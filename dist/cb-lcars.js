/*! For license information please see cb-lcars.js.LICENSE.txt */
(()=>{var e,t,s={356:(e,t,s)=>{"use strict";s.r(t),s.d(t,{DEFAULT_DOMAIN_ICON:()=>Z,DEFAULT_PANEL:()=>K,DEFAULT_VIEW_ENTITY_ID:()=>ae,DOMAINS_HIDE_MORE_INFO:()=>te,DOMAINS_MORE_INFO_NO_HISTORY:()=>se,DOMAINS_TOGGLE:()=>re,DOMAINS_WITH_CARD:()=>Q,DOMAINS_WITH_MORE_INFO:()=>ee,NumberFormat:()=>n,STATES_OFF:()=>ne,TimeFormat:()=>r,UNIT_C:()=>ie,UNIT_F:()=>oe,applyThemesOnElement:()=>B,computeCardSize:()=>I,computeDomain:()=>z,computeEntity:()=>j,computeRTL:()=>H,computeRTLDirection:()=>U,computeStateDisplay:()=>J,computeStateDomain:()=>G,createThing:()=>ue,debounce:()=>he,domainIcon:()=>ge,evaluateFilter:()=>me,fireEvent:()=>le,fixedIcons:()=>pe,formatDate:()=>d,formatDateMonth:()=>b,formatDateMonthYear:()=>f,formatDateNumeric:()=>h,formatDateShort:()=>g,formatDateTime:()=>x,formatDateTimeNumeric:()=>A,formatDateTimeWithSeconds:()=>C,formatDateWeekday:()=>l,formatDateYear:()=>v,formatNumber:()=>Y,formatTime:()=>D,formatTimeWeekday:()=>O,formatTimeWithSeconds:()=>T,forwardHaptic:()=>fe,getLovelace:()=>Ae,handleAction:()=>we,handleActionConfig:()=>ve,handleClick:()=>Se,hasAction:()=>xe,hasConfigOrEntityChanged:()=>$e,hasDoubleClick:()=>Ce,isNumericState:()=>V,navigate:()=>ye,numberFormatToLocale:()=>q,relativeTime:()=>P,round:()=>W,stateIcon:()=>Ee,timerTimeRemaining:()=>N,toggleEntity:()=>_e,turnOnOffEntities:()=>ke,turnOnOffEntity:()=>be});var n,r,i,o=function(){return o=Object.assign||function(e){for(var t,s=1,n=arguments.length;s<n;s++)for(var r in t=arguments[s])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},o.apply(this,arguments)},a={second:45,minute:45,hour:22,day:5},l=function(e,t){return c(t).format(e)},c=function(e){return new Intl.DateTimeFormat(e.language,{weekday:"long",month:"long",day:"numeric"})},d=function(e,t){return u(t).format(e)},u=function(e){return new Intl.DateTimeFormat(e.language,{year:"numeric",month:"long",day:"numeric"})},h=function(e,t){return p(t).format(e)},p=function(e){return new Intl.DateTimeFormat(e.language,{year:"numeric",month:"numeric",day:"numeric"})},g=function(e,t){return m(t).format(e)},m=function(e){return new Intl.DateTimeFormat(e.language,{day:"numeric",month:"short"})},f=function(e,t){return y(t).format(e)},y=function(e){return new Intl.DateTimeFormat(e.language,{month:"long",year:"numeric"})},b=function(e,t){return _(t).format(e)},_=function(e){return new Intl.DateTimeFormat(e.language,{month:"long"})},v=function(e,t){return w(t).format(e)},w=function(e){return new Intl.DateTimeFormat(e.language,{year:"numeric"})};(i=n||(n={})).language="language",i.system="system",i.comma_decimal="comma_decimal",i.decimal_comma="decimal_comma",i.space_comma="space_comma",i.none="none",function(e){e.language="language",e.system="system",e.am_pm="12",e.twenty_four="24"}(r||(r={}));var S=function(e){if(e.time_format===r.language||e.time_format===r.system){var t=e.time_format===r.language?e.language:void 0,s=(new Date).toLocaleString(t);return s.includes("AM")||s.includes("PM")}return e.time_format===r.am_pm},x=function(e,t){return $(t).format(e)},$=function(e){return new Intl.DateTimeFormat(e.language,{year:"numeric",month:"long",day:"numeric",hour:S(e)?"numeric":"2-digit",minute:"2-digit",hour12:S(e)})},C=function(e,t){return k(t).format(e)},k=function(e){return new Intl.DateTimeFormat(e.language,{year:"numeric",month:"long",day:"numeric",hour:S(e)?"numeric":"2-digit",minute:"2-digit",second:"2-digit",hour12:S(e)})},A=function(e,t){return M(t).format(e)},M=function(e){return new Intl.DateTimeFormat(e.language,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"2-digit",hour12:S(e)})},D=function(e,t){return E(t).format(e)},E=function(e){return new Intl.DateTimeFormat(e.language,{hour:"numeric",minute:"2-digit",hour12:S(e)})},T=function(e,t){return R(t).format(e)},R=function(e){return new Intl.DateTimeFormat(e.language,{hour:S(e)?"numeric":"2-digit",minute:"2-digit",second:"2-digit",hour12:S(e)})},O=function(e,t){return L(t).format(e)},L=function(e){return new Intl.DateTimeFormat(e.language,{hour:S(e)?"numeric":"2-digit",minute:"2-digit",second:"2-digit",hour12:S(e)})},P=function(e,t,s,n){void 0===n&&(n=!0);var r=function(e,t,s){void 0===t&&(t=Date.now()),void 0===s&&(s={});var n=o(o({},a),s||{}),r=(+e-+t)/1e3;if(Math.abs(r)<n.second)return{value:Math.round(r),unit:"second"};var i=r/60;if(Math.abs(i)<n.minute)return{value:Math.round(i),unit:"minute"};var l=r/3600;if(Math.abs(l)<n.hour)return{value:Math.round(l),unit:"hour"};var c=r/86400;if(Math.abs(c)<n.day)return{value:Math.round(c),unit:"day"};var d=new Date(e),u=new Date(t),h=d.getFullYear()-u.getFullYear();if(Math.round(Math.abs(h))>0)return{value:Math.round(h),unit:"year"};var p=12*h+d.getMonth()-u.getMonth();if(Math.round(Math.abs(p))>0)return{value:Math.round(p),unit:"month"};var g=r/604800;return{value:Math.round(g),unit:"week"}}(e,s);return n?function(e){return new Intl.RelativeTimeFormat(e.language,{numeric:"auto"})}(t).format(r.value,r.unit):Intl.NumberFormat(t.language,{style:"unit",unit:r.unit,unitDisplay:"long"}).format(Math.abs(r.value))};function N(e){var t,s=3600*(t=e.attributes.remaining.split(":").map(Number))[0]+60*t[1]+t[2];if("active"===e.state){var n=(new Date).getTime(),r=new Date(e.last_changed).getTime();s=Math.max(s-(n-r)/1e3,0)}return s}function F(){return(F=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(e[n]=s[n])}return e}).apply(this,arguments)}var B=function(e,t,s,n){void 0===n&&(n=!1),e._themes||(e._themes={});var r=t.default_theme;("default"===s||s&&t.themes[s])&&(r=s);var i=F({},e._themes);if("default"!==r){var o=t.themes[r];Object.keys(o).forEach((function(t){var s="--"+t;e._themes[s]="",i[s]=o[t]}))}if(e.updateStyles?e.updateStyles(i):window.ShadyCSS&&window.ShadyCSS.styleSubtree(e,i),n){var a=document.querySelector("meta[name=theme-color]");if(a){a.hasAttribute("default-content")||a.setAttribute("default-content",a.getAttribute("content"));var l=i["--primary-color"]||a.getAttribute("default-content");a.setAttribute("content",l)}}},I=function(e){return"function"==typeof e.getCardSize?e.getCardSize():4};function z(e){return e.substr(0,e.indexOf("."))}function j(e){return e.substr(e.indexOf(".")+1)}function H(e){var t,s=(null==e||null==(t=e.locale)?void 0:t.language)||"en";return e.translationMetadata.translations[s]&&e.translationMetadata.translations[s].isRTL||!1}function U(e){return H(e)?"rtl":"ltr"}function G(e){return z(e.entity_id)}var V=function(e){return!!e.attributes.unit_of_measurement||!!e.attributes.state_class},q=function(e){switch(e.number_format){case n.comma_decimal:return["en-US","en"];case n.decimal_comma:return["de","es","it"];case n.space_comma:return["fr","sv","cs"];case n.system:return;default:return e.language}},W=function(e,t){return void 0===t&&(t=2),Math.round(e*Math.pow(10,t))/Math.pow(10,t)},Y=function(e,t,s){var r=t?q(t):void 0;if(Number.isNaN=Number.isNaN||function e(t){return"number"==typeof t&&e(t)},(null==t?void 0:t.number_format)!==n.none&&!Number.isNaN(Number(e))&&Intl)try{return new Intl.NumberFormat(r,X(e,s)).format(Number(e))}catch(t){return console.error(t),new Intl.NumberFormat(void 0,X(e,s)).format(Number(e))}return"string"==typeof e?e:W(e,null==s?void 0:s.maximumFractionDigits).toString()+("currency"===(null==s?void 0:s.style)?" "+s.currency:"")},X=function(e,t){var s=F({maximumFractionDigits:2},t);if("string"!=typeof e)return s;if(!t||!t.minimumFractionDigits&&!t.maximumFractionDigits){var n=e.indexOf(".")>-1?e.split(".")[1].length:0;s.minimumFractionDigits=n,s.maximumFractionDigits=n}return s},J=function(e,t,s,n){var r=void 0!==n?n:t.state;if("unknown"===r||"unavailable"===r)return e("state.default."+r);if(V(t)){if("monetary"===t.attributes.device_class)try{return Y(r,s,{style:"currency",currency:t.attributes.unit_of_measurement})}catch(e){}return Y(r,s)+(t.attributes.unit_of_measurement?" "+t.attributes.unit_of_measurement:"")}var i=G(t);if("input_datetime"===i){var o;if(void 0===n)return t.attributes.has_date&&t.attributes.has_time?(o=new Date(t.attributes.year,t.attributes.month-1,t.attributes.day,t.attributes.hour,t.attributes.minute),x(o,s)):t.attributes.has_date?(o=new Date(t.attributes.year,t.attributes.month-1,t.attributes.day),d(o,s)):t.attributes.has_time?((o=new Date).setHours(t.attributes.hour,t.attributes.minute),D(o,s)):t.state;try{var a=n.split(" ");if(2===a.length)return x(new Date(a.join("T")),s);if(1===a.length){if(n.includes("-"))return d(new Date(n+"T00:00"),s);if(n.includes(":")){var l=new Date;return D(new Date(l.toISOString().split("T")[0]+"T"+n),s)}}return n}catch(e){return n}}return"humidifier"===i&&"on"===r&&t.attributes.humidity?t.attributes.humidity+" %":"counter"===i||"number"===i||"input_number"===i?Y(r,s):t.attributes.device_class&&e("component."+i+".state."+t.attributes.device_class+"."+r)||e("component."+i+".state._."+r)||r},Z="mdi:bookmark",K="lovelace",Q=["climate","cover","configurator","input_select","input_number","input_text","lock","media_player","scene","script","timer","vacuum","water_heater","weblink"],ee=["alarm_control_panel","automation","camera","climate","configurator","cover","fan","group","history_graph","input_datetime","light","lock","media_player","script","sun","updater","vacuum","water_heater","weather"],te=["input_number","input_select","input_text","scene","weblink"],se=["camera","configurator","history_graph","scene"],ne=["closed","locked","off"],re=new Set(["fan","input_boolean","light","switch","group","automation"]),ie="°C",oe="°F",ae="group.default_view",le=function(e,t,s,n){n=n||{},s=null==s?{}:s;var r=new Event(t,{bubbles:void 0===n.bubbles||n.bubbles,cancelable:Boolean(n.cancelable),composed:void 0===n.composed||n.composed});return r.detail=s,e.dispatchEvent(r),r},ce=new Set(["call-service","divider","section","weblink","cast","select"]),de={alert:"toggle",automation:"toggle",climate:"climate",cover:"cover",fan:"toggle",group:"group",input_boolean:"toggle",input_number:"input-number",input_select:"input-select",input_text:"input-text",light:"toggle",lock:"lock",media_player:"media-player",remote:"toggle",scene:"scene",script:"script",sensor:"sensor",timer:"timer",switch:"toggle",vacuum:"toggle",water_heater:"climate",input_datetime:"input-datetime"},ue=function(e,t){void 0===t&&(t=!1);var s=function(e,t){return n("hui-error-card",{type:"error",error:e,config:t})},n=function(e,t){var n=window.document.createElement(e);try{if(!n.setConfig)return;n.setConfig(t)}catch(n){return console.error(e,n),s(n.message,t)}return n};if(!e||"object"!=typeof e||!t&&!e.type)return s("No type defined",e);var r=e.type;if(r&&r.startsWith("custom:"))r=r.substr(7);else if(t)if(ce.has(r))r="hui-"+r+"-row";else{if(!e.entity)return s("Invalid config given.",e);var i=e.entity.split(".",1)[0];r="hui-"+(de[i]||"text")+"-entity-row"}else r="hui-"+r+"-card";if(customElements.get(r))return n(r,e);var o=s("Custom element doesn't exist: "+e.type+".",e);o.style.display="None";var a=setTimeout((function(){o.style.display=""}),2e3);return customElements.whenDefined(e.type).then((function(){clearTimeout(a),le(o,"ll-rebuild",{},o)})),o},he=function(e,t,s){var n;return void 0===s&&(s=!1),function(){var r=[].slice.call(arguments),i=this,o=s&&!n;clearTimeout(n),n=setTimeout((function(){n=null,s||e.apply(i,r)}),t),o&&e.apply(i,r)}},pe={alert:"mdi:alert",automation:"mdi:playlist-play",calendar:"mdi:calendar",camera:"mdi:video",climate:"mdi:thermostat",configurator:"mdi:settings",conversation:"mdi:text-to-speech",device_tracker:"mdi:account",fan:"mdi:fan",group:"mdi:google-circles-communities",history_graph:"mdi:chart-line",homeassistant:"mdi:home-assistant",homekit:"mdi:home-automation",image_processing:"mdi:image-filter-frames",input_boolean:"mdi:drawing",input_datetime:"mdi:calendar-clock",input_number:"mdi:ray-vertex",input_select:"mdi:format-list-bulleted",input_text:"mdi:textbox",light:"mdi:lightbulb",mailbox:"mdi:mailbox",notify:"mdi:comment-alert",person:"mdi:account",plant:"mdi:flower",proximity:"mdi:apple-safari",remote:"mdi:remote",scene:"mdi:google-pages",script:"mdi:file-document",sensor:"mdi:eye",simple_alarm:"mdi:bell",sun:"mdi:white-balance-sunny",switch:"mdi:flash",timer:"mdi:timer",updater:"mdi:cloud-upload",vacuum:"mdi:robot-vacuum",water_heater:"mdi:thermometer",weblink:"mdi:open-in-new"};function ge(e,t){if(e in pe)return pe[e];switch(e){case"alarm_control_panel":switch(t){case"armed_home":return"mdi:bell-plus";case"armed_night":return"mdi:bell-sleep";case"disarmed":return"mdi:bell-outline";case"triggered":return"mdi:bell-ring";default:return"mdi:bell"}case"binary_sensor":return t&&"off"===t?"mdi:radiobox-blank":"mdi:checkbox-marked-circle";case"cover":return"closed"===t?"mdi:window-closed":"mdi:window-open";case"lock":return t&&"unlocked"===t?"mdi:lock-open":"mdi:lock";case"media_player":return t&&"off"!==t&&"idle"!==t?"mdi:cast-connected":"mdi:cast";case"zwave":switch(t){case"dead":return"mdi:emoticon-dead";case"sleeping":return"mdi:sleep";case"initializing":return"mdi:timer-sand";default:return"mdi:z-wave"}default:return console.warn("Unable to find icon for domain "+e+" ("+t+")"),"mdi:bookmark"}}var me=function(e,t){var s=t.value||t,n=t.attribute?e.attributes[t.attribute]:e.state;switch(t.operator||"=="){case"==":return n===s;case"<=":return n<=s;case"<":return n<s;case">=":return n>=s;case">":return n>s;case"!=":return n!==s;case"regex":return n.match(s);default:return!1}},fe=function(e){le(window,"haptic",e)},ye=function(e,t,s){void 0===s&&(s=!1),s?history.replaceState(null,"",t):history.pushState(null,"",t),le(window,"location-changed",{replace:s})},be=function(e,t,s){void 0===s&&(s=!0);var n,r=z(t),i="group"===r?"homeassistant":r;switch(r){case"lock":n=s?"unlock":"lock";break;case"cover":n=s?"open_cover":"close_cover";break;default:n=s?"turn_on":"turn_off"}return e.callService(i,n,{entity_id:t})},_e=function(e,t){var s=ne.includes(e.states[t].state);return be(e,t,s)},ve=function(e,t,s,n){if(n||(n={action:"more-info"}),!n.confirmation||n.confirmation.exemptions&&n.confirmation.exemptions.some((function(e){return e.user===t.user.id}))||(fe("warning"),confirm(n.confirmation.text||"Are you sure you want to "+n.action+"?")))switch(n.action){case"more-info":(s.entity||s.camera_image)&&le(e,"hass-more-info",{entityId:s.entity?s.entity:s.camera_image});break;case"navigate":n.navigation_path&&ye(0,n.navigation_path);break;case"url":n.url_path&&window.open(n.url_path);break;case"toggle":s.entity&&(_e(t,s.entity),fe("success"));break;case"call-service":if(!n.service)return void fe("failure");var r=n.service.split(".",2);t.callService(r[0],r[1],n.service_data,n.target),fe("success");break;case"fire-dom-event":le(e,"ll-custom",n)}},we=function(e,t,s,n){var r;"double_tap"===n&&s.double_tap_action?r=s.double_tap_action:"hold"===n&&s.hold_action?r=s.hold_action:"tap"===n&&s.tap_action&&(r=s.tap_action),ve(e,t,s,r)},Se=function(e,t,s,n,r){var i;if(r&&s.double_tap_action?i=s.double_tap_action:n&&s.hold_action?i=s.hold_action:!n&&s.tap_action&&(i=s.tap_action),i||(i={action:"more-info"}),!i.confirmation||i.confirmation.exemptions&&i.confirmation.exemptions.some((function(e){return e.user===t.user.id}))||confirm(i.confirmation.text||"Are you sure you want to "+i.action+"?"))switch(i.action){case"more-info":(i.entity||s.entity||s.camera_image)&&(le(e,"hass-more-info",{entityId:i.entity?i.entity:s.entity?s.entity:s.camera_image}),i.haptic&&fe(i.haptic));break;case"navigate":i.navigation_path&&(ye(0,i.navigation_path),i.haptic&&fe(i.haptic));break;case"url":i.url_path&&window.open(i.url_path),i.haptic&&fe(i.haptic);break;case"toggle":s.entity&&(_e(t,s.entity),i.haptic&&fe(i.haptic));break;case"call-service":if(!i.service)return;var o=i.service.split(".",2),a=o[0],l=o[1],c=F({},i.service_data);"entity"===c.entity_id&&(c.entity_id=s.entity),t.callService(a,l,c,i.target),i.haptic&&fe(i.haptic);break;case"fire-dom-event":le(e,"ll-custom",i),i.haptic&&fe(i.haptic)}};function xe(e){return void 0!==e&&"none"!==e.action}function $e(e,t,s){if(t.has("config")||s)return!0;if(e.config.entity){var n=t.get("hass");return!n||n.states[e.config.entity]!==e.hass.states[e.config.entity]}return!1}function Ce(e){return void 0!==e&&"none"!==e.action}var ke=function(e,t,s){void 0===s&&(s=!0);var n={};t.forEach((function(t){if(ne.includes(e.states[t].state)===s){var r=z(t),i=["cover","lock"].includes(r)?r:"homeassistant";i in n||(n[i]=[]),n[i].push(t)}})),Object.keys(n).forEach((function(t){var r;switch(t){case"lock":r=s?"unlock":"lock";break;case"cover":r=s?"open_cover":"close_cover";break;default:r=s?"turn_on":"turn_off"}e.callService(t,r,{entity_id:n[t]})}))},Ae=function(){var e=document.querySelector("home-assistant");if(e=(e=(e=(e=(e=(e=(e=(e=e&&e.shadowRoot)&&e.querySelector("home-assistant-main"))&&e.shadowRoot)&&e.querySelector("app-drawer-layout partial-panel-resolver"))&&e.shadowRoot||e)&&e.querySelector("ha-panel-lovelace"))&&e.shadowRoot)&&e.querySelector("hui-root")){var t=e.lovelace;return t.current_view=e.___curView,t}return null},Me={humidity:"mdi:water-percent",illuminance:"mdi:brightness-5",temperature:"mdi:thermometer",pressure:"mdi:gauge",power:"mdi:flash",signal_strength:"mdi:wifi"},De={binary_sensor:function(e,t){var s="off"===e;switch(null==t?void 0:t.attributes.device_class){case"battery":return s?"mdi:battery":"mdi:battery-outline";case"battery_charging":return s?"mdi:battery":"mdi:battery-charging";case"cold":return s?"mdi:thermometer":"mdi:snowflake";case"connectivity":return s?"mdi:server-network-off":"mdi:server-network";case"door":return s?"mdi:door-closed":"mdi:door-open";case"garage_door":return s?"mdi:garage":"mdi:garage-open";case"power":case"plug":return s?"mdi:power-plug-off":"mdi:power-plug";case"gas":case"problem":case"safety":case"tamper":return s?"mdi:check-circle":"mdi:alert-circle";case"smoke":return s?"mdi:check-circle":"mdi:smoke";case"heat":return s?"mdi:thermometer":"mdi:fire";case"light":return s?"mdi:brightness-5":"mdi:brightness-7";case"lock":return s?"mdi:lock":"mdi:lock-open";case"moisture":return s?"mdi:water-off":"mdi:water";case"motion":return s?"mdi:walk":"mdi:run";case"occupancy":case"presence":return s?"mdi:home-outline":"mdi:home";case"opening":return s?"mdi:square":"mdi:square-outline";case"running":return s?"mdi:stop":"mdi:play";case"sound":return s?"mdi:music-note-off":"mdi:music-note";case"update":return s?"mdi:package":"mdi:package-up";case"vibration":return s?"mdi:crop-portrait":"mdi:vibrate";case"window":return s?"mdi:window-closed":"mdi:window-open";default:return s?"mdi:radiobox-blank":"mdi:checkbox-marked-circle"}},cover:function(e){var t="closed"!==e.state;switch(e.attributes.device_class){case"garage":return t?"mdi:garage-open":"mdi:garage";case"door":return t?"mdi:door-open":"mdi:door-closed";case"shutter":return t?"mdi:window-shutter-open":"mdi:window-shutter";case"blind":return t?"mdi:blinds-open":"mdi:blinds";case"window":return t?"mdi:window-open":"mdi:window-closed";default:return ge("cover",e.state)}},sensor:function(e){var t=e.attributes.device_class;if(t&&t in Me)return Me[t];if("battery"===t){var s=Number(e.state);if(isNaN(s))return"mdi:battery-unknown";var n=10*Math.round(s/10);return n>=100?"mdi:battery":n<=0?"mdi:battery-alert":"hass:battery-"+n}var r=e.attributes.unit_of_measurement;return"°C"===r||"°F"===r?"mdi:thermometer":ge("sensor")},input_datetime:function(e){return e.attributes.has_date?e.attributes.has_time?ge("input_datetime"):"mdi:calendar":"mdi:clock"}},Ee=function(e){if(!e)return"mdi:bookmark";if(e.attributes.icon)return e.attributes.icon;var t=z(e.entity_id);return t in De?De[t](e):ge(t,e.state)}},835:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getNestedProperty=void 0,t.deepMerge=function e(t,s){const n={...t};for(const t of Object.keys(s)){const r=n[t],o=s[t];"type"===t||Array.isArray(r)&&Array.isArray(o)?n[t]=o:i(r)&&i(o)?n[t]=e({...r},o):n[t]=o}return n},t.isObject=i,t.generateControl=function(e,s){const i={...s,hass:s._hass,window},o=!e.visibilityCondition||s._evaluateCondition(e.visibilityCondition,i),a=!!e.disabledCondition&&s._evaluateCondition(e.disabledCondition,i),l=!!e.requiredCondition&&s._evaluateCondition(e.requiredCondition,i);if(!o)return null;if("selector"in e&&e.selector&&e.selector.select&&e.selector.select.optionsCondition){const t=s._evaluateCondition(e.selector.select.optionsCondition,i);e.selector.select.options=t}switch(e.type){case"Selector":return n.html`
                <div class="form-control">
                <ha-selector
                    .hass=${s._hass}
                    .selector=${e.selector}
                    .configValue=${e.configValue}
                    .value=${(0,t.getNestedProperty)(s._config,e.configValue)}
                    .label=${e.label}
                    .helper=${e.helper}
                    .disabled=${a}
                    .required=${l}
                    @value-changed=${s._valueChanged}
                ></ha-selector>
                </div>
                `;case"Filler":return n.html`<div class="form-control"></div>`;case"Divider":return n.html`<hr>`;case"Message":return n.html`
                <div class="form-control">
                    <ha-alert alert-type=${e.alertType||"info"} title=${e.title||""}>
                        ${e.message||""}
                    </ha-alert>
                </div>
            `;case"RawHTML":return n.html`
                <div class="form-control">
                    ${(0,r.unsafeHTML)(e.html||"")}
                </div>
            `;case"ColorPreview":let i,o=(0,t.getNestedProperty)(s._config,e.configValue);o?i=o:(o="#1B1B249A",i="Color Not Set");const c=o.startsWith("var(");let d=o;if(c){const e=o.match(/var\((--[^,)]+)\)/),t=e?e[1]:o;d=getComputedStyle(document.documentElement).getPropertyValue(t).trim(),d||(console.warn(`CSS variable ${t} is not defined. Using fallback color.`),d="#0000ff")}else"#1B1B249A"!==o&&(i="User Defined Color");const u=e=>{let t,s,n,r,i;return 8===(e=e.replace(/^#/,"")).length?(t=parseInt(e,16),s=t>>24&255,n=t>>16&255,r=t>>8&255,i=255&t,[s,n,r,i/255]):(t=parseInt(e,16),s=t>>16&255,n=t>>8&255,r=255&t,[s,n,r])},h=(e=>{const[t,s,n]=u(e),[r,i,o]=[t,s,n].map((e=>e/255)).map((e=>e<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4)));return.2126*r+.7152*i+.0722*o})(d)>.5?"#000":"#fff";return n.html`
                <div class="form-control">
                    <div style="-webkit-fill-available; height: 50px; background-color: ${o}; border-radius: 25px; border: 1px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: ${h};">
                        <div>${i}</div>
                        <div>${d}</div>
                    </div>
                </div>
            `;default:return n.html`
                <div class="form-control">
                    <ha-alert alert-type="error" title="Unsupported Control Type">
                    The control type "${e.type}" is not supported.
                </ha-alert>
                </div>
                `}};const n=s(243),r=s(534);function i(e){return null!==e&&"object"==typeof e}t.getNestedProperty=(e,t)=>t.split(".").reduce(((e,t)=>e&&e[t]),e)},41:(e,t,s)=>{"use strict";const n=s(356),r=s(243),i=s(534),o=s(369),a=s(835);class l extends r.LitElement{constructor(){super(...arguments),this._selectedTab="panel-0",this._userStyles=r.css``,this._mergeUserStyles=!0}setConfig(e){this._config=e,this.requestUpdate("_config")}set hass(e){this._hass=e}generateForm(e){if(!e)return r.html``;if(e.tabs)return this.generateTabs(e.tabs);{const t=e.render_form.map((e=>(0,o.isSection)(e)?this.generateSection(e):this.generateRow(e)));return r.html`
            <div class="card-form">
                ${t}
            </div>
        `}}_handleTabActivated(e){this._selectedTab=e.detail.name,this.requestUpdate()}generateTabs(e){const t=e.filter((e=>this._evaluateCondition(e.visibilityCondition||"true")));return r.html`
            <sl-tab-group @sl-tab-show=${this._handleTabActivated}>
                ${t.map(((e,t)=>r.html`
                    <sl-tab slot="nav" panel="panel-${t}" ?active=${this._selectedTab===`panel-${t}`}>
                        ${e.label}
                    </sl-tab>
                `))}
            </sl-tab-group>
            <div class="tab-content">
                ${t.map(((e,t)=>r.html`
                    <sl-tab-panel name="panel-${t}" ?hidden=${this._selectedTab!==`panel-${t}`}>
                        ${e.content.map((e=>"Section"===e.type?this.generateSection(e):this.generateRow(e)))}
                    </sl-tab-panel>
                `))}
            </div>
        `}generateSection(e){var t;if(e.visibilityCondition&&!this._evaluateCondition(e.visibilityCondition))return r.html``;const s=e.cssClass?`form-row ${e.cssClass}`:"form-row",n=`h${e.headerLevel||4}`,a=`\n            <${n} slot="header">\n                ${e.icon?`<ha-icon icon="${e.icon}"></ha-icon>`:""}\n                ${e.label}\n                ${e.secondary?`<div slot="secondary">${e.secondary}</div>`:""}\n            </${n}>\n        `;return r.html`
            <div class="${s}">
                <ha-expansion-panel
                    .expanded=${e.expanded||!1}
                    .noCollapse=${e.noCollapse||!1}
                    .outlined=${e.outlined||!0}
                    .leftChevron=${e.leftChevron||!1}
                    .secondary=${e.secondary||""}
                >
                    ${(0,i.unsafeHTML)(a)}
                    <div>
                        ${null===(t=e.rows)||void 0===t?void 0:t.map((e=>(0,o.isSection)(e)?this.generateSection(e):this.generateRow(e)))}
                    </div>
                </ha-expansion-panel>
            </div>
        `}generateRow(e){if(e.visibilityCondition&&!this._evaluateCondition(e.visibilityCondition))return r.html``;const t=e.cssClass?`form-row ${e.cssClass}`:"form-row";return r.html`
            <div class="${t}">
                ${e.label?r.html`<label>${e.label}</label>`:""}
                ${e.controls.map((e=>e.visibilityCondition&&!this._evaluateCondition(e.visibilityCondition)?r.html``:(0,a.generateControl)(e,this)))}
            </div>
        `}_evaluateCondition(e,t={}){try{return new Function("context","with(context) { return "+e+"; }").call(this,t)}catch(t){return console.error("Error evaluating condition:",e,t),!1}}_valueChanged(e){var t,s;if(!this._config||!this._hass)return;const r=e.target,i=null!==(s=null===(t=r.configValue)||void 0===t?void 0:t.split("."))&&void 0!==s?s:[],o=this._getNewValue(r,e.detail),a="HA-SELECTOR"===r.tagName&&Array.isArray(e.detail.value);this._updateConfig(i,o,a),(0,n.fireEvent)(this,"config-changed",{config:this._config},{bubbles:!0,composed:!0}),this.requestUpdate()}_getNewValue(e,t){var s,n,r;switch(e.tagName){case"HA-SELECTOR":return null==t?void 0:t.value;case"HA-SWITCH":return null!==(s=e.checked)&&void 0!==s?s:e.__checked;case"HA-CHECKBOX":return e.value;case"HA-FORM":return Object.values(null!==(n=null==t?void 0:t.value)&&void 0!==n?n:{})[0];default:return null!==(r=null==t?void 0:t.value)&&void 0!==r?r:e.value}}_updateConfig(e,t,s=!1){if(!e.length)return;e.join(".");let n={...this._config},r=n;for(let t=0;t<e.length-1;t++)r[e[t]]=r[e[t]]||{},r=r[e[t]];const i=e[e.length-1];""===t||null==t?delete r[i]:r[i]=t,this._config=(0,a.deepMerge)(this._config,n)}updated(e){super.updated(e);const t=this.constructor;this._mergeUserStyles?this.shadowRoot.adoptedStyleSheets=[t.styles.styleSheet,this._userStyles.styleSheet]:this.shadowRoot.adoptedStyleSheets=[this._userStyles.styleSheet]}static get styles(){return r.css`
            /* Base styles for the form container */
            .card-form {
                display: grid;
                grid-gap: 8px;
            }

             /* Styles for tabs */
            mwc-tab-bar {
                border-bottom: 1px solid var(--divider-color);
            }
            .tab-content {
                padding: 10px;
            }
            .tab-panel {
                display: none;
            }
            .tab-panel:not([hidden]) {
                display: block;
            }
            /* Base styles for form rows */
            .form-row {
                display: grid;
                grid-template-columns: 1fr;
                grid-gap: 8px;
                /* margin-bottom: 10px; */
                border-radius: 10px;
            }

            /* Styles for form rows with two controls */
            .form-row.two-controls {
                grid-template-columns: 1fr 1fr;
            }
            /* Labels in form rows with two controls */
            .form-row.two-controls label {
                grid-column: span 2; /* Make the label span across both columns */
                justify-self: start; /* Left-justify the label */
                font-weight: bold;
                height: auto;
                margin-bottom: 5px; /* Add some space below the label */
                padding-left: 8px;
            }

            /* ensure full width for form controls not in two-controls class */

            .form-row:not(.two-controls) .form-control > * {
                width: -webkit-fill-available;
            }

            /* Base styles for form controls */
            .form-control {
                display: flex; /* Use flexbox for internal alignment */
                align-items: center;
                padding: 8px;
                border-radius: 10px;
            }

            /* Label styles within form controls */
            .form-control label {
                font-weight: bold;
                padding-left: 8px;
            }

            /* Styles for expandable sections */
            ha-expansion-panel {
                margin-bottom: 10px;
                border-radius: var(--ha-card-border-radius, 34px);
            }
            ha-expansion-panel[outlined] {
                border: 2px solid var(--chip-background-color);
            }
            ha-expansion-panel[expanded] {
                background-color: var(--chip-background-color);
            }
            h1 > ha-icon,
            h2 > ha-icon,
            h3 > ha-icon,
            h4 > ha-icon,
            h5 > ha-icon,
            h6 > ha-icon {
                margin: 0 8px;
            }

            hr {
                width: 95%;
                border: 1px solid var(--chip-background-color);
            }

            /* Styles for form errors */
            .form-error {
                color: var(--error-color); /* Home Assistant theme color */
                font-size: 0.875em;
                margin-top: 5px;
            }
        `}}t.A=l},369:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSection=function(e){return"Section"===e.type},t.isControlRow=function(e){return"ControlRow"===e.type}},640:(e,t,s)=>{"use strict";s.d(t,{A1:()=>u,CZ:()=>l,FS:()=>o,WG:()=>n,ZU:()=>a,iM:()=>c,i_:()=>r,ry:()=>i,ur:()=>d});const n=s(330).version,r="https://cb-lcars.unimatrix01.ca",i=["https://fonts.googleapis.com/css2?family=Antonio:wght@100;700&display=swap","cb-lcars_jeffries","cb-lcars_microgramma"],o="/hacsfiles/cb-lcars/cb-lcars-lovelace.yaml",a="/hacsfiles/cb-lcars/cb-lcars-stub-config.yaml",l="/hacsfiles/cb-lcars/cb-lcars-themes.yaml",c="/hacsfiles/cb-lcars/editor",d=["ncc-1701-a","ncc-1701-a-blue","enterprise-d-shuttlecraft15-anomaly"],u="/hacsfiles/cb-lcars/msd/"},733:()=>{!function(){if("undefined"==typeof window)return;const e=window;function t(){const t=e.__msdDebug?.pipelineInstance;if(!t||!t.enabled)throw new Error("pipeline disabled");return t}function s(t){return e.__msdDebug?.routing?.inspect(t)}function n(t="*"){e.__msdDebug?.routing?.invalidate(t)}e.__msdScenarios=e.__msdScenarios||{};const r="line_grid_forced";function i(e){const s=t().getResolvedModel().overlays.find((t=>t.id===e));if(!s)throw new Error("overlay not found");s._raw=s._raw||{},s._raw.corner_style="round",s._raw.corner_radius=s._raw.corner_radius||40}const o={arc_presence:function(){i(r),n("*");const e=s(r);return{ok:!!e&&/A\d+/.test(e.d)&&e.meta.arc&&e.meta.arc.count>0,details:{dSample:e?.d?.slice(0,120)+"...",arc:e?.meta?.arc}}},radius_clamp:function(){i(r);const e=t().getResolvedModel().overlays.find((e=>e.id===r)),o=e._raw.corner_radius;e._raw.corner_radius=1e3,n("*");const a=s(r);return e._raw.corner_radius=o,n("*"),{ok:!!a&&a.meta.arc&&a.meta.arc.count>0,details:{trimPx:a?.meta?.arc?.trimPx,count:a?.meta?.arc?.count}}},arc_cache_reuse:function(){i(r),n("*");const e=s(r),t=s(r);return{ok:!!e&&!!t&&!1===e.meta.cache_hit&&!0===t.meta.cache_hit&&t.meta.arc?.count>=0,details:{firstHit:e?.meta.cache_hit,secondHit:t?.meta.cache_hit,arcCount:t?.meta?.arc?.count}}},miter_fallback:function(){const e=t().getResolvedModel().overlays.find((e=>e.id===r));if(!e)return{ok:!1,details:"overlay missing"};e._raw=e._raw||{};const i=e._raw.corner_style;e._raw.corner_style="miter",n("*");const o=s(r);return e._raw.corner_style=i,n("*"),{ok:!!o&&!o.meta.arc,details:{hasArcMeta:!!o.meta.arc}}}},a={list:()=>Object.keys(o),run:e=>{if(!o[e])return console.warn("[MSD Arc Scenario] Unknown",e),null;try{const t=o[e]();return console.log(`[MSD Arc Scenario] ${e}: ${t.ok?"OK":"FAIL"}`,t),t}catch(t){const s={ok:!1,details:String(t)};return console.log(`[MSD Arc Scenario] ${e}: FAIL`,s),s}},runAll:()=>{const e={};for(const t of Object.keys(o))e[t]=a.run(t);const t=Object.values(e).every((e=>e&&e.ok));return console.log("[MSD Arc Scenario] Summary:",t?"ALL PASS":"FAILURES",e),e}};e.__msdScenarios.arcs=a,console.info("[MSD v1] Arc routing scenario harness installed. Use: window.__msdScenarios.arcs.list()")}()},388:()=>{!function(){if("undefined"==typeof window)return;const e=window;function t(){const t=e.__msdDebug?.pipelineInstance;if(!t||!t.enabled)throw new Error("pipeline disabled");return t}function s(t){return e.__msdDebug?.routing?.inspect(t)}function n(t="*"){e.__msdDebug?.routing?.invalidate(t)}function r(){const e="line_channel_demo",r=t().getResolvedModel().overlays.find((t=>t.id===e));if(!r)return{ok:!1,details:"overlay missing"};r._raw=r._raw||{};const i=r._raw.route_channels?r._raw.route_channels.slice():[],o=r._raw.route_channel_mode;r._raw.route_channels=[],r._raw.route_channel_mode="prefer",n("*");const a=s(e);r._raw.route_channels=["main_bus"],r._raw.route_channel_mode="prefer",n("*");const l=s(e);return r._raw.route_channels=i,r._raw.route_channel_mode=o,n("*"),{ok:!!a&&!!l&&l.meta.cost<=a.meta.cost,details:{baseCost:a?.meta.cost,preferCost:l?.meta.cost}}}function i(){const e="line_channel_demo",r=t().getResolvedModel().overlays.find((t=>t.id===e));if(!r)return{ok:!1,details:"overlay missing"};r._raw=r._raw||{};const i=r._raw.route_channels?r._raw.route_channels.slice():[],o=r._raw.route_channel_mode;r._raw.route_channels=["main_bus"],r._raw.route_channel_mode="prefer",n("*");const a=s(e);r._raw.route_channel_mode="avoid",n("*");const l=s(e);return r._raw.route_channels=i,r._raw.route_channel_mode=o,n("*"),{ok:!!a&&!!l&&l.meta.cost>=a.meta.cost,details:{preferCost:a?.meta.cost,avoidCost:l?.meta.cost}}}function o(){const e="line_channel_demo",r=t().getResolvedModel().overlays.find((t=>t.id===e));if(!r)return{ok:!1,details:"overlay missing"};r._raw=r._raw||{};const i=r._raw.route_channels?r._raw.route_channels.slice():[],o=r._raw.route_channel_mode;r._raw.route_channels=["main_bus","aux_bus"],r._raw.route_channel_mode="force",n("*");const a=s(e);return r._raw.route_channels=i,r._raw.route_channel_mode=o,n("*"),{ok:!!a&&a.meta.channel&&(!0===a.meta.channel.forcedOutside||100===a.meta.channel.coveragePct),details:a?.meta.channel||{}}}function a(){const e="line_channel_demo",r=t().getResolvedModel().overlays.find((t=>t.id===e));if(!r)return{ok:!1,details:"overlay missing"};r._raw=r._raw||{};const i={channels:r._raw.route_channels?r._raw.route_channels.slice():[],mode:r._raw.route_channel_mode,modeFull:r._raw.route_mode_full};r._raw.route_mode_full="grid",r._raw.route_channels=["main_bus"],r._raw.route_channel_mode="prefer",n("*");const o=s(e);if(!o||!o.meta.channel)return r._raw.route_channels=i.channels,r._raw.route_channel_mode=i.mode,r._raw.route_mode_full=i.modeFull,n("*"),{ok:!1,details:"channel meta missing"};const a=o.meta.channel.coveragePct;try{if(t().setAnchor&&t().setAnchor){const e=r._raw.anchor,s=t().getResolvedModel();if(s?.anchors?.[e]){const r=s.anchors[e].slice();t().setAnchor(e,[r[0]-120,r[1]]),n("*")}}}catch{}const l=s(e),c=l?.meta?.channel?.coveragePct??a;return r._raw.route_channels=i.channels,r._raw.route_channel_mode=i.mode,r._raw.route_mode_full=i.modeFull,n("*"),{ok:c>=a,details:{coverageBefore:a,coverageAfter:c}}}e.__msdScenarios=e.__msdScenarios||{};const l={prefer_improves_cost:r,avoid_increases_cost:i,force_penalty_or_full_coverage:o,prefer_shaping_coverage:a,force_downgrade_or_full:function(){const e="line_channel_demo",r=t().getResolvedModel().overlays.find((t=>t.id===e));if(!r)return{ok:!1,details:"overlay missing"};r._raw=r._raw||{};const i={channels:r._raw.route_channels?r._raw.route_channels.slice():[],mode:r._raw.route_channel_mode};r._raw.route_channels=["main_bus","aux_bus"],r._raw.route_channel_mode="force",n("*");const o=s(e),a=o?.meta?.channel;return r._raw.route_channels=i.channels,r._raw.route_channel_mode=i.mode,n("*"),a?{ok:100===a.coveragePct||a.shaping&&a.shaping.downgraded,details:a}:{ok:!1,details:"no channel meta"}},channel_acceptance:function(){const e=r(),t=i(),s=o(),n=a();return{ok:[e,t,s,n].every((e=>e&&e.ok)),details:{prefer:e,avoid:t,force:s,shaping:n}}}},c={list:()=>Object.keys(l),run:e=>{if(!l[e])return console.warn("[MSD Channel Scenario] Unknown",e),null;try{const t=l[e]();return console.log(`[MSD Channel Scenario] ${e}: ${t.ok?"OK":"FAIL"}`,t),t}catch(t){const s={ok:!1,details:String(t)};return console.log(`[MSD Channel Scenario] ${e}: FAIL`,s),s}},runAll:()=>{const e={};for(const t of Object.keys(l))e[t]=c.run(t);const t=Object.values(e).every((e=>e&&e.ok));return console.log("[MSD Channel Scenario] Summary:",t?"ALL PASS":"FAILURES",e),e}};e.__msdScenarios.channels=c,console.info("[MSD v1] Channel routing scenario harness installed. Use: window.__msdScenarios.channels.list()")}()},372:()=>{!function(){if("undefined"==typeof window)return;const e=window;function t(){const t=e.__msdDebug?.pipelineInstance;if(!t||!1===t.enabled)throw new Error("Pipeline disabled or missing.");return t}function s(){return e.__msdDebug?.lastRenderModel||t().getResolvedModel?.()||null}function n(e){return function(){const e=s();return e?.overlays||[]}().find((t=>t.id===e))}function r(t){return e.__msdDebug?.routing?.inspect(t)}function i(t="*"){e.__msdDebug?.routing?.invalidate(t)}function o(e,t){const s=t.ok?"color:#4caf50":"color:#f44336";console.log(`%c[MSD Scenario] ${e}: ${t.ok?"OK":"FAIL"}`,s,t)}e.__msdScenarios=e.__msdScenarios||{};const a={cache:function(){const e="line_grid_forced";i("*");const t=r(e),s=r(e);return{ok:!!t&&!!s&&!1===t.meta.cache_hit&&!0===s.meta.cache_hit,details:{firstHit:t?.meta.cache_hit,secondHit:s?.meta.cache_hit}}},grid_vs_manhattan:function(){const e=r("line_grid_forced"),t=r("line_manhattan_baseline");return{ok:!!e&&!!t&&e.meta.strategy.startsWith("grid")&&t.meta.strategy.startsWith("manhattan"),details:{gridStrategy:e?.meta.strategy,manStrategy:t?.meta.strategy}}},avoid_creates_bend:function(){const e="line_smart_clear",t=n(e);if(!t)return{ok:!1,details:"overlay not found"};const s=r(e);t._raw=t._raw||{};const o=Array.isArray(t._raw.avoid)?t._raw.avoid.slice():void 0;t._raw.avoid||(t._raw.avoid=[]),t._raw.avoid.includes("obstacle_vertical")||t._raw.avoid.push("obstacle_vertical"),i("*");const a=r(e);return void 0===o?delete t._raw.avoid:t._raw.avoid=o,i("*"),{ok:!!s&&!!a&&a.meta.bends>=s.meta.bends,details:{bendsBefore:s?.meta.bends,bendsAfter:a?.meta.bends}}},mode_hint_yx:function(){const e="line_grid_forced",t=n(e);if(!t)return{ok:!1,details:"overlay not found"};t._raw=t._raw||{},t._raw.route_mode="xy",i("*");const s=r(e);t._raw.route_mode="yx",i("*");const o=r(e);delete t._raw.route_mode,i("*");const a=s?.pts||[],l=o?.pts||[],c=a.length>=3&&a[1][1]===a[0][1],d=l.length>=3&&l[1][0]===l[0][0];return{ok:c&&d,details:{basePts:a,yxPts:l,baseHorizontalFirst:c,yxVerticalFirst:d}}},clearance_shift:function(){const e="line_grid_forced",s=t().router;if(!s)return{ok:!1,details:"router missing"};i("*");const n=r(e),o=s.config.clearance;s.config.clearance=(o||8)+24,i("*");const a=r(e);return s.config.clearance=o,i("*"),{ok:!!n&&!!a&&a.meta.cost>=n.meta.cost,details:{baseCost:n?.meta.cost,raisedCost:a?.meta.cost}}},anchor_move:function(){const e="smart_far_anchor",n=t(),o=s();if(!o?.anchors||!o.anchors[e])return{ok:!1,details:"anchor not present"};const a="line_smart_far_avoid";i("*");const l=r(a),c=o.anchors[e].slice(),d=n.setAnchor(e,[c[0]+40,c[1]]);i("*");const u=r(a);return n.setAnchor(e,c),i("*"),{ok:d&&!!l&&!!u&&l.pts[0][0]!==u.pts[0][0],details:{from:l?.pts[0],to:u?.pts[0],moved:d}}},fallback_impossible_grid:function(){const e=t().router;if(!e)return{ok:!1,details:"router missing"};const s=e._computeGrid;e._computeGrid=function(e){return"line_grid_forced"===e.id?null:s.call(this,e)},i("*");const n=r("line_grid_forced");return e._computeGrid=s,i("*"),{ok:!!n&&/manhattan|fallback/.test(n.meta.strategy),details:{strategy:n?.meta.strategy}}}},l={list:()=>Object.keys(a),run:e=>{if(!a[e])return console.warn("[MSD Scenario] Unknown",e),null;try{const t=a[e]();return o(e,t),t}catch(t){const s={ok:!1,details:String(t)};return o(e,s),s}},runAll:()=>{const e={};for(const t of Object.keys(a))e[t]=l.run(t);const t=Object.values(e).every((e=>e&&e.ok));return console.log("[MSD Scenario] Summary:",t?"ALL PASS":"FAILURES",e),e}};e.__msdScenarios.routing=l,console.info("[MSD v1] Routing scenario harness installed. Use: window.__msdScenarios.routing.list()")}()},157:()=>{!function(){if("undefined"==typeof window)return;const e=window;function t(t){return e.__msdDebug?.routing?.inspect(t)}function s(t="*"){e.__msdDebug?.routing?.invalidate(t)}function n(t,n,r){const i=e.__msdDebug?.lastRenderModel,o=i?.overlays?.find((e=>e.id===t));if(!o)throw new Error("overlay not found: "+t);o._raw=o._raw||{};const a=o._raw.route_mode_full;o._raw.route_mode_full=n;try{return s("*"),r()}finally{o._raw.route_mode_full=a,s("*")}}e.__msdScenarios=e.__msdScenarios||{};const r={smart_vs_grid_cost:function(){const e="line_grid_forced",s=n(e,"grid",(()=>t(e))),r=n(e,"smart",(()=>t(e)));return{ok:!!s&&!!r&&"smart"===r.meta.strategy&&r.meta.cost<=s.meta.cost+40,details:{gridCost:s?.meta.cost,smartCost:r?.meta.cost}}},smart_refinement_attempt:function(){const e="line_grid_forced",s=n(e,"smart",(()=>t(e))),r=s?.meta?.smart;return{ok:!!r&&r.detoursTried>=0,details:r}},smart_penalty_reduction:function(){const e="line_smart_blocked",s=n(e,"smart",(()=>t(e))),r=s?.meta;return r?.smart?{ok:r.smart.penaltyAfter<=r.smart.penaltyBefore,details:r.smart}:{ok:!1,details:"no smart meta"}},smart_cache_behavior:function(){const n="line_smart_forced_xy",r=e.__msdDebug?.lastRenderModel,i=r?.overlays?.find((e=>e.id===n));if(!i)return{ok:!1,details:"overlay not found"};i._raw=i._raw||{};const o=i._raw.route_mode_full;try{!function(t){const s=e.__msdDebug?.lastRenderModel,n=s?.overlays?.find((e=>e.id===t));if(!n)throw new Error("overlay not found: "+t);n._raw=n._raw||{},n._raw.route_mode_full="smart"}(n),s("*");const r=t(n),i=t(n);return{ok:!!r&&!!i&&!1===r.meta.cache_hit&&!0===i.meta.cache_hit,details:{firstHit:r?.meta.cache_hit,secondHit:i?.meta.cache_hit}}}catch(e){return{ok:!1,details:String(e)}}finally{i._raw.route_mode_full=o,s("*")}}},i={list:()=>Object.keys(r),run:e=>{if(!r[e])return console.warn("[MSD Smart Scenario] Unknown",e),null;try{const t=r[e]();return console.log(`[MSD Smart Scenario] ${e}: ${t.ok?"OK":"FAIL"}`,t),t}catch(t){const s={ok:!1,details:String(t)};return console.log(`[MSD Smart Scenario] ${e}: FAIL`,s),s}},runAll:()=>{const e={};for(const t of Object.keys(r))e[t]=i.run(t);const t=Object.values(e).every((e=>e&&e.ok));return console.log("[MSD Smart Scenario] Summary:",t?"ALL PASS":"FAILURES",e),e}};e.__msdScenarios.smart=i,console.info("[MSD v1] Smart routing scenario harness installed. Use: window.__msdScenarios.smart.list()")}()},786:()=>{!function(){if("undefined"==typeof window)return;const e=window;function t(t){return e.__msdDebug?.routing?.inspect(t)}function s(){e.__msdDebug?.routing?.invalidate("*")}e.__msdScenarios=e.__msdScenarios||{};const n="line_grid_forced";function r(){const t=function(){const t=e.__msdDebug?.pipelineInstance;if(!t||!t.enabled)throw new Error("pipeline disabled");return t}().getResolvedModel().overlays.find((e=>e.id===n));if(!t)throw new Error("overlay not found");return t._raw=t._raw||{},t}const i={smoothing_increases_points:function(){const e=r();e._raw.smoothing_mode="none",e._raw.smoothing_iterations=0,s();const i=t(n);e._raw.smoothing_mode="chaikin",e._raw.smoothing_iterations=2,s();const o=t(n);return delete e._raw.smoothing_mode,delete e._raw.smoothing_iterations,s(),{ok:!!i&&!!o&&o.pts.length>i.pts.length&&o.meta.smooth,details:{basePts:i?.pts.length,smoothPts:o?.pts.length,meta:o?.meta?.smooth}}},smoothing_cache_hit:function(){const e=r();e._raw.smoothing_mode="chaikin",e._raw.smoothing_iterations=1,s();const i=t(n),o=t(n);return delete e._raw.smoothing_mode,delete e._raw.smoothing_iterations,s(),{ok:!!i&&!!o&&!1===i.meta.cache_hit&&!0===o.meta.cache_hit,details:{firstHit:i?.meta.cache_hit,secondHit:o?.meta.cache_hit}}},smoothing_disabled_no_meta:function(){const e=r();e._raw.smoothing_mode="none",e._raw.smoothing_iterations=0,s();const i=t(n);return delete e._raw.smoothing_mode,delete e._raw.smoothing_iterations,s(),{ok:!!i&&!i.meta.smooth,details:{hasSmoothMeta:!!i.meta.smooth}}},smoothing_invalid_mode_fallback:function(){const e=r();e._raw.smoothing_mode="bogus_mode",e._raw.smoothing_iterations=2,s();const i=t(n);return delete e._raw.smoothing_mode,delete e._raw.smoothing_iterations,s(),{ok:!!i&&!i.meta.smooth,details:{hasSmoothMeta:!!i.meta.smooth}}}},o={list:()=>Object.keys(i),run:e=>{if(!i[e])return console.warn("[MSD Smooth Scenario] Unknown",e),null;try{const t=i[e]();return console.log(`[MSD Smooth Scenario] ${e}: ${t.ok?"OK":"FAIL"}`,t),t}catch(t){const s={ok:!1,details:String(t)};return console.log(`[MSD Smooth Scenario] ${e}: FAIL`,s),s}},runAll:()=>{const e={};for(const t of Object.keys(i))e[t]=o.run(t);const t=Object.values(e).every((e=>e&&e.ok));return console.log("[MSD Smooth Scenario] Summary:",t?"ALL PASS":"FAILURES",e),e}};e.__msdScenarios.smoothing=o,console.info("[MSD v1] Smoothing scenario harness installed. Use: window.__msdScenarios.smoothing.list()")}()},625:(e,t,s)=>{"use strict";s.r(t),s.d(t,{animateElement:()=>l,animateWithRoot:()=>a,applyPresets:()=>u,createTimeline:()=>c,createTimelines:()=>d,waitForElement:()=>i,waitForElements:()=>o});var n=s(191),r=s(152);function i(e,t=document,s=2e3){return new Promise(((n,r)=>{const i=t.querySelector(e);if(i)return n(i);const o=new MutationObserver((()=>{const s=t.querySelector(e);if(s){try{o.disconnect()}catch(e){}clearTimeout(a),n(s)}}));o.observe(t,{childList:!0,subtree:!0});const a=setTimeout((()=>{try{o.disconnect()}catch(e){}r(new Error(`[CB-LCARS] Timeout waiting for element: ${e}`))}),s)}))}async function o(e,t=document,s=2e3){const r=(o=e,Array.isArray(o)?o:o&&"number"==typeof o.length&&"function"==typeof o.item?Array.from(o):[o]).filter(Boolean);var o;const a=[];for(const e of r)try{if(e instanceof Element){a.push(e);continue}if("string"==typeof e){const n=e.split(",").map((e=>e.trim())).filter(Boolean);for(const e of n){const n=await i(e,t,s);n&&a.push(n);const r=t.querySelectorAll(e);for(const e of Array.from(r))a.includes(e)||a.push(e)}continue}n.lr.warn("[waitForElements] Unsupported target type, skipping.",{item:e})}catch(t){n.lr.error("[waitForElements] Failed to resolve target:",{item:e,error:t})}return a}async function a(e){const{targets:t,root:s=document,scopeId:r,...i}=e;if(t)try{const e=await o(t,s);if(0===e.length)return void n.lr.warn("[animateWithRoot] No targets resolved.",{targets:t});for(const t of e)try{let e;if(r&&window.cblcars.anim.scopes.has(r)){const s=window.cblcars.anim.scopes.get(r);e=window.cblcars.anime(t,{...i,scope:s.scope}),s.addAnimation(e)}else e=window.cblcars.anime(t,i)}catch(e){n.lr.error("[animateWithRoot] Failed to animate a resolved element.",{element:t?.id,error:e})}}catch(e){n.lr.error("[animateWithRoot] Failed to animate element(s):",{targets:t,error:e})}else n.lr.warn("[animateWithRoot] Animation missing targets.",{options:e})}async function l(e,t,s=null){const{type:a,targets:l,root:c=document,...d}=t;a&&l&&e?(n.lr.debug("[animateElement] Received options:",{options:t}),e.scope.add((async()=>{try{const h=await o(l,c);if(!h||0===h.length)return void n.lr.error("[animateElement] Target element(s) not found:",{targets:l});for(const o of h){const l={duration:1e3,easing:"easeInOutQuad",...d};if(t.state_resolver&&t.entity&&window.cblcars.styleHelpers?.resolveStateStyles){const e=window.cblcars.styleHelpers.resolveStateStyles(t.state_resolver,s,t.entity);Object.assign(l,e)}if(Array.isArray(a))u(a,l,o,t);else{const e=r.m[String(a).toLowerCase()];if(e)await e(l,o,t);else if("morph"===String(a).toLowerCase()){if(!t.morph_to_selector){n.lr.error("[animateElement] morph animation requires a `morph_to_selector`.",{options:t});continue}const e=await i(t.morph_to_selector,c);if(!e){n.lr.error(`[animateElement] morph could not find target shape for selector: ${t.morph_to_selector}`);continue}const s=t.precision?parseInt(t.precision,10):void 0;Object.assign(l,{d:window.cblcars.animejs.svg.morphTo(e,s)})}else n.lr.debug(`[animateElement] Using standard animation for type: ${a}`,{params:l})}l._cssAnimation||null===l.targets||(window.cblcars.anim.anime(o,l),n.lr.debug(`[animateElement] Animation constructor added to scope: ${e.id}`,{params:l,element:o.id}))}}catch(e){n.lr.error("[animateElement] Failed to animate element(s):",{targets:l,type:a,error:e})}}))):n.lr.warn("[animateElement] Animation missing type, targets, or scope.",{options:t,scope:e})}async function c(e,t,s=document){const n=window.cblcars.anim.scopes.get(t),r=window.cblcars.anim.animejs.createTimeline({scope:n?.scope});if(!Array.isArray(e))return r;for(const t of e){const{targets:e,offset:n,...i}=t||{};if(!e)continue;const o=await window.cblcars.anim.waitForElement(e,s);o&&r.add(o,i,n)}return n&&n.addAnimation?.(r),r}async function d(e,t,s=document,i={},a=null,l={}){const c=window.cblcars.anim.scopes.get(t);if(!c)return n.lr.error("[createTimelines] Scope not found:",t),{};const d={},u=window.cblcars.styleHelpers?.resolveAllDynamicValues;for(const[t,h]of Object.entries(e||{})){const{steps:e,...p}=h||{},g=u?u(p,a):p,m=window.cblcars.anim.animejs.createTimeline({scope:c.scope,...g});if(e&&Array.isArray(e)){for(const c of e){let e=[];try{e=await o(c.targets,s)}catch(e){n.lr.error(`[createTimelines] Failed to find target(s) for "${t}":`,{targets:c.targets,error:e});continue}if(e&&0!==e.length)for(const s of e){let e={...i?.[s.id]?.animation||{},...g,...c};if(c?.state_resolver&&window.cblcars.styleHelpers?.resolveStatePreset)try{const t=window.cblcars.styleHelpers.resolveStatePreset({state_resolver:c.state_resolver,entity:c.entity,attribute:c.attribute},l,a);t&&"object"==typeof t&&(e=t.animation&&"object"==typeof t.animation?{...e,...t.animation}:{...e,...t})}catch(e){n.lr.warn("[createTimelines] step.state_resolver failed",{timelineName:t,step:c,error:e})}e=u?u(e,a):e,"pulse"!==e.type&&"glow"!==e.type||"text"!==s.tagName&&"TEXT"!==s.tagName||(s.style.transformOrigin="center",s.style.transformBox="fill-box"),e.type&&r.m[e.type]&&(e.__timeline=!0,await r.m[e.type](e,s,e));const{targets:o,offset:d,direction:h,state_resolver:p,preset:f,entity:y,attribute:b,__timeline:_,deep:v,descendants:w,apply_to:S,...x}=e,$=!0===e.descendants||!0===e.deep||"descendants"===e.apply_to,C=["fill","stroke","stroke-width","filter","color","opacity"],k={};for(const e of C)void 0===x[e]||Array.isArray(x[e])||"object"==typeof x[e]||(k[e]=x[e]);if(Object.keys(k).length){const e=x.onBegin;x.onBegin=()=>{try{const e=$?s.querySelectorAll("*"):[s];window.cblcars?.anim?.utils?.set?e.forEach((e=>window.cblcars.anim.utils.set(e,k))):e.forEach((e=>{for(const[t,s]of Object.entries(k))t in e.style?e.style[t]=s:e.setAttribute(t,s)}))}catch(e){}"function"==typeof e&&e()}}m.add(s,x,d)}else n.lr.warn(`[createTimelines] No elements found for timeline "${t}" step:`,{targets:c.targets})}"function"==typeof c.addAnimation&&c.addAnimation(m),d[t]=m,!1===g?.autoplay&&n.lr.info(`[createTimelines] Timeline "${t}" created with autoplay: false.`)}else n.lr.warn(`[createTimelines] Timeline "${t}" has no steps array.`),d[t]=m}return d}function u(e,t,s,n){const i=Array.isArray(e)?e:[e];for(const e of i){const i=r.m[e.toLowerCase()];i&&i(t,s,n?.[e]||n)}}},152:(e,t,s)=>{"use strict";s.d(t,{m:()=>i});var n=s(191),r=s(988);const i={draw:(e,t,s={})=>{const[n]=window.cblcars.animejs.svg.createDrawable(t),r=e.duration??s.duration??1200,i=e.easing??s.easing??"easeInOutSine",o=e.loop??s.loop??!1,a=e.alternate??s.alternate??!1,l=e.draw||s.draw||{};let c;c=Array.isArray(l)?l:l&&Array.isArray(l.values)?l.values:["0 0","0 1"],Object.assign(e,{targets:n,draw:c,duration:r,easing:i,loop:o,alternate:a}),delete e.opacity,delete e["stroke-width"]},pulse:(e,t,s={})=>{n.lr.debug("[pulse preset] Before mutation:",{params:e,element:t,options:s});const r=e.pulse||s.pulse||s||{},i=void 0!==r.max_scale?r.max_scale:"text"===t.tagName||"TEXT"===t.tagName?1.1:1.5,o=void 0!==r.min_opacity?r.min_opacity:.7;delete e["stroke-width"],delete e.opacity;const a=e.duration??s.duration??1200,l=e.easing??s.easing??"easeInOutSine",c=e.loop??s.loop??!0,d=e.alternate??s.alternate??!0;if("text"===t.tagName||"TEXT"===t.tagName)Object.assign(e,{scale:[1,i],opacity:[1,o],easing:l,duration:a,loop:c,alternate:d}),t.style.transformOrigin="center",t.style.transformBox="fill-box",n.lr.debug("[pulse preset] Set transformOrigin/transformBox for text:",{id:t.id,style:t.style.cssText});else if(t.hasAttribute("stroke-width")){const s=parseFloat(t.getAttribute("stroke-width"))||4;Object.assign(e,{"stroke-width":[s,s*i],opacity:[1,o],easing:l,duration:a,loop:c,alternate:d}),n.lr.debug("[pulse preset] Pulsing line:",{id:t.id,strokeWidth:s,maxScale:i})}else Object.assign(e,{opacity:[1,o],easing:l,duration:a,loop:c,alternate:d});n.lr.debug("[pulse preset] After mutation:",{params:e,element:t})},blink:(e,t,s)=>{Object.assign(e,{opacity:[s.max_opacity??1,s.min_opacity??.3],alternate:!0,loop:!0,easing:s.easing||"linear",duration:s.duration??1200})},fade:(e,t,s={})=>{const n=e.duration??s.duration??1e3,r=e.easing??s.easing??"linear",i=e.loop??s.loop??!1,o=e.alternate??s.alternate??!1;Object.assign(e,{opacity:[0,1],duration:n,easing:r,loop:i,alternate:o})},motionpath:async function(e,t,s={}){try{const i=s.root??document;!window.cblcars.waitForElement&&window.cblcars.anim?.waitForElement&&(window.cblcars.waitForElement=window.cblcars.anim.waitForElement);const o=s.tracer;if(!o){const s="[motionpath] tracer is required";return n.lr.warn(s,{element:t}),void(e.targets=null)}const a=s.path_selector;let l=a?await window.cblcars.waitForElement(a,i).catch((()=>null)):t;if(!l){const t=`Motionpath: path not found for selector "${a||"(self)"}"`;return n.lr.error(t),void(e.targets=null)}if("path"!==String(l.tagName).toLowerCase()){const t="[motionpath] Target is not an SVG <path>";return n.lr.warn(t,{id:l.id}),void(e.targets=null)}const c=l.id||"msd_path",d=e=>!(!e||"string"!=typeof e)&&/[LCHQAVZlchqavz]/.test(e),u=e=>{try{return e.getTotalLength()>.5}catch(e){return!1}},h=e=>"true"===e?.getAttribute("data-cblcars-pending"),p=()=>{const e=l.ownerSVGElement||l.closest("svg")||i;if(!e)return;const t=e.querySelector(`#${c}_tracer[data-cblcars-owned="motionpath"]`),s=e.querySelector(`#${c}_trail[data-cblcars-owned="motionpath"]`);t?.parentNode&&t.parentNode.removeChild(t),s?.parentNode&&s.parentNode.removeChild(s)};let g=null,m=null,f=null,y=!0;const b=()=>{const t=s.trail;if(t)try{g=l.cloneNode(!0),g.id=`${c}_trail`,g.setAttribute("data-cblcars-owned","motionpath");const n=t.stroke||l.getAttribute("stroke")||"var(--lcars-yellow)",r=t["stroke-width"]??s["stroke-width"]??l.getAttribute("stroke-width")??4;g.setAttribute("stroke",n),g.setAttribute("stroke-width",r),void 0!==t.opacity&&g.setAttribute("opacity",t.opacity),"single"===(t.mode||"overlay")&&(l.setAttribute("opacity","0"),l.setAttribute("stroke","none")),h(l)&&g.setAttribute("visibility","hidden"),l.parentNode.insertBefore(g,l.nextSibling);const[i]=window.cblcars.animejs.svg.createDrawable(g),o={draw:"0 1",duration:t.duration??e.duration??1e3,easing:t.easing??e.easing??"linear",loop:t.loop??e.loop??!0};window.cblcars.anim.anime(i,o)}catch(e){n.lr.error("[motionpath] Trail setup failed:",e)}},_=()=>{let e=o.id||`${c}_tracer`;const t=l.ownerSVGElement||l.closest("svg")||l.parentNode,s=t?t.getElementById?.(e):null;let n;s&&"motionpath"!==s.getAttribute("data-cblcars-owned")&&(e=`${e}_mptrc`),n="rect"===o.shape?r.drawRect({x:-(o.width||8)/2,y:-(o.height||8)/2,width:o.width||8,height:o.height||8,id:e,attrs:{fill:o.fill||"var(--lcars-orange)"},style:o.style||{}}):r.drawCircle({cx:0,cy:0,r:o.r||4,id:e,attrs:{fill:o.fill||"var(--lcars-orange)"},style:o.style||{}});const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.innerHTML=n,m=i.firstElementChild,m.setAttribute("data-cblcars-owned","motionpath"),(t||l.parentNode).appendChild(m)},v=()=>{if(!m||!l)return;const{translateX:t,translateY:n,rotate:r}=window.cblcars.animejs.svg.createMotionPath(l),i=new Set(["tracer","trail","path_selector","root","targets","type","animation","stroke","stroke-width","corner_style","corner_radius","waypoints","steps","rounded","smooth","smooth_tension","id"]),o={};Object.entries({...e,...s}).forEach((([e,t])=>{i.has(e)||(o[e]=t)}));try{m.__cblcars_motion&&"function"==typeof m.__cblcars_motion.pause&&m.__cblcars_motion.pause()}catch(e){}m.__cblcars_motion=window.cblcars.anim.anime(m,{...o,translateX:t,translateY:n,rotate:r})},w=(e="")=>{try{if(!d(l.getAttribute("d"))||!u(l))return;g&&(g.setAttribute("d",l.getAttribute("d")||""),h(l)?g.setAttribute("visibility","hidden"):g.removeAttribute("visibility")),v()}catch(t){n.lr.warn("[motionpath] rebind failed",{reason:e,e:t})}},S=()=>{b(),_(),w("initial")},x=Number.isFinite(s.wait_max_ms)?s.wait_max_ms:12e3,$=120,C=performance.now(),k=()=>new Promise((e=>{const t=()=>{if(!y)return e(!1);const s=l.getAttribute("d")||"",n=h(l),r=d(s)&&u(l);return!n&&r?e(!0):!n&&performance.now()-C>=x?e(!1):void setTimeout(t,$)};t()}));if(p(),!await k()){const t=`[motionpath] Timed out waiting for usable path geometry (id=${l.id})`;return n.lr.warn(t),void(e.targets=null)}S();try{f=new MutationObserver((e=>{let t=!1;for(const s of e)if("attributes"===s.type&&("d"===s.attributeName||"data-cblcars-pending"===s.attributeName)){t=!0;break}t&&(g&&h(l)&&g.setAttribute("visibility","hidden"),w("mutation"))})),f.observe(l,{attributes:!0,attributeFilter:["d","data-cblcars-pending"]})}catch(e){}const A=l.id,M=()=>{if(!y)return;const e=i.getElementById&&i.getElementById(A)||l;if(e!==l&&e instanceof SVGPathElement){n.lr.debug("[motionpath] Path element replaced; reinitializing",{id:A});try{f?.disconnect()}catch(e){}l=e,p(),g=null,m=null,k().then((e=>{if(e){S();try{f=new MutationObserver((e=>{let t=!1;for(const s of e)if("attributes"===s.type&&("d"===s.attributeName||"data-cblcars-pending"===s.attributeName)){t=!0;break}t&&w("mutation(replaced)")})),f.observe(l,{attributes:!0,attributeFilter:["d","data-cblcars-pending"]})}catch(e){}}}))}setTimeout(M,2e3)};setTimeout(M,2e3),e.targets=null,t.__cblcars_motionpath_cleanup=()=>{y=!1;try{f?.disconnect()}catch(e){}try{m?.__cblcars_motion?.pause&&m.__cblcars_motion.pause()}catch(e){}try{p()}catch(e){}}}catch(t){n.lr.error("[motionpath] Unhandled error",t),e.targets=null}},march:(e,t,s={})=>{let r=e.stroke_dasharray??s.stroke_dasharray??[25,15];(!Array.isArray(r)||r.length<2)&&(r=[25,15]);const[i,o]=r;t.style.strokeDasharray=`${i} ${o}`,t.style.strokeDashoffset=0;const a=e.stroke_linecap??s.stroke_linecap;a&&(t.style.strokeLinecap=a);const l=i+o,c=(e.duration??s.duration??2e3)/1e3;let d=e.reversed??s.reversed??!1;const u=t.id||`march_${Math.random().toString(36).substring(2,9)}`;t.dataset.marchAnimId=u;const h=d?l:-l;let p=e.loop??s.loop??!0;const g=!0===p?"infinite":!1===p||0===p?"1":"number"==typeof p?Math.max(1,p):"infinite",m=t.getRootNode(),f=m!==document,y=`march_${u}`,b=`@keyframes ${y} { to { stroke-dashoffset: ${h}px; } }`,_=c/(e.playbackRate??s.playbackRate??1)+"s";if(t.style.animation=`${y} ${_} linear ${g}`,f&&m.adoptedStyleSheets)try{let e=Array.from(m.adoptedStyleSheets).find((e=>e.marchAnimations));e||(e=new CSSStyleSheet,e.marchAnimations=!0,m.adoptedStyleSheets=[...m.adoptedStyleSheets,e]),e.insertRule(b,e.cssRules.length)}catch(e){n.lr.error("Failed to add CSS animation to Shadow DOM:",e),v()}else v();function v(){const e="march-smooth-css-animations";let t=m.getElementById?m.getElementById(e):null;t||(t=document.createElement("style"),t.id=e,(f?m:document.head).appendChild(t)),t.textContent.includes(y)||(t.textContent+=b)}Object.assign(e,{_cssAnimation:!0,duration:1,loop:!1,autoplay:!1})},glow:(e,t,s={})=>{n.lr.debug("[glow preset] Before mutation:",{params:e,element:t,options:s});const r=s.glow||{},i=r.color||s.color||"var(--picard-light-blue)",o=r.intensity??s.intensity??.8,a=r.blur_min??0,l=r.blur_max??12,c=r.opacity_min??.4,d=r.opacity_max??o,u=s.duration??r.duration??900,h=s.easing??r.easing??"easeInOutSine",p=s.loop??r.loop??!0,g=s.alternate??r.alternate??!0,m={blur:a,opacity:c};Object.assign(e,{targets:m,blur:[a,l,a],opacity:[c,d,c],duration:u,easing:h,loop:p,alternate:g,onUpdate(){"text"===t.tagName||"TEXT"===t.tagName?t.style.filter=`drop-shadow(0 0 ${m.blur}px ${i}) opacity(${m.opacity})`:t.style.filter=`drop-shadow(0 0 ${m.blur}px ${i})`}}),delete e.fill,delete e.stroke,t.style.transformOrigin="center",t.style.transformBox="fill-box",n.lr.debug("[glow preset] Animating drop-shadow:",{color:i,intensity:o,blurMin:a,blurMax:l,opacityMin:c,opacityMax:d,duration:u,easing:h,loop:p,alternate:g}),n.lr.debug("[glow preset] After mutation:",{params:e,element:t})},shimmer:(e,t,s={})=>{const n=s.color||"var(--lcars-yellow)";Object.assign(e,{opacity:[1,.5,1],fill:[t.getAttribute("fill")||n,n],alternate:!0,loop:!0,easing:"easeInOutSine",duration:s.duration??1200})},strobe:(e,t,s={})=>{Object.assign(e,{opacity:[1,.1],alternate:!0,loop:!0,easing:"steps(2, end)",duration:s.duration??400})},cascade:(e,t,s={})=>{Object.assign(e,{opacity:[0,1],delay:window.cblcars.animejs.stagger(s.stagger??100),easing:"easeOutQuad",duration:s.duration??800})},ripple:(e,t,s={})=>{Object.assign(e,{scale:[1,s.max_scale??2,1],opacity:[1,.3,1],alternate:!0,loop:!0,easing:"easeInOutSine",duration:s.duration??1200})},flicker:(e,t,s={})=>{Object.assign(e,{opacity:[1,.7+.3*Math.random(),.4+.3*Math.random(),1],alternate:!1,loop:!0,easing:"steps(4, end)",duration:s.duration??600})},set:(e,t,s={})=>{if(s&&s.__timeline)return;const r=["type","targets","root","animation","id","offset","__timeline"],i={...e,...s},o={};Object.entries(i).forEach((([e,t])=>{r.includes(e)||void 0===t||(o[e]=t)}));let a=!1;try{window.cblcars?.anim?.utils?.set&&(window.cblcars.anim.utils.set(t,o),a=!0)}catch(e){n.lr.warn("[set preset] animejs.utils.set() failed, will fallback to manual mutation.",{e})}if(!a)for(const[e,s]of Object.entries(o))try{e in t.style?t.style[e]=s:t.setAttribute(e,s)}catch(t){n.lr.warn(`[set preset] Could not set "${e}"="${s}" manually`,{e:t})}e._cssAnimation=!0,e.targets=null}}},191:(e,t,s)=>{"use strict";s.d(t,{lr:()=>l,mD:()=>i,mZ:()=>o,zf:()=>c});var n=s(640);let r="info";function i(e){r=e,l.info(`Setting CBLCARS global log level set to: ${e}`,{},"info")}function o(){return r}function a(e,...t){const s=["error","warn","info","debug"],n=s.indexOf(r);if(s.indexOf(e)>n)return;const i={info:"background-color: #37a6d1",warn:"background-color: #ff6753",error:"background-color: #ef1d10",debug:"background-color: #8e44ad",default:"background-color: #6d748c"},o=`%c    CB-LCARS | ${e} `,a=`${i[e]||i.default}; color: white; padding: 1px 4px; border-radius: 15px;`;switch(e){case"info":default:console.log(o,a,...t);break;case"warn":console.warn(o,a,...t);break;case"error":console.error(o,a,...t);break;case"debug":console.debug(o,a,...t)}}function l(e,...t){return a(e,...t)}function c(){const e=n.WG,t=n.i_,s="CB-LCARS v"+e,r=t.length+4-s.length,i=r>0?" ".repeat(r):"",o=" ".repeat(4)+t;console.info(`%c${i}${s}  %c\n%c${o}  `,["color: white","font-weight: bold","padding: 2px 4px","border-radius: 5em 5em 0 0","background-color: #37a6d1"].join(";"),["color: transparent","padding: 0","border: none"].join(";"),["color: white","padding: 2px 4px","border-radius: 0 0 5em 5em","background-color: #37a6d1"].join(";"))}window.cblcars=window.cblcars||{},window.cblcars.setGlobalLogLevel=i,window.cblcars.getGlobalLogLevel=o,["error","warn","info","debug"].forEach((e=>{window.cblcars.setGlobalLogLevel[e]=()=>i(e)})),l.log=(...e)=>a("info",...e),l.info=(...e)=>a("info",...e),l.warn=(...e)=>a("warn",...e),l.error=(...e)=>a("error",...e),l.debug=(...e)=>a("debug",...e)},988:(e,t,s)=>{"use strict";function n({x1:e,y1:t,x2:s,y2:n,id:r,attrs:i={},style:o={}}){return`<line id="${r||""}" x1="${e}" y1="${t}" x2="${s}" y2="${n}"${c(i)}${d(o)} />`}function r({points:e,id:t,attrs:s={},style:n={}}){return`<polyline id="${t||""}" points="${e.map((e=>e.join(","))).join(" ")}"${c(s)}${d(n)} />`}function i({d:e,id:t,attrs:s={},style:n={}}){return`<path id="${t||""}" d="${e}"${c(s)}${d(n)} />`}function o({x:e,y:t,text:s,id:n,attrs:r={},style:i={}}){return`<text id="${n||""}" x="${e}" y="${t}"${c(r)}${d(i)}>${s}</text>`}function a({cx:e,cy:t,r:s,id:n,attrs:r={},style:i={}}){return`<circle id="${n||""}" cx="${e}" cy="${t}" r="${s}"${c(r)}${d(i)} />`}function l({x:e,y:t,width:s,height:n,id:r,attrs:i={},style:o={}}){return`<rect id="${r||""}" x="${e}" y="${t}" width="${s}" height="${n}"${c(i)}${d(o)} />`}function c(e){return e&&"object"==typeof e?Object.entries(e).map((([e,t])=>` ${e.replace(/[A-Z]/g,(e=>"-"+e.toLowerCase()))}="${t}"`)).join(""):""}function d(e){if(!e||"object"!=typeof e)return"";const t=Object.entries(e).map((([e,t])=>`${e.replace(/[A-Z]/g,(e=>"-"+e.toLowerCase()))}:${t}`)).join(";");return t?` style="${t}"`:""}s.r(t),s.d(t,{attrsToString:()=>c,drawCircle:()=>a,drawLine:()=>n,drawPath:()=>i,drawPolyline:()=>r,drawRect:()=>l,drawText:()=>o,styleToString:()=>d})},752:(e,t,s)=>{"use strict";s.d(t,{JW:()=>C,XX:()=>G,c0:()=>A,ej:()=>k,ge:()=>H,qy:()=>$,s6:()=>M});const n=globalThis,r=n.trustedTypes,i=r?r.createPolicy("lit-html",{createHTML:e=>e}):void 0,o="$lit$",a=`lit$${Math.random().toFixed(9).slice(2)}$`,l="?"+a,c=`<${l}>`,d=document,u=()=>d.createComment(""),h=e=>null===e||"object"!=typeof e&&"function"!=typeof e,p=Array.isArray,g=e=>p(e)||"function"==typeof e?.[Symbol.iterator],m="[ \t\n\f\r]",f=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,y=/-->/g,b=/>/g,_=RegExp(`>|${m}(?:([^\\s"'>=/]+)(${m}*=${m}*(?:[^ \t\n\f\r"'\`<>=]|("|')|))|$)`,"g"),v=/'/g,w=/"/g,S=/^(?:script|style|textarea|title)$/i,x=e=>(t,...s)=>({_$litType$:e,strings:t,values:s}),$=x(1),C=x(2),k=x(3),A=Symbol.for("lit-noChange"),M=Symbol.for("lit-nothing"),D=new WeakMap,E=d.createTreeWalker(d,129);function T(e,t){if(!p(e)||!e.hasOwnProperty("raw"))throw Error("invalid template strings array");return void 0!==i?i.createHTML(t):t}const R=(e,t)=>{const s=e.length-1,n=[];let r,i=2===t?"<svg>":3===t?"<math>":"",l=f;for(let t=0;t<s;t++){const s=e[t];let d,u,h=-1,p=0;for(;p<s.length&&(l.lastIndex=p,u=l.exec(s),null!==u);)p=l.lastIndex,l===f?"!--"===u[1]?l=y:void 0!==u[1]?l=b:void 0!==u[2]?(S.test(u[2])&&(r=RegExp("</"+u[2],"g")),l=_):void 0!==u[3]&&(l=_):l===_?">"===u[0]?(l=r??f,h=-1):void 0===u[1]?h=-2:(h=l.lastIndex-u[2].length,d=u[1],l=void 0===u[3]?_:'"'===u[3]?w:v):l===w||l===v?l=_:l===y||l===b?l=f:(l=_,r=void 0);const g=l===_&&e[t+1].startsWith("/>")?" ":"";i+=l===f?s+c:h>=0?(n.push(d),s.slice(0,h)+o+s.slice(h)+a+g):s+a+(-2===h?t:g)}return[T(e,i+(e[s]||"<?>")+(2===t?"</svg>":3===t?"</math>":"")),n]};class O{constructor({strings:e,_$litType$:t},s){let n;this.parts=[];let i=0,c=0;const d=e.length-1,h=this.parts,[p,g]=R(e,t);if(this.el=O.createElement(p,s),E.currentNode=this.el.content,2===t||3===t){const e=this.el.content.firstChild;e.replaceWith(...e.childNodes)}for(;null!==(n=E.nextNode())&&h.length<d;){if(1===n.nodeType){if(n.hasAttributes())for(const e of n.getAttributeNames())if(e.endsWith(o)){const t=g[c++],s=n.getAttribute(e).split(a),r=/([.?@])?(.*)/.exec(t);h.push({type:1,index:i,name:r[2],strings:s,ctor:"."===r[1]?B:"?"===r[1]?I:"@"===r[1]?z:F}),n.removeAttribute(e)}else e.startsWith(a)&&(h.push({type:6,index:i}),n.removeAttribute(e));if(S.test(n.tagName)){const e=n.textContent.split(a),t=e.length-1;if(t>0){n.textContent=r?r.emptyScript:"";for(let s=0;s<t;s++)n.append(e[s],u()),E.nextNode(),h.push({type:2,index:++i});n.append(e[t],u())}}}else if(8===n.nodeType)if(n.data===l)h.push({type:2,index:i});else{let e=-1;for(;-1!==(e=n.data.indexOf(a,e+1));)h.push({type:7,index:i}),e+=a.length-1}i++}}static createElement(e,t){const s=d.createElement("template");return s.innerHTML=e,s}}function L(e,t,s=e,n){if(t===A)return t;let r=void 0!==n?s._$Co?.[n]:s._$Cl;const i=h(t)?void 0:t._$litDirective$;return r?.constructor!==i&&(r?._$AO?.(!1),void 0===i?r=void 0:(r=new i(e),r._$AT(e,s,n)),void 0!==n?(s._$Co??=[])[n]=r:s._$Cl=r),void 0!==r&&(t=L(e,r._$AS(e,t.values),r,n)),t}class P{constructor(e,t){this._$AV=[],this._$AN=void 0,this._$AD=e,this._$AM=t}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}u(e){const{el:{content:t},parts:s}=this._$AD,n=(e?.creationScope??d).importNode(t,!0);E.currentNode=n;let r=E.nextNode(),i=0,o=0,a=s[0];for(;void 0!==a;){if(i===a.index){let t;2===a.type?t=new N(r,r.nextSibling,this,e):1===a.type?t=new a.ctor(r,a.name,a.strings,this,e):6===a.type&&(t=new j(r,this,e)),this._$AV.push(t),a=s[++o]}i!==a?.index&&(r=E.nextNode(),i++)}return E.currentNode=d,n}p(e){let t=0;for(const s of this._$AV)void 0!==s&&(void 0!==s.strings?(s._$AI(e,s,t),t+=s.strings.length-2):s._$AI(e[t])),t++}}class N{get _$AU(){return this._$AM?._$AU??this._$Cv}constructor(e,t,s,n){this.type=2,this._$AH=M,this._$AN=void 0,this._$AA=e,this._$AB=t,this._$AM=s,this.options=n,this._$Cv=n?.isConnected??!0}get parentNode(){let e=this._$AA.parentNode;const t=this._$AM;return void 0!==t&&11===e?.nodeType&&(e=t.parentNode),e}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(e,t=this){e=L(this,e,t),h(e)?e===M||null==e||""===e?(this._$AH!==M&&this._$AR(),this._$AH=M):e!==this._$AH&&e!==A&&this._(e):void 0!==e._$litType$?this.$(e):void 0!==e.nodeType?this.T(e):g(e)?this.k(e):this._(e)}O(e){return this._$AA.parentNode.insertBefore(e,this._$AB)}T(e){this._$AH!==e&&(this._$AR(),this._$AH=this.O(e))}_(e){this._$AH!==M&&h(this._$AH)?this._$AA.nextSibling.data=e:this.T(d.createTextNode(e)),this._$AH=e}$(e){const{values:t,_$litType$:s}=e,n="number"==typeof s?this._$AC(e):(void 0===s.el&&(s.el=O.createElement(T(s.h,s.h[0]),this.options)),s);if(this._$AH?._$AD===n)this._$AH.p(t);else{const e=new P(n,this),s=e.u(this.options);e.p(t),this.T(s),this._$AH=e}}_$AC(e){let t=D.get(e.strings);return void 0===t&&D.set(e.strings,t=new O(e)),t}k(e){p(this._$AH)||(this._$AH=[],this._$AR());const t=this._$AH;let s,n=0;for(const r of e)n===t.length?t.push(s=new N(this.O(u()),this.O(u()),this,this.options)):s=t[n],s._$AI(r),n++;n<t.length&&(this._$AR(s&&s._$AB.nextSibling,n),t.length=n)}_$AR(e=this._$AA.nextSibling,t){for(this._$AP?.(!1,!0,t);e&&e!==this._$AB;){const t=e.nextSibling;e.remove(),e=t}}setConnected(e){void 0===this._$AM&&(this._$Cv=e,this._$AP?.(e))}}class F{get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}constructor(e,t,s,n,r){this.type=1,this._$AH=M,this._$AN=void 0,this.element=e,this.name=t,this._$AM=n,this.options=r,s.length>2||""!==s[0]||""!==s[1]?(this._$AH=Array(s.length-1).fill(new String),this.strings=s):this._$AH=M}_$AI(e,t=this,s,n){const r=this.strings;let i=!1;if(void 0===r)e=L(this,e,t,0),i=!h(e)||e!==this._$AH&&e!==A,i&&(this._$AH=e);else{const n=e;let o,a;for(e=r[0],o=0;o<r.length-1;o++)a=L(this,n[s+o],t,o),a===A&&(a=this._$AH[o]),i||=!h(a)||a!==this._$AH[o],a===M?e=M:e!==M&&(e+=(a??"")+r[o+1]),this._$AH[o]=a}i&&!n&&this.j(e)}j(e){e===M?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,e??"")}}class B extends F{constructor(){super(...arguments),this.type=3}j(e){this.element[this.name]=e===M?void 0:e}}class I extends F{constructor(){super(...arguments),this.type=4}j(e){this.element.toggleAttribute(this.name,!!e&&e!==M)}}class z extends F{constructor(e,t,s,n,r){super(e,t,s,n,r),this.type=5}_$AI(e,t=this){if((e=L(this,e,t,0)??M)===A)return;const s=this._$AH,n=e===M&&s!==M||e.capture!==s.capture||e.once!==s.once||e.passive!==s.passive,r=e!==M&&(s===M||n);n&&this.element.removeEventListener(this.name,this,s),r&&this.element.addEventListener(this.name,this,e),this._$AH=e}handleEvent(e){"function"==typeof this._$AH?this._$AH.call(this.options?.host??this.element,e):this._$AH.handleEvent(e)}}class j{constructor(e,t,s){this.element=e,this.type=6,this._$AN=void 0,this._$AM=t,this.options=s}get _$AU(){return this._$AM._$AU}_$AI(e){L(this,e)}}const H={M:o,P:a,A:l,C:1,L:R,R:P,D:g,V:L,I:N,H:F,N:I,U:z,B,F:j},U=n.litHtmlPolyfillSupport;U?.(O,N),(n.litHtmlVersions??=[]).push("3.3.0");const G=(e,t,s)=>{const n=s?.renderBefore??t;let r=n._$litPart$;if(void 0===r){const e=s?.renderBefore??null;n._$litPart$=r=new N(t.insertBefore(u(),e),e,void 0,s??{})}return r._$AI(e),r}},534:(e,t,s)=>{"use strict";s.r(t),s.d(t,{UnsafeHTMLDirective:()=>i,unsafeHTML:()=>o});var n=s(752);class r{constructor(e){}get _$AU(){return this._$AM._$AU}_$AT(e,t,s){this._$Ct=e,this._$AM=t,this._$Ci=s}_$AS(e,t){return this.update(e,t)}update(e,t){return this.render(...t)}}class i extends r{constructor(e){if(super(e),this.it=n.s6,2!==e.type)throw Error(this.constructor.directiveName+"() can only be used in child bindings")}render(e){if(e===n.s6||null==e)return this._t=void 0,this.it=e;if(e===n.c0)return e;if("string"!=typeof e)throw Error(this.constructor.directiveName+"() called with a non-string value");if(e===this.it)return this._t;this.it=e;const t=[e];return t.raw=t,this._t={_$litType$:this.constructor.resultType,strings:t,values:[]}}}i.directiveName="unsafeHTML",i.resultType=1;const o=(a=i,(...e)=>({_$litDirective$:a,values:e}));var a},243:(e,t,s)=>{"use strict";s.r(t),s.d(t,{CSSResult:()=>a,LitElement:()=>D,ReactiveElement:()=>k,_$LE:()=>T,_$LH:()=>A.ge,adoptStyles:()=>d,css:()=>c,defaultConverter:()=>x,getCompatibleStyle:()=>u,html:()=>A.qy,isServer:()=>R,mathml:()=>A.ej,noChange:()=>A.c0,notEqual:()=>$,nothing:()=>A.s6,render:()=>A.XX,supportsAdoptingStyleSheets:()=>r,svg:()=>A.JW,unsafeCSS:()=>l});const n=globalThis,r=n.ShadowRoot&&(void 0===n.ShadyCSS||n.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,i=Symbol(),o=new WeakMap;class a{constructor(e,t,s){if(this._$cssResult$=!0,s!==i)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=e,this.t=t}get styleSheet(){let e=this.o;const t=this.t;if(r&&void 0===e){const s=void 0!==t&&1===t.length;s&&(e=o.get(t)),void 0===e&&((this.o=e=new CSSStyleSheet).replaceSync(this.cssText),s&&o.set(t,e))}return e}toString(){return this.cssText}}const l=e=>new a("string"==typeof e?e:e+"",void 0,i),c=(e,...t)=>{const s=1===e.length?e[0]:t.reduce(((t,s,n)=>t+(e=>{if(!0===e._$cssResult$)return e.cssText;if("number"==typeof e)return e;throw Error("Value passed to 'css' function must be a 'css' function result: "+e+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(s)+e[n+1]),e[0]);return new a(s,e,i)},d=(e,t)=>{if(r)e.adoptedStyleSheets=t.map((e=>e instanceof CSSStyleSheet?e:e.styleSheet));else for(const s of t){const t=document.createElement("style"),r=n.litNonce;void 0!==r&&t.setAttribute("nonce",r),t.textContent=s.cssText,e.appendChild(t)}},u=r?e=>e:e=>e instanceof CSSStyleSheet?(e=>{let t="";for(const s of e.cssRules)t+=s.cssText;return l(t)})(e):e,{is:h,defineProperty:p,getOwnPropertyDescriptor:g,getOwnPropertyNames:m,getOwnPropertySymbols:f,getPrototypeOf:y}=Object,b=globalThis,_=b.trustedTypes,v=_?_.emptyScript:"",w=b.reactiveElementPolyfillSupport,S=(e,t)=>e,x={toAttribute(e,t){switch(t){case Boolean:e=e?v:null;break;case Object:case Array:e=null==e?e:JSON.stringify(e)}return e},fromAttribute(e,t){let s=e;switch(t){case Boolean:s=null!==e;break;case Number:s=null===e?null:Number(e);break;case Object:case Array:try{s=JSON.parse(e)}catch(e){s=null}}return s}},$=(e,t)=>!h(e,t),C={attribute:!0,type:String,converter:x,reflect:!1,useDefault:!1,hasChanged:$};Symbol.metadata??=Symbol("metadata"),b.litPropertyMetadata??=new WeakMap;class k extends HTMLElement{static addInitializer(e){this._$Ei(),(this.l??=[]).push(e)}static get observedAttributes(){return this.finalize(),this._$Eh&&[...this._$Eh.keys()]}static createProperty(e,t=C){if(t.state&&(t.attribute=!1),this._$Ei(),this.prototype.hasOwnProperty(e)&&((t=Object.create(t)).wrapped=!0),this.elementProperties.set(e,t),!t.noAccessor){const s=Symbol(),n=this.getPropertyDescriptor(e,s,t);void 0!==n&&p(this.prototype,e,n)}}static getPropertyDescriptor(e,t,s){const{get:n,set:r}=g(this.prototype,e)??{get(){return this[t]},set(e){this[t]=e}};return{get:n,set(t){const i=n?.call(this);r?.call(this,t),this.requestUpdate(e,i,s)},configurable:!0,enumerable:!0}}static getPropertyOptions(e){return this.elementProperties.get(e)??C}static _$Ei(){if(this.hasOwnProperty(S("elementProperties")))return;const e=y(this);e.finalize(),void 0!==e.l&&(this.l=[...e.l]),this.elementProperties=new Map(e.elementProperties)}static finalize(){if(this.hasOwnProperty(S("finalized")))return;if(this.finalized=!0,this._$Ei(),this.hasOwnProperty(S("properties"))){const e=this.properties,t=[...m(e),...f(e)];for(const s of t)this.createProperty(s,e[s])}const e=this[Symbol.metadata];if(null!==e){const t=litPropertyMetadata.get(e);if(void 0!==t)for(const[e,s]of t)this.elementProperties.set(e,s)}this._$Eh=new Map;for(const[e,t]of this.elementProperties){const s=this._$Eu(e,t);void 0!==s&&this._$Eh.set(s,e)}this.elementStyles=this.finalizeStyles(this.styles)}static finalizeStyles(e){const t=[];if(Array.isArray(e)){const s=new Set(e.flat(1/0).reverse());for(const e of s)t.unshift(u(e))}else void 0!==e&&t.push(u(e));return t}static _$Eu(e,t){const s=t.attribute;return!1===s?void 0:"string"==typeof s?s:"string"==typeof e?e.toLowerCase():void 0}constructor(){super(),this._$Ep=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this._$Em=null,this._$Ev()}_$Ev(){this._$ES=new Promise((e=>this.enableUpdating=e)),this._$AL=new Map,this._$E_(),this.requestUpdate(),this.constructor.l?.forEach((e=>e(this)))}addController(e){(this._$EO??=new Set).add(e),void 0!==this.renderRoot&&this.isConnected&&e.hostConnected?.()}removeController(e){this._$EO?.delete(e)}_$E_(){const e=new Map,t=this.constructor.elementProperties;for(const s of t.keys())this.hasOwnProperty(s)&&(e.set(s,this[s]),delete this[s]);e.size>0&&(this._$Ep=e)}createRenderRoot(){const e=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return d(e,this.constructor.elementStyles),e}connectedCallback(){this.renderRoot??=this.createRenderRoot(),this.enableUpdating(!0),this._$EO?.forEach((e=>e.hostConnected?.()))}enableUpdating(e){}disconnectedCallback(){this._$EO?.forEach((e=>e.hostDisconnected?.()))}attributeChangedCallback(e,t,s){this._$AK(e,s)}_$ET(e,t){const s=this.constructor.elementProperties.get(e),n=this.constructor._$Eu(e,s);if(void 0!==n&&!0===s.reflect){const r=(void 0!==s.converter?.toAttribute?s.converter:x).toAttribute(t,s.type);this._$Em=e,null==r?this.removeAttribute(n):this.setAttribute(n,r),this._$Em=null}}_$AK(e,t){const s=this.constructor,n=s._$Eh.get(e);if(void 0!==n&&this._$Em!==n){const e=s.getPropertyOptions(n),r="function"==typeof e.converter?{fromAttribute:e.converter}:void 0!==e.converter?.fromAttribute?e.converter:x;this._$Em=n,this[n]=r.fromAttribute(t,e.type)??this._$Ej?.get(n)??null,this._$Em=null}}requestUpdate(e,t,s){if(void 0!==e){const n=this.constructor,r=this[e];if(s??=n.getPropertyOptions(e),!((s.hasChanged??$)(r,t)||s.useDefault&&s.reflect&&r===this._$Ej?.get(e)&&!this.hasAttribute(n._$Eu(e,s))))return;this.C(e,t,s)}!1===this.isUpdatePending&&(this._$ES=this._$EP())}C(e,t,{useDefault:s,reflect:n,wrapped:r},i){s&&!(this._$Ej??=new Map).has(e)&&(this._$Ej.set(e,i??t??this[e]),!0!==r||void 0!==i)||(this._$AL.has(e)||(this.hasUpdated||s||(t=void 0),this._$AL.set(e,t)),!0===n&&this._$Em!==e&&(this._$Eq??=new Set).add(e))}async _$EP(){this.isUpdatePending=!0;try{await this._$ES}catch(e){Promise.reject(e)}const e=this.scheduleUpdate();return null!=e&&await e,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??=this.createRenderRoot(),this._$Ep){for(const[e,t]of this._$Ep)this[e]=t;this._$Ep=void 0}const e=this.constructor.elementProperties;if(e.size>0)for(const[t,s]of e){const{wrapped:e}=s,n=this[t];!0!==e||this._$AL.has(t)||void 0===n||this.C(t,void 0,s,n)}}let e=!1;const t=this._$AL;try{e=this.shouldUpdate(t),e?(this.willUpdate(t),this._$EO?.forEach((e=>e.hostUpdate?.())),this.update(t)):this._$EM()}catch(t){throw e=!1,this._$EM(),t}e&&this._$AE(t)}willUpdate(e){}_$AE(e){this._$EO?.forEach((e=>e.hostUpdated?.())),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(e)),this.updated(e)}_$EM(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$ES}shouldUpdate(e){return!0}update(e){this._$Eq&&=this._$Eq.forEach((e=>this._$ET(e,this[e]))),this._$EM()}updated(e){}firstUpdated(e){}}k.elementStyles=[],k.shadowRootOptions={mode:"open"},k[S("elementProperties")]=new Map,k[S("finalized")]=new Map,w?.({ReactiveElement:k}),(b.reactiveElementVersions??=[]).push("2.1.0");var A=s(752);const M=globalThis;class D extends k{constructor(){super(...arguments),this.renderOptions={host:this},this._$Do=void 0}createRenderRoot(){const e=super.createRenderRoot();return this.renderOptions.renderBefore??=e.firstChild,e}update(e){const t=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(e),this._$Do=(0,A.XX)(t,this.renderRoot,this.renderOptions)}connectedCallback(){super.connectedCallback(),this._$Do?.setConnected(!0)}disconnectedCallback(){super.disconnectedCallback(),this._$Do?.setConnected(!1)}render(){return A.c0}}D._$litElement$=!0,D.finalized=!0,M.litElementHydrateSupport?.({LitElement:D});const E=M.litElementPolyfillSupport;E?.({LitElement:D});const T={_$AK:(e,t,s)=>{e._$AK(t,s)},_$AL:e=>e._$AL};(M.litElementVersions??=[]).push("4.2.0");const R=!1},330:e=>{"use strict";e.exports=JSON.parse('{"name":"cb-lcars","version":"2025.08.1-fuk.76-69","description":"Home Assistant LCARS libary built on custom-button-card","main":"index.js","author":"Jason Weyermars","license":"MIT","homepage":"https://cb-lcars.unimatrix01.ca","directories":{"doc":"doc"},"keywords":["HomeAssistant","Home Assistant","HASS","LCARS","Star Trek"],"scripts":{"clean":"rimraf dist","build":"webpack --mode production","generate-editor-json":"node src/editor/cb-lcars_generate_editor_forms.js","test:msd":"node scripts/msd/test-runner.js","test:msd:fast":"node scripts/msd/test-runner.js --fail-fast","test:msd:m1.1":"node scripts/msd/test-runner.js --milestone=1.1","test:msd:m1.2":"node scripts/msd/test-runner.js --milestone=1.2","test:msd:m1.3":"node scripts/msd/test-runner.js --milestone=1.3","test:msd:determinism":"node scripts/msd/test-determinism.js","test:msd:legacy":"node scripts/msd/test-legacy-removal.js","test:msd:validation":"node scripts/msd/test-validation-integration.js","test:msd:anchor":"node scripts/msd/test-anchor-validation.js","test:msd:performance":"node scripts/msd/test-performance.js","test:msd:export":"node scripts/msd/test-export-parity.js","test:msd:rules":"node scripts/msd/test-rules-engine.js","test:msd:palette":"node scripts/msd/test-palette-deep-merge.js","test:msd:anchor-prov":"node scripts/msd/test-anchor-provenance.js","test:msd:external":"node scripts/msd/test-external-packs.js","test:msd:rules-deps":"node scripts/msd/test-rule-dependencies.js","test:msd:rules-trace":"node scripts/msd/test-rule-tracing.js","test:msd:m2.1":"node scripts/msd/test-runner.js --milestone=2.1","test:msd:m2.2":"node scripts/msd/test-runner.js --milestone=2.2","test:msd:anim-registry":"node scripts/msd/test-animation-registry.js","test:msd:profile-system":"node scripts/msd/test-profile-system.js","test:msd:m3.1":"node scripts/msd/test-runner.js --milestone=3.1","test:msd:m3.2":"node scripts/msd/test-runner.js --milestone=3.2","test:msd:rendering":"node scripts/msd/test-advanced-rendering.js","test:msd:export-completion":"node scripts/msd/test-export-completion.js","test:msd:m4.1":"node scripts/msd/test-runner.js --milestone=4.1","test:msd:m4.2":"node scripts/msd/test-runner.js --milestone=4.2","test:msd:phase1":"node scripts/msd/test-phase1-data-layer.js","test:msd:phase2":"node scripts/msd/test-phase2-comprehensive.js","test:msd:phase3":"node scripts/msd/test-phase3-hud-system.js","test:msd:phase4":"node scripts/msd/test-phase4-controls-api.js","test:msd:real-data":"node scripts/msd/test-real-data-integration.js","test:msd:phase2-complete":"node scripts/msd/test-phase2-complete.js","test:msd:templates":"node scripts/msd/test-phase2-complete.js","test:msd:datasource":"node scripts/msd/test-datasource-integration.js","test:msd:sparkline-debug":"node scripts/msd/test-sparkline-debug.js","test:msd:debug-enhancements":"node scripts/msd/test-debug-enhancements.js","test:msd:export-panel":"node scripts/msd/test-export-panel.js","test:all":"npm run test:msd","audit:form-ids":"node scripts/audit-form-ids.js"},"devDependencies":{"clean-webpack-plugin":"^4.0.0","js-yaml":"^4.1.0","rimraf":"^6.0.1","webpack":"^5.94.0","webpack-bundle-analyzer":"^4.10.2","webpack-cli":"^5.1.4","webpack-dev-server":"^5.0.4"},"dependencies":{"ha-editor-formbuilder-yaml":"github:snootched/ha-card-formbuilder","animejs":"^4.0.0"}}')}},n={};function r(e){var t=n[e];if(void 0!==t)return t.exports;var i=n[e]={exports:{}};return s[e](i,i.exports,r),i.exports}r.m=s,r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,s)=>(r.f[s](e,t),t)),[])),r.u=e=>e+".cb-lcars.js",r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="cb-lcars:",r.l=(s,n,i,o)=>{if(e[s])e[s].push(n);else{var a,l;if(void 0!==i)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var u=c[d];if(u.getAttribute("src")==s||u.getAttribute("data-webpack")==t+i){a=u;break}}a||(l=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,r.nc&&a.setAttribute("nonce",r.nc),a.setAttribute("data-webpack",t+i),a.src=s),e[s]=[n];var h=(t,n)=>{a.onerror=a.onload=null,clearTimeout(p);var r=e[s];if(delete e[s],a.parentNode&&a.parentNode.removeChild(a),r&&r.forEach((e=>e(n))),t)return t(n)},p=setTimeout(h.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=h.bind(null,a.onerror),a.onload=h.bind(null,a.onload),l&&document.head.appendChild(a)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var s=t.getElementsByTagName("script");if(s.length)for(var n=s.length-1;n>-1&&(!e||!/^http(s?):/.test(e));)e=s[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{var e={792:0};r.f.j=(t,s)=>{var n=r.o(e,t)?e[t]:void 0;if(0!==n)if(n)s.push(n[2]);else{var i=new Promise(((s,r)=>n=e[t]=[s,r]));s.push(n[2]=i);var o=r.p+r.u(t),a=new Error;r.l(o,(s=>{if(r.o(e,t)&&(0!==(n=e[t])&&(e[t]=void 0),n)){var i=s&&("load"===s.type?"missing":s.type),o=s&&s.target&&s.target.src;a.message="Loading chunk "+t+" failed.\n("+i+": "+o+")",a.name="ChunkLoadError",a.type=i,a.request=o,n[1](a)}}),"chunk-"+t,t)}};var t=(t,s)=>{var n,i,[o,a,l]=s,c=0;if(o.some((t=>0!==e[t]))){for(n in a)r.o(a,n)&&(r.m[n]=a[n]);l&&l(r)}for(t&&t(s);c<o.length;c++)i=o[c],r.o(e,i)&&e[i]&&e[i][0](),e[i]=0},s=self.webpackChunkcb_lcars=self.webpackChunkcb_lcars||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})(),(()=>{"use strict";var e={};r.r(e),r.d(e,{Animatable:()=>gs,Draggable:()=>xs,JSAnimation:()=>Nt,Scope:()=>Cs,ScrollObserver:()=>Ps,Spring:()=>fs,Timeline:()=>hs,Timer:()=>rt,WAAPIAnimation:()=>Zt,animate:()=>Ft,createAnimatable:()=>ms,createDraggable:()=>$s,createScope:()=>ks,createSpring:()=>ys,createTimeline:()=>ps,createTimer:()=>it,eases:()=>bt,engine:()=>Me,onScroll:()=>Ns,scrollContainers:()=>Ms,stagger:()=>Fs,svg:()=>Be,utils:()=>cs,waapi:()=>Kt});var t={};r.r(t),r.d(t,{findSvgAnchors:()=>Sl,getSvgAspectRatio:()=>Cl,getSvgContent:()=>xl,getSvgViewBox:()=>$l});const s="undefined"!=typeof window,n=s?window:null,i=s?document:null,o={replace:0,none:1,blend:2},a=Symbol(),l=Symbol(),c=Symbol(),d=Symbol(),u=Symbol(),h=Symbol(),p=1e-11,g=1e12,m=1e3,f="",y=new Map;y.set("x","translateX"),y.set("y","translateY"),y.set("z","translateZ");const b=["translateX","translateY","translateZ","rotate","rotateX","rotateY","rotateZ","scale","scaleX","scaleY","scaleZ","skew","skewX","skewY","perspective","matrix","matrix3d"],_=b.reduce(((e,t)=>({...e,[t]:t+"("})),{}),v=()=>{},w=/(^#([\da-f]{3}){1,2}$)|(^#([\da-f]{4}){1,2}$)/i,S=/rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i,x=/rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(-?\d+|-?\d*.\d+)\s*\)/i,$=/hsl\(\s*(-?\d+|-?\d*.\d+)\s*,\s*(-?\d+|-?\d*.\d+)%\s*,\s*(-?\d+|-?\d*.\d+)%\s*\)/i,C=/hsla\(\s*(-?\d+|-?\d*.\d+)\s*,\s*(-?\d+|-?\d*.\d+)%\s*,\s*(-?\d+|-?\d*.\d+)%\s*,\s*(-?\d+|-?\d*.\d+)\s*\)/i,k=/[-+]?\d*\.?\d+(?:e[-+]?\d)?/gi,A=/^([-+]?\d*\.?\d+(?:e[-+]?\d+)?)([a-z]+|%)$/i,M=/([a-z])([A-Z])/g,D=/(\w+)(\([^)]+\)+)/g,E=/(\*=|\+=|-=)/,T={id:null,keyframes:null,playbackEase:null,playbackRate:1,frameRate:120,loop:0,reversed:!1,alternate:!1,autoplay:!0,duration:m,delay:0,loopDelay:0,ease:"out(2)",composition:o.replace,modifier:e=>e,onBegin:v,onBeforeUpdate:v,onUpdate:v,onLoop:v,onPause:v,onComplete:v,onRender:v},R={defaults:T,root:i,scope:null,precision:4,timeScale:1,tickThreshold:200},O={version:"4.0.2",engine:null};s&&(n.AnimeJS||(n.AnimeJS=[]),n.AnimeJS.push(O));const L=e=>e.replace(M,"$1-$2").toLowerCase(),P=(e,t)=>0===e.indexOf(t),N=Date.now,F=Array.isArray,B=e=>e&&e.constructor===Object,I=e=>"number"==typeof e&&!isNaN(e),z=e=>"string"==typeof e,j=e=>"function"==typeof e,H=e=>void 0===e,U=e=>H(e)||null===e,G=e=>s&&e instanceof SVGElement,V=e=>w.test(e),q=e=>P(e,"rgb"),W=e=>P(e,"hsl"),Y=e=>!R.defaults.hasOwnProperty(e),X=e=>z(e)?parseFloat(e):e,J=Math.pow,Z=Math.sqrt,K=Math.sin,Q=Math.cos,ee=Math.abs,te=Math.exp,se=Math.ceil,ne=Math.floor,re=Math.asin,ie=Math.max,oe=Math.atan2,ae=Math.PI,le=Math.round,ce=(e,t,s)=>e<t?t:e>s?s:e,de={},ue=(e,t)=>{if(t<0)return e;if(!t)return le(e);let s=de[t];return s||(s=de[t]=10**t),le(e*s)/s},he=(e,t)=>F(t)?t.reduce(((t,s)=>ee(s-e)<ee(t-e)?s:t)):t?le(e/t)*t:e,pe=(e,t,s)=>e+(t-e)*s,ge=e=>e===1/0?g:e===-1/0?-1e12:e,me=e=>e<=p?p:ge(ue(e,11)),fe=e=>F(e)?[...e]:e,ye=(e,t)=>{const s={...e};for(let n in t){const r=e[n];s[n]=H(r)?t[n]:r}return s},be=(e,t,s,n="_prev",r="_next")=>{let i=e._head,o=r;for(s&&(i=e._tail,o=n);i;){const e=i[o];t(i),i=e}},_e=(e,t,s="_prev",n="_next")=>{const r=t[s],i=t[n];r?r[n]=i:e._head=i,i?i[s]=r:e._tail=r,t[s]=null,t[n]=null},ve=(e,t,s,n="_prev",r="_next")=>{let i=e._tail;for(;i&&s&&s(i,t);)i=i[n];const o=i?i[r]:e._head;i?i[r]=t:e._head=t,o?o[n]=t:e._tail=t,t[n]=i,t[r]=o};class we{constructor(e=0){this.deltaTime=0,this._currentTime=e,this._elapsedTime=e,this._startTime=e,this._lastTime=e,this._scheduledTime=0,this._frameDuration=ue(m/120,0),this._fps=120,this._speed=1,this._hasChildren=!1,this._head=null,this._tail=null}get fps(){return this._fps}set fps(e){const t=this._frameDuration,s=+e,n=s<p?p:s,r=ue(m/n,0);this._fps=n,this._frameDuration=r,this._scheduledTime+=r-t}get speed(){return this._speed}set speed(e){const t=+e;this._speed=t<p?p:t}requestTick(e){const t=this._scheduledTime,s=this._elapsedTime;if(this._elapsedTime+=e-s,s<t)return 0;const n=this._frameDuration,r=s-t;return this._scheduledTime+=r<n?n:r,1}computeDeltaTime(e){const t=e-this._lastTime;return this.deltaTime=t,this._lastTime=e,t}}const Se=(e,t,s,n,r)=>{const i=e.parent,a=e.duration,l=e.completed,c=e.iterationDuration,u=e.iterationCount,h=e._currentIteration,g=e._loopDelay,m=e._reversed,y=e._alternate,b=e._hasChildren,v=e._delay,w=e._currentTime,S=v+c,x=t-v,$=ce(w,-v,a),C=ce(x,-v,a),k=x-w,A=C>0,M=C>=a,D=a<=p,E=2===r;let T=0,O=x,L=0;if(u>1){const t=~~(C/(c+(M?0:g)));e._currentIteration=ce(t,0,u),M&&e._currentIteration--,T=e._currentIteration%2,O=C%(c+g)||0}const P=m^(y&&T),N=e._ease;let F=M?P?0:a:P?c-O:O;N&&(F=c*N(F/c)||0);const B=(i?i.backwards:x<w)?!P:!!P;if(e._currentTime=x,e._iterationTime=F,e.backwards=B,A&&!e.began?(e.began=!0,s||i&&(B||!i.began)||e.onBegin(e)):x<=0&&(e.began=!1),s||b||!A||e._currentIteration===h||e.onLoop(e),E||1===r&&(t>=v&&t<=S||t<=v&&$>v||t>=S&&$!==a)||F>=S&&$!==a||F<=v&&$>0||t<=$&&$===a&&l||M&&!l&&D){if(A&&(e.computeDeltaTime($),s||e.onBeforeUpdate(e)),!b){const t=E||(B?-1*k:k)>=R.tickThreshold,r=e._offset+(i?i._offset:0)+v+F;let a,l,c,u,h=e._head,p=0;for(;h;){const e=h._composition,s=h._currentTime,i=h._changeDuration,g=h._absoluteStartTime+h._changeDuration,m=h._nextRep,y=h._prevRep,b=e!==o.none;if((t||(s!==i||r<=g+(m?m._delay:0))&&(0!==s||r>=h._absoluteStartTime))&&(!b||!h._isOverridden&&(!h._isOverlapped||r<=g)&&(!m||m._isOverridden||r<=m._absoluteStartTime)&&(!y||y._isOverridden||r>=y._absoluteStartTime+y._changeDuration+h._delay))){const t=h._currentTime=ce(F-h._startTime,0,i),s=h._ease(t/h._updateDuration),r=h._modifier,g=h._valueType,m=h._tweenType,f=0===m,y=0===g,_=y&&f||0===s||1===s?-1:R.precision;let v,w;if(y)v=w=r(ue(pe(h._fromNumber,h._toNumber,s),_));else if(1===g)w=r(ue(pe(h._fromNumber,h._toNumber,s),_)),v=`${w}${h._unit}`;else if(2===g){const e=h._fromNumbers,t=h._toNumbers,n=ue(ce(r(pe(e[0],t[0],s)),0,255),0),i=ue(ce(r(pe(e[1],t[1],s)),0,255),0),o=ue(ce(r(pe(e[2],t[2],s)),0,255),0),a=ce(r(ue(pe(e[3],t[3],s),_)),0,1);if(v=`rgba(${n},${i},${o},${a})`,b){const e=h._numbers;e[0]=n,e[1]=i,e[2]=o,e[3]=a}}else if(3===g){v=h._strings[0];for(let e=0,t=h._toNumbers.length;e<t;e++){const t=r(ue(pe(h._fromNumbers[e],h._toNumbers[e],s),_)),n=h._strings[e+1];v+=`${n?t+n:t}`,b&&(h._numbers[e]=t)}}if(b&&(h._number=w),n||e===o.blend)h._value=v;else{const e=h.property;a=h.target,f?a[e]=v:1===m?a.setAttribute(e,v):(l=a.style,3===m?(a!==c&&(c=a,u=a[d]),u[e]=v,p=1):2===m?l[e]=v:4===m&&l.setProperty(e,v)),A&&(L=1)}}if(p&&h._renderTransforms){let e=f;for(let t in u)e+=`${_[t]}${u[t]}) `;l.transform=e,p=0}h=h._next}!s&&L&&e.onRender(e)}!s&&A&&e.onUpdate(e)}return i&&D?!s&&(i.began&&!B&&x>=a&&!l||B&&x<=p&&l)&&(e.onComplete(e),e.completed=!B):A&&M?u===1/0?e._startTime+=e.duration:e._currentIteration>=u-1&&(e.paused=!0,l||b||(e.completed=!0,s||i&&(B||!i.began)||(e.onComplete(e),e._resolve(e)))):e.completed=!1,L},xe=(e,t,s,n,r)=>{const i=e._currentIteration;if(Se(e,t,s,n,r),e._hasChildren){const o=e,a=o.backwards,l=n?t:o._iterationTime,c=N();let d=0,u=!0;if(!n&&o._currentIteration!==i){const e=o.iterationDuration;be(o,(t=>{if(a){const n=t.duration,r=t._offset+t._delay;s||!(n<=p)||r&&r+n!==e||t.onComplete(t)}else!t.completed&&!t.backwards&&t._currentTime<t.iterationDuration&&Se(t,e,s,1,2),t.began=!1,t.completed=!1})),s||o.onLoop(o)}be(o,(e=>{const t=ue((l-e._offset)*e._speed,12),i=e._fps<o._fps?e.requestTick(c):r;d+=Se(e,t,s,n,i),!e.completed&&u&&(u=!1)}),a),!s&&d&&o.onRender(o),u&&o._currentTime>=o.duration&&(o.paused=!0,o.completed||(o.completed=!0,s||(o.onComplete(o),o._resolve(o))))}},$e={animation:null,update:v},Ce=s?requestAnimationFrame:setImmediate,ke=s?cancelAnimationFrame:clearImmediate;class Ae extends we{constructor(e){super(e),this.useDefaultMainLoop=!0,this.pauseOnDocumentHidden=!0,this.defaults=T,this.paused=!(!s||!i.hidden),this.reqId=null}update(){const e=this._currentTime=N();if(this.requestTick(e)){this.computeDeltaTime(e);const t=this._speed,s=this._fps;let n=this._head;for(;n;){const r=n._next;n.paused?(_e(this,n),this._hasChildren=!!this._tail,n._running=!1,n.completed&&!n._cancelled&&n.cancel()):xe(n,(e-n._startTime)*n._speed*t,0,0,n._fps<s?n.requestTick(e):1),n=r}$e.update()}}wake(){return!this.useDefaultMainLoop||this.reqId||this.paused||(this.reqId=Ce(De)),this}pause(){return this.paused=!0,Ee()}resume(){if(this.paused)return this.paused=!1,be(this,(e=>e.resetTime())),this.wake()}get speed(){return this._speed*(1===R.timeScale?1:m)}set speed(e){this._speed=e*R.timeScale,be(this,(e=>e.speed=e._speed))}get timeUnit(){return 1===R.timeScale?"ms":"s"}set timeUnit(e){const t="s"===e,s=t?.001:1;if(R.timeScale!==s){R.timeScale=s,R.tickThreshold=200*s;const e=t?.001:m;this.defaults.duration*=e,this._speed*=e}}get precision(){return R.precision}set precision(e){R.precision=e}}const Me=(()=>{const e=new Ae(N());return s&&(O.engine=e,i.addEventListener("visibilitychange",(()=>{e.pauseOnDocumentHidden&&(i.hidden?e.pause():e.resume())}))),e})(),De=()=>{Me._head?(Me.reqId=Ce(De),Me.update()):Me.reqId=0},Ee=()=>(ke(Me.reqId),Me.reqId=0,Me);function Te(e){const t=z(e)?R.root.querySelectorAll(e):e;if(t instanceof NodeList||t instanceof HTMLCollection)return t}function Re(e){if(U(e))return[];if(F(e)){const t=e.flat(1/0),s=[];for(let e=0,n=t.length;e<n;e++){const n=t[e];if(!U(n)){const e=Te(n);if(e)for(let t=0,n=e.length;t<n;t++){const n=e[t];if(!U(n)){let e=!1;for(let t=0,r=s.length;t<r;t++)if(s[t]===n){e=!0;break}e||s.push(n)}}else{let e=!1;for(let t=0,r=s.length;t<r;t++)if(s[t]===n){e=!0;break}e||s.push(n)}}}return s}if(!s)return[e];const t=Te(e);return t?Array.from(t):[e]}function Oe(e){const t=Re(e),s=t.length;if(s)for(let e=0;e<s;e++){const s=t[e];if(!s[a]){s[a]=!0;const e=G(s);(s.nodeType||e)&&(s[l]=!0,s[c]=e,s[d]={})}}return t}const Le=e=>{const t=Re(e)[0];if(t&&G(t))return t},Pe=(e,t,s=0)=>e.getPointAtLength(t+s>=1?t+s:0),Ne=(e,t)=>s=>{const n=+e.getTotalLength(),r=s[c],i=e.getCTM();return{from:0,to:n,modifier:s=>{if("a"===t){const t=Pe(e,s,-1),n=Pe(e,s,1);return 180*oe(n.y-t.y,n.x-t.x)/ae}{const n=Pe(e,s,0);return"x"===t?r||!i?n.x:n.x*i.a+n.y*i.c+i.e:r||!i?n.y:n.x*i.b+n.y*i.d+i.f}}}},Fe=["opacity","rotate","overflow","color"],Be={morphTo:(e,t=.33)=>s=>{const n=Le(e);if(!n)return;const r="path"===s.tagName,i=r?" ":",",o=s[u];o&&s.setAttribute(r?"d":"points",o);let a="",l="";if(t){const e=s.getTotalLength(),o=n.getTotalLength(),c=Math.max(Math.ceil(e*t),Math.ceil(o*t));for(let t=0;t<c;t++){const d=t/(c-1),u=s.getPointAtLength(e*d),h=n.getPointAtLength(o*d),p=r?0===t?"M":"L":"";a+=p+ue(u.x,3)+i+u.y+" ",l+=p+ue(h.x,3)+i+h.y+" "}}else a=s.getAttribute(r?"d":"points"),l=n.getAttribute(r?"d":"points");return s[u]=l,[a,l]},createMotionPath:e=>{const t=Le(e);if(t)return{translateX:Ne(t,"x"),translateY:Ne(t,"y"),rotate:Ne(t,"a")}},createDrawable:(e,t=0,s=0)=>Re(e).map((e=>((e,t,s)=>{const n=m,r=getComputedStyle(e),i=r.strokeLinecap,o="non-scaling-stroke"===r.vectorEffect?e:null;let a=i;const l=new Proxy(e,{get(e,t){const s=e[t];return t===h?e:"setAttribute"===t?(...t)=>{if("draw"===t[0]){const s=t[1].split(" "),r=+s[0],l=+s[1],c=(e=>{let t=1;if(e&&e.getCTM){const s=e.getCTM();s&&(t=(Z(s.a*s.a+s.b*s.b)+Z(s.c*s.c+s.d*s.d))/2)}return t})(o),d=-1e3*r*c,u=l*n*c+d,h=n*c+(0===r&&1===l||1===r&&0===l?0:10*c)-u;if("butt"!==i){const t=r===l?"butt":i;a!==t&&(e.style.strokeLinecap=`${t}`,a=t)}e.setAttribute("stroke-dashoffset",`${d}`),e.setAttribute("stroke-dasharray",`${u} ${h}`)}return Reflect.apply(s,e,t)}:j(s)?(...t)=>Reflect.apply(s,e,t):s}});return"1000"!==e.getAttribute("pathLength")&&(e.setAttribute("pathLength","1000"),l.setAttribute("draw",`${t} ${s}`)),l})(e,t,s)))},Ie=(e,t,s)=>(s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e),ze=(e,t)=>H(e)?t:e,je=(e,t,s,n,r)=>{if(j(e)){const i=()=>{const r=e(t,s,n);return isNaN(+r)?r||0:+r};return r&&(r.func=i),i()}return e},He=(e,t)=>e[l]?e[c]&&((e,t)=>{if(Fe.includes(t))return!1;if(e.getAttribute(t)||t in e){if("scale"===t){const t=e.parentNode;return t&&"filter"===t.tagName}return!0}})(e,t)?1:b.includes(t)||y.get(t)?3:P(t,"--")?4:t in e.style?2:t in e?0:1:0,Ue=(e,t,s)=>{const n=e.style[t];n&&s&&(s[t]=n);const r=n||getComputedStyle(e[h]||e).getPropertyValue(t);return"auto"===r?"0":r},Ge=(e,t,s,n)=>{const r=H(s)?He(e,t):s;return 0===r?e[t]||0:1===r?e.getAttribute(t):3===r?((e,t,s)=>{const n=e.style.transform;let r;if(n){const i=e[d];let o;for(;o=D.exec(n);){const e=o[1],n=o[2].slice(1,-1);i[e]=n,e===t&&(r=n,s&&(s[t]=n))}}return n&&!H(r)?r:P(t,"scale")?"1":P(t,"rotate")||P(t,"skew")?"0deg":"0px"})(e,t,n):4===r?Ue(e,t,n).trimStart():Ue(e,t,n)},Ve=(e,t,s)=>"-"===s?e-t:"+"===s?e+t:e*t,qe=(e,t)=>{if(t.t=0,t.n=0,t.u=null,t.o=null,t.d=null,t.s=null,!e)return t;const s=+e;if(isNaN(s)){let s=e;"="===s[1]&&(t.o=s[0],s=s.slice(2));const r=!s.includes(" ")&&A.exec(s);if(r)return t.t=1,t.n=+r[1],t.u=r[2],t;if(t.o)return t.n=+s,t;if((e=>V(e)||q(e)||W(e))(s))return t.t=2,t.d=q(n=s)?(e=>{const t=S.exec(e)||x.exec(e),s=H(t[4])?1:+t[4];return[+t[1],+t[2],+t[3],s]})(n):V(n)?(e=>{const t=e.length,s=4===t||5===t;return[+("0x"+e[1]+e[s?1:2]),+("0x"+e[s?2:3]+e[s?2:4]),+("0x"+e[s?3:5]+e[s?3:6]),5===t||9===t?+(+("0x"+e[s?4:7]+e[s?4:8])/255).toFixed(3):1]})(n):W(n)?(e=>{const t=$.exec(e)||C.exec(e),s=+t[1]/360,n=+t[2]/100,r=+t[3]/100,i=H(t[4])?1:+t[4];let o,a,l;if(0===n)o=a=l=r;else{const e=r<.5?r*(1+n):r+n-r*n,t=2*r-e;o=ue(255*Ie(t,e,s+1/3),0),a=ue(255*Ie(t,e,s),0),l=ue(255*Ie(t,e,s-1/3),0)}return[o,a,l,i]})(n):[0,0,0,1],t;{const e=s.match(k);return t.t=3,t.d=e?e.map(Number):[],t.s=s.split(k)||[],t}}var n;return t.n=s,t},We=(e,t)=>(t.t=e._valueType,t.n=e._toNumber,t.u=e._unit,t.o=null,t.d=fe(e._toNumbers),t.s=fe(e._strings),t),Ye={t:0,n:0,u:null,o:null,d:null,s:null},Xe={_rep:new WeakMap,_add:new Map},Je=(e,t,s="_rep")=>{const n=Xe[s];let r=n.get(e);return r||(r={},n.set(e,r)),r[t]?r[t]:r[t]={_head:null,_tail:null}},Ze=(e,t)=>e._isOverridden||e._absoluteStartTime>t._absoluteStartTime,Ke=e=>{e._isOverlapped=1,e._isOverridden=1,e._changeDuration=p,e._currentTime=p},Qe=(e,t)=>{const s=e._composition;if(s===o.replace){const s=e._absoluteStartTime;ve(t,e,Ze,"_prevRep","_nextRep");const n=e._prevRep;if(n){const t=n.parent,r=n._absoluteStartTime+n._changeDuration;if(e.parent.id!==t.id&&t.iterationCount>1&&r+(t.duration-t.iterationDuration)>s){Ke(n);let e=n._prevRep;for(;e&&e.parent.id===t.id;)Ke(e),e=e._prevRep}const i=s-e._delay;if(r>i){const e=n._startTime,t=r-(e+n._updateDuration);n._changeDuration=i-t-e,n._currentTime=n._changeDuration,n._isOverlapped=1,n._changeDuration<p&&Ke(n)}let o=!0;if(be(t,(e=>{e._isOverlapped||(o=!1)})),o){const e=t.parent;if(e){let s=!0;be(e,(e=>{e!==t&&be(e,(e=>{e._isOverlapped||(s=!1)}))})),s&&e.cancel()}else t.cancel()}}}else if(s===o.blend){const t=Je(e.target,e.property,"_add"),s=(e=>{let t=$e.animation;return t||(t={duration:p,computeDeltaTime:v,_offset:0,_delay:0,_head:null,_tail:null},$e.animation=t,$e.update=()=>{e.forEach((e=>{for(let t in e){const s=e[t],n=s._head;if(n){const e=n._valueType,t=3===e||2===e?fe(n._fromNumbers):null;let r=n._fromNumber,i=s._tail;for(;i&&i!==n;){if(t)for(let e=0,s=i._numbers.length;e<s;e++)t[e]+=i._numbers[e];else r+=i._number;i=i._prevAdd}n._toNumber=r,n._toNumbers=t}}})),Se(t,1,1,0,2)}),t})(Xe._add);let n=t._head;n||(n={...e},n._composition=o.replace,n._updateDuration=p,n._startTime=0,n._numbers=fe(e._fromNumbers),n._number=0,n._next=null,n._prev=null,ve(t,n),ve(s,n));const r=e._toNumber;if(e._fromNumber=n._fromNumber-r,e._toNumber=0,e._numbers=fe(e._fromNumbers),e._number=0,n._fromNumber=r,e._toNumbers){const t=fe(e._toNumbers);t&&t.forEach(((t,s)=>{e._fromNumbers[s]=n._fromNumbers[s]-t,e._toNumbers[s]=0})),n._fromNumbers=t}ve(t,e,null,"_prevAdd","_nextAdd")}return e},et=e=>{const t=e._composition;if(t!==o.none){const s=e.target,n=e.property,r=Xe._rep.get(s)[n];if(_e(r,e,"_prevRep","_nextRep"),t===o.blend){const t=Xe._add,r=t.get(s);if(!r)return;const i=r[n],o=$e.animation;_e(i,e,"_prevAdd","_nextAdd");const a=i._head;if(a&&a===i._tail){_e(i,a,"_prevAdd","_nextAdd"),_e(o,a);let e=!0;for(let t in r)if(r[t]._head){e=!1;break}e&&t.delete(s)}}}return e},tt=e=>(e.paused=!0,e.began=!1,e.completed=!1,e),st=e=>e._cancelled?(e._hasChildren?be(e,st):be(e,(e=>{e._composition!==o.none&&Qe(e,Je(e.target,e.property))})),e._cancelled=0,e):e;let nt=0;class rt extends we{constructor(e={},t=null,s=0){super(0);const{id:n,delay:r,duration:i,reversed:o,alternate:a,loop:l,loopDelay:c,autoplay:d,frameRate:u,playbackRate:h,onComplete:g,onLoop:m,onPause:f,onBegin:y,onBeforeUpdate:b,onUpdate:_}=e;R.scope&&R.scope.revertibles.push(this);const w=t?0:Me._elapsedTime,S=t?t.defaults:R.defaults,x=j(r)||H(r)?S.delay:+r,$=j(i)||H(i)?1/0:+i,C=ze(l,S.loop),k=ze(c,S.loopDelay),A=!0===C||C===1/0||C<0?1/0:C+1;let M=0;if(t)M=s;else{let e=N();Me.paused&&(Me.requestTick(e),e=Me._elapsedTime),M=e-Me._startTime}this.id=H(n)?++nt:n,this.parent=t,this.duration=ge(($+k)*A-k)||p,this.backwards=!1,this.paused=!0,this.began=!1,this.completed=!1,this.onBegin=y||S.onBegin,this.onBeforeUpdate=b||S.onBeforeUpdate,this.onUpdate=_||S.onUpdate,this.onLoop=m||S.onLoop,this.onPause=f||S.onPause,this.onComplete=g||S.onComplete,this.iterationDuration=$,this.iterationCount=A,this._autoplay=!t&&ze(d,S.autoplay),this._offset=M,this._delay=x,this._loopDelay=k,this._iterationTime=0,this._currentIteration=0,this._resolve=v,this._running=!1,this._reversed=+ze(o,S.reversed),this._reverse=this._reversed,this._cancelled=0,this._alternate=ze(a,S.alternate),this._prev=null,this._next=null,this._elapsedTime=w,this._startTime=w,this._lastTime=w,this._fps=ze(u,S.frameRate),this._speed=ze(h,S.playbackRate)}get cancelled(){return!!this._cancelled}set cancelled(e){e?this.cancel():this.reset(1).play()}get currentTime(){return ce(ue(this._currentTime,R.precision),-this._delay,this.duration)}set currentTime(e){const t=this.paused;this.pause().seek(+e),t||this.resume()}get iterationCurrentTime(){return ue(this._iterationTime,R.precision)}set iterationCurrentTime(e){this.currentTime=this.iterationDuration*this._currentIteration+e}get progress(){return ce(ue(this._currentTime/this.duration,5),0,1)}set progress(e){this.currentTime=this.duration*e}get iterationProgress(){return ce(ue(this._iterationTime/this.iterationDuration,5),0,1)}set iterationProgress(e){const t=this.iterationDuration;this.currentTime=t*this._currentIteration+t*e}get currentIteration(){return this._currentIteration}set currentIteration(e){this.currentTime=this.iterationDuration*ce(+e,0,this.iterationCount-1)}get reversed(){return!!this._reversed}set reversed(e){e?this.reverse():this.play()}get speed(){return super.speed}set speed(e){super.speed=e,this.resetTime()}reset(e=0){return st(this),this._reversed&&!this._reverse&&(this.reversed=!1),this._iterationTime=this.iterationDuration,xe(this,0,1,e,2),tt(this),this._hasChildren&&be(this,tt),this}init(e=0){this.fps=this._fps,this.speed=this._speed,!e&&this._hasChildren&&xe(this,this.duration,1,e,2),this.reset(e);const t=this._autoplay;return!0===t?this.resume():t&&!H(t.linked)&&t.link(this),this}resetTime(){const e=1/(this._speed*Me._speed);return this._startTime=N()-(this._currentTime+this._delay)*e,this}pause(){return this.paused||(this.paused=!0,this.onPause(this)),this}resume(){return this.paused?(this.paused=!1,this.duration<=p&&!this._hasChildren?xe(this,p,0,0,2):(this._running||(ve(Me,this),Me._hasChildren=!0,this._running=!0),this.resetTime(),this._startTime-=12,Me.wake()),this):this}restart(){return this.reset(0).resume()}seek(e,t=0,s=0){st(this),this.completed=!1;const n=this.paused;return this.paused=!0,xe(this,e+this._delay,~~t,~~s,1),n?this:this.resume()}alternate(){const e=this._reversed,t=this.iterationCount,s=this.iterationDuration,n=t===1/0?ne(g/s):t;return this._reversed=+(!this._alternate||n%2?!e:e),t===1/0?this.iterationProgress=this._reversed?1-this.iterationProgress:this.iterationProgress:this.seek(s*n-this._currentTime),this.resetTime(),this}play(){return this._reversed&&this.alternate(),this.resume()}reverse(){return this._reversed||this.alternate(),this.resume()}cancel(){return this._hasChildren?be(this,(e=>e.cancel()),!0):be(this,et),this._cancelled=1,this.pause()}stretch(e){const t=this.duration,s=me(e);if(t===s)return this;const n=e/t,r=e<=p;return this.duration=r?p:s,this.iterationDuration=r?p:me(this.iterationDuration*n),this._offset*=n,this._delay*=n,this._loopDelay*=n,this}revert(){xe(this,0,1,0,1);const e=this._autoplay;return e&&e.linked&&e.linked===this&&e.revert(),this.cancel()}complete(){return this.seek(this.duration).cancel()}then(e=v){const t=this.then,s=()=>{this.then=null,e(this),this.then=t,this._resolve=v};return new Promise((e=>(this._resolve=()=>e(s()),this.completed&&this._resolve(),this)))}}const it=e=>new rt(e,null,0).init(),ot=e=>e,at=(e,t,s)=>(((1-3*s+3*t)*e+(3*s-6*t))*e+3*t)*e,lt=(e=.5,t=0,s=.5,n=1)=>e===t&&s===n?ot:r=>0===r||1===r?r:at(((e,t,s)=>{let n,r,i=0,o=1,a=0;do{r=i+(o-i)/2,n=at(r,t,s)-e,n>0?o=r:i=r}while(ee(n)>1e-7&&++a<100);return r})(r,e,s),t,n),ct=(e=10,t)=>{const s=t?se:ne;return t=>s(ce(t,0,1)*e)*(1/e)},dt=(...e)=>{const t=e.length;if(!t)return ot;const s=t-1,n=e[0],r=e[s],i=[0],o=[X(n)];for(let t=1;t<s;t++){const n=e[t],r=z(n)?n.trim().split(" "):[n],a=r[0],l=r[1];i.push(H(l)?t/s:X(l)/100),o.push(X(a))}return o.push(X(r)),i.push(1),function(e){for(let t=1,s=i.length;t<s;t++){const s=i[t];if(e<=s){const n=i[t-1],r=o[t-1];return r+(o[t]-r)*(e-n)/(s-n)}}return o[o.length-1]}},ut=(e=10,t=1)=>{const s=[0],n=e-1;for(let e=1;e<n;e++){const r=s[e-1],i=e/n,o=i*(1-t)+(i+((e+1)/n-i)*Math.random())*t;s.push(ce(o,r,1))}return s.push(1),dt(...s)},ht=ae/2,pt=2*ae,gt=(e=1.68)=>t=>J(t,+e),mt={[f]:gt,Quad:gt(2),Cubic:gt(3),Quart:gt(4),Quint:gt(5),Sine:e=>1-Q(e*ht),Circ:e=>1-Z(1-e*e),Expo:e=>e?J(2,10*e-10):0,Bounce:e=>{let t,s=4;for(;e<((t=J(2,--s))-1)/11;);return 1/J(4,3-s)-7.5625*J((3*t-2)/22-e,2)},Back:(e=1.70158)=>t=>(+e+1)*t*t*t-+e*t*t,Elastic:(e=1,t=.3)=>{const s=ce(+e,1,10),n=ce(+t,p,2),r=n/pt*re(1/s),i=pt/n;return e=>0===e||1===e?e:-s*J(2,-10*(1-e))*K((1-e-r)*i)}},ft={in:e=>t=>e(t),out:e=>t=>1-e(1-t),inOut:e=>t=>t<.5?e(2*t)/2:1-e(-2*t+2)/2,outIn:e=>t=>t<.5?(1-e(1-2*t))/2:(e(2*t-1)+1)/2},yt=(e,t,s)=>{if(s[e])return s[e];if(e.indexOf("(")<=-1){const n=ft[e]||e.includes("Back")||e.includes("Elastic")?t[e]():t[e];return n?s[e]=n:ot}{const n=e.slice(0,-1).split("("),r=t[n[0]];return r?s[e]=r(...n[1].split(",")):ot}},bt=(()=>{const e={linear:dt,irregular:ut,steps:ct,cubicBezier:lt};for(let t in ft)for(let s in mt){const n=mt[s],r=ft[t];e[t+s]=s===f||"Back"===s||"Elastic"===s?(e,t)=>r(n(e,t)):r(n)}return e})(),_t={linear:ot},vt=e=>j(e)?e:z(e)?yt(e,bt,_t):ot,wt={},St=(e,t,s)=>{if(3===s){return y.get(e)||e}if(2===s||1===s&&G(t)&&e in t.style){const t=wt[e];if(t)return t;{const t=e?L(e):e;return wt[e]=t,t}}return e},xt={deg:1,rad:180/ae,turn:360},$t={},Ct=(e,t,s,n=!1)=>{const r=t.u,o=t.n;if(1===t.t&&r===s)return t;const a=o+r+s,l=$t[a];if(H(l)||n){let n;if(r in xt)n=o*xt[r]/xt[s];else{const t=100,a=e.cloneNode(),l=e.parentNode,c=l&&l!==i?l:i.body;c.appendChild(a);const d=a.style;d.width=t+r;const u=a.offsetWidth||t;d.width=t+s;const h=u/(a.offsetWidth||t);c.removeChild(a),n=h*o}t.n=n,$t[a]=n}else t.n=l;return t.t,t.u=s,t},kt=e=>{if(e._hasChildren)be(e,kt,!0);else{const t=e;t.pause(),be(t,(e=>{const s=e.property,n=e.target;if(n[l]){const r=n.style,i=t._inlineStyles[s];if(3===e._tweenType){const t=n[d];if(H(i)||i===f?delete t[s]:t[s]=i,e._renderTransforms)if(Object.keys(t).length){let e=f;for(let s in t)e+=_[s]+t[s]+") ";r.transform=e}else r.removeProperty("transform")}else H(i)||i===f?r.removeProperty(s):r[s]=i;t._tail===e&&t.targets.forEach((e=>{e.getAttribute&&e.getAttribute("style")===f&&e.removeAttribute("style")}))}}))}return e},At={t:0,n:0,u:null,o:null,d:null,s:null},Mt={t:0,n:0,u:null,o:null,d:null,s:null},Dt={func:null},Et=[null],Tt=[null,null],Rt={to:null};let Ot,Lt,Pt=0;class Nt extends rt{constructor(e,t,s,n,r=!1,i=0,a=0){super(t,s,n);const l=Oe(e),c=l.length,d=t.keyframes,u=d?ye(((e,t)=>{const s={};if(F(e)){const t=[].concat(...e.map((e=>Object.keys(e)))).filter(Y);for(let n=0,r=t.length;n<r;n++){const r=t[n],i=e.map((e=>{const t={};for(let s in e){const n=e[s];Y(s)?s===r&&(t.to=n):t[s]=n}return t}));s[r]=i}}else{const n=ze(t.duration,R.defaults.duration),r=Object.keys(e).map((t=>({o:parseFloat(t)/100,p:e[t]}))).sort(((e,t)=>e.o-t.o));r.forEach((e=>{const t=e.o,r=e.p;for(let e in r)if(Y(e)){let i=s[e];i||(i=s[e]=[]);const o=t*n;let a=i.length,l=i[a-1];const c={to:r[e]};let d=0;for(let e=0;e<a;e++)d+=i[e].duration;1===a&&(c.from=l.to),r.ease&&(c.ease=r.ease),c.duration=o-(a?d:0),i.push(c)}return e}));for(let e in s){const t=s[e];let n;for(let e=0,s=t.length;e<s;e++){const s=t[e],r=s.ease;s.ease=n||void 0,n=r}t[0].duration||t.shift()}}return s})(d,t),t):t,{delay:h,duration:g,ease:f,playbackEase:y,modifier:b,composition:_,onRender:v}=u,w=s?s.defaults:R.defaults,S=ze(y,w.playbackEase),x=S?vt(S):null,$=!H(f)&&!H(f.ease),C=$?f.ease:ze(f,x?"linear":w.ease),k=$?f.duration:ze(g,w.duration),A=ze(h,w.delay),M=b||w.modifier,D=H(_)&&c>=m?o.none:H(_)?w.composition:_,E={},T=this._offset+(s?s._offset:0);let O=NaN,L=NaN,P=0,N=0;for(let e=0;e<c;e++){const t=l[e],n=i||e,d=a||c;let h=NaN,g=NaN;for(let e in u)if(Y(e)){const i=He(t,e),a=St(e,t,i);let l=u[e];const c=F(l);if(r&&!c&&(Tt[0]=l,Tt[1]=l,l=Tt),c){const e=l.length,t=!B(l[0]);2===e&&t?(Rt.to=l,Et[0]=Rt,Ot=Et):e>2&&t?(Ot=[],l.forEach(((e,t)=>{t?1===t?(Tt[1]=e,Ot.push(Tt)):Ot.push(e):Tt[0]=e}))):Ot=l}else Et[0]=l,Ot=Et;let m=null,f=null,y=NaN,b=0,_=0;for(let e=Ot.length;_<e;_++){const r=Ot[_];B(r)?Lt=r:(Rt.to=r,Lt=Rt),Dt.func=null;const l=je(Lt.to,t,n,d,Dt);let c;B(l)&&!H(l.to)?(Lt=l,c=l.to):c=l;const u=je(Lt.from,t,n,d),h=Lt.ease,g=!H(h)&&!H(h.ease),v=g?h.ease:h||C,w=g?h.duration:je(ze(Lt.duration,e>1?je(k,t,n,d)/e:k),t,n,d),S=je(ze(Lt.delay,_?0:A),t,n,d),x=je(ze(Lt.composition,D),t,n,d),$=I(x)?x:o[x],R=Lt.modifier||M,O=!H(u),L=!H(c),z=F(c),j=z||O&&L,U=f?b+S:S,G=T+U;N||!O&&!z||(N=1);let V=f;if($!==o.none){m||(m=Je(t,a));let e=m._head;for(;e&&!e._isOverridden&&e._absoluteStartTime<=G;)if(V=e,e=e._nextRep,e&&e._absoluteStartTime>=G)for(;e;)Ke(e),e=e._nextRep}if(j?(qe(z?je(c[0],t,n,d):u,At),qe(z?je(c[1],t,n,d,Dt):c,Mt),0===At.t&&(V?1===V._valueType&&(At.t=1,At.u=V._unit):(qe(Ge(t,a,i,E),Ye),1===Ye.t&&(At.t=1,At.u=Ye.u)))):(L?qe(c,Mt):f?We(f,Mt):qe(s&&V&&V.parent.parent===s?V._value:Ge(t,a,i,E),Mt),O?qe(u,At):f?We(f,At):qe(s&&V&&V.parent.parent===s?V._value:Ge(t,a,i,E),At)),At.o&&(At.n=Ve(V?V._toNumber:qe(Ge(t,a,i,E),Ye).n,At.n,At.o)),Mt.o&&(Mt.n=Ve(At.n,Mt.n,Mt.o)),At.t!==Mt.t)if(3===At.t||3===Mt.t){const e=3===At.t?At:Mt,t=3===At.t?Mt:At;t.t=3,t.s=fe(e.s),t.d=e.d.map((()=>t.n))}else if(1===At.t||1===Mt.t){const e=1===At.t?At:Mt,t=1===At.t?Mt:At;t.t=1,t.u=e.u}else if(2===At.t||2===Mt.t){const e=2===At.t?At:Mt,t=2===At.t?Mt:At;t.t=2,t.s=e.s,t.d=[0,0,0,1]}if(At.u!==Mt.u){let e=Mt.u?At:Mt;e=Ct(t,e,Mt.u?Mt.u:At.u,!1)}if(Mt.d&&At.d&&Mt.d.length!==At.d.length){const e=At.d.length>Mt.d.length?At:Mt,t=e===At?Mt:At;t.d=e.d.map(((e,s)=>H(t.d[s])?0:t.d[s])),t.s=fe(e.s)}const q=ue(+w||p,12),W={parent:this,id:Pt++,property:a,target:t,_value:null,_func:Dt.func,_ease:vt(v),_fromNumbers:fe(At.d),_toNumbers:fe(Mt.d),_strings:fe(Mt.s),_fromNumber:At.n,_toNumber:Mt.n,_numbers:fe(At.d),_number:At.n,_unit:Mt.u,_modifier:R,_currentTime:0,_startTime:U,_delay:+S,_updateDuration:q,_changeDuration:q,_absoluteStartTime:G,_tweenType:i,_valueType:Mt.t,_composition:$,_isOverlapped:0,_isOverridden:0,_renderTransforms:0,_prevRep:null,_nextRep:null,_prevAdd:null,_nextAdd:null,_prev:null,_next:null};$!==o.none&&Qe(W,m),isNaN(y)&&(y=W._startTime),b=ue(U+q,12),f=W,P++,ve(this,W)}(isNaN(L)||y<L)&&(L=y),(isNaN(O)||b>O)&&(O=b),3===i&&(h=P-_,g=P)}if(!isNaN(h)){let e=0;be(this,(t=>{e>=h&&e<g&&(t._renderTransforms=1,t._composition===o.blend&&be($e.animation,(e=>{e.id===t.id&&(e._renderTransforms=1)}))),e++}))}}c||console.warn("No target found. Make sure the element you're trying to animate is accessible before creating your animation."),L?(be(this,(e=>{e._startTime-e._delay||(e._delay-=L),e._startTime-=L})),O-=L):L=0,O||(O=p,this.iterationCount=0),this.targets=l,this.duration=O===p?p:ge((O+this._loopDelay)*this.iterationCount-this._loopDelay)||p,this.onRender=v||w.onRender,this._ease=x,this._delay=L,this.iterationDuration=O,this._inlineStyles=E,!this._autoplay&&N&&this.onRender(this)}stretch(e){const t=this.duration;if(t===me(e))return this;const s=e/t;return be(this,(e=>{e._updateDuration=me(e._updateDuration*s),e._changeDuration=me(e._changeDuration*s),e._currentTime*=s,e._startTime*=s,e._absoluteStartTime*=s})),super.stretch(e)}refresh(){return be(this,(e=>{const t=Ge(e.target,e.property,e._tweenType);qe(t,Ye),e._fromNumbers=fe(Ye.d),e._fromNumber=Ye.n,e._func&&(qe(e._func(),Mt),e._toNumbers=fe(Mt.d),e._strings=fe(Mt.s),e._toNumber=Mt.n)})),this}revert(){return super.revert(),kt(this)}then(e){return super.then(e)}}const Ft=(e,t)=>new Nt(e,t,null,0,!1).init(),Bt=(e,t=100)=>{const s=[];for(let n=0;n<=t;n++)s.push(e(n/t));return`linear(${s.join(", ")})`},It={in:"ease-in",out:"ease-out",inOut:"ease-in-out"},zt=(()=>{const e={};for(let t in ft)e[t]=e=>ft[t](gt(e));return e})(),jt=e=>{let t=It[e];if(t)return t;if(t="linear",z(e)){if(P(e,"linear")||P(e,"cubic-")||P(e,"steps")||P(e,"ease"))t=e;else if(P(e,"cubicB"))t=L(e);else{const s=yt(e,zt,It);j(s)&&(t=s===ot?"linear":Bt(s))}It[e]=t}else if(j(e)){const s=Bt(e);s&&(t=s)}else e.ease&&(t=Bt(e.ease));return t},Ht=["x","y","z"],Ut=["perspective","width","height","margin","padding","top","right","bottom","left","borderWidth","fontSize","borderRadius",...Ht],Gt=[...Ht,...b.filter((e=>["X","Y","Z"].some((t=>e.endsWith(t)))))];let Vt=s&&(H(CSS)||!Object.hasOwnProperty.call(CSS,"registerProperty"));const qt={_head:null,_tail:null},Wt=(e,t,s)=>{let n=qt._head;for(;n;){const r=n._next,i=n.$el===e,o=!t||n.property===t,a=!s||n.parent===s;if(i&&o&&a){const e=n.animation;try{e.commitStyles()}catch{}e.cancel(),_e(qt,n);const t=n.parent;t&&(t._completed++,t.animations.length===t._completed&&(t.completed=!0,t.muteCallbacks||(t.paused=!0,t.onComplete(t),t._resolve(t))))}n=r}},Yt=(e,t,s,n,r)=>{const i=t.animate(n,r),o=r.delay+ +r.duration*r.iterations;i.playbackRate=e._speed,e.paused&&i.pause(),e.duration<o&&(e.duration=o,e.controlAnimation=i),e.animations.push(i),Wt(t,s),ve(qt,{parent:e,animation:i,$el:t,property:s,_next:null,_prev:null});const a=()=>{Wt(t,s,e)};return i.onremove=a,i.onfinish=a,i},Xt=(e,t,s,n,r)=>{let i=je(t,s,n,r);return I(i)?Ut.includes(e)||P(e,"translate")?`${i}px`:P(e,"rotate")||P(e,"skew")?`${i}deg`:`${i}`:i},Jt=(e,t,s,n,r,i)=>{let o="0";const a=H(n)?getComputedStyle(e)[t]:Xt(t,n,e,r,i);return o=H(s)?F(n)?n.map((s=>Xt(t,s,e,r,i))):a:[Xt(t,s,e,r,i),a],o};class Zt{constructor(e,t){R.scope&&R.scope.revertibles.push(this),Vt||(b.forEach((e=>{const t=P(e,"skew"),s=P(e,"scale"),n=P(e,"rotate"),r=P(e,"translate"),i=n||t,o=i?"<angle>":s?"<number>":r?"<length-percentage>":"*";try{CSS.registerProperty({name:"--"+e,syntax:o,inherits:!1,initialValue:r?"0px":i?"0deg":s?"1":"0"})}catch{}})),Vt=!0);const s=Oe(e),n=s.length;n||console.warn("No target found. Make sure the element you're trying to animate is accessible before creating your animation.");const r=ze(t.ease,jt(R.defaults.ease)),i=r.ease&&r,o=ze(t.autoplay,R.defaults.autoplay),a=!(!o||!o.link)&&o,l=t.alternate&&!0===t.alternate,c=t.reversed&&!0===t.reversed,u=ze(t.loop,R.defaults.loop),h=!0===u||u===1/0?1/0:I(u)?u+1:1,p=l?c?"alternate-reverse":"alternate":c?"reverse":"normal",g=jt(r),w=1===R.timeScale?1:m;this.targets=s,this.animations=[],this.controlAnimation=null,this.onComplete=t.onComplete||v,this.duration=0,this.muteCallbacks=!1,this.completed=!1,this.paused=!o||!1!==a,this.reversed=c,this.autoplay=o,this._speed=ze(t.playbackRate,R.defaults.playbackRate),this._resolve=v,this._completed=0,this._inlineStyles=s.map((e=>e.getAttribute("style"))),s.forEach(((e,s)=>{const o=e[d],a=Gt.some((e=>t.hasOwnProperty(e))),l=(i?i.duration:je(ze(t.duration,R.defaults.duration),e,s,n))*w,c=je(ze(t.delay,R.defaults.delay),e,s,n)*w,u=ze(t.composition,"replace");for(let i in t){if(!Y(i))continue;const d={},m={iterations:h,direction:p,fill:"forwards",easing:g,duration:l,delay:c,composite:u},f=t[i],_=!!a&&(b.includes(i)?i:y.get(i));let v;if(B(f)){const t=f,a=ze(t.ease,r),h=a.ease&&a,p=t.to,g=t.from;if(m.duration=(h?h.duration:je(ze(t.duration,l),e,s,n))*w,m.delay=je(ze(t.delay,c),e,s,n)*w,m.composite=ze(t.composition,u),m.easing=jt(a),v=Jt(e,i,g,p,s,n),_?(d[`--${_}`]=v,o[_]=v):d[i]=Jt(e,i,g,p,s,n),Yt(this,e,i,d,m),!H(g))if(_){const t=`--${_}`;e.style.setProperty(t,d[t][0])}else e.style[i]=d[i][0]}else v=F(f)?f.map((t=>Xt(i,t,e,s,n))):Xt(i,f,e,s,n),_?(d[`--${_}`]=v,o[_]=v):d[i]=v,Yt(this,e,i,d,m)}if(a){let t=f;for(let e in o)t+=`${_[e]}var(--${e})) `;e.style.transform=t}})),a&&this.autoplay.link(this)}forEach(e){const t=z(e)?t=>t[e]():e;return this.animations.forEach(t),this}get speed(){return this._speed}set speed(e){this._speed=+e,this.forEach((t=>t.playbackRate=e))}get currentTime(){const e=this.controlAnimation,t=R.timeScale;return this.completed?this.duration:e?+e.currentTime*(1===t?1:t):0}set currentTime(e){const t=e*(1===R.timeScale?1:m);this.forEach((e=>{t>=this.duration&&e.play(),e.currentTime=t}))}get progress(){return this.currentTime/this.duration}set progress(e){this.forEach((t=>t.currentTime=e*this.duration||0))}resume(){return this.paused?(this.paused=!1,this.forEach("play")):this}pause(){return this.paused?this:(this.paused=!0,this.forEach("pause"))}alternate(){return this.reversed=!this.reversed,this.forEach("reverse"),this.paused&&this.forEach("pause"),this}play(){return this.reversed&&this.alternate(),this.resume()}reverse(){return this.reversed||this.alternate(),this.resume()}seek(e,t=!1){return t&&(this.muteCallbacks=!0),e<this.duration&&(this.completed=!1),this.currentTime=e,this.muteCallbacks=!1,this.paused&&this.pause(),this}restart(){return this.completed=!1,this.seek(0,!0).resume()}commitStyles(){return this.forEach("commitStyles")}complete(){return this.seek(this.duration)}cancel(){return this.forEach("cancel"),this.pause()}revert(){return this.cancel(),this.targets.forEach(((e,t)=>e.setAttribute("style",this._inlineStyles[t]))),this}then(e=v){const t=this.then,s=()=>{this.then=null,e(this),this.then=t,this._resolve=v};return new Promise((e=>(this._resolve=()=>e(s()),this.completed&&this._resolve(),this)))}}const Kt={animate:(e,t)=>new Zt(e,t),convertEase:Bt},Qt=(e=v)=>new rt({duration:1*R.timeScale,onComplete:e},null,0).resume();function es(e,t,s){const n=Oe(e);if(!n.length)return;const[r]=n,i=He(r,t),o=St(t,r,i);let a=Ge(r,o);if(H(s))return a;if(qe(a,Ye),0===Ye.t||1===Ye.t){if(!1===s)return Ye.n;{const e=Ct(r,Ye,s,!1);return`${ue(e.n,R.precision)}${e.u}`}}}const ts=(e,t)=>{if(!H(t))return t.duration=p,t.composition=ze(t.composition,o.none),new Nt(e,t,null,0,!0).resume()},ss=(e,t,s)=>{let n=!1;return be(t,(r=>{const i=r.target;if(e.includes(i)){const e=r.property,o=r._tweenType,a=St(s,i,o);(!a||a&&a===e)&&(r.parent._tail===r&&3===r._tweenType&&r._prev&&3===r._prev._tweenType&&(r._prev._renderTransforms=1),_e(t,r),et(r),n=!0)}}),!0),n},ns=(e,t,s)=>{const n=Re(e),r=t||Me,i=t&&t.controlAnimation&&t;for(let e=0,t=n.length;e<t;e++){const t=n[e];Wt(t,s,i)}let o;if(r._hasChildren){let t=0;be(r,(i=>{if(!i._hasChildren)if(o=ss(n,i,s),o&&!i._head)i.cancel(),_e(r,i);else{const e=i._offset+i._delay+i.duration;e>t&&(t=e)}i._head?ns(e,i,s):i._hasChildren=!1}),!0),H(r.iterationDuration)||(r.iterationDuration=t)}else o=ss(n,r,s);return o&&!r._head&&(r._hasChildren=!1,r.cancel&&r.cancel()),n},rs=(e,t,s)=>{const n=10**(s||0);return ne((Math.random()*(t-e+1/n)+e)*n)/n},is=(e,t,s,n,r)=>n+(e-t)/(s-t)*(r-n),os=(e,t,s,n)=>{let r=m/R.defaults.frameRate;if(!1!==n){const e=n||Me._hasChildren&&Me;e&&e.deltaTime&&(r=e.deltaTime)}const i=1-Math.exp(-s*r*.1);return s?1===s?t:(1-i)*e+i*t:e},as=e=>(...t)=>{const s=e(...t);return new Proxy(v,{apply:(e,t,[n])=>s(n),get:(e,t)=>as(((...e)=>{const n=cs[t](...e);return e=>n(s(e))}))})},ls=(e,t=0)=>(...s)=>(s.length<e.length?as(((e,t=0)=>(...s)=>t?t=>e(...s,t):t=>e(t,...s))(e,t)):e)(...s),cs={$:Oe,get:es,set:ts,remove:ns,cleanInlineStyles:kt,random:rs,randomPick:e=>e[rs(0,e.length-1)],shuffle:e=>{let t,s,n=e.length;for(;n;)s=rs(0,--n),t=e[n],e[n]=e[s],e[s]=t;return e},lerp:os,sync:Qt,clamp:ls(ce),round:ls(ue),snap:ls(he),wrap:ls(((e,t,s)=>((e-t)%(s-t)+(s-t))%(s-t)+t)),interpolate:ls(pe,1),mapRange:ls(is),roundPad:ls(((e,t)=>(+e).toFixed(t))),padStart:ls(((e,t,s)=>`${e}`.padStart(t,s))),padEnd:ls(((e,t,s)=>`${e}`.padEnd(t,s))),degToRad:ls((e=>e*ae/180)),radToDeg:ls((e=>180*e/ae))},ds=(e,t)=>{let s=e.iterationDuration;if(s===p&&(s=0),H(t))return s;if(I(+t))return+t;const n=t,r=e?e.labels:null,i=!U(r),o=((e,t)=>{if(P(t,"<")){const s="<"===t[1],n=e._tail,r=n?n._offset+n._delay:0;return s?r:r+n.duration}})(e,n),a=!H(o),l=E.exec(n);if(l){const e=l[0],t=n.split(e),c=i&&t[0]?r[t[0]]:s,d=a?o:i?c:s,u=+t[1];return Ve(d,u,e[0])}return a?o:i?H(r[n])?s:r[n]:s};function us(e,t,s,n,r,i){const o=I(e.duration)&&e.duration<=p?s-p:s;xe(t,o,1,1,1);const a=n?new Nt(n,e,t,o,!1,r,i):new rt(e,t,o);return a.init(1),ve(t,a),be(t,(e=>{const s=e._offset+e._delay+e.duration;s>t.iterationDuration&&(t.iterationDuration=s)})),t.duration=function(e){return ge((e.iterationDuration+e._loopDelay)*e.iterationCount-e._loopDelay)||p}(t),t}class hs extends rt{constructor(e={}){super(e,null,0),this.duration=0,this.labels={};const t=e.defaults,s=R.defaults;this.defaults=t?ye(t,s):s,this.onRender=e.onRender||s.onRender;const n=ze(e.playbackEase,s.playbackEase);this._ease=n?vt(n):null,this.iterationDuration=0}add(e,t,s){const n=B(t),r=B(e);if(n||r){if(this._hasChildren=!0,n){const n=t;if(j(s)){const t=s,r=Re(e),i=this.duration,o=this.iterationDuration,a=n.id;let l=0;const c=r.length;r.forEach((e=>{const s={...n};this.duration=i,this.iterationDuration=o,H(a)||(s.id=a+"-"+l),us(s,this,t(e,l,c,this),e,l,c),l++}))}else us(n,this,ds(this,s),e)}else us(e,this,ds(this,t));return this.init(1)}}sync(e,t){if(H(e)||e&&H(e.pause))return this;e.pause();const s=+(e.effect?e.effect.getTiming().duration:e.duration);return this.add(e,{currentTime:[0,s],duration:s,ease:"linear"},t)}set(e,t,s){return H(t)?this:(t.duration=p,t.composition=o.replace,this.add(e,t,s))}call(e,t){return H(e)||e&&!j(e)?this:this.add({duration:0,onComplete:()=>e(this)},t)}label(e,t){return H(e)||e&&!z(e)||(this.labels[e]=ds(this,t)),this}remove(e,t){return ns(e,this,t),this}stretch(e){const t=this.duration;if(t===me(e))return this;const s=e/t,n=this.labels;be(this,(e=>e.stretch(e.duration*s)));for(let e in n)n[e]*=s;return super.stretch(e)}refresh(){return be(this,(e=>{e.refresh&&e.refresh()})),this}revert(){return super.revert(),be(this,(e=>e.revert),!0),kt(this)}then(e){return super.then(e)}}const ps=e=>new hs(e).init();class gs{constructor(e,t){R.scope&&R.scope.revertibles.push(this);const s={},n={};if(this.targets=[],this.animations={},!H(e)&&!H(t)){for(let e in t){const r=t[e];Y(e)?n[e]=r:s[e]=r}for(let t in n){const r=n[t],i=B(r);let a={},l="+=0";if(i){const e=r.unit;z(e)&&(l+=e)}else a.duration=r;a[t]=i?ye({to:l},r):l;const c=ye(s,a);c.composition=o.replace,c.autoplay=!1;const d=this.animations[t]=new Nt(e,c,null,0,!1).init();this.targets.length||this.targets.push(...d.targets),this[t]=(e,t,s)=>{const n=d._head;if(H(e)&&n){const e=n._numbers;return e&&e.length?e:n._modifier(n._number)}return be(d,(t=>{if(F(e))for(let s=0,n=e.length;s<n;s++)H(t._numbers[s])||(t._fromNumbers[s]=t._modifier(t._numbers[s]),t._toNumbers[s]=e[s]);else t._fromNumber=t._modifier(t._number),t._toNumber=e;H(s)||(t._ease=vt(s)),t._currentTime=0})),H(t)||d.stretch(t),d.reset(1).resume(),this}}}}revert(){for(let e in this.animations)this[e]=v,this.animations[e].revert();return this.animations={},this.targets.length=0,this}}const ms=(e,t)=>new gs(e,t);class fs{constructor(e={}){this.timeStep=.02,this.restThreshold=5e-4,this.restDuration=200,this.maxDuration=6e4,this.maxRestSteps=this.restDuration/this.timeStep/m,this.maxIterations=this.maxDuration/this.timeStep/m,this.m=ce(ze(e.mass,1),0,m),this.s=ce(ze(e.stiffness,100),1,m),this.d=ce(ze(e.damping,10),.1,m),this.v=ce(ze(e.velocity,0),-1e3,m),this.w0=0,this.zeta=0,this.wd=0,this.b=0,this.solverDuration=0,this.duration=0,this.compute(),this.ease=e=>0===e||1===e?e:this.solve(e*this.solverDuration)}solve(e){const{zeta:t,w0:s,wd:n,b:r}=this;let i=e;return i=t<1?te(-i*t*s)*(1*Q(n*i)+r*K(n*i)):(1+r*i)*te(-i*s),1-i}compute(){const{maxRestSteps:e,maxIterations:t,restThreshold:s,timeStep:n,m:r,d:i,s:o,v:a}=this,l=this.w0=ce(Z(o/r),p,m),c=this.zeta=i/(2*Z(o*r)),d=this.wd=c<1?l*Z(1-c*c):0;this.b=c<1?(c*l-a)/d:-a+l;let u=0,h=0,g=0;for(;h<e&&g<t;)ee(1-this.solve(u))<s?h++:h=0,this.solverDuration=u,u+=n,g++;this.duration=ue(this.solverDuration*m,0)*R.timeScale}get mass(){return this.m}set mass(e){this.m=ce(ze(e,1),0,m),this.compute()}get stiffness(){return this.s}set stiffness(e){this.s=ce(ze(e,100),1,m),this.compute()}get damping(){return this.d}set damping(e){this.d=ce(ze(e,10),.1,m),this.compute()}get velocity(){return this.v}set velocity(e){this.v=ce(ze(e,0),-1e3,m),this.compute()}}const ys=e=>new fs(e),bs=e=>{e.cancelable&&e.preventDefault()};class _s{constructor(e){this.el=e,this.zIndex=0,this.parentElement=null,this.classList={add:v,remove:v}}get x(){return this.el.x||0}set x(e){this.el.x=e}get y(){return this.el.y||0}set y(e){this.el.y=e}get width(){return this.el.width||0}set width(e){this.el.width=e}get height(){return this.el.height||0}set height(e){this.el.height=e}getBoundingClientRect(){return{top:this.y,right:this.x,bottom:this.y+this.height,left:this.x+this.width}}}class vs{constructor(e){this.$el=e,this.inlineTransforms=[],this.point=new DOMPoint,this.inversedMatrix=this.getMatrix().inverse()}normalizePoint(e,t){return this.point.x=e,this.point.y=t,this.point.matrixTransform(this.inversedMatrix)}traverseUp(e){let t=this.$el.parentElement,s=0;for(;t&&t!==i;)e(t,s),t=t.parentElement,s++}getMatrix(){const e=new DOMMatrix;return this.traverseUp((t=>{const s=getComputedStyle(t).transform;if(s){const t=new DOMMatrix(s);e.preMultiplySelf(t)}})),e}remove(){this.traverseUp(((e,t)=>{this.inlineTransforms[t]=e.style.transform,e.style.transform="none"}))}revert(){this.traverseUp(((e,t)=>{const s=this.inlineTransforms[t];""===s?e.style.removeProperty("transform"):e.style.transform=s}))}}const ws=(e,t)=>e&&j(e)?e(t):e;let Ss=0;class xs{constructor(e,t={}){if(!e)return;R.scope&&R.scope.revertibles.push(this);const s=t.x,r=t.y,o=t.trigger,a=t.modifier,l=t.releaseEase,c=l&&vt(l),d=!H(l)&&!H(l.ease),u=B(s)&&!H(s.mapTo)?s.mapTo:"translateX",h=B(r)&&!H(r.mapTo)?r.mapTo:"translateY",p=ws(t.container,this);this.containerArray=F(p)?p:null,this.$container=p&&!this.containerArray?Re(p)[0]:i.body,this.useWin=this.$container===i.body,this.$scrollContainer=this.useWin?n:this.$container,this.$target=B(e)?new _s(e):Re(e)[0],this.$trigger=Re(o||e)[0],this.fixed="fixed"===es(this.$target,"position"),this.isFinePointer=!0,this.containerPadding=[0,0,0,0],this.containerFriction=0,this.releaseContainerFriction=0,this.snapX=0,this.snapY=0,this.scrollSpeed=0,this.scrollThreshold=0,this.dragSpeed=0,this.maxVelocity=0,this.minVelocity=0,this.velocityMultiplier=0,this.cursor=!1,this.releaseXSpring=d?l:ys({mass:ze(t.releaseMass,1),stiffness:ze(t.releaseStiffness,80),damping:ze(t.releaseDamping,20)}),this.releaseYSpring=d?l:ys({mass:ze(t.releaseMass,1),stiffness:ze(t.releaseStiffness,80),damping:ze(t.releaseDamping,20)}),this.releaseEase=c||bt.outQuint,this.hasReleaseSpring=d,this.onGrab=t.onGrab||v,this.onDrag=t.onDrag||v,this.onRelease=t.onRelease||v,this.onUpdate=t.onUpdate||v,this.onSettle=t.onSettle||v,this.onSnap=t.onSnap||v,this.onResize=t.onResize||v,this.onAfterResize=t.onAfterResize||v,this.disabled=[0,0];const m={};if(a&&(m.modifier=a),H(s)||!0===s)m[u]=0;else if(B(s)){const e=s,t={};e.modifier&&(t.modifier=e.modifier),e.composition&&(t.composition=e.composition),m[u]=t}else!1===s&&(m[u]=0,this.disabled[0]=1);if(H(r)||!0===r)m[h]=0;else if(B(r)){const e=r,t={};e.modifier&&(t.modifier=e.modifier),e.composition&&(t.composition=e.composition),m[h]=t}else!1===r&&(m[h]=0,this.disabled[1]=1);this.animate=new gs(this.$target,m),this.xProp=u,this.yProp=h,this.destX=0,this.destY=0,this.deltaX=0,this.deltaY=0,this.scroll={x:0,y:0},this.coords=[this.x,this.y,0,0],this.snapped=[0,0],this.pointer=[0,0,0,0,0,0,0,0],this.scrollView=[0,0],this.dragArea=[0,0,0,0],this.containerBounds=[-1e12,g,g,-1e12],this.scrollBounds=[0,0,0,0],this.targetBounds=[0,0,0,0],this.window=[0,0],this.velocityStack=[0,0,0],this.velocityStackIndex=0,this.velocityTime=N(),this.velocity=0,this.angle=0,this.cursorStyles=null,this.triggerStyles=null,this.bodyStyles=null,this.targetStyles=null,this.touchActionStyles=null,this.transforms=new vs(this.$target),this.overshootCoords={x:0,y:0},this.overshootXTicker=new rt({autoplay:!1},null,0).init(),this.overshootYTicker=new rt({autoplay:!1},null,0).init(),this.updateTicker=new rt({autoplay:!1},null,0).init(),this.overshootXTicker.onUpdate=()=>{this.disabled[0]||(this.updated=!0,this.manual=!0,this.animate[this.xProp](this.overshootCoords.x,0))},this.overshootXTicker.onComplete=()=>{this.disabled[0]||(this.manual=!1,this.animate[this.xProp](this.overshootCoords.x,0))},this.overshootYTicker.onUpdate=()=>{this.disabled[1]||(this.updated=!0,this.manual=!0,this.animate[this.yProp](this.overshootCoords.y,0))},this.overshootYTicker.onComplete=()=>{this.disabled[1]||(this.manual=!1,this.animate[this.yProp](this.overshootCoords.y,0))},this.updateTicker.onUpdate=()=>this.update(),this.contained=!H(p),this.manual=!1,this.grabbed=!1,this.dragged=!1,this.updated=!1,this.released=!1,this.canScroll=!1,this.enabled=!1,this.initialized=!1,this.activeProp=this.disabled[1]?u:h,this.animate.animations[this.activeProp].onRender=()=>{const e=this.updated,t=!(this.grabbed&&e)&&this.released,s=this.x,n=this.y,r=s-this.coords[2],i=n-this.coords[3];this.deltaX=r,this.deltaY=i,this.coords[2]=s,this.coords[3]=n,e&&this.onUpdate(this),t?(this.computeVelocity(r,i),this.angle=oe(i,r)):this.updated=!1},this.animate.animations[this.activeProp].onComplete=()=>{!this.grabbed&&this.released&&(this.released=!1),this.manual||(this.deltaX=0,this.deltaY=0,this.velocity=0,this.velocityStack[0]=0,this.velocityStack[1]=0,this.velocityStack[2]=0,this.velocityStackIndex=0,this.onSettle(this))},this.resizeTicker=new rt({autoplay:!1,duration:150*R.timeScale,onComplete:()=>{this.onResize(this),this.refresh(),this.onAfterResize(this)}}).init(),this.parameters=t,this.resizeObserver=new ResizeObserver((()=>{this.initialized?this.resizeTicker.restart():this.initialized=!0})),this.enable(),this.refresh(),this.resizeObserver.observe(this.$container),B(e)||this.resizeObserver.observe(this.$target)}computeVelocity(e,t){const s=this.velocityTime,n=N(),r=n-s;if(r<17)return this.velocity;this.velocityTime=n;const i=this.velocityStack,o=this.velocityMultiplier,a=this.minVelocity,l=this.maxVelocity,c=this.velocityStackIndex;i[c]=ue(ce(Z(e*e+t*t)/r*o,a,l),5);const d=ie(i[0],i[1],i[2]);return this.velocity=d,this.velocityStackIndex=(c+1)%3,d}setX(e,t=!1){if(this.disabled[0])return;const s=ue(e,5);return this.overshootXTicker.pause(),this.manual=!0,this.updated=!t,this.destX=s,this.snapped[0]=he(s,this.snapX),this.animate[this.xProp](s,0),this.manual=!1,this}setY(e,t=!1){if(this.disabled[1])return;const s=ue(e,5);return this.overshootYTicker.pause(),this.manual=!0,this.updated=!t,this.destY=s,this.snapped[1]=he(s,this.snapY),this.animate[this.yProp](s,0),this.manual=!1,this}get x(){return ue(this.animate[this.xProp](),R.precision)}set x(e){this.setX(e,!1)}get y(){return ue(this.animate[this.yProp](),R.precision)}set y(e){this.setY(e,!1)}get progressX(){return is(this.x,this.containerBounds[3],this.containerBounds[1],0,1)}set progressX(e){this.setX(is(e,0,1,this.containerBounds[3],this.containerBounds[1]),!1)}get progressY(){return is(this.y,this.containerBounds[0],this.containerBounds[2],0,1)}set progressY(e){this.setY(is(e,0,1,this.containerBounds[0],this.containerBounds[2]),!1)}updateScrollCoords(){const e=ue(this.useWin?n.scrollX:this.$container.scrollLeft,0),t=ue(this.useWin?n.scrollY:this.$container.scrollTop,0),[s,r,i,o]=this.containerPadding,a=this.scrollThreshold;this.scroll.x=e,this.scroll.y=t,this.scrollBounds[0]=t-this.targetBounds[0]+s-a,this.scrollBounds[1]=e-this.targetBounds[1]-r+a,this.scrollBounds[2]=t-this.targetBounds[2]-i+a,this.scrollBounds[3]=e-this.targetBounds[3]+o-a}updateBoundingValues(){const e=this.$container,t=this.x,s=this.y,r=this.coords[2],o=this.coords[3];this.coords[2]=0,this.coords[3]=0,this.setX(0,!0),this.setY(0,!0),this.transforms.remove();const a=this.window[0]=n.innerWidth,l=this.window[1]=n.innerHeight,c=this.useWin,d=e.scrollWidth,u=e.scrollHeight,h=this.fixed,p=e.getBoundingClientRect(),[g,m,f,y]=this.containerPadding;this.dragArea[0]=c?0:p.left,this.dragArea[1]=c?0:p.top,this.scrollView[0]=c?ce(d,a,d):d,this.scrollView[1]=c?ce(u,l,u):u,this.updateScrollCoords();const{width:b,height:_,left:v,top:w,right:S,bottom:x}=e.getBoundingClientRect();this.dragArea[2]=ue(c?ce(b,a,a):b,0),this.dragArea[3]=ue(c?ce(_,l,l):_,0);const $=es(e,"overflow"),C="visible"===$,k="hidden"===$;if(this.canScroll=!h&&this.contained&&(e===i.body&&C||!k&&!C)&&(d>this.dragArea[2]+y-m||u>this.dragArea[3]+g-f)&&(!this.containerArray||this.containerArray&&!F(this.containerArray)),this.contained){const t=this.scroll.x,s=this.scroll.y,n=this.canScroll,r=this.$target.getBoundingClientRect(),i=n?c?0:e.scrollLeft:0,o=n?c?0:e.scrollTop:0,d=n?this.scrollView[0]-i-b:0,u=n?this.scrollView[1]-o-_:0;this.targetBounds[0]=ue(r.top+s-(c?0:w),0),this.targetBounds[1]=ue(r.right+t-(c?a:S),0),this.targetBounds[2]=ue(r.bottom+s-(c?l:x),0),this.targetBounds[3]=ue(r.left+t-(c?0:v),0),this.containerArray?(this.containerBounds[0]=this.containerArray[0]+g,this.containerBounds[1]=this.containerArray[1]-m,this.containerBounds[2]=this.containerArray[2]-f,this.containerBounds[3]=this.containerArray[3]+y):(this.containerBounds[0]=-ue(r.top-(h?ce(w,0,l):w)+o-g,0),this.containerBounds[1]=-ue(r.right-(h?ce(S,0,a):S)-d+m,0),this.containerBounds[2]=-ue(r.bottom-(h?ce(x,0,l):x)-u+f,0),this.containerBounds[3]=-ue(r.left-(h?ce(v,0,a):v)+i-y,0))}this.transforms.revert(),this.coords[2]=r,this.coords[3]=o,this.setX(t,!0),this.setY(s,!0)}isOutOfBounds(e,t,s){if(!this.contained)return 0;const[n,r,i,o]=e,[a,l]=this.disabled,c=!a&&t<o||!a&&t>r,d=!l&&s<n||!l&&s>i;return c&&!d?1:!c&&d?2:c&&d?3:0}refresh(){const e=this.parameters,t=e.x,s=e.y,r=ws(e.container,this),o=ws(e.containerPadding,this)||0,a=F(o)?o:[o,o,o,o],l=this.x,c=this.y,d=ws(e.cursor,this),u={onHover:"grab",onGrab:"grabbing"};if(d){const{onHover:e,onGrab:t}=d;e&&(u.onHover=e),t&&(u.onGrab=t)}this.containerArray=F(r)?r:null,this.$container=r&&!this.containerArray?Re(r)[0]:i.body,this.useWin=this.$container===i.body,this.$scrollContainer=this.useWin?n:this.$container,this.isFinePointer=matchMedia("(pointer:fine)").matches,this.containerPadding=ze(a,[0,0,0,0]),this.containerFriction=ce(ze(ws(e.containerFriction,this),.8),0,1),this.releaseContainerFriction=ce(ze(ws(e.releaseContainerFriction,this),this.containerFriction),0,1),this.snapX=ws(B(t)&&!H(t.snap)?t.snap:e.snap,this),this.snapY=ws(B(s)&&!H(s.snap)?s.snap:e.snap,this),this.scrollSpeed=ze(ws(e.scrollSpeed,this),1.5),this.scrollThreshold=ze(ws(e.scrollThreshold,this),20),this.dragSpeed=ze(ws(e.dragSpeed,this),1),this.minVelocity=ze(ws(e.minVelocity,this),0),this.maxVelocity=ze(ws(e.maxVelocity,this),50),this.velocityMultiplier=ze(ws(e.velocityMultiplier,this),1),this.cursor=!1!==d&&u,this.updateBoundingValues();const[h,p,g,m]=this.containerBounds;this.setX(ce(l,m,p),!0),this.setY(ce(c,h,g),!0)}update(){if(this.updateScrollCoords(),this.canScroll){const[e,t,s,n]=this.containerPadding,[r,i]=this.scrollView,o=this.dragArea[2],a=this.dragArea[3],l=this.scroll.x,c=this.scroll.y,d=this.$container.scrollWidth,u=this.$container.scrollHeight,h=this.useWin?ce(d,this.window[0],d):d,p=this.useWin?ce(u,this.window[1],u):u,g=r-h,m=i-p;this.dragged&&g>0&&(this.coords[0]-=g,this.scrollView[0]=h),this.dragged&&m>0&&(this.coords[1]-=m,this.scrollView[1]=p);const f=10*this.scrollSpeed,y=this.scrollThreshold,[b,_]=this.coords,[v,w,S,x]=this.scrollBounds,$=ue(ce((_-v+e)/y,-1,0)*f,0),C=ue(ce((b-w-t)/y,0,1)*f,0),k=ue(ce((_-S-s)/y,0,1)*f,0),A=ue(ce((b-x+n)/y,-1,0)*f,0);if($||k||A||C){const[e,t]=this.disabled;let s=l,n=c;e||(s=ue(ce(l+(A||C),0,r-o),0),this.coords[0]-=l-s),t||(n=ue(ce(c+($||k),0,i-a),0),this.coords[1]-=c-n),this.useWin?this.$scrollContainer.scrollBy(-(l-s),-(c-n)):this.$scrollContainer.scrollTo(s,n)}}const[e,t,s,n]=this.containerBounds,[r,i,o,a,l,c]=this.pointer;this.coords[0]+=(r-l)*this.dragSpeed,this.coords[1]+=(i-c)*this.dragSpeed,this.pointer[4]=r,this.pointer[5]=i;const[d,u]=this.coords,[h,p]=this.snapped,g=(1-this.containerFriction)*this.dragSpeed;this.setX(d>t?t+(d-t)*g:d<n?n+(d-n)*g:d,!1),this.setY(u>s?s+(u-s)*g:u<e?e+(u-e)*g:u,!1),this.computeVelocity(r-l,i-c),this.angle=oe(i-a,r-o);const[m,f]=this.snapped;(m!==h&&this.snapX||f!==p&&this.snapY)&&this.onSnap(this)}stop(){this.updateTicker.pause(),this.overshootXTicker.pause(),this.overshootYTicker.pause();for(let e in this.animate.animations)this.animate.animations[e].pause();return ns(this,null,"x"),ns(this,null,"y"),ns(this,null,"progressX"),ns(this,null,"progressY"),ns(this.scroll),ns(this.overshootCoords),this}scrollInView(e,t=0,s=bt.inOutQuad){this.updateScrollCoords();const n=this.destX,r=this.destY,i=this.scroll,o=this.scrollBounds,a=this.canScroll;if(!this.containerArray&&this.isOutOfBounds(o,n,r)){const[l,c,d,u]=o,h=ue(ce(r-l,-1e12,0),0),p=ue(ce(n-c,0,g),0),m=ue(ce(r-d,0,g),0),f=ue(ce(n-u,-1e12,0),0);new Nt(i,{x:ue(i.x+(f?f-t:p?p+t:0),0),y:ue(i.y+(h?h-t:m?m+t:0),0),duration:H(e)?350*R.timeScale:e,ease:s,onUpdate:()=>{this.canScroll=!1,this.$scrollContainer.scrollTo(i.x,i.y)}}).init().then((()=>{this.canScroll=a}))}return this}handleHover(){this.isFinePointer&&this.cursor&&!this.cursorStyles&&(this.cursorStyles=ts(this.$trigger,{cursor:this.cursor.onHover}))}animateInView(e,t=0,s=bt.inOutQuad){this.stop(),this.updateBoundingValues();const n=this.x,r=this.y,[i,o,a,l]=this.containerPadding,c=this.scroll.y-this.targetBounds[0]+i+t,d=this.scroll.x-this.targetBounds[1]-o-t,u=this.scroll.y-this.targetBounds[2]-a-t,h=this.scroll.x-this.targetBounds[3]+l+t,p=this.isOutOfBounds([c,d,u,h],n,r);if(p){const[t,i]=this.disabled,o=ce(he(n,this.snapX),h,d),a=ce(he(r,this.snapY),c,u),l=H(e)?350*R.timeScale:e;t||1!==p&&3!==p||this.animate[this.xProp](o,l,s),i||2!==p&&3!==p||this.animate[this.yProp](a,l,s)}return this}handleDown(e){const t=e.target;if(this.grabbed||"range"===t.type)return;e.stopPropagation(),this.grabbed=!0,this.released=!1,this.stop(),this.updateBoundingValues();const s=e.changedTouches,n=s?s[0].clientX:e.clientX,r=s?s[0].clientY:e.clientY,{x:o,y:a}=this.transforms.normalizePoint(n,r),[l,c,d,u]=this.containerBounds,h=(1-this.containerFriction)*this.dragSpeed,p=this.x,g=this.y;this.coords[0]=this.coords[2]=h?p>c?c+(p-c)/h:p<u?u+(p-u)/h:p:p,this.coords[1]=this.coords[3]=h?g>d?d+(g-d)/h:g<l?l+(g-l)/h:g:g,this.pointer[0]=o,this.pointer[1]=a,this.pointer[2]=o,this.pointer[3]=a,this.pointer[4]=o,this.pointer[5]=a,this.pointer[6]=o,this.pointer[7]=a,this.deltaX=0,this.deltaY=0,this.velocity=0,this.velocityStack[0]=0,this.velocityStack[1]=0,this.velocityStack[2]=0,this.velocityStackIndex=0,this.angle=0,this.targetStyles&&(this.targetStyles.revert(),this.targetStyles=null);const m=es(this.$target,"zIndex",!1);Ss=(m>Ss?m:Ss)+1,this.targetStyles=ts(this.$target,{zIndex:Ss}),this.triggerStyles&&(this.triggerStyles.revert(),this.triggerStyles=null),this.cursorStyles&&(this.cursorStyles.revert(),this.cursorStyles=null),this.isFinePointer&&this.cursor&&(this.bodyStyles=ts(i.body,{cursor:this.cursor.onGrab})),this.scrollInView(100,0,bt.out(3)),this.onGrab(this),i.addEventListener("touchmove",this),i.addEventListener("touchend",this),i.addEventListener("touchcancel",this),i.addEventListener("mousemove",this),i.addEventListener("mouseup",this),i.addEventListener("selectstart",this)}handleMove(e){if(!this.grabbed)return;const t=e.changedTouches,s=t?t[0].clientX:e.clientX,n=t?t[0].clientY:e.clientY,{x:r,y:i}=this.transforms.normalizePoint(s,n),o=r-this.pointer[6],a=i-this.pointer[7];let l=e.target,c=!1,d=!1,u=!1;for(;t&&l&&l!==this.$trigger;){const e=es(l,"overflow-y");if("hidden"!==e&&"visible"!==e){const{scrollTop:e,scrollHeight:t,clientHeight:s}=l;if(t>s){u=!0,c=e<=3,d=e>=t-s-3;break}}l=l.parentNode}u&&(!c&&!d||c&&a<0||d&&a>0)?(this.pointer[0]=r,this.pointer[1]=i,this.pointer[2]=r,this.pointer[3]=i,this.pointer[4]=r,this.pointer[5]=i,this.pointer[6]=r,this.pointer[7]=i):(bs(e),this.triggerStyles||(this.triggerStyles=ts(this.$trigger,{pointerEvents:"none"})),this.$trigger.addEventListener("touchstart",bs,{passive:!1}),this.$trigger.addEventListener("touchmove",bs,{passive:!1}),this.$trigger.addEventListener("touchend",bs),(!this.disabled[0]&&ee(o)>3||!this.disabled[1]&&ee(a)>3)&&(this.updateTicker.resume(),this.pointer[2]=this.pointer[0],this.pointer[3]=this.pointer[1],this.pointer[0]=r,this.pointer[1]=i,this.dragged=!0,this.released=!1,this.onDrag(this)))}handleUp(){if(!this.grabbed)return;this.updateTicker.pause(),this.triggerStyles&&(this.triggerStyles.revert(),this.triggerStyles=null),this.bodyStyles&&(this.bodyStyles.revert(),this.bodyStyles=null);const[e,t]=this.disabled,[s,n,r,a,l,c]=this.pointer,[d,u,h,p]=this.containerBounds,[g,m]=this.snapped,f=this.releaseXSpring,y=this.releaseYSpring,b=this.releaseEase,_=this.hasReleaseSpring,v=this.overshootCoords,w=this.x,S=this.y,x=this.computeVelocity(s-l,n-c),$=this.angle=oe(n-a,s-r),C=150*x,k=(1-this.releaseContainerFriction)*this.dragSpeed,A=w+Q($)*C,M=S+K($)*C,D=A>u?u+(A-u)*k:A<p?p+(A-p)*k:A,E=M>h?h+(M-h)*k:M<d?d+(M-d)*k:M,T=this.destX=ce(ue(he(D,this.snapX),5),p,u),O=this.destY=ce(ue(he(E,this.snapY),5),d,h),L=this.isOutOfBounds(this.containerBounds,A,M);let P=0,N=0,F=b,B=b,I=0;if(v.x=w,v.y=S,!e){const e=T===u?w>u?-1:1:w<p?-1:1,s=ue(w-T,0);f.velocity=t&&_?s?C*e/ee(s):0:x;const{ease:n,duration:r,restDuration:i}=f;P=w===T?0:_?r:r-i*R.timeScale,_&&(F=n),P>I&&(I=P)}if(!t){const t=O===h?S>h?-1:1:S<d?-1:1,s=ue(S-O,0);y.velocity=e&&_?s?C*t/ee(s):0:x;const{ease:n,duration:r,restDuration:i}=y;N=S===O?0:_?r:r-i*R.timeScale,_&&(B=n),N>I&&(I=N)}if(!_&&L&&k&&(P||N)){const e=o.blend;new Nt(v,{x:{to:D,duration:.65*P},y:{to:E,duration:.65*N},ease:b,composition:e}).init(),new Nt(v,{x:{to:T,duration:P},y:{to:O,duration:N},ease:b,composition:e}).init(),this.overshootXTicker.stretch(P).restart(),this.overshootYTicker.stretch(N).restart()}else e||this.animate[this.xProp](T,P,F),t||this.animate[this.yProp](O,N,B);this.scrollInView(I,this.scrollThreshold,b);let z=!1;T!==g&&(this.snapped[0]=T,this.snapX&&(z=!0)),O!==m&&this.snapY&&(this.snapped[1]=O,this.snapY&&(z=!0)),z&&this.onSnap(this),this.grabbed=!1,this.dragged=!1,this.updated=!0,this.released=!0,this.onRelease(this),this.$trigger.removeEventListener("touchstart",bs),this.$trigger.removeEventListener("touchmove",bs),this.$trigger.removeEventListener("touchend",bs),i.removeEventListener("touchmove",this),i.removeEventListener("touchend",this),i.removeEventListener("touchcancel",this),i.removeEventListener("mousemove",this),i.removeEventListener("mouseup",this),i.removeEventListener("selectstart",this)}reset(){return this.stop(),this.resizeTicker.pause(),this.grabbed=!1,this.dragged=!1,this.updated=!1,this.released=!1,this.canScroll=!1,this.setX(0,!0),this.setY(0,!0),this.coords[0]=0,this.coords[1]=0,this.pointer[0]=0,this.pointer[1]=0,this.pointer[2]=0,this.pointer[3]=0,this.pointer[4]=0,this.pointer[5]=0,this.pointer[6]=0,this.pointer[7]=0,this.velocity=0,this.velocityStack[0]=0,this.velocityStack[1]=0,this.velocityStack[2]=0,this.velocityStackIndex=0,this.angle=0,this}enable(){return this.enabled||(this.enabled=!0,this.$target.classList.remove("is-disabled"),this.touchActionStyles=ts(this.$trigger,{touchAction:this.disabled[0]?"pan-x":this.disabled[1]?"pan-y":"none"}),this.$trigger.addEventListener("touchstart",this,{passive:!0}),this.$trigger.addEventListener("mousedown",this,{passive:!0}),this.$trigger.addEventListener("mouseenter",this)),this}disable(){return this.enabled=!1,this.grabbed=!1,this.dragged=!1,this.updated=!1,this.released=!1,this.canScroll=!1,this.touchActionStyles.revert(),this.cursorStyles&&(this.cursorStyles.revert(),this.cursorStyles=null),this.triggerStyles&&(this.triggerStyles.revert(),this.triggerStyles=null),this.bodyStyles&&(this.bodyStyles.revert(),this.bodyStyles=null),this.targetStyles&&(this.targetStyles.revert(),this.targetStyles=null),this.stop(),this.$target.classList.add("is-disabled"),this.$trigger.removeEventListener("touchstart",this),this.$trigger.removeEventListener("mousedown",this),this.$trigger.removeEventListener("mouseenter",this),i.removeEventListener("touchmove",this),i.removeEventListener("touchend",this),i.removeEventListener("touchcancel",this),i.removeEventListener("mousemove",this),i.removeEventListener("mouseup",this),i.removeEventListener("selectstart",this),this}revert(){return this.reset(),this.disable(),this.$target.classList.remove("is-disabled"),this.updateTicker.revert(),this.overshootXTicker.revert(),this.overshootYTicker.revert(),this.resizeTicker.revert(),this.animate.revert(),this}handleEvent(e){switch(e.type){case"mousedown":case"touchstart":this.handleDown(e);break;case"mousemove":case"touchmove":this.handleMove(e);break;case"mouseup":case"touchend":case"touchcancel":this.handleUp();break;case"mouseenter":this.handleHover();break;case"selectstart":bs(e)}}}const $s=(e,t)=>new xs(e,t);class Cs{constructor(e={}){R.scope&&R.scope.revertibles.push(this);const t=e.root;let s=i;t&&(s=t.current||t.nativeElement||Re(t)[0]||i);const r=e.defaults,o=R.defaults,a=e.mediaQueries;if(this.defaults=r?ye(r,o):o,this.root=s,this.constructors=[],this.revertConstructors=[],this.revertibles=[],this.methods={},this.matches={},this.mediaQueryLists={},this.data={},a)for(let e in a){const t=n.matchMedia(a[e]);this.mediaQueryLists[e]=t,t.addEventListener("change",this)}}execute(e){let t=R.scope,s=R.root,n=R.defaults;R.scope=this,R.root=this.root,R.defaults=this.defaults;const r=this.mediaQueryLists;for(let e in r)this.matches[e]=r[e].matches;const i=e(this);return R.scope=t,R.root=s,R.defaults=n,i}refresh(){return this.execute((()=>{let e=this.revertibles.length,t=this.revertConstructors.length;for(;e--;)this.revertibles[e].revert();for(;t--;)this.revertConstructors[t](this);this.revertibles.length=0,this.revertConstructors.length=0,this.constructors.forEach((e=>{const t=e(this);t&&this.revertConstructors.push(t)}))})),this}add(e,t){if(j(e)){const t=e;this.constructors.push(t),this.execute((()=>{const e=t(this);e&&this.revertConstructors.push(e)}))}else this.methods[e]=(...e)=>this.execute((()=>t(...e)));return this}handleEvent(e){"change"===e.type&&this.refresh()}revert(){const e=this.revertibles,t=this.revertConstructors,s=this.mediaQueryLists;let n=e.length,r=t.length;for(;n--;)e[n].revert();for(;r--;)t[r](this);for(let e in s)s[e].removeEventListener("change",this);e.length=0,t.length=0,this.constructors.length=0,this.matches={},this.methods={},this.mediaQueryLists={},this.data={}}}const ks=e=>new Cs(e),As=(e,t)=>e&&j(e)?e(t):e,Ms=new Map;class Ds{constructor(e){this.element=e,this.useWin=this.element===i.body,this.winWidth=0,this.winHeight=0,this.width=0,this.height=0,this.left=0,this.top=0,this.zIndex=0,this.scrollX=0,this.scrollY=0,this.prevScrollX=0,this.prevScrollY=0,this.scrollWidth=0,this.scrollHeight=0,this.velocity=0,this.backwardX=!1,this.backwardY=!1,this.scrollTicker=new rt({autoplay:!1,onBegin:()=>this.dataTimer.resume(),onUpdate:()=>{const e=this.backwardX||this.backwardY;be(this,(e=>e.handleScroll()),e)},onComplete:()=>this.dataTimer.pause()}).init(),this.dataTimer=new rt({autoplay:!1,frameRate:30,onUpdate:e=>{const t=e.deltaTime,s=this.prevScrollX,n=this.prevScrollY,r=this.scrollX,i=this.scrollY,o=s-r,a=n-i;this.prevScrollX=r,this.prevScrollY=i,o&&(this.backwardX=s>r),a&&(this.backwardY=n>i),this.velocity=ue(t>0?Math.sqrt(o*o+a*a)/t:0,5)}}).init(),this.resizeTicker=new rt({autoplay:!1,duration:250*R.timeScale,onComplete:()=>{this.updateWindowBounds(),this.refreshScrollObservers(),this.handleScroll()}}).init(),this.wakeTicker=new rt({autoplay:!1,duration:500*R.timeScale,onBegin:()=>{this.scrollTicker.resume()},onComplete:()=>{this.scrollTicker.pause()}}).init(),this._head=null,this._tail=null,this.updateScrollCoords(),this.updateWindowBounds(),this.updateBounds(),this.refreshScrollObservers(),this.handleScroll(),this.resizeObserver=new ResizeObserver((()=>this.resizeTicker.restart())),this.resizeObserver.observe(this.element),(this.useWin?n:this.element).addEventListener("scroll",this,!1)}updateScrollCoords(){const e=this.useWin,t=this.element;this.scrollX=ue(e?n.scrollX:t.scrollLeft,0),this.scrollY=ue(e?n.scrollY:t.scrollTop,0)}updateWindowBounds(){this.winWidth=n.innerWidth,this.winHeight=(()=>{const e=document.createElement("div");i.body.appendChild(e),e.style.height="100lvh";const t=e.offsetHeight;return i.body.removeChild(e),t})()}updateBounds(){const e=getComputedStyle(this.element),t=this.element;let s,n;if(this.scrollWidth=t.scrollWidth+parseFloat(e.marginLeft)+parseFloat(e.marginRight),this.scrollHeight=t.scrollHeight+parseFloat(e.marginTop)+parseFloat(e.marginBottom),this.updateWindowBounds(),this.useWin)s=this.winWidth,n=this.winHeight;else{const e=t.getBoundingClientRect();s=e.width,n=e.height,this.top=e.top,this.left=e.left}this.width=s,this.height=n}refreshScrollObservers(){be(this,(e=>{e._debug&&e.removeDebug()})),this.updateBounds(),be(this,(e=>{e.refresh(),e._debug&&e.debug()}))}refresh(){this.updateWindowBounds(),this.updateBounds(),this.refreshScrollObservers(),this.handleScroll()}handleScroll(){this.updateScrollCoords(),this.wakeTicker.restart()}handleEvent(e){"scroll"===e.type&&this.handleScroll()}revert(){this.scrollTicker.cancel(),this.dataTimer.cancel(),this.resizeTicker.cancel(),this.wakeTicker.cancel(),this.resizeObserver.unobserve(this.element),(this.useWin?n:this.element).removeEventListener("scroll",this),Ms.delete(this.element)}}const Es=(e,t,s,n,r)=>{const i="min"===t,o="max"===t,a="top"===t||"left"===t||"start"===t||i?0:"bottom"===t||"right"===t||"end"===t||o?"100%":"center"===t?"50%":t,{n:l,u:c}=qe(a,Ye);let d=l;return"%"===c?d=l/100*s:c&&(d=Ct(e,Ye,"px",!0).n),o&&n<0&&(d+=n),i&&r>0&&(d+=r),d},Ts=(e,t,s,n,r)=>{let i;if(z(t)){const o=E.exec(t);if(o){const a=o[0],l=a[0],c=t.split(a),d="min"===c[0],u="max"===c[0],h=Es(e,c[0],s,n,r),p=Es(e,c[1],s,n,r);if(d){const t=Ve(Es(e,"min",s),p,l);i=t<h?h:t}else if(u){const t=Ve(Es(e,"max",s),p,l);i=t>h?h:t}else i=Ve(h,p,l)}else i=Es(e,t,s,n,r)}else i=t;return ue(i,0)},Rs=e=>{let t;const s=e.targets;for(let e=0,n=s.length;e<n;e++){const n=s[e];if(n[l]){t=n;break}}return t};let Os=0;const Ls=["#FF4B4B","#FF971B","#FFC730","#F9F640","#7AFF5A","#18FF74","#17E09B","#3CFFEC","#05DBE9","#33B3F1","#638CF9","#C563FE","#FF4FCF","#F93F8A"];class Ps{constructor(e={}){R.scope&&R.scope.revertibles.push(this);const t=ze(e.sync,"play pause"),s=t?vt(t):null,n=t&&("linear"===t||t===ot),r=t&&!(s===ot&&!n),o=t&&(I(t)||!0===t||n),a=t&&z(t)&&!r&&!o,l=a?t.split(" ").map((e=>()=>{const t=this.linked;return t&&t[e]?t[e]():null})):null,c=a&&l.length>2;this.index=Os++,this.id=H(e.id)?this.index:e.id,this.container=(e=>{const t=e&&Re(e)[0]||i.body;let s=Ms.get(t);return s||(s=new Ds(t),Ms.set(t,s)),s})(e.container),this.target=null,this.linked=null,this.repeat=null,this.horizontal=null,this.enter=null,this.leave=null,this.sync=r||o||!!l,this.syncEase=r?s:null,this.syncSmooth=o?!0===t||n?1:t:null,this.onSyncEnter=l&&!c&&l[0]?l[0]:v,this.onSyncLeave=l&&!c&&l[1]?l[1]:v,this.onSyncEnterForward=l&&c&&l[0]?l[0]:v,this.onSyncLeaveForward=l&&c&&l[1]?l[1]:v,this.onSyncEnterBackward=l&&c&&l[2]?l[2]:v,this.onSyncLeaveBackward=l&&c&&l[3]?l[3]:v,this.onEnter=e.onEnter||v,this.onLeave=e.onLeave||v,this.onEnterForward=e.onEnterForward||v,this.onLeaveForward=e.onLeaveForward||v,this.onEnterBackward=e.onEnterBackward||v,this.onLeaveBackward=e.onLeaveBackward||v,this.onUpdate=e.onUpdate||v,this.onSyncComplete=e.onSyncComplete||v,this.reverted=!1,this.completed=!1,this.began=!1,this.isInView=!1,this.forceEnter=!1,this.hasEntered=!1,this.offsets=[],this.offset=0,this.offsetStart=0,this.offsetEnd=0,this.distance=0,this.prevProgress=0,this.thresholds=["start","end","end","start"],this.coords=[0,0,0,0],this.debugStyles=null,this.$debug=null,this._params=e,this._debug=ze(e.debug,!1),this._next=null,this._prev=null,ve(this.container,this),Qt((()=>{if(!this.reverted){if(!this.target){const t=Re(e.target)[0];this.target=t||i.body,this.refresh()}this._debug&&this.debug()}}))}link(e){if(e&&(e.pause(),this.linked=e,!this._params.target)){let t;H(e.targets)?be(e,(e=>{e.targets&&!t&&(t=Rs(e))})):t=Rs(e),this.target=t||i.body,this.refresh()}return this}get velocity(){return this.container.velocity}get backward(){return this.horizontal?this.container.backwardX:this.container.backwardY}get scroll(){return this.horizontal?this.container.scrollX:this.container.scrollY}get progress(){const e=(this.scroll-this.offsetStart)/this.distance;return e===1/0||isNaN(e)?0:ue(ce(e,0,1),6)}refresh(){this.reverted=!1;const e=this._params;return this.repeat=ze(As(e.repeat,this),!0),this.horizontal="x"===ze(As(e.axis,this),"y"),this.enter=ze(As(e.enter,this),"end start"),this.leave=ze(As(e.leave,this),"start end"),this.updateBounds(),this.handleScroll(),this}removeDebug(){return this.$debug&&(this.$debug.parentNode.removeChild(this.$debug),this.$debug=null),this.debugStyles&&(this.debugStyles.revert(),this.$debug=null),this}debug(){this.removeDebug();const e=this.container,t=this.horizontal,s=e.element.querySelector(":scope > .animejs-onscroll-debug"),n=i.createElement("div"),r=i.createElement("div"),o=i.createElement("div"),a=Ls[this.index%Ls.length],l=e.useWin,c=l?e.winWidth:e.width,d=l?e.winHeight:e.height,u=e.scrollWidth,h=e.scrollHeight,p=this.container.width>360?320:260,g=t?0:10,m=t?10:0,f=t?24:p/2,y=t?f:15,b=t?60:f,_=t?b:y,v=t?"repeat-x":"repeat-y",w=e=>t?"0px "+e+"px":e+"px 2px",S=e=>`linear-gradient(${t?90:0}deg, ${e} 2px, transparent 1px)`,x=(e,t,s,n,r)=>`position:${e};left:${t}px;top:${s}px;width:${n}px;height:${r}px;`;n.style.cssText=`${x("absolute",g,m,t?u:p,t?p:h)}\n      pointer-events: none;\n      z-index: ${this.container.zIndex++};\n      display: flex;\n      flex-direction: ${t?"column":"row"};\n      filter: drop-shadow(0px 1px 0px rgba(0,0,0,.75));\n    `,r.style.cssText=`${x("sticky",0,0,t?c:f,t?f:d)}`,s||(r.style.cssText+=`background:\n        ${S("#FFFF")}${w(f-10)} / 100px 100px ${v},\n        ${S("#FFF8")}${w(f-10)} / 10px 10px ${v};\n      `),o.style.cssText=`${x("relative",0,0,t?u:f,t?f:h)}`,s||(o.style.cssText+=`background:\n        ${S("#FFFF")}${w(0)} / ${t?"100px 10px":"10px 100px"} ${v},\n        ${S("#FFF8")}${w(0)} / ${t?"10px 0px":"0px 10px"} ${v};\n      `);const $=[" enter: "," leave: "];this.coords.forEach(((e,s)=>{const n=s>1,l=(n?0:this.offset)+e,g=s%2,m=l<_,f=l>(n?t?c:d:t?u:h)-_,v=(n?g&&!m:!g&&!m)||f,w=i.createElement("div"),S=i.createElement("div"),C=t?v?"right":"left":v?"bottom":"top",k=v?(t?b:y)+(n?t?-1:f?0:-2:t?-1:-2):t?1:0;S.innerHTML=`${this.id}${$[g]}${this.thresholds[s]}`,w.style.cssText=`${x("absolute",0,0,b,y)}\n        display: flex;\n        flex-direction: ${t?"column":"row"};\n        justify-content: flex-${n?"start":"end"};\n        align-items: flex-${v?"end":"start"};\n        border-${C}: 2px solid ${a};\n      `,S.style.cssText=`\n        overflow: hidden;\n        max-width: ${p/2-10}px;\n        height: ${y};\n        margin-${t?v?"right":"left":v?"bottom":"top"}: -2px;\n        padding: 1px;\n        font-family: ui-monospace, monospace;\n        font-size: 10px;\n        letter-spacing: -.025em;\n        line-height: 9px;\n        font-weight: 600;\n        text-align: ${t&&v||!t&&!n?"right":"left"};\n        white-space: pre;\n        text-overflow: ellipsis;\n        color: ${g?a:"rgba(0,0,0,.75)"};\n        background-color: ${g?"rgba(0,0,0,.65)":a};\n        border: 2px solid ${g?a:"transparent"};\n        border-${t?v?"top-left":"top-right":v?"top-left":"bottom-left"}-radius: 5px;\n        border-${t?v?"bottom-left":"bottom-right":v?"top-right":"bottom-right"}-radius: 5px;\n      `,w.appendChild(S);let A=l-k+(t?1:0);w.style[t?"left":"top"]=`${A}px`,(n?r:o).appendChild(w)})),n.appendChild(r),n.appendChild(o),e.element.appendChild(n),s||n.classList.add("animejs-onscroll-debug"),this.$debug=n,"static"===es(e.element,"position")&&(this.debugStyles=ts(e.element,{position:"relative "}))}updateBounds(){let e;this._debug&&this.removeDebug();const t=this.target,s=this.container,n=this.horizontal,r=this.linked;let o,a=t,l=0,c=0,d=a;r&&(o=r.currentTime,r.seek(0,!0));const u="static"===es(s.element,"position")&&ts(s.element,{position:"relative "});for(;a&&a!==s.element&&a!==i.body;){const t="sticky"===es(a,"position")&&ts(a,{position:"static"});a===d&&(l+=a.offsetLeft||0,c+=a.offsetTop||0,d=a.offsetParent),a=a.parentElement,t&&(e||(e=[]),e.push(t))}u&&u.revert();const h=n?l:c,p=n?t.offsetWidth:t.offsetHeight,g=n?s.width:s.height,m=(n?s.scrollWidth:s.scrollHeight)-g,f=this.enter,y=this.leave;let b="start",_="end",v="end",w="start";if(z(f)){const e=f.split(" ");v=e[0],b=e.length>1?e[1]:b}else if(B(f)){const e=f;H(e.container)||(v=e.container),H(e.target)||(b=e.target)}else I(f)&&(v=f);if(z(y)){const e=y.split(" ");w=e[0],_=e.length>1?e[1]:_}else if(B(y)){const e=y;H(e.container)||(w=e.container),H(e.target)||(_=e.target)}else I(y)&&(w=y);const S=Ts(t,b,p),x=Ts(t,_,p),$=S+h-g,C=x+h-m,k=Ts(t,v,g,$,C),A=Ts(t,w,g,$,C),M=S+h-k,D=x+h-A,E=D-M;this.offsets[0]=l,this.offsets[1]=c,this.offset=h,this.offsetStart=M,this.offsetEnd=D,this.distance=E<=0?0:E,this.thresholds=[b,_,v,w],this.coords=[S,x,k,A],e&&e.forEach((e=>e.revert())),r&&r.seek(o,!0),this._debug&&this.debug()}handleScroll(){const e=this.linked,t=this.sync,s=this.syncEase,n=this.syncSmooth,r=e&&(s||n),i=this.horizontal,o=this.container,a=this.scroll,l=a<=this.offsetStart,c=a>=this.offsetEnd,d=!l&&!c,u=a===this.offsetStart||a===this.offsetEnd,h=!this.hasEntered&&u,p=this._debug&&this.$debug;let g=!1,m=!1,f=this.progress;if(l&&this.began&&(this.began=!1),f>0&&!this.began&&(this.began=!0),r){const t=e.progress;if(n&&I(n)){if(n<1){const e=t<f&&1===f?1e-4:t>f&&!f?-1e-4:0;f=ue(os(t,f,pe(.01,.2,n),!1)+e,6)}}else s&&(f=s(f));g=f!==this.prevProgress,m=1===t,g&&!m&&n&&t&&o.wakeTicker.restart()}if(p){const e=i?o.scrollY:o.scrollX;p.style[i?"top":"left"]=e+10+"px"}(d&&!this.isInView||h&&!this.forceEnter&&!this.hasEntered)&&(d&&(this.isInView=!0),this.forceEnter&&this.hasEntered?d&&(this.forceEnter=!1):(p&&d&&(p.style.zIndex=""+this.container.zIndex++),this.onSyncEnter(this),this.onEnter(this),this.backward?(this.onSyncEnterBackward(this),this.onEnterBackward(this)):(this.onSyncEnterForward(this),this.onEnterForward(this)),this.hasEntered=!0,h&&(this.forceEnter=!0))),(d||!d&&this.isInView)&&(g=!0),g&&(r&&e.seek(e.duration*f),this.onUpdate(this)),!d&&this.isInView&&(this.isInView=!1,this.onSyncLeave(this),this.onLeave(this),this.backward?(this.onSyncLeaveBackward(this),this.onLeaveBackward(this)):(this.onSyncLeaveForward(this),this.onLeaveForward(this)),t&&!n&&(m=!0)),f>=1&&this.began&&!this.completed&&(t&&m||!t)&&(t&&this.onSyncComplete(this),this.completed=!0,(!this.repeat&&!e||!this.repeat&&e&&e.completed)&&this.revert()),f<1&&this.completed&&(this.completed=!1),this.prevProgress=f}revert(){if(this.reverted)return;const e=this.container;return _e(e,this),e._head||e.revert(),this._debug&&this.removeDebug(),this.reverted=!0,this}}const Ns=(e={})=>new Ps(e),Fs=(e,t={})=>{let s=[],n=0;const r=t.from,i=t.reversed,o=t.ease,a=!H(o),l=a&&!H(o.ease)?o.ease:a?vt(o):null,c=t.grid,d=t.axis,u=H(r)||0===r||"first"===r,h="center"===r,p="last"===r,g=F(e),m=X(g?e[0]:e),y=g?X(e[1]):0,b=A.exec((g?e[1]:e)+f),_=t.start||0+(g?m:0);let v=u?0:I(r)?r:0;return(e,r,o,a)=>{if(h&&(v=(o-1)/2),p&&(v=o-1),!s.length){for(let e=0;e<o;e++){if(c){const t=h?(c[0]-1)/2:v%c[0],n=h?(c[1]-1)/2:ne(v/c[0]),r=t-e%c[0],i=n-ne(e/c[0]);let o=Z(r*r+i*i);"x"===d&&(o=-r),"y"===d&&(o=-i),s.push(o)}else s.push(ee(v-e));n=ie(...s)}l&&(s=s.map((e=>l(e/n)*n))),i&&(s=s.map((e=>d?e<0?-1*e:-e:ee(n-e))))}const u=g?(y-m)/n:m;let f=(a?ds(a,H(t.start)?a.iterationDuration:_):_)+(u*ue(s[r],2)||0);return t.modifier&&(f=t.modifier(f)),b&&(f=`${f}${b[2]}`),f}};var Bs=r(640),Is=r(191);function zs(e){return null==e}var js={isNothing:zs,isObject:function(e){return"object"==typeof e&&null!==e},toArray:function(e){return Array.isArray(e)?e:zs(e)?[]:[e]},repeat:function(e,t){var s,n="";for(s=0;s<t;s+=1)n+=e;return n},isNegativeZero:function(e){return 0===e&&Number.NEGATIVE_INFINITY===1/e},extend:function(e,t){var s,n,r,i;if(t)for(s=0,n=(i=Object.keys(t)).length;s<n;s+=1)e[r=i[s]]=t[r];return e}};function Hs(e,t){var s="",n=e.reason||"(unknown reason)";return e.mark?(e.mark.name&&(s+='in "'+e.mark.name+'" '),s+="("+(e.mark.line+1)+":"+(e.mark.column+1)+")",!t&&e.mark.snippet&&(s+="\n\n"+e.mark.snippet),n+" "+s):n}function Us(e,t){Error.call(this),this.name="YAMLException",this.reason=e,this.mark=t,this.message=Hs(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack||""}Us.prototype=Object.create(Error.prototype),Us.prototype.constructor=Us,Us.prototype.toString=function(e){return this.name+": "+Hs(this,e)};var Gs=Us;function Vs(e,t,s,n,r){var i="",o="",a=Math.floor(r/2)-1;return n-t>a&&(t=n-a+(i=" ... ").length),s-n>a&&(s=n+a-(o=" ...").length),{str:i+e.slice(t,s).replace(/\t/g,"→")+o,pos:n-t+i.length}}function qs(e,t){return js.repeat(" ",t-e.length)+e}var Ws=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],Ys=["scalar","sequence","mapping"],Xs=function(e,t){if(t=t||{},Object.keys(t).forEach((function(t){if(-1===Ws.indexOf(t))throw new Gs('Unknown option "'+t+'" is met in definition of "'+e+'" YAML type.')})),this.options=t,this.tag=e,this.kind=t.kind||null,this.resolve=t.resolve||function(){return!0},this.construct=t.construct||function(e){return e},this.instanceOf=t.instanceOf||null,this.predicate=t.predicate||null,this.represent=t.represent||null,this.representName=t.representName||null,this.defaultStyle=t.defaultStyle||null,this.multi=t.multi||!1,this.styleAliases=function(e){var t={};return null!==e&&Object.keys(e).forEach((function(s){e[s].forEach((function(e){t[String(e)]=s}))})),t}(t.styleAliases||null),-1===Ys.indexOf(this.kind))throw new Gs('Unknown kind "'+this.kind+'" is specified for "'+e+'" YAML type.')};function Js(e,t){var s=[];return e[t].forEach((function(e){var t=s.length;s.forEach((function(s,n){s.tag===e.tag&&s.kind===e.kind&&s.multi===e.multi&&(t=n)})),s[t]=e})),s}function Zs(e){return this.extend(e)}Zs.prototype.extend=function(e){var t=[],s=[];if(e instanceof Xs)s.push(e);else if(Array.isArray(e))s=s.concat(e);else{if(!e||!Array.isArray(e.implicit)&&!Array.isArray(e.explicit))throw new Gs("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");e.implicit&&(t=t.concat(e.implicit)),e.explicit&&(s=s.concat(e.explicit))}t.forEach((function(e){if(!(e instanceof Xs))throw new Gs("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(e.loadKind&&"scalar"!==e.loadKind)throw new Gs("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(e.multi)throw new Gs("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")})),s.forEach((function(e){if(!(e instanceof Xs))throw new Gs("Specified list of YAML types (or a single Type object) contains a non-Type object.")}));var n=Object.create(Zs.prototype);return n.implicit=(this.implicit||[]).concat(t),n.explicit=(this.explicit||[]).concat(s),n.compiledImplicit=Js(n,"implicit"),n.compiledExplicit=Js(n,"explicit"),n.compiledTypeMap=function(){var e,t,s={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}};function n(e){e.multi?(s.multi[e.kind].push(e),s.multi.fallback.push(e)):s[e.kind][e.tag]=s.fallback[e.tag]=e}for(e=0,t=arguments.length;e<t;e+=1)arguments[e].forEach(n);return s}(n.compiledImplicit,n.compiledExplicit),n};var Ks=Zs,Qs=new Xs("tag:yaml.org,2002:str",{kind:"scalar",construct:function(e){return null!==e?e:""}}),en=new Xs("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(e){return null!==e?e:[]}}),tn=new Xs("tag:yaml.org,2002:map",{kind:"mapping",construct:function(e){return null!==e?e:{}}}),sn=new Ks({explicit:[Qs,en,tn]}),nn=new Xs("tag:yaml.org,2002:null",{kind:"scalar",resolve:function(e){if(null===e)return!0;var t=e.length;return 1===t&&"~"===e||4===t&&("null"===e||"Null"===e||"NULL"===e)},construct:function(){return null},predicate:function(e){return null===e},represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"}),rn=new Xs("tag:yaml.org,2002:bool",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t=e.length;return 4===t&&("true"===e||"True"===e||"TRUE"===e)||5===t&&("false"===e||"False"===e||"FALSE"===e)},construct:function(e){return"true"===e||"True"===e||"TRUE"===e},predicate:function(e){return"[object Boolean]"===Object.prototype.toString.call(e)},represent:{lowercase:function(e){return e?"true":"false"},uppercase:function(e){return e?"TRUE":"FALSE"},camelcase:function(e){return e?"True":"False"}},defaultStyle:"lowercase"});function on(e){return 48<=e&&e<=57||65<=e&&e<=70||97<=e&&e<=102}function an(e){return 48<=e&&e<=55}function ln(e){return 48<=e&&e<=57}var cn=new Xs("tag:yaml.org,2002:int",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t,s=e.length,n=0,r=!1;if(!s)return!1;if("-"!==(t=e[n])&&"+"!==t||(t=e[++n]),"0"===t){if(n+1===s)return!0;if("b"===(t=e[++n])){for(n++;n<s;n++)if("_"!==(t=e[n])){if("0"!==t&&"1"!==t)return!1;r=!0}return r&&"_"!==t}if("x"===t){for(n++;n<s;n++)if("_"!==(t=e[n])){if(!on(e.charCodeAt(n)))return!1;r=!0}return r&&"_"!==t}if("o"===t){for(n++;n<s;n++)if("_"!==(t=e[n])){if(!an(e.charCodeAt(n)))return!1;r=!0}return r&&"_"!==t}}if("_"===t)return!1;for(;n<s;n++)if("_"!==(t=e[n])){if(!ln(e.charCodeAt(n)))return!1;r=!0}return!(!r||"_"===t)},construct:function(e){var t,s=e,n=1;if(-1!==s.indexOf("_")&&(s=s.replace(/_/g,"")),"-"!==(t=s[0])&&"+"!==t||("-"===t&&(n=-1),t=(s=s.slice(1))[0]),"0"===s)return 0;if("0"===t){if("b"===s[1])return n*parseInt(s.slice(2),2);if("x"===s[1])return n*parseInt(s.slice(2),16);if("o"===s[1])return n*parseInt(s.slice(2),8)}return n*parseInt(s,10)},predicate:function(e){return"[object Number]"===Object.prototype.toString.call(e)&&e%1==0&&!js.isNegativeZero(e)},represent:{binary:function(e){return e>=0?"0b"+e.toString(2):"-0b"+e.toString(2).slice(1)},octal:function(e){return e>=0?"0o"+e.toString(8):"-0o"+e.toString(8).slice(1)},decimal:function(e){return e.toString(10)},hexadecimal:function(e){return e>=0?"0x"+e.toString(16).toUpperCase():"-0x"+e.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),dn=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$"),un=/^[-+]?[0-9]+e/,hn=new Xs("tag:yaml.org,2002:float",{kind:"scalar",resolve:function(e){return null!==e&&!(!dn.test(e)||"_"===e[e.length-1])},construct:function(e){var t,s;return s="-"===(t=e.replace(/_/g,"").toLowerCase())[0]?-1:1,"+-".indexOf(t[0])>=0&&(t=t.slice(1)),".inf"===t?1===s?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:".nan"===t?NaN:s*parseFloat(t,10)},predicate:function(e){return"[object Number]"===Object.prototype.toString.call(e)&&(e%1!=0||js.isNegativeZero(e))},represent:function(e,t){var s;if(isNaN(e))switch(t){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===e)switch(t){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===e)switch(t){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(js.isNegativeZero(e))return"-0.0";return s=e.toString(10),un.test(s)?s.replace("e",".e"):s},defaultStyle:"lowercase"}),pn=sn.extend({implicit:[nn,rn,cn,hn]}),gn=pn,mn=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),fn=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$"),yn=new Xs("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:function(e){return null!==e&&(null!==mn.exec(e)||null!==fn.exec(e))},construct:function(e){var t,s,n,r,i,o,a,l,c=0,d=null;if(null===(t=mn.exec(e))&&(t=fn.exec(e)),null===t)throw new Error("Date resolve error");if(s=+t[1],n=+t[2]-1,r=+t[3],!t[4])return new Date(Date.UTC(s,n,r));if(i=+t[4],o=+t[5],a=+t[6],t[7]){for(c=t[7].slice(0,3);c.length<3;)c+="0";c=+c}return t[9]&&(d=6e4*(60*+t[10]+ +(t[11]||0)),"-"===t[9]&&(d=-d)),l=new Date(Date.UTC(s,n,r,i,o,a,c)),d&&l.setTime(l.getTime()-d),l},instanceOf:Date,represent:function(e){return e.toISOString()}}),bn=new Xs("tag:yaml.org,2002:merge",{kind:"scalar",resolve:function(e){return"<<"===e||null===e}}),_n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\n\r",vn=new Xs("tag:yaml.org,2002:binary",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t,s,n=0,r=e.length,i=_n;for(s=0;s<r;s++)if(!((t=i.indexOf(e.charAt(s)))>64)){if(t<0)return!1;n+=6}return n%8==0},construct:function(e){var t,s,n=e.replace(/[\r\n=]/g,""),r=n.length,i=_n,o=0,a=[];for(t=0;t<r;t++)t%4==0&&t&&(a.push(o>>16&255),a.push(o>>8&255),a.push(255&o)),o=o<<6|i.indexOf(n.charAt(t));return 0==(s=r%4*6)?(a.push(o>>16&255),a.push(o>>8&255),a.push(255&o)):18===s?(a.push(o>>10&255),a.push(o>>2&255)):12===s&&a.push(o>>4&255),new Uint8Array(a)},predicate:function(e){return"[object Uint8Array]"===Object.prototype.toString.call(e)},represent:function(e){var t,s,n="",r=0,i=e.length,o=_n;for(t=0;t<i;t++)t%3==0&&t&&(n+=o[r>>18&63],n+=o[r>>12&63],n+=o[r>>6&63],n+=o[63&r]),r=(r<<8)+e[t];return 0==(s=i%3)?(n+=o[r>>18&63],n+=o[r>>12&63],n+=o[r>>6&63],n+=o[63&r]):2===s?(n+=o[r>>10&63],n+=o[r>>4&63],n+=o[r<<2&63],n+=o[64]):1===s&&(n+=o[r>>2&63],n+=o[r<<4&63],n+=o[64],n+=o[64]),n}}),wn=Object.prototype.hasOwnProperty,Sn=Object.prototype.toString,xn=new Xs("tag:yaml.org,2002:omap",{kind:"sequence",resolve:function(e){if(null===e)return!0;var t,s,n,r,i,o=[],a=e;for(t=0,s=a.length;t<s;t+=1){if(n=a[t],i=!1,"[object Object]"!==Sn.call(n))return!1;for(r in n)if(wn.call(n,r)){if(i)return!1;i=!0}if(!i)return!1;if(-1!==o.indexOf(r))return!1;o.push(r)}return!0},construct:function(e){return null!==e?e:[]}}),$n=Object.prototype.toString,Cn=new Xs("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:function(e){if(null===e)return!0;var t,s,n,r,i,o=e;for(i=new Array(o.length),t=0,s=o.length;t<s;t+=1){if(n=o[t],"[object Object]"!==$n.call(n))return!1;if(1!==(r=Object.keys(n)).length)return!1;i[t]=[r[0],n[r[0]]]}return!0},construct:function(e){if(null===e)return[];var t,s,n,r,i,o=e;for(i=new Array(o.length),t=0,s=o.length;t<s;t+=1)n=o[t],r=Object.keys(n),i[t]=[r[0],n[r[0]]];return i}}),kn=Object.prototype.hasOwnProperty,An=new Xs("tag:yaml.org,2002:set",{kind:"mapping",resolve:function(e){if(null===e)return!0;var t,s=e;for(t in s)if(kn.call(s,t)&&null!==s[t])return!1;return!0},construct:function(e){return null!==e?e:{}}}),Mn=gn.extend({implicit:[yn,bn],explicit:[vn,xn,Cn,An]}),Dn=Object.prototype.hasOwnProperty,En=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,Tn=/[\x85\u2028\u2029]/,Rn=/[,\[\]\{\}]/,On=/^(?:!|!!|![a-z\-]+!)$/i,Ln=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function Pn(e){return Object.prototype.toString.call(e)}function Nn(e){return 10===e||13===e}function Fn(e){return 9===e||32===e}function Bn(e){return 9===e||32===e||10===e||13===e}function In(e){return 44===e||91===e||93===e||123===e||125===e}function zn(e){var t;return 48<=e&&e<=57?e-48:97<=(t=32|e)&&t<=102?t-97+10:-1}function jn(e){return 120===e?2:117===e?4:85===e?8:0}function Hn(e){return 48<=e&&e<=57?e-48:-1}function Un(e){return 48===e?"\0":97===e?"":98===e?"\b":116===e||9===e?"\t":110===e?"\n":118===e?"\v":102===e?"\f":114===e?"\r":101===e?"":32===e?" ":34===e?'"':47===e?"/":92===e?"\\":78===e?"":95===e?" ":76===e?"\u2028":80===e?"\u2029":""}function Gn(e){return e<=65535?String.fromCharCode(e):String.fromCharCode(55296+(e-65536>>10),56320+(e-65536&1023))}for(var Vn=new Array(256),qn=new Array(256),Wn=0;Wn<256;Wn++)Vn[Wn]=Un(Wn)?1:0,qn[Wn]=Un(Wn);function Yn(e,t){this.input=e,this.filename=t.filename||null,this.schema=t.schema||Mn,this.onWarning=t.onWarning||null,this.legacy=t.legacy||!1,this.json=t.json||!1,this.listener=t.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=e.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function Xn(e,t){var s={name:e.filename,buffer:e.input.slice(0,-1),position:e.position,line:e.line,column:e.position-e.lineStart};return s.snippet=function(e,t){if(t=Object.create(t||null),!e.buffer)return null;t.maxLength||(t.maxLength=79),"number"!=typeof t.indent&&(t.indent=1),"number"!=typeof t.linesBefore&&(t.linesBefore=3),"number"!=typeof t.linesAfter&&(t.linesAfter=2);for(var s,n=/\r?\n|\r|\0/g,r=[0],i=[],o=-1;s=n.exec(e.buffer);)i.push(s.index),r.push(s.index+s[0].length),e.position<=s.index&&o<0&&(o=r.length-2);o<0&&(o=r.length-1);var a,l,c="",d=Math.min(e.line+t.linesAfter,i.length).toString().length,u=t.maxLength-(t.indent+d+3);for(a=1;a<=t.linesBefore&&!(o-a<0);a++)l=Vs(e.buffer,r[o-a],i[o-a],e.position-(r[o]-r[o-a]),u),c=js.repeat(" ",t.indent)+qs((e.line-a+1).toString(),d)+" | "+l.str+"\n"+c;for(l=Vs(e.buffer,r[o],i[o],e.position,u),c+=js.repeat(" ",t.indent)+qs((e.line+1).toString(),d)+" | "+l.str+"\n",c+=js.repeat("-",t.indent+d+3+l.pos)+"^\n",a=1;a<=t.linesAfter&&!(o+a>=i.length);a++)l=Vs(e.buffer,r[o+a],i[o+a],e.position-(r[o]-r[o+a]),u),c+=js.repeat(" ",t.indent)+qs((e.line+a+1).toString(),d)+" | "+l.str+"\n";return c.replace(/\n$/,"")}(s),new Gs(t,s)}function Jn(e,t){throw Xn(e,t)}function Zn(e,t){e.onWarning&&e.onWarning.call(null,Xn(e,t))}var Kn={YAML:function(e,t,s){var n,r,i;null!==e.version&&Jn(e,"duplication of %YAML directive"),1!==s.length&&Jn(e,"YAML directive accepts exactly one argument"),null===(n=/^([0-9]+)\.([0-9]+)$/.exec(s[0]))&&Jn(e,"ill-formed argument of the YAML directive"),r=parseInt(n[1],10),i=parseInt(n[2],10),1!==r&&Jn(e,"unacceptable YAML version of the document"),e.version=s[0],e.checkLineBreaks=i<2,1!==i&&2!==i&&Zn(e,"unsupported YAML version of the document")},TAG:function(e,t,s){var n,r;2!==s.length&&Jn(e,"TAG directive accepts exactly two arguments"),n=s[0],r=s[1],On.test(n)||Jn(e,"ill-formed tag handle (first argument) of the TAG directive"),Dn.call(e.tagMap,n)&&Jn(e,'there is a previously declared suffix for "'+n+'" tag handle'),Ln.test(r)||Jn(e,"ill-formed tag prefix (second argument) of the TAG directive");try{r=decodeURIComponent(r)}catch(t){Jn(e,"tag prefix is malformed: "+r)}e.tagMap[n]=r}};function Qn(e,t,s,n){var r,i,o,a;if(t<s){if(a=e.input.slice(t,s),n)for(r=0,i=a.length;r<i;r+=1)9===(o=a.charCodeAt(r))||32<=o&&o<=1114111||Jn(e,"expected valid JSON character");else En.test(a)&&Jn(e,"the stream contains non-printable characters");e.result+=a}}function er(e,t,s,n){var r,i,o,a;for(js.isObject(s)||Jn(e,"cannot merge mappings; the provided source object is unacceptable"),o=0,a=(r=Object.keys(s)).length;o<a;o+=1)i=r[o],Dn.call(t,i)||(t[i]=s[i],n[i]=!0)}function tr(e,t,s,n,r,i,o,a,l){var c,d;if(Array.isArray(r))for(c=0,d=(r=Array.prototype.slice.call(r)).length;c<d;c+=1)Array.isArray(r[c])&&Jn(e,"nested arrays are not supported inside keys"),"object"==typeof r&&"[object Object]"===Pn(r[c])&&(r[c]="[object Object]");if("object"==typeof r&&"[object Object]"===Pn(r)&&(r="[object Object]"),r=String(r),null===t&&(t={}),"tag:yaml.org,2002:merge"===n)if(Array.isArray(i))for(c=0,d=i.length;c<d;c+=1)er(e,t,i[c],s);else er(e,t,i,s);else e.json||Dn.call(s,r)||!Dn.call(t,r)||(e.line=o||e.line,e.lineStart=a||e.lineStart,e.position=l||e.position,Jn(e,"duplicated mapping key")),"__proto__"===r?Object.defineProperty(t,r,{configurable:!0,enumerable:!0,writable:!0,value:i}):t[r]=i,delete s[r];return t}function sr(e){var t;10===(t=e.input.charCodeAt(e.position))?e.position++:13===t?(e.position++,10===e.input.charCodeAt(e.position)&&e.position++):Jn(e,"a line break is expected"),e.line+=1,e.lineStart=e.position,e.firstTabInLine=-1}function nr(e,t,s){for(var n=0,r=e.input.charCodeAt(e.position);0!==r;){for(;Fn(r);)9===r&&-1===e.firstTabInLine&&(e.firstTabInLine=e.position),r=e.input.charCodeAt(++e.position);if(t&&35===r)do{r=e.input.charCodeAt(++e.position)}while(10!==r&&13!==r&&0!==r);if(!Nn(r))break;for(sr(e),r=e.input.charCodeAt(e.position),n++,e.lineIndent=0;32===r;)e.lineIndent++,r=e.input.charCodeAt(++e.position)}return-1!==s&&0!==n&&e.lineIndent<s&&Zn(e,"deficient indentation"),n}function rr(e){var t,s=e.position;return!(45!==(t=e.input.charCodeAt(s))&&46!==t||t!==e.input.charCodeAt(s+1)||t!==e.input.charCodeAt(s+2)||(s+=3,0!==(t=e.input.charCodeAt(s))&&!Bn(t)))}function ir(e,t){1===t?e.result+=" ":t>1&&(e.result+=js.repeat("\n",t-1))}function or(e,t){var s,n,r=e.tag,i=e.anchor,o=[],a=!1;if(-1!==e.firstTabInLine)return!1;for(null!==e.anchor&&(e.anchorMap[e.anchor]=o),n=e.input.charCodeAt(e.position);0!==n&&(-1!==e.firstTabInLine&&(e.position=e.firstTabInLine,Jn(e,"tab characters must not be used in indentation")),45===n)&&Bn(e.input.charCodeAt(e.position+1));)if(a=!0,e.position++,nr(e,!0,-1)&&e.lineIndent<=t)o.push(null),n=e.input.charCodeAt(e.position);else if(s=e.line,cr(e,t,3,!1,!0),o.push(e.result),nr(e,!0,-1),n=e.input.charCodeAt(e.position),(e.line===s||e.lineIndent>t)&&0!==n)Jn(e,"bad indentation of a sequence entry");else if(e.lineIndent<t)break;return!!a&&(e.tag=r,e.anchor=i,e.kind="sequence",e.result=o,!0)}function ar(e){var t,s,n,r,i=!1,o=!1;if(33!==(r=e.input.charCodeAt(e.position)))return!1;if(null!==e.tag&&Jn(e,"duplication of a tag property"),60===(r=e.input.charCodeAt(++e.position))?(i=!0,r=e.input.charCodeAt(++e.position)):33===r?(o=!0,s="!!",r=e.input.charCodeAt(++e.position)):s="!",t=e.position,i){do{r=e.input.charCodeAt(++e.position)}while(0!==r&&62!==r);e.position<e.length?(n=e.input.slice(t,e.position),r=e.input.charCodeAt(++e.position)):Jn(e,"unexpected end of the stream within a verbatim tag")}else{for(;0!==r&&!Bn(r);)33===r&&(o?Jn(e,"tag suffix cannot contain exclamation marks"):(s=e.input.slice(t-1,e.position+1),On.test(s)||Jn(e,"named tag handle cannot contain such characters"),o=!0,t=e.position+1)),r=e.input.charCodeAt(++e.position);n=e.input.slice(t,e.position),Rn.test(n)&&Jn(e,"tag suffix cannot contain flow indicator characters")}n&&!Ln.test(n)&&Jn(e,"tag name cannot contain such characters: "+n);try{n=decodeURIComponent(n)}catch(t){Jn(e,"tag name is malformed: "+n)}return i?e.tag=n:Dn.call(e.tagMap,s)?e.tag=e.tagMap[s]+n:"!"===s?e.tag="!"+n:"!!"===s?e.tag="tag:yaml.org,2002:"+n:Jn(e,'undeclared tag handle "'+s+'"'),!0}function lr(e){var t,s;if(38!==(s=e.input.charCodeAt(e.position)))return!1;for(null!==e.anchor&&Jn(e,"duplication of an anchor property"),s=e.input.charCodeAt(++e.position),t=e.position;0!==s&&!Bn(s)&&!In(s);)s=e.input.charCodeAt(++e.position);return e.position===t&&Jn(e,"name of an anchor node must contain at least one character"),e.anchor=e.input.slice(t,e.position),!0}function cr(e,t,s,n,r){var i,o,a,l,c,d,u,h,p,g=1,m=!1,f=!1;if(null!==e.listener&&e.listener("open",e),e.tag=null,e.anchor=null,e.kind=null,e.result=null,i=o=a=4===s||3===s,n&&nr(e,!0,-1)&&(m=!0,e.lineIndent>t?g=1:e.lineIndent===t?g=0:e.lineIndent<t&&(g=-1)),1===g)for(;ar(e)||lr(e);)nr(e,!0,-1)?(m=!0,a=i,e.lineIndent>t?g=1:e.lineIndent===t?g=0:e.lineIndent<t&&(g=-1)):a=!1;if(a&&(a=m||r),1!==g&&4!==s||(h=1===s||2===s?t:t+1,p=e.position-e.lineStart,1===g?a&&(or(e,p)||function(e,t,s){var n,r,i,o,a,l,c,d=e.tag,u=e.anchor,h={},p=Object.create(null),g=null,m=null,f=null,y=!1,b=!1;if(-1!==e.firstTabInLine)return!1;for(null!==e.anchor&&(e.anchorMap[e.anchor]=h),c=e.input.charCodeAt(e.position);0!==c;){if(y||-1===e.firstTabInLine||(e.position=e.firstTabInLine,Jn(e,"tab characters must not be used in indentation")),n=e.input.charCodeAt(e.position+1),i=e.line,63!==c&&58!==c||!Bn(n)){if(o=e.line,a=e.lineStart,l=e.position,!cr(e,s,2,!1,!0))break;if(e.line===i){for(c=e.input.charCodeAt(e.position);Fn(c);)c=e.input.charCodeAt(++e.position);if(58===c)Bn(c=e.input.charCodeAt(++e.position))||Jn(e,"a whitespace character is expected after the key-value separator within a block mapping"),y&&(tr(e,h,p,g,m,null,o,a,l),g=m=f=null),b=!0,y=!1,r=!1,g=e.tag,m=e.result;else{if(!b)return e.tag=d,e.anchor=u,!0;Jn(e,"can not read an implicit mapping pair; a colon is missed")}}else{if(!b)return e.tag=d,e.anchor=u,!0;Jn(e,"can not read a block mapping entry; a multiline key may not be an implicit key")}}else 63===c?(y&&(tr(e,h,p,g,m,null,o,a,l),g=m=f=null),b=!0,y=!0,r=!0):y?(y=!1,r=!0):Jn(e,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),e.position+=1,c=n;if((e.line===i||e.lineIndent>t)&&(y&&(o=e.line,a=e.lineStart,l=e.position),cr(e,t,4,!0,r)&&(y?m=e.result:f=e.result),y||(tr(e,h,p,g,m,f,o,a,l),g=m=f=null),nr(e,!0,-1),c=e.input.charCodeAt(e.position)),(e.line===i||e.lineIndent>t)&&0!==c)Jn(e,"bad indentation of a mapping entry");else if(e.lineIndent<t)break}return y&&tr(e,h,p,g,m,null,o,a,l),b&&(e.tag=d,e.anchor=u,e.kind="mapping",e.result=h),b}(e,p,h))||function(e,t){var s,n,r,i,o,a,l,c,d,u,h,p,g=!0,m=e.tag,f=e.anchor,y=Object.create(null);if(91===(p=e.input.charCodeAt(e.position)))o=93,c=!1,i=[];else{if(123!==p)return!1;o=125,c=!0,i={}}for(null!==e.anchor&&(e.anchorMap[e.anchor]=i),p=e.input.charCodeAt(++e.position);0!==p;){if(nr(e,!0,t),(p=e.input.charCodeAt(e.position))===o)return e.position++,e.tag=m,e.anchor=f,e.kind=c?"mapping":"sequence",e.result=i,!0;g?44===p&&Jn(e,"expected the node content, but found ','"):Jn(e,"missed comma between flow collection entries"),h=null,a=l=!1,63===p&&Bn(e.input.charCodeAt(e.position+1))&&(a=l=!0,e.position++,nr(e,!0,t)),s=e.line,n=e.lineStart,r=e.position,cr(e,t,1,!1,!0),u=e.tag,d=e.result,nr(e,!0,t),p=e.input.charCodeAt(e.position),!l&&e.line!==s||58!==p||(a=!0,p=e.input.charCodeAt(++e.position),nr(e,!0,t),cr(e,t,1,!1,!0),h=e.result),c?tr(e,i,y,u,d,h,s,n,r):a?i.push(tr(e,null,y,u,d,h,s,n,r)):i.push(d),nr(e,!0,t),44===(p=e.input.charCodeAt(e.position))?(g=!0,p=e.input.charCodeAt(++e.position)):g=!1}Jn(e,"unexpected end of the stream within a flow collection")}(e,h)?f=!0:(o&&function(e,t){var s,n,r,i,o=1,a=!1,l=!1,c=t,d=0,u=!1;if(124===(i=e.input.charCodeAt(e.position)))n=!1;else{if(62!==i)return!1;n=!0}for(e.kind="scalar",e.result="";0!==i;)if(43===(i=e.input.charCodeAt(++e.position))||45===i)1===o?o=43===i?3:2:Jn(e,"repeat of a chomping mode identifier");else{if(!((r=Hn(i))>=0))break;0===r?Jn(e,"bad explicit indentation width of a block scalar; it cannot be less than one"):l?Jn(e,"repeat of an indentation width identifier"):(c=t+r-1,l=!0)}if(Fn(i)){do{i=e.input.charCodeAt(++e.position)}while(Fn(i));if(35===i)do{i=e.input.charCodeAt(++e.position)}while(!Nn(i)&&0!==i)}for(;0!==i;){for(sr(e),e.lineIndent=0,i=e.input.charCodeAt(e.position);(!l||e.lineIndent<c)&&32===i;)e.lineIndent++,i=e.input.charCodeAt(++e.position);if(!l&&e.lineIndent>c&&(c=e.lineIndent),Nn(i))d++;else{if(e.lineIndent<c){3===o?e.result+=js.repeat("\n",a?1+d:d):1===o&&a&&(e.result+="\n");break}for(n?Fn(i)?(u=!0,e.result+=js.repeat("\n",a?1+d:d)):u?(u=!1,e.result+=js.repeat("\n",d+1)):0===d?a&&(e.result+=" "):e.result+=js.repeat("\n",d):e.result+=js.repeat("\n",a?1+d:d),a=!0,l=!0,d=0,s=e.position;!Nn(i)&&0!==i;)i=e.input.charCodeAt(++e.position);Qn(e,s,e.position,!1)}}return!0}(e,h)||function(e,t){var s,n,r;if(39!==(s=e.input.charCodeAt(e.position)))return!1;for(e.kind="scalar",e.result="",e.position++,n=r=e.position;0!==(s=e.input.charCodeAt(e.position));)if(39===s){if(Qn(e,n,e.position,!0),39!==(s=e.input.charCodeAt(++e.position)))return!0;n=e.position,e.position++,r=e.position}else Nn(s)?(Qn(e,n,r,!0),ir(e,nr(e,!1,t)),n=r=e.position):e.position===e.lineStart&&rr(e)?Jn(e,"unexpected end of the document within a single quoted scalar"):(e.position++,r=e.position);Jn(e,"unexpected end of the stream within a single quoted scalar")}(e,h)||function(e,t){var s,n,r,i,o,a;if(34!==(a=e.input.charCodeAt(e.position)))return!1;for(e.kind="scalar",e.result="",e.position++,s=n=e.position;0!==(a=e.input.charCodeAt(e.position));){if(34===a)return Qn(e,s,e.position,!0),e.position++,!0;if(92===a){if(Qn(e,s,e.position,!0),Nn(a=e.input.charCodeAt(++e.position)))nr(e,!1,t);else if(a<256&&Vn[a])e.result+=qn[a],e.position++;else if((o=jn(a))>0){for(r=o,i=0;r>0;r--)(o=zn(a=e.input.charCodeAt(++e.position)))>=0?i=(i<<4)+o:Jn(e,"expected hexadecimal character");e.result+=Gn(i),e.position++}else Jn(e,"unknown escape sequence");s=n=e.position}else Nn(a)?(Qn(e,s,n,!0),ir(e,nr(e,!1,t)),s=n=e.position):e.position===e.lineStart&&rr(e)?Jn(e,"unexpected end of the document within a double quoted scalar"):(e.position++,n=e.position)}Jn(e,"unexpected end of the stream within a double quoted scalar")}(e,h)?f=!0:function(e){var t,s,n;if(42!==(n=e.input.charCodeAt(e.position)))return!1;for(n=e.input.charCodeAt(++e.position),t=e.position;0!==n&&!Bn(n)&&!In(n);)n=e.input.charCodeAt(++e.position);return e.position===t&&Jn(e,"name of an alias node must contain at least one character"),s=e.input.slice(t,e.position),Dn.call(e.anchorMap,s)||Jn(e,'unidentified alias "'+s+'"'),e.result=e.anchorMap[s],nr(e,!0,-1),!0}(e)?(f=!0,null===e.tag&&null===e.anchor||Jn(e,"alias node should not have any properties")):function(e,t,s){var n,r,i,o,a,l,c,d,u=e.kind,h=e.result;if(Bn(d=e.input.charCodeAt(e.position))||In(d)||35===d||38===d||42===d||33===d||124===d||62===d||39===d||34===d||37===d||64===d||96===d)return!1;if((63===d||45===d)&&(Bn(n=e.input.charCodeAt(e.position+1))||s&&In(n)))return!1;for(e.kind="scalar",e.result="",r=i=e.position,o=!1;0!==d;){if(58===d){if(Bn(n=e.input.charCodeAt(e.position+1))||s&&In(n))break}else if(35===d){if(Bn(e.input.charCodeAt(e.position-1)))break}else{if(e.position===e.lineStart&&rr(e)||s&&In(d))break;if(Nn(d)){if(a=e.line,l=e.lineStart,c=e.lineIndent,nr(e,!1,-1),e.lineIndent>=t){o=!0,d=e.input.charCodeAt(e.position);continue}e.position=i,e.line=a,e.lineStart=l,e.lineIndent=c;break}}o&&(Qn(e,r,i,!1),ir(e,e.line-a),r=i=e.position,o=!1),Fn(d)||(i=e.position+1),d=e.input.charCodeAt(++e.position)}return Qn(e,r,i,!1),!!e.result||(e.kind=u,e.result=h,!1)}(e,h,1===s)&&(f=!0,null===e.tag&&(e.tag="?")),null!==e.anchor&&(e.anchorMap[e.anchor]=e.result)):0===g&&(f=a&&or(e,p))),null===e.tag)null!==e.anchor&&(e.anchorMap[e.anchor]=e.result);else if("?"===e.tag){for(null!==e.result&&"scalar"!==e.kind&&Jn(e,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+e.kind+'"'),l=0,c=e.implicitTypes.length;l<c;l+=1)if((u=e.implicitTypes[l]).resolve(e.result)){e.result=u.construct(e.result),e.tag=u.tag,null!==e.anchor&&(e.anchorMap[e.anchor]=e.result);break}}else if("!"!==e.tag){if(Dn.call(e.typeMap[e.kind||"fallback"],e.tag))u=e.typeMap[e.kind||"fallback"][e.tag];else for(u=null,l=0,c=(d=e.typeMap.multi[e.kind||"fallback"]).length;l<c;l+=1)if(e.tag.slice(0,d[l].tag.length)===d[l].tag){u=d[l];break}u||Jn(e,"unknown tag !<"+e.tag+">"),null!==e.result&&u.kind!==e.kind&&Jn(e,"unacceptable node kind for !<"+e.tag+'> tag; it should be "'+u.kind+'", not "'+e.kind+'"'),u.resolve(e.result,e.tag)?(e.result=u.construct(e.result,e.tag),null!==e.anchor&&(e.anchorMap[e.anchor]=e.result)):Jn(e,"cannot resolve a node with !<"+e.tag+"> explicit tag")}return null!==e.listener&&e.listener("close",e),null!==e.tag||null!==e.anchor||f}function dr(e){var t,s,n,r,i=e.position,o=!1;for(e.version=null,e.checkLineBreaks=e.legacy,e.tagMap=Object.create(null),e.anchorMap=Object.create(null);0!==(r=e.input.charCodeAt(e.position))&&(nr(e,!0,-1),r=e.input.charCodeAt(e.position),!(e.lineIndent>0||37!==r));){for(o=!0,r=e.input.charCodeAt(++e.position),t=e.position;0!==r&&!Bn(r);)r=e.input.charCodeAt(++e.position);for(n=[],(s=e.input.slice(t,e.position)).length<1&&Jn(e,"directive name must not be less than one character in length");0!==r;){for(;Fn(r);)r=e.input.charCodeAt(++e.position);if(35===r){do{r=e.input.charCodeAt(++e.position)}while(0!==r&&!Nn(r));break}if(Nn(r))break;for(t=e.position;0!==r&&!Bn(r);)r=e.input.charCodeAt(++e.position);n.push(e.input.slice(t,e.position))}0!==r&&sr(e),Dn.call(Kn,s)?Kn[s](e,s,n):Zn(e,'unknown document directive "'+s+'"')}nr(e,!0,-1),0===e.lineIndent&&45===e.input.charCodeAt(e.position)&&45===e.input.charCodeAt(e.position+1)&&45===e.input.charCodeAt(e.position+2)?(e.position+=3,nr(e,!0,-1)):o&&Jn(e,"directives end mark is expected"),cr(e,e.lineIndent-1,4,!1,!0),nr(e,!0,-1),e.checkLineBreaks&&Tn.test(e.input.slice(i,e.position))&&Zn(e,"non-ASCII line breaks are interpreted as content"),e.documents.push(e.result),e.position===e.lineStart&&rr(e)?46===e.input.charCodeAt(e.position)&&(e.position+=3,nr(e,!0,-1)):e.position<e.length-1&&Jn(e,"end of the stream or a document separator is expected")}function ur(e,t){t=t||{},0!==(e=String(e)).length&&(10!==e.charCodeAt(e.length-1)&&13!==e.charCodeAt(e.length-1)&&(e+="\n"),65279===e.charCodeAt(0)&&(e=e.slice(1)));var s=new Yn(e,t),n=e.indexOf("\0");for(-1!==n&&(s.position=n,Jn(s,"null byte is not allowed in input")),s.input+="\0";32===s.input.charCodeAt(s.position);)s.lineIndent+=1,s.position+=1;for(;s.position<s.length-1;)dr(s);return s.documents}var hr={loadAll:function(e,t,s){null!==t&&"object"==typeof t&&void 0===s&&(s=t,t=null);var n=ur(e,s);if("function"!=typeof t)return n;for(var r=0,i=n.length;r<i;r+=1)t(n[r])},load:function(e,t){var s=ur(e,t);if(0!==s.length){if(1===s.length)return s[0];throw new Gs("expected a single document in the stream, but found more")}}},pr=Object.prototype.toString,gr=Object.prototype.hasOwnProperty,mr=65279,fr={0:"\\0",7:"\\a",8:"\\b",9:"\\t",10:"\\n",11:"\\v",12:"\\f",13:"\\r",27:"\\e",34:'\\"',92:"\\\\",133:"\\N",160:"\\_",8232:"\\L",8233:"\\P"},yr=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],br=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function _r(e){var t,s,n;if(t=e.toString(16).toUpperCase(),e<=255)s="x",n=2;else if(e<=65535)s="u",n=4;else{if(!(e<=4294967295))throw new Gs("code point within a string may not be greater than 0xFFFFFFFF");s="U",n=8}return"\\"+s+js.repeat("0",n-t.length)+t}function vr(e){this.schema=e.schema||Mn,this.indent=Math.max(1,e.indent||2),this.noArrayIndent=e.noArrayIndent||!1,this.skipInvalid=e.skipInvalid||!1,this.flowLevel=js.isNothing(e.flowLevel)?-1:e.flowLevel,this.styleMap=function(e,t){var s,n,r,i,o,a,l;if(null===t)return{};for(s={},r=0,i=(n=Object.keys(t)).length;r<i;r+=1)o=n[r],a=String(t[o]),"!!"===o.slice(0,2)&&(o="tag:yaml.org,2002:"+o.slice(2)),(l=e.compiledTypeMap.fallback[o])&&gr.call(l.styleAliases,a)&&(a=l.styleAliases[a]),s[o]=a;return s}(this.schema,e.styles||null),this.sortKeys=e.sortKeys||!1,this.lineWidth=e.lineWidth||80,this.noRefs=e.noRefs||!1,this.noCompatMode=e.noCompatMode||!1,this.condenseFlow=e.condenseFlow||!1,this.quotingType='"'===e.quotingType?2:1,this.forceQuotes=e.forceQuotes||!1,this.replacer="function"==typeof e.replacer?e.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function wr(e,t){for(var s,n=js.repeat(" ",t),r=0,i=-1,o="",a=e.length;r<a;)-1===(i=e.indexOf("\n",r))?(s=e.slice(r),r=a):(s=e.slice(r,i+1),r=i+1),s.length&&"\n"!==s&&(o+=n),o+=s;return o}function Sr(e,t){return"\n"+js.repeat(" ",e.indent*t)}function xr(e){return 32===e||9===e}function $r(e){return 32<=e&&e<=126||161<=e&&e<=55295&&8232!==e&&8233!==e||57344<=e&&e<=65533&&e!==mr||65536<=e&&e<=1114111}function Cr(e){return $r(e)&&e!==mr&&13!==e&&10!==e}function kr(e,t,s){var n=Cr(e),r=n&&!xr(e);return(s?n:n&&44!==e&&91!==e&&93!==e&&123!==e&&125!==e)&&35!==e&&!(58===t&&!r)||Cr(t)&&!xr(t)&&35===e||58===t&&r}function Ar(e,t){var s,n=e.charCodeAt(t);return n>=55296&&n<=56319&&t+1<e.length&&(s=e.charCodeAt(t+1))>=56320&&s<=57343?1024*(n-55296)+s-56320+65536:n}function Mr(e){return/^\n* /.test(e)}function Dr(e,t,s,n,r){e.dump=function(){if(0===t.length)return 2===e.quotingType?'""':"''";if(!e.noCompatMode&&(-1!==yr.indexOf(t)||br.test(t)))return 2===e.quotingType?'"'+t+'"':"'"+t+"'";var i=e.indent*Math.max(1,s),o=-1===e.lineWidth?-1:Math.max(Math.min(e.lineWidth,40),e.lineWidth-i),a=n||e.flowLevel>-1&&s>=e.flowLevel;switch(function(e,t,s,n,r,i,o,a){var l,c=0,d=null,u=!1,h=!1,p=-1!==n,g=-1,m=function(e){return $r(e)&&e!==mr&&!xr(e)&&45!==e&&63!==e&&58!==e&&44!==e&&91!==e&&93!==e&&123!==e&&125!==e&&35!==e&&38!==e&&42!==e&&33!==e&&124!==e&&61!==e&&62!==e&&39!==e&&34!==e&&37!==e&&64!==e&&96!==e}(Ar(e,0))&&function(e){return!xr(e)&&58!==e}(Ar(e,e.length-1));if(t||o)for(l=0;l<e.length;c>=65536?l+=2:l++){if(!$r(c=Ar(e,l)))return 5;m=m&&kr(c,d,a),d=c}else{for(l=0;l<e.length;c>=65536?l+=2:l++){if(10===(c=Ar(e,l)))u=!0,p&&(h=h||l-g-1>n&&" "!==e[g+1],g=l);else if(!$r(c))return 5;m=m&&kr(c,d,a),d=c}h=h||p&&l-g-1>n&&" "!==e[g+1]}return u||h?s>9&&Mr(e)?5:o?2===i?5:2:h?4:3:!m||o||r(e)?2===i?5:2:1}(t,a,e.indent,o,(function(t){return function(e,t){var s,n;for(s=0,n=e.implicitTypes.length;s<n;s+=1)if(e.implicitTypes[s].resolve(t))return!0;return!1}(e,t)}),e.quotingType,e.forceQuotes&&!n,r)){case 1:return t;case 2:return"'"+t.replace(/'/g,"''")+"'";case 3:return"|"+Er(t,e.indent)+Tr(wr(t,i));case 4:return">"+Er(t,e.indent)+Tr(wr(function(e,t){for(var s,n,r,i=/(\n+)([^\n]*)/g,o=(r=-1!==(r=e.indexOf("\n"))?r:e.length,i.lastIndex=r,Rr(e.slice(0,r),t)),a="\n"===e[0]||" "===e[0];n=i.exec(e);){var l=n[1],c=n[2];s=" "===c[0],o+=l+(a||s||""===c?"":"\n")+Rr(c,t),a=s}return o}(t,o),i));case 5:return'"'+function(e){for(var t,s="",n=0,r=0;r<e.length;n>=65536?r+=2:r++)n=Ar(e,r),!(t=fr[n])&&$r(n)?(s+=e[r],n>=65536&&(s+=e[r+1])):s+=t||_r(n);return s}(t)+'"';default:throw new Gs("impossible error: invalid scalar style")}}()}function Er(e,t){var s=Mr(e)?String(t):"",n="\n"===e[e.length-1];return s+(!n||"\n"!==e[e.length-2]&&"\n"!==e?n?"":"-":"+")+"\n"}function Tr(e){return"\n"===e[e.length-1]?e.slice(0,-1):e}function Rr(e,t){if(""===e||" "===e[0])return e;for(var s,n,r=/ [^ ]/g,i=0,o=0,a=0,l="";s=r.exec(e);)(a=s.index)-i>t&&(n=o>i?o:a,l+="\n"+e.slice(i,n),i=n+1),o=a;return l+="\n",e.length-i>t&&o>i?l+=e.slice(i,o)+"\n"+e.slice(o+1):l+=e.slice(i),l.slice(1)}function Or(e,t,s,n){var r,i,o,a="",l=e.tag;for(r=0,i=s.length;r<i;r+=1)o=s[r],e.replacer&&(o=e.replacer.call(s,String(r),o)),(Pr(e,t+1,o,!0,!0,!1,!0)||void 0===o&&Pr(e,t+1,null,!0,!0,!1,!0))&&(n&&""===a||(a+=Sr(e,t)),e.dump&&10===e.dump.charCodeAt(0)?a+="-":a+="- ",a+=e.dump);e.tag=l,e.dump=a||"[]"}function Lr(e,t,s){var n,r,i,o,a,l;for(i=0,o=(r=s?e.explicitTypes:e.implicitTypes).length;i<o;i+=1)if(((a=r[i]).instanceOf||a.predicate)&&(!a.instanceOf||"object"==typeof t&&t instanceof a.instanceOf)&&(!a.predicate||a.predicate(t))){if(s?a.multi&&a.representName?e.tag=a.representName(t):e.tag=a.tag:e.tag="?",a.represent){if(l=e.styleMap[a.tag]||a.defaultStyle,"[object Function]"===pr.call(a.represent))n=a.represent(t,l);else{if(!gr.call(a.represent,l))throw new Gs("!<"+a.tag+'> tag resolver accepts not "'+l+'" style');n=a.represent[l](t,l)}e.dump=n}return!0}return!1}function Pr(e,t,s,n,r,i,o){e.tag=null,e.dump=s,Lr(e,s,!1)||Lr(e,s,!0);var a,l=pr.call(e.dump),c=n;n&&(n=e.flowLevel<0||e.flowLevel>t);var d,u,h="[object Object]"===l||"[object Array]"===l;if(h&&(u=-1!==(d=e.duplicates.indexOf(s))),(null!==e.tag&&"?"!==e.tag||u||2!==e.indent&&t>0)&&(r=!1),u&&e.usedDuplicates[d])e.dump="*ref_"+d;else{if(h&&u&&!e.usedDuplicates[d]&&(e.usedDuplicates[d]=!0),"[object Object]"===l)n&&0!==Object.keys(e.dump).length?(function(e,t,s,n){var r,i,o,a,l,c,d="",u=e.tag,h=Object.keys(s);if(!0===e.sortKeys)h.sort();else if("function"==typeof e.sortKeys)h.sort(e.sortKeys);else if(e.sortKeys)throw new Gs("sortKeys must be a boolean or a function");for(r=0,i=h.length;r<i;r+=1)c="",n&&""===d||(c+=Sr(e,t)),a=s[o=h[r]],e.replacer&&(a=e.replacer.call(s,o,a)),Pr(e,t+1,o,!0,!0,!0)&&((l=null!==e.tag&&"?"!==e.tag||e.dump&&e.dump.length>1024)&&(e.dump&&10===e.dump.charCodeAt(0)?c+="?":c+="? "),c+=e.dump,l&&(c+=Sr(e,t)),Pr(e,t+1,a,!0,l)&&(e.dump&&10===e.dump.charCodeAt(0)?c+=":":c+=": ",d+=c+=e.dump));e.tag=u,e.dump=d||"{}"}(e,t,e.dump,r),u&&(e.dump="&ref_"+d+e.dump)):(function(e,t,s){var n,r,i,o,a,l="",c=e.tag,d=Object.keys(s);for(n=0,r=d.length;n<r;n+=1)a="",""!==l&&(a+=", "),e.condenseFlow&&(a+='"'),o=s[i=d[n]],e.replacer&&(o=e.replacer.call(s,i,o)),Pr(e,t,i,!1,!1)&&(e.dump.length>1024&&(a+="? "),a+=e.dump+(e.condenseFlow?'"':"")+":"+(e.condenseFlow?"":" "),Pr(e,t,o,!1,!1)&&(l+=a+=e.dump));e.tag=c,e.dump="{"+l+"}"}(e,t,e.dump),u&&(e.dump="&ref_"+d+" "+e.dump));else if("[object Array]"===l)n&&0!==e.dump.length?(e.noArrayIndent&&!o&&t>0?Or(e,t-1,e.dump,r):Or(e,t,e.dump,r),u&&(e.dump="&ref_"+d+e.dump)):(function(e,t,s){var n,r,i,o="",a=e.tag;for(n=0,r=s.length;n<r;n+=1)i=s[n],e.replacer&&(i=e.replacer.call(s,String(n),i)),(Pr(e,t,i,!1,!1)||void 0===i&&Pr(e,t,null,!1,!1))&&(""!==o&&(o+=","+(e.condenseFlow?"":" ")),o+=e.dump);e.tag=a,e.dump="["+o+"]"}(e,t,e.dump),u&&(e.dump="&ref_"+d+" "+e.dump));else{if("[object String]"!==l){if("[object Undefined]"===l)return!1;if(e.skipInvalid)return!1;throw new Gs("unacceptable kind of an object to dump "+l)}"?"!==e.tag&&Dr(e,e.dump,t,i,c)}null!==e.tag&&"?"!==e.tag&&(a=encodeURI("!"===e.tag[0]?e.tag.slice(1):e.tag).replace(/!/g,"%21"),a="!"===e.tag[0]?"!"+a:"tag:yaml.org,2002:"===a.slice(0,18)?"!!"+a.slice(18):"!<"+a+">",e.dump=a+" "+e.dump)}return!0}function Nr(e,t){var s,n,r=[],i=[];for(Fr(e,r,i),s=0,n=i.length;s<n;s+=1)t.duplicates.push(r[i[s]]);t.usedDuplicates=new Array(n)}function Fr(e,t,s){var n,r,i;if(null!==e&&"object"==typeof e)if(-1!==(r=t.indexOf(e)))-1===s.indexOf(r)&&s.push(r);else if(t.push(e),Array.isArray(e))for(r=0,i=e.length;r<i;r+=1)Fr(e[r],t,s);else for(r=0,i=(n=Object.keys(e)).length;r<i;r+=1)Fr(e[n[r]],t,s)}function Br(e,t){return function(){throw new Error("Function yaml."+e+" is removed in js-yaml 4. Use yaml."+t+" instead, which is now safe by default.")}}const Ir={Type:Xs,Schema:Ks,FAILSAFE_SCHEMA:sn,JSON_SCHEMA:pn,CORE_SCHEMA:gn,DEFAULT_SCHEMA:Mn,load:hr.load,loadAll:hr.loadAll,dump:function(e,t){var s=new vr(t=t||{});s.noRefs||Nr(e,s);var n=e;return s.replacer&&(n=s.replacer.call({"":n},"",n)),Pr(s,0,n,!0,!0)?s.dump+"\n":""},YAMLException:Gs,types:{binary:vn,float:hn,map:tn,null:nn,pairs:Cn,set:An,timestamp:yn,bool:rn,int:cn,merge:bn,omap:xn,seq:en,str:Qs},safeLoad:Br("safeLoad","load"),safeLoadAll:Br("safeLoadAll","loadAll"),safeDump:Br("safeDump","dump")};try{"undefined"==typeof window||window.jsyaml||(window.jsyaml={load:Ir.load,dump:Ir.dump})}catch{}async function zr(e){try{const t=await async function(e){try{const t=await fetch(e);if(t.ok)return await t.text()}catch(e){throw Is.lr.error("[fetchYAML] Error fetching YAML file ",e),e}}(e);return Ir.load(t)}catch(e){throw Is.lr.error("[readYamlFile] Failed to parse YAML file",e.message),e}}function jr(){return window.cblcars=window.cblcars||{},window.cblcars.msd=window.cblcars.msd||{},window.cblcars.msd.svg_templates=window.cblcars.msd.svg_templates||{},window.cblcars.msd.svg_templates}async function Hr(e,t){const s=jr();if(s[e])return s[e];try{const n=await fetch(t);if(!n.ok)return void Is.lr.error(`[loadSVGToCache] Failed to fetch SVG [${t}] for key [${e}]: ${n.status} ${n.statusText}`);let r=await n.text();return r=r.replace(/<svg([^>]*)>/i,((e,t)=>`<svg width="100%" height="100%"${t.replace(/\s(width|height)=["'][^"']*["']/gi,"")}>`)),s[e]=r,Is.lr.debug(`[loadSVGToCache] Loaded SVG [${e}] from [${t}]`),r}catch(s){return void Is.lr.error(`[loadSVGToCache] Error loading SVG [${e}] from [${t}]`,s)}}function Ur(e){return jr()[e]}var Gr=r(243),Vr=r(41);class qr extends Vr.A{_formControls;_cardType;constructor(e){super(),this._formControls={},this._cardType="",this._cardType=e,this._initializationPromise=this._initialize()}async _initialize(){try{const e=await fetch(`${Bs.iM}/${this._cardType}.json`);if(!e.ok)throw new Error(`Form definition not found for card type: ${this._cardType}`);const t=await e.json();Is.lr.debug("Loaded formControls:",t),this._formControls=t,this._userStyles=Gr.css`${(0,Gr.unsafeCSS)(t.css&&t.css.cssText||"")}`,this._mergeUserStyles=t?.css?.mergeUserStyles??!0,this.requestUpdate()}catch(e){Is.lr.error("Error fetching editor form definition: ",e)}}async setConfig(e){await this._initializationPromise,super.setConfig(e),this.requestUpdate()}render(){if(!this._hass)return Gr.html`<ha-alert alert-type="error" title="Error">Home Assistant instance is missing.</ha-alert>`;if(!this._config)return Gr.html`<ha-alert alert-type="error" title="Error">Card configuration is missing.</ha-alert>`;if(!this._formControls)return Gr.html`<ha-alert alert-type="error" title="Error">Form controls are missing.</ha-alert>`;try{const e=this._formControls;return this.generateForm(e)}catch(e){return Is.lr.error("Error rendering configuration form:",e),Gr.html`<ha-alert alert-type="error" title="Error">Error rendering form: ${e.message}</ha-alert>`}}}function Wr(e){window.cblcars._loadedFonts=window.cblcars._loadedFonts||new Set;const t=e.split(",").map((e=>e.trim().replace(/^['"]|['"]$/g,"")));t.forEach((e=>{if(e.startsWith("http://")||e.startsWith("https://")){const t=e;if(window.cblcars._loadedFonts.has(t))return;if(document.querySelector(`link[href="${t}"]`))return void window.cblcars._loadedFonts.add(t);const s=document.createElement("link");return s.rel="stylesheet",s.href=t,document.head.appendChild(s),window.cblcars._loadedFonts.add(t),void Is.lr.info(`[loadFont] Loaded remote font from: ${t}`)}if(!e.startsWith("cb-lcars_"))return;const t=`/hacsfiles/cb-lcars/fonts/${e}.css`,s=e;if(window.cblcars._loadedFonts.has(s))return;if(document.querySelector(`link[href="${t}"]`))return void window.cblcars._loadedFonts.add(s);const n=document.createElement("link");n.rel="stylesheet",n.href=t,document.head.appendChild(n),window.cblcars._loadedFonts.add(s),Is.lr.info(`[loadFont] Loaded local font: ${e}`)}))}function Yr(e,t,s,n){var r,i=arguments.length,o=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(i<3?r(o):i>3?r(t,s,o):r(t,s))||o);return i>3&&o&&Object.defineProperty(t,s,o),o}const Xr=window,Jr=Xr.ShadowRoot&&(void 0===Xr.ShadyCSS||Xr.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,Zr=Symbol(),Kr=new WeakMap;class Qr{constructor(e,t,s){if(this._$cssResult$=!0,s!==Zr)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=e,this.t=t}get styleSheet(){let e=this.o;const t=this.t;if(Jr&&void 0===e){const s=void 0!==t&&1===t.length;s&&(e=Kr.get(t)),void 0===e&&((this.o=e=new CSSStyleSheet).replaceSync(this.cssText),s&&Kr.set(t,e))}return e}toString(){return this.cssText}}const ei=Jr?e=>e:e=>e instanceof CSSStyleSheet?(e=>{let t="";for(const s of e.cssRules)t+=s.cssText;return(e=>new Qr("string"==typeof e?e:e+"",void 0,Zr))(t)})(e):e;var ti;const si=window,ni=si.trustedTypes,ri=ni?ni.emptyScript:"",ii=si.reactiveElementPolyfillSupport,oi={toAttribute(e,t){switch(t){case Boolean:e=e?ri:null;break;case Object:case Array:e=null==e?e:JSON.stringify(e)}return e},fromAttribute(e,t){let s=e;switch(t){case Boolean:s=null!==e;break;case Number:s=null===e?null:Number(e);break;case Object:case Array:try{s=JSON.parse(e)}catch(e){s=null}}return s}},ai=(e,t)=>t!==e&&(t==t||e==e),li={attribute:!0,type:String,converter:oi,reflect:!1,hasChanged:ai},ci="finalized";class di extends HTMLElement{constructor(){super(),this._$Ei=new Map,this.isUpdatePending=!1,this.hasUpdated=!1,this._$El=null,this.u()}static addInitializer(e){var t;this.finalize(),(null!==(t=this.h)&&void 0!==t?t:this.h=[]).push(e)}static get observedAttributes(){this.finalize();const e=[];return this.elementProperties.forEach(((t,s)=>{const n=this._$Ep(s,t);void 0!==n&&(this._$Ev.set(n,s),e.push(n))})),e}static createProperty(e,t=li){if(t.state&&(t.attribute=!1),this.finalize(),this.elementProperties.set(e,t),!t.noAccessor&&!this.prototype.hasOwnProperty(e)){const s="symbol"==typeof e?Symbol():"__"+e,n=this.getPropertyDescriptor(e,s,t);void 0!==n&&Object.defineProperty(this.prototype,e,n)}}static getPropertyDescriptor(e,t,s){return{get(){return this[t]},set(n){const r=this[e];this[t]=n,this.requestUpdate(e,r,s)},configurable:!0,enumerable:!0}}static getPropertyOptions(e){return this.elementProperties.get(e)||li}static finalize(){if(this.hasOwnProperty(ci))return!1;this[ci]=!0;const e=Object.getPrototypeOf(this);if(e.finalize(),void 0!==e.h&&(this.h=[...e.h]),this.elementProperties=new Map(e.elementProperties),this._$Ev=new Map,this.hasOwnProperty("properties")){const e=this.properties,t=[...Object.getOwnPropertyNames(e),...Object.getOwnPropertySymbols(e)];for(const s of t)this.createProperty(s,e[s])}return this.elementStyles=this.finalizeStyles(this.styles),!0}static finalizeStyles(e){const t=[];if(Array.isArray(e)){const s=new Set(e.flat(1/0).reverse());for(const e of s)t.unshift(ei(e))}else void 0!==e&&t.push(ei(e));return t}static _$Ep(e,t){const s=t.attribute;return!1===s?void 0:"string"==typeof s?s:"string"==typeof e?e.toLowerCase():void 0}u(){var e;this._$E_=new Promise((e=>this.enableUpdating=e)),this._$AL=new Map,this._$Eg(),this.requestUpdate(),null===(e=this.constructor.h)||void 0===e||e.forEach((e=>e(this)))}addController(e){var t,s;(null!==(t=this._$ES)&&void 0!==t?t:this._$ES=[]).push(e),void 0!==this.renderRoot&&this.isConnected&&(null===(s=e.hostConnected)||void 0===s||s.call(e))}removeController(e){var t;null===(t=this._$ES)||void 0===t||t.splice(this._$ES.indexOf(e)>>>0,1)}_$Eg(){this.constructor.elementProperties.forEach(((e,t)=>{this.hasOwnProperty(t)&&(this._$Ei.set(t,this[t]),delete this[t])}))}createRenderRoot(){var e;const t=null!==(e=this.shadowRoot)&&void 0!==e?e:this.attachShadow(this.constructor.shadowRootOptions);return((e,t)=>{Jr?e.adoptedStyleSheets=t.map((e=>e instanceof CSSStyleSheet?e:e.styleSheet)):t.forEach((t=>{const s=document.createElement("style"),n=Xr.litNonce;void 0!==n&&s.setAttribute("nonce",n),s.textContent=t.cssText,e.appendChild(s)}))})(t,this.constructor.elementStyles),t}connectedCallback(){var e;void 0===this.renderRoot&&(this.renderRoot=this.createRenderRoot()),this.enableUpdating(!0),null===(e=this._$ES)||void 0===e||e.forEach((e=>{var t;return null===(t=e.hostConnected)||void 0===t?void 0:t.call(e)}))}enableUpdating(e){}disconnectedCallback(){var e;null===(e=this._$ES)||void 0===e||e.forEach((e=>{var t;return null===(t=e.hostDisconnected)||void 0===t?void 0:t.call(e)}))}attributeChangedCallback(e,t,s){this._$AK(e,s)}_$EO(e,t,s=li){var n;const r=this.constructor._$Ep(e,s);if(void 0!==r&&!0===s.reflect){const i=(void 0!==(null===(n=s.converter)||void 0===n?void 0:n.toAttribute)?s.converter:oi).toAttribute(t,s.type);this._$El=e,null==i?this.removeAttribute(r):this.setAttribute(r,i),this._$El=null}}_$AK(e,t){var s;const n=this.constructor,r=n._$Ev.get(e);if(void 0!==r&&this._$El!==r){const e=n.getPropertyOptions(r),i="function"==typeof e.converter?{fromAttribute:e.converter}:void 0!==(null===(s=e.converter)||void 0===s?void 0:s.fromAttribute)?e.converter:oi;this._$El=r,this[r]=i.fromAttribute(t,e.type),this._$El=null}}requestUpdate(e,t,s){let n=!0;void 0!==e&&(((s=s||this.constructor.getPropertyOptions(e)).hasChanged||ai)(this[e],t)?(this._$AL.has(e)||this._$AL.set(e,t),!0===s.reflect&&this._$El!==e&&(void 0===this._$EC&&(this._$EC=new Map),this._$EC.set(e,s))):n=!1),!this.isUpdatePending&&n&&(this._$E_=this._$Ej())}async _$Ej(){this.isUpdatePending=!0;try{await this._$E_}catch(e){Promise.reject(e)}const e=this.scheduleUpdate();return null!=e&&await e,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){var e;if(!this.isUpdatePending)return;this.hasUpdated,this._$Ei&&(this._$Ei.forEach(((e,t)=>this[t]=e)),this._$Ei=void 0);let t=!1;const s=this._$AL;try{t=this.shouldUpdate(s),t?(this.willUpdate(s),null===(e=this._$ES)||void 0===e||e.forEach((e=>{var t;return null===(t=e.hostUpdate)||void 0===t?void 0:t.call(e)})),this.update(s)):this._$Ek()}catch(e){throw t=!1,this._$Ek(),e}t&&this._$AE(s)}willUpdate(e){}_$AE(e){var t;null===(t=this._$ES)||void 0===t||t.forEach((e=>{var t;return null===(t=e.hostUpdated)||void 0===t?void 0:t.call(e)})),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(e)),this.updated(e)}_$Ek(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$E_}shouldUpdate(e){return!0}update(e){void 0!==this._$EC&&(this._$EC.forEach(((e,t)=>this._$EO(t,this[t],e))),this._$EC=void 0),this._$Ek()}updated(e){}firstUpdated(e){}}var ui;di[ci]=!0,di.elementProperties=new Map,di.elementStyles=[],di.shadowRootOptions={mode:"open"},null==ii||ii({ReactiveElement:di}),(null!==(ti=si.reactiveElementVersions)&&void 0!==ti?ti:si.reactiveElementVersions=[]).push("1.6.2");const hi=window,pi=hi.trustedTypes,gi=pi?pi.createPolicy("lit-html",{createHTML:e=>e}):void 0,mi="$lit$",fi=`lit$${(Math.random()+"").slice(9)}$`,yi="?"+fi,bi=`<${yi}>`,_i=document,vi=()=>_i.createComment(""),wi=e=>null===e||"object"!=typeof e&&"function"!=typeof e,Si=Array.isArray,xi="[ \t\n\f\r]",$i=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,Ci=/-->/g,ki=/>/g,Ai=RegExp(`>|${xi}(?:([^\\s"'>=/]+)(${xi}*=${xi}*(?:[^ \t\n\f\r"'\`<>=]|("|')|))|$)`,"g"),Mi=/'/g,Di=/"/g,Ei=/^(?:script|style|textarea|title)$/i,Ti=(e,...t)=>({_$litType$:1,strings:e,values:t}),Ri=Symbol.for("lit-noChange"),Oi=Symbol.for("lit-nothing"),Li=new WeakMap,Pi=_i.createTreeWalker(_i,129,null,!1);function Ni(e,t){if(!Array.isArray(e)||!e.hasOwnProperty("raw"))throw Error("invalid template strings array");return void 0!==gi?gi.createHTML(t):t}class Fi{constructor({strings:e,_$litType$:t},s){let n;this.parts=[];let r=0,i=0;const o=e.length-1,a=this.parts,[l,c]=((e,t)=>{const s=e.length-1,n=[];let r,i=2===t?"<svg>":"",o=$i;for(let t=0;t<s;t++){const s=e[t];let a,l,c=-1,d=0;for(;d<s.length&&(o.lastIndex=d,l=o.exec(s),null!==l);)d=o.lastIndex,o===$i?"!--"===l[1]?o=Ci:void 0!==l[1]?o=ki:void 0!==l[2]?(Ei.test(l[2])&&(r=RegExp("</"+l[2],"g")),o=Ai):void 0!==l[3]&&(o=Ai):o===Ai?">"===l[0]?(o=null!=r?r:$i,c=-1):void 0===l[1]?c=-2:(c=o.lastIndex-l[2].length,a=l[1],o=void 0===l[3]?Ai:'"'===l[3]?Di:Mi):o===Di||o===Mi?o=Ai:o===Ci||o===ki?o=$i:(o=Ai,r=void 0);const u=o===Ai&&e[t+1].startsWith("/>")?" ":"";i+=o===$i?s+bi:c>=0?(n.push(a),s.slice(0,c)+mi+s.slice(c)+fi+u):s+fi+(-2===c?(n.push(void 0),t):u)}return[Ni(e,i+(e[s]||"<?>")+(2===t?"</svg>":"")),n]})(e,t);if(this.el=Fi.createElement(l,s),Pi.currentNode=this.el.content,2===t){const e=this.el.content,t=e.firstChild;t.remove(),e.append(...t.childNodes)}for(;null!==(n=Pi.nextNode())&&a.length<o;){if(1===n.nodeType){if(n.hasAttributes()){const e=[];for(const t of n.getAttributeNames())if(t.endsWith(mi)||t.startsWith(fi)){const s=c[i++];if(e.push(t),void 0!==s){const e=n.getAttribute(s.toLowerCase()+mi).split(fi),t=/([.?@])?(.*)/.exec(s);a.push({type:1,index:r,name:t[2],strings:e,ctor:"."===t[1]?Hi:"?"===t[1]?Gi:"@"===t[1]?Vi:ji})}else a.push({type:6,index:r})}for(const t of e)n.removeAttribute(t)}if(Ei.test(n.tagName)){const e=n.textContent.split(fi),t=e.length-1;if(t>0){n.textContent=pi?pi.emptyScript:"";for(let s=0;s<t;s++)n.append(e[s],vi()),Pi.nextNode(),a.push({type:2,index:++r});n.append(e[t],vi())}}}else if(8===n.nodeType)if(n.data===yi)a.push({type:2,index:r});else{let e=-1;for(;-1!==(e=n.data.indexOf(fi,e+1));)a.push({type:7,index:r}),e+=fi.length-1}r++}}static createElement(e,t){const s=_i.createElement("template");return s.innerHTML=e,s}}function Bi(e,t,s=e,n){var r,i,o,a;if(t===Ri)return t;let l=void 0!==n?null===(r=s._$Co)||void 0===r?void 0:r[n]:s._$Cl;const c=wi(t)?void 0:t._$litDirective$;return(null==l?void 0:l.constructor)!==c&&(null===(i=null==l?void 0:l._$AO)||void 0===i||i.call(l,!1),void 0===c?l=void 0:(l=new c(e),l._$AT(e,s,n)),void 0!==n?(null!==(o=(a=s)._$Co)&&void 0!==o?o:a._$Co=[])[n]=l:s._$Cl=l),void 0!==l&&(t=Bi(e,l._$AS(e,t.values),l,n)),t}class Ii{constructor(e,t){this._$AV=[],this._$AN=void 0,this._$AD=e,this._$AM=t}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}u(e){var t;const{el:{content:s},parts:n}=this._$AD,r=(null!==(t=null==e?void 0:e.creationScope)&&void 0!==t?t:_i).importNode(s,!0);Pi.currentNode=r;let i=Pi.nextNode(),o=0,a=0,l=n[0];for(;void 0!==l;){if(o===l.index){let t;2===l.type?t=new zi(i,i.nextSibling,this,e):1===l.type?t=new l.ctor(i,l.name,l.strings,this,e):6===l.type&&(t=new qi(i,this,e)),this._$AV.push(t),l=n[++a]}o!==(null==l?void 0:l.index)&&(i=Pi.nextNode(),o++)}return Pi.currentNode=_i,r}v(e){let t=0;for(const s of this._$AV)void 0!==s&&(void 0!==s.strings?(s._$AI(e,s,t),t+=s.strings.length-2):s._$AI(e[t])),t++}}class zi{constructor(e,t,s,n){var r;this.type=2,this._$AH=Oi,this._$AN=void 0,this._$AA=e,this._$AB=t,this._$AM=s,this.options=n,this._$Cp=null===(r=null==n?void 0:n.isConnected)||void 0===r||r}get _$AU(){var e,t;return null!==(t=null===(e=this._$AM)||void 0===e?void 0:e._$AU)&&void 0!==t?t:this._$Cp}get parentNode(){let e=this._$AA.parentNode;const t=this._$AM;return void 0!==t&&11===(null==e?void 0:e.nodeType)&&(e=t.parentNode),e}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(e,t=this){e=Bi(this,e,t),wi(e)?e===Oi||null==e||""===e?(this._$AH!==Oi&&this._$AR(),this._$AH=Oi):e!==this._$AH&&e!==Ri&&this._(e):void 0!==e._$litType$?this.g(e):void 0!==e.nodeType?this.$(e):(e=>Si(e)||"function"==typeof(null==e?void 0:e[Symbol.iterator]))(e)?this.T(e):this._(e)}k(e){return this._$AA.parentNode.insertBefore(e,this._$AB)}$(e){this._$AH!==e&&(this._$AR(),this._$AH=this.k(e))}_(e){this._$AH!==Oi&&wi(this._$AH)?this._$AA.nextSibling.data=e:this.$(_i.createTextNode(e)),this._$AH=e}g(e){var t;const{values:s,_$litType$:n}=e,r="number"==typeof n?this._$AC(e):(void 0===n.el&&(n.el=Fi.createElement(Ni(n.h,n.h[0]),this.options)),n);if((null===(t=this._$AH)||void 0===t?void 0:t._$AD)===r)this._$AH.v(s);else{const e=new Ii(r,this),t=e.u(this.options);e.v(s),this.$(t),this._$AH=e}}_$AC(e){let t=Li.get(e.strings);return void 0===t&&Li.set(e.strings,t=new Fi(e)),t}T(e){Si(this._$AH)||(this._$AH=[],this._$AR());const t=this._$AH;let s,n=0;for(const r of e)n===t.length?t.push(s=new zi(this.k(vi()),this.k(vi()),this,this.options)):s=t[n],s._$AI(r),n++;n<t.length&&(this._$AR(s&&s._$AB.nextSibling,n),t.length=n)}_$AR(e=this._$AA.nextSibling,t){var s;for(null===(s=this._$AP)||void 0===s||s.call(this,!1,!0,t);e&&e!==this._$AB;){const t=e.nextSibling;e.remove(),e=t}}setConnected(e){var t;void 0===this._$AM&&(this._$Cp=e,null===(t=this._$AP)||void 0===t||t.call(this,e))}}class ji{constructor(e,t,s,n,r){this.type=1,this._$AH=Oi,this._$AN=void 0,this.element=e,this.name=t,this._$AM=n,this.options=r,s.length>2||""!==s[0]||""!==s[1]?(this._$AH=Array(s.length-1).fill(new String),this.strings=s):this._$AH=Oi}get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}_$AI(e,t=this,s,n){const r=this.strings;let i=!1;if(void 0===r)e=Bi(this,e,t,0),i=!wi(e)||e!==this._$AH&&e!==Ri,i&&(this._$AH=e);else{const n=e;let o,a;for(e=r[0],o=0;o<r.length-1;o++)a=Bi(this,n[s+o],t,o),a===Ri&&(a=this._$AH[o]),i||(i=!wi(a)||a!==this._$AH[o]),a===Oi?e=Oi:e!==Oi&&(e+=(null!=a?a:"")+r[o+1]),this._$AH[o]=a}i&&!n&&this.j(e)}j(e){e===Oi?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,null!=e?e:"")}}class Hi extends ji{constructor(){super(...arguments),this.type=3}j(e){this.element[this.name]=e===Oi?void 0:e}}const Ui=pi?pi.emptyScript:"";class Gi extends ji{constructor(){super(...arguments),this.type=4}j(e){e&&e!==Oi?this.element.setAttribute(this.name,Ui):this.element.removeAttribute(this.name)}}class Vi extends ji{constructor(e,t,s,n,r){super(e,t,s,n,r),this.type=5}_$AI(e,t=this){var s;if((e=null!==(s=Bi(this,e,t,0))&&void 0!==s?s:Oi)===Ri)return;const n=this._$AH,r=e===Oi&&n!==Oi||e.capture!==n.capture||e.once!==n.once||e.passive!==n.passive,i=e!==Oi&&(n===Oi||r);r&&this.element.removeEventListener(this.name,this,n),i&&this.element.addEventListener(this.name,this,e),this._$AH=e}handleEvent(e){var t,s;"function"==typeof this._$AH?this._$AH.call(null!==(s=null===(t=this.options)||void 0===t?void 0:t.host)&&void 0!==s?s:this.element,e):this._$AH.handleEvent(e)}}class qi{constructor(e,t,s){this.element=e,this.type=6,this._$AN=void 0,this._$AM=t,this.options=s}get _$AU(){return this._$AM._$AU}_$AI(e){Bi(this,e)}}const Wi=hi.litHtmlPolyfillSupport;var Yi,Xi;null==Wi||Wi(Fi,zi),(null!==(ui=hi.litHtmlVersions)&&void 0!==ui?ui:hi.litHtmlVersions=[]).push("2.7.5");class Ji extends di{constructor(){super(...arguments),this.renderOptions={host:this},this._$Do=void 0}createRenderRoot(){var e,t;const s=super.createRenderRoot();return null!==(e=(t=this.renderOptions).renderBefore)&&void 0!==e||(t.renderBefore=s.firstChild),s}update(e){const t=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(e),this._$Do=((e,t,s)=>{var n,r;const i=null!==(n=null==s?void 0:s.renderBefore)&&void 0!==n?n:t;let o=i._$litPart$;if(void 0===o){const e=null!==(r=null==s?void 0:s.renderBefore)&&void 0!==r?r:null;i._$litPart$=o=new zi(t.insertBefore(vi(),e),e,void 0,null!=s?s:{})}return o._$AI(e),o})(t,this.renderRoot,this.renderOptions)}connectedCallback(){var e;super.connectedCallback(),null===(e=this._$Do)||void 0===e||e.setConnected(!0)}disconnectedCallback(){var e;super.disconnectedCallback(),null===(e=this._$Do)||void 0===e||e.setConnected(!1)}render(){return Ri}}Ji.finalized=!0,Ji._$litElement$=!0,null===(Yi=globalThis.litElementHydrateSupport)||void 0===Yi||Yi.call(globalThis,{LitElement:Ji});const Zi=globalThis.litElementPolyfillSupport;null==Zi||Zi({LitElement:Ji}),(null!==(Xi=globalThis.litElementVersions)&&void 0!==Xi?Xi:globalThis.litElementVersions=[]).push("3.3.2");const Ki=(e,t)=>"method"===t.kind&&t.descriptor&&!("value"in t.descriptor)?{...t,finisher(s){s.createProperty(t.key,e)}}:{kind:"field",key:Symbol(),placement:"own",descriptor:{},originalKey:t.key,initializer(){"function"==typeof t.initializer&&(this[t.key]=t.initializer.call(this))},finisher(s){s.createProperty(t.key,e)}};function Qi(e){return(t,s)=>void 0!==s?((e,t,s)=>{t.constructor.createProperty(s,e)})(e,t,s):Ki(e,t)}const eo=({finisher:e,descriptor:t})=>(s,n)=>{var r;if(void 0===n){const n=null!==(r=s.originalKey)&&void 0!==r?r:s.key,i=null!=t?{kind:"method",placement:"prototype",key:n,descriptor:t(s.key)}:{...s,key:n};return null!=e&&(i.finisher=function(t){e(t,n)}),i}{const r=s.constructor;void 0!==t&&Object.defineProperty(s,n,t(n)),null==e||e(r,n)}};function to(e){return eo({finisher:(t,s)=>{Object.assign(t.prototype[s],e)}})}var so;null===(so=window.HTMLSlotElement)||void 0===so||so.prototype.assignedElements;class no{constructor(e){this.startPress=t=>{e().then((e=>{e&&e.startPress(t)}))},this.endPress=()=>{e().then((e=>{e&&e.endPress()}))},this.startFocus=()=>{e().then((e=>{e&&e.startFocus()}))},this.endFocus=()=>{e().then((e=>{e&&e.endFocus()}))},this.startHover=()=>{e().then((e=>{e&&e.startHover()}))},this.endHover=()=>{e().then((e=>{e&&e.endHover()}))}}}const ro=e=>(...t)=>({_$litDirective$:e,values:t});class io{constructor(e){}get _$AU(){return this._$AM._$AU}_$AT(e,t,s){this._$Ct=e,this._$AM=t,this._$Ci=s}_$AS(e,t){return this.update(e,t)}update(e,t){return this.render(...t)}}const oo="important",ao=" !"+oo,lo=ro(class extends io{constructor(e){var t;if(super(e),1!==e.type||"style"!==e.name||(null===(t=e.strings)||void 0===t?void 0:t.length)>2)throw Error("The `styleMap` directive must be used in the `style` attribute and must be the only part in the attribute.")}render(e){return Object.keys(e).reduce(((t,s)=>{const n=e[s];return null==n?t:t+`${s=s.includes("-")?s:s.replace(/(?:^(webkit|moz|ms|o)|)(?=[A-Z])/g,"-$&").toLowerCase()}:${n};`}),"")}update(e,[t]){const{style:s}=e.element;if(void 0===this.ut){this.ut=new Set;for(const e in t)this.ut.add(e);return this.render(t)}this.ut.forEach((e=>{null==t[e]&&(this.ut.delete(e),e.includes("-")?s.removeProperty(e):s[e]="")}));for(const e in t){const n=t[e];if(null!=n){this.ut.add(e);const t="string"==typeof n&&n.endsWith(ao);e.includes("-")||t?s.setProperty(e,t?n.slice(0,-11):n,t?oo:""):s[e]=n}}return Ri}});class co extends io{constructor(e){if(super(e),this.et=Oi,2!==e.type)throw Error(this.constructor.directiveName+"() can only be used in child bindings")}render(e){if(e===Oi||null==e)return this.ft=void 0,this.et=e;if(e===Ri)return e;if("string"!=typeof e)throw Error(this.constructor.directiveName+"() called with a non-string value");if(e===this.et)return this.ft;this.et=e;const t=[e];return t.raw=t,this.ft={_$litType$:this.constructor.resultType,strings:t,values:[]}}}co.directiveName="unsafeHTML",co.resultType=1;const uo=ro(co),ho=ro(class extends io{constructor(e){var t;if(super(e),1!==e.type||"class"!==e.name||(null===(t=e.strings)||void 0===t?void 0:t.length)>2)throw Error("`classMap()` can only be used in the `class` attribute and must be the only part in the attribute.")}render(e){return" "+Object.keys(e).filter((t=>e[t])).join(" ")+" "}update(e,[t]){var s,n;if(void 0===this.it){this.it=new Set,void 0!==e.strings&&(this.nt=new Set(e.strings.join(" ").split(/\s/).filter((e=>""!==e))));for(const e in t)t[e]&&!(null===(s=this.nt)||void 0===s?void 0:s.has(e))&&this.it.add(e);return this.render(t)}const r=e.element.classList;this.it.forEach((e=>{e in t||(r.remove(e),this.it.delete(e))}));for(const e in t){const s=!!t[e];s===this.it.has(e)||(null===(n=this.nt)||void 0===n?void 0:n.has(e))||(s?(r.add(e),this.it.add(e)):(r.remove(e),this.it.delete(e)))}return Ri}}),po=(e,t,s,n)=>{n=n||{},s=null==s?{}:s;const r=new Event(t,{bubbles:void 0===n.bubbles||n.bubbles,cancelable:Boolean(n.cancelable),composed:void 0===n.composed||n.composed});return r.detail=s,e.dispatchEvent(r),r},go=(e,t)=>{if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){if(e.constructor!==t.constructor)return!1;let s,n;if(Array.isArray(e)){if(n=e.length,n!==t.length)return!1;for(s=n;0!=s--;)if(!go(e[s],t[s]))return!1;return!0}if(e instanceof Map&&t instanceof Map){if(e.size!==t.size)return!1;for(s of e.entries())if(!t.has(s[0]))return!1;for(s of e.entries())if(!go(s[1],t.get(s[0])))return!1;return!0}if(e instanceof Set&&t instanceof Set){if(e.size!==t.size)return!1;for(s of e.entries())if(!t.has(s[0]))return!1;return!0}if(ArrayBuffer.isView(e)&&ArrayBuffer.isView(t)){if(n=e.length,n!==t.length)return!1;for(s=n;0!=s--;)if(e[s]!==t[s])return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();const r=Object.keys(e);if(n=r.length,n!==Object.keys(t).length)return!1;for(s=n;0!=s--;)if(!Object.prototype.hasOwnProperty.call(t,r[s]))return!1;for(s=n;0!=s--;){const n=r[s];if(!go(e[n],t[n]))return!1}return!0}return e!=e&&t!=t},mo="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;class fo extends HTMLElement{constructor(){super(),this.holdTime=500,this.held=!1,this.cancelled=!1,this.isRepeating=!1,this.repeatCount=0,this.ripple=document.createElement("mwc-ripple")}connectedCallback(){Object.assign(this.style,{position:"fixed",width:mo?"100px":"50px",height:mo?"100px":"50px",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:"999"}),this.appendChild(this.ripple),this.ripple.primary=!0,["touchcancel","mouseout","mouseup","touchmove","mousewheel","wheel","scroll"].forEach((e=>{document.addEventListener(e,(()=>{this.cancelled=!0,this.timer&&(this.stopAnimation(),clearTimeout(this.timer),this.timer=void 0,this.isRepeating&&this.repeatTimeout&&(clearInterval(this.repeatTimeout),this.isRepeating=!1))}),{passive:!0})}))}bind(e,t){e.actionHandler&&go(t,e.actionHandler.options)||(e.actionHandler?(e.removeEventListener("touchstart",e.actionHandler.start),e.removeEventListener("touchend",e.actionHandler.end),e.removeEventListener("touchcancel",e.actionHandler.end),e.removeEventListener("mousedown",e.actionHandler.start),e.removeEventListener("click",e.actionHandler.end),e.removeEventListener("keyup",e.actionHandler.handleEnter)):e.addEventListener("contextmenu",(e=>{const t=e||window.event;return t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),t.cancelBubble=!0,t.returnValue=!1,!1})),e.actionHandler={options:t},t.disabled||(e.actionHandler.start=s=>{let n,r;this.cancelled=!1,s.touches?(n=s.touches[0].clientX,r=s.touches[0].clientY):(n=s.clientX,r=s.clientY),t.hasHold&&(this.held=!1,this.timer=window.setTimeout((()=>{this.startAnimation(n,r),this.held=!0,t.repeat&&!this.isRepeating&&(this.repeatCount=0,this.isRepeating=!0,this.repeatTimeout=setInterval((()=>{po(e,"action",{action:"hold"}),this.repeatCount++,this.repeatTimeout&&t.repeatLimit&&this.repeatCount>=t.repeatLimit&&(clearInterval(this.repeatTimeout),this.isRepeating=!1)}),t.repeat))}),this.holdTime))},e.actionHandler.end=e=>{if(["touchend","touchcancel"].includes(e.type)&&this.cancelled)return void(this.isRepeating&&this.repeatTimeout&&(clearInterval(this.repeatTimeout),this.isRepeating=!1));const s=e.target;e.cancelable&&e.preventDefault(),t.hasHold&&(clearTimeout(this.timer),this.isRepeating&&this.repeatTimeout&&clearInterval(this.repeatTimeout),this.isRepeating=!1,this.stopAnimation(),this.timer=void 0),t.hasHold&&this.held?t.repeat||po(s,"action",{action:"hold"}):t.hasDoubleClick?"click"===e.type&&e.detail<2||!this.dblClickTimeout?this.dblClickTimeout=window.setTimeout((()=>{this.dblClickTimeout=void 0,po(s,"action",{action:"tap"})}),250):(clearTimeout(this.dblClickTimeout),this.dblClickTimeout=void 0,po(s,"action",{action:"double_tap"})):po(s,"action",{action:"tap"})},e.actionHandler.handleEnter=e=>{13===e.keyCode&&e.currentTarget.actionHandler.end(e)},e.addEventListener("touchstart",e.actionHandler.start,{passive:!0}),e.addEventListener("touchend",e.actionHandler.end),e.addEventListener("touchcancel",e.actionHandler.end),e.addEventListener("mousedown",e.actionHandler.start,{passive:!0}),e.addEventListener("click",e.actionHandler.end),e.addEventListener("keyup",e.actionHandler.handleEnter)))}startAnimation(e,t){Object.assign(this.style,{left:`${e}px`,top:`${t}px`,display:null}),this.ripple.disabled=!1,this.ripple.startPress(),this.ripple.unbounded=!0}stopAnimation(){this.ripple.endPress(),this.ripple.disabled=!0,this.style.display="none"}}customElements.define("cblcars-button-card-action-handler",fo);const yo=ro(class extends io{update(e,[t]){return((e,t)=>{const s=(()=>{const e=document.body;if(e.querySelector("cblcars-button-card-action-handler"))return e.querySelector("cblcars-button-card-action-handler");const t=document.createElement("cblcars-button-card-action-handler");return e.appendChild(t),t})();s&&s.bind(e,t)})(e.element,t),Ri}render(e){}});function bo(e,t){(function(e){return"string"==typeof e&&-1!==e.indexOf(".")&&1===parseFloat(e)})(e)&&(e="100%");var s=function(e){return"string"==typeof e&&-1!==e.indexOf("%")}(e);return e=360===t?e:Math.min(t,Math.max(0,parseFloat(e))),s&&(e=parseInt(String(e*t),10)/100),Math.abs(e-t)<1e-6?1:e=360===t?(e<0?e%t+t:e%t)/parseFloat(String(t)):e%t/parseFloat(String(t))}function _o(e){return Math.min(1,Math.max(0,e))}function vo(e){return e=parseFloat(e),(isNaN(e)||e<0||e>1)&&(e=1),e}function wo(e){return e<=1?"".concat(100*Number(e),"%"):e}function So(e){return 1===e.length?"0"+e:String(e)}function xo(e,t,s){e=bo(e,255),t=bo(t,255),s=bo(s,255);var n=Math.max(e,t,s),r=Math.min(e,t,s),i=0,o=0,a=(n+r)/2;if(n===r)o=0,i=0;else{var l=n-r;switch(o=a>.5?l/(2-n-r):l/(n+r),n){case e:i=(t-s)/l+(t<s?6:0);break;case t:i=(s-e)/l+2;break;case s:i=(e-t)/l+4}i/=6}return{h:i,s:o,l:a}}function $o(e,t,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*s*(t-e):s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e}function Co(e,t,s){e=bo(e,255),t=bo(t,255),s=bo(s,255);var n=Math.max(e,t,s),r=Math.min(e,t,s),i=0,o=n,a=n-r,l=0===n?0:a/n;if(n===r)i=0;else{switch(n){case e:i=(t-s)/a+(t<s?6:0);break;case t:i=(s-e)/a+2;break;case s:i=(e-t)/a+4}i/=6}return{h:i,s:l,v:o}}function ko(e,t,s,n){var r=[So(Math.round(e).toString(16)),So(Math.round(t).toString(16)),So(Math.round(s).toString(16))];return n&&r[0].startsWith(r[0].charAt(1))&&r[1].startsWith(r[1].charAt(1))&&r[2].startsWith(r[2].charAt(1))?r[0].charAt(0)+r[1].charAt(0)+r[2].charAt(0):r.join("")}function Ao(e){return Math.round(255*parseFloat(e)).toString(16)}function Mo(e){return Do(e)/255}function Do(e){return parseInt(e,16)}var Eo={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",goldenrod:"#daa520",gold:"#ffd700",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavenderblush:"#fff0f5",lavender:"#e6e6fa",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},To="(?:".concat("[-\\+]?\\d*\\.\\d+%?",")|(?:").concat("[-\\+]?\\d+%?",")"),Ro="[\\s|\\(]+(".concat(To,")[,|\\s]+(").concat(To,")[,|\\s]+(").concat(To,")\\s*\\)?"),Oo="[\\s|\\(]+(".concat(To,")[,|\\s]+(").concat(To,")[,|\\s]+(").concat(To,")[,|\\s]+(").concat(To,")\\s*\\)?"),Lo={CSS_UNIT:new RegExp(To),rgb:new RegExp("rgb"+Ro),rgba:new RegExp("rgba"+Oo),hsl:new RegExp("hsl"+Ro),hsla:new RegExp("hsla"+Oo),hsv:new RegExp("hsv"+Ro),hsva:new RegExp("hsva"+Oo),hex3:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex4:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex8:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/};function Po(e){return Boolean(Lo.CSS_UNIT.exec(String(e)))}var No=function(){function e(t,s){var n;if(void 0===t&&(t=""),void 0===s&&(s={}),t instanceof e)return t;"number"==typeof t&&(t=function(e){return{r:e>>16,g:(65280&e)>>8,b:255&e}}(t)),this.originalInput=t;var r=function(e){var t={r:0,g:0,b:0},s=1,n=null,r=null,i=null,o=!1,a=!1;return"string"==typeof e&&(e=function(e){if(0===(e=e.trim().toLowerCase()).length)return!1;var t=!1;if(Eo[e])e=Eo[e],t=!0;else if("transparent"===e)return{r:0,g:0,b:0,a:0,format:"name"};var s=Lo.rgb.exec(e);return s?{r:s[1],g:s[2],b:s[3]}:(s=Lo.rgba.exec(e))?{r:s[1],g:s[2],b:s[3],a:s[4]}:(s=Lo.hsl.exec(e))?{h:s[1],s:s[2],l:s[3]}:(s=Lo.hsla.exec(e))?{h:s[1],s:s[2],l:s[3],a:s[4]}:(s=Lo.hsv.exec(e))?{h:s[1],s:s[2],v:s[3]}:(s=Lo.hsva.exec(e))?{h:s[1],s:s[2],v:s[3],a:s[4]}:(s=Lo.hex8.exec(e))?{r:Do(s[1]),g:Do(s[2]),b:Do(s[3]),a:Mo(s[4]),format:t?"name":"hex8"}:(s=Lo.hex6.exec(e))?{r:Do(s[1]),g:Do(s[2]),b:Do(s[3]),format:t?"name":"hex"}:(s=Lo.hex4.exec(e))?{r:Do(s[1]+s[1]),g:Do(s[2]+s[2]),b:Do(s[3]+s[3]),a:Mo(s[4]+s[4]),format:t?"name":"hex8"}:!!(s=Lo.hex3.exec(e))&&{r:Do(s[1]+s[1]),g:Do(s[2]+s[2]),b:Do(s[3]+s[3]),format:t?"name":"hex"}}(e)),"object"==typeof e&&(Po(e.r)&&Po(e.g)&&Po(e.b)?(t=function(e,t,s){return{r:255*bo(e,255),g:255*bo(t,255),b:255*bo(s,255)}}(e.r,e.g,e.b),o=!0,a="%"===String(e.r).substr(-1)?"prgb":"rgb"):Po(e.h)&&Po(e.s)&&Po(e.v)?(n=wo(e.s),r=wo(e.v),t=function(e,t,s){e=6*bo(e,360),t=bo(t,100),s=bo(s,100);var n=Math.floor(e),r=e-n,i=s*(1-t),o=s*(1-r*t),a=s*(1-(1-r)*t),l=n%6;return{r:255*[s,o,i,i,a,s][l],g:255*[a,s,s,o,i,i][l],b:255*[i,i,a,s,s,o][l]}}(e.h,n,r),o=!0,a="hsv"):Po(e.h)&&Po(e.s)&&Po(e.l)&&(n=wo(e.s),i=wo(e.l),t=function(e,t,s){var n,r,i;if(e=bo(e,360),t=bo(t,100),s=bo(s,100),0===t)r=s,i=s,n=s;else{var o=s<.5?s*(1+t):s+t-s*t,a=2*s-o;n=$o(a,o,e+1/3),r=$o(a,o,e),i=$o(a,o,e-1/3)}return{r:255*n,g:255*r,b:255*i}}(e.h,n,i),o=!0,a="hsl"),Object.prototype.hasOwnProperty.call(e,"a")&&(s=e.a)),s=vo(s),{ok:o,format:e.format||a,r:Math.min(255,Math.max(t.r,0)),g:Math.min(255,Math.max(t.g,0)),b:Math.min(255,Math.max(t.b,0)),a:s}}(t);this.originalInput=t,this.r=r.r,this.g=r.g,this.b=r.b,this.a=r.a,this.roundA=Math.round(100*this.a)/100,this.format=null!==(n=s.format)&&void 0!==n?n:r.format,this.gradientType=s.gradientType,this.r<1&&(this.r=Math.round(this.r)),this.g<1&&(this.g=Math.round(this.g)),this.b<1&&(this.b=Math.round(this.b)),this.isValid=r.ok}return e.prototype.isDark=function(){return this.getBrightness()<128},e.prototype.isLight=function(){return!this.isDark()},e.prototype.getBrightness=function(){var e=this.toRgb();return(299*e.r+587*e.g+114*e.b)/1e3},e.prototype.getLuminance=function(){var e=this.toRgb(),t=e.r/255,s=e.g/255,n=e.b/255;return.2126*(t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.7152*(s<=.03928?s/12.92:Math.pow((s+.055)/1.055,2.4))+.0722*(n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4))},e.prototype.getAlpha=function(){return this.a},e.prototype.setAlpha=function(e){return this.a=vo(e),this.roundA=Math.round(100*this.a)/100,this},e.prototype.isMonochrome=function(){return 0===this.toHsl().s},e.prototype.toHsv=function(){var e=Co(this.r,this.g,this.b);return{h:360*e.h,s:e.s,v:e.v,a:this.a}},e.prototype.toHsvString=function(){var e=Co(this.r,this.g,this.b),t=Math.round(360*e.h),s=Math.round(100*e.s),n=Math.round(100*e.v);return 1===this.a?"hsv(".concat(t,", ").concat(s,"%, ").concat(n,"%)"):"hsva(".concat(t,", ").concat(s,"%, ").concat(n,"%, ").concat(this.roundA,")")},e.prototype.toHsl=function(){var e=xo(this.r,this.g,this.b);return{h:360*e.h,s:e.s,l:e.l,a:this.a}},e.prototype.toHslString=function(){var e=xo(this.r,this.g,this.b),t=Math.round(360*e.h),s=Math.round(100*e.s),n=Math.round(100*e.l);return 1===this.a?"hsl(".concat(t,", ").concat(s,"%, ").concat(n,"%)"):"hsla(".concat(t,", ").concat(s,"%, ").concat(n,"%, ").concat(this.roundA,")")},e.prototype.toHex=function(e){return void 0===e&&(e=!1),ko(this.r,this.g,this.b,e)},e.prototype.toHexString=function(e){return void 0===e&&(e=!1),"#"+this.toHex(e)},e.prototype.toHex8=function(e){return void 0===e&&(e=!1),function(e,t,s,n,r){var i=[So(Math.round(e).toString(16)),So(Math.round(t).toString(16)),So(Math.round(s).toString(16)),So(Ao(n))];return r&&i[0].startsWith(i[0].charAt(1))&&i[1].startsWith(i[1].charAt(1))&&i[2].startsWith(i[2].charAt(1))&&i[3].startsWith(i[3].charAt(1))?i[0].charAt(0)+i[1].charAt(0)+i[2].charAt(0)+i[3].charAt(0):i.join("")}(this.r,this.g,this.b,this.a,e)},e.prototype.toHex8String=function(e){return void 0===e&&(e=!1),"#"+this.toHex8(e)},e.prototype.toHexShortString=function(e){return void 0===e&&(e=!1),1===this.a?this.toHexString(e):this.toHex8String(e)},e.prototype.toRgb=function(){return{r:Math.round(this.r),g:Math.round(this.g),b:Math.round(this.b),a:this.a}},e.prototype.toRgbString=function(){var e=Math.round(this.r),t=Math.round(this.g),s=Math.round(this.b);return 1===this.a?"rgb(".concat(e,", ").concat(t,", ").concat(s,")"):"rgba(".concat(e,", ").concat(t,", ").concat(s,", ").concat(this.roundA,")")},e.prototype.toPercentageRgb=function(){var e=function(e){return"".concat(Math.round(100*bo(e,255)),"%")};return{r:e(this.r),g:e(this.g),b:e(this.b),a:this.a}},e.prototype.toPercentageRgbString=function(){var e=function(e){return Math.round(100*bo(e,255))};return 1===this.a?"rgb(".concat(e(this.r),"%, ").concat(e(this.g),"%, ").concat(e(this.b),"%)"):"rgba(".concat(e(this.r),"%, ").concat(e(this.g),"%, ").concat(e(this.b),"%, ").concat(this.roundA,")")},e.prototype.toName=function(){if(0===this.a)return"transparent";if(this.a<1)return!1;for(var e="#"+ko(this.r,this.g,this.b,!1),t=0,s=Object.entries(Eo);t<s.length;t++){var n=s[t],r=n[0];if(e===n[1])return r}return!1},e.prototype.toString=function(e){var t=Boolean(e);e=null!=e?e:this.format;var s=!1,n=this.a<1&&this.a>=0;return t||!n||!e.startsWith("hex")&&"name"!==e?("rgb"===e&&(s=this.toRgbString()),"prgb"===e&&(s=this.toPercentageRgbString()),"hex"!==e&&"hex6"!==e||(s=this.toHexString()),"hex3"===e&&(s=this.toHexString(!0)),"hex4"===e&&(s=this.toHex8String(!0)),"hex8"===e&&(s=this.toHex8String()),"name"===e&&(s=this.toName()),"hsl"===e&&(s=this.toHslString()),"hsv"===e&&(s=this.toHsvString()),s||this.toHexString()):"name"===e&&0===this.a?this.toName():this.toRgbString()},e.prototype.toNumber=function(){return(Math.round(this.r)<<16)+(Math.round(this.g)<<8)+Math.round(this.b)},e.prototype.clone=function(){return new e(this.toString())},e.prototype.lighten=function(t){void 0===t&&(t=10);var s=this.toHsl();return s.l+=t/100,s.l=_o(s.l),new e(s)},e.prototype.brighten=function(t){void 0===t&&(t=10);var s=this.toRgb();return s.r=Math.max(0,Math.min(255,s.r-Math.round(-t/100*255))),s.g=Math.max(0,Math.min(255,s.g-Math.round(-t/100*255))),s.b=Math.max(0,Math.min(255,s.b-Math.round(-t/100*255))),new e(s)},e.prototype.darken=function(t){void 0===t&&(t=10);var s=this.toHsl();return s.l-=t/100,s.l=_o(s.l),new e(s)},e.prototype.tint=function(e){return void 0===e&&(e=10),this.mix("white",e)},e.prototype.shade=function(e){return void 0===e&&(e=10),this.mix("black",e)},e.prototype.desaturate=function(t){void 0===t&&(t=10);var s=this.toHsl();return s.s-=t/100,s.s=_o(s.s),new e(s)},e.prototype.saturate=function(t){void 0===t&&(t=10);var s=this.toHsl();return s.s+=t/100,s.s=_o(s.s),new e(s)},e.prototype.greyscale=function(){return this.desaturate(100)},e.prototype.spin=function(t){var s=this.toHsl(),n=(s.h+t)%360;return s.h=n<0?360+n:n,new e(s)},e.prototype.mix=function(t,s){void 0===s&&(s=50);var n=this.toRgb(),r=new e(t).toRgb(),i=s/100;return new e({r:(r.r-n.r)*i+n.r,g:(r.g-n.g)*i+n.g,b:(r.b-n.b)*i+n.b,a:(r.a-n.a)*i+n.a})},e.prototype.analogous=function(t,s){void 0===t&&(t=6),void 0===s&&(s=30);var n=this.toHsl(),r=360/s,i=[this];for(n.h=(n.h-(r*t>>1)+720)%360;--t;)n.h=(n.h+r)%360,i.push(new e(n));return i},e.prototype.complement=function(){var t=this.toHsl();return t.h=(t.h+180)%360,new e(t)},e.prototype.monochromatic=function(t){void 0===t&&(t=6);for(var s=this.toHsv(),n=s.h,r=s.s,i=s.v,o=[],a=1/t;t--;)o.push(new e({h:n,s:r,v:i})),i=(i+a)%1;return o},e.prototype.splitcomplement=function(){var t=this.toHsl(),s=t.h;return[this,new e({h:(s+72)%360,s:t.s,l:t.l}),new e({h:(s+216)%360,s:t.s,l:t.l})]},e.prototype.onBackground=function(t){var s=this.toRgb(),n=new e(t).toRgb(),r=s.a+n.a*(1-s.a);return new e({r:(s.r*s.a+n.r*n.a*(1-s.a))/r,g:(s.g*s.a+n.g*n.a*(1-s.a))/r,b:(s.b*s.a+n.b*n.a*(1-s.a))/r,a:r})},e.prototype.triad=function(){return this.polyad(3)},e.prototype.tetrad=function(){return this.polyad(4)},e.prototype.polyad=function(t){for(var s=this.toHsl(),n=s.h,r=[this],i=360/t,o=1;o<t;o++)r.push(new e({h:(n+o*i)%360,s:s.s,l:s.l}));return r},e.prototype.equals=function(t){return this.toRgbString()===new e(t).toRgbString()},e}();function Fo(e,t){return void 0===e&&(e=""),void 0===t&&(t={}),new No(e,t)}const Bo="unavailable",Io=(zo=[Bo,"unknown"],(e,t)=>zo.includes(e,t));var zo;const jo=new Set(["fan","input_boolean","light","switch","group","automation","humidifier"]),Ho=["auto","auto-no-temperature"],Uo=["card","label-card"],Go=["--ha-card-background","--card-background-color"],Vo="var(--primary-text-color)";function qo(e){return e.substr(0,e.indexOf("."))}function Wo(e,t){const s=[];let n=t;return"var"===t.trim().substring(0,3)&&(t.split(",").forEach((e=>{const t=e.match(/var\(\s*([a-zA-Z0-9-]*)/);t&&s.push(t[1])})),s.some((t=>{const s=window.getComputedStyle(e).getPropertyValue(t);return!!s&&(n=s,!0)}))),n}function Yo(...e){const t=e=>e&&"object"==typeof e;return e.reduce(((e,s)=>(Object.keys(s).forEach((n=>{const r=e[n],i=s[n];Array.isArray(r)&&Array.isArray(i)?e[n]=r.concat(...i):t(r)&&t(i)?e[n]=Yo(r,i):e[n]=i})),e)),{})}function Xo(e,t){let s=[];return e&&e.forEach((e=>{let n=e;t&&t.forEach((t=>{t.id&&e.id&&t.id==e.id&&(n=Yo(n,t))})),s.push(n)})),t&&(s=s.concat(t.filter((t=>!e||!e.find((e=>!(!e.id||!t.id)&&e.id==t.id)))))),s}function Jo(e,t){if(void 0===e)return!1;const s=qo(e.entity_id),n=void 0!==t?t:null==e?void 0:e.state;if(["button","event","input_button","scene"].includes(s))return n!==Bo;if(Io(n))return!1;if("off"===n&&"alert"!==s)return!1;switch(s){case"alarm_control_panel":return"disarmed"!==n;case"alert":return"idle"!==n;case"cover":return"closed"!==n;case"device_tracker":case"person":return"not_home"!==n;case"lock":return"locked"!==n;case"media_player":return"standby"!==n;case"vacuum":return!["idle","docked","paused"].includes(n);case"plant":return"problem"===n;case"group":return["on","home","open","locked","problem"].includes(n);case"timer":return"active"===n;case"camera":return"streaming"===n}return!0}function Zo(e){return Array.isArray(e)?e.reverse().reduce(((e,t)=>`var(${t}${e?`, ${e}`:""})`),void 0):`var(${e})`}function Ko(e){const t=e.split(":").map(Number);return 3600*t[0]+60*t[1]+t[2]}const Qo=e=>e<10?`0${e}`:e,ea=new Set(["call-service","divider","section","weblink","cast","select"]),ta={alert:"toggle",automation:"toggle",climate:"climate",cover:"cover",fan:"toggle",group:"group",input_boolean:"toggle",input_number:"input-number",input_select:"input-select",input_text:"input-text",light:"toggle",lock:"lock",media_player:"media-player",remote:"toggle",scene:"scene",script:"script",sensor:"sensor",timer:"timer",switch:"toggle",vacuum:"toggle",water_heater:"climate",input_datetime:"input-datetime"},sa=((e,...t)=>{const s=1===e.length?e[0]:t.reduce(((t,s,n)=>t+(e=>{if(!0===e._$cssResult$)return e.cssText;if("number"==typeof e)return e;throw Error("Value passed to 'css' function must be a 'css' function result: "+e+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(s)+e[n+1]),e[0]);return new Qr(s,e,Zr)})`
  :host {
    position: relative;
    display: block;
    --state-inactive-color: var(--paper-item-icon-color);
  }
  ha-card {
    cursor: pointer;
    overflow: hidden;
    box-sizing: border-box;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    line-height: normal;

    -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
    -khtml-user-select: none; /* Konqueror HTML */
    -moz-user-select: none; /* Old versions of Firefox */
    -ms-user-select: none; /* Internet Explorer/Edge */
    user-select: none; /* Non-prefixed version, currently
                          supported by Chrome, Opera and Firefox */
  }
  ha-card.disabled {
    pointer-events: none;
    cursor: default;
  }
  :host(.tooltip) .tooltiptext {
    pointer-events: none;
    opacity: 0;
    text-align: center;
    padding: 4px;
    border-radius: var(--ha-card-border-radius, 4px);
    box-shadow: var(
      --ha-card-box-shadow,
      0px 2px 1px -1px rgba(0, 0, 0, 0.2),
      0px 1px 1px 0px rgba(0, 0, 0, 0.14),
      0px 1px 3px 0px rgba(0, 0, 0, 0.12)
    );
    background: var(--ha-card-background, var(--card-background-color, white));
    border: 1px solid var(--primary-text-color);
    color: var(--primary-text-color);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  :host(.tooltip:hover) span.tooltiptext {
    opacity: 1;
    transition-delay: 1.5s;
  }
  :not(ha-state-icon) ha-icon,
  ha-state-icon {
    display: inline-block;
    margin: auto;
    --mdc-icon-size: 100%;
    --iron-icon-width: 100%;
    --iron-icon-height: 100%;
  }
  ha-card.button-card-main {
    padding: 4% 0px;
    text-transform: none;
    font-weight: 400;
    font-size: 1.2rem;
    align-items: center;
    text-align: center;
    letter-spacing: normal;
    width: 100%;
  }
  .ellipsis {
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
  }

  #overlay {
    align-items: flex-start;
    justify-content: flex-end;
    padding: 8px 7px;
    opacity: 0.5;
    /* DO NOT override items below */
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    display: flex;
  }
  #lock {
    -webkit-animation-fill-mode: both;
    animation-fill-mode: both;
    margin: unset;
    width: 24px;
  }
  .invalid {
    animation: blink 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
  }
  .hidden {
    visibility: hidden;
    opacity: 0;
    transition: visibility 0s 1s, opacity 1s linear;
  }
  @keyframes blink {
    0% {
      opacity: 0;
    }
    50% {
      opacity: 1;
    }
    100% {
      opacity: 0;
    }
  }
  @-webkit-keyframes rotating /* Safari and Chrome */ {
    from {
      -webkit-transform: rotate(0deg);
      -o-transform: rotate(0deg);
      transform: rotate(0deg);
    }
    to {
      -webkit-transform: rotate(360deg);
      -o-transform: rotate(360deg);
      transform: rotate(360deg);
    }
  }
  @keyframes rotating {
    from {
      -ms-transform: rotate(0deg);
      -moz-transform: rotate(0deg);
      -webkit-transform: rotate(0deg);
      -o-transform: rotate(0deg);
      transform: rotate(0deg);
    }
    to {
      -ms-transform: rotate(360deg);
      -moz-transform: rotate(360deg);
      -webkit-transform: rotate(360deg);
      -o-transform: rotate(360deg);
      transform: rotate(360deg);
    }
  }
  [rotating] {
    -webkit-animation: rotating 2s linear infinite;
    -moz-animation: rotating 2s linear infinite;
    -ms-animation: rotating 2s linear infinite;
    -o-animation: rotating 2s linear infinite;
    animation: rotating 2s linear infinite;
  }

  #container {
    display: grid;
    width: 100%;
    height: 100%;
    text-align: center;
    align-items: center;
  }
  #img-cell {
    display: flex;
    grid-area: i;
    height: 100%;
    width: 100%;
    max-width: 100%;
    max-height: 100%;
    align-self: center;
    justify-self: center;
    overflow: hidden;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  ha-state-icon#icon {
    height: 100%;
    width: 100%;
    max-height: 100%;
    position: absolute;
  }
  img#icon {
    display: block;
    height: auto;
    width: 100%;
    position: absolute;
  }
  #name {
    grid-area: n;
    max-width: 100%;
    align-self: center;
    justify-self: center;
    /* margin: auto; */
  }
  #state {
    grid-area: s;
    max-width: 100%;
    align-self: center;
    justify-self: center;
    /* margin: auto; */
  }

  #label {
    grid-area: l;
    max-width: 100%;
    align-self: center;
    justify-self: center;
  }

  #container.vertical {
    grid-template-areas: 'i' 'n' 's' 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr min-content min-content min-content;
  }
  /* Vertical No Icon */
  #container.vertical.no-icon {
    grid-template-areas: 'n' 's' 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr min-content 1fr;
  }
  #container.vertical.no-icon #state {
    align-self: center;
  }
  #container.vertical.no-icon #name {
    align-self: end;
  }
  #container.vertical.no-icon #label {
    align-self: start;
  }

  /* Vertical No Icon No Name */
  #container.vertical.no-icon.no-name {
    grid-template-areas: 's' 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 1fr;
  }
  #container.vertical.no-icon.no-name #state {
    align-self: end;
  }
  #container.vertical.no-icon.no-name #label {
    align-self: start;
  }

  /* Vertical No Icon No State */
  #container.vertical.no-icon.no-state {
    grid-template-areas: 'n' 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 1fr;
  }
  #container.vertical.no-icon.no-state #name {
    align-self: end;
  }
  #container.vertical.no-icon.no-state #label {
    align-self: start;
  }

  /* Vertical No Icon No Label */
  #container.vertical.no-icon.no-label {
    grid-template-areas: 'n' 's';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 1fr;
  }
  #container.vertical.no-icon.no-label #name {
    align-self: end;
  }
  #container.vertical.no-icon.no-label #state {
    align-self: start;
  }

  /* Vertical No Icon No Label No Name */
  #container.vertical.no-icon.no-label.no-name {
    grid-template-areas: 's';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
  }
  #container.vertical.no-icon.no-label.no-name #state {
    align-self: center;
  }
  /* Vertical No Icon No Label No State */
  #container.vertical.no-icon.no-label.no-state {
    grid-template-areas: 'n';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
  }
  #container.vertical.no-icon.no-label.no-state #name {
    align-self: center;
  }

  /* Vertical No Icon No Name No State */
  #container.vertical.no-icon.no-name.no-state {
    grid-template-areas: 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
  }
  #container.vertical.no-icon.no-name.no-state #label {
    align-self: center;
  }

  #container.icon_name_state {
    grid-template-areas: 'i n' 'l l';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr min-content;
  }

  #container.icon_name {
    grid-template-areas: 'i n' 's s' 'l l';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr min-content min-content;
  }

  #container.icon_state {
    grid-template-areas: 'i s' 'n n' 'l l';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr min-content min-content;
  }

  #container.name_state {
    grid-template-areas: 'i' 'n' 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr min-content min-content;
  }
  #container.name_state.no-icon {
    grid-template-areas: 'n' 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 1fr;
  }
  #container.name_state.no-icon #name {
    align-self: end;
  }
  #container.name_state.no-icon #label {
    align-self: start;
  }

  #container.name_state.no-icon.no-label {
    grid-template-areas: 'n';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
  }
  #container.name_state.no-icon.no-label #name {
    align-self: center;
  }

  /* icon_name_state2nd default */
  #container.icon_name_state2nd {
    grid-template-areas: 'i n' 'i s' 'i l';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr min-content 1fr;
  }
  #container.icon_name_state2nd #name {
    align-self: end;
  }
  #container.icon_name_state2nd #state {
    align-self: center;
  }
  #container.icon_name_state2nd #label {
    align-self: start;
  }

  /* icon_name_state2nd No Label */
  #container.icon_name_state2nd.no-label {
    grid-template-areas: 'i n' 'i s';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr 1fr;
  }
  #container.icon_name_state2nd #name {
    align-self: end;
  }
  #container.icon_name_state2nd #state {
    align-self: start;
  }

  /* icon_state_name2nd Default */
  #container.icon_state_name2nd {
    grid-template-areas: 'i s' 'i n' 'i l';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr min-content 1fr;
  }
  #container.icon_state_name2nd #state {
    align-self: end;
  }
  #container.icon_state_name2nd #name {
    align-self: center;
  }
  #container.icon_state_name2nd #label {
    align-self: start;
  }

  /* icon_state_name2nd No Label */
  #container.icon_state_name2nd.no-label {
    grid-template-areas: 'i s' 'i n';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr 1fr;
  }
  #container.icon_state_name2nd #state {
    align-self: end;
  }
  #container.icon_state_name2nd #name {
    align-self: start;
  }

  #container.icon_label {
    grid-template-areas: 'i l' 'n n' 's s';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr min-content min-content;
  }

  [style*='--aspect-ratio'] > :first-child {
    width: 100%;
  }
  [style*='--aspect-ratio'] > img {
    height: auto;
  }
  @supports (--custom: property) {
    [style*='--aspect-ratio'] {
      position: relative;
    }
    [style*='--aspect-ratio']::before {
      content: '';
      display: block;
      padding-bottom: calc(100% / (var(--aspect-ratio)));
    }
    [style*='--aspect-ratio'] > :first-child {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
    }
  }
`;var na,ra,ia,oa,aa;!function(e){e.language="language",e.system="system",e.comma_decimal="comma_decimal",e.decimal_comma="decimal_comma",e.space_comma="space_comma",e.none="none"}(na||(na={})),function(e){e.language="language",e.system="system",e.am_pm="12",e.twenty_four="24"}(ra||(ra={})),function(e){e.local="local",e.server="server"}(ia||(ia={})),function(e){e.language="language",e.system="system",e.DMY="DMY",e.MDY="MDY",e.YMD="YMD"}(oa||(oa={})),function(e){e.language="language",e.monday="monday",e.tuesday="tuesday",e.wednesday="wednesday",e.thursday="thursday",e.friday="friday",e.saturday="saturday",e.sunday="sunday"}(aa||(aa={}));const la=(e,t,s)=>{const n=t?(e=>{switch(e.number_format){case na.comma_decimal:return["en-US","en"];case na.decimal_comma:return["de","es","it"];case na.space_comma:return["fr","sv","cs"];case na.system:return;default:return e.language}})(t):void 0;if(Number.isNaN=Number.isNaN||function e(t){return"number"==typeof t&&e(t)},(null==t?void 0:t.number_format)!==na.none&&!Number.isNaN(Number(e))&&Intl)try{return new Intl.NumberFormat(n,da(e,s)).format(Number(e))}catch(t){return console.error(t),new Intl.NumberFormat(void 0,da(e,s)).format(Number(e))}return"string"==typeof e?e:`${((e,t=2)=>Math.round(e*10**t)/10**t)(e,null==s?void 0:s.maximumFractionDigits).toString()}${"currency"===(null==s?void 0:s.style)?` ${s.currency}`:""}`},ca=(e,t,s)=>{var n;let r=null==s?void 0:s.display_precision;return void 0!==t&&(r=t),null!=r?{maximumFractionDigits:r,minimumFractionDigits:r}:Number.isInteger(Number(null===(n=e.attributes)||void 0===n?void 0:n.step))&&Number.isInteger(Number(e.state))?{maximumFractionDigits:0}:null!=e.attributes.step?{maximumFractionDigits:Math.ceil(Math.log10(1/e.attributes.step))}:void 0},da=(e,t)=>{const s=Object.assign({maximumFractionDigits:2},t);if("string"!=typeof e)return s;if(!t||void 0===t.minimumFractionDigits&&void 0===t.maximumFractionDigits){const t=e.indexOf(".")>-1?e.split(".")[1].length:0;s.minimumFractionDigits=t,s.maximumFractionDigits=t}return s};var ua,ha,pa,ga,ma;!function(e){e.language="language",e.system="system",e.comma_decimal="comma_decimal",e.decimal_comma="decimal_comma",e.space_comma="space_comma",e.none="none"}(ua||(ua={})),function(e){e.language="language",e.system="system",e.am_pm="12",e.twenty_four="24"}(ha||(ha={})),function(e){e.local="local",e.server="server"}(pa||(pa={})),function(e){e.language="language",e.system="system",e.DMY="DMY",e.MDY="MDY",e.YMD="YMD"}(ga||(ga={})),function(e){e.language="language",e.monday="monday",e.tuesday="tuesday",e.wednesday="wednesday",e.thursday="thursday",e.friday="friday",e.saturday="saturday",e.sunday="sunday"}(ma||(ma={}));const fa=(e,t=2)=>{let s=""+e;for(let e=1;e<t;e++)s=parseInt(s)<10**e?`0${s}`:s;return s},ya={ms:1,s:1e3,min:6e4,h:36e5,d:864e5};var ba=Number.isNaN||function(e){return"number"==typeof e&&e!=e};function _a(e,t){if(e.length!==t.length)return!1;for(var s=0;s<e.length;s++)if(!((n=e[s])===(r=t[s])||ba(n)&&ba(r)))return!1;var n,r;return!0}function va(e,t){void 0===t&&(t=_a);var s=null;function n(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];if(s&&s.lastThis===this&&t(n,s.lastArgs))return s.lastResult;var i=e.apply(this,n);return s={lastResult:i,lastArgs:n,lastThis:this},i}return n.clear=function(){s=null},n}const wa=va(((e,t)=>new Intl.DateTimeFormat(e.language,{weekday:"long",month:"long",day:"numeric",timeZone:"server"===e.time_zone?t:void 0}))),Sa=(e,t,s)=>xa(t,s.time_zone).format(e),xa=va(((e,t)=>new Intl.DateTimeFormat(e.language,{year:"numeric",month:"long",day:"numeric",timeZone:"server"===e.time_zone?t:void 0}))),$a=(e,t,s)=>{var n,r,i,o;const a=Ca(t,s.time_zone);if(t.date_format===oa.language||t.date_format===oa.system)return a.format(e);const l=a.formatToParts(e),c=null===(n=l.find((e=>"literal"===e.type)))||void 0===n?void 0:n.value,d=null===(r=l.find((e=>"day"===e.type)))||void 0===r?void 0:r.value,u=null===(i=l.find((e=>"month"===e.type)))||void 0===i?void 0:i.value,h=null===(o=l.find((e=>"year"===e.type)))||void 0===o?void 0:o.value,p=l[l.length-1];let g="literal"===(null==p?void 0:p.type)?null==p?void 0:p.value:"";return"bg"===t.language&&t.date_format===oa.YMD&&(g=""),{[oa.DMY]:`${d}${c}${u}${c}${h}${g}`,[oa.MDY]:`${u}${c}${d}${c}${h}${g}`,[oa.YMD]:`${h}${c}${u}${c}${d}${g}`}[t.date_format]},Ca=va(((e,t)=>{const s=e.date_format===oa.system?void 0:e.language;return e.date_format===oa.language||(e.date_format,oa.system),new Intl.DateTimeFormat(s,{year:"numeric",month:"numeric",day:"numeric",timeZone:"server"===e.time_zone?t:void 0})})),ka=va(((e,t)=>new Intl.DateTimeFormat(e.language,{day:"numeric",month:"short",timeZone:"server"===e.time_zone?t:void 0}))),Aa=va(((e,t)=>new Intl.DateTimeFormat(e.language,{month:"long",year:"numeric",timeZone:"server"===e.time_zone?t:void 0}))),Ma=va(((e,t)=>new Intl.DateTimeFormat(e.language,{month:"long",timeZone:"server"===e.time_zone?t:void 0}))),Da=va(((e,t)=>new Intl.DateTimeFormat(e.language,{year:"numeric",timeZone:"server"===e.time_zone?t:void 0}))),Ea=va(((e,t)=>new Intl.DateTimeFormat(e.language,{weekday:"long",timeZone:"server"===e.time_zone?t:void 0}))),Ta=va(((e,t)=>new Intl.DateTimeFormat(e.language,{weekday:"short",timeZone:"server"===e.time_zone?t:void 0}))),Ra=va((e=>{if(e.time_format===ra.language||e.time_format===ra.system){const t=e.time_format===ra.language?e.language:void 0,s=(new Date).toLocaleString(t);return s.includes("AM")||s.includes("PM")}return e.time_format===ra.am_pm})),Oa=(e,t,s)=>La(t,s.time_zone).format(e),La=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{hour:"numeric",minute:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),Pa=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{hour:Ra(e)?"numeric":"2-digit",minute:"2-digit",second:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),Na=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{weekday:"long",hour:Ra(e)?"numeric":"2-digit",minute:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),Fa=va(((e,t)=>new Intl.DateTimeFormat("en-GB",{hour:"numeric",minute:"2-digit",hour12:!1,timeZone:"server"===e.time_zone?t:void 0}))),Ba=(e,t,s)=>Ia(t,s.time_zone).format(e),Ia=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{year:"numeric",month:"long",day:"numeric",hour:Ra(e)?"numeric":"2-digit",minute:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),za=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{year:"numeric",month:"short",day:"numeric",hour:Ra(e)?"numeric":"2-digit",minute:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),ja=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{month:"short",day:"numeric",hour:Ra(e)?"numeric":"2-digit",minute:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),Ha=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{year:"numeric",month:"long",day:"numeric",hour:Ra(e)?"numeric":"2-digit",minute:"2-digit",second:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),Ua=(e,t)=>!!(e.supported_features&t),Ga=(e,t,s,n,r,i,o)=>{const a=r[t.entity_id];return Va(e,s,n,a,t.entity_id,t.attributes,i,void 0!==o?o:t.state)},Va=(e,t,s,n,r,i,o,a)=>{var l;if("unknown"===a||"unavailable"===a)return e(`state.default.${a}`);if(function(e){return!!e.unit_of_measurement||!!e.state_class}(i)){if("duration"===i.device_class&&i.unit_of_measurement&&ya[i.unit_of_measurement])try{return((e,t)=>function(e){const t=Math.floor(e/1e3/3600),s=Math.floor(e/1e3%3600/60),n=Math.floor(e/1e3%3600%60),r=Math.floor(e%1e3);return t>0?`${t}:${fa(s)}:${fa(n)}`:s>0?`${s}:${fa(n)}`:n>0||r>0?`${n}${r>0?`.${fa(r,3)}`:""}`:null}(parseFloat(e)*ya[t])||"0")(a,i.unit_of_measurement)}catch(e){}if("monetary"===i.device_class)try{return la(a,t,Object.assign({style:"currency",currency:(null==o?void 0:o.units)||i.unit_of_measurement,minimumFractionDigits:2},ca({state:a,attributes:i},null==o?void 0:o.numeric_precision,n)))}catch(e){}const e=(null==o?void 0:o.show_units)?(null==o?void 0:o.units)?null==o?void 0:o.units:i.unit_of_measurement:void 0,s=e?"%"===e?(e=>{switch(e.language){case"cz":case"de":case"fi":case"fr":case"sk":case"sv":return" ";default:return""}})(t)+"%":` ${e}`:"";return`${la(a,t,ca({state:a,attributes:i},null==o?void 0:o.numeric_precision,n))}${s}`}const c=qo(r);if("datetime"===c){const e=new Date(a);return Ba(e,t,s)}if(["date","input_datetime","time"].includes(c))try{const e=a.split(" ");if(2===e.length)return Ba(new Date(e.join("T")),Object.assign(Object.assign({},t),{time_zone:pa.local}),s);if(1===e.length){if(a.includes("-"))return Sa(new Date(`${a}T00:00`),Object.assign(Object.assign({},t),{time_zone:pa.local}),s);if(a.includes(":")){const e=new Date;return Oa(new Date(`${e.toISOString().split("T")[0]}T${a}`),Object.assign(Object.assign({},t),{time_zone:pa.local}),s)}}return a}catch(e){return a}if("counter"===c||"number"===c||"input_number"===c)return la(a,t,ca({state:a,attributes:i},null==o?void 0:o.numeric_precision,n));if(["button","event","input_button","scene","stt","tts"].includes(c)||"sensor"===c&&"timestamp"===i.device_class)try{return Ba(new Date(a),t,s)}catch(e){return a}return"update"===c?"on"===a?(e=>(e=>Ua(e,4)&&"number"==typeof e.in_progress)(e)||!!e.in_progress)(i)?Ua(i,4)&&"number"==typeof i.in_progress?e("ui.card.update.installing_with_progress",{progress:i.in_progress}):e("ui.card.update.installing"):i.latest_version:i.skipped_version===i.latest_version?null!==(l=i.latest_version)&&void 0!==l?l:e("state.default.unavailable"):e("ui.card.update.up_to_date"):(null==n?void 0:n.translation_key)&&e(`component.${n.platform}.entity.${c}.${n.translation_key}.state.${a}`)||i.device_class&&e(`component.${c}.entity_component.${i.device_class}.state.${a}`)||e(`component.${c}.entity_component._.state.${a}`)||a};var qa=Function.prototype.toString,Wa=Object.create,Ya=Object.defineProperty,Xa=Object.getOwnPropertyDescriptor,Ja=Object.getOwnPropertyNames,Za=Object.getOwnPropertySymbols,Ka=Object.getPrototypeOf,Qa=Object.prototype,el=Qa.hasOwnProperty,tl=Qa.propertyIsEnumerable,sl="function"==typeof Za,nl="function"==typeof WeakMap,rl=function(){if(nl)return function(){return new WeakMap};var e=function(){function e(){this._keys=[],this._values=[]}return e.prototype.has=function(e){return!!~this._keys.indexOf(e)},e.prototype.get=function(e){return this._values[this._keys.indexOf(e)]},e.prototype.set=function(e,t){this._keys.push(e),this._values.push(t)},e}();return function(){return new e}}(),il=function(e,t){var s=e.__proto__||Ka(e);if(!s)return Wa(null);var n=s.constructor;if(n===t.Object)return s===t.Object.prototype?{}:Wa(s);if(~qa.call(n).indexOf("[native code]"))try{return new n}catch(e){}return Wa(s)},ol=function(e,t,s,n){var r=il(e,t);for(var i in n.set(e,r),e)el.call(e,i)&&(r[i]=s(e[i],n));if(sl)for(var o=Za(e),a=0,l=o.length,c=void 0;a<l;++a)c=o[a],tl.call(e,c)&&(r[c]=s(e[c],n));return r},al=function(e,t,s,n){var r=il(e,t);n.set(e,r);for(var i=sl?Ja(e).concat(Za(e)):Ja(e),o=0,a=i.length,l=void 0,c=void 0;o<a;++o)if("callee"!==(l=i[o])&&"caller"!==l)if(c=Xa(e,l)){c.get||c.set||(c.value=s(e[l],n));try{Ya(r,l,c)}catch(e){r[l]=c.value}}else r[l]=s(e[l],n);return r},ll=Array.isArray,cl=Object.getPrototypeOf,dl=function(){return"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==r.g?r.g:(console&&console.error&&console.error('Unable to locate global object, returning "this".'),this)}();function ul(e,t){var s=!(!t||!t.isStrict),n=t&&t.realm||dl,r=s?al:ol,i=function(e,t){if(!e||"object"!=typeof e)return e;if(t.has(e))return t.get(e);var o,a,l,c=e.__proto__||cl(e),d=c&&c.constructor;if(!d||d===n.Object)return r(e,n,i,t);if(ll(e)){if(s)return al(e,n,i,t);o=new d,t.set(e,o);for(var u=0,h=e.length;u<h;++u)o[u]=i(e[u],t);return o}if(e instanceof n.Date)return new d(e.getTime());if(e instanceof n.RegExp)return(o=new d(e.source,e.flags||(l="",(a=e).global&&(l+="g"),a.ignoreCase&&(l+="i"),a.multiline&&(l+="m"),a.unicode&&(l+="u"),a.sticky&&(l+="y"),l))).lastIndex=e.lastIndex,o;if(n.Map&&e instanceof n.Map)return o=new d,t.set(e,o),e.forEach((function(e,s){o.set(s,i(e,t))})),o;if(n.Set&&e instanceof n.Set)return o=new d,t.set(e,o),e.forEach((function(e){o.add(i(e,t))})),o;if(n.Blob&&e instanceof n.Blob)return e.slice(0,e.size,e.type);if(n.Buffer&&n.Buffer.isBuffer(e))return o=n.Buffer.allocUnsafe?n.Buffer.allocUnsafe(e.length):new d(e.length),t.set(e,o),e.copy(o),o;if(n.ArrayBuffer){if(n.ArrayBuffer.isView(e))return o=new d(e.buffer.slice(0)),t.set(e,o),o;if(e instanceof n.ArrayBuffer)return o=e.slice(0),t.set(e,o),o}return"function"==typeof e.then||e instanceof Error||n.WeakMap&&e instanceof n.WeakMap||n.WeakSet&&e instanceof n.WeakSet?e:r(e,n,i,t)};return i(e,rl())}ul.default=ul,ul.strict=function(e,t){return ul(e,{isStrict:!0,realm:t?t.realm:void 0})};const hl=new Set(["alarm_control_panel","alert","automation","binary_sensor","calendar","camera","climate","cover","device_tracker","fan","group","humidifier","input_boolean","light","lock","media_player","person","plant","remote","schedule","script","siren","sun","switch","timer","update","vacuum"]),pl=(e,t,s)=>{if((void 0!==t?t:null==e?void 0:e.state)===Bo)return"var(--state-unavailable-color)";const n=ml(e,t,s);return n?Zo(n):void 0},gl=(e,t,s,n)=>{const r=void 0!==s?s:t.state,i=Jo(t,s),o=[],a=function(e,t="_"){const s="àáäâãåăæąçćčđďèéěėëêęğǵḧìíïîįłḿǹńňñòóöôœøṕŕřßşśšșťțùúüûǘůűūųẃẍÿýźžż·/_,:;",n=`aaaaaaaaacccddeeeeeeegghiiiiilmnnnnooooooprrsssssttuuuuuuuuuwxyyzzz${t}${t}${t}${t}${t}${t}`,r=new RegExp(s.split("").join("|"),"g");return e.toString().toLowerCase().replace(/\s+/g,t).replace(r,(e=>n.charAt(s.indexOf(e)))).replace(/&/g,`${t}and${t}`).replace(/[^\w-]+/g,"").replace(/-/g,t).replace(new RegExp(`(${t})\\1+`,"g"),"$1").replace(new RegExp(`^${t}+`),"").replace(new RegExp(`${t}+$`),"")}(r,"_"),l=i?"active":"inactive";if(n&&Uo.includes(n)&&"inactive"==l)return Go;const c=t.attributes.device_class;return c&&o.push(`--state-${e}-${c}-${a}-color`),o.push(`--state-${e}-${a}-color`,`--state-${e}-${l}-color`,`--state-${l}-color`),o},ml=(e,t,s)=>{const n=void 0!==t?t:null==e?void 0:e.state,r=qo(e.entity_id),i=e.attributes.device_class;if("sensor"===r&&"battery"===i){const e=(e=>{const t=Number(e);if(!isNaN(t))return t>=70?"--state-sensor-battery-high-color":t>=30?"--state-sensor-battery-medium-color":"--state-sensor-battery-low-color"})(n);if(e)return[e]}if("group"===r){const n=(e=>{const t=e.attributes.entity_id||[],s=[...new Set(t.map((e=>qo(e))))];return 1===s.length?s[0]:void 0})(e);if(n&&hl.has(n))return gl(n,e,t,s)}return hl.has(r)?gl(r,e,t,s):s&&Uo.includes(s)?Go:void 0};let fl=window.cardHelpers;const yl=new Promise((async e=>{fl&&e(),window.loadCardHelpers&&(fl=await window.loadCardHelpers(),window.cardHelpers=fl,e())}));console.info("%c  BUTTON-CARD (mod for CB-LCARS)  \n%c Version 4.1.2-cblcars.3 ","color: white; font-weight: bold; background: #37a6d1","color: white; font-weight: bold; background: #37a6d1");let bl=class extends Ji{constructor(){super(...arguments),this._cards={},this._cardsConfig={},this._entities=[],this._initialSetupComplete=!1,this._rippleHandlers=new no((()=>this._ripple))}get _doIHaveEverything(){return!!this._hass&&!!this._config&&this.isConnected}set hass(e){this._hass=e,Object.keys(this._cards).forEach((e=>{this._cards[e].hass=this._hass})),this._initialSetupComplete||this._finishSetup()}disconnectedCallback(){super.disconnectedCallback(),this._clearInterval()}connectedCallback(){super.connectedCallback(),this._initialSetupComplete?this._startTimerCountdown():this._finishSetup()}_evaluateVariablesSkipError(e){var t;this._evaledVariables={},(null===(t=this._config)||void 0===t?void 0:t.variables)&&Object.keys(this._config.variables).sort().forEach((t=>{try{this._evaledVariables[t]=this._objectEvalTemplate(e,this._config.variables[t])}catch(e){}}))}_finishSetup(){if(!this._initialSetupComplete&&this._doIHaveEverything){if(this._evaluateVariablesSkipError(),this._config.entity){const e=this._getTemplateOrValue(void 0,this._config.entity);this._config.entity=e,this._stateObj=this._hass.states[e]}this._evaluateVariablesSkipError(this._stateObj),this._config.entity&&jo.has(qo(this._config.entity))?this._config=Object.assign({tap_action:{action:"toggle"}},this._config):this._config.entity?this._config=Object.assign({tap_action:{action:"more-info"}},this._config):this._config=Object.assign({tap_action:{action:"none"}},this._config);const e=JSON.stringify(this._config);if(this._entities=[],Array.isArray(this._config.triggers_update))this._config.triggers_update.forEach((e=>{try{const t=this._getTemplateOrValue(this._stateObj,e);null==t||this._entities.includes(t)||this._entities.push(t)}catch(e){}}));else if("string"==typeof this._config.triggers_update){const e=this._getTemplateOrValue(this._stateObj,this._config.triggers_update);e&&"all"!==e?this._entities.push(e):this._config.triggers_update=e}if("all"!==this._config.triggers_update){const t=new RegExp(/states\[\s*('|\\")([a-zA-Z0-9_]+\.[a-zA-Z0-9_]+)\1\s*\]/,"gm"),s=new RegExp(/states\[\s*('|\\")([a-zA-Z0-9_]+\.[a-zA-Z0-9_]+)\1\s*\]/,"m"),n=e.match(t);null==n||n.forEach((e=>{const t=e.match(s);t&&!this._entities.includes(t[2])&&this._entities.push(t[2])}))}this._config.entity&&!this._entities.includes(this._config.entity)&&this._entities.push(this._config.entity),this._expandTriggerGroups();const t=new RegExp("\\[\\[\\[.*\\]\\]\\]","m");this._hasTemplate=!("all"!==this._config.triggers_update||!e.match(t)),this._startTimerCountdown(),this._initialSetupComplete=!0}}_startTimerCountdown(){if(this._config&&this._config.entity&&"timer"===qo(this._config.entity)){const e=this._hass.states[this._config.entity];this._startInterval(e)}}_createCard(e){if(fl)return fl.createCardElement(e);{const t=((e,t=!1)=>{const s=(e,t)=>n("hui-error-card",{type:"error",error:e,config:t}),n=(e,t)=>{const n=window.document.createElement(e);try{if(!n.setConfig)return;n.setConfig(t)}catch(n){return console.error(e,n),s(n.message,t)}return n};if(!e||"object"!=typeof e||!t&&!e.type)return s("No type defined",e);let r=e.type;if(r&&r.startsWith("custom:"))r=r.substr(7);else if(t)if(ea.has(r))r=`hui-${r}-row`;else{if(!e.entity)return s("Invalid config given.",e);const t=e.entity.split(".",1)[0];r=`hui-${ta[t]||"text"}-entity-row`}else r=`hui-${r}-card`;if(customElements.get(r))return n(r,e);const i=s(`Custom element doesn't exist: ${e.type}.`,e);i.style.display="None";const o=setTimeout((()=>{i.style.display=""}),2e3);return customElements.whenDefined(e.type).then((()=>{clearTimeout(o),po(i,"ll-rebuild",{},i)})),i})(e);return yl.then((()=>{po(t,"ll-rebuild",{})})),t}}static get styles(){return sa}render(){var e;if(!this._config||!this._hass)return Ti``;this._stateObj=this._config.entity?this._hass.states[this._config.entity]:void 0;try{return this._evaledVariables={},(null===(e=this._config)||void 0===e?void 0:e.variables)&&Object.keys(this._config.variables).sort().forEach((e=>{this._evaledVariables[e]=this._objectEvalTemplate(this._stateObj,this._config.variables[e])})),this._cardHtml()}catch(e){e.stack?console.error(e.stack):console.error(e);const t=document.createElement("hui-error-card");return t.setConfig({type:"error",error:e.toString(),origConfig:this._config}),Ti` ${t} `}}shouldUpdate(e){return!(!this._hasTemplate&&!e.has("_timeRemaining")&&!function(e,t){if(t.has("_config"))return!0;const s=t.get("_hass");return!!s&&e._entities.some((function(t){return(null==s?void 0:s.states[t])!==e._hass.states[t]}))}(this,e)||(this._expandTriggerGroups(),0))}updated(e){if(super.updated(e),this._config&&this._config.entity&&"timer"===qo(this._config.entity)&&e.has("_hass")){const t=this._hass.states[this._config.entity],s=e.get("_hass");(s?s.states[this._config.entity]:void 0)!==t?this._startInterval(t):t||this._clearInterval()}}_clearInterval(){this._interval&&(window.clearInterval(this._interval),this._interval=void 0)}_startInterval(e){this._clearInterval(),this._calculateRemaining(e),"active"===e.state&&(this._interval=window.setInterval((()=>this._calculateRemaining(e)),1e3))}_calculateRemaining(e){e.attributes.remaining&&(this._timeRemaining=(e=>{if(!e.attributes.remaining)return;let t=Ko(e.attributes.remaining);if("active"===e.state){const s=(new Date).getTime(),n=new Date(e.last_changed).getTime();t=Math.max(t-(s-n)/1e3,0)}return t})(e))}_computeTimeDisplay(e){if(e)return function(e){const t=Math.floor(e/3600),s=Math.floor(e%3600/60),n=Math.floor(e%3600%60);return t>0?`${t}:${Qo(s)}:${Qo(n)}`:s>0?`${s}:${Qo(n)}`:n>0?""+n:null}(this._timeRemaining||Ko(e.attributes.duration))}_getMatchingConfigState(e){if(!this._config.state)return;const t=this._config.state.find((e=>"template"===e.operator));if(!e&&!t)return;let s;const n=this._config.state.find((t=>{if(!t.operator)return e&&this._getTemplateOrValue(e,t.value)==e.state;switch(t.operator){case"==":return e&&e.state==this._getTemplateOrValue(e,t.value);case"<=":return e&&e.state<=this._getTemplateOrValue(e,t.value);case"<":return e&&e.state<this._getTemplateOrValue(e,t.value);case">=":return e&&e.state>=this._getTemplateOrValue(e,t.value);case">":return e&&e.state>this._getTemplateOrValue(e,t.value);case"!=":return e&&e.state!=this._getTemplateOrValue(e,t.value);case"regex":return!(!e||!e.state.match(this._getTemplateOrValue(e,t.value)));case"template":return this._getTemplateOrValue(e,t.value);case"default":return s=t,!1;default:return!1}}));return!n&&s?s:n}_localize(e,t,s,n=!0,r){var i;return Ga(this._hass.localize,e,this._hass.locale,this._hass.config,this._hass.entities,{numeric_precision:"card"===s?null===(i=this._config)||void 0===i?void 0:i.numeric_precision:s,show_units:n,units:r},t)}_relativeTime(e,t=!1){return e?Ti`
        <ha-relative-time
          id="relative-time"
          class="ellipsis"
          .hass="${this._hass}"
          .datetime="${e}"
          .capitalize="${t}"
        ></ha-relative-time>
      `:""}_getTemplateHelpers(){return{localize:this._localize.bind(this),formatDateTime:e=>Ba(new Date(e),this._hass.locale,this._hass.config),formatShortDateTimeWithYear:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,za(s,n.time_zone).format(t);var t,s,n},formatShortDateTime:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,ja(s,n.time_zone).format(t);var t,s,n},formatDateTimeWithSeconds:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,Ha(s,n.time_zone).format(t);var t,s,n},formatDateTimeNumeric:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,`${$a(t,s,n)}, ${Oa(t,s,n)}`;var t,s,n},relativeTime:this._relativeTime.bind(this),formatTime:e=>Oa(new Date(e),this._hass.locale,this._hass.config),formatTimeWithSeconds:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,Pa(s,n.time_zone).format(t);var t,s,n},formatTimeWeekday:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,Na(s,n.time_zone).format(t);var t,s,n},formatTime24h:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,Fa(s,n.time_zone).format(t);var t,s,n},formatDateWeekdayDay:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,wa(s,n.time_zone).format(t);var t,s,n},formatDate:e=>Sa(new Date(e),this._hass.locale,this._hass.config),formatDateNumeric:e=>$a(new Date(e),this._hass.locale,this._hass.config),formatDateShort:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,ka(s,n.time_zone).format(t);var t,s,n},formatDateMonthYear:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,Aa(s,n.time_zone).format(t);var t,s,n},formatDateMonth:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,Ma(s,n.time_zone).format(t);var t,s,n},formatDateYear:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,Da(s,n.time_zone).format(t);var t,s,n},formatDateWeekday:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,Ea(s,n.time_zone).format(t);var t,s,n},formatDateWeekdayShort:e=>{return t=new Date(e),s=this._hass.locale,n=this._hass.config,Ta(s,n.time_zone).format(t);var t,s,n}}}_evalTemplate(e,t){try{return new Function("states","entity","user","hass","variables","html","helpers",`'use strict'; ${t}`).call(this,this._hass.states,e,this._hass.user,this._hass,this._evaledVariables,Ti,this._getTemplateHelpers())}catch(e){const s=t.length<=100?t.trim():`${t.trim().substring(0,98)}...`;throw e.message=`${e.name}: ${e.message} in '${s}'`,e.name="ButtonCardJSTemplateError",e}}_objectEvalTemplate(e,t){const s=ul(t);return this._getTemplateOrValue(e,s)}_getTemplateOrValue(e,t){if(["number","boolean"].includes(typeof t))return t;if(!t)return t;if("object"==typeof t)return Object.keys(t).forEach((s=>{t[s]=this._getTemplateOrValue(e,t[s])})),t;const s=t.trim();return"[[["===s.substring(0,3)&&"]]]"===s.slice(-3)?this._evalTemplate(e,s.slice(3,-3)):t}_getColorForLightEntity(e,t,s){let n=Vo;return Uo.includes(n)&&(n=Zo(Go)),e&&(Jo(e)?(n=e.attributes.rgb_color?`rgb(${e.attributes.rgb_color.join(",")})`:t&&e.attributes.color_temp&&e.attributes.min_mireds&&e.attributes.max_mireds?function(e,t,s){const n=new No("rgb(255, 160, 0)"),r=new No("rgb(166, 209, 255)"),i=new No("white"),o=(e-t)/(s-t)*100;return o<50?Fo(r).mix(i,2*o).toRgbString():Fo(i).mix(n,2*(o-50)).toRgbString()}(e.attributes.color_temp,e.attributes.min_mireds,e.attributes.max_mireds):pl(e,e.state,s)||Vo,e.attributes.brightness&&(n=function(e,t,s){const n=new No(Wo(e,t));if(n.isValid){const e=n.mix("black",100-s).toString();if(e)return e}return t}(this,n,(e.attributes.brightness+245)/5))):n=pl(e,e.state,s)||Vo),n}_buildCssColorAttribute(e,t){var s,n;let r,i="";return(null==t?void 0:t.color)?i=t.color:this._config.color&&(i=this._config.color),Ho.includes(i)&&(!e||e&&"light"!==qo(e.entity_id))&&(i=""),r=Ho.includes(i)?this._getColorForLightEntity(e,"auto-no-temperature"!==i,null===(s=this._config)||void 0===s?void 0:s.color_type):i||e&&pl(e,e.state,null===(n=this._config)||void 0===n?void 0:n.color_type)||Vo,r}_buildIcon(e,t){if(!this._config.show_icon)return;let s;if(null==t?void 0:t.icon)s=t.icon;else{if(!this._config.icon)return;s=this._config.icon}return this._getTemplateOrValue(e,s)}_buildEntityPicture(e,t){if(!this._config.show_entity_picture||!e&&!t&&!this._config.entity_picture)return;let s;return(null==t?void 0:t.entity_picture)?s=t.entity_picture:this._config.entity_picture?s=this._config.entity_picture:e&&(s=e.attributes&&e.attributes.entity_picture?e.attributes.entity_picture:void 0),this._getTemplateOrValue(e,s)}_buildStyleGeneric(e,t,s){var n,r;let i={};if((null===(n=this._config.styles)||void 0===n?void 0:n[s])&&(i=Object.assign(i,...this._config.styles[s])),null===(r=null==t?void 0:t.styles)||void 0===r?void 0:r[s]){let e={};e=Object.assign(e,...t.styles[s]),i=Object.assign(Object.assign({},i),e)}return Object.keys(i).forEach((t=>{i[t]=this._getTemplateOrValue(e,i[t])})),i}_buildCustomStyleGeneric(e,t,s){var n,r,i,o;let a={};if((null===(r=null===(n=this._config.styles)||void 0===n?void 0:n.custom_fields)||void 0===r?void 0:r[s])&&(a=Object.assign(a,...this._config.styles.custom_fields[s])),null===(o=null===(i=null==t?void 0:t.styles)||void 0===i?void 0:i.custom_fields)||void 0===o?void 0:o[s]){let e={};e=Object.assign(e,...t.styles.custom_fields[s]),a=Object.assign(Object.assign({},a),e)}return Object.keys(a).forEach((t=>{a[t]=this._getTemplateOrValue(e,a[t])})),a}_buildName(e,t){if(!1===this._config.show_name)return;let s;var n;return(null==t?void 0:t.name)?s=t.name:this._config.name?s=this._config.name:e&&(s=e.attributes&&e.attributes.friendly_name?e.attributes.friendly_name:(n=e.entity_id).substr(n.indexOf(".")+1)),this._getTemplateOrValue(e,s)}_buildStateString(e){let t;return this._config.show_state&&e&&e.state&&("timer"===qo(e.entity_id)?"idle"===e.state||0===this._timeRemaining?t=Ga(this._hass.localize,e,this._hass.locale,this._hass.config,this._hass.entities,this._config):(t=this._computeTimeDisplay(e),"paused"===e.state&&(t+=` (${Ga(this._hass.localize,e,this._hass.locale,this._hass.config,this._hass.entities,this._config)})`)):t=Ga(this._hass.localize,e,this._hass.locale,this._hass.config,this._hass.entities,this._config)),t}_buildLastChanged(e,t){return this._config.show_last_changed&&e?Ti`
          <ha-relative-time
            id="label"
            class="ellipsis"
            .hass="${this._hass}"
            .datetime="${e.last_changed}"
            style=${lo(t)}
          ></ha-relative-time>
        `:void 0}_buildLabel(e,t){if(!this._config.show_label)return;let s;return s=(null==t?void 0:t.label)?t.label:this._config.label,this._getTemplateOrValue(e,s)}_buildCustomFields(e,t){let s=Ti``;const n={},r={};return this._config.custom_fields&&Object.keys(this._config.custom_fields).forEach((t=>{const s=this._config.custom_fields[t];s.card?s.do_not_eval?r[t]=ul(s.card):r[t]=this._objectEvalTemplate(e,s.card):n[t]=this._getTemplateOrValue(e,s)})),(null==t?void 0:t.custom_fields)&&Object.keys(t.custom_fields).forEach((s=>{const i=t.custom_fields[s];i.card?i.do_not_eval?r[s]=ul(i.card):r[s]=this._objectEvalTemplate(e,i.card):n[s]=this._getTemplateOrValue(e,i)})),Object.keys(n).forEach((r=>{if(null!=n[r]){const i=Object.assign(Object.assign({},this._buildCustomStyleGeneric(e,t,r)),{"grid-area":r});s=Ti`
          ${s}
          <div id=${r} class="ellipsis" style=${lo(i)}>${this._unsafeHTMLorNot(n[r])}</div>
        `}})),Object.keys(r).forEach((n=>{if(null!=r[n]){const i=Object.assign(Object.assign({},this._buildCustomStyleGeneric(e,t,n)),{"grid-area":n});let o;go(this._cardsConfig[n],r[n])?o=this._cards[n]:(o=this._createCard(r[n]),this._cards[n]=o,this._cardsConfig[n]=ul(r[n])),o.hass=this._hass,s=Ti`
          ${s}
          <div
            id=${n}
            @action=${this._stopPropagation}
            @click=${this._stopPropagation}
            @touchstart=${this._stopPropagation}
            @mousedown=${this._stopPropagation}
            @mouseup=${this._stopPropagation}
            @touchend=${this._stopPropagation}
            @touchcancel=${this._stopPropagation}
            style=${lo(i)}
          >
            ${o}
          </div>
        `}})),s}_hasChildCards(e){return!!e&&Object.keys(e).some((t=>!!e[t].card))}_isClickable(e,t){const s=this._getTemplateOrValue(e,this._config.tap_action.action),n=this._getTemplateOrValue(e,this._config.hold_action.action),r=this._getTemplateOrValue(e,this._config.double_tap_action.action),i=this._hasChildCards(this._config.custom_fields)||!(!t||!this._hasChildCards(t.custom_fields));return"none"!=s||"none"!=n||"none"!=r||i}_rotate(e){return!!(null==e?void 0:e.spin)}_blankCardColoredHtml(e){const t=Object.assign({background:"none","box-shadow":"none","border-style":"none"},e);return Ti`
      <ha-card class="disabled" style=${lo(t)}>
        <div></div>
      </ha-card>
    `}_cardHtml(){var e,t,s,n;const r=this._getMatchingConfigState(this._stateObj);let i="var(--state-inactive-color)";(null==r?void 0:r.color)&&!Ho.includes(r.color)?i=r.color:(null===(e=this._config)||void 0===e?void 0:e.color)&&!Ho.includes(this._config.color)?this._stateObj?Jo(this._stateObj)&&(i=(null===(t=this._config)||void 0===t?void 0:t.color)||i):i=this._config.color:i=this._buildCssColorAttribute(this._stateObj,r);let o=i,a={},l={};const c={},d=this._buildStyleGeneric(this._stateObj,r,"lock"),u=this._buildStyleGeneric(this._stateObj,r,"card"),h=this._buildStyleGeneric(this._stateObj,r,"tooltip"),p={"button-card-main":!0,disabled:!this._isClickable(this._stateObj,r)};switch((null===(s=this._config)||void 0===s?void 0:s.tooltip)&&this.classList.add("tooltip"),u.width&&(this.style.setProperty("flex","0 0 auto"),this.style.setProperty("max-width","fit-content")),this._config.color_type){case"blank-card":return this._blankCardColoredHtml(u);case"card":case"label-card":{const e=function(e,t){const s=new No(Wo(e,t)).getLuminance(),n=new No({r:225,g:225,b:225}),r=n.getLuminance(),i=new No({r:28,g:28,b:28}),o=i.getLuminance();return 0===s||(Math.max(s,r)+.05)/Math.min(s,r+.05)>(Math.max(s,o)+.05)/Math.min(s,o+.05)?n.toRgbString():i.toRgbString()}(this,i);a.color=e,l.color=e,a["background-color"]=i,a=Object.assign(Object.assign({},a),u),o="inherit";break}default:a=u}this._config.aspect_ratio?(c["--aspect-ratio"]=this._config.aspect_ratio,a.position="absolute"):c.display="inline",this.style.setProperty("--button-card-light-color",this._getColorForLightEntity(this._stateObj,!0)),this.style.setProperty("--button-card-light-color-no-temperature",this._getColorForLightEntity(this._stateObj,!1)),l=Object.assign(Object.assign({},l),d);const g=this._config.extra_styles?Ti`
          <style>
            ${this._getTemplateOrValue(this._stateObj,this._config.extra_styles)}
          </style>
        `:Ti``;return Ti`
      ${g}
      <div id="aspect-ratio" style=${lo(c)}>
        <ha-card
          id="card"
          class=${ho(p)}
          style=${lo(a)}
          @action=${this._handleAction}
          @focus="${this.handleRippleFocus}"
          @blur="${this.handleRippleBlur}"
          @mousedown="${this.handleRippleActivate}"
          @mouseup="${this.handleRippleDeactivate}"
          @touchstart="${this.handleRippleActivate}"
          @touchend="${this.handleRippleDeactivate}"
          @touchcancel="${this.handleRippleDeactivate}"
          .actionHandler=${yo({hasDoubleClick:"none"!==this._config.double_tap_action.action,hasHold:"none"!==this._config.hold_action.action,repeat:this._config.hold_action.repeat,repeatLimit:this._config.hold_action.repeat_limit})}
          .config="${this._config}"
        >
          ${this._buttonContent(this._stateObj,r,o)}
          <mwc-ripple id="ripple"></mwc-ripple>
        </ha-card>
        ${this._getLock(l)}
      </div>
      ${(null===(n=this._config)||void 0===n?void 0:n.tooltip)?Ti`
            <span class="tooltiptext" style=${lo(h)}>
              ${this._getTemplateOrValue(this._stateObj,this._config.tooltip)}
            </span>
          `:""}
    `}_getLock(e){return this._config.lock&&this._getTemplateOrValue(this._stateObj,this._config.lock.enabled)?Ti`
        <div
          id="overlay"
          style=${lo(e)}
          @action=${this._handleUnlockType}
          .actionHandler=${yo({hasDoubleClick:"double_tap"===this._config.lock.unlock,hasHold:"hold"===this._config.lock.unlock})}
          .config="${this._config}"
        >
          <ha-icon id="lock" icon="mdi:lock-outline"></ha-icon>
        </div>
      `:Ti``}_buttonContent(e,t,s){const n=this._buildName(e,t),r=(null==t?void 0:t.state_display)||this._config.state_display||void 0,i=(this._config.show_state&&r?this._getTemplateOrValue(e,r):void 0)||this._buildStateString(e),o=function(e,t){if(!e&&!t)return;let s;return s=t?e?`${e}: ${t}`:t:e,s}(n,i);switch(this._config.layout){case"icon_name_state":case"name_state":return this._gridHtml(e,t,this._config.layout,s,o,void 0);default:return this._gridHtml(e,t,this._config.layout,s,n,i)}}_unsafeHTMLorNot(e){return e.strings||e.values?e:uo(`${e}`)}_gridHtml(e,t,s,n,r,i){const o=this._getIconHtml(e,t,n),a=[s],l=this._buildLabel(e,t),c=this._buildStyleGeneric(e,t,"name"),d=this._buildStyleGeneric(e,t,"state"),u=this._buildStyleGeneric(e,t,"label"),h=this._buildLastChanged(e,u),p=this._buildStyleGeneric(e,t,"grid");return o||a.push("no-icon"),r||a.push("no-name"),i||a.push("no-state"),l||h||a.push("no-label"),Ti`
      <div id="container" class=${a.join(" ")} style=${lo(p)}>
        ${o||""}
        ${r?Ti`
              <div id="name" class="ellipsis" style=${lo(c)}>
                ${this._unsafeHTMLorNot(r)}
              </div>
            `:""}
        ${i?Ti`
              <div id="state" class="ellipsis" style=${lo(d)}>
                ${this._unsafeHTMLorNot(i)}
              </div>
            `:""}
        ${l&&!h?Ti`
              <div id="label" class="ellipsis" style=${lo(u)}>
                ${this._unsafeHTMLorNot(l)}
              </div>
            `:""}
        ${h||""} ${this._buildCustomFields(e,t)}
      </div>
    `}_getIconHtml(e,t,s){const n=this._buildIcon(e,t),r=this._buildEntityPicture(e,t),i=this._buildStyleGeneric(e,t,"entity_picture"),o=this._buildStyleGeneric(e,t,"icon"),a=this._buildStyleGeneric(e,t,"img_cell"),l=this._buildStyleGeneric(e,t,"card"),c=Object.assign({color:s,width:this._config.size,"--ha-icon-display":l.height?"inline":void 0,position:this._config.aspect_ratio||l.height?"absolute":"relative"},o),d=Object.assign(Object.assign({},c),i),u=this._buildLiveStream(d),h=this._config.show_icon&&(n||e);if(h||r){let s;return e&&(s=qo(e.entity_id)),Ti`
        <div id="img-cell" style=${lo(a)}>
          ${!h||r||u?"":Ti`
                <ha-state-icon
                  .state=${e}
                  .stateObj=${e}
                  .hass=${this._hass}
                  ?data-domain=${s}
                  data-state=${(e=>null!=e?e:Oi)(null==e?void 0:e.state)}
                  style=${lo(c)}
                  .icon="${n}"
                  id="icon"
                  ?rotating=${this._rotate(t)}
                ></ha-state-icon>
              `}
          ${u||""}
          ${r&&!u?Ti`
                <img
                  src="${r}"
                  style=${lo(d)}
                  id="icon"
                  ?rotating=${this._rotate(t)}
                />
              `:""}
        </div>
      `}}_buildLiveStream(e){return this._config.show_live_stream&&this._config.entity&&"camera"===qo(this._config.entity)?Ti`
        <hui-image
          .hass=${this._hass}
          .cameraImage=${this._config.entity}
          .entity=${this._config.entity}
          cameraView="live"
          style=${lo(e)}
        ></hui-image>
      `:void 0}_configFromLLTemplates(e,t){const s=t.template;if(!s)return t;let n,r={};const i=s&&Array.isArray(s)?s:[s];return null==i||i.forEach((t=>{var s,i;let o;if(null===(s=e.config.cblcars_card_templates)||void 0===s?void 0:s[t])o=e.config.cblcars_card_templates[t];else{if(!(null===(i=window.cblcars_card_templates)||void 0===i?void 0:i[t]))throw new Error(`LCARS Button-card template '${t}' is missing!`);o=window.cblcars_card_templates[t]}const a=this._configFromLLTemplates(e,o);r=Yo(r,a),n=Xo(n,a.state)})),r=Yo(r,t),r.state=Xo(n,t.state),r}setConfig(e){if(!e)throw new Error("Invalid configuration");this._initialSetupComplete&&(this._initialSetupComplete=!1),this._cards={},this._cardsConfig={};const t=function(){let e=document.querySelector("home-assistant");if(e=e&&e.shadowRoot,e=e&&e.querySelector("home-assistant-main"),e=e&&e.shadowRoot,e=e&&e.querySelector("app-drawer-layout partial-panel-resolver, ha-drawer partial-panel-resolver"),e=e&&e.shadowRoot||e,e=e&&e.querySelector("ha-panel-lovelace"),e=e&&e.shadowRoot,e=e&&e.querySelector("hui-root"),e){const t=e.lovelace;return t.current_view=e.___curView,t}return null}()||function(){let e=document.querySelector("hc-main");if(e=e&&e.shadowRoot,e=e&&e.querySelector("hc-lovelace"),e=e&&e.shadowRoot,e=e&&(e.querySelector("hui-view")||e.querySelector("hui-panel-view")),e){const t=e.lovelace;return t.current_view=e.___curView,t}return null}();let s=ul(e);s=this._configFromLLTemplates(t,s),this._config=Object.assign(Object.assign({type:"custom:cblcars-button-card",group_expand:!1,hold_action:{action:"none"},double_tap_action:{action:"none"},layout:"vertical",size:"40%",color_type:"icon",show_name:!0,show_state:!1,show_icon:!0,show_units:!0,show_label:!1,show_entity_picture:!1,show_live_stream:!1,card_size:3},s),{lock:Object.assign({enabled:!1,duration:5,unlock:"tap"},s.lock)}),this._initialSetupComplete||this._finishSetup()}_loopGroup(e){e&&e.forEach((e=>{var t,s;(null===(t=this._hass)||void 0===t?void 0:t.states[e])&&((null===(s=this._hass.states[e].attributes)||void 0===s?void 0:s.entity_id)?this._loopGroup(this._hass.states[e].attributes.entity_id):this._entities.includes(e)||this._entities.push(e))}))}_expandTriggerGroups(){var e;this._hass&&(null===(e=this._config)||void 0===e?void 0:e.group_expand)&&this._entities&&this._entities.forEach((e=>{var t,s,n,r,i;(null===(n=null===(s=null===(t=this._hass)||void 0===t?void 0:t.states[e])||void 0===s?void 0:s.attributes)||void 0===n?void 0:n.entity_id)&&this._loopGroup(null===(i=null===(r=this._hass)||void 0===r?void 0:r.states[e].attributes)||void 0===i?void 0:i.entity_id)}))}getCardSize(){var e;return(null===(e=this._config)||void 0===e?void 0:e.card_size)||3}_evalActions(e,t){var s,n,r,i,o;const a=ul(e),l=e=>e?(Object.keys(e).forEach((t=>{"object"==typeof e[t]?e[t]=l(e[t]):e[t]=this._getTemplateOrValue(this._stateObj,e[t])})),e):e;return"entity"===(null===(n=null===(s=a[t])||void 0===s?void 0:s.service_data)||void 0===n?void 0:n.entity_id)&&(a[t].service_data.entity_id=e.entity),"entity"===(null===(i=null===(r=a[t])||void 0===r?void 0:r.data)||void 0===i?void 0:i.entity_id)&&(a[t].data.entity_id=e.entity),a[t]=l(a[t]),!a[t].confirmation&&a.confirmation&&(a[t].confirmation=l(a.confirmation)),(null===(o=a[t])||void 0===o?void 0:o.entity)&&(a.entity=a[t].entity),a}handleRippleActivate(e){this._ripple.then((t=>t&&"function"==typeof t.startPress&&this._rippleHandlers.startPress(e)))}handleRippleDeactivate(){this._ripple.then((e=>e&&"function"==typeof e.endPress&&this._rippleHandlers.endPress()))}handleRippleFocus(){this._ripple.then((e=>e&&"function"==typeof e.startFocus&&this._rippleHandlers.startFocus()))}handleRippleBlur(){this._ripple.then((e=>e&&"function"==typeof e.endFocus&&this._rippleHandlers.endFocus()))}_handleAction(e){var t;if(null===(t=e.detail)||void 0===t?void 0:t.action)switch(e.detail.action){case"tap":case"hold":case"double_tap":const t=this._config;if(!t)return;const s=e.detail.action,n=this._evalActions(t,`${s}_action`);(async(e,t,s,n)=>{po(e,"hass-action",{config:s,action:n})})(this,this._hass,n,s)}}_handleUnlockType(e){const t=this._config;t&&t.lock.unlock===e.detail.action&&this._handleLock()}_handleLock(){var e;const t=this.shadowRoot.getElementById("lock");if(!t)return;if(this._config.lock.exemptions){if(!(null===(e=this._hass.user)||void 0===e?void 0:e.name)||!this._hass.user.id)return;let s=!1;if(this._config.lock.exemptions.forEach((e=>{var t,n;(!s&&e.user===(null===(t=this._hass.user)||void 0===t?void 0:t.id)||e.username===(null===(n=this._hass.user)||void 0===n?void 0:n.name))&&(s=!0)})),!s)return t.classList.add("invalid"),void window.setTimeout((()=>{t&&t.classList.remove("invalid")}),3e3)}const s=this.shadowRoot.getElementById("overlay");if(s.style.setProperty("pointer-events","none"),t){const e=document.createAttribute("icon");e.value="mdi:lock-open-outline",t.attributes.setNamedItem(e),t.classList.add("hidden")}window.setTimeout((()=>{if(s.style.setProperty("pointer-events",""),t){t.classList.remove("hidden");const e=document.createAttribute("icon");e.value="mdi:lock-outline",t.attributes.setNamedItem(e)}}),1e3*this._config.lock.duration)}_stopPropagation(e){e.stopPropagation()}};Yr([Qi()],bl.prototype,"_hass",void 0),Yr([Qi()],bl.prototype,"_config",void 0),Yr([Qi()],bl.prototype,"_timeRemaining",void 0),Yr([eo({descriptor:e=>({async get(){var e;return await this.updateComplete,null===(e=this.renderRoot)||void 0===e?void 0:e.querySelector("mwc-ripple")},enumerable:!0,configurable:!0})})],bl.prototype,"_ripple",void 0),Yr([to({passive:!0})],bl.prototype,"handleRippleActivate",null),Yr([to({passive:!0})],bl.prototype,"handleRippleDeactivate",null),Yr([to({passive:!0})],bl.prototype,"handleRippleFocus",null),Yr([to({passive:!0})],bl.prototype,"handleRippleBlur",null),Yr([to({passive:!0})],bl.prototype,"_handleAction",null),Yr([to({passive:!0})],bl.prototype,"_handleUnlockType",null),Yr([to({passive:!0})],bl.prototype,"_handleLock",null),Yr([to({passive:!0})],bl.prototype,"_stopPropagation",null),bl=Yr([(e=>t=>"function"==typeof t?((e,t)=>(customElements.define(e,t),t))(e,t):((e,t)=>{const{kind:s,elements:n}=t;return{kind:s,elements:n,finisher(t){customElements.define(e,t)}}})(e,t))("cblcars-button-card")],bl);var _l=r(625),vl=r(152),wl=r(988);function Sl(e){const t={},s=/<circle[^>]*id="([^"]+)"[^>]*>/g;let n;for(;null!==(n=s.exec(e));){const e=n[1],s=n[0],r=s.match(/\scx="([^"]+)"/),i=s.match(/\scy="([^"]+)"/);r&&i&&(t[e]=[parseFloat(r[1]),parseFloat(i[1])])}const r=/<text[^>]*id="([^"]+)"[^>]*>/g;for(;null!==(n=r.exec(e));){const e=n[1],s=n[0],r=s.match(/\sx="([^"]+)"/),i=s.match(/\sy="([^"]+)"/);r&&i&&(t[e]=[parseFloat(r[1]),parseFloat(i[1])])}const i=/<g[^>]*id="([^"]+)"[^>]*>/g;for(;null!==(n=i.exec(e));)t[n[1]]=null;return t}function xl(e){let t=null;return e&&e.startsWith("builtin:")?t=e.replace("builtin:",""):e&&e.startsWith("/local/")&&(t=e.split("/").pop().replace(".svg","")),t&&window.cblcars?.msd?.svg_templates?.[t]}function $l(e){const t=e&&e.match(/viewBox="([0-9.\-]+)\s+([0-9.\-]+)\s+([0-9.\-]+)\s+([0-9.\-]+)"/);return t?[parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]),parseFloat(t[4])]:[0,0,400,200]}function Cl(e){return e[2]&&e[3]?e[2]/e[3]:2}function kl(e){if(null===e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(kl);const t={};for(const[s,n]of Object.entries(e))s.startsWith("__")||"checksum"===s||"origin_pack"===s||"timestamp"===s||(t[s]=kl(n));return t}function Al(e){if(null===e||"object"!=typeof e)return JSON.stringify(e);if(Array.isArray(e))return`[${e.map(Al).join(",")}]`;const t=Object.keys(e).sort().map((t=>`"${t}":${Al(e[t])}`));return`{${t.join(",")}}`}const Ml=new class{constructor(){this.counters=new Map,this.timings=new Map,this.sessionStart=performance.now()}addTiming(e,t,s={}){this.timings.has(e)||this.timings.set(e,{last:0,totalMs:0,samples:0,avg:0,min:1/0,max:0,metadata:[]});const n=this.timings.get(e);n.last=t,n.totalMs+=t,n.samples++,n.avg=n.totalMs/n.samples,n.min=Math.min(n.min,t),n.max=Math.max(n.max,t),Object.keys(s).length>0&&(n.metadata.push({...s,ms:t,timestamp:Date.now()}),n.metadata.length>10&&(n.metadata=n.metadata.slice(-10)))}addCount(e,t=1,s={}){this.counters.has(e)||this.counters.set(e,{count:0,rate:0,lastUpdate:performance.now(),metadata:[]});const n=this.counters.get(e),r=performance.now(),i=(r-n.lastUpdate)/1e3;n.count+=t,n.rate=i>0?t/i:0,n.lastUpdate=r,Object.keys(s).length>0&&(n.metadata.push({...s,increment:t,timestamp:Date.now()}),n.metadata.length>10&&(n.metadata=n.metadata.slice(-10)))}async timeAsync(e,t,s={}){const n=performance.now();try{const r=await t(),i=performance.now()-n;return this.addTiming(e,i,s),r}catch(t){const r=performance.now()-n;throw this.addTiming(e,r,{...s,error:t.message}),t}}timeSync(e,t,s={}){const n=performance.now();try{const r=t(),i=performance.now()-n;return this.addTiming(e,i,s),r}catch(t){const r=performance.now()-n;throw this.addTiming(e,r,{...s,error:t.message}),t}}getAll(){const e=performance.now()-this.sessionStart;return{session:{duration_ms:e,started_at:Date.now()-e},timings:Object.fromEntries(this.timings),counters:Object.fromEntries(this.counters),summary:this.getSummary()}}getSummary(){const e={timings:{},counters:{},health:"good"};return["merge.total","validation.total","render.total"].forEach((t=>{if(this.timings.has(t)){const s=this.timings.get(t);e.timings[t]={avg:s.avg,last:s.last,samples:s.samples},s.avg>50&&(e.health="warning"),s.avg>100&&(e.health="critical")}})),["rules.eval.count","rules.match.count","animation.instance.reuse"].forEach((t=>{if(this.counters.has(t)){const s=this.counters.get(t);e.counters[t]={count:s.count,rate:s.rate}}})),e}reset(){this.counters.clear(),this.timings.clear(),this.sessionStart=performance.now()}export(e={}){const t=this.getAll();return"csv"===e.format?this.exportToCsv(t):e.minify?this.minifyData(t):t}minifyData(e){const t={session:e.session,timings:{},counters:{},summary:e.summary};for(const[s,n]of Object.entries(e.timings))t.timings[s]={avg:n.avg,last:n.last,samples:n.samples,min:n.min,max:n.max};for(const[s,n]of Object.entries(e.counters))t.counters[s]={count:n.count,rate:n.rate};return t}};function Dl(e,t,s={}){return"function"==typeof t?Ml.timeSync(e,t,s):{end:(t={})=>{const s=performance.now()-Dl.start;Ml.addTiming(e,s,t)}}}async function El(e,t,s={}){return Ml.timeAsync(e,t,s)}function Tl(e,t=1,s={}){Ml.addCount(e,t,s)}const Rl="undefined"!=typeof window?window:r.g;async function Ol(e){return await El("merge.total",(async()=>{const t=await El("merge.loadLayers",(()=>async function(e){const t=[],s=e.use_packs?.builtin||["core"];for(const e of s){const s=await Ll(e);s&&t.push({type:"builtin",pack:e,data:s,priority:100})}if(e.use_packs?.external?.length>0){const s=await async function(e,t={}){const{timeout:s=5e3,retries:n=2,retryDelay:i=1e3,enableCaching:o=!0}=t,a=[],l={total_packs:e.length,successful:0,failed:0,retried:0,cached_hits:0,total_time_ms:0},c=performance.now();for(let t=0;t<e.length;t++){const r=e[t],c=await Pl(r,{timeout:s,retries:n,retryDelay:i,enableCaching:o,index:t});a.push(c),c.error?l.failed++:l.successful++,c.retryCount>0&&l.retried++,c.cached&&l.cached_hits++}l.total_time_ms=performance.now()-c;try{const e="undefined"!=typeof window?window:r.g;e.__msdDebug=e.__msdDebug||{},e.__msdDebug._lastExternalPackPerf=l}catch(e){}return a}(e.use_packs.external);s.forEach(((e,s)=>{e.data&&!e.error&&t.push({type:"external",pack:e.url,data:e.data,priority:200+s})}))}return t.push({type:"user",pack:"user_config",data:e,priority:1e3}),t.sort(((e,t)=>e.priority-t.priority))}(e))),s=await El("merge.processSingle",(()=>async function(e){const t={version:1,anchors:{},palettes:{},profiles:[],overlays:[],rules:[],animations:[],timelines:[],routing:{},data_sources:{},active_profiles:["normal"],__provenance:{anchors:{},palettes:{},overlays:{},rules:{},animations:{},merge_order:[]}};for(const s of e)Dl("merge.processLayer",(()=>Il(t,s)),{layer:s.pack,type:s.type}),t.__provenance.merge_order.push({type:s.type,pack:s.pack,priority:s.priority});return Dl("merge.applyRemovals",(()=>function(e,t){if(!t||"object"!=typeof t)return;const s=["overlays","rules","animations","profiles","timelines"];for(const n of s){const s=t[n];if(Array.isArray(s))for(const t of s){const s=e[n].findIndex((e=>e.id===t));s>=0&&(e[n].splice(s,1),e.__provenance[n][t]={...e.__provenance[n][t]||{},removed:!0,removal_source:"global"})}}}(t,e[e.length-1]?.data?.remove))),t.checksum=await El("merge.checksum",(()=>async function(e){const t=Al(kl(e)),s=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",s),r=new Uint8Array(n),i=Array.from(r).map((e=>e.toString(16).padStart(2,"0"))).join("");return i.substring(0,10)}(t))),t}(t)));return s}),{config_overlays:e.overlays?.length||0,config_rules:e.rules?.length||0,config_anchors:Object.keys(e.anchors||{}).length,use_packs:e.use_packs?.builtin?.length||0})}async function Ll(e){try{const t=window.__msdDebug?.packs;if(t){const s="core"===e?t.core:t.builtin?.[e];if(s&&"object"==typeof s)return s}}catch(e){}return"core"===e?{version:1,anchors:{svg_bridge:[200,150],svg_warp:[350,200]},_extracted_anchors:["svg_bridge","svg_warp"],profiles:[{id:"normal",defaults:{line:{color:"var(--lcars-orange)",width:2},text:{color:"var(--lcars-orange)",font_size:14}}}],palettes:{default:{accent1:"var(--lcars-orange)",accent2:"var(--lcars-yellow)",danger:"var(--lcars-red)",info:"var(--lcars-cyan)"}}}:null}async function Pl(e,t){const{timeout:s,retries:n,retryDelay:r,enableCaching:i,index:o}=t;if(i&&Bl.has(e)){const t=Bl.get(e);if(Date.now()-t.timestamp<3e5)return{url:e,data:t.data,error:t.error,cached:!0,loadTime:0,retryCount:0,index:o}}let a=null,l=0;for(let t=0;t<=n;t++){const d=performance.now();try{const t=await Promise.race([Nl(e),Fl(s,e)]),n=performance.now()-d;return i&&Bl.set(e,{data:t.data,error:null,timestamp:Date.now()}),{url:e,data:t.data,error:null,cached:!1,loadTime:n,retryCount:l,index:o,contentType:t.contentType,size:t.size}}catch(c){if(a=c,l=t,"ValidationError"===c.name||"SyntaxError"===c.name||c.message.includes("404"))break;t<n&&await new Promise((e=>setTimeout(e,r*(t+1))))}}return i&&Bl.set(e,{data:null,error:a.message,timestamp:Date.now()}),{url:e,data:null,error:a?.message||"Unknown error",errorType:(c=a,c?"TimeoutError"===c.name?"timeout":"ValidationError"===c.name?"validation":"SyntaxError"===c.name?"syntax":c.message.includes("404")?"not_found":c.message.includes("403")?"forbidden":c.message.includes("network")?"network":"unknown":"unknown"),cached:!1,loadTime:0,retryCount:l,index:o};var c}async function Nl(e){try{new URL(e)}catch(t){const s=new Error(`Invalid URL format: ${e}`);throw s.name="ValidationError",s}const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText} for ${e}`);const s=t.headers.get("content-type")||"";s.includes("application/json")||s.includes("text/")||console.warn(`[MSD] External pack ${e} has unexpected content-type: ${s}`);const n=await t.text();if(n.length>1048576)throw new Error(`External pack ${e} too large: ${n.length} bytes (max 1MB)`);let r;try{r=JSON.parse(n)}catch(t){const s=new Error(`Invalid JSON in external pack ${e}: ${t.message}`);throw s.name="SyntaxError",s}return r&&"object"==typeof r&&function(e,t){const s=Object.keys(e);["version","anchors","overlays","rules","animations","profiles","palettes","timelines"].some((e=>s.includes(e)))||console.warn(`[MSD] External pack ${t} doesn't contain recognized MSD fields`),["overlays","rules","animations","profiles"].forEach((s=>{Array.isArray(e[s])&&e[s].forEach(((e,n)=>{e.id||console.warn(`[MSD] External pack ${t} ${s}[${n}] missing required 'id' field`)}))}))}(r,e),{data:r,contentType:s,size:n.length}}function Fl(e,t){return new Promise(((s,n)=>{setTimeout((()=>{const s=new Error(`Timeout loading external pack: ${t} (${e}ms)`);s.name="TimeoutError",n(s)}),e)}))}Rl&&(Rl.__msdPerf={getAll:function(){return Ml.getAll()},getSummary:function(){return Ml.getSummary()},reset:function(){Ml.reset()},export:function(e={}){return Ml.export(e)}});const Bl=new Map;async function Il(e,t){const s=["overlays","rules","animations","profiles","timelines"];for(const n of s)t.data[n]&&Array.isArray(t.data[n])&&Dl(`merge.collection.${n}`,(()=>{e.__provenance[n]||(e.__provenance[n]={});for(const s of t.data[n]){if(!s.id)continue;if(!0===s.remove){const r=e[n].findIndex((e=>e.id===s.id));r>=0&&(e[n].splice(r,1),e.__provenance[n][s.id]={...e.__provenance[n][s.id]||{},removed:!0,removal_source:t.pack});continue}const r=e[n].findIndex((e=>e.id===s.id)),i=structuredClone(s);delete i.remove,r>=0?(e[n][r]=i,e.__provenance[n][s.id]={origin_pack:e.__provenance[n][s.id]?.origin_pack||t.pack,overridden:!0,override_layer:t.pack}):(e[n].push(i),e.__provenance[n][s.id]={origin_pack:t.pack,overridden:!1})}Tl(`merge.items.${n}`,t.data[n].length)}));t.data.palettes&&Dl("merge.palettes",(()=>{e.palettes=e.palettes||{},e.__provenance.palettes||(e.__provenance.palettes={});for(const[s,n]of Object.entries(t.data.palettes))if("object"==typeof n&&!Array.isArray(n)){e.palettes[s]||(e.palettes[s]={},e.__provenance.palettes[s]={origin_pack:t.pack,tokens:{},overridden:!1}),e.__provenance.palettes[s].tokens||(e.__provenance.palettes[s].tokens={});for(const[r,i]of Object.entries(n)){const n=void 0!==e.palettes[s][r],o=e.palettes[s][r];e.palettes[s][r]=i,e.__provenance.palettes[s].tokens[r]=n?{origin_pack:e.__provenance.palettes[s].tokens[r]?.origin_pack||"unknown",current_value:i,previous_value:o,overridden:!0,override_pack:t.pack,override_history:[...e.__provenance.palettes[s].tokens[r]?.override_history||[],{pack:t.pack,value:i,timestamp:Date.now()}]}:{origin_pack:t.pack,current_value:i,overridden:!1,override_history:[]}}e.__provenance.palettes[s].origin_pack!==t.pack&&(e.__provenance.palettes[s].overridden=!0,e.__provenance.palettes[s].last_modified_by=t.pack)}let s=0;Object.values(t.data.palettes).forEach((e=>{"object"!=typeof e||Array.isArray(e)||(s+=Object.keys(e).length)})),Tl("merge.palette.tokens",s),Tl("merge.palettes",Object.keys(t.data.palettes).length)})),t.data.anchors&&Dl("merge.anchors",(()=>{for(const[s,n]of Object.entries(t.data.anchors)){const r=s in e.anchors,i=e.anchors[s];e.anchors[s]=n;const o=zl(t,s);if(r){const r=e.__provenance.anchors[s];e.__provenance.anchors[s]={origin_pack:r?.origin_pack||"unknown",origin_type:r?.origin_type||"unknown",coordinates:n,overridden:!0,override_source:t.pack,override_type:o,previous_coordinates:i,override_history:[...r?.override_history||[],{pack:t.pack,type:o,coordinates:n,previous_coordinates:i,timestamp:Date.now()}]}}else e.__provenance.anchors[s]={origin_pack:t.pack,origin_type:o,coordinates:n,overridden:!1,override_history:[]}}Tl("merge.anchors",Object.keys(t.data.anchors).length)})),t.data.routing&&(e.routing={...e.routing,...t.data.routing}),t.data.data_sources&&(e.data_sources={...e.data_sources,...t.data.data_sources}),t.data.debug&&(e.debug={...e.debug,...t.data.debug},e.__provenance.debug?(e.__provenance.debug.overridden=!0,e.__provenance.debug.override_layer=t.pack):e.__provenance.debug={origin_pack:t.pack,overridden:!1}),Array.isArray(t.data.active_profiles)&&(e.active_profiles=[...t.data.active_profiles])}function zl(e,t){return"builtin"===e.type||"external"===e.type?e.data._extracted_anchors&&e.data._extracted_anchors.includes(t)?"svg":"pack":"user"===e.type?"user":"unknown"}try{"undefined"!=typeof window&&(window.__msdDebug=window.__msdDebug||{},window.__msdDebug.packs=window.__msdDebug.packs||{},window.__msdDebug.packs.mergePacks=Ol,window.__msdDebug.exportCollapsed=()=>function(e){const t={};return["version","use_packs","anchors","overlays","animations","rules","profiles","timelines","palettes","routing","active_profiles","remove","debug"].forEach((s=>{e&&void 0!==e[s]&&(t[s]=e[s])})),t}(window.__msdDebug._hudUserMsdConfig||{}))}catch(Xr){}function jl(e,t,s){Array.isArray(e)&&2===e.length?e.forEach(((e,n)=>{const r=0===n?"x":"y";"string"==typeof e?e.endsWith("%")&&!isNaN(parseFloat(e.slice(0,-1)))||t.errors.push({code:"coordinates.invalid",message:`${s} ${r}-coordinate '${e}' must be number or percentage string`}):"number"!=typeof e&&t.errors.push({code:"coordinates.invalid",message:`${s} ${r}-coordinate must be number or percentage string`})})):t.errors.push({code:"coordinates.invalid",message:`${s} must be array of 2 elements [x, y]`})}class Hl{static resolvePosition(e,t){if(Array.isArray(e)&&e.length>=2)return[Number(e[0]),Number(e[1])];if("string"==typeof e&&t[e]){const s=t[e];if(Array.isArray(s)&&s.length>=2)return[Number(s[0]),Number(s[1])]}return console.warn("[PositionResolver] Could not resolve position:",e),null}}class Ul{static _getTextMeasureContext(){return window.cblcars||(window.cblcars={}),window.cblcars._textMeasureCanvas||(window.cblcars._textMeasureCanvas=document.createElement("canvas"),window.cblcars._textMeasureContext=window.cblcars._textMeasureCanvas.getContext("2d"),window.cblcars._textMeasureCache=new Map),window.cblcars._textMeasureContext}static _getSvgTransformInfo(e){try{const t=e?.querySelector("svg");if(!t)return null;const s=t.viewBox.baseVal,n=t.getBoundingClientRect(),r=s.width/n.width,i=s.height/n.height;return{svg:t,viewBox:[s.x,s.y,s.width,s.height],screenRect:{width:n.width,height:n.height},scaleX:r,scaleY:i,pixelToViewBox:e=>e*Math.max(r,i)}}catch(e){return console.warn("[RendererUtils] Failed to get SVG transform info:",e),null}}static measureText(e,t="16px Arial",s=!0,n=null){if(!e)return{width:0,height:0,ascent:0,descent:0};const r=`${e}::${t}`,i=window.cblcars?._textMeasureCache;if(s&&i&&i.has(r)){const e=i.get(r);return n?this._transformTextMetrics(e,n):e}const o=this._getTextMeasureContext();o.font=t;const a=o.measureText(e),l={width:a.width,height:a.actualBoundingBoxAscent+a.actualBoundingBoxDescent,ascent:a.actualBoundingBoxAscent,descent:a.actualBoundingBoxDescent,actualLeft:a.actualBoundingBoxLeft||0,actualRight:a.actualBoundingBoxRight||a.width,_pixelWidth:a.width,_pixelHeight:a.actualBoundingBoxAscent+a.actualBoundingBoxDescent,_pixelAscent:a.actualBoundingBoxAscent,_pixelDescent:a.actualBoundingBoxDescent};return s&&i&&i.set(r,l),n?this._transformTextMetrics(l,n):l}static _transformTextMetrics(e,t){const s=this._getSvgTransformInfo(t);if(!s)return console.warn("[RendererUtils] No transform info available, using pixel metrics"),e;const{pixelToViewBox:n}=s,r={...e,width:n(e._pixelWidth||e.width),height:n(e._pixelHeight||e.height),ascent:n(e._pixelAscent||e.ascent),descent:n(e._pixelDescent||e.descent),actualLeft:n(e.actualLeft),actualRight:n(e.actualRight)};return console.log("[RendererUtils] Transformed text metrics:",{original:{width:e.width,height:e.height},transformed:{width:r.width,height:r.height},scaleInfo:{scaleX:s.scaleX,scaleY:s.scaleY}}),r}static measureMultilineText(e,t="16px Arial",s=1.2,n=!0,r=null){if(!e)return{width:0,height:0,lines:[],lineMetrics:[]};const i=e.split("\n"),o=i.map((e=>this.measureText(e,t,n,r))),a=Math.max(...o.map((e=>e.width))),l=this._parseFontSize(t);let c=l,d=s;if(r){const e=this._getSvgTransformInfo(r);e&&(c=e.pixelToViewBox(l),d=s)}return{width:a,height:i.length>1?o[0].ascent+(i.length-1)*c*d+o[o.length-1].descent:o[0]?.height||0,lines:i,lineMetrics:o,_transformApplied:!!r,_adjustedFontSize:c}}static getTextBoundingBox(e,t,s,n="16px Arial",r="start",i="auto",o=null){const a=this.measureText(e,n,!0,o);let l=t;"middle"===r?l=t-a.width/2:"end"===r&&(l=t-a.width);let c=s-a.ascent;"middle"===i?c=s-a.height/2:"hanging"===i&&(c=s);const d={left:l,right:l+a.width,top:c,bottom:c+a.height,width:a.width,height:a.height,centerX:l+a.width/2,centerY:c+a.height/2};return console.log("[RendererUtils] Text bounding box calculation:",{text:e.substring(0,20)+(e.length>20?"...":""),inputPosition:{x:t,y:s},textAnchor:r,dominantBaseline:i,metrics:{width:a.width,height:a.height,ascent:a.ascent,descent:a.descent},bbox:d,hasContainer:!!o}),d}static getTextAttachmentPoints(e,t,s,n="16px Arial",r="start",i="auto",o=null){const a=this.getTextBoundingBox(e,t,s,n,r,i,o),l=this._getSvgTransformInfo(o),c=l?l.pixelToViewBox(4):4;return{top:[a.centerX,a.top],bottom:[a.centerX,a.bottom],left:[a.left,a.centerY],right:[a.right,a.centerY],center:[a.centerX,a.centerY],topLeft:[a.left,a.top],topRight:[a.right,a.top],bottomLeft:[a.left,a.bottom],bottomRight:[a.right,a.bottom],topPadded:[a.centerX,a.top-c],bottomPadded:[a.centerX,a.bottom+c],leftPadded:[a.left-c,a.centerY],rightPadded:[a.right+c,a.centerY]}}static _parseFontSize(e){const t=e.match(/(\d+(?:\.\d+)?)px/);return t?parseFloat(t[1]):16}static buildFontString(e){const t=[];return e.fontStyle&&"normal"!==e.fontStyle&&t.push(e.fontStyle),e.fontWeight&&"normal"!==e.fontWeight&&t.push(e.fontWeight),t.push(`${e.fontSize}px`),e.fontFamily&&"inherit"!==e.fontFamily?t.push(e.fontFamily):t.push("Arial, sans-serif"),t.join(" ")}static resolveFontFamily(e,t){if(e.fontFamily&&"inherit"!==e.fontFamily)return e.fontFamily;try{const e=t?.querySelector?.("svg"),s=e||t||document.documentElement,n=window.getComputedStyle(s).fontFamily;if(n&&"inherit"!==n)return n}catch(e){console.warn("[RendererUtils] resolveFontFamily failed:",e)}return"Arial, sans-serif"}static buildMeasurementFontString(e,t){const s=this.resolveFontFamily(e,t),n=e.fontStyle&&"normal"!==e.fontStyle?`${e.fontStyle} `:"",r=e.fontWeight&&"normal"!==e.fontWeight?`${e.fontWeight} `:"";let i=e.fontSize;if(t){const s=this._getSvgTransformInfo(t);if(s){const t=s.screenRect.width/s.viewBox[2];i=e.fontSize*t}}return`${n}${r}${i}px ${s}`}static clearTextMeasureCache(){window.cblcars?._textMeasureCache&&window.cblcars._textMeasureCache.clear()}static getTextMeasureCacheStats(){const e=window.cblcars?._textMeasureCache;return{size:e?.size||0,keys:e?Array.from(e.keys()):[]}}static parseGradientConfig(e){if(!e)return null;if("string"==typeof e){if(e.includes(",")){const t=e.split(",").map((e=>e.trim()));return{type:"linear",direction:"horizontal",stops:t.map(((e,s)=>({offset:s/(t.length-1)*100+"%",color:e})))}}if(e.includes("-to-")){const[t,s]=e.split("-to-").map((e=>e.trim()));return{type:"linear",direction:"horizontal",stops:[{offset:"0%",color:t},{offset:"100%",color:s}]}}return null}return"object"==typeof e?{type:e.type||"linear",direction:e.direction||"horizontal",x1:e.x1||"0%",y1:e.y1||"0%",x2:e.x2||"100%",y2:e.y2||"0%",cx:e.cx||"50%",cy:e.cy||"50%",r:e.r||"50%",stops:e.stops||[{offset:"0%",color:e.from||"var(--lcars-orange)"},{offset:"100%",color:e.to||"var(--lcars-red)"}]}:null}static parsePatternConfig(e){return e?"string"==typeof e?{dots:{type:"dots",size:8,color:"currentColor",opacity:.5},lines:{type:"lines",size:4,color:"currentColor",opacity:.5},diagonal:{type:"diagonal",size:8,color:"currentColor",opacity:.5},grid:{type:"grid",size:10,color:"currentColor",opacity:.3}}[e]||null:"object"==typeof e?{type:e.type||"dots",size:Number(e.size||8),color:e.color||"currentColor",opacity:Number(e.opacity||.5),content:e.content||null}:null:null}static parseGlowConfig(e){return e?!0===e?{color:"currentColor",size:4,opacity:.6}:"string"==typeof e?{color:e,size:4,opacity:.6}:"object"==typeof e?{color:e.color||"currentColor",size:Number(e.size||4),opacity:Number(e.opacity||.6),intensity:Number(e.intensity||1)}:null:null}static parseShadowConfig(e){if(!e)return null;if(!0===e)return{color:"rgba(0,0,0,0.3)",offsetX:2,offsetY:2,blur:3};if("string"==typeof e){const t=e.split(" ");return{offsetX:Number(t[0])||2,offsetY:Number(t[1])||2,blur:Number(t[2])||3,color:t[3]||"rgba(0,0,0,0.3)"}}return"object"==typeof e?{color:e.color||"rgba(0,0,0,0.3)",offsetX:Number(e.offsetX||e.offset?.[0]||2),offsetY:Number(e.offsetY||e.offset?.[1]||2),blur:Number(e.blur||3)}:null}static parseBlurConfig(e){return e?"number"==typeof e?{amount:e}:"string"==typeof e?{amount:Number(e)||1}:"object"==typeof e?{amount:Number(e.amount||e.blur||1)}:null:null}static createGradientDefinition(e,t){if("radial"===e.type){const s=e.stops.map((e=>`<stop offset="${e.offset}" stop-color="${e.color}"/>`)).join("");return`<radialGradient id="${t}" cx="${e.cx}" cy="${e.cy}" r="${e.r}">\n                ${s}\n              </radialGradient>`}return`<linearGradient id="${t}" ${this.getLinearGradientCoords(e.direction,e)}>\n                ${e.stops.map((e=>`<stop offset="${e.offset}" stop-color="${e.color}"/>`)).join("")}\n              </linearGradient>`}static getLinearGradientCoords(e,t={}){if(void 0!==t.x1)return`x1="${t.x1}" y1="${t.y1}" x2="${t.x2}" y2="${t.y2}"`;const s={horizontal:'x1="0%" y1="0%" x2="100%" y2="0%"',vertical:'x1="0%" y1="0%" x2="0%" y2="100%"',diagonal:'x1="0%" y1="0%" x2="100%" y2="100%"',"diagonal-reverse":'x1="100%" y1="0%" x2="0%" y2="100%"',"to-right":'x1="0%" y1="0%" x2="100%" y2="0%"',"to-left":'x1="100%" y1="0%" x2="0%" y2="0%"',"to-bottom":'x1="0%" y1="0%" x2="0%" y2="100%"',"to-top":'x1="0%" y1="100%" x2="0%" y2="0%"'};return s[e]||s.horizontal}static createPatternDefinition(e,t){const s=e.size,n=e.color,r=e.opacity;let i="";switch(e.type){case"dots":default:i=`<circle cx="${s/2}" cy="${s/2}" r="1"\n                                  fill="${n}" opacity="${r}"/>`;break;case"lines":i=`<path d="M 0,${s} l ${s},-${s} M -1,1 l 2,-2 M ${s-1},${s+1} l 2,-2"\n                                stroke="${n}" stroke-width="1" opacity="${r}"/>`;break;case"diagonal":i=`<path d="M0,${s} L${s},0"\n                                stroke="${n}" stroke-width="1" opacity="${r}"/>`;break;case"grid":i=`\n          <path d="M0,0 L0,${s}" stroke="${n}" stroke-width="0.5" opacity="${r}"/>\n          <path d="M0,0 L${s},0" stroke="${n}" stroke-width="0.5" opacity="${r}"/>\n        `;break;case"custom":i=e.content||""}return`<pattern id="${t}" x="0" y="0" width="${s}" height="${s}"\n                     patternUnits="userSpaceOnUse">\n              ${i}\n            </pattern>`}static createGlowFilter(e,t){return`<filter id="${t}" x="-50%" y="-50%" width="200%" height="200%">\n              <feGaussianBlur stdDeviation="${e.size||4}" result="coloredBlur"/>\n              <feFlood flood-color="${e.color||"currentColor"}" flood-opacity="${e.intensity||1}"/>\n              <feComposite in="flood" in2="coloredBlur" operator="in" result="glowColor"/>\n              <feMerge>\n                <feMergeNode in="glowColor"/>\n                <feMergeNode in="SourceGraphic"/>\n              </feMerge>\n            </filter>`}static createShadowFilter(e,t){return`<filter id="${t}" x="-50%" y="-50%" width="200%" height="200%">\n              <feDropShadow dx="${e.offsetX||2}" dy="${e.offsetY||2}"\n                           stdDeviation="${e.blur||3}"\n                           flood-color="${e.color||"rgba(0,0,0,0.3)"}"/>\n            </filter>`}static createBlurFilter(e,t){return`<filter id="${t}" x="-50%" y="-50%" width="200%" height="200%">\n              <feGaussianBlur stdDeviation="${e.amount||1}"/>\n            </filter>`}static createLcarsBracket(e,t,s="left",n={}){n.bracketWidth;const r=n.cornerRadius||2,i=n.strokeWidth||2;let o="";return o="left"===s?`M ${e} 0 L ${r} 0\n                  Q 0 0 0 ${r}\n                  L 0 ${t-r}\n                  Q 0 ${t} ${r} ${t}\n                  L ${e} ${t}`:`M 0 0 L ${e-r} 0\n                  Q ${e} 0 ${e} ${r}\n                  L ${e} ${t-r}\n                  Q ${e} ${t} ${e-r} ${t}\n                  L 0 ${t}`,`<path d="${o}"\n                  stroke="${n.color||"var(--lcars-orange)"}"\n                  stroke-width="${i}"\n                  fill="none"/>`}static createMarkerDefinition(e,t){const s=this.getMarkerSize(e.size||"medium"),n="inherit"===e.color?"currentColor":e.color;let r="",i=`0 0 ${s} ${s}`,o=s/2,a=s/2;switch(e.type){case"arrow":i="0 0 10 10",o=8,a=5,r=`<path d="M2,2 L8,5 L2,8 z" fill="${n}"/>`;break;case"dot":case"circle":default:r=`<circle cx="${s/2}" cy="${s/2}" r="${s/4}" fill="${n}"/>`;break;case"diamond":r=`<path d="M${s/2},2 L${s-2},${s/2} L${s/2},${s-2} L2,${s/2} z" fill="${n}"/>`;break;case"square":r=`<rect x="2" y="2" width="${s-4}" height="${s-4}" fill="${n}"/>`;break;case"triangle":r=`<path d="M${s/2},2 L${s-2},${s-2} L2,${s-2} z" fill="${n}"/>`}return`<marker id="${t}"\n                    viewBox="${i}"\n                    refX="${o}" refY="${a}"\n                    markerWidth="${s}" markerHeight="${s}"\n                    markerUnits="strokeWidth"\n                    orient="${!1!==e.rotate?"auto":"0"}">\n              ${r}\n            </marker>`}static getMarkerSize(e){return"number"==typeof e?e:{small:6,medium:8,large:12,xlarge:16}[e]||8}static escapeXml(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}static generateId(e="element",t=""){return`${e}-${Date.now().toString(36)}-${Math.random().toString(36).substr(2,5)}${t?"-"+t:""}`}static parseColor(e){const t=document.createElement("div");t.style.color=e,document.body.appendChild(t);const s=getComputedStyle(t).color;document.body.removeChild(t);const n=s.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(n){const t=parseInt(n[1]),r=parseInt(n[2]),i=parseInt(n[3]);return{rgb:[t,r,i],hex:this.rgbToHex(t,r,i),hsl:this.rgbToHsl(t,r,i),original:e,computed:s}}return{original:e,computed:s}}static rgbToHex(e,t,s){return"#"+((1<<24)+(e<<16)+(t<<8)+s).toString(16).slice(1)}static rgbToHsl(e,t,s){e/=255,t/=255,s/=255;const n=Math.max(e,t,s),r=Math.min(e,t,s);let i,o,a=(n+r)/2;if(n===r)i=o=0;else{const l=n-r;switch(o=a>.5?l/(2-n-r):l/(n+r),n){case e:i=(t-s)/l+(t<s?6:0);break;case t:i=(s-e)/l+2;break;case s:i=(e-t)/l+4}i/=6}return[Math.round(360*i),Math.round(100*o),Math.round(100*a)]}static getContrastColor(e){const t=this.parseColor(e);if(!t.rgb)return"#ffffff";const[s,n,r]=t.rgb;return(.299*s+.587*n+.114*r)/255>.5?"#000000":"#ffffff"}static interpolateColor(e,t,s){const n=this.parseColor(e),r=this.parseColor(t);return n.rgb&&r.rgb?`rgb(${Math.round(n.rgb[0]+(r.rgb[0]-n.rgb[0])*s)}, ${Math.round(n.rgb[1]+(r.rgb[1]-n.rgb[1])*s)}, ${Math.round(n.rgb[2]+(r.rgb[2]-n.rgb[2])*s)})`:e}static createAnimationAttributes(e={}){const t=[];if(!1!==e.animatable&&t.push('data-animatable="true"'),Object.keys(e).forEach((s=>{if(s.endsWith("_speed")||s.endsWith("Speed")){const n=e[s];if(n>0){const e=s.replace(/([A-Z])/g,"-$1").toLowerCase().replace("_","-");t.push(`data-${e}="${n}"`)}}})),e.animation_ref||e.animationRef){const s=e.animation_ref||e.animationRef;t.push(`data-animation-ref="${s}"`)}return t}static sanitizeStyles(e){const t={},s={color:e=>this.isValidColor(e),opacity:e=>this.isValidOpacity(e),width:e=>this.isValidNumber(e),height:e=>this.isValidNumber(e),stroke:e=>this.isValidColor(e),fill:e=>this.isValidColor(e)||"none"===e,fontSize:e=>this.isValidNumber(e),fontFamily:e=>this.isValidString(e)};return Object.keys(e).forEach((n=>{const r=s[n]||s[this.camelToKebab(n)];r&&r(e[n])&&(t[n]=e[n])})),t}static isValidColor(e){return"string"==typeof e&&/^(#[0-9a-f]{3,8}|rgb\(|rgba\(|hsl\(|hsla\(|var\(--|\w+)/.test(e.toLowerCase())}static isValidOpacity(e){const t=Number(e);return!isNaN(t)&&t>=0&&t<=1}static isValidNumber(e){return!isNaN(Number(e))&&isFinite(Number(e))}static isValidString(e){return"string"==typeof e&&e.length>0}static camelToKebab(e){return e.replace(/([A-Z])/g,"-$1").toLowerCase()}static getDomTextBBox(e){try{if(!e)return null;const t=e.querySelector("text");if(!t)return null;const s=t.getBBox();return{width:s.width,height:s.height,left:s.x,top:s.y,right:s.x+s.width,bottom:s.y+s.height,centerX:s.x+s.width/2,centerY:s.y+s.height/2}}catch(e){return null}}}class Gl{constructor(){this.gradientCache=new Map,this.patternCache=new Map,this.filterCache=new Map}static render(e,t,s,n){const r=new Gl;return r.container=n,r.viewBox=s,r.renderText(e,t,s)}renderText(e,t,s){const n=Hl.resolvePosition(e.position,t);if(!n)return console.warn("[TextOverlayRenderer] Text overlay position could not be resolved:",e.id),"";const[r,i]=n;try{const t=e.finalStyle||e.style||{},s=this._resolveTextStyles(t,e.id);if(this.container&&"undefined"!=typeof window)try{const e=this.container,n=e?getComputedStyle(e):null;if(n&&("inherit"===s.fontFamily&&n.fontFamily&&(s.fontFamily=n.fontFamily),!t.font_size&&!t.fontSize&&n.fontSize)){const e=parseFloat(n.fontSize);!isNaN(e)&&e>0&&(s.fontSize=e)}}catch(e){}const n=this._prepareAnimationAttributes(e,t),o=this._resolveTextContent(e,t);if(!o)return console.warn(`[TextOverlayRenderer] No text content for overlay ${e.id}`),"";s._cachedContent=o;const a=this._measureTextBlock(o,r,i,s),l=[this._buildDefinitions(s,e.id),this._buildMainText(o,r,i,s,e.id,n),this._buildTextDecorations(o,r,i,s,e.id),this._buildEffects(o,r,i,s,e.id)].filter(Boolean);return console.log(`[TextOverlayRenderer] Rendered enhanced text ${e.id} with ${s.features.length} features`),`<g data-overlay-id="${e.id}"\n                  data-overlay-type="text"\n                  data-text-features="${s.features.join(",")}"\n                  data-animation-ready="${!!n.hasAnimations}"\n                  data-text-width="${a.width||0}"\n                  data-text-height="${a.height||0}"\n                  data-font-family="${s.fontFamily}"\n                  data-font-size="${s.fontSize}"\n                  data-font-stabilized="0">\n                ${l.join("\n")}\n              </g>`}catch(t){return console.error(`[TextOverlayRenderer] Enhanced rendering failed for text ${e.id}:`,t),this._renderFallbackText(e,r,i)}}_resolveTextStyles(e,t){const s={color:e.color||e.fill||"var(--lcars-orange)",fontSize:Number(e.font_size||e.fontSize||16),fontFamily:e.font_family||e.fontFamily||"inherit",fontWeight:e.font_weight||e.fontWeight||"normal",fontStyle:e.font_style||e.fontStyle||"normal",textAnchor:(e.text_anchor||e.textAnchor||"start").toLowerCase(),dominantBaseline:(e.dominant_baseline||e.dominantBaseline||"auto").toLowerCase(),alignmentBaseline:(e.alignment_baseline||e.alignmentBaseline||"auto").toLowerCase(),letterSpacing:e.letter_spacing||e.letterSpacing||"normal",wordSpacing:e.word_spacing||e.wordSpacing||"normal",textDecoration:e.text_decoration||e.textDecoration||"none",opacity:Number(e.opacity||1),visibility:e.visibility||"visible",stroke:e.stroke||null,strokeWidth:Number(e.stroke_width||e.strokeWidth||0),strokeOpacity:Number(e.stroke_opacity||e.strokeOpacity||1),strokeLinecap:(e.stroke_linecap||e.strokeLinecap||"butt").toLowerCase(),strokeLinejoin:(e.stroke_linejoin||e.strokeLinejoin||"miter").toLowerCase(),strokeDasharray:e.stroke_dasharray||e.strokeDasharray||null,strokeDashoffset:Number(e.stroke_dashoffset||e.strokeDashoffset||0),gradient:this._parseGradientConfig(e.gradient),pattern:this._parsePatternConfig(e.pattern),glow:this._parseGlowConfig(e.glow),shadow:this._parseShadowConfig(e.shadow),blur:this._parseBlurConfig(e.blur),multiline:e.multiline||!1,lineHeight:Number(e.line_height||e.lineHeight||1.2),maxWidth:Number(e.max_width||e.maxWidth||0),textWrapping:e.text_wrapping||e.textWrapping||"none",animatable:!1!==e.animatable,pulseSpeed:Number(e.pulse_speed||0),fadeSpeed:Number(e.fade_speed||0),typewriterSpeed:Number(e.typewriter_speed||0),status_indicator:e.status_indicator||null,status_indicator_position:e.status_indicator_position||e.statusIndicatorPosition||"left-center",bracket_style:e.bracket_style||null,highlight:e.highlight||!1,features:[]};return s.gradient&&s.features.push("gradient"),s.pattern&&s.features.push("pattern"),s.stroke&&s.strokeWidth>0&&s.features.push("stroke"),s.glow&&s.features.push("glow"),s.shadow&&s.features.push("shadow"),s.blur&&s.features.push("blur"),s.multiline&&s.features.push("multiline"),s.pulseSpeed>0&&s.features.push("pulse"),s.fadeSpeed>0&&s.features.push("fade"),s.typewriterSpeed>0&&s.features.push("typewriter"),s.status_indicator&&s.features.push("status"),s.bracket_style&&s.features.push("brackets"),s.highlight&&s.features.push("highlight"),s}_resolveTextContent(e,t){return t.value||e.text||e.content||""}_buildDefinitions(e,t){const s=[];return e.gradient&&s.push(this._createGradientDefinition(e.gradient,t)),e.pattern&&s.push(this._createPatternDefinition(e.pattern,t)),e.glow&&s.push(this._createGlowFilter(e.glow,t)),e.shadow&&s.push(this._createShadowFilter(e.shadow,t)),e.blur&&s.push(this._createBlurFilter(e.blur,t)),0===s.length?"":`<defs>${s.join("\n")}</defs>`}_buildMainText(e,t,s,n,r,i){if(n.multiline)return this._buildMultilineText(e,t,s,n,r,i);const o=[];o.push(`x="${t}"`),o.push(`y="${s}"`),this._applyTextAttributes(o,n,r),o.push(...i.textAttributes);const a=this.escapeXml(e);return`<text ${o.join(" ")}>${a}</text>`}_buildMultilineText(e,t,s,n,r,i){const o=e.split("\n"),a=n.fontSize*n.lineHeight,l=[];o.forEach(((e,s)=>{const n=0===s?0:a,r=this.escapeXml(e);l.push(`<tspan x="${t}" dy="${n}">${r}</tspan>`)}));const c=[];return c.push(`y="${s}"`),this._applyTextAttributes(c,n,r),c.push(...i.textAttributes),`<text ${c.join(" ")}>${l.join("")}</text>`}_applyTextAttributes(e,t,s){t.gradient?e.push(`fill="url(#text-gradient-${s})"`):t.pattern?e.push(`fill="url(#text-pattern-${s})"`):e.push(`fill="${t.color}"`),e.push(`fill-opacity="${t.opacity}"`),e.push(`font-size="${t.fontSize}"`),"inherit"!==t.fontFamily&&e.push(`font-family="${t.fontFamily}"`),"normal"!==t.fontWeight&&e.push(`font-weight="${t.fontWeight}"`),"normal"!==t.fontStyle&&e.push(`font-style="${t.fontStyle}"`),"start"!==t.textAnchor&&e.push(`text-anchor="${t.textAnchor}"`),"auto"!==t.dominantBaseline&&e.push(`dominant-baseline="${t.dominantBaseline}"`),"auto"!==t.alignmentBaseline&&e.push(`alignment-baseline="${t.alignmentBaseline}"`),"normal"!==t.letterSpacing&&e.push(`letter-spacing="${t.letterSpacing}"`),"normal"!==t.wordSpacing&&e.push(`word-spacing="${t.wordSpacing}"`),"none"!==t.textDecoration&&e.push(`text-decoration="${t.textDecoration}"`),t.stroke&&t.strokeWidth>0&&(e.push(`stroke="${t.stroke}"`),e.push(`stroke-width="${t.strokeWidth}"`),e.push(`stroke-opacity="${t.strokeOpacity}"`),e.push(`stroke-linecap="${t.strokeLinecap}"`),e.push(`stroke-linejoin="${t.strokeLinejoin}"`),t.strokeDasharray&&(e.push(`stroke-dasharray="${t.strokeDasharray}"`),0!==t.strokeDashoffset&&e.push(`stroke-dashoffset="${t.strokeDashoffset}"`))),"visible"!==t.visibility&&e.push(`visibility="${t.visibility}"`);const n=[];t.glow&&n.push(`url(#text-glow-${s})`),t.shadow&&n.push(`url(#text-shadow-${s})`),t.blur&&n.push(`url(#text-blur-${s})`),n.length>0&&e.push(`filter="${n.join(" ")}"`)}_buildTextDecorations(e,t,s,n,r){const i=[];return n.bracket_style&&i.push(this._buildBrackets(e,t,s,n,r)),n.highlight&&i.push(this._buildHighlight(e,t,s,n,r)),n.status_indicator&&i.push(this._buildStatusIndicator(t,s,n,r)),i.filter(Boolean).join("\n")}_buildEffects(e,t,s,n,r){return n.features.includes("typewriter"),n.features.includes("pulse"),n.features.includes("fade"),[].join("\n")}_buildBrackets(e,t,s,n,r){const i=Ul.buildMeasurementFontString(n,this.container);let o;if(n.multiline){const r=Ul.measureMultilineText(e,i,n.lineHeight);let a=t;"middle"===n.textAnchor?a=t-r.width/2:"end"===n.textAnchor&&(a=t-r.width);let l=s-r.lineMetrics[0]?.ascent||0;"middle"===n.dominantBaseline?l=s-r.height/2:"hanging"===n.dominantBaseline&&(l=s),o={left:a,right:a+r.width,top:l,bottom:l+r.height,width:r.width,height:r.height}}else o=Ul.getTextBoundingBox(e,t,s,i,n.textAnchor,n.dominantBaseline);const a=o.left-8-4,l=o.right+4,c=o.top-4,d=o.bottom+4,u=n.color,h=Math.max(1,n.fontSize/16);return`<g data-decoration="brackets">\n              <path d="M ${a+8} ${c} L ${a} ${c} L ${a} ${d} L ${a+8} ${d}"\n                    stroke="${u}" stroke-width="${h}" fill="none"/>\n              <path d="M ${l-8} ${c} L ${l} ${c} L ${l} ${d} L ${l-8} ${d}"\n                    stroke="${u}" stroke-width="${h}" fill="none"/>\n            </g>`}_buildHighlight(e,t,s,n,r){const i=Ul.buildMeasurementFontString(n,this.container);let o;if(n.multiline){const r=Ul.measureMultilineText(e,i,n.lineHeight,!0,this.container);let a=t;"middle"===n.textAnchor?a=t-r.width/2:"end"===n.textAnchor&&(a=t-r.width);let l=s-r.lineMetrics[0]?.ascent||0;"middle"===n.dominantBaseline?l=s-r.height/2:"hanging"===n.dominantBaseline&&(l=s),o={left:a,right:a+r.width,top:l,bottom:l+r.height,width:r.width,height:r.height}}else o=Ul.getTextBoundingBox(e,t,s,i,n.textAnchor,n.dominantBaseline,this.container);const a=Ul._getSvgTransformInfo(this.container),l=a?a.pixelToViewBox(2):2;return`<rect x="${o.left-l}" y="${o.top-l}"\n                  width="${o.width+2*l}" height="${o.height+2*l}"\n                  fill="${"string"==typeof n.highlight?n.highlight:"var(--lcars-blue-light)"}" fill-opacity="${"number"==typeof n.highlight_opacity?n.highlight_opacity:.3}"\n                  data-decoration="highlight"/>`}_buildStatusIndicator(e,t,s,n){const r=.4*s.fontSize,i="string"==typeof s.status_indicator?s.status_indicator:"var(--lcars-green)",o=s.status_indicator_position||"left-center",a=s._cachedContent||s.value||"",l=Ul.buildMeasurementFontString(s,this.container),c=Ul._getSvgTransformInfo(this.container);let d;if(console.log(`[TextOverlayRenderer] Transform info for ${n}:`,{transformInfo:c,containerTag:this.container?.tagName,hasSvg:!!this.container?.querySelector("svg")}),s.multiline){const n=Ul.measureMultilineText(a,l,s.lineHeight,!0,this.container);let r=e;"middle"===s.textAnchor?r=e-n.width/2:"end"===s.textAnchor&&(r=e-n.width);let i=t-(n.lineMetrics[0]?.ascent||0);"middle"===s.dominantBaseline?i=t-n.height/2:"hanging"===s.dominantBaseline&&(i=t),d={left:r,right:r+n.width,top:i,bottom:i+n.height,width:n.width,height:n.height,centerX:r+n.width/2,centerY:i+n.height/2}}else{const n=Ul.measureText(a,l,!0,this.container);let r=e;"middle"===s.textAnchor?r=e-n.width/2:"end"===s.textAnchor&&(r=e-n.width);let i=t-n.ascent;"middle"===s.dominantBaseline?i=t-n.height/2:"hanging"===s.dominantBaseline&&(i=t),d={left:r,right:r+n.width,top:i,bottom:i+n.height,width:n.width,height:n.height,centerX:r+n.width/2,centerY:i+n.height/2}}console.log(`[TextOverlayRenderer] Status indicator debug for ${n}:`,{textContent:a,x:e,y:t,textAnchor:s.textAnchor,dominantBaseline:s.dominantBaseline,position:o,bbox:d,fontSize:s.fontSize,hasContainer:!!this.container,containerType:this.container?.tagName,transformInfo:c?{scaleX:c.scaleX,scaleY:c.scaleY,viewBox:c.viewBox}:null});let u=e,h=t;const p=c?c.pixelToViewBox(8):r;switch(o){case"top-left":u=d.left-p,h=d.top-p;break;case"top-right":u=d.right+p,h=d.top-p;break;case"bottom-left":u=d.left-p,h=d.bottom+p;break;case"bottom-right":u=d.right+p,h=d.bottom+p;break;case"top":u=d.centerX,h=d.top-p;break;case"bottom":u=d.centerX,h=d.bottom+p;break;case"left-center":case"left":default:u=d.left-p,h=d.centerY;break;case"right-center":case"right":u=d.right+p,h=d.centerY;break;case"center":u=d.centerX,h=d.centerY}return console.log(`[TextOverlayRenderer] Status indicator final position for ${n}:`,{indicatorX:u,indicatorY:h,padding:p,pixelPadding:8,transformInfo:c?"present":"missing"}),`<circle cx="${u}" cy="${h}" r="${r}"\n                    fill="${i}"\n                    data-status-pos="${o}"\n                    data-decoration="status-indicator"/>`}_createGradientDefinition(e,t){const s=`text-gradient-${t}`;if("string"==typeof e){const[t,n]=e.split(",").map((e=>e.trim()));return`<linearGradient id="${s}">\n                <stop offset="0%" stop-color="${t||"var(--lcars-orange)"}"/>\n                <stop offset="100%" stop-color="${n||"var(--lcars-red)"}"/>\n              </linearGradient>`}const n=e.type||"linear",r=e.stops||[{offset:"0%",color:"var(--lcars-orange)"},{offset:"100%",color:"var(--lcars-red)"}];return"radial"===n?`<radialGradient id="${s}" cx="${e.cx||"50%"}" cy="${e.cy||"50%"}" r="${e.r||"50%"}">\n                ${r.map((e=>`<stop offset="${e.offset}" stop-color="${e.color}"/>`)).join("")}\n              </radialGradient>`:`<linearGradient id="${s}" x1="${e.x1||"0%"}" y1="${e.y1||"0%"}" x2="${e.x2||"100%"}" y2="${e.y2||"0%"}">\n                ${r.map((e=>`<stop offset="${e.offset}" stop-color="${e.color}"/>`)).join("")}\n              </linearGradient>`}_createPatternDefinition(e,t){const s=`text-pattern-${t}`;if("string"==typeof e)switch(e){case"dots":return`<pattern id="${s}" patternUnits="userSpaceOnUse" width="8" height="8">\n                    <circle cx="4" cy="4" r="1" fill="currentColor"/>\n                  </pattern>`;case"lines":return`<pattern id="${s}" patternUnits="userSpaceOnUse" width="4" height="4">\n                    <path d="M 0,4 l 4,-4 M -1,1 l 2,-2 M 3,5 l 2,-2" stroke="currentColor" stroke-width="1"/>\n                  </pattern>`;default:return""}const n=e.width||10,r=e.height||10;return`<pattern id="${s}" patternUnits="${e.patternUnits||"userSpaceOnUse"}" width="${n}" height="${r}">\n              ${e.content||""}\n            </pattern>`}_createGlowFilter(e,t){const s=`text-glow-${t}`;let n,r,i;return"string"==typeof e?(n=e,r=3,i=1):(n=e.color||"var(--lcars-orange)",r=Number(e.blur||3),i=Number(e.intensity||1)),`<filter id="${s}">\n              <feGaussianBlur stdDeviation="${r}" result="blur"/>\n              <feFlood flood-color="${n}" flood-opacity="${i}" result="color"/>\n              <feComposite in="color" in2="blur" operator="in" result="coloredBlur"/>\n              <feMerge>\n                <feMergeNode in="coloredBlur"/>\n                <feMergeNode in="SourceGraphic"/>\n              </feMerge>\n            </filter>`}_createShadowFilter(e,t){const s=`text-shadow-${t}`;let n,r,i,o;return"string"==typeof e?([n,r,i,o]=e.split(" "),n=Number(n)||2,r=Number(r)||2,i=Number(i)||2,o=o||"rgba(0,0,0,0.5)"):(n=Number(e.offsetX||2),r=Number(e.offsetY||2),i=Number(e.blur||2),o=e.color||"rgba(0,0,0,0.5)"),`<filter id="${s}">\n              <feDropShadow dx="${n}" dy="${r}" stdDeviation="${i}" flood-color="${o}"/>\n            </filter>`}_createBlurFilter(e,t){return`<filter id="text-blur-${t}">\n              <feGaussianBlur stdDeviation="${"number"==typeof e?e:Number(e)||1}"/>\n            </filter>`}_parseGradientConfig(e){return e?"string"==typeof e?e:{type:e.type||"linear",x1:e.x1||"0%",y1:e.y1||"0%",x2:e.x2||"100%",y2:e.y2||"0%",cx:e.cx||"50%",cy:e.cy||"50%",r:e.r||"50%",stops:e.stops||[]}:null}_parsePatternConfig(e){return e||null}_parseGlowConfig(e){return e||null}_parseShadowConfig(e){return e||null}_parseBlurConfig(e){return e||null}_prepareAnimationAttributes(e,t){const s={textAttributes:[],hasAnimations:!1};return(t.pulse_speed||t.pulseSpeed)&&(s.textAttributes.push(`data-pulse-speed="${t.pulse_speed||t.pulseSpeed}"`),s.hasAnimations=!0),(t.fade_speed||t.fadeSpeed)&&(s.textAttributes.push(`data-fade-speed="${t.fade_speed||t.fadeSpeed}"`),s.hasAnimations=!0),(t.typewriter_speed||t.typewriterSpeed)&&(s.textAttributes.push(`data-typewriter-speed="${t.typewriter_speed||t.typewriterSpeed}"`),s.hasAnimations=!0),s.hasAnimations&&s.textAttributes.push('data-animatable="true"'),s}_renderFallbackText(e,t,s){const n=e.finalStyle||e.style||{},r=n.value||e.text||"",i=n.color||"var(--lcars-orange)",o=n.font_size||n.fontSize||16;return console.warn(`[TextOverlayRenderer] Using fallback rendering for text ${e.id}`),`<g data-overlay-id="${e.id}" data-overlay-type="text" data-fallback="true">\n              <text x="${t}" y="${s}"\n                    fill="${i}"\n                    font-size="${o}"\n                    text-anchor="start"\n                    dominant-baseline="auto">\n                ${this.escapeXml(r)}\n              </text>\n            </g>`}updateTextStyle(e,t){console.log(`[TextOverlayRenderer] Style update requested for text ${e}`)}getCapabilities(){return{multiline:!0,gradients:!0,patterns:!0,effects:["glow","shadow","blur"],decorations:["brackets","highlight","status"],animations:["pulse","fade","typewriter"],textWrapping:!0,advancedTypography:!0,strokeText:!0,advanced:!0}}static escapeXml(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}escapeXml(e){return Gl.escapeXml(e)}getAttachmentPoints(e,t,s){const n=this._resolveTextContent(e,e.finalStyle||{}),r=this._resolveTextStyles(e.finalStyle||{},e.id),i=Ul.buildMeasurementFontString(r,this.container);return Ul.getTextAttachmentPoints(n,t,s,i,r.textAnchor,r.dominantBaseline,this.container)}static computeAttachmentPoints(e,t,s){if(!e||"text"!==e.type)return null;const n=Hl.resolvePosition(e.position,t);if(!n)return null;const[r,i]=n,o=new Gl,a=e.finalStyle||e.style||{},l=o._resolveTextStyles(a,e.id),c=o._resolveTextContent(e,a);if(!c)return null;const d=Ul.buildMeasurementFontString(l,s),u=Ul.getTextBoundingBox(c,r,i,d,l.textAnchor,l.dominantBaseline,s),h=Ul.getTextAttachmentPoints(c,r,i,d,l.textAnchor,l.dominantBaseline,s);return{id:e.id,center:h.center,points:h,bbox:u,textStyle:l,x:r,y:i}}_measureTextBlock(e,t,s,n){try{const t=Ul.buildMeasurementFontString(n,this.container);if(n.multiline){const s=Ul.measureMultilineText(e,t,n.lineHeight,!0,this.container);return{width:s.width,height:s.height}}{const s=Ul.measureText(e,t,!0,this.container);return{width:s.width,height:s.height}}}catch(e){return{width:0,height:0}}}}class Vl{constructor(){this.gradientCache=new Map,this.patternCache=new Map,this.filterCache=new Map,this.pathCache=new Map}static render(e,t,s){return(new Vl).renderSparkline(e,t,s)}renderSparkline(e,t,s){const n=Hl.resolvePosition(e.position,t);if(!n)return console.warn("[SparklineRenderer] Sparkline overlay position could not be resolved:",e.id),"";const[r,i]=n,o=e.size||[200,60],[a,l]=o;try{const t=Vl.getHistoricalDataForSparkline(e.source),s=e.finalStyle||e.style||{},n=this._resolveSparklineStyles(s,e.id),o=this._prepareAnimationAttributes(e,s);return console.log(`[SparklineRenderer] Data result for ${e.id}:`,t.status,t.data?.length),"OK"===t.status&&t.data&&t.data.length>=2?this._renderEnhancedSparkline(e,r,i,a,l,t.data,n,o):this._renderEnhancedStatusIndicator(e,r,i,a,l,t,n,o)}catch(t){return console.error(`[SparklineRenderer] Enhanced rendering failed for sparkline ${e.id}:`,t),this._renderFallbackSparkline(e,r,i,a,l)}}_resolveSparklineStyles(e,t){const s={color:e.color||e.stroke||"var(--lcars-yellow)",width:Number(e.width||e.stroke_width||e.strokeWidth||2),opacity:Number(e.opacity||1),lineCap:(e.line_cap||e.lineCap||e.strokeLinecap||"round").toLowerCase(),lineJoin:(e.line_join||e.lineJoin||e.strokeLinejoin||"round").toLowerCase(),miterLimit:Number(e.miter_limit||e.miterLimit||4),dashArray:e.dash_array||e.dashArray||e.strokeDasharray||null,dashOffset:Number(e.dash_offset||e.dashOffset||e.strokeDashoffset||0),smoothing_mode:(e.smoothing_mode||e.smoothingMode||"none").toLowerCase(),interpolation:(e.interpolation||"linear").toLowerCase(),path_precision:Number(e.path_precision||e.pathPrecision||2),fill:e.fill||"none",fillOpacity:Number(e.fill_opacity||e.fillOpacity||.2),fillGradient:this._parseGradientConfig(e.fill_gradient||e.fillGradient),gradient:this._parseGradientConfig(e.gradient),pattern:this._parsePatternConfig(e.pattern),show_points:e.show_points||e.showPoints||!1,point_size:Number(e.point_size||e.pointSize||3),point_color:e.point_color||e.pointColor||null,show_last_value:e.show_last_value||e.showLastValue||!1,value_format:e.value_format||e.valueFormat||null,thresholds:this._parseThresholds(e.thresholds),zero_line:e.zero_line||e.zeroLine||!1,zero_line_color:e.zero_line_color||e.zeroLineColor||"var(--lcars-gray)",min_value:void 0!==e.min_value?Number(e.min_value):null,max_value:void 0!==e.max_value?Number(e.max_value):null,auto_scale:!1!==e.auto_scale,glow:this._parseGlowConfig(e.glow),shadow:this._parseShadowConfig(e.shadow),blur:this._parseBlurConfig(e.blur),bracket_style:e.bracket_style||e.bracketStyle||!1,bracket_width:Number(e.bracket_width||e.bracketWidth||2),bracket_color:e.bracket_color||e.bracketColor||null,bracket_gap:Number(e.bracket_gap||e.bracketGap||6),bracket_corner_radius:Number(e.bracket_corner_radius||e.bracketCornerRadius||0),bracket_style_mode:(e.bracket_style_mode||e.bracketStyleMode||"square").toLowerCase(),status_indicator:e.status_indicator||e.statusIndicator||!1,scan_line:e.scan_line||e.scanLine||!1,grid_lines:e.grid_lines||e.gridLines||!1,grid_color:e.grid_color||e.gridColor||"var(--lcars-gray)",grid_opacity:Number(e.grid_opacity||e.gridOpacity||.4),grid_stroke_width:Number(e.grid_stroke_width||e.gridStrokeWidth||1),grid_horizontal_count:Number(e.grid_horizontal_count||e.gridHorizontalCount||3),grid_vertical_count:Number(e.grid_vertical_count||e.gridVerticalCount||5),animatable:!1!==e.animatable,tracer_speed:Number(e.tracer_speed||e.tracerSpeed||0),pulse_speed:Number(e.pulse_speed||e.pulseSpeed||0),decimation:Number(e.decimation||0),max_points:Number(e.max_points||e.maxPoints||1e3),features:[]};return s.gradient&&s.features.push("gradient"),s.pattern&&s.features.push("pattern"),"none"!==s.fill&&s.features.push("area-fill"),s.fillGradient&&s.features.push("area-gradient"),s.show_points&&s.features.push("data-points"),s.thresholds&&s.thresholds.length>0&&s.features.push("thresholds"),s.zero_line&&s.features.push("zero-line"),s.glow&&s.features.push("glow"),s.shadow&&s.features.push("shadow"),s.blur&&s.features.push("blur"),s.bracket_style&&s.features.push("brackets"),s.status_indicator&&s.features.push("status"),s.scan_line&&s.features.push("scan-line"),s.grid_lines&&s.features.push("grid"),s.show_last_value&&s.features.push("value-label"),"none"!==s.smoothing_mode&&s.features.push("smoothing"),s.tracer_speed>0&&s.features.push("tracer"),s.pulse_speed>0&&s.features.push("pulse"),s}_renderEnhancedSparkline(e,t,s,n,r,i,o,a){const l=[this._buildDefinitions(o,e.id),this._buildSparklineBackground(n,r,o,e.id),this._buildGridLines(n,r,o,e.id),this._buildThresholdLines(i,n,r,o,e.id),this._buildZeroLine(i,n,r,o,e.id),this._buildAreaFill(i,n,r,o,e.id),this._buildMainSparklinePath(i,n,r,o,e.id,a),this._buildDataPoints(i,n,r,o,e.id),this._buildValueLabel(i,n,r,o,e.id),this._buildBrackets(n,r,o,e.id),this._buildStatusIndicator(n,r,o,e.id),this._buildScanLine(n,r,o,e.id)].filter(Boolean);return console.log(`[SparklineRenderer] Rendered enhanced sparkline ${e.id} with ${o.features.length} features`),`<g data-overlay-id="${e.id}"\n                data-overlay-type="sparkline"\n                data-source="${e.source}"\n                data-sparkline-features="${o.features.join(",")}"\n                data-animation-ready="${!!a.hasAnimations}"\n                transform="translate(${t}, ${s})">\n              ${l.join("\n")}\n            </g>`}_buildDefinitions(e,t){const s=[];return e.gradient&&s.push(Ul.createGradientDefinition(e.gradient,`sparkline-gradient-${t}`)),e.fillGradient&&s.push(Ul.createGradientDefinition(e.fillGradient,`sparkline-area-gradient-${t}`)),e.pattern&&s.push(Ul.createPatternDefinition(e.pattern,`sparkline-pattern-${t}`)),e.glow&&s.push(Ul.createGlowFilter(e.glow,`sparkline-glow-${t}`)),e.shadow&&s.push(Ul.createShadowFilter(e.shadow,`sparkline-shadow-${t}`)),e.blur&&s.push(Ul.createBlurFilter(e.blur,`sparkline-blur-${t}`)),s.length>0?`<defs>${s.join("\n")}</defs>`:""}_buildSparklineBackground(e,t,s,n){return""}_buildGridLines(e,t,s,n){if(!s.grid_lines)return"";const r=[];for(let n=1;n<s.grid_horizontal_count;n++){const i=t/s.grid_horizontal_count*n;r.push(`<line x1="0" y1="${i}" x2="${e}" y2="${i}"\n                        stroke="${s.grid_color}"\n                        stroke-width="${s.grid_stroke_width}"\n                        opacity="${s.grid_opacity}"/>`)}for(let n=1;n<s.grid_vertical_count;n++){const i=e/s.grid_vertical_count*n;r.push(`<line x1="${i}" y1="0" x2="${i}" y2="${t}"\n                        stroke="${s.grid_color}"\n                        stroke-width="${s.grid_stroke_width}"\n                        opacity="${s.grid_opacity}"/>`)}return`<g data-feature="grid-lines">${r.join("\n")}</g>`}_buildThresholdLines(e,t,s,n,r){if(!n.thresholds||0===n.thresholds.length)return"";const i=e.map((e=>e.value)),o=null!==n.min_value?n.min_value:Math.min(...i),a=(null!==n.max_value?n.max_value:Math.max(...i))-o||1,l=n.thresholds.map((e=>{const n=s-(e.value-o)/a*s,r=e.color||"var(--lcars-orange)",i=e.width||1,l=e.opacity||.7,c=e.dash?"4,2":null;return`<line x1="0" y1="${n}" x2="${t}" y2="${n}"\n                    stroke="${r}" stroke-width="${i}" opacity="${l}"\n                    ${c?`stroke-dasharray="${c}"`:""}\n                    data-threshold="${e.value}"/>`}));return`<g data-feature="threshold-lines">${l.join("\n")}</g>`}_buildZeroLine(e,t,s,n,r){if(!n.zero_line)return"";const i=e.map((e=>e.value)),o=null!==n.min_value?n.min_value:Math.min(...i),a=null!==n.max_value?n.max_value:Math.max(...i);if(o>0||a<0)return"";const l=s-(0-o)/(a-o||1)*s;return`<line x1="0" y1="${l}" x2="${t}" y2="${l}"\n                  stroke="${n.zero_line_color}" stroke-width="1" opacity="0.5"\n                  stroke-dasharray="2,2"\n                  data-feature="zero-line"/>`}_buildAreaFill(e,t,s,n,r){if("none"===n.fill&&!n.fillGradient)return"";const i=this._processDataForRendering(e,n),o=this._createSparklinePath(i,{width:t,height:s},n)+` L ${t} ${s} L 0 ${s} Z`;let a=n.fill;return n.fillGradient?a=`url(#sparkline-area-gradient-${r})`:"none"===a&&(a=n.color),`<path d="${o}"\n                  fill="${a}"\n                  fill-opacity="${n.fillOpacity}"\n                  data-feature="area-fill"/>`}_buildMainSparklinePath(e,t,s,n,r,i){const o=this._processDataForRendering(e,n),a=this._createSparklinePath(o,{width:t,height:s},n),l=[];l.push(`d="${a}"`),l.push('fill="none"'),n.gradient?l.push(`stroke="url(#sparkline-gradient-${r})"`):n.pattern?l.push(`stroke="url(#sparkline-pattern-${r})"`):l.push(`stroke="${n.color}"`),l.push(`stroke-width="${n.width}"`),l.push(`stroke-opacity="${n.opacity}"`),l.push(`stroke-linecap="${n.lineCap}"`),l.push(`stroke-linejoin="${n.lineJoin}"`),l.push('vector-effect="non-scaling-stroke"'),"miter"===n.lineJoin&&4!==n.miterLimit&&l.push(`stroke-miterlimit="${n.miterLimit}"`),n.dashArray&&(l.push(`stroke-dasharray="${n.dashArray}"`),0!==n.dashOffset&&l.push(`stroke-dashoffset="${n.dashOffset}"`));const c=[];return n.glow&&c.push(`url(#sparkline-glow-${r})`),n.shadow&&c.push(`url(#sparkline-shadow-${r})`),n.blur&&c.push(`url(#sparkline-blur-${r})`),c.length>0&&l.push(`filter="${c.join(" ")}"`),l.push(...i.pathAttributes),`<path ${l.join(" ")} data-feature="main-path"/>`}_buildDataPoints(e,t,s,n,r){if(!n.show_points)return"";const i=this._processDataForRendering(e,n),o=this._calculateDataPointPositions(i,{width:t,height:s},n),a=n.point_color||n.color,l=n.point_size;return`<g data-feature="data-points">${o.map(((e,t)=>`<circle cx="${e.x.toFixed(n.path_precision)}"\n                      cy="${e.y.toFixed(n.path_precision)}"\n                      r="${l}"\n                      fill="${a}"\n                      opacity="${n.opacity}"\n                      data-value="${e.value}"\n                      data-timestamp="${e.timestamp}"/>`)).join("\n")}</g>`}_buildValueLabel(e,t,s,n,r){if(!n.show_last_value||0===e.length)return"";const i=e[e.length-1].value,o=n.value_format?this._formatValue(i,n.value_format):i.toFixed(1),a=Math.min(t/10,s/3,12);return`<text x="${t+4}" y="${s/2}"\n                  fill="${n.color}"\n                  font-size="${a}"\n                  text-anchor="start"\n                  dominant-baseline="middle"\n                  font-family="var(--lcars-font-family, monospace)"\n                  data-feature="value-label">\n              ${o}\n            </text>`}_buildBrackets(e,t,s,n){if(!s.bracket_style)return"";const r=s.bracket_color||s.color,i=s.bracket_width;let o=s.bracket_gap;"none"!==s.smoothing_mode&&(o=Math.max(o,12));const a=s.bracket_corner_radius,l=s.bracket_style_mode;let c,d;return"rounded"===l&&a>0?(c=this._buildRoundedBracketPath("left",o,t,a),d=this._buildRoundedBracketPath("right",e,o,t,a)):"lcars"===l?(c=this._buildLcarsBracketPath("left",o,t),d=this._buildLcarsBracketPath("right",e,o,t)):(c=this._buildSquareBracketPath("left",o,t),d=this._buildSquareBracketPath("right",e,o,t)),`<g data-feature="brackets">\n              <path d="${c}" stroke="${r}" stroke-width="${i}" fill="none"/>\n              <path d="${d}" stroke="${r}" stroke-width="${i}" fill="none"/>\n            </g>`}_buildSquareBracketPath(e,t,s,n){return"left"===e?`M ${-t-4} 0 L ${-t-4} ${s} M ${-t-4} 0 L ${-t/2} 0 M ${-t-4} ${s} L ${-t/2} ${s}`:`M ${t+s/2} 0 L ${t+s+4} 0 M ${t+s+4} 0 L ${t+s+4} ${n} M ${t+s/2} ${n} L ${t+s+4} ${n}`}_buildRoundedBracketPath(e,t,s,n,r){if("left"===e){const e=t,r=s,i=n,o=Math.min(i,e/4,r/6);return`M ${-e-4} ${o}\n              A ${o} ${o} 0 0 1 ${-e-4+o} 0\n              L ${-e/2} 0\n              M ${-e-4} ${r-o}\n              A ${o} ${o} 0 0 0 ${-e-4+o} ${r}\n              L ${-e/2} ${r}\n              M ${-e-4} ${o}\n              L ${-e-4} ${r-o}`}{const e=t,i=s,o=n,a=r,l=Math.min(a,i/4,o/6);return`M ${e+i/2} 0\n              L ${e+i+4-l} 0\n              A ${l} ${l} 0 0 1 ${e+i+4} ${l}\n              M ${e+i/2} ${o}\n              L ${e+i+4-l} ${o}\n              A ${l} ${l} 0 0 0 ${e+i+4} ${o-l}\n              M ${e+i+4} ${l}\n              L ${e+i+4} ${o-l}`}}_buildLcarsBracketPath(e,t,s,n){if("left"===e){const e=t,n=s,r=Math.min(4,e/4,n/10);return`M ${-e-4} ${r}\n              L ${-e-4+r} 0\n              L ${-e/2} 0\n              M ${-e-4} ${n-r}\n              L ${-e-4+r} ${n}\n              L ${-e/2} ${n}\n              M ${-e-4} ${r}\n              L ${-e-4} ${n-r}`}{const e=t,r=s,i=n,o=Math.min(4,r/4,i/10);return`M ${e+r/2} 0\n              L ${e+r+4-o} 0\n              L ${e+r+4} ${o}\n              M ${e+r/2} ${i}\n              L ${e+r+4-o} ${i}\n              L ${e+r+4} ${i-o}\n              M ${e+r+4} ${o}\n              L ${e+r+4} ${i-o}`}}_buildStatusIndicator(e,t,s,n){return s.status_indicator?`<circle cx="-8" cy="${t/2}" r="4"\n                    fill="${"string"==typeof s.status_indicator?s.status_indicator:"var(--lcars-green)"}"\n                    data-feature="status-indicator"/>`:""}_buildScanLine(e,t,s,n){return s.scan_line?`<line x1="0" y1="0" x2="0" y2="${t}"\n                  stroke="${s.color}" stroke-width="1" opacity="0.8"\n                  data-feature="scan-line"\n                  data-scan-speed="${s.tracer_speed||2}">\n              <animate attributeName="x1" values="0;${e};0" dur="3s" repeatCount="indefinite"/>\n              <animate attributeName="x2" values="0;${e};0" dur="3s" repeatCount="indefinite"/>\n            </line>`:""}_createSparklinePath(e,t,s){if(!e||e.length<2)return`M 0 ${t.height/2} L ${t.width} ${t.height/2}`;const{width:n,height:r}=t,i=this._calculateDataPointPositions(e,t,s);let o;switch(s.smoothing_mode){case"chaikin":o=this._createChaikinPath(i,s.path_precision,n);break;case"constrained":o=this._createConstrainedSmoothPath(i,s.path_precision,n);break;case"bezier":o=this._createBezierPath(i,s.path_precision,n);break;case"spline":o=this._createSplinePath(i,s.path_precision,n);break;case"stepped":o=this._createSteppedPath(i,s.path_precision);break;default:o=this._createLinearPath(i,s.path_precision)}return o}_calculateDataPointPositions(e,t,s){const{width:n,height:r}=t,i=e.map((e=>e.value));let o=null!==s.min_value?s.min_value:Math.min(...i),a=null!==s.max_value?s.max_value:Math.max(...i);o===a&&(o-=.5,a+=.5);const l=a-o;return e.map(((t,s)=>({x:s/(e.length-1)*n,y:r-(t.value-o)/l*r,value:t.value,timestamp:t.timestamp})))}_createLinearPath(e,t){const s=[];return e.forEach(((e,n)=>{const r=e.x.toFixed(t),i=e.y.toFixed(t);0===n?s.push(`M ${r} ${i}`):s.push(`L ${r} ${i}`)})),s.join(" ")}_createSteppedPath(e,t){const s=[];return e.forEach(((n,r)=>{const i=n.x.toFixed(t),o=n.y.toFixed(t);if(0===r)s.push(`M ${i} ${o}`);else{const n=e[r-1].y.toFixed(t);s.push(`L ${i} ${n}`),s.push(`L ${i} ${o}`)}})),s.join(" ")}_createChaikinPath(e,t,s){if(e.length<3)return this._createLinearPath(e,t);let n=[...e];for(let e=0;e<2;e++){const e=[];for(let t=0;t<n.length-1;t++){const s=n[t],r=n[t+1];e.push({x:.75*s.x+.25*r.x,y:.75*s.y+.25*r.y}),e.push({x:.25*s.x+.75*r.x,y:.25*s.y+.75*r.y})}n=e}if(n.length>1){const e=Math.min(...n.map((e=>e.x))),t=Math.max(...n.map((e=>e.x))),r=t-e;r>0&&(n=n.map((t=>({x:(t.x-e)/r*s,y:t.y}))))}return this._createLinearPath(n,t)}_createBezierPath(e,t,s){if(e.length<3)return this._createLinearPath(e,t);const n=[`M ${e[0].x.toFixed(t)} ${e[0].y.toFixed(t)}`];for(let s=1;s<e.length-1;s++){const r=e[s-1],i=e[s],o=e[s+1],a=r.x+.5*(i.x-r.x),l=r.y+.5*(i.y-r.y);i.x,o.x,i.x,i.y,o.y,i.y,n.push(`Q ${a.toFixed(t)} ${l.toFixed(t)} ${i.x.toFixed(t)} ${i.y.toFixed(t)}`)}const r=e[e.length-1];return n.push(`L ${r.x.toFixed(t)} ${r.y.toFixed(t)}`),n.join(" ")}_createSplinePath(e,t,s){if(e.length<4)return this._createBezierPath(e,t,s);const n=[];n.push(e[0]);for(let t=1;t<e.length-2;t++){const s=e[t-1],r=e[t],i=e[t+1],o=e[t+2],a=10;for(let e=0;e<=a;e++){const t=e/a,l=t*t,c=l*t,d=-.5*c+l-.5*t,u=1.5*c-2.5*l+1,h=-1.5*c+2*l+.5*t,p=.5*c-.5*l,g=d*s.x+u*r.x+h*i.x+p*o.x,m=d*s.y+u*r.y+h*i.y+p*o.y;n.push({x:g,y:m})}}if(n.push(e[e.length-1]),n.length>1){const e=Math.min(...n.map((e=>e.x))),t=Math.max(...n.map((e=>e.x))),r=t-e;r>0&&n.forEach((t=>{t.x=(t.x-e)/r*s}))}return this._createLinearPath(n,t)}_createConstrainedSmoothPath(e,t,s){if(e.length<3)return this._createLinearPath(e,t);const n=[];n.push(`M ${e[0].x.toFixed(t)} ${e[0].y.toFixed(t)}`);for(let s=0;s<e.length-1;s++){const r=e[s],i=e[s+1];let o,a,l,c;if(0===s){const t=e[s+2]||i;o=r.x+.3*(i.x-r.x),a=r.y+.2*(i.y-r.y),l=i.x-.2*(t.x-r.x),c=i.y-.1*(t.y-r.y)}else if(s===e.length-2){const t=e[s-1];o=r.x+.2*(i.x-t.x),a=r.y+.1*(i.y-t.y),l=i.x-.3*(i.x-r.x),c=i.y-.2*(i.y-r.y)}else{const t=e[s-1],n=e[s+2],d={x:i.x-t.x,y:i.y-t.y},u={x:n.x-r.x,y:n.y-r.y};o=r.x+.25*d.x,a=r.y+.15*d.y,l=i.x-.25*u.x,c=i.y-.15*u.y}o=Math.max(r.x,Math.min(i.x,o)),l=Math.max(r.x,Math.min(i.x,l)),n.push(`C ${o.toFixed(t)} ${a.toFixed(t)} ${l.toFixed(t)} ${c.toFixed(t)} ${i.x.toFixed(t)} ${i.y.toFixed(t)}`)}return n.join(" ")}_processDataForRendering(e,t){let s=[...e];if(t.decimation>0&&s.length>t.decimation){const n=Math.floor(s.length/t.decimation);s=s.filter(((e,t)=>t%n==0)),s[s.length-1]!==e[e.length-1]&&s.push(e[e.length-1])}if(t.max_points>0&&s.length>t.max_points){const n=Math.floor(s.length/t.max_points);s=s.filter(((e,t)=>t%n==0)),s[s.length-1]!==e[e.length-1]&&s.push(e[e.length-1])}return s}_renderEnhancedStatusIndicator(e,t,s,n,r,i,o,a){const l={NO_SOURCE:"var(--lcars-red)",MANAGER_NOT_AVAILABLE:"var(--lcars-blue)",SOURCE_NOT_FOUND:"var(--lcars-orange)",NO_BUFFER:"var(--lcars-orange)",EMPTY_BUFFER:"var(--lcars-blue)",INSUFFICIENT_DATA:"var(--lcars-blue)",ERROR:"var(--lcars-red)"}[i.status]||o.color,c={NO_SOURCE:"NO SOURCE",MANAGER_NOT_AVAILABLE:"LOADING",SOURCE_NOT_FOUND:"NOT FOUND",NO_BUFFER:"NO BUFFER",EMPTY_BUFFER:"NO DATA",INSUFFICIENT_DATA:"LOADING",ERROR:"ERROR"}[i.status]||"UNKNOWN",d=Math.min(n/8,r/3,14),u=["MANAGER_NOT_AVAILABLE","INSUFFICIENT_DATA"].includes(i.status),h=u?'\n      <animate attributeName="opacity" values="0.3;1.0;0.3" dur="1s" repeatCount="indefinite"/>\n    ':'\n      <animate attributeName="opacity" values="0.3;0.8;0.3" dur="2s" repeatCount="indefinite"/>\n    ',p=[this._buildDefinitions(o,e.id),o.bracket_style?this._buildBrackets(n,r,{...o,color:l},e.id):"",`<rect width="${n}" height="${r}"\n             fill="none" stroke="${l}" stroke-width="2"\n             stroke-dasharray="${u?"4,2":"8,4"}" opacity="0.6">\n        ${h}\n       </rect>`,`<text x="${n/2}" y="${r/2}"\n             fill="${l}" text-anchor="middle" dominant-baseline="middle"\n             font-family="var(--lcars-font-family, monospace)"\n             font-size="${d}" font-weight="bold">\n        ${c}\n       </text>`,n>120?`<text x="${n/2}" y="${r/2+d+4}"\n                           fill="${l}" text-anchor="middle" dominant-baseline="middle"\n                           font-family="var(--lcars-font-family, monospace)"\n                           font-size="${Math.max(8,.6*d)}" opacity="0.7">\n                      ${e.source||"NO SOURCE ID"}\n                     </text>`:""].filter(Boolean);return`<g data-overlay-id="${e.id}"\n                data-overlay-type="sparkline"\n                data-source="${e.source||"unknown"}"\n                data-status="${i.status}"\n                data-animation-ready="${!!a.hasAnimations}"\n                transform="translate(${t}, ${s})">\n              ${p.join("\n")}\n            </g>`}_parseGradientConfig(e){return Ul.parseGradientConfig(e)}_parsePatternConfig(e){return Ul.parsePatternConfig(e)}_parseGlowConfig(e){return Ul.parseGlowConfig(e)}_parseShadowConfig(e){return Ul.parseShadowConfig(e)}_parseBlurConfig(e){return Ul.parseBlurConfig(e)}_parseThresholds(e){return e&&Array.isArray(e)?e.map((e=>({value:Number(e.value||e),color:e.color||"var(--lcars-orange)",width:Number(e.width||1),opacity:Number(e.opacity||.7),dash:e.dash||!1,label:e.label||null}))):[]}_formatValue(e,t){return"function"==typeof t?t(e):"string"==typeof t?t.replace("{value}",e.toFixed(1)):e.toFixed(1)}_prepareAnimationAttributes(e,t){const s={pathAttributes:[],hasAnimations:!1};return!1!==t.animatable&&s.pathAttributes.push('data-animatable="true"'),t.tracer_speed>0&&(s.pathAttributes.push(`data-tracer-speed="${t.tracer_speed}"`),s.hasAnimations=!0),t.pulse_speed>0&&(s.pathAttributes.push(`data-pulse-speed="${t.pulse_speed}"`),s.hasAnimations=!0),s}_renderFallbackSparkline(e,t,s,n,r){const i=e.finalStyle||e.style||{},o=i.color||"var(--lcars-yellow)",a=i.width||2;return console.warn(`[SparklineRenderer] Using fallback rendering for sparkline ${e.id}`),`<g data-overlay-id="${e.id}" data-overlay-type="sparkline" data-fallback="true">\n              <g transform="translate(${t}, ${s})">\n                <path d="M 0 ${r/2} L ${n} ${r/2}"\n                      fill="none" stroke="${o}" stroke-width="${a}"\n                      vector-effect="non-scaling-stroke"/>\n              </g>\n            </g>`}static getHistoricalDataForSparkline(e){if(!e)return{data:null,status:"NO_SOURCE",message:"No data source specified"};try{const t=window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager;if(t){console.log(`[SparklineRenderer] 🔍 Checking DataSourceManager for '${e}'`);const s=t.getSource(e);if(s){const t=s.getCurrentData();if(console.log(`[SparklineRenderer] Source data for '${e}':`,{bufferSize:t?.bufferSize||0,historyReady:t?.historyReady,started:t?.started,historyLoaded:t?.stats?.historyLoaded||0}),t?.buffer){const s=t.buffer.getAll();if(console.log(`[SparklineRenderer] Raw buffer data for '${e}':`,s),s&&s.length>=2){const t=s.map((e=>({timestamp:e.t,value:e.v})));return console.log(`[SparklineRenderer] ✅ Found ${t.length} data points for '${e}'`),{data:t,status:"OK",message:`${t.length} data points`}}return s&&1===s.length?(console.log(`[SparklineRenderer] ⚠️ Only 1 data point available for '${e}'`),{data:null,status:"INSUFFICIENT_DATA",message:"Only 1 data point available (need 2+ for sparkline)"}):(console.log(`[SparklineRenderer] ⚠️ Buffer exists but is empty for '${e}'`),{data:null,status:"EMPTY_BUFFER",message:"Buffer exists but contains no data"})}return console.log(`[SparklineRenderer] ⚠️ Data source '${e}' found but no buffer`),{data:null,status:"NO_BUFFER",message:"Data source found but no buffer available"}}const n=Array.from(t.sources.keys());return console.warn(`[SparklineRenderer] ❌ Source '${e}' not found in DataSourceManager`),{data:null,status:"SOURCE_NOT_FOUND",message:`Source '${e}' not found. Available: ${n.join(", ")}`}}return{data:null,status:"MANAGER_NOT_AVAILABLE",message:"DataSourceManager not available"}}catch(t){return console.error(`[SparklineRenderer] Error getting data for '${e}':`,t),{data:null,status:"ERROR",message:`Error occurred: ${t.message}`}}}static updateSparklineData(e,t,s){console.log(`[SparklineRenderer] updateSparklineData called for ${t.id}:`,{hasBuffer:!!s?.buffer,bufferSize:s?.buffer?.size?.()||0,currentStatus:e.getAttribute("data-status"),elementFound:!!e,currentValue:s?.v}),e&&t&&s?(new Vl)._updateSparklineElement(e,t,s):console.warn("[SparklineRenderer] updateSparklineData: Missing required parameters")}_updateSparklineElement(e,t,s){if(null!==e.getAttribute("data-status")&&(s.buffer||s.historicalData))return void this._upgradeStatusIndicatorToSparkline(e,t,s);const n=e.querySelector('path[data-feature="main-path"]');if(n)try{const r={width:t.size?.[0]||200,height:t.size?.[1]||60},i=this._extractHistoricalData(s);if(i.length>1){const s=t.finalStyle||t.style||{},o=this._resolveSparklineStyles(s,t.id),a=this._processDataForRendering(i,o),l=this._createSparklinePath(a,r,o);n.setAttribute("d",l),e.removeAttribute("data-status"),e.setAttribute("data-last-update",Date.now()),console.log(`[SparklineRenderer] ✅ Updated sparkline ${t.id} with ${i.length} points`)}else console.warn(`[SparklineRenderer] Insufficient data for sparkline ${t.id}: ${i.length} points`),e.setAttribute("data-status",0===i.length?"NO_DATA":"INSUFFICIENT_DATA")}catch(s){console.error(`[SparklineRenderer] Error updating sparkline ${t.id}:`,s),e.setAttribute("data-status","ERROR")}else this._extractHistoricalData(s).length>1&&this._upgradeStatusIndicatorToSparkline(e,t,s)}_upgradeStatusIndicatorToSparkline(e,t,s){const n=this._extractHistoricalData(s);if(n.length>1){const s=t.size||[200,60],[r,i]=s,o=t.finalStyle||t.style||{},a=this._resolveSparklineStyles(o,t.id),l=this._prepareAnimationAttributes(t,o),c=[this._buildDefinitions(a,t.id),this._buildSparklineBackground(r,i,a,t.id),this._buildGridLines(r,i,a,t.id),this._buildThresholdLines(n,r,i,a,t.id),this._buildZeroLine(n,r,i,a,t.id),this._buildAreaFill(n,r,i,a,t.id),this._buildMainSparklinePath(n,r,i,a,t.id,l),this._buildDataPoints(n,r,i,a,t.id),this._buildValueLabel(n,r,i,a,t.id),this._buildBrackets(r,i,a,t.id),this._buildStatusIndicator(r,i,a,t.id),this._buildScanLine(r,i,a,t.id)].filter(Boolean);e.innerHTML=c.join("\n"),e.removeAttribute("data-status"),e.setAttribute("data-last-update",Date.now()),e.setAttribute("data-sparkline-features",a.features.join(",")),console.log(`[SparklineRenderer] ✅ Upgraded status indicator ${t.id} to full sparkline with ${a.features.length} features and ${n.length} data points`)}else e.setAttribute("data-status",0===n.length?"NO_DATA":"INSUFFICIENT_DATA")}_extractHistoricalData(e){let t=[];if(e.buffer&&"function"==typeof e.buffer.getAll)t=e.buffer.getAll().map((e=>({timestamp:e.t,value:e.v}))),console.log("[SparklineRenderer] Using buffer data:",t.length,"points");else if(e.historicalData&&Array.isArray(e.historicalData))t=e.historicalData,console.log("[SparklineRenderer] Using pre-formatted historical data:",t.length,"points");else if(void 0!==e.v&&void 0!==e.t){console.log("[SparklineRenderer] Generating demo data from current value:",e.v);const s=Date.now();for(let n=0;n<20;n++)t.push({timestamp:s-6e4*(19-n),value:e.v+(Math.random()-.5)*(.1*e.v)})}return t}getCapabilities(){return{pathSmoothing:["none","constrained","chaikin","bezier","spline","stepped"],dataVisualization:["points","thresholds","zero-line","value-labels"],styling:["gradients","patterns","area-fill","dash-patterns"],effects:["glow","shadow","blur"],lcarsFeatures:["brackets","status-indicator","scan-line","grid-lines"],animations:["tracer","pulse"],performance:["decimation","max-points","viewport-optimization"],advanced:!0}}static debugSparklineUpdates(){console.log("🔍 Enhanced Sparkline Update Debug Report"),console.log("==========================================");const e=window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager;if(e){const t=e.getStats();console.log("DataSourceManager stats:",t)}else console.warn("DataSourceManager not accessible via debug interface")}static debugDataSource(e){console.log(`🔍 Enhanced Debugging data source: ${e}`),console.log("====================================================");const t=window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager;if(!t)return void console.error("❌ DataSourceManager not available");const s=t.getSource(e);return s?{source:s}:(console.error(`❌ Source '${e}' not found`),void console.log("Available sources:",Array.from(t.sources.keys())))}}"undefined"!=typeof window&&(window.SparklineRenderer=Vl);class ql{constructor(e){this.routerCore=e,this.markerCache=new Map,this.gradientCache=new Map,this.patternCache=new Map,this.textAttachmentPoints=new Map}setTextAttachmentPoints(e){this.textAttachmentPoints=e||new Map}render(e,t,s){if(!this.routerCore)return console.error("[LineOverlayRenderer] RouterCore not available for line rendering"),"";let n=Hl.resolvePosition(e.anchor,t),r=Hl.resolvePosition(e.attach_to,t),i=null;if(!r&&e.attach_to&&this.textAttachmentPoints.has(e.attach_to)&&(i=this.textAttachmentPoints.get(e.attach_to),r=this._computeTextAttachPoint(n,i,e)),!n||!r)return console.warn(`[LineOverlayRenderer] Line ${e.id} missing anchor points`),"";try{const t=this.routerCore.buildRouteRequest(e,n,r),s=this.routerCore.computePath(t);if(!s?.d)return console.warn(`[LineOverlayRenderer] No path computed for line ${e.id}`),"";const i=e.finalStyle||e.style||{},o=this._resolveLineStyles(i,e.id),a=this._prepareAnimationAttributes(e,i),l=[this._buildDefinitions(o,e.id),this._buildMainPath(s.d,o,e.id,a),this._buildMarkers(s,o,e.id),this._buildEffects(s,o,e.id)].filter(Boolean);return console.log(`[LineOverlayRenderer] Rendered enhanced line ${e.id} with ${o.features.length} features`),`<g data-overlay-id="${e.id}"\n                  data-overlay-type="line"\n                  data-routing-strategy="${s.meta?.strategy||"unknown"}"\n                  data-animation-ready="${!!a.hasAnimations}">\n                ${l.join("\n")}\n              </g>`}catch(t){return console.error(`[LineOverlayRenderer] Enhanced rendering failed for line ${e.id}:`,t),this._renderFallbackLine(e,n,r)}}_resolveLineStyles(e,t){const s={color:e.color||e.stroke||"var(--lcars-orange)",width:Number(e.width||e.stroke_width||e.strokeWidth||2),opacity:Number(e.opacity||1),lineCap:(e.line_cap||e.lineCap||e.strokeLinecap||"round").toLowerCase(),lineJoin:(e.line_join||e.lineJoin||e.strokeLinejoin||"round").toLowerCase(),miterLimit:Number(e.miter_limit||e.miterLimit||4),dashArray:e.dash_array||e.dashArray||e.strokeDasharray||null,dashOffset:Number(e.dash_offset||e.dashOffset||e.strokeDashoffset||0),fill:e.fill||"none",fillOpacity:Number(e.fill_opacity||e.fillOpacity||1),gradient:this._parseGradientConfig(e.gradient),pattern:this._parsePatternConfig(e.pattern),markerStart:this._parseMarkerConfig(e.marker_start||e.markerStart),markerMid:this._parseMarkerConfig(e.marker_mid||e.markerMid),markerEnd:this._parseMarkerConfig(e.marker_end||e.markerEnd),glow:this._parseGlowConfig(e.glow),shadow:this._parseShadowConfig(e.shadow),animatable:!1!==e.animatable,pulseSpeed:Number(e.pulse_speed||0),flowSpeed:Number(e.flow_speed||0),segment_colors:this._parseSegmentColors(e.segment_colors),status_indicator:e.status_indicator||null,features:[]};return s.gradient&&s.features.push("gradient"),s.pattern&&s.features.push("pattern"),(s.markerStart||s.markerMid||s.markerEnd)&&s.features.push("markers"),s.glow&&s.features.push("glow"),s.shadow&&s.features.push("shadow"),s.segment_colors&&s.features.push("segments"),s.pulseSpeed>0&&s.features.push("pulse"),s.flowSpeed>0&&s.features.push("flow"),s}_parseGradientConfig(e){if(!e)return null;if("string"==typeof e){const t=e.match(/^(.+?)-to-(.+)$/);return t?{type:"linear",direction:"horizontal",stops:[{offset:"0%",color:t[1].trim()},{offset:"100%",color:t[2].trim()}]}:null}return"object"==typeof e?{type:e.type||"linear",direction:e.direction||"horizontal",stops:e.stops||[{offset:"0%",color:e.from||"#ff6600"},{offset:"100%",color:e.to||"#ffcc00"}]}:null}_parsePatternConfig(e){return e?"string"==typeof e?{type:e,size:8,color:"currentColor"}:"object"==typeof e?{type:e.type||"dots",size:Number(e.size||8),color:e.color||"currentColor",opacity:Number(e.opacity||.5)}:null:null}_parseMarkerConfig(e){return e?"string"==typeof e?{type:e,size:"medium",color:"inherit"}:"object"==typeof e?{type:e.type||"arrow",size:e.size||"medium",color:e.color||"inherit",rotate:!1!==e.rotate}:null:null}_parseGlowConfig(e){return e?!0===e?{color:"currentColor",size:4,opacity:.6}:"object"==typeof e?{color:e.color||"currentColor",size:Number(e.size||4),opacity:Number(e.opacity||.6)}:null:null}_parseShadowConfig(e){return e?!0===e?{color:"rgba(0,0,0,0.3)",offset:[2,2],blur:3}:"object"==typeof e?{color:e.color||"rgba(0,0,0,0.3)",offset:e.offset||[2,2],blur:Number(e.blur||3)}:null:null}_parseSegmentColors(e){return e&&Array.isArray(e)?e.map((e=>({color:e.color||"var(--lcars-orange)",start:Number(e.start||0),end:Number(e.end||1)}))):null}_buildDefinitions(e,t){const s=[];return e.gradient&&s.push(this._createGradientDefinition(e.gradient,t)),e.pattern&&s.push(this._createPatternDefinition(e.pattern,t)),["markerStart","markerMid","markerEnd"].forEach((n=>{e[n]&&s.push(this._createMarkerDefinition(e[n],t,n))})),e.glow&&s.push(this._createGlowFilter(e.glow,t)),e.shadow&&s.push(this._createShadowFilter(e.shadow,t)),s.length>0?`<defs>${s.join("\n")}</defs>`:""}_createGradientDefinition(e,t){const s=`line-gradient-${t}`;return"radial"===e.type?`<radialGradient id="${s}">${e.stops.map((e=>`<stop offset="${e.offset}" stop-color="${e.color}"/>`)).join("")}</radialGradient>`:`<linearGradient id="${s}" ${this._getLinearGradientCoords(e.direction)}>${e.stops.map((e=>`<stop offset="${e.offset}" stop-color="${e.color}"/>`)).join("")}</linearGradient>`}_getLinearGradientCoords(e){const t={horizontal:'x1="0%" y1="0%" x2="100%" y2="0%"',vertical:'x1="0%" y1="0%" x2="0%" y2="100%"',diagonal:'x1="0%" y1="0%" x2="100%" y2="100%"',"diagonal-reverse":'x1="100%" y1="0%" x2="0%" y2="100%"'};return t[e]||t.horizontal}_createPatternDefinition(e,t){const s=`line-pattern-${t}`,n=e.size;let r="";switch(e.type){case"dots":r=`<circle cx="${n/2}" cy="${n/2}" r="1" fill="${e.color}" opacity="${e.opacity}"/>`;break;case"diagonal":r=`<path d="M0,${n} L${n},0" stroke="${e.color}" stroke-width="1" opacity="${e.opacity}"/>`;break;case"grid":r=`\n          <path d="M0,0 L0,${n}" stroke="${e.color}" stroke-width="0.5" opacity="${e.opacity}"/>\n          <path d="M0,0 L${n},0" stroke="${e.color}" stroke-width="0.5" opacity="${e.opacity}"/>\n        `}return`<pattern id="${s}" x="0" y="0" width="${n}" height="${n}" patternUnits="userSpaceOnUse">\n              ${r}\n            </pattern>`}_createMarkerDefinition(e,t,s){const n=`line-marker-${t}-${s}`,r=this._getMarkerSize(e.size);let i="",o=`0 0 ${r} ${r}`,a=r/2,l=r/2;switch(e.type){case"arrow":o="0 0 10 10",a=8,l=5,i=`<path d="M2,2 L8,5 L2,8 z" fill="${"inherit"===e.color?"currentColor":e.color}"/>`;break;case"dot":i=`<circle cx="${r/2}" cy="${r/2}" r="${r/4}" fill="${"inherit"===e.color?"currentColor":e.color}"/>`;break;case"diamond":i=`<path d="M${r/2},2 L${r-2},${r/2} L${r/2},${r-2} L2,${r/2} z" fill="${"inherit"===e.color?"currentColor":e.color}"/>`;break;case"square":i=`<rect x="2" y="2" width="${r-4}" height="${r-4}" fill="${"inherit"===e.color?"currentColor":e.color}"/>`}return`<marker id="${n}"\n                    viewBox="${o}"\n                    refX="${a}" refY="${l}"\n                    markerWidth="${r}" markerHeight="${r}"\n                    markerUnits="strokeWidth"\n                    orient="${e.rotate?"auto":"0"}">\n              ${i}\n            </marker>`}_getMarkerSize(e){return{small:6,medium:8,large:12,xlarge:16}[e]||Number(e)||8}_createGlowFilter(e,t){return`<filter id="line-glow-${t}" x="-50%" y="-50%" width="200%" height="200%">\n              <feGaussianBlur stdDeviation="${e.size}" result="coloredBlur"/>\n              <feMerge>\n                <feMergeNode in="coloredBlur"/>\n                <feMergeNode in="SourceGraphic"/>\n              </feMerge>\n            </filter>`}_createShadowFilter(e,t){const s=`line-shadow-${t}`,[n,r]=e.offset;return`<filter id="${s}" x="-50%" y="-50%" width="200%" height="200%">\n              <feDropShadow dx="${n}" dy="${r}"\n                           stdDeviation="${e.blur}"\n                           flood-color="${e.color}"/>\n            </filter>`}_buildMainPath(e,t,s,n){const r=[];r.push(`d="${e}"`),r.push(`fill="${t.fill}"`),r.push(`fill-opacity="${t.fillOpacity}"`),t.gradient?r.push(`stroke="url(#line-gradient-${s})"`):t.pattern?r.push(`stroke="url(#line-pattern-${s})"`):r.push(`stroke="${t.color}"`),r.push(`stroke-width="${t.width}"`),r.push(`stroke-opacity="${t.opacity}"`),r.push(`stroke-linecap="${t.lineCap}"`),r.push(`stroke-linejoin="${t.lineJoin}"`),"miter"===t.lineJoin&&4!==t.miterLimit&&r.push(`stroke-miterlimit="${t.miterLimit}"`),t.dashArray&&(r.push(`stroke-dasharray="${t.dashArray}"`),0!==t.dashOffset&&r.push(`stroke-dashoffset="${t.dashOffset}"`)),t.markerStart&&r.push(`marker-start="url(#line-marker-${s}-markerStart)"`),t.markerMid&&r.push(`marker-mid="url(#line-marker-${s}-markerMid)"`),t.markerEnd&&r.push(`marker-end="url(#line-marker-${s}-markerEnd)"`);const i=[];return t.glow&&i.push(`url(#line-glow-${s})`),t.shadow&&i.push(`url(#line-shadow-${s})`),i.length>0&&r.push(`filter="${i.join(" ")}"`),r.push(...n.pathAttributes),`<path ${r.join(" ")}/>`}_buildMarkers(e,t,s){return""}_buildEffects(e,t,s){return t.features.includes("flow"),t.features.includes("pulse"),[].join("\n")}_prepareAnimationAttributes(e,t){const s={hasAnimations:!1,pathAttributes:[],groupAttributes:[]};return!1!==t.animatable&&s.pathAttributes.push('data-animatable="true"'),t.pulse_speed>0&&(s.pathAttributes.push(`data-pulse-speed="${t.pulse_speed}"`),s.hasAnimations=!0),t.flow_speed>0&&(s.pathAttributes.push(`data-flow-speed="${t.flow_speed}"`),s.hasAnimations=!0),e._raw?.animation_ref&&(s.groupAttributes.push(`data-animation-ref="${e._raw.animation_ref}"`),s.hasAnimations=!0),s}_renderFallbackLine(e,t,s){const[n,r]=t,[i,o]=s,a=e.finalStyle||e.style||{},l=a.color||"var(--lcars-orange)",c=a.width||2;return console.warn(`[LineOverlayRenderer] Using fallback rendering for line ${e.id}`),`<g data-overlay-id="${e.id}" data-overlay-type="line" data-fallback="true">\n              <line x1="${n}" y1="${r}" x2="${i}" y2="${o}"\n                    stroke="${l}" stroke-width="${c}"\n                    stroke-linecap="round" fill="none"/>\n            </g>`}updateLineStyle(e,t){console.log(`[LineOverlayRenderer] Style update requested for line ${e}`)}getCapabilities(){return{routing:!0,gradients:!0,patterns:!0,markers:["arrow","dot","diamond","square"],effects:["glow","shadow"],animations:["pulse","flow"],segmentColors:!0,dashPatterns:!0,advanced:!0}}_computeTextAttachPoint(e,t,s){if(!e||!t)return t?.center;const n=s._raw||s.raw||s,r=(n.attach_side||n.attachSide||"auto").toLowerCase(),i=n.attach_gap??n.attachment_gap??n.line_gap??n.gap,o=Number(i??4),{bbox:a,points:l}=t,c=l.center;let d,u=r;if("auto"===u){const t=e[0]-c[0],s=e[1]-c[1];u=Math.abs(t)>=Math.abs(s)?t<=0?"left":"right":s<=0?"top":"bottom"}let h=[0,0];switch(u){case"left":case"left-center":default:d=[a.left,c[1]],h=[-1,0];break;case"right":case"right-center":d=[a.right,c[1]],h=[1,0];break;case"top":case"top-center":d=[c[0],a.top],h=[0,-1];break;case"bottom":case"bottom-center":d=[c[0],a.bottom],h=[0,1]}const p=[d[0]+h[0]*o,d[1]+h[1]*o];return s._attachComputed={targetOverlay:t.id,sideChosen:u,gap:o,basePoint:d,attachPoint:p},p}}class Wl{constructor(e,t){this.mountEl=e,this.routerCore=t,this.overlayElements=new Map,this.lastRenderArgs=null,this.lineRenderer=new ql(t),this.overlayElementCache=new Map,this.textAttachmentPoints=new Map,this._lineDeps=new Map}render(e){if(console.log("[MSD DEBUG] 🎨 AdvancedRenderer.render() ENTRY:",{timestamp:(new Date).toISOString(),hasResolvedModel:!!e,overlayCount:e?.overlays?.length||0,anchorCount:e?.anchors?Object.keys(e.anchors).length:0,hasViewBox:!!e?.viewBox,mountElExists:!!this.mountEl,stackTrace:(new Error).stack.split("\n").slice(1,3).join("\n")}),!e)return console.error("[MSD DEBUG] ❌ AdvancedRenderer.render() - No resolved model provided"),{svgMarkup:"",overlayCount:0};const{overlays:t=[],anchors:s={},viewBox:n}=e;console.log("[MSD DEBUG] 🎨 AdvancedRenderer processing:",{overlayCount:t.length,overlayTypes:t.map((e=>e.type)),anchorCount:Object.keys(s).length,viewBox:n}),this.overlayElements.clear();const r=this.mountEl?.querySelector("svg");if(!r)return console.error("[MSD DEBUG] ❌ AdvancedRenderer.render() - SVG element not found in container:",{mountEl:this.mountEl,mountElTagName:this.mountEl?.tagName,mountElChildren:this.mountEl?.children?.length||0}),{svgMarkup:"",overlayCount:0};console.log("[MSD DEBUG] ✅ SVG element found, proceeding with overlay rendering");const i=this._ensureOverlayGroup(r);i.innerHTML="",this.overlayElementCache.clear(),this.textAttachmentPoints.clear(),t.filter((e=>"text"===e.type)).forEach((e=>{const t=Gl.computeAttachmentPoints(e,s,this.mountEl);t&&this.textAttachmentPoints.set(e.id,t)})),this.lineRenderer.setTextAttachmentPoints(this.textAttachmentPoints);const o=new Set(["text","sparkline"]);let a="",l=0;return t.filter((e=>o.has(e.type))).forEach((e=>{try{const t=this.renderOverlay(e,s,n);t&&(a+=t),l++}catch(t){console.warn("[AdvancedRenderer] Phase1 failed for",e.id,t)}})),i.innerHTML=a,this._cacheElementsFrom(i),this._dynamicAnchors={...s},this._buildDynamicOverlayAnchors(t,this._dynamicAnchors),t.filter((e=>!o.has(e.type))).forEach((e=>{try{const t=this.renderOverlay(e,this._dynamicAnchors,n);if(t){i.insertAdjacentHTML("beforeend",t),a+=t;const s=i.querySelector(`[data-overlay-id="${e.id}"]`);s&&this.overlayElementCache.set(e.id,s);const n=e._raw||e.raw||{},r=n.attach_to||n.attachTo;if(r&&(this._lineDeps.has(r)||this._lineDeps.set(r,new Set),this._lineDeps.get(r).add(e.id),this.routerCore&&n.anchor&&this._dynamicAnchors[n.anchor]&&this._dynamicAnchors[r]))try{const t=this.routerCore.buildRouteRequest(e,this._dynamicAnchors[n.anchor],this._dynamicAnchors[r]);this.routerCore.computePath(t)}catch(t){console.warn("[AdvancedRenderer] Overlay-destination route registration failed",e.id,t)}}l++}catch(t){console.warn("[AdvancedRenderer] Phase2 failed for",e.id,t)}})),console.log("[AdvancedRenderer] Injected elements (after phased render):",{total:this.overlayElementCache.size,text:i.querySelectorAll('[data-overlay-type="text"]').length,lines:i.querySelectorAll('[data-overlay-type="line"]').length,sparklines:i.querySelectorAll('[data-overlay-type="sparkline"]').length}),this._scheduleDeferredLineRefresh(t,this._dynamicAnchors,n),this._scheduleFontStabilization(t,this._dynamicAnchors,n),this.lastRenderArgs={resolvedModel:e,overlays:t,svg:r},{svgMarkup:a,overlayCount:l,errors:t.length-l}}_ensureOverlayGroup(e){let t=e.querySelector("#msd-overlay-container");return t||(t=document.createElementNS("http://www.w3.org/2000/svg","g"),t.setAttribute("id","msd-overlay-container"),e.appendChild(t)),t}_cacheElementsFrom(e){e.querySelectorAll("[data-overlay-id]").forEach((e=>{const t=e.getAttribute("data-overlay-id");t&&this.overlayElementCache.set(t,e)}))}_buildDynamicOverlayAnchors(e,t){e.filter((e=>"line"===e.type)).forEach((e=>{const s=e._raw||e.raw||{},n=s.attach_to||s.attachTo;if(!n)return;const r=this.textAttachmentPoints.get(n);if(!r||!r.points)return;const i=(s.attach_side||s.attachSide||"").toLowerCase(),o=this._resolveOverlayAttachmentPoint(r.points,i);if(!o)return;const a=this._applyAttachGap(o,i,s,r.bbox);if(t[n]=a,this.routerCore&&this.routerCore.anchors){this.routerCore.anchors[n]=a;try{this.routerCore.invalidate(e.id);const n=t[s.anchor]||this.routerCore.anchors[s.anchor];if(n){const t=this.routerCore.buildRouteRequest(e,n,a);this.routerCore.computePath(t)}}catch(t){console.warn("[AdvancedRenderer] Route registration (initial) failed",e.id,t)}}this._lineDeps.has(n)||this._lineDeps.set(n,new Set),this._lineDeps.get(n).add(e.id)}))}_updateDynamicAnchorsForOverlays(e,t,s){e.size&&e.forEach((e=>{const n=this.textAttachmentPoints.get(e);if(!n||!n.points)return;const r=this._lineDeps.get(e);r&&r.forEach((r=>{const i=t.find((e=>e.id===r));if(!i)return;const o=i._raw||i.raw||{},a=(o.attach_side||o.attachSide||"").toLowerCase(),l=this._resolveOverlayAttachmentPoint(n.points,a);if(!l)return;const c=this._applyAttachGap(l,a,o,n.bbox);if(s[e]=c,this.routerCore&&this.routerCore.anchors){this.routerCore.anchors[e]=c;try{this.routerCore.invalidate(i.id);const e=s[o.anchor]||this.routerCore.anchors[o.anchor];if(e){const t=this.routerCore.buildRouteRequest(i,e,c);this.routerCore.computePath(t)}}catch(e){console.warn("[AdvancedRenderer] Route registration (update) failed",i.id,e)}}}))}))}_applyAttachGap(e,t,s,n){const r=Number(s.attach_gap||s.attachGap||0),i=Number(s.attach_gap_x||s.attachGapX||r||0),o=Number(s.attach_gap_y||s.attachGapY||r||0);if(!i&&!o)return e;const[a,l]=e;let c=0,d=0;switch(t){case"left":c=-i;break;case"right":c=i;break;case"top":d=-o;break;case"bottom":d=o;break;case"top-left":c=-i,d=-o;break;case"top-right":c=i,d=-o;break;case"bottom-left":c=-i,d=o;break;case"bottom-right":c=i,d=o}return n&&(t.includes("left")&&a>n.left&&(c=-Math.abs(c)),t.includes("right")&&a<n.right&&(c=Math.abs(c)),t.includes("top")&&l>n.top&&(d=-Math.abs(d)),t.includes("bottom")&&l<n.bottom&&(d=Math.abs(d))),[a+c,l+d]}_resolveOverlayAttachmentPoint(e,t){if(!e)return null;switch(t){case"left":return e.left||e.leftPadded||e.center;case"right":return e.right||e.rightPadded||e.center;case"top":return e.top||e.topPadded||e.center;case"bottom":return e.bottom||e.bottomPadded||e.center;case"top-left":return e.topLeft||e.left||e.top||e.center;case"top-right":return e.topRight||e.right||e.top||e.center;case"bottom-left":return e.bottomLeft||e.left||e.bottom||e.center;case"bottom-right":return e.bottomRight||e.right||e.bottom||e.center;default:return e.center}}_scheduleFontStabilization(e,t,s){if(!e.some((e=>"text"===e.type)))return;let n=0;const r=()=>{const i=new Set;let o=!1;e.filter((e=>"text"===e.type)).forEach((e=>{const n=this.overlayElementCache.get(e.id);if(!n)return;const r=Ul.getDomTextBBox(n);if(!r)return void(o=!0);const a=parseFloat(n.getAttribute("data-text-width")||"0")||0,l=parseFloat(n.getAttribute("data-text-height")||"0")||0,c=Math.abs(r.width-a),d=Math.abs(r.height-l);if(c>.01||d>.01){const n=this._reRenderSingleTextOverlay(e,t,s);if(n){const t=Ul.getDomTextBBox(n);t&&(n.setAttribute("data-text-width",String(t.width)),n.setAttribute("data-text-height",String(t.height)),this._updateStatusIndicatorPosition(n,t)),i.add(e.id),o=!0}}else(c>0||d>0)&&(n.setAttribute("data-text-width",String(r.width)),n.setAttribute("data-text-height",String(r.height)),i.add(e.id)),"1"!==n.getAttribute("data-font-stabilized")&&n.setAttribute("data-font-stabilized","1"),this._updateTextAttachmentPointsFromDom(e,n,r),this._updateStatusIndicatorPosition(n,r)})),this.lineRenderer.setTextAttachmentPoints(this.textAttachmentPoints),i.size&&(this._updateDynamicAnchorsForOverlays(i,e,this._dynamicAnchors),this._rerenderDependentLines(i,e,this._dynamicAnchors,s)),n++;const a=n<15;(i.size||o)&&a?requestAnimationFrame(r):(i.size&&this._scheduleDeferredLineRefresh(e,this._dynamicAnchors,s),setTimeout((()=>{const t=e.filter((e=>"text"===e.type)).some((e=>{const t=this.overlayElementCache.get(e.id);return t&&"1"!==t.getAttribute("data-font-stabilized")}));t&&(console.log("[AdvancedRenderer] Running safety stabilization pass"),n=0,requestAnimationFrame(r))}),180),console.log("[AdvancedRenderer] Font stabilization complete",{passes:n,changed:Array.from(i)}))},i=document.fonts;i&&"loaded"!==i.status?i.ready.then((()=>requestAnimationFrame(r))).catch((()=>requestAnimationFrame(r))):requestAnimationFrame(r)}_scheduleDeferredLineRefresh(e,t,s){if("function"!=typeof requestAnimationFrame)return;const n=e.filter((e=>"line"===e.type&&((e._raw||e.raw||{}).attach_side||(e._raw||e.raw||{}).attach_to)));n.length&&requestAnimationFrame((()=>{n.forEach((e=>{const n=this.overlayElementCache.get(e.id);if(n)try{const r=this.lineRenderer.render(e,t,s);if(!r)return;const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.innerHTML=r.trim();const o=i.firstElementChild;if(!o)return;n.replaceWith(o),this.overlayElementCache.set(e.id,o)}catch(t){console.warn("[AdvancedRenderer] Deferred line refresh failed",e.id,t)}})),console.log("[AdvancedRenderer] Deferred line refresh pass complete")}))}renderOverlay(e,t,s){if(!e||!e.type)return console.warn("[AdvancedRenderer] Invalid overlay - missing type:",e),"";const n=this.mountEl,r=n?.querySelector("svg");switch(r||console.warn("[AdvancedRenderer] SVG element not found in container for overlay:",e.id),r&&(r.style.pointerEvents="auto",r.style.zIndex="0"),e.type){case"text":const r=Gl.computeAttachmentPoints(e,t,n);return r&&this.textAttachmentPoints.set(e.id,r),Gl.render(e,t,s,n);case"sparkline":return Vl.render(e,t,s);case"line":return this.lineRenderer.render(e,t,s);case"control":return console.log("[AdvancedRenderer] Control overlay detected, skipping SVG rendering:",e.id),"";default:return console.warn(`[AdvancedRenderer] Unknown overlay type: ${e.type}`),""}}injectSvgContent(e){const t=this.mountEl.querySelector("svg");if(!t)return void console.warn("[AdvancedRenderer] No SVG element found for overlay injection");let s=t.querySelector("#msd-overlay-container");s?s.innerHTML="":(s=document.createElementNS("http://www.w3.org/2000/svg","g"),s.setAttribute("id","msd-overlay-container"),t.appendChild(s));try{s.innerHTML=e,console.log("[AdvancedRenderer] SVG content injected successfully"),this.overlayElementCache.clear(),s.querySelectorAll("[data-overlay-id]").forEach((e=>{const t=e.getAttribute("data-overlay-id");t&&(this.overlayElementCache.set(t,e),console.log(`[AdvancedRenderer] Cached element for overlay: ${t}`))}));const t=s.querySelectorAll('[data-overlay-type="sparkline"]'),n=s.querySelectorAll('[data-overlay-type="line"]'),r=s.querySelectorAll('[data-overlay-type="text"]');console.log("[AdvancedRenderer] Injected elements:",{sparklines:t.length,lines:n.length,texts:r.length,cached:this.overlayElementCache.size})}catch(e){console.error("[AdvancedRenderer] Failed to inject SVG content:",e)}}updateOverlayData(e,t){if(console.log("[AdvancedRenderer] updateOverlayData called:",{overlayId:e,hasSourceData:!!t,sourceDataKeys:t?Object.keys(t):"none",hasBuffer:!!t?.buffer,bufferSize:t?.buffer?.size?.()||0,hasCachedElement:this.overlayElementCache.has(e)}),!t)return void console.warn("[AdvancedRenderer] updateOverlayData: Missing sourceData");const s=this.overlayElementCache.get(e);if(!s)return void console.warn(`[AdvancedRenderer] Could not find cached overlay element: ${e}. Element should be cached during render.`);const n=this.lastRenderArgs?.overlays?.find((t=>t.id===e));n?"sparkline"===n.type?Vl.updateSparklineData(s,n,t):console.warn(`[AdvancedRenderer] Update not implemented for overlay type: ${n.type}`):console.warn(`[AdvancedRenderer] Could not find overlay config: ${e}`)}handleDataSourceUpdate(e){if(!this.mountEl)return;const t=Array.from(this.overlayElementCache.values()).filter((t=>t.getAttribute("data-source")===e.sourceId));0!==t.length?t.forEach((t=>{const s=this.lastRenderArgs.overlays?.find((e=>e.id===t.getAttribute("data-overlay-id")));s&&Vl.updateSparklineData(t,s,e.data)})):console.log(`[AdvancedRenderer] No cached sparklines found for source: ${e.sourceId}`)}destroy(){this.overlayElements.clear(),this.overlayElementCache.clear(),this.lastRenderArgs=null}_updateTextAttachmentPointsFromDom(e,t,s){if(!e||!t||!s)return;const n={id:e.id,center:[s.centerX,s.centerY],bbox:{left:s.left,right:s.right,top:s.top,bottom:s.bottom,width:s.width,height:s.height},points:{center:[s.centerX,s.centerY],top:[s.centerX,s.top],bottom:[s.centerX,s.bottom],left:[s.left,s.centerY],right:[s.right,s.centerY],topLeft:[s.left,s.top],topRight:[s.right,s.top],bottomLeft:[s.left,s.bottom],bottomRight:[s.right,s.bottom]}};this.textAttachmentPoints.set(e.id,n)}_rerenderDependentLines(e,t,s,n){if(!e||!e.size)return;const r=new Set;e.forEach((e=>{const t=this._lineDeps.get(e);t&&t.forEach((e=>r.add(e)))})),r.size&&requestAnimationFrame((()=>{r.forEach((e=>{const r=t.find((t=>t.id===e));if(!r)return;const i=this.overlayElementCache.get(e);if(i)try{const t=this.lineRenderer.render(r,s,n);if(!t)return;const o=document.createElementNS("http://www.w3.org/2000/svg","g");o.innerHTML=t.trim();const a=o.firstElementChild;if(!a)return;i.replaceWith(a),this.overlayElementCache.set(e,a)}catch(t){console.warn("[AdvancedRenderer] Dep line re-render failed",e,t)}})),console.log("[AdvancedRenderer] Rerendered dependent lines after font stabilization",{count:r.size})}))}_reRenderSingleTextOverlay(e,t,s){try{const n=this.overlayElementCache.get(e.id);if(!n)return null;const r=Gl.render(e,t,s,this.mountEl);if(!r)return null;const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.innerHTML=r.trim();const o=i.firstElementChild;if(!o)return null;n.replaceWith(o),this.overlayElementCache.set(e.id,o);const a=Ul.getDomTextBBox(o);return a&&this._updateTextAttachmentPointsFromDom(e,o,a),o}catch(t){return console.warn("[AdvancedRenderer] Re-render text overlay failed",e.id,t),null}}_updateStatusIndicatorPosition(e,t){try{if(!e)return;const s=e.querySelector('circle[data-decoration="status-indicator"]');if(!s)return;const n=s.getAttribute("data-status-pos")||"left-center",r=.4*Number(e.getAttribute("data-font-size")||16),i=Ul._getSvgTransformInfo(this.mountEl),o=8,a=i?i.pixelToViewBox(o):r,l=t;let c=l.centerX,d=l.centerY;switch(n){case"top-left":c=l.left-a,d=l.top-a;break;case"top-right":c=l.right+a,d=l.top-a;break;case"bottom-left":c=l.left-a,d=l.bottom+a;break;case"bottom-right":c=l.right+a,d=l.bottom+a;break;case"top":c=l.centerX,d=l.top-a;break;case"bottom":c=l.centerX,d=l.bottom+a;break;case"left":case"left-center":default:c=l.left-a,d=l.centerY;break;case"right":case"right-center":c=l.right+a,d=l.centerY;break;case"center":c=l.centerX,d=l.centerY}s.setAttribute("cx",c),s.setAttribute("cy",d),s.setAttribute("r",r)}catch(e){}}}class Yl{constructor(){this.enabled=!1,this.debugLayer=null,this.anchorMarkers=new Map,this.boundingBoxes=new Map,this.routingOverlays=new Map,this.performanceOverlays=new Map,this.scale=1,this.debugManager=null,this.unsubscribeDebug=null,this._lastRenderContext=null}init(e){this.debugManager=e.debugManager,this.unsubscribeDebug=this.debugManager.onChange((e=>{"feature"!==e.type&&"scale"!==e.type&&"router-ready"!==e.type||this._scheduleRerender()}))}setScale(e=1){this.scale=Math.max(.3,Math.min(3,e)),console.log(`[MsdDebugRenderer] Scale factor set to: ${this.scale}`)}render(e,t,s={}){const n=this.debugManager?.getSnapshot();if(!n?.enabled)return;if(this._lastRenderContext={root:e,viewBox:t,opts:s},!this.debugManager||!this.debugManager.initialized)return;if(!e||"function"!=typeof e.querySelector)return void console.warn("[MsdDebugRenderer] Invalid root element");const r=e.querySelector("svg");r?(this.setScale(n.scale),this.integrateWithAdvancedRenderer(r,t,s.anchors),this.debugLayer&&(this.debugLayer.innerHTML=""),n.enabled?(console.log("[MsdDebugRenderer] Rendering debug features"),n.anchors&&s.anchors&&(console.log("[MsdDebugRenderer] Rendering anchors..."),this.renderAnchorMarkers(s.anchors)),n.bounding_boxes&&s.overlays&&(console.log("[MsdDebugRenderer] Rendering bounding boxes..."),this.renderOverlayBounds(s.overlays)),n.routing&&this.debugManager.canRenderRouting()&&(console.log("[MsdDebugRenderer] Rendering routing guides..."),this.renderRoutingGuides(s)),n.performance&&(console.log("[MsdDebugRenderer] Rendering performance overlays..."),this.renderPerformanceOverlays(s)),this.debugLayer&&(this.debugLayer.style.display="block")):this.debugLayer&&(this.debugLayer.style.display="none")):console.warn("[MsdDebugRenderer] No SVG element found in root")}_scheduleRerender(){this._lastRenderContext&&requestAnimationFrame((()=>{const{root:e,viewBox:t,opts:s}=this._lastRenderContext;this.render(e,t,s)}))}renderRoutingGuides(e){if(!this.debugLayer)return;this.routingOverlays.forEach((e=>e.remove())),this.routingOverlays.clear();const t=e.router||window.__msdDebug?.routing;if(!t||"function"!=typeof t.inspect)return void console.log("[MsdDebugRenderer] Routing system not available for debug rendering");const s=(e.overlays||[]).filter((e=>"line"===e.type));if(0===s.length)return void console.log("[MsdDebugRenderer] No line overlays found for routing visualization");let n=0;s.forEach((e=>{try{const s=t.inspect(e.id);if(s&&s.pts&&s.pts.length>1){const t=this.createRoutingOverlay(e.id,s);this.debugLayer.appendChild(t),this.routingOverlays.set(e.id,t),n++}else console.log(`[MsdDebugRenderer] No route info for overlay ${e.id}`)}catch(t){console.warn(`[MsdDebugRenderer] Failed to render routing guide for ${e.id}:`,t)}})),console.log(`[MsdDebugRenderer] Rendered ${n} routing guides`)}createRoutingOverlay(e,t){const s=this.debugLayer.ownerDocument,n=s.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("class","msd-debug-routing");const r=t.pts||[];if(r.forEach(((e,t)=>{if(Array.isArray(e)&&e.length>=2){const[i,o]=e,a=s.createElementNS("http://www.w3.org/2000/svg","circle");if(a.setAttribute("cx",i),a.setAttribute("cy",o),a.setAttribute("r",2*this.scale),a.setAttribute("fill","magenta"),a.setAttribute("stroke","white"),a.setAttribute("stroke-width",1*this.scale),a.setAttribute("opacity","0.8"),n.appendChild(a),0===t||t===r.length-1||r.length<=6){const e=s.createElementNS("http://www.w3.org/2000/svg","text");e.setAttribute("x",i+4*this.scale),e.setAttribute("y",o-4*this.scale),e.setAttribute("fill","magenta"),e.setAttribute("font-size",8*this.scale),e.setAttribute("font-family","monospace"),e.setAttribute("opacity","0.8"),e.textContent=t,n.appendChild(e)}}})),t.meta){const e=r[0];if(e&&Array.isArray(e)&&e.length>=2){const r=s.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",e[0]),r.setAttribute("y",e[1]-12*this.scale),r.setAttribute("fill","magenta"),r.setAttribute("font-size",9*this.scale),r.setAttribute("font-family","monospace"),r.setAttribute("opacity","0.9"),r.textContent=`${t.meta.strategy||"auto"} (${Math.round(t.meta.cost||0)})`,n.appendChild(r)}}return n}renderAnchorMarkers(e){if(!e||!this.debugLayer)return;this.anchorMarkers.forEach((e=>e.remove())),this.anchorMarkers.clear();let t=0;for(const[s,n]of Object.entries(e))if(Array.isArray(n)&&n.length>=2){const e=this.createAnchorMarker(s,n[0],n[1]);this.debugLayer.appendChild(e),this.anchorMarkers.set(s,e),t++}console.log(`[MsdDebugRenderer] Rendered ${t} anchor markers`)}createAnchorMarker(e,t,s){const n=this.debugLayer.ownerDocument.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("transform",`translate(${t}, ${s})`),n.setAttribute("class","msd-debug-anchor");const r=8*this.scale,i=2*this.scale,o=3*this.scale,a=12*this.scale,l=12*this.scale,c=`\n      <line x1="${-r}" y1="0" x2="${r}" y2="0" stroke="cyan" stroke-width="${i}" opacity="0.8"/>\n      <line x1="0" y1="${-r}" x2="0" y2="${r}" stroke="cyan" stroke-width="${i}" opacity="0.8"/>\n      <circle cx="0" cy="0" r="${o}" fill="cyan" stroke="white" stroke-width="${this.scale}" opacity="0.9"/>\n    `,d=`\n      <text x="${l}" y="4" fill="cyan" font-size="${a}" font-family="monospace" opacity="0.9">\n        ${e} (${Math.round(t)}, ${Math.round(s)})\n      </text>\n    `;return n.innerHTML=c+d,n}renderOverlayBounds(e=[]){if(!this.debugLayer)return;this.boundingBoxes.forEach((e=>{e.rect?.remove(),e.label?.remove()})),this.boundingBoxes.clear();let t=0;e.forEach((e=>{if(e.position&&Array.isArray(e.position)){const[s,n]=e.position,r=e.size?e.size[0]:100,i=e.size?e.size[1]:20,o=this.createBoundingBox(e.id,s,n,r,i);this.debugLayer.appendChild(o.rect),this.debugLayer.appendChild(o.label),this.boundingBoxes.set(e.id,o),t++}})),console.log(`[MsdDebugRenderer] Rendered ${t} bounding boxes`)}createBoundingBox(e,t,s,n,r){const i=this.debugLayer.ownerDocument,o=i.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",t),o.setAttribute("y",s),o.setAttribute("width",n),o.setAttribute("height",r),o.setAttribute("fill","none"),o.setAttribute("stroke","orange"),o.setAttribute("stroke-width",1*this.scale),o.setAttribute("stroke-dasharray",`${3*this.scale},${3*this.scale}`),o.setAttribute("opacity","0.7"),o.setAttribute("class","msd-debug-bbox");const a=i.createElementNS("http://www.w3.org/2000/svg","text");return a.setAttribute("x",t+2*this.scale),a.setAttribute("y",s+12*this.scale),a.setAttribute("fill","orange"),a.setAttribute("font-size",10*this.scale),a.setAttribute("font-family","monospace"),a.setAttribute("opacity","0.9"),a.textContent=e||"unknown",a.setAttribute("class","msd-debug-bbox-label"),{rect:o,label:a}}renderPerformanceOverlays(e){if(!this.debugLayer)return;this.performanceOverlays.forEach((e=>e.remove())),this.performanceOverlays.clear();const t=window.__msdDebug?.getPerf?.()||{},s=[];if(t.timers&&Object.entries(t.timers).forEach((([e,t])=>{if(t&&"object"==typeof t){const n=t.count>0?t.total/t.count:0;s.push(`${e}: ${n.toFixed(2)}ms avg`)}})),t.counters&&Object.entries(t.counters).forEach((([e,t])=>{s.push(`${e}: ${t}`)})),0===s.length&&Object.entries(t).slice(0,10).forEach((([e,t])=>{let n;n="object"==typeof t&&null!==t?void 0!==t.count&&void 0!==t.total?`${(t.count>0?t.total/t.count:0).toFixed(2)}ms avg`:JSON.stringify(t):String(t),s.push(`${e}: ${n}`)})),0===s.length)return void console.log("[MsdDebugRenderer] No performance data available");const n=this.debugLayer.ownerDocument,r=n.createElementNS("http://www.w3.org/2000/svg","g");r.setAttribute("class","msd-debug-performance");const i=10*this.scale,o=10*this.scale,a=200*this.scale,l=5*this.scale,c=n.createElementNS("http://www.w3.org/2000/svg","rect");c.setAttribute("x",i),c.setAttribute("y",o),c.setAttribute("width",a),c.setAttribute("height",(20+15*s.slice(0,8).length)*this.scale),c.setAttribute("fill","rgba(0,0,0,0.8)"),c.setAttribute("stroke","yellow"),c.setAttribute("stroke-width",1*this.scale),c.setAttribute("rx",4*this.scale),r.appendChild(c);const d=n.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",i+l),d.setAttribute("y",o+15*this.scale),d.setAttribute("fill","yellow"),d.setAttribute("font-size",12*this.scale),d.setAttribute("font-family","monospace"),d.setAttribute("font-weight","bold"),d.textContent="Performance",r.appendChild(d),s.slice(0,8).forEach(((e,t)=>{const s=n.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("x",i+l),s.setAttribute("y",o+(30+15*t)*this.scale),s.setAttribute("fill","yellow"),s.setAttribute("font-size",10*this.scale),s.setAttribute("font-family","monospace"),s.textContent=e,r.appendChild(s)})),this.debugLayer.appendChild(r),this.performanceOverlays.set("perf-info",r),console.log(`[MsdDebugRenderer] Rendered performance overlay with ${s.length} metrics at scale ${this.scale}`)}integrateWithAdvancedRenderer(e,t,s={}){e&&(this.ensureDebugLayer(e),this.viewBox=t,this.anchors=s)}ensureDebugLayer(e){if(!e)return void console.warn("[MsdDebugRenderer] ensureDebugLayer: no SVG element provided");let t=e.querySelector("#msd-debug-layer");t?console.log("[MsdDebugRenderer] Using existing debug layer"):(console.log("[MsdDebugRenderer] Creating new debug layer"),t=e.ownerDocument.createElementNS("http://www.w3.org/2000/svg","g"),t.id="msd-debug-layer",t.style.pointerEvents="none",t.style.zIndex="1000",e.appendChild(t)),this.debugLayer=t}toggle(e=!this.enabled){return this.enabled=e,this.debugLayer&&(this.debugLayer.style.display=e?"block":"none"),console.log("[MsdDebugRenderer] Debug visualization "+(e?"enabled":"disabled")),e}toggleFeature(e,t){this.features.hasOwnProperty(e)&&(this.features[e]=t,console.log(`[MsdDebugRenderer] Feature '${e}' ${t?"enabled":"disabled"}`),setTimeout((()=>{if(this._lastRenderContext){const{root:e,viewBox:t,opts:s}=this._lastRenderContext;this.render(e,t,s)}}),10))}getDebugState(){return{enabled:this.enabled,features:{...this.features},hasDebugLayer:Boolean(this.debugLayer),markerCount:this.anchorMarkers.size,boundingBoxCount:this.boundingBoxes.size,routingOverlayCount:this.routingOverlays.size,performanceOverlayCount:this.performanceOverlays.size}}destroy(){this.unsubscribeDebug&&(this.unsubscribeDebug(),this.unsubscribeDebug=null),this.debugLayer=null,this._lastRenderContext=null}}"undefined"!=typeof window&&(window.cblcars=window.cblcars||{},window.cblcars.MsdDebugRenderer=Yl);class Xl{constructor(e){this.renderer=e,this.controlElements=new Map,this.hass=null,this.lastRenderArgs=null,this._isRendering=!1,this._lastSignature=null,"undefined"!=typeof window&&(window._msdControlsRenderer=this),console.log("[MsdControlsRenderer] Constructor called")}setHass(e){console.log("[MsdControlsRenderer] setHass called with:",{hasHass:!!e,entityCount:e?.states?Object.keys(e.states).length:0,hasLightDesk:!!e?.states?.["light.desk"],lightDeskState:e?.states?.["light.desk"]?.state,previousHass:!!this.hass,controlElementsCount:this.controlElements.size}),this.hass=e,this.controlElements.size>0?(console.log("[MsdControlsRenderer] Updating HASS context for",this.controlElements.size,"control cards"),this._updateAllControlsHass(e)):console.log("[MsdControlsRenderer] No control elements to update")}_updateAllControlsHass(e){console.log(`[MsdControlsRenderer] Updating HASS for ${this.controlElements.size} control cards`);for(const[t,s]of this.controlElements)try{const n=s.querySelector('[class*="card"], [data-card-type], cb-lcars-button-card, hui-light-card')||s.firstElementChild;n&&this._applyHassToCard(n,e,t)}catch(e){console.warn("[MsdControlsRenderer] Failed to update HASS for control:",t,e)}}_applyHassToCard(e,t,s){console.log(`[MsdControlsRenderer] Updating HASS for ${s}:`,{tagName:e.tagName,isCustomButtonCard:e.tagName.toLowerCase().includes("button-card"),hasConfig:!!e._config,hasSetConfig:"function"==typeof e.setConfig,currentHass:!!e.hass,hasSetHass:"function"==typeof e.setHass,entity:e._config?.entity||"none"});try{const n=e.tagName?e.tagName.toLowerCase():"",r=n.includes("cb-lcars"),i=n.includes("hui-")||n.includes("button-card")&&!n.includes("cb-lcars");if(r){console.log(`[MsdControlsRenderer] Using property assignment for CB-LCARS card: ${s}`);const n=e.hass;if(e._config?.entity&&t.states?.[e._config.entity]){const n=t.states[e._config.entity];console.log(`[MsdControlsRenderer] Updating _stateObj for ${s} entity: ${e._config.entity}`,{oldState:e._stateObj?.state,newState:n?.state,stateChanged:e._stateObj?.state!==n?.state}),e._stateObj=n}e.hass=t,e._hass=t,"function"==typeof e.requestUpdate&&(console.log(`[MsdControlsRenderer] Triggering LitElement property update for ${s}`),e.requestUpdate("hass",n),e.requestUpdate("_hass",n),e._config?.entity&&e.requestUpdate("_stateObj"))}else if(i)if(console.log(`[MsdControlsRenderer] Using setHass() method for standard HA card: ${s}`),e.setHass&&"function"==typeof e.setHass)e.setHass(t);else{console.warn(`[MsdControlsRenderer] Standard HA card ${s} has no setHass method`);const n=e.hass;e.hass=t,e._hass=t,"function"==typeof e.requestUpdate&&e.requestUpdate("hass",n)}else if(console.log(`[MsdControlsRenderer] Using fallback approach for unknown card type: ${s}`),e.setHass&&"function"==typeof e.setHass)e.setHass(t);else{const s=e.hass;e.hass=t,e._hass=t,"function"==typeof e.requestUpdate&&e.requestUpdate("hass",s)}return!0}catch(e){return console.error(`[MsdControlsRenderer] ❌ Failed to update HASS for ${s}:`,e),!1}}async renderControls(e,t){if(this._isRendering)return void console.log("[MsdControlsRenderer] renderControls skipped (in progress)");if(!e?.length)return void console.log("[MsdControlsRenderer] No control overlays to render");if(!t)return void console.error("[MsdControlsRenderer] No resolved model provided");if("undefined"==typeof document)return void console.error("[MsdControlsRenderer] Document not available");const s=e.map((e=>e.id)).sort().join("|");if(this._lastSignature!==s||this.controlElements.size!==e.length){this._isRendering=!0;try{console.log("[MsdControlsRenderer] renderControls called",{count:e.length,ids:e.map((e=>e.id)),signature:s,hasHass:!!this.hass});const n=this.getSvgControlsContainer();if(!n)return void console.error("[MsdControlsRenderer] No SVG container available; abort render");console.log("[MsdControlsRenderer] SVG container found, clearing existing controls"),n.innerHTML="",this.controlElements.clear();for(const s of e)try{await this.renderControlOverlay(s,t)}catch(e){console.error(`[MsdControlsRenderer] Failed to render control overlay ${s.id}:`,e)}this.lastRenderArgs={controlOverlays:e,resolvedModel:t},this._lastSignature=s,console.log("[MsdControlsRenderer] renderControls completed successfully")}catch(e){throw console.error("[MsdControlsRenderer] renderControls failed:",e),e}finally{this._isRendering=!1}}else console.log("[MsdControlsRenderer] renderControls skipped (unchanged signature)",s)}async renderControlOverlay(e,t){const s=document.querySelector(`#msd-control-foreign-${e.id}`);if(s){console.log("[MsdControlsRenderer] Existing foreignObject found for",e.id,"- removing to avoid duplicates");try{s.remove()}catch(e){}}this.controlElements.has(e.id)&&this.controlElements.delete(e.id),console.log("[MsdControlsRenderer] Creating control overlay",e.id);const n=await this.createControlElement(e);n&&(this.positionControlElement(n,e,t),this.controlElements.set(e.id,n))}resolveCardDefinition(e){if(e.card)return e.card;if(e.card_config)return e.card_config;if(e.cardConfig)return e.cardConfig;if(e._card)return e._card;if(e.meta?.card)return e.meta.card;if(e.extension?.card)return e.extension.card;if(!this._rawOverlayIndex){const e=window&&window._msdRawOverlays?window._msdRawOverlays:[];this._rawOverlayIndex=new Map(e.map((e=>[e.id,e])))}const t=this._rawOverlayIndex?.get(e.id);return t?.card?t.card:null}_normalizeCardType(e){return e?e.startsWith("custom:")?e.slice(7):{button:"hui-button-card",light:"hui-light-card",switch:"hui-switch-card",sensor:"hui-sensor-card","binary-sensor":"hui-binary-sensor-card",cover:"hui-cover-card",fan:"hui-fan-card",climate:"hui-climate-card",thermostat:"hui-thermostat-card","media-player":"hui-media-control-card","alarm-panel":"hui-alarm-panel-card","input-number":"hui-input-number-card","input-select":"hui-input-select-card","input-text":"hui-input-text-card",lock:"hui-lock-card",vacuum:"hui-vacuum-card","water-heater":"hui-water-heater-card",weather:"hui-weather-forecast-card"}[e]||e:null}async createControlElement(e){const t=this.resolveCardDefinition(e);if(!t)return console.warn("[MsdControlsRenderer] No card definition found for control overlay",e.id),null;try{const s=t.type;let n=null;const r=this._normalizeCardType(s);console.log("[MsdControls] Creating card element:",{originalType:s,normalizedType:r,overlayId:e.id}),n=r.startsWith("hui-")?await this._createHomeAssistantCard(r,t,e):await this._createCustomCard(r,t,e),n||(console.warn(`Could not create card element for type: ${s}, creating fallback`),n=this._createFallbackCard(s,t)),console.log("[MsdControls] Applying HASS and config:",{overlayId:e.id,hasHass:!!this.hass,hasSetConfig:"function"==typeof n.setConfig}),this.hass&&await this._applyHassContext(n,e.id),await this._configureCard(n,t,e);const i=document.createElement("div");return i.className="msd-control-wrapper",i.dataset.msdControlId=e.id,i.style.position="absolute",i.style.pointerEvents="auto",i.style.touchAction="manipulation",i.appendChild(n),this._setupEventIsolation(i,n,e),i}catch(e){return console.error(`[MSD Controls] Failed to create card ${t?.type}:`,e),this._createFallbackCard(t?.type||"unknown",t)}}async _createHomeAssistantCard(e,t,s){console.log("[MsdControls] Creating HA built-in card:",e);try{if(!window.customCards&&!document.querySelector("home-assistant"))return console.warn("[MsdControls] Home Assistant not fully loaded yet"),null;let t=null;return window.customElements&&window.customElements.get(e)?t=new(window.customElements.get(e)):(t=document.createElement(e),await this._waitForElementUpgrade(t,3e3)),t&&"function"!=typeof t.setConfig&&(console.log("[MsdControls] HA card created but setConfig not available, trying alternative approach"),await new Promise((e=>setTimeout(e,500))),"function"!=typeof t.setConfig)?(console.warn("[MsdControls] HA card does not have setConfig method:",e),null):t}catch(e){return console.warn("[MsdControls] HA card creation failed:",e),null}}async _createCustomCard(e,t,s){console.log("[MsdControls] Starting custom card creation strategies for:",e);let n=null;if(console.log("[MsdControls] Strategy 1: Attempting direct custom element creation for:",e),window.customElements&&"function"==typeof window.customElements.get)try{const t=window.customElements.get(e);t?(n=new t,console.log("[MsdControls] ✅ Strategy 1 SUCCESS: Created via constructor:",e)):console.log("[MsdControls] ❌ Strategy 1 FAILED: No custom element found for:",e)}catch(t){console.log("[MsdControls] ❌ Strategy 1 FAILED: Constructor error for",e,":",t.message)}else console.log("[MsdControls] ❌ Strategy 1 SKIPPED: customElements not available");if(!n){console.log("[MsdControls] Strategy 2: Attempting createElement with upgrade for:",e);try{n=document.createElement(e),n.tagName.toLowerCase()===e.toLowerCase()?(console.log("[MsdControls] Strategy 2: Created element, waiting for upgrade:",e),await this._waitForElementUpgrade(n),"function"==typeof n.setConfig?console.log("[MsdControls] ✅ Strategy 2 SUCCESS: Created via createElement with upgrade:",e):(console.log("[MsdControls] ❌ Strategy 2 FAILED: Element created but no setConfig after upgrade:",e),n=null)):(console.log("[MsdControls] ❌ Strategy 2 FAILED: Generic element created, not custom card:",e),n=null)}catch(t){console.log("[MsdControls] ❌ Strategy 2 FAILED: createElement error for",e,":",t.message)}}if(!n){console.log("[MsdControls] Strategy 3: Attempting body attachment technique for:",e);try{n=document.createElement(e);const t=document.createElement("div");t.style.position="absolute",t.style.left="-10000px",document.body.appendChild(t),t.appendChild(n),console.log("[MsdControls] Strategy 3: Element attached to body, waiting for upgrade:",e),await this._waitForElementUpgrade(n,5e3),n.remove(),t.remove(),"function"==typeof n.setConfig?console.log("[MsdControls] ✅ Strategy 3 SUCCESS: Created via body attachment:",e):(console.log("[MsdControls] ❌ Strategy 3 FAILED: Body attachment did not result in working card:",e),n=null)}catch(t){console.log("[MsdControls] ❌ Strategy 3 FAILED: Body attachment error for",e,":",t.message)}}return n?console.log("[MsdControls] 🎉 Custom card creation SUCCESSFUL for:",e):console.log("[MsdControls] 💥 ALL STRATEGIES FAILED for:",e),n}async _waitForElementUpgrade(e,t=5e3){const s=Date.now();for(console.log("[MsdControls] Waiting for element upgrade:",{tagName:e.tagName,hasSetConfig:"function"==typeof e.setConfig});Date.now()-s<t;){if("function"==typeof e.setConfig)return console.log("[MsdControls] Element upgraded successfully:",e.tagName),e;if(e.updateComplete)try{if(await e.updateComplete,"function"==typeof e.setConfig)return console.log("[MsdControls] Element upgraded via updateComplete:",e.tagName),e}catch(e){}if(window.customElements&&window.customElements.upgrade)try{window.customElements.upgrade(e)}catch(e){}await new Promise((e=>setTimeout(e,100)))}return console.warn("[MsdControls] Element upgrade timeout:",{tagName:e.tagName,hasSetConfig:"function"==typeof e.setConfig,waitTime:Date.now()-s}),e}async _configureCard(e,t,s){const n=this._buildCardConfig(t);if(console.log("[MsdControls] Configuring card:",{overlayId:s.id,cardType:t.type,hasSetConfig:"function"==typeof e.setConfig,hasHass:!!this.hass,config:n}),n&&(await this._applyCardConfig(e,n,s.id)||setTimeout((async()=>{console.log("[MsdControls] Retrying config application after delay:",s.id),await this._applyCardConfig(e,n,s.id)}),1e3)),"function"==typeof e.requestUpdate)try{await e.requestUpdate(),console.log("[MsdControls] Requested update for:",s.id)}catch(e){console.debug("[MsdControls] requestUpdate failed:",e)}if(e.tagName){const t=e.tagName.toLowerCase();t.includes("cb-lcars")||t.includes("button-card")||e._isCustomButtonCard||e.constructor?.name?.includes("Button")?(console.log("[MsdControls] Setting up custom-button-card updates for:",s.id),setTimeout((()=>{try{if(this.hass&&(e.hass=this.hass,e._hass=this.hass),e._config&&"function"==typeof e.setConfig){const t={...e._config};e.setConfig(t),this.hass&&(e.hass=this.hass)}"function"==typeof e.requestUpdate&&e.requestUpdate(),console.debug("[MsdControls] ✅ Custom-button-card initial update completed for:",s.id)}catch(e){console.debug("[MsdControls] Custom-button-card specific update failed:",e)}}),100)):t.startsWith("hui-")&&setTimeout((()=>{try{"function"==typeof e.requestUpdate&&e.requestUpdate(),this.hass&&(e.hass=this.hass)}catch(e){console.debug("[MsdControls] HA card specific update failed:",e)}}),200)}}_buildCardConfig(e){if(!e)return null;let t;if(e.config&&"object"==typeof e.config)t={type:e.type,...e.config};else{const{type:s,config:n,card:r,card_config:i,cardConfig:o,...a}=e;t={type:s,...a}}const s=t.type,n="custom:cb-lcars-button-card"===s||"cb-lcars-button-card"===s||"custom:button-card"===s||"button-card"===s,r="button"===s||"light"===s||"switch"===s||s.startsWith("hui-");return n&&!r&&t.entity?(console.log(`[MsdControlsRenderer] Adding triggers_update for CB-LCARS card with entity: ${t.entity}`),n&&!r&&(console.log(`[MsdControlsRenderer] Setting triggers_update to 'all' for CB-LCARS card: ${t.entity}`),t.triggers_update="all",console.log("[MsdControlsRenderer] CB-LCARS card configured with triggers_update: 'all'")),console.log("[MsdControlsRenderer] CB-LCARS card configured with triggers_update:",t.triggers_update)):r&&console.log(`[MsdControlsRenderer] Skipping triggers_update for built-in HA card: ${s}`),t._msdGenerated=!0,t}async _applyHassContext(e,t){if(!this.hass)return console.warn("[MsdControls] No HASS context available for:",t),!1;console.log("[MsdControls] Starting HASS application strategies for:",t);const s=[()=>{console.log("[MsdControls] HASS Strategy 1: Attempting direct property assignment for:",t);try{e.hass=this.hass;const s=e.hass===this.hass;return s?console.log("[MsdControls] ✅ HASS Strategy 1 SUCCESS: Direct property assignment for:",t):console.log("[MsdControls] ❌ HASS Strategy 1 FAILED: Property assignment did not stick for:",t),s}catch(e){return console.log("[MsdControls] ❌ HASS Strategy 1 FAILED: Property assignment error for",t,":",e.message),!1}},()=>{console.log("[MsdControls] HASS Strategy 2: Attempting property descriptor for:",t);try{return Object.defineProperty(e,"hass",{value:this.hass,writable:!0,configurable:!0}),console.log("[MsdControls] ✅ HASS Strategy 2 SUCCESS: Property descriptor applied for:",t),!0}catch(e){return console.log("[MsdControls] ❌ HASS Strategy 2 FAILED: Property descriptor error for",t,":",e.message),!1}},()=>{console.log("[MsdControls] HASS Strategy 3: Attempting private property fallback for:",t);try{return e._hass=this.hass,"hass"in e&&(e.hass=this.hass,console.log("[MsdControls] HASS Strategy 3: Also set public hass property for:",t)),console.log("[MsdControls] ✅ HASS Strategy 3 SUCCESS: Private property fallback for:",t),!0}catch(e){return console.log("[MsdControls] ❌ HASS Strategy 3 FAILED: Private property error for",t,":",e.message),!1}}];for(const[e,n]of s.entries())if(n())return console.log(`[MsdControls] 🎉 HASS application SUCCESSFUL via strategy ${e+1} for:`,t),!0;return console.log("[MsdControls] 💥 ALL HASS STRATEGIES FAILED for:",t),!1}async _applyCardConfig(e,t,s){if(!t)return!1;console.log("[MsdControls] Applying config:",{overlayId:s,hasSetConfig:"function"==typeof e.setConfig,cardType:t.type,entity:t.entity,triggersUpdate:t.triggers_update,config:t});for(let n=0;n<8;n++)try{if("function"==typeof e.setConfig)return e.setConfig(t),e._config=t,e._config&&e._config.triggers_update?console.log(`[MsdControls] ✅ Config applied with triggers_update:${e._config.triggers_update} for:`,s):console.warn("[MsdControls] ⚠️ Config applied but no triggers_update found for:",s),console.log(`[MsdControls] ✅ Config applied on attempt ${n+1} for:`,s),!0;if(n<7){const e=200*(n+1);console.log(`[MsdControls] Retrying config in ${e}ms for:`,s),await new Promise((t=>setTimeout(t,e)))}}catch(e){console.warn(`[MsdControls] setConfig attempt ${n+1} failed for ${s}:`,e),n<7&&await new Promise((e=>setTimeout(e,200*(n+1))))}e._pendingConfig=t,console.warn("[MsdControls] ❌ Config stored for deferred application:",s);const n=setInterval((()=>{if("function"==typeof e.setConfig)try{e.setConfig(t),e._config=t,console.log("[MsdControls] ✅ Deferred config finally applied:",s),clearInterval(n)}catch(e){console.warn("[MsdControls] Deferred config retry failed:",s,e)}}),1e3);return setTimeout((()=>clearInterval(n)),1e4),!1}_createFallbackCard(e,t){const s=document.createElement("div");s.className="msd-control-fallback",Object.assign(s.style,{border:"2px dashed var(--primary-color, #ffa500)",borderRadius:"8px",padding:"16px",background:"var(--card-background-color, rgba(0,0,0,0.8))",color:"var(--primary-text-color, #ffffff)",fontSize:"14px",textAlign:"center",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",minHeight:"80px"});const n=document.createElement("div");n.textContent=`Card: ${e}`,n.style.fontWeight="bold",n.style.marginBottom="8px";const r=document.createElement("div");return r.textContent="(Card failed to load)",r.style.fontSize="12px",r.style.opacity="0.7",s.appendChild(n),s.appendChild(r),s.addEventListener("click",(()=>{console.log("[MsdControls] Fallback card clicked:",{cardType:e,cardDef:t})})),s}_setupEventIsolation(e,t,s){["click","dblclick","contextmenu","pointerdown","pointerup","pointermove","pointercancel","touchstart","touchend","touchmove","touchcancel","mousedown","mouseup","mousemove","mouseenter","mouseleave","focus","blur","focusin","focusout","keydown","keyup","keypress"].forEach((s=>{e.addEventListener(s,(e=>{(e.target===t||t.contains(e.target))&&e.stopPropagation()}),{capture:!1,passive:!1})})),e.style.pointerEvents="auto",e.style.position="absolute",e.style.zIndex="1000",e.setAttribute("tabindex","0"),t&&(t.style.pointerEvents="auto",t.style.position="relative",t.style.zIndex="1",t.style.touchAction="manipulation")}positionControlElement(e,t,s){const n=this.resolvePosition(t.position,s),r=this.resolveSize(t.size,s);if(!n||!r)return void console.warn("[MSD Controls] Invalid position or size for control:",t.id);const i=this.createSvgForeignObject(t.id,n,r);if(!i)return void console.error("[MSD Controls] Failed to create SVG foreignObject for:",t.id);this.configureControlForSvg(e,t,r),i.appendChild(e);const o=this.getSvgControlsContainer();o&&i.parentNode!==o&&(o.appendChild(i),console.debug("[MSD Controls] Control positioned in SVG coordinates:",t.id,{position:n,size:r}))}createSvgForeignObject(e,t,s){const n=this.renderer.container||this.renderer.mountEl,r=n?.querySelector("svg");if(!r)return console.warn("[MSD Controls] No SVG element found for foreignObject creation"),null;try{const n=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");return n.setAttribute("x",t[0]),n.setAttribute("y",t[1]),n.setAttribute("width",s[0]),n.setAttribute("height",s[1]),n.setAttribute("data-msd-control-id",e),n.setAttribute("id",`msd-control-foreign-${e}`),n.style.pointerEvents="auto",n.style.overflow="visible",n}catch(e){return console.error("[MSD Controls] Failed to create foreignObject:",e),null}}configureControlForSvg(e,t,s){e.style.position="relative",e.style.left="auto",e.style.top="auto",e.style.width="100%",e.style.height="100%",e.style.boxSizing="border-box",e.style.pointerEvents="auto",e.style.zIndex=t.z_index||"auto",e.style.background||e.shadowRoot||(e.style.background="none"),console.debug("[MSD Controls] Configured element for SVG embedding:",t.id)}getSvgControlsContainer(){const e=this.renderer.container||this.renderer.mountEl,t=e?.querySelector("svg");if(!t)return console.warn("[MSD Controls] No SVG element found for controls container"),null;let s=t.querySelector("#msd-controls-container");if(!s){s=document.createElementNS("http://www.w3.org/2000/svg","g"),s.setAttribute("id","msd-controls-container"),s.style.pointerEvents="none";const e=t.querySelector("#msd-overlay-container"),n=t.querySelector("#msd-debug-layer");n?t.insertBefore(s,n):e?t.insertBefore(s,e.nextSibling):t.appendChild(s),console.log("[MSD Controls] Created SVG controls container group")}return s}resolvePosition(e,t){return Hl.resolvePosition(e,t.anchors||{})||(console.warn("[MSD Controls] Position resolution failed, using default [0, 0]"),[0,0])}resolveSize(e,t){return!e||!Array.isArray(e)||e.length<2?[100,100]:[e[0],e[1]]}cleanup(){console.log("[MsdControlsRenderer] Cleaning up controls renderer");for(const[e,t]of this.controlElements)try{const s=t.closest("foreignObject")||document.querySelector(`#msd-control-foreign-${e}`);s&&s.remove?s.remove():t&&t.remove&&t.remove()}catch(t){console.warn(`Failed to remove control element ${e}:`,t)}this.controlElements.clear();const e=this.renderer?.container||this.renderer?.mountEl,t=e?.querySelector("svg"),s=t?.querySelector("#msd-controls-container");if(s)try{s.remove()}catch(e){console.warn("Failed to remove SVG controls container:",e)}const n=e?.querySelector("#msd-controls-container");if(n&&"DIV"===n.tagName)try{n.remove(),console.log("[MsdControlsRenderer] Removed legacy DOM controls container")}catch(e){console.warn("Failed to remove legacy controls container:",e)}this.hass=null}}class Jl{constructor(){this.thresholds=new Map,this.previousSnapshot={}}setThreshold(e,t){const s=parseFloat(t);isNaN(s)?this.thresholds.delete(e):this.thresholds.set(e,{avgMs:s})}resetTimer(e){try{window.__msdDebug?.getPerf?.()?.resetTimer?.(e)}catch{}}clearAllTimers(){try{window.__msdDebug?.getPerf?.()?.clear?.()}catch{}this.thresholds.clear()}exportData(){const e=window.__msdDebug?.getPerf?.()||{},t={timestamp:Date.now(),timers:e.timers||{},counters:e.counters||{},thresholds:Object.fromEntries(this.thresholds)};console.table(t.timers),console.log("[PerformancePanel] Performance data:",t);const s=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),n=URL.createObjectURL(s),r=document.createElement("a");r.href=n,r.download=`msd-performance-${Date.now()}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}captureData(){const e={},t={},s=[],n=[];try{window.__msdDebug?.getDebugStatusSilent?.();const r=window.__msdDebug?.getPerf?.()||{};r.timers&&Object.entries(r.timers).forEach((([t,r])=>{const i={count:r.count||0,total:r.total||0,avg:r.count>0?r.total/r.count:0,last:r.last||0,max:r.max||0,min:r.min||0};e[t]=i;const o=this.thresholds.get(t);o&&i.avg>o.avgMs&&s.push({type:"threshold",timer:t,current:i.avg,threshold:o.avgMs,severity:i.avg>2*o.avgMs?"high":"medium"});const a=this.previousSnapshot[t];if(a&&a.avg>0){const e=(i.avg-a.avg)/a.avg*100;e>20&&n.push({timer:t,previousAvg:a.avg,currentAvg:i.avg,regression:e})}})),r.counters&&Object.entries(r.counters).forEach((([e,s])=>{t[e]=Number(s)||0})),this.previousSnapshot={...e}}catch(e){console.warn("[PerformancePanel] Data capture failed:",e)}return{timers:e,counters:t,alerts:s,regressions:n}}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Performance Monitor</h3>';const{timers:s,counters:n,alerts:r,regressions:i}=e;t+='<div class="msd-hud-section"><h4>Controls</h4>',t+='<div style="display:flex;flex-wrap:wrap;gap:4px;">',t+='<button data-bus-event="performance:clear-all" onclick="__msdHudBus(\'performance:clear-all\')"\n      style="font-size:10px;padding:2px 6px;background:#666;color:#fff;border:1px solid #888;border-radius:3px;cursor:pointer;">\n      Clear All\n    </button>',t+='<button data-bus-event="performance:export" onclick="__msdHudBus(\'performance:export\')"\n      style="font-size:10px;padding:2px 6px;background:#333;color:#fff;border:1px solid #555;border-radius:3px;cursor:pointer;">\n      Export\n    </button>',t+="</div></div>",r&&r.length>0&&(t+='<div class="msd-hud-section msd-hud-warning"><h4>Threshold Alerts</h4>',r.forEach((e=>{const s="high"===e.severity?"#ff4444":"#ffaa00";t+=`<div class="msd-hud-metric msd-hud-warning">\n          <span class="msd-hud-metric-name" style="color:${s};">${e.timer}</span>\n          <span class="msd-hud-metric-value">${e.current.toFixed(2)}ms > ${e.threshold}ms</span>\n        </div>`})),t+="</div>"),i&&i.length>0&&(t+='<div class="msd-hud-section msd-hud-error"><h4>Performance Regressions</h4>',i.forEach((e=>{t+=`<div class="msd-hud-metric msd-hud-error">\n          <span class="msd-hud-metric-name">${e.timer}</span>\n          <span class="msd-hud-metric-value">+${e.regression.toFixed(1)}%</span>\n        </div>`,t+=`<div class="msd-hud-metric-detail">\n          ${e.previousAvg.toFixed(2)}ms → ${e.currentAvg.toFixed(2)}ms\n        </div>`})),t+="</div>");const o=Object.entries(s||{}).slice(0,10);o.length>0&&(t+='<div class="msd-hud-section"><h4>Timers</h4>',o.sort((([,e],[,t])=>t.avg-e.avg)),o.forEach((([e,s])=>{const n=this.thresholds.has(e),r=this.thresholds.get(e),i=n&&s.avg>r.avgMs?"#ff6666":s.avg>10?"#ffaa00":"#66ff99";t+=`<div class="msd-hud-metric" style="margin:4px 0;padding:4px;border:1px solid #333;border-radius:3px;">\n          <div style="display:flex;justify-content:space-between;">\n            <span class="msd-hud-metric-name">${e}</span>\n            <span class="msd-hud-metric-value" style="color:${i};">${s.avg.toFixed(2)}ms</span>\n          </div>\n          <div style="font-size:10px;color:#888;margin-top:2px;">\n            Count: ${s.count} • Max: ${s.max.toFixed(1)}ms • Last: ${s.last.toFixed(1)}ms\n          </div>\n          <div style="display:flex;gap:4px;margin-top:4px;">\n            <input type="number" placeholder="Threshold (ms)" value="${n?r.avgMs:""}"\n              id="perf-threshold-${e.replace(/[^a-z0-9_-]/gi,"-")}"\n              name="perf-threshold-${e.replace(/[^a-z0-9_-]/gi,"-")}"\n              data-bus-event="performance:set-threshold" data-timer="${e}"\n              onchange="__msdHudBus('performance:set-threshold',{timer:'${e}',value:this.value})"\n              style="width:80px;font-size:9px;padding:1px 3px;">\n            <button data-bus-event="performance:reset-timer"\n              onclick="__msdHudBus('performance:reset-timer',{timer:'${e}'})"\n              style="font-size:9px;padding:1px 4px;background:#555;color:#fff;border:1px solid #777;border-radius:2px;cursor:pointer;">\n              Reset\n            </button>\n          </div>\n        </div>`})),t+="</div>");const a=Object.entries(n||{}).slice(0,8);a.length>0&&(t+='<div class="msd-hud-section"><h4>Counters</h4>',a.forEach((([e,s])=>{t+=`<div class="msd-hud-metric">\n          <span class="msd-hud-metric-name">${e}</span>\n          <span class="msd-hud-metric-value">${s}</span>\n        </div>`})),t+="</div>"),0===o.length&&0===a.length&&(t+='<div class="msd-hud-section">No performance data available</div>');const l=r?.length||0,c=i?.length||0;return t+=`<div class="msd-hud-section msd-hud-summary">\n      ${o.length} timers • ${a.length} counters\n      ${l>0?` • ${l} alerts`:""}\n      ${c>0?` • ${c} regressions`:""}\n    </div>`,t+="</div>",t}}class Zl{captureData(){const e=[],t=[];try{const s=window.__msdDebug?.getDebugStatusSilent?.()||{};let n={};n=s.enabled&&window.__msdDebug?.validation?.issues?window.__msdDebug.validation.issues()||{}:window.__msdDebug?.pipelineInstance?.getValidationIssues?.()||{},n.errors&&n.errors.forEach((t=>{e.push({code:t.code||"unknown",severity:t.severity||"error",message:t.msg||t.message||"Unknown error",overlay:t.overlay,anchor:t.anchor})})),n.warnings&&n.warnings.forEach((e=>{t.push({code:e.code||"unknown",severity:e.severity||"warning",message:e.msg||e.message||"Unknown warning",overlay:e.overlay,anchor:e.anchor})}))}catch(e){}return{errors:e,warnings:t}}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Validation</h3>';const s=e.errors||[];s.length>0&&(t+='<div class="msd-hud-section msd-hud-errors"><h4>Errors</h4>',s.slice(0,6).forEach((e=>{t+=`<div class="msd-hud-metric msd-hud-error"\n          data-select-type="${e.overlay?"overlay":"anchor"}"\n          data-select-id="${e.overlay||e.anchor||e.code}"\n          onclick="__msdHudBus('select:set',{type:'${e.overlay?"overlay":"anchor"}',id:'${e.overlay||e.anchor||e.code}',source:'validation'})"\n        >\n          <span class="msd-hud-metric-name">${e.code}</span>\n          <span class="msd-hud-metric-value">${e.message}</span>\n        </div>`,e.overlay&&(t+=`<div class="msd-hud-metric-detail">Overlay: ${e.overlay}</div>`),e.anchor&&(t+=`<div class="msd-hud-metric-detail">Anchor: ${e.anchor}</div>`)})),t+="</div>");const n=e.warnings||[];n.length>0&&(t+='<div class="msd-hud-section msd-hud-warnings"><h4>Warnings</h4>',n.slice(0,6).forEach((e=>{t+=`<div class="msd-hud-metric msd-hud-warning"\n          data-select-type="${e.overlay?"overlay":"anchor"}"\n          data-select-id="${e.overlay||e.anchor||e.code}"\n          onclick="__msdHudBus('select:set',{type:'${e.overlay?"overlay":"anchor"}',id:'${e.overlay||e.anchor||e.code}',source:'validation'})"\n        >\n          <span class="msd-hud-metric-name">${e.code}</span>\n          <span class="msd-hud-metric-value">${e.message}</span>\n        </div>`,e.overlay&&(t+=`<div class="msd-hud-metric-detail">Overlay: ${e.overlay}</div>`)})),t+="</div>");const r=s.length+n.length;return t+=0===r?'<div class="msd-hud-section msd-hud-success">✅ No validation issues</div>':`<div class="msd-hud-section msd-hud-summary">\n        ${s.length} errors, ${n.length} warnings\n      </div>`,t+="</div>",t}}class Kl{constructor(){this.entityChangeHistory=new Map,this.maxHistoryLength=10}inspectEntity(e){try{const t=window.__msdDebug?.pipelineInstance,s=t?.dataSourceManager||t?.systemsManager?.dataSourceManager||window.__msdDebug?.dataSourceManager;if(s?.getEntity){const t=s.getEntity(e);console.log(`[DataSourcePanel] Entity ${e}:`,t),console.table([t])}else console.warn("[DataSourcePanel] DataSourceManager not available")}catch(e){console.warn("[DataSourcePanel] Entity inspection failed:",e)}}refreshSubscriptions(){try{const e=window.__msdDebug?.pipelineInstance,t=e?.dataSourceManager||e?.systemsManager?.dataSourceManager||window.__msdDebug?.dataSourceManager;t?.refreshSubscriptions?(t.refreshSubscriptions(),console.log("[DataSourcePanel] Subscriptions refreshed")):console.warn("[DataSourcePanel] Refresh not available"),window.__msdDebug?.hud?.refresh&&window.__msdDebug.hud.refresh()}catch(e){console.warn("[DataSourcePanel] Subscription refresh failed:",e)}}clearHistory(){this.entityChangeHistory.clear(),console.log("[DataSourcePanel] Change history cleared"),window.__msdDebug?.hud?.refresh&&window.__msdDebug.hud.refresh()}captureData(){const e={},t={},s={},n={},r=[];try{const i=window.__msdDebug?.pipelineInstance,o=i?.dataSourceManager||i?.systemsManager?.dataSourceManager||window.__msdDebug?.dataSourceManager;if(o){const i=o.listIds?.()||[],a=o.getStats?.()||{},l=o.getHealth?.()||{};t.count=i.length,t.subscribed=Object.keys(a.sources||{}).length,t.updated=Object.values(a.sources||{}).reduce(((e,t)=>e+(t.received||0)),0),t.cacheHits=Object.values(a.sources||{}).reduce(((e,t)=>e+(t.cacheHits||0)),0),t.errors=Object.values(a.sources||{}).reduce(((e,t)=>e+(t.errors||0)),0),l.status&&(s.status=l.status,s.uptime=l.uptime||0,s.lastError=l.lastError,s.connectionCount=l.connectionCount||0),a.sources&&Object.entries(a.sources).forEach((([e,t])=>{n[e]={subscribers:t.subscribers||0,received:t.received||0,errors:t.errors||0,lastUpdate:t.lastUpdate,cacheHits:t.cacheHits||0}})),i.slice(0,15).forEach((t=>{const s=o.getEntity?.(t);if(s){const n=this.entityChangeHistory.get(t);if(n&&n.state!==s.state&&r.push({id:t,from:n.state,to:s.state,timestamp:Date.now()}),this.entityChangeHistory.set(t,{state:s.state,timestamp:Date.now()}),this.entityChangeHistory.size>this.maxHistoryLength){const e=this.entityChangeHistory.keys().next().value;this.entityChangeHistory.delete(e)}e[t]={state:s.state,lastChanged:s.last_changed,lastUpdated:s.last_updated,attributes:s.attributes||{},domain:t.split(".")[0]}}}))}else console.warn("[DataSourcePanel] DataSourceManager not available via consolidated interface"),t.error="DataSourceManager not available"}catch(e){console.warn("[DataSourcePanel] Data capture failed:",e),t.error=e.message}return{entities:e,stats:t,health:s,subscriptions:n,recentChanges:r}}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Data Sources</h3>';const{entities:s,stats:n,health:r,subscriptions:i,recentChanges:o}=e;if(n.error)return t+=`<div class="msd-hud-section msd-hud-error">\n        <h4>Error</h4>\n        <div class="msd-hud-metric-value">${n.error}</div>\n      </div>`,t+="</div>",t;if(t+='<div class="msd-hud-section"><h4>Controls</h4>',t+='<div style="display:flex;flex-wrap:wrap;gap:4px;">',t+='<button data-bus-event="datasource:refresh-subs" onclick="__msdHudBus(\'datasource:refresh-subs\')"\n      style="font-size:10px;padding:2px 6px;background:#333;color:#fff;border:1px solid #555;border-radius:3px;cursor:pointer;">\n      Refresh Subs\n    </button>',t+='<button data-bus-event="datasource:clear-history" onclick="__msdHudBus(\'datasource:clear-history\')"\n      style="font-size:10px;padding:2px 6px;background:#666;color:#fff;border:1px solid #888;border-radius:3px;cursor:pointer;">\n      Clear History\n    </button>',t+="</div></div>",r&&r.status){const e="healthy"===r.status?"#66ff99":"warning"===r.status?"#ffaa00":"#ff6666";if(t+='<div class="msd-hud-section"><h4>Health Status</h4>',t+=`<div class="msd-hud-metric">\n        <span class="msd-hud-metric-name">Status</span>\n        <span class="msd-hud-metric-value" style="color:${e};">${r.status}</span>\n      </div>`,r.uptime>0){const e=(r.uptime/36e5).toFixed(1);t+=`<div class="msd-hud-metric">\n          <span class="msd-hud-metric-name">Uptime</span>\n          <span class="msd-hud-metric-value">${e}h</span>\n        </div>`}void 0!==r.connectionCount&&(t+=`<div class="msd-hud-metric">\n          <span class="msd-hud-metric-name">Connections</span>\n          <span class="msd-hud-metric-value">${r.connectionCount}</span>\n        </div>`),r.lastError&&(t+=`<div class="msd-hud-metric msd-hud-warning">\n          <span class="msd-hud-metric-name">Last Error</span>\n          <span class="msd-hud-metric-value">${r.lastError}</span>\n        </div>`),t+="</div>"}if(t+='<div class="msd-hud-section"><h4>Statistics</h4>',t+=`<div class="msd-hud-metric">\n      <span class="msd-hud-metric-name">Total Entities</span>\n      <span class="msd-hud-metric-value">${n.count||0}</span>\n    </div>`,t+=`<div class="msd-hud-metric">\n      <span class="msd-hud-metric-name">Data Sources</span>\n      <span class="msd-hud-metric-value">${n.subscribed||0}</span>\n    </div>`,t+=`<div class="msd-hud-metric">\n      <span class="msd-hud-metric-name">Total Updates</span>\n      <span class="msd-hud-metric-value">${n.updated||0}</span>\n    </div>`,void 0!==n.cacheHits){const e=n.updated>0?(n.cacheHits/n.updated*100).toFixed(1):"0";t+=`<div class="msd-hud-metric">\n        <span class="msd-hud-metric-name">Cache Hit Rate</span>\n        <span class="msd-hud-metric-value">${e}%</span>\n      </div>`}void 0!==n.errors&&n.errors>0&&(t+=`<div class="msd-hud-metric msd-hud-warning">\n        <span class="msd-hud-metric-name">Errors</span>\n        <span class="msd-hud-metric-value">${n.errors}</span>\n      </div>`),t+="</div>",i&&Object.keys(i).length>0&&(t+='<div class="msd-hud-section"><h4>Active Subscriptions</h4>',Object.entries(i).slice(0,6).forEach((([e,s])=>{const n=e.length>18?e.substring(0,15)+"...":e,r=s.errors>0;t+=`<div class="msd-hud-metric ${r?"msd-hud-warning":""}">\n          <div style="display:flex;justify-content:space-between;">\n            <span class="msd-hud-metric-name">${n}</span>\n            <span class="msd-hud-metric-value">${s.subscribers} subs</span>\n          </div>\n          <div style="font-size:10px;color:#888;margin-top:2px;">\n            ${s.received} updates • ${s.cacheHits} cached\n            ${r?` • ${s.errors} errors`:""}\n          </div>\n        </div>`})),t+="</div>"),o&&o.length>0&&(t+='<div class="msd-hud-section"><h4>Recent Changes</h4>',o.slice(-5).forEach((e=>{const s=e.id.length>20?e.id.substring(0,17)+"...":e.id,n=Math.round((Date.now()-e.timestamp)/1e3);t+=`<div class="msd-hud-metric" style="cursor:pointer;"\n          onclick="__msdHudBus('datasource:inspect',{id:'${e.id}'})">\n          <div style="display:flex;justify-content:space-between;">\n            <span class="msd-hud-metric-name">${s}</span>\n            <span style="font-size:10px;color:#888;">${n}s ago</span>\n          </div>\n          <div style="font-size:10px;color:#ccc;margin-top:1px;">\n            ${e.from} → ${e.to}\n          </div>\n        </div>`})),t+="</div>");const a=Object.entries(s||{});if(a.length>0){const e={};a.forEach((([t,s])=>{const n=s.domain||"unknown";e[n]||(e[n]=[]),e[n].push([t,s])})),t+='<div class="msd-hud-section"><h4>Entity Samples</h4>',Object.entries(e).slice(0,4).forEach((([e,s])=>{t+=`<div style="margin-bottom:6px;">\n          <div style="font-weight:bold;font-size:11px;color:#ffaa00;">${e} (${s.length})</div>`,s.slice(0,3).forEach((([e,s])=>{const n=e.length>20?e.substring(0,17)+"...":e,r=s.state||"N/A",i=r.length>12?r.substring(0,9)+"...":r;t+=`<div class="msd-hud-metric" style="cursor:pointer;margin-left:10px;"\n            onclick="__msdHudBus('datasource:inspect',{id:'${e}'})">\n            <span class="msd-hud-metric-name">${n}</span>\n            <span class="msd-hud-metric-value">${i}</span>\n          </div>`})),t+="</div>"})),t+="</div>"}else n.count>0?t+='<div class="msd-hud-section">Entities available but no recent data</div>':t+='<div class="msd-hud-section">No entity data available</div>';return t+="</div>",t}}class Ql{constructor(){this.filters={strategy:"all",minCost:0,maxCost:1500,cacheHit:"all",showArcs:!1},this.inputStates={minCostFocused:!1,maxCostFocused:!1}}setFilter(e,t){this.filters[e]=t}updateCostFilter(e,t){const s=parseFloat(t);isNaN(s)||(this.filters[e]=s)}finalizeCostFilter(){}setInputFocus(e,t){this.inputStates[e]=t}highlightRoute(e){console.log("[RoutingPanel] Highlighting route:",e);try{const t=window.__msdDebug?.pipelineInstance?.mountElement||window.__msdDebug?.mountElement||document.querySelector("cb-lcars-msd-card")?.shadowRoot||document;if(!t)return void console.warn("[RoutingPanel] No mount element found for route highlighting");t.querySelectorAll(`g[data-overlay-id="${e}"], path[data-overlay-id="${e}"], #${e}`).forEach((e=>{e.classList.add("msd-route-highlighted"),setTimeout((()=>{e.classList.remove("msd-route-highlighted")}),3e3)})),t.querySelectorAll(`g[data-overlay-id="${e}"]`).forEach((e=>{e.querySelectorAll("path").forEach((e=>{const t=e.style.stroke||e.getAttribute("stroke"),s=e.style.strokeWidth||e.getAttribute("stroke-width");e.style.stroke="#ff00ff",e.style.strokeWidth="4",e.style.filter="drop-shadow(0 0 6px #ff00ff)",setTimeout((()=>{e.style.stroke=t,e.style.strokeWidth=s,e.style.filter=""}),3e3)}))})),this.showRouteHighlightFeedback(e)}catch(e){console.warn("[RoutingPanel] Route highlighting failed:",e)}window.__msdDebug?.hud?.emit&&window.__msdDebug.hud.emit("routing:focus",{id:e})}analyzeRoute(e){const t=window.__msdDebug?.routing;if(t?.inspect){const s=t.inspect(e);if(console.group(`🔍 Route Analysis: ${e}`),s.meta&&console.table({Strategy:s.meta.strategy||"unknown",Cost:s.meta.cost||0,Segments:s.meta.segments||0,Bends:s.meta.bends||0,"Cache Hit":s.meta.cache_hit?"✅ Yes":"❌ No"}),s.pts&&s.pts.length>0&&(console.log("📍 Path Points:",s.pts.length,"points"),console.table(s.pts.map(((e,t)=>({Index:t,X:e[0],Y:e[1],Type:0===t?"Start":t===s.pts.length-1?"End":"Waypoint"}))))),s.meta?.hint&&(console.log("💡 Routing Hints:"),console.table(s.meta.hint)),s.d){const e=s.d.length>100?s.d.substring(0,97)+"...":s.d;console.log("🎨 SVG Path:",e)}console.log("📋 Full Analysis Object:",s),console.groupEnd(),this.showRouteAnalysisFeedback(e,s)}}showRouteHighlightFeedback(e){const t=document.createElement("div");t.style.cssText="\n      position: fixed;\n      top: 20px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(255, 0, 255, 0.9);\n      color: white;\n      padding: 8px 16px;\n      border-radius: 4px;\n      font-size: 12px;\n      z-index: 1000001;\n      pointer-events: none;\n    ",t.textContent=`Highlighting route: ${e}`,document.body.appendChild(t),setTimeout((()=>{t.remove()}),2e3)}showRouteAnalysisFeedback(e,t){const s=document.createElement("div");s.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: rgba(0, 0, 0, 0.95);\n      color: #00ffff;\n      padding: 16px;\n      border: 2px solid #00ffff;\n      border-radius: 8px;\n      font-family: monospace;\n      font-size: 12px;\n      z-index: 1000002;\n      max-width: 400px;\n      box-shadow: 0 4px 20px rgba(0, 255, 255, 0.3);\n    ";let n=`<h3 style="margin:0 0 12px;color:#ffaa00;">Route Analysis: ${e}</h3>`;t.meta&&(n+=`\n        <div style="margin-bottom:12px;">\n          <div><strong>Strategy:</strong> ${t.meta.strategy||"unknown"}</div>\n          <div><strong>Cost:</strong> ${t.meta.cost||0}</div>\n          <div><strong>Segments:</strong> ${t.meta.segments||0}</div>\n          <div><strong>Bends:</strong> ${t.meta.bends||0}</div>\n          <div><strong>Cache Hit:</strong> ${t.meta.cache_hit?"✅ Yes":"❌ No"}</div>\n        </div>\n      `),t.pts&&t.pts.length>0&&(n+=`\n        <div style="margin-bottom:12px;">\n          <strong>Path:</strong> ${t.pts.length} points<br>\n          <div style="font-size:10px;margin-top:4px;">\n            Start: (${t.pts[0][0]}, ${t.pts[0][1]})<br>\n            End: (${t.pts[t.pts.length-1][0]}, ${t.pts[t.pts.length-1][1]})\n          </div>\n        </div>\n      `),t.meta?.hint&&(n+=`\n        <div style="margin-bottom:12px;">\n          <strong>Hints:</strong><br>\n          <div style="font-size:10px;margin-top:4px;">\n            First: ${t.meta.hint.first||"n/a"} (${t.meta.hint.sourceFirst||"n/a"})<br>\n            Last: ${t.meta.hint.last||"n/a"} (${t.meta.hint.sourceLast||"n/a"})\n          </div>\n        </div>\n      `),n+='\n      <div style="text-align:center;margin-top:12px;">\n        <button onclick="this.parentElement.parentElement.remove()"\n          style="background:#333;color:#fff;border:1px solid #555;padding:4px 12px;border-radius:4px;cursor:pointer;">\n          Close\n        </button>\n      </div>\n    ',s.innerHTML=n,document.body.appendChild(s),setTimeout((()=>{s.parentElement&&s.remove()}),25e3)}captureData(){const e={},t={},s={};try{const n=window.__msdDebug?.routing;if(n){const r=n.stats?.()||{};Object.assign(e,r),n.getPerformanceMetrics&&(s.metrics=n.getPerformanceMetrics());const i=window.__msdDebug?.pipelineInstance;if(i){const e=i.getResolvedModel?.();if(e?.overlays){const s=e.overlays.filter((e=>"line"===e.type&&e.anchor&&e.attach_to)).slice(0,15);s.forEach((e=>{try{const s=n.inspect?.(e.id);s&&s.pts?t[e.id]={id:e.id,strategy:s.meta?.strategy||"auto",pathLength:s.pts?.length||0,segments:s.meta?.segments||0,bends:s.meta?.bends||0,cost:s.meta?.cost||0,cached:s.meta?.cache_hit||!1,success:s.pts&&s.pts.length>0,arcCount:s.meta?.arc?.count||0,startAnchor:e.anchor,endAnchor:e.attach_to,smooth:s.meta?.smooth||!1,channel:s.meta?.channel,computeTime:s.meta?.compute_time_ms||0}:t[e.id]={id:e.id,strategy:"unknown",pathLength:0,segments:0,bends:0,cost:0,cached:!1,success:!1,arcCount:0,startAnchor:e.anchor,endAnchor:e.attach_to,smooth:!1,channel:null,computeTime:0}}catch(t){console.warn(`[RoutingPanel] Route inspection failed for ${e.id}:`,t)}}))}}}}catch(e){console.warn("[RoutingPanel] Data capture failed:",e)}return{stats:e,routes:t,performance:s}}filterRoutes(e){return Object.values(e).filter((e=>!("all"!==this.filters.strategy&&e.strategy!==this.filters.strategy||e.cost<this.filters.minCost||e.cost>this.filters.maxCost||"hit"===this.filters.cacheHit&&!e.cached||"miss"===this.filters.cacheHit&&e.cached||this.filters.showArcs&&0===e.arcCount)))}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Enhanced Routing</h3>';t+="<style>\n      .msd-route-highlighted {\n        outline: 3px solid #ff00ff !important;\n        background: rgba(255, 0, 255, 0.1) !important;\n        box-shadow: 0 0 10px #ff00ff !important;\n      }\n    </style>",t+='<div class="msd-hud-section"><h4>Filters</h4>',t+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">',t+='<select id="hud-routing-strategy" name="hud-routing-strategy" data-bus-event="routing:set-filter" data-key="strategy" onchange="__msdHudBus(\'routing:set-filter\', {key:\'strategy\', value:this.value})" style="font-size:10px;">',["all","auto","manhattan","smooth","direct"].forEach((e=>{const s=this.filters.strategy===e?"selected":"";t+=`<option value="${e}" ${s}>${e}</option>`})),t+="</select>",t+=`<input type="number" id="hud-routing-min-cost" name="hud-routing-min-cost"\n      data-bus-event="routing:update-cost" data-key="minCost"\n      onfocus="__msdHudBus('routing:focus-set',{field:'minCostFocused',focus:true})"\n      onblur="__msdHudBus('routing:focus-set',{field:'minCostFocused',focus:false});__msdHudBus('routing:finalize-cost')"\n      oninput="__msdHudBus('routing:update-cost',{key:'minCost',value:this.value})"\n      placeholder="Min cost" value="${this.filters.minCost}" style="width:60px;font-size:10px;">`,t+=`<input type="number" id="hud-routing-max-cost" name="hud-routing-max-cost"\n      data-bus-event="routing:update-cost" data-key="maxCost"\n      onfocus="__msdHudBus('routing:focus-set',{field:'maxCostFocused',focus:true})"\n      onblur="__msdHudBus('routing:focus-set',{field:'maxCostFocused',focus:false});__msdHudBus('routing:finalize-cost')"\n      oninput="__msdHudBus('routing:update-cost',{key:'maxCost',value:this.value})"\n      placeholder="Max cost" value="${this.filters.maxCost}" style="width:60px;font-size:10px;">`,t+='<select id="hud-routing-cachehit" name="hud-routing-cachehit" data-bus-event="routing:set-filter" data-key="cacheHit" onchange="__msdHudBus(\'routing:set-filter\', {key:\'cacheHit\', value:this.value})" style="font-size:10px;">',["all","hit","miss"].forEach((e=>{const s=this.filters.cacheHit===e?"selected":"";t+=`<option value="${e}" ${s}>Cache: ${e}</option>`})),t+="</select>",t+="</div></div>";const s=e.stats||{};Object.keys(s).length>0&&(t+='<div class="msd-hud-section"><h4>Cache Statistics</h4>',Object.entries(s).forEach((([e,s])=>{t+=`<div class="msd-hud-metric">\n          <span class="msd-hud-metric-name">${e}</span>\n          <span class="msd-hud-metric-value">${s}</span>\n        </div>`})),t+="</div>");const n=e.performance||{};n.metrics&&(t+='<div class="msd-hud-section"><h4>Performance</h4>',Object.entries(n.metrics).forEach((([e,s])=>{const n="number"==typeof s?s.toFixed(2):s;t+=`<div class="msd-hud-metric">\n          <span class="msd-hud-metric-name">${e}</span>\n          <span class="msd-hud-metric-value">${n}</span>\n        </div>`})),t+="</div>");const r=e.routes||{},i=this.filterRoutes(r);return i.length>0?(t+=`<div class="msd-hud-section"><h4>Routes (${i.length}/${Object.keys(r).length})</h4>`,i.sort(((e,t)=>t.cost-e.cost)),i.slice(0,8).forEach((e=>{const s=e.id.length>15?e.id.substring(0,12)+"...":e.id,n=(e.success,e.cost>50?"#ff6666":e.cost>20?"#ffaa00":"#66ff99");t+=`<div class="msd-hud-metric"\n          data-overlay-id="${e.id}"\n          data-select-type="route"\n          data-select-id="${e.id}"\n          style="cursor:pointer;border:1px solid #333;padding:4px;margin:2px 0;border-radius:3px;transition:all 0.3s;"\n          onclick="__msdHudBus('select:set',{type:'route',id:'${e.id}',source:'routing'});__msdHudBus('routing:highlight',{id:'${e.id}'})"\n          onmouseover="this.style.background='rgba(255,0,255,0.1)'"\n          onmouseout="this.style.background=''">\n          <div style="display:flex;justify-content:space-between;">\n            <span class="msd-hud-metric-name">${s}</span>\n            <span class="msd-hud-metric-value" style="color:${n};">${e.cost.toFixed(1)}</span>\n          </div>\n          <div style="font-size:10px;color:#888;margin-top:2px;">\n            ${e.strategy} • ${e.pathLength}pts • ${e.bends}↻\n            ${e.cached?" • 📋":""}\n            ${e.arcCount>0?` • 🔄${e.arcCount}`:""}\n          </div>\n        </div>`,t+=`<div style="text-align:right;margin-top:2px;">\n          <button data-bus-event="routing:analyze"\n            onclick="__msdHudBus('select:set',{type:'route',id:'${e.id}',source:'routing'});__msdHudBus('routing:analyze',{id:'${e.id}'})"\n            style="font-size:9px;padding:1px 4px;background:#333;color:#ccc;border:1px solid #555;border-radius:2px;cursor:pointer;">\n            Analyze\n          </button>\n        </div>`})),i.length>8&&(t+=`<div style="font-size:10px;text-align:center;color:#666;margin-top:4px;">\n          ... ${i.length-8} more routes\n        </div>`),t+="</div>"):t+='<div class="msd-hud-section">No routes match current filters</div>',t+="</div>",t}shouldSkipRefresh(){return this.inputStates.minCostFocused||this.inputStates.maxCostFocused}}class ec{constructor(){this.history=new Map,this.maxHistoryLength=30,this.conflictThreshold=3,this.lastSnapshot=null}captureData(){const e=window.__msdDebug?.routing,t=e?.channels?._occupancy||{},s=[],n={},r=[];try{Object.entries(t).forEach((([e,t])=>{this.history.has(e)||this.history.set(e,[]);const s=this.history.get(e);s.push(t),s.length>this.maxHistoryLength&&s.shift()})),Object.entries(t).forEach((([e,t])=>{t>=this.conflictThreshold&&s.push({channel:e,count:t,severity:t>=5?"high":"medium"})})),this.history.forEach(((e,t)=>{if(e.length>=3){const s=e.slice(-3),r=s.reduce(((e,t)=>e+t),0)/s.length,i=s[s.length-1]-s[0];n[t]={current:s[s.length-1],average:r,trend:i,variance:this.calculateVariance(s),history:[...e]}}})),s.length>0&&r.push({type:"conflict",message:`${s.length} channel conflicts detected`,action:"Consider adjusting routing strategy"});const e=Object.entries(n).filter((([e,t])=>t.variance>2)).length;e>0&&r.push({type:"variance",message:`${e} channels show high variance`,action:"Review routing stability"});const i=this.history.size-Object.keys(t).length;i>5&&r.push({type:"optimization",message:`${i} channels currently unused`,action:"Potential for route optimization"})}catch(e){console.warn("[ChannelTrendPanel] Data capture failed:",e)}return{current:t,conflicts:s,trends:n,recommendations:r}}calculateVariance(e){if(0===e.length)return 0;const t=e.reduce(((e,t)=>e+t),0)/e.length;return e.map((e=>Math.pow(e-t,2))).reduce(((e,t)=>e+t),0)/e.length}renderSparkline(e,t=null){if(!e||0===e.length)return"";const s=t||Math.max(...e,1);let n="";const r=Math.max(1,Math.floor(e.length/40));for(let t=0;t<e.length;t+=r){const r=e[t]/s;n+=" ▁▂▃▄▅▆▇█"[Math.min(8,Math.floor(8*r))]}return n}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Channel Trends</h3>';const{current:s,conflicts:n,trends:r,recommendations:i}=e;if(n&&n.length>0&&(t+='<div class="msd-hud-section msd-hud-warning"><h4>Conflicts Detected</h4>',n.forEach((e=>{const s="high"===e.severity?"#ff4444":"#ffaa00";t+=`<div class="msd-hud-metric">\n          <span class="msd-hud-metric-name" style="color:${s};">${e.channel}</span>\n          <span class="msd-hud-metric-value">${e.count} routes</span>\n        </div>`})),t+="</div>"),i&&i.length>0&&(t+='<div class="msd-hud-section"><h4>Recommendations</h4>',i.forEach((e=>{const s="conflict"===e.type?"#ff6666":"variance"===e.type?"#ffaa00":"#66ff99";t+=`<div class="msd-hud-metric">\n          <div style="color:${s};font-size:10px;">${e.message}</div>\n          <div style="color:#888;font-size:9px;">${e.action}</div>\n        </div>`})),t+="</div>"),r&&Object.keys(r).length>0){t+='<div class="msd-hud-section"><h4>Usage Trends</h4>';const e=Object.entries(r).sort((([,e],[,t])=>t.current-e.current)).slice(0,8);e.forEach((([e,s])=>{const n=e.length>15?e.substring(0,12)+"...":e,r=s.trend>0?"↗":s.trend<0?"↘":"→",i=s.trend>0?"#ff6666":s.trend<0?"#66ff99":"#888",o=this.renderSparkline(s.history);t+=`<div class="msd-hud-metric" style="margin:4px 0;">\n          <div style="display:flex;justify-content:space-between;">\n            <span class="msd-hud-metric-name">${n}</span>\n            <span class="msd-hud-metric-value">${s.current}</span>\n          </div>\n          <div style="display:flex;justify-content:space-between;font-size:10px;margin-top:2px;">\n            <span style="font-family:monospace;color:#888;">${o}</span>\n            <span style="color:${i};">${r} ${s.average.toFixed(1)}</span>\n          </div>\n        </div>`})),t+="</div>"}const o=Object.keys(s||{}).length,a=Object.values(s||{}).reduce(((e,t)=>e+t),0),l=this.history.size;return t+=`<div class="msd-hud-section msd-hud-summary">\n      ${o} active channels • ${a} total routes • ${l} tracked\n    </div>`,t+="</div>",t}}class tc{constructor(){this.debugFeatures=["anchors","bounding_boxes","routing","performance"]}toggleFeature(e){if(console.log("[FlagsPanel] toggleFeature called:",e),!window.__msdDebug?.debug)return void console.warn("[FlagsPanel] Debug interface not available");const t=window.__msdDebug?.debugManager||window.__msdDebug?.pipelineInstance?.systemsManager?.debugManager;if(!t)return void console.warn("[FlagsPanel] DebugManager not available");const s=t.getSnapshot()[e];s?window.__msdDebug.debug.disable(e):window.__msdDebug.debug.enable(e),setTimeout((()=>{try{const t=window.__msdDebug?.pipelineInstance;t?.reRender?(console.log("[FlagsPanel] Triggering re-render after",e,s?"disable":"enable"),t.reRender()):console.warn("[FlagsPanel] No reRender method available on pipeline instance")}catch(e){console.warn("[FlagsPanel] Failed to trigger re-render:",e)}}),50),setTimeout((()=>{window.__msdDebug?.hud?.refresh&&window.__msdDebug.hud.refresh()}),100)}adjustScale(e){if(!window.__msdDebug?.debug?.status)return;const t=window.__msdDebug.debug.status().scale||1,s=e>0?t+.1:t-.1,n=Math.max(.5,Math.min(3,s));window.__msdDebug.debug.setScale&&window.__msdDebug.debug.setScale(n)}setScale(e){const t=parseFloat(e);if(isNaN(t))return;const s=Math.max(.5,Math.min(3,t));window.__msdDebug?.debug?.setScale&&window.__msdDebug.debug.setScale(s)}refreshDebug(){window.__msdDebug?.debug?.refresh?.()}captureData(){const e={},t={};try{const s=window.__msdDebug?.getDebugStatusSilent?.()||{};Object.assign(t,s),Object.assign(e,window.__msdDebug?._debugFlags||{})}catch(e){console.warn("[FlagsPanel] Data capture failed:",e)}return{flags:e,debugFeatures:t}}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Debug Features</h3>';const s=e.debugFeatures||{},n=s.scale||1;s.initialized?(t+='<div class="msd-hud-section"><h4>Status</h4>',t+=`<div>Debug ready • Scale: ${n.toFixed(1)}x</div></div>`):(t+='<div class="msd-hud-section msd-hud-warning"><h4>Status</h4>',t+="<div>Debug interface not ready</div></div>"),t+='<div class="msd-hud-section"><h4>Debug Features</h4>',t+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">',this.debugFeatures.forEach((e=>{const n=Boolean(s[e]),r=e.replace("_"," ");t+=`<button data-bus-event="flags:toggle" onclick="__msdHudBus('flags:toggle',{feature:'${e}'})"\n        style="font-size:10px;padding:2px 6px;border:1px solid #444;border-radius:3px;cursor:pointer;\n        background:${n?"#ff00ff":"#333"};color:${n?"#000":"#eee"};">\n        ${r}\n      </button>`})),t+="</div></div>",t+='<div class="msd-hud-section"><h4>Scale Control</h4>',t+='<div style="display:flex;gap:4px;align-items:center;margin-bottom:6px;">',t+='<button data-bus-event="flags:scale-adjust" onclick="__msdHudBus(\'flags:scale-adjust\',{dir:-1})" style="font-size:10px;padding:2px 6px;border:1px solid #444;border-radius:3px;cursor:pointer;\n      background:#333;color:#eee;">-</button>',t+=`<input type="number" id="hud-flags-scale" name="hud-flags-scale"\n      value="${n.toFixed(1)}" min="0.5" max="3.0" step="0.1" data-bus-event="flags:scale-set"\n      onchange="__msdHudBus('flags:scale-set',{scale:this.value})"\n      style="width:60px;font-size:10px;padding:2px 4px;border:1px solid #444;border-radius:3px;\n      background:#222;color:#eee;text-align:center;">`,t+='<button data-bus-event="flags:scale-adjust" onclick="__msdHudBus(\'flags:scale-adjust\',{dir:1})" style="font-size:10px;padding:2px 6px;border:1px solid #444;border-radius:3px;cursor:pointer;\n      background:#333;color:#eee;">+</button>',t+="</div>",t+='<div style="display:flex;gap:4px;align-items:center;">',[.8,1,1.2,1.5,2].forEach((e=>{const s=Math.abs(n-e)<.05;t+=`<button data-bus-event="flags:scale-set"\n        onclick="__msdHudBus('flags:scale-set',{scale:${e}})"\n        style="font-size:10px;padding:2px 6px;border:1px solid #444;border-radius:3px;cursor:pointer;\n        background:${s?"#ffaa00":"#333"};color:${s?"#000":"#eee"};">\n        ${e}x\n      </button>`})),t+='<button data-bus-event="flags:refresh" onclick="__msdHudBus(\'flags:refresh\')" style="font-size:10px;padding:2px 6px;border:1px solid #444;border-radius:3px;cursor:pointer;\n      background:#333;color:#eee;margin-left:8px;">\n      Refresh\n    </button>',t+="</div></div>";const r=this.debugFeatures.filter((e=>s[e])).length;return t+=`<div class="msd-hud-section msd-hud-summary">\n      ${r}/${this.debugFeatures.length} features enabled\n    </div>`,t+="</div>",t}}class sc{constructor(){this.issueCategories={validation:{label:"Validation",color:"#ff6666",icon:"⚠️"},routing:{label:"Routing",color:"#ffaa00",icon:"🔀"},performance:{label:"Performance",color:"#ff9900",icon:"⏱️"},debug:{label:"Debug",color:"#66cfff",icon:"🔧"}}}handleIssueClick(e,t,s){switch(console.log("[IssuesPanel] Issue clicked:",{action:e,id:t,overlay:s}),e){case"overlay":s&&window.__msdDebug?.debug&&console.log(`[IssuesPanel] Highlighting overlay: ${s}`);break;case"routing":console.log("[IssuesPanel] Opening routing diagnostics"),window.__msdDebug?.hud?.refresh&&window.__msdDebug.hud.refresh();break;case"performance":console.log(`[IssuesPanel] Performance issue: ${t}`);break;case"debug":console.log("[IssuesPanel] Debug issue clicked - attempting to initialize debug interface"),window.__msdDebug?.debug?.refresh&&window.__msdDebug.debug.refresh();break;case"enable-features":if(console.log("[IssuesPanel] Enabling basic debug features"),window.__msdDebug?.debug){window.__msdDebug.debug.enable("anchors"),window.__msdDebug.debug.enable("bounding_boxes");const e=document.createElement("div");e.style.cssText="\n            position: fixed;\n            top: 20px;\n            left: 50%;\n            transform: translateX(-50%);\n            background: rgba(0, 255, 0, 0.9);\n            color: white;\n            padding: 8px 16px;\n            border-radius: 4px;\n            font-size: 12px;\n            z-index: 1000001;\n            pointer-events: none;\n          ",e.textContent="Debug features enabled: anchors, bounding_boxes",document.body.appendChild(e),setTimeout((()=>e.remove()),3e3)}}this.bus&&("overlay"===e&&s?this.bus.emit("select:set",{type:"overlay",id:s,source:"issues"}):"routing"===e&&t?this.bus.emit("select:set",{type:"route",id:t,source:"issues"}):"performance"===e&&t&&this.bus.emit("select:set",{type:"timer",id:t,source:"issues"}))}captureData(){const e={validation:[],routing:[],performance:[],debug:[]};try{const t=window.__msdDebug?.validation?.issues?.()||{};t.errors&&t.errors.forEach((t=>{e.validation.push({id:t.overlay||t.anchor||"unknown",type:"validation",severity:"error",message:t.msg||t.message||"Validation error",code:t.code,overlay:t.overlay,anchor:t.anchor,clickAction:"overlay"})})),t.warnings&&t.warnings.forEach((t=>{e.validation.push({id:t.overlay||t.anchor||"unknown",type:"validation",severity:"warning",message:t.msg||t.message||"Validation warning",code:t.code,overlay:t.overlay,anchor:t.anchor,clickAction:"overlay"})}));const s=window.__msdDebug?.getDebugStatusSilent?.()||{};if(s.enabled){const t=window.__msdDebug?.routing;if(t?.stats){const s=t.stats();s.errors&&s.errors>0&&e.routing.push({id:"routing-errors",type:"routing",severity:"error",message:`${s.errors} routing errors detected`,code:"routing_errors",clickAction:"routing"})}}if(s.performance){const t=window.__msdDebug?.getPerf?.()||{};t.timers&&Object.entries(t.timers).forEach((([t,s])=>{s.avg>50&&e.performance.push({id:t,type:"performance",severity:"warning",message:`Slow timer: ${t} (${s.avg.toFixed(1)}ms avg)`,code:"slow_timer",clickAction:"performance"})}))}s.initialized?s.enabled||e.debug.push({id:"debug-features-disabled",type:"debug",severity:"info",message:"All debug features are disabled",code:"debug_features_off",clickAction:"enable-features"}):e.debug.push({id:"debug-status",type:"debug",severity:"warning",message:"Debug interface not initialized",code:"debug_not_initialized",clickAction:"debug"})}catch(t){console.warn("[IssuesPanel] Data capture failed:",t),e.debug.push({id:"capture-error",type:"debug",severity:"error",message:`Issue capture failed: ${t.message}`,code:"capture_error",clickAction:"debug"})}return e}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Issues</h3>';const s=[];if(Object.values(e).forEach((e=>{s.push(...e)})),0===s.length)return t+='<div class="msd-hud-section msd-hud-success">✅ No issues detected</div>',t+="</div>",t;const n=s.filter((e=>"error"===e.severity)).length,r=s.filter((e=>"warning"===e.severity)).length;return t+=`<div class="msd-hud-section msd-hud-summary">\n      ${n} errors, ${r} warnings • Click to fix\n    </div>`,Object.entries(e).forEach((([e,s])=>{if(0===s.length)return;const n=this.issueCategories[e];t+=`<div class="msd-hud-section">\n        <h4 style="color: ${n.color};">${n.icon} ${n.label} (${s.length})</h4>\n      `,s.slice(0,6).forEach(((e,s)=>{const n="error"===e.severity?"#ff6666":"#ffaa00";t+=`<div class="msd-hud-metric msd-issue-row"\n          data-bus-event="issues:action"\n          data-action="${e.clickAction}"\n          data-id="${e.id}"\n          data-overlay="${e.overlay||""}"\n          data-select-type="${"overlay"===e.clickAction?"overlay":"routing"===e.clickAction?"route":"performance"===e.clickAction?"timer":"issue"}"\n          data-select-id="${e.overlay||e.id}"\n          onclick="__msdHudBus('issues:action',{action:'${e.clickAction}',id:'${e.id}',overlay:'${e.overlay||""}'});__msdHudBus('select:set',{type:'${"overlay"===e.clickAction?"overlay":"routing"===e.clickAction?"route":"performance"===e.clickAction?"timer":"issue"}',id:'${e.overlay||e.id}',source:'issues'})"\n          style="cursor:pointer; border-left:3px solid ${n}; padding-left:6px; margin:2px 0;">\n          <div style="display: flex; justify-content: space-between; align-items: center;">\n            <span class="msd-hud-metric-name">[${e.code||e.type}]</span>\n            <span style="color: ${n}; font-size: 10px;">${e.severity.toUpperCase()}</span>\n          </div>\n          <div style="font-size: 10px; color: #ccc; margin-top: 2px;">${e.message}</div>\n        </div>`})),s.length>6&&(t+=`<div style="font-size: 9px; opacity: 0.6; text-align: center;">\n          ... ${s.length-6} more ${n.label.toLowerCase()} issues\n        </div>`),t+="</div>"})),t+="</div>",t}}class nc{captureData(){const e={},t={},s={};try{const n=window.__msdDebug?.pipelineInstance;if(n){const r=n.getResolvedModel?.();r&&(["animations","timelines","rules","profiles","overlays"].forEach((t=>{e[t]=r[t]||[],s[t]=e[t].length})),r.__provenance&&Object.assign(t,r.__provenance));const i=n.merged;i&&(Object.keys(e).forEach((t=>{i[t]&&(e[t]=i[t],s[t]=i[t].length)})),i.__provenance&&Object.assign(t,i.__provenance))}}catch(e){console.warn("[PacksPanel] Data capture failed:",e)}return{collections:e,provenance:t,summary:s}}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Packs & Collections</h3>';const{collections:s,provenance:n,summary:r}=e;if(r&&Object.keys(r).length>0&&(t+='<div class="msd-hud-section"><h4>Collection Summary</h4>',t+='<div style="display:flex;flex-wrap:wrap;gap:4px;font-size:10px;">',Object.entries(r).forEach((([e,s])=>{t+=`<span style="background:#222;color:${s>0?"#66ff99":"#666"};padding:2px 4px;border:1px solid #444;border-radius:3px;">\n          ${e}:${s}\n        </span>`})),t+="</div></div>"),n&&Object.keys(n).some((e=>Object.keys(n[e]||{}).length>0))){t+='<div class="msd-hud-section"><h4>Provenance Sample</h4>';const e=[];Object.entries(n).forEach((([t,s])=>{Object.entries(s||{}).forEach((([s,n])=>{e.push({collection:t,id:s,chain:n})}))})),e.slice(0,8).forEach((e=>{const s=e.id.length>15?e.id.substring(0,12)+"...":e.id,n=(e.chain||[]).map((e=>`${e.layer_id}${e.overridden?"*":""}`)).join(" → ");t+=`<div class="msd-hud-metric" style="margin:2px 0;">\n          <div style="display:flex;justify-content:space-between;">\n            <span class="msd-hud-metric-name">${e.collection}:${s}</span>\n          </div>\n          <div style="font-size:9px;color:#888;margin-top:1px;font-family:monospace;">\n            ${n||"No chain data"}\n          </div>\n        </div>`})),e.length>8&&(t+=`<div style="font-size:9px;opacity:0.6;text-align:center;">\n          ... ${e.length-8} more items\n        </div>`),t+="</div>"}return s&&Object.keys(s).length>0?(t+='<div class="msd-hud-section"><h4>Collections Detail</h4>',Object.entries(s).forEach((([e,s])=>{Array.isArray(s)&&0!==s.length&&(t+=`<div style="margin-bottom:6px;">\n          <div style="font-weight:bold;font-size:11px;color:#ffaa00;">${e} (${s.length})</div>`,s.slice(0,6).forEach((e=>{if(!e||!e.id)return;const s=[];if(e.__meta?.origin_pack){const t=e.__meta.origin_pack;"builtin:core"===t?s.push({text:"core",color:"#555"}):t.startsWith("builtin:")?s.push({text:"builtin",color:"#663399"}):t.startsWith("external:")?s.push({text:"ext",color:"#cc6600"}):s.push({text:"user",color:"#996515"})}e.__meta?.overridden&&s.push({text:"mod",color:"#8a6d00"}),e.__meta?.removed&&s.push({text:"rm",color:"#702020"});const n=s.map((e=>`<span style="background:${e.color};color:#fff;padding:0 3px;margin-left:4px;border-radius:2px;font-size:8px;">\n              ${e.text}\n            </span>`)).join(""),r=e.id.length>20?e.id.substring(0,17)+"...":e.id;t+=`<div style="margin-left:10px;font-size:10px;margin:1px 0;">\n            ${r}${n}\n          </div>`})),s.length>6&&(t+=`<div style="margin-left:10px;font-size:9px;color:#666;">\n            ... ${s.length-6} more\n          </div>`),t+="</div>")})),t+="</div>"):t+='<div class="msd-hud-section">No pack data available</div>',t+="</div>",t}}class rc{captureData(){const e=[],t=[],s={};try{const n=window.__msdDebug?.pipelineInstance,r=n?.systemsManager?.rulesEngine||n?.rulesEngine;if(r){const n=r.getTrace?.()||[];Array.isArray(n)?t.push(...n):n&&t.push(n);const i=r.rules||r._rules||[];Array.isArray(i)&&i.forEach((s=>{const n=t.find((e=>e&&e.id===s.id));e.push({id:s.id,priority:s.priority||0,lastMatch:n?.matched||!1,matchCount:s._matchCount||s.matchCount||0,conditions:s.when?Object.keys(s.when).length:0,actions:s.apply?Object.keys(s.apply).length:0})})),s.totalRules=e.length,s.matchedRules=e.filter((e=>e.lastMatch)).length,s.totalMatches=e.reduce(((e,t)=>e+t.matchCount),0),s.avgPriority=e.length>0?e.reduce(((e,t)=>e+t.priority),0)/e.length:0}}catch(e){return console.warn("[RulesPanel] Data capture failed:",e),{rules:[],trace:[],stats:{totalRules:0,matchedRules:0,totalMatches:0,avgPriority:0}}}return{rules:e,trace:t,stats:s}}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Rules Engine</h3>';const{rules:s,trace:n,stats:r}=e;if(r&&Object.keys(r).length>0&&(t+='<div class="msd-hud-section"><h4>Statistics</h4>',t+=`<div class="msd-hud-metric">\n        <span class="msd-hud-metric-name">Total Rules</span>\n        <span class="msd-hud-metric-value">${r.totalRules}</span>\n      </div>`,t+=`<div class="msd-hud-metric">\n        <span class="msd-hud-metric-name">Currently Matched</span>\n        <span class="msd-hud-metric-value" style="color:${r.matchedRules>0?"#66ff99":"#666"};">\n          ${r.matchedRules}\n        </span>\n      </div>`,t+=`<div class="msd-hud-metric">\n        <span class="msd-hud-metric-name">Total Matches</span>\n        <span class="msd-hud-metric-value">${r.totalMatches}</span>\n      </div>`,t+=`<div class="msd-hud-metric">\n        <span class="msd-hud-metric-name">Avg Priority</span>\n        <span class="msd-hud-metric-value">${r.avgPriority.toFixed(1)}</span>\n      </div>`,t+="</div>"),s&&s.length>0){t+='<div class="msd-hud-section"><h4>Rules Activity</h4>';const e=[...s].sort(((e,t)=>e.lastMatch!==t.lastMatch?t.lastMatch-e.lastMatch:t.priority-e.priority));e.slice(0,10).forEach((e=>{const s=e.id.length>20?e.id.substring(0,17)+"...":e.id,n=e.lastMatch?"✓":"○",r=e.lastMatch?"#66ff99":"#666";t+=`<div class="msd-hud-metric"\n          data-select-type="rule"\n          data-select-id="${e.id}"\n          onclick="__msdHudBus('select:set',{type:'rule',id:'${e.id}',source:'rules'})"\n          style="margin:2px 0;padding:2px;${e.lastMatch?"background:rgba(102,255,153,0.1);":""} border-radius:3px;">\n          <div style="display:flex;justify-content:space-between;align-items:center;">\n            <span class="msd-hud-metric-name">${s}</span>\n            <div style="display:flex;gap:8px;align-items:center;">\n              <span style="font-size:10px;color:#888;">p:${e.priority}</span>\n              <span style="color:${r};font-weight:bold;">${n}</span>\n            </div>\n          </div>\n          <div style="font-size:10px;color:#888;margin-top:1px;">\n            ${e.conditions} conditions • ${e.actions} actions • ${e.matchCount} matches\n          </div>\n        </div>`})),e.length>10&&(t+=`<div style="font-size:10px;text-align:center;color:#666;margin-top:4px;">\n          ... ${e.length-10} more rules\n        </div>`),t+="</div>"}else t+='<div class="msd-hud-section">No rules engine data available</div>';return t+="</div>",t}}class ic{constructor(){console.log("[ExportPanel] Constructor called"),this.initialized=!1,this.initialized=!0}exportCollapsed(){try{const e=window.__msdDebug?.pipelineInstance;if(e?.exportCollapsedJson){const t=e.exportCollapsedJson(!0);this.downloadJson(t,"msd-config-collapsed"),this.updateTextarea("collapsed",t)}}catch(e){console.error("[ExportPanel] Collapsed export failed:",e)}}exportFull(e=!1){try{const t=window.__msdDebug?.pipelineInstance;if(t?.exportFullSnapshotJson){const s=e?{include_meta:!0}:{},n=t.exportFullSnapshotJson(s,!0),r=e?"msd-snapshot-with-meta":"msd-snapshot";this.downloadJson(n,r),this.updateTextarea("full",n)}}catch(e){console.error("[ExportPanel] Full export failed:",e)}}diffItem(){}clearTextarea(e){this.updateTextarea(e,"")}copyToClipboard(e){const t=document.getElementById(`export-${e}-textarea`);t&&t.value&&navigator.clipboard.writeText(t.value).then((()=>{this.showFeedback("Copied to clipboard!")})).catch((e=>{console.warn("Clipboard copy failed:",e),t.select(),t.setSelectionRange(0,99999)}))}downloadJson(e,t){try{const s=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(s),r=document.createElement("a");r.href=n,r.download=`${t}-${Date.now()}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n),this.showFeedback(`Downloaded: ${r.download}`)}catch(e){console.error("[ExportPanel] Download failed:",e)}}updateTextarea(e,t){const s=document.getElementById(`export-${e}-textarea`);s&&(s.value=t)}showFeedback(e,t="info"){const s={info:"#00ffff",success:"#00ff00",warning:"#ffaa00",error:"#ff6666"},n=document.createElement("div");n.style.cssText=`\n      position: fixed;\n      top: 20px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(0, 0, 0, 0.9);\n      color: ${s[t]};\n      padding: 8px 16px;\n      border: 1px solid ${s[t]};\n      border-radius: 4px;\n      font-size: 12px;\n      z-index: 1000001;\n      pointer-events: none;\n    `,n.textContent=e,document.body.appendChild(n),setTimeout((()=>n.remove()),3e3)}captureData(){const e=window.__msdDebug?.pipelineInstance,t={available:!!e,hasExportMethods:!(!e?.exportCollapsedJson||!e?.exportFullSnapshotJson),hasDiffMethod:!!e?.diffItem,collections:["animations","timelines","rules","profiles","overlays"],initialized:this.initialized,globalHandlers:!!window.__msdExportPanel};return t.available||console.warn("[ExportPanel] Pipeline not available for export functionality"),t}renderHtml(e){if(!e.available)return`<h3>Export & Config</h3>\n        <div class="msd-hud-section msd-hud-error">\n          Pipeline instance not available\n          <div style="font-size: 10px; color: #888; margin-top: 4px;">\n            Initialized: ${e.initialized} | Handlers: ${e.globalHandlers}\n          </div>\n        </div>`;let t="<h3>Export & Config</h3>";return t+='<div class="msd-hud-section"><h4>Export Configuration</h4>',t+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;">',t+='<button data-bus-event="export:collapsed" onclick="__msdHudBus(\'export:collapsed\')"\n      style="font-size:10px;padding:2px 6px;background:#333;color:#fff;border:1px solid #555;border-radius:3px;cursor:pointer;">\n      Collapsed JSON\n    </button>',t+='<button data-bus-event="export:full" onclick="__msdHudBus(\'export:full\')"\n      style="font-size:10px;padding:2px 6px;background:#333;color:#fff;border:1px solid #555;border-radius:3px;cursor:pointer;">\n      Full Snapshot\n    </button>',t+='<button data-bus-event="export:full-meta" onclick="__msdHudBus(\'export:full-meta\')"\n      style="font-size:10px;padding:2px 6px;background:#666;color:#fff;border:1px solid #888;border-radius:3px;cursor:pointer;">\n      +Metadata\n    </button>',t+="</div>",t+='<div style="margin-bottom:6px;">',t+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">',t+='<span style="font-size:11px;color:#ffaa00;">Collapsed JSON:</span>',t+='<div style="display:flex;gap:2px;">',t+='<button data-bus-event="export:copy" onclick="__msdHudBus(\'export:copy\',{type:\'collapsed\'})" style="font-size:9px;padding:1px 4px;background:#444;color:#fff;border:1px solid #666;border-radius:2px;cursor:pointer;">Copy</button>',t+='<button data-bus-event="export:clear" onclick="__msdHudBus(\'export:clear\',{type:\'collapsed\'})" style="font-size:9px;padding:1px 4px;background:#666;color:#fff;border:1px solid #888;border-radius:2px;cursor:pointer;">Clear</button>',t+="</div></div>",t+='<textarea id="export-collapsed-textarea" name="export-collapsed" readonly\n      style="width:100%;height:80px;font-size:9px;font-family:monospace;background:#111;color:#ccc;border:1px solid #444;border-radius:3px;padding:4px;resize:vertical;"></textarea>',t+="</div>",t+='<div style="margin-bottom:6px;">',t+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">',t+='<span style="font-size:11px;color:#ffaa00;">Full Snapshot:</span>',t+='<div style="display:flex;gap:2px;">',t+='<button data-bus-event="export:copy" onclick="__msdHudBus(\'export:copy\',{type:\'full\'})" style="font-size:9px;padding:1px 4px;background:#444;color:#fff;border:1px solid #666;border-radius:2px;cursor:pointer;">Copy</button>',t+='<button data-bus-event="export:clear" onclick="__msdHudBus(\'export:clear\',{type:\'full\'})" style="font-size:9px;padding:1px 4px;background:#666;color:#fff;border:1px solid #888;border-radius:2px;cursor:pointer;">Clear</button>',t+="</div></div>",t+='<textarea id="export-full-textarea" name="export-full" readonly\n      style="width:100%;height:100px;font-size:9px;font-family:monospace;background:#111;color:#ccc;border:1px solid #444;border-radius:3px;padding:4px;resize:vertical;"></textarea>',t+="</div>",t+="</div>",t+=`<div class="msd-hud-section msd-hud-summary">\n      Export: ${e.hasExportMethods?"✅":"❌"} •\n      Diff: ${e.hasDiffMethod?"✅":"❌"} •\n      Handlers: ${e.globalHandlers?"✅":"❌"} •\n      Ready for config management\n    </div>`,t}}class oc{constructor(){this._listeners=new Map}on(e,t){return this._listeners.has(e)||this._listeners.set(e,new Set),this._listeners.get(e).add(t),()=>this.off(e,t)}once(e,t){const s=this.on(e,(e=>{s(),t(e)}))}off(e,t){this._listeners.get(e)?.delete(t)}emit(e,t){const s=this._listeners.get(e);s&&s.forEach((e=>{try{e(t)}catch(e){}}));const n=this._listeners.get("*");n&&n.forEach((s=>{try{s({event:e,payload:t})}catch(e){}}))}clear(){this._listeners.clear()}}class ac{constructor(e){this.bus=e,this.current=null}set(e,t,s={}){e&&t&&(this.current={type:e,id:t,meta:s,ts:Date.now()},this.bus?.emit("select:changed",this.current))}clear(){this.current=null,this.bus?.emit("select:changed",null)}get(){return this.current}}class lc{captureData(){const e=[],t={total:0,byType:{}};try{const s=window.__msdDebug?.pipelineInstance,n=s?.getResolvedModel?.();n?.overlays&&n.overlays.forEach((s=>{t.total++,t.byType[s.type]=(t.byType[s.type]||0)+1,e.push({id:s.id,type:s.type||"unknown",anchor:s.anchor,attach_to:s.attach_to,profileCount:Array.isArray(s._profiles)?s._profiles.length:0,patchCount:Array.isArray(s._patches)?s._patches.length:0,styleSourceCount:Array.isArray(s._styleSources)?s._styleSources.length:0,finalStyle:s.finalStyle||s.style||{},smooth:s.smooth,channel:s.channel,meta:{fromPacks:s.__meta?.origin_pack,overridden:!!s.__meta?.overridden}})}))}catch(e){console.warn("[OverlaysPanel] captureData failed:",e)}return{overlays:e,stats:t}}highlightOverlay(e){try{if(!e)return;const t=window.__msdDebug?.pipelineInstance?.mountElement||window.__msdDebug?.mountElement;if(!t)return void console.warn("[OverlaysPanel] No mountElement available for highlight");this._ensureHighlightStyles();const s=[t];t.shadowRoot&&s.push(t.shadowRoot);const n=[],r=`[data-overlay-id="${CSS.escape(e)}"]`,i=`#${CSS.escape(e)}`;if(s.forEach((e=>{e.querySelectorAll(r).forEach((e=>n.push(e)));const t=e.querySelector(i);t&&!n.includes(t)&&n.push(t)})),0===n.length)return console.warn("[OverlaysPanel] No nodes found for overlay",e),void this._toast(`Overlay not found: ${e}`,"#ff4444");n.forEach((e=>{this._applyElementHighlight(e,"#ff66ff"),e.tagName&&"g"===e.tagName.toLowerCase()&&e.querySelectorAll("path, line, polyline, polygon, rect, circle, ellipse").forEach((e=>{this._applyElementHighlight(e,"#ff66ff",!0)}))})),this._toast(`Overlay: ${e}`,"#ff66ff")}catch(e){console.warn("[OverlaysPanel] highlightOverlay failed:",e)}}_applyElementHighlight(e,t,s=!1){const n=(e.tagName||"").toLowerCase();["path","g","line","polyline","polygon","rect","circle","ellipse"].includes(n)||e instanceof SVGElement?(e.dataset._msdHl||(e.dataset._msdHl="1",e.dataset._msdPrevStroke=e.getAttribute("stroke")||e.style.stroke||"",e.dataset._msdPrevStrokeW=e.getAttribute("stroke-width")||e.style.strokeWidth||"",e.dataset._msdPrevFilter=e.style.filter||""),e.style.stroke=t,"g"!==n&&(e.style.strokeWidth="4"),e.style.filter="drop-shadow(0 0 6px "+t+")",e.classList.add("msd-overlay-highlighted"),setTimeout((()=>{void 0!==e.dataset._msdPrevStroke&&(e.dataset._msdPrevStroke?e.style.stroke=e.dataset._msdPrevStroke:e.style.removeProperty("stroke")),void 0!==e.dataset._msdPrevStrokeW&&(e.dataset._msdPrevStrokeW?e.style.strokeWidth=e.dataset._msdPrevStrokeW:e.style.removeProperty("stroke-width")),void 0!==e.dataset._msdPrevFilter&&(e.dataset._msdPrevFilter?e.style.filter=e.dataset._msdPrevFilter:e.style.removeProperty("filter")),e.classList.remove("msd-overlay-highlighted")}),3e3)):(e.dataset._msdHlBox||(e.dataset._msdHlBox="1",e.dataset._msdPrevOutline=e.style.outline||"",e.dataset._msdPrevBoxShadow=e.style.boxShadow||"",e.dataset._msdPrevFilter=e.style.filter||""),e.style.outline=`3px solid ${t}`,e.style.boxShadow=`0 0 10px ${t}`,e.style.filter=`drop-shadow(0 0 6px ${t})`,e.classList.add("msd-overlay-highlighted"),setTimeout((()=>{void 0!==e.dataset._msdPrevOutline&&(e.dataset._msdPrevOutline?e.style.outline=e.dataset._msdPrevOutline:e.style.removeProperty("outline")),void 0!==e.dataset._msdPrevBoxShadow&&(e.dataset._msdPrevBoxShadow?e.style.boxShadow=e.dataset._msdPrevBoxShadow:e.style.removeProperty("box-shadow")),void 0!==e.dataset._msdPrevFilter&&(e.dataset._msdPrevFilter?e.style.filter=e.dataset._msdPrevFilter:e.style.removeProperty("filter")),e.classList.remove("msd-overlay-highlighted")}),3e3))}_ensureHighlightStyles(){if(document.getElementById("msd-overlay-highlight-style"))return;const e=document.createElement("style");e.id="msd-overlay-highlight-style",e.textContent="\n      .msd-overlay-highlighted {\n        transition: outline .15s, box-shadow .15s;\n      }\n    ",document.head.appendChild(e)}analyzeOverlay(e){try{const t=window.__msdDebug?.pipelineInstance,s=t?.getResolvedModel?.(),n=s?.overlays?.find((t=>t.id===e));if(!n)return console.warn("[OverlaysPanel] analyzeOverlay: overlay not found",e),void this._toast("Overlay not found","#ff4444");console.group(`🛰 Overlay Analysis: ${e}`),console.table([{id:n.id,type:n.type,anchor:n.anchor,attach_to:n.attach_to,channel:n.channel,smooth:n.smooth,profiles:(n._profiles||[]).length,patches:(n._patches||[]).length,styleSources:(n._styleSources||[]).length}]),(n.finalStyle||n.style)&&console.log("Final Style:",n.finalStyle||n.style),n._styleSources&&console.log("Style Sources:",n._styleSources),n._patches&&console.log("Rule Patches:",n._patches),n.__meta&&console.log("Metadata:",n.__meta),console.groupEnd(),this._showOverlayPopup(n)}catch(e){console.warn("[OverlaysPanel] analyzeOverlay failed:",e)}}_showOverlayPopup(e){const t=document.getElementById("msd-overlay-popup");t&&t.remove();const s=document.createElement("div");s.id="msd-overlay-popup",s.style.cssText="\n      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);\n      background:rgba(0,0,0,0.95);color:#ff66ff;\n      border:2px solid #ff66ff;border-radius:8px;\n      padding:14px 16px;z-index:1000003;\n      font-family:monospace;font-size:12px;\n      max-width:480px;max-height:70vh;overflow:auto;\n      box-shadow:0 4px 18px rgba(255,102,255,0.4);\n    ";const n=(()=>{try{const t=JSON.stringify(e.finalStyle||e.style||{},null,2);return t.length>520?t.slice(0,517)+"...":t}catch{return"{}"}})(),r=(e._styleSources||[]).map((e=>`${e.kind}:${e.id}`)).join(", ")||"—",i=(e._patches||[]).map((e=>e.ruleId||e.id)).join(", ")||"—",o=(e._profiles||[]).map((e=>e.id||e)).join(", ")||"—";s.innerHTML=`\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">\n        <h3 style="margin:0;color:#ffaaee;">Overlay: ${e.id}</h3>\n        <button style="background:#331133;color:#fff;border:1px solid #553366;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:11px;"\n          onclick="document.getElementById('msd-overlay-popup')?.remove()">\n          Close\n        </button>\n      </div>\n      <div style="font-size:11px;line-height:1.4;color:#ddd;">\n        <strong>Type:</strong> ${e.type||"n/a"}<br>\n        <strong>Anchor:</strong> ${e.anchor||"—"} → <strong>Attach:</strong> ${e.attach_to||"—"}<br>\n        <strong>Channel:</strong> ${e.channel||"—"} • <strong>Smooth:</strong> ${e.smooth?"yes":"no"}<br>\n        <strong>Profiles:</strong> ${o}<br>\n        <strong>Sources:</strong> ${r}<br>\n        <strong>Patches:</strong> ${i}<br>\n        <strong>Meta:</strong> ${e.__meta?Object.keys(e.__meta).join(", "):"—"}\n      </div>\n      <div style="margin-top:8px;">\n        <div style="color:#ffaaee;font-size:11px;margin-bottom:4px;">Final Style</div>\n        <pre style="margin:0;background:#111;color:#ccc;padding:8px;border:1px solid #552255;border-radius:4px;font-size:10px;max-height:200px;overflow:auto;">${n}</pre>\n      </div>\n      <div style="margin-top:8px;text-align:right;">\n        <button\n          style="background:#552255;color:#fff;border:1px solid #aa55aa;border-radius:4px;padding:3px 10px;cursor:pointer;font-size:11px;"\n          onclick="navigator.clipboard.writeText(JSON.stringify(${JSON.stringify(e.finalStyle||e.style||{})},null,2))">\n          Copy Style\n        </button>\n        <button\n          style="background:#331133;color:#fff;border:1px solid #553366;border-radius:4px;padding:3px 10px;cursor:pointer;font-size:11px;margin-left:6px;"\n          onclick="document.getElementById('msd-overlay-popup')?.remove()">\n          Done\n        </button>\n      </div>\n    `,document.body.appendChild(s),setTimeout((()=>{s.parentElement&&(s.style.opacity="1")}),10),setTimeout((()=>s.parentElement&&s.remove()),25e3)}_ensureHighlightStyles(){if(document.getElementById("msd-overlay-highlight-style"))return;const e=document.createElement("style");e.id="msd-overlay-highlight-style",e.textContent="\n      .msd-overlay-highlighted {\n        transition: outline .15s, box-shadow .15s;\n      }\n    ",document.head.appendChild(e)}_findOverlayModel(e){try{const t=window.__msdDebug?.pipelineInstance?.getResolvedModel?.();return t?.overlays?.find((t=>t.id===e))}catch{return null}}_highlightBoundingBoxFromModel(e,t){try{const s=e.anchor,n=e.attach_to,r=window.__msdDebug?.pipelineInstance?.mountElement||window.__msdDebug?.mountElement||document,i=s?r.querySelector(`[data-anchor-id="${CSS.escape(s)}"],#${CSS.escape(s)}`):null,o=n?r.querySelector(`[data-anchor-id="${CSS.escape(n)}"],#${CSS.escape(n)}`):null;if(!i&&!o){const e=r.getBoundingClientRect();return void this._spawnBoundingBox(e,t,"#ff66ff")}const a=[];i&&a.push(i.getBoundingClientRect()),o&&a.push(o.getBoundingClientRect());const l=Math.min(...a.map((e=>e.left))),c=Math.min(...a.map((e=>e.top))),d=Math.max(...a.map((e=>e.right))),u=Math.max(...a.map((e=>e.bottom)));this._spawnBoundingBox({left:l,top:c,width:d-l,height:u-c},t,"#ff66ff")}catch(e){console.warn("[OverlaysPanel] _highlightBoundingBoxFromModel failed:",e)}}_spawnBoundingBox(e,t,s){if(!e)return;const n=document.createElement("div");n.className="msd-overlay-box-highlight",n.style.left=e.left+"px",n.style.top=e.top+"px",n.style.width=e.width+"px",n.style.height=e.height+"px",n.dataset.overlayBoxFor=t,document.body.appendChild(n),setTimeout((()=>n.remove()),3e3),this._toast(`Overlay (bbox): ${t}`,s)}_toast(e,t="#ff66ff"){const s=document.createElement("div");s.style.cssText=`\n      position:fixed;top:18px;right:18px;\n      background:#000;padding:4px 10px;\n      border:1px solid ${t};color:${t};\n      font:10px monospace;z-index:1000002;\n      border-radius:4px;opacity:.95;\n    `,s.textContent=e,document.body.appendChild(s),setTimeout((()=>s.remove()),1600)}renderHtml(e){const{overlays:t=[],stats:s={}}=e;let n='<div class="msd-hud-panel"><h3>Overlays</h3>';return n+="<style>\n      .msd-overlay-highlighted { outline:3px solid #ff66ff !important; }\n    </style>",n+='<div class="msd-hud-section"><h4>Stats</h4>',n+=`<div class="msd-hud-metric"><span class="msd-hud-metric-name">Total</span><span class="msd-hud-metric-value">${s.total||0}</span></div>`,Object.entries(s.byType||{}).slice(0,6).forEach((([e,t])=>{n+=`<div class="msd-hud-metric" style="font-size:10px;">\n        <span class="msd-hud-metric-name">${e}</span>\n        <span class="msd-hud-metric-value">${t}</span>\n      </div>`})),n+="</div>",t.length?(n+='<div class="msd-hud-section"><h4>Overlay List</h4>',t.slice(0,25).forEach((e=>{const t=e.id.length>22?e.id.slice(0,19)+"...":e.id,s=e.meta.overridden?" • mod":"",r=(()=>{try{const t=JSON.stringify(e.finalStyle);return t.length>50?t.slice(0,47)+"...":t}catch{return""}})();n+=`<div\n        data-select-type="overlay"\n        data-select-id="${e.id}"\n        style="cursor:pointer;border:1px solid #222;padding:4px;border-radius:4px;margin:4px 0;"\n        onclick="__msdHudBus('select:set',{type:'overlay',id:'${e.id}',source:'overlays'});__msdHudBus('overlay:highlight',{id:'${e.id}'})"\n      >\n        <div style="display:flex;justify-content:space-between;align-items:center;">\n          <span style="color:#aaa;">${t}${s}</span>\n          <span style="color:#ff66ff;font-size:11px;">${e.type}</span>\n        </div>\n        <div style="font-size:10px;color:#888;margin-top:2px;">\n          A:${e.anchor||"-"} → ${e.attach_to||"-"} ${e.channel?"• ch:"+e.channel:""} ${e.smooth?"• smooth":""}\n        </div>\n        <div style="font-size:9px;color:#666;margin-top:2px;">\n          src: p${e.profileCount} / s${e.styleSourceCount} / r${e.patchCount}\n        </div>\n        <div style="font-size:9px;color:#555;overflow:hidden;text-overflow:ellipsis;margin-top:2px;">\n          ${r}\n        </div>\n        <div style="margin-top:4px;text-align:right;">\n          <button\n            onclick="event.stopPropagation();__msdHudBus('overlay:highlight',{id:'${e.id}'});__msdHudBus('overlay:analyze',{id:'${e.id}'})"\n            style="font-size:9px;padding:2px 6px;background:#331133;color:#ffccff;border:1px solid #553355;border-radius:3px;cursor:pointer;">\n            Analyze\n          </button>\n        </div>\n      </div>`})),t.length>25&&(n+=`<div style="font-size:9px;opacity:.6;text-align:center;margin-top:4px;">... ${t.length-25} more</div>`),n+="</div></div>",n):(n+='<div class="msd-hud-section">No overlays</div></div>',n)}}console.log("[MsdHudManager] Importing ExportPanel class");class cc{constructor(){console.log("[MsdHudManager] Testing ExportPanel instantiation...");try{new ic,console.log("[MsdHudManager] ExportPanel test successful")}catch(e){console.error("[MsdHudManager] ExportPanel instantiation failed:",e)}this.bus=new oc,window.__msdHudBus=(e,t)=>this.bus.emit(e,t||{}),this.panels={issues:new sc,flags:new tc,performance:new Jl,export:new ic,rules:new rc,packs:new nc,overlays:new lc,routing:new Ql,channelTrend:new ec,dataSources:new Kl,validation:new Zl},console.log("[MsdHudManager] Created panels:",Object.keys(this.panels)),this.state={visible:!1,activePanel:"performance",refreshRate:2e3,lastRefresh:0,panelVisibility:{issues:!0,flags:!0,performance:!0,export:!0,rules:!0,packs:!0,overlays:!0,routing:!1,channelTrend:!1,dataSources:!1,validation:!1},panelOrder:["issues","flags","performance","export","rules","packs","overlays","routing","channelTrend","dataSources","validation"],compactMode:!1,autoPosition:!0,panelManagerOpen:!1,hudWidth:420,resizable:!1},console.log("[MsdHudManager] Initial panel order:",this.state.panelOrder),this.hudElement=null,this.refreshInterval=null,this.mountElement=null,this.dragState={isDragging:!1,startX:0,startY:0,startLeft:0,startTop:0},this._setupGlobalPanelControls(),this.keyboardEnabled=!0,this._setupKeyboardShortcuts(),Object.values(this.panels).forEach((e=>{e.bus=this.bus})),this._registerBusHandlers(),this.selection=new ac(this.bus),this._registerSelectionHandlers(),this.show=this.show.bind(this),this.hide=this.hide.bind(this),this.toggle=this.toggle.bind(this),this.refresh=this.refresh.bind(this),this.setRefreshRate=this.setRefreshRate.bind(this)}_setupGlobalPanelControls(){if(window.__msdHudPanelControls)return;const e=this;window.__msdHudPanelControls={togglePanel:function(t){e.state.panelVisibility[t]=!e.state.panelVisibility[t],e.updateHudContent()},setCompactMode:function(t){e.state.compactMode=t,e.updateHudContent()},setAutoPosition:function(t){e.state.autoPosition=t,t&&e._autoPositionHud()},resetPanelLayout:function(){Object.keys(e.state.panelVisibility).forEach((t=>{e.state.panelVisibility[t]=["issues","flags","performance","export"].includes(t)})),e.state.compactMode=!1,e.state.autoPosition=!0,e.updateHudContent(),e._autoPositionHud()},movePanel:function(t,s){const n=[...e.state.panelOrder],r=n.indexOf(t);if(-1===r)return;const i="up"===s?Math.max(0,r-1):Math.min(n.length-1,r+1);[n[r],n[i]]=[n[i],n[r]],e.state.panelOrder=n,e.updateHudContent()},togglePanelManager:function(){e.state.panelManagerOpen=!e.state.panelManagerOpen;const t=document.getElementById("msd-panel-manager");t&&(t.style.display=e.state.panelManagerOpen?"block":"none",e.state.panelManagerOpen&&setTimeout((()=>e._attachPanelManagerEventListeners()),10)),console.log("[MsdHudManager] Panel manager toggled:",e.state.panelManagerOpen)},closePanelManager:function(){e.state.panelManagerOpen=!1;const t=document.getElementById("msd-panel-manager");t&&(t.style.display="none"),console.log("[MsdHudManager] Panel manager closed")}}}_autoPositionHud(){if(!this.state.autoPosition||!this.hudElement)return;const e=window.innerWidth,t=window.innerHeight,s=this.state.hudWidth,n=Object.values(this.state.panelVisibility).filter(Boolean).length,r=Math.min(.9*t,200+n*(this.state.compactMode?80:140)),i=document.querySelector("app-header, ha-app-layout app-header"),o=document.querySelector("ha-sidebar, app-drawer-layout ha-sidebar"),a=i?i.offsetHeight:0,l=o&&!o.hasAttribute("collapsed")?o.offsetWidth:0;let c,d;c=e-s-20,l>0&&c<l+20&&(c=Math.max(l+20,e-s-20)),c<20&&(c=20),d=Math.max(a+20,20),d+r>t-20&&(d=Math.max(a+20,t-r-20)),this.hudElement.style.transition="all 0.3s ease",this.hudElement.style.left=c+"px",this.hudElement.style.top=d+"px",this.hudElement.style.right="auto",setTimeout((()=>{this.hudElement.style.transition=""}),300),console.log(`[MsdHudManager] Auto-positioned to (${c}, ${d}) avoiding header:${a}px sidebar:${l}px`)}_setupResizeHandler(){if(this._resizeSetup)return;let e;this._resizeSetup=!0,window.addEventListener("resize",(()=>{this.state.autoPosition&&this.state.visible&&(clearTimeout(e),e=setTimeout((()=>{this._autoPositionHud()}),250))}))}init(e){this.mountElement=e,window.__msdDebug&&(window.__msdDebug.mountElement=e),this._setupDebugStatusHelper(),console.log("[MsdHudManager] Initialized with pipeline mount element reference")}_setupDebugStatusHelper(){if(window.__msdDebug?.getDebugStatusSilent)return;const e="undefined"!=typeof window?window:{};e.__msdDebug=e.__msdDebug||{},e.__msdDebug.getDebugStatusSilent=function(){try{const t=e.__msdDebug?.pipelineInstance,s=t?.systemsManager?.debugManager;if(s?.getSnapshot)return s.getSnapshot();const n=e.__msdDebug?.debug;return n?._state?{...n._state}:{enabled:!1,initialized:!1}}catch(e){return{enabled:!1,initialized:!1,error:e.message}}}}_registerBusHandlers(){const{routing:e,performance:t,flags:s,export:n,dataSources:r,issues:i,overlays:o}=this.panels;this.bus.on("routing:highlight",(({id:t})=>e?.highlightRoute?.(t))),this.bus.on("routing:analyze",(({id:t})=>e?.analyzeRoute?.(t))),this.bus.on("routing:set-filter",(({key:t,value:s})=>e?.setFilter?.(t,s))),this.bus.on("routing:update-cost",(({key:t,value:s})=>e?.updateCostFilter?.(t,s))),this.bus.on("routing:finalize-cost",(()=>e?.finalizeCostFilter?.())),this.bus.on("routing:focus-set",(({field:t,focus:s})=>e?.setInputFocus?.(t,s))),this.bus.on("performance:clear-all",(()=>t?.clearAllTimers?.())),this.bus.on("performance:export",(()=>t?.exportData?.())),this.bus.on("performance:reset-timer",(({timer:e})=>t?.resetTimer?.(e))),this.bus.on("performance:set-threshold",(({timer:e,value:s})=>t?.setThreshold?.(e,s))),this.bus.on("flags:toggle",(({feature:e})=>s?.toggleFeature?.(e))),this.bus.on("flags:scale-adjust",(({dir:e})=>s?.adjustScale?.(e))),this.bus.on("flags:scale-set",(({scale:e})=>s?.setScale?.(e))),this.bus.on("flags:refresh",(()=>s?.refreshDebug?.())),this.bus.on("export:collapsed",(()=>n?.exportCollapsed?.())),this.bus.on("export:full",(()=>n?.exportFull?.(!1))),this.bus.on("export:full-meta",(()=>n?.exportFull?.(!0))),this.bus.on("export:copy",(({type:e})=>n?.copyToClipboard?.(e))),this.bus.on("export:clear",(({type:e})=>n?.clearTextarea?.(e))),this.bus.on("datasource:inspect",(({id:e})=>r?.inspectEntity?.(e))),this.bus.on("datasource:refresh-subs",(()=>r?.refreshSubscriptions?.())),this.bus.on("datasource:clear-history",(()=>r?.clearHistory?.())),this.bus.on("issues:action",(({action:e,id:t,overlay:s})=>i?.handleIssueClick?.(e,t,s))),this.bus.on("overlay:highlight",(({id:e})=>o?.highlightOverlay?.(e))),this.bus.on("overlay:analyze",(({id:e})=>o?.analyzeOverlay?.(e))),this.bus.on("hud:refresh",(()=>this.refresh()))}_registerSelectionHandlers(){this.bus.on("select:set",(({type:e,id:t,source:s})=>{this.selection.set(e,t,{source:s}),"route"===e?this.bus.emit("routing:highlight",{id:t}):"overlay"===e&&this.bus.emit("overlay:highlight",{id:t}),this.refresh()})),this.bus.on("select:clear",(()=>{this.selection.clear(),this.refresh()})),this.bus.on("select:changed",(()=>{this._applySelectionHighlight(),this._updateSelectionBadge()}))}_applySelectionHighlight(){if(!this.hudElement)return;const e=this.selection.get();this.hudElement.querySelectorAll(".msd-selected").forEach((e=>e.classList.remove("msd-selected"))),e&&this.hudElement.querySelectorAll(`[data-select-type="${e.type}"][data-select-id="${CSS.escape(e.id)}"]`).forEach((e=>e.classList.add("msd-selected")))}_updateSelectionBadge(){if(!this.hudElement)return;const e=this.hudElement.querySelector("#msd-selection-badge");if(!e)return;const t=this.selection.get();e.innerHTML=t?`\n      <span style="background:#222;border:1px solid #444;padding:2px 6px;border-radius:4px;font-size:10px;display:inline-flex;gap:6px;align-items:center;">\n        <span style="color:#ffaa00;">${t.type}</span>\n        <span style="color:#00ffff;max-width:160px;overflow:hidden;text-overflow:ellipsis;">${t.id}</span>\n        <button data-bus-event="select:clear"\n          onclick="__msdHudBus('select:clear')"\n          style="background:#333;color:#ccc;border:1px solid #555;border-radius:3px;font-size:9px;cursor:pointer;padding:0 4px;">\n          ✕\n        </button>\n      </span>\n    `:""}togglePanelCollapse(e){this.state.collapsedPanels[e]=!this.state.collapsedPanels[e],this._applyCollapseState()}toggleFocusPanel(e){this.state.focusPanel===e?this.state.focusPanel=null:this.state.focusPanel=e,this.updateHudContent()}_applyCollapseState(){this.hudElement&&(this.hudElement.querySelectorAll(".msd-hud-panel[data-panel]").forEach((e=>{const t=e.getAttribute("data-panel"),s=this.state.collapsedPanels[t];s?e.classList.add("collapsed"):e.classList.remove("collapsed");const n=e.querySelector(":scope h3"),r=n?.querySelector(".msd-collapse-indicator");if(r&&(r.textContent=s?"+":"−"),this.state.focusPanel&&this.state.focusPanel!==t?e.classList.add("focus-hidden"):e.classList.remove("focus-hidden"),this.state.filterTerm){const s=this.state.filterTerm.toLowerCase();t.toLowerCase().includes(s)?e.classList.remove("filter-hidden"):e.classList.add("filter-hidden")}else e.classList.remove("filter-hidden")})),this._updateFocusBadgeInFooter())}_decoratePanelHeaders(){this.hudElement&&(this.hudElement.querySelectorAll(".msd-hud-panel[data-panel]").forEach((e=>{const t=e.getAttribute("data-panel"),s=e.querySelector(":scope h3");if(!s||"1"===s.dataset.enhanced)return;s.dataset.enhanced="1",s.style.cursor="pointer";const n=document.createElement("span");n.className="msd-collapse-indicator",n.style.cssText="margin-left:6px;font-weight:bold;color:#ffaa00;",n.textContent=this.state.collapsedPanels[t]?"+":"−",s.appendChild(n),s.title="Click: Collapse/Expand • Alt+Click: Focus panel",s.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),e.altKey?this.toggleFocusPanel(t):this.togglePanelCollapse(t)}))})),this._applyCollapseState())}_updateFocusBadgeInFooter(){if(!this.hudElement)return;const e=this.hudElement.querySelector("#msd-focus-footer");e&&(this.state.focusPanel?e.innerHTML=`\n      <span style="background:#222;border:1px solid #444;padding:2px 6px;border-radius:4px;font-size:9px;">\n        Focus: <strong style="color:#ffaa00;">${this.state.focusPanel}</strong>\n        <button style="margin-left:6px;font-size:9px;background:#333;color:#ccc;border:1px solid #555;border-radius:3px;cursor:pointer;padding:0 4px;"\n          onclick="__msdHudBus && window.__msdDebug?.hud?.manager?.toggleFocusPanel && window.__msdDebug.hud.manager.toggleFocusPanel('${this.state.focusPanel}')">\n          Exit\n        </button>\n      </span>\n    `:e.innerHTML="")}setFilterTerm(e){this.state.filterTerm=e||"",this._applyCollapseState()}createHudElement(){this.hudElement||(this.hudElement=document.createElement("div"),this.hudElement.id="msd-debug-hud",this.hudElement.style.cssText=`\n      position: fixed;\n      top: 10px;\n      right: 10px;\n      width: ${this.state.hudWidth}px;\n      max-height: 90vh;\n      background: rgba(0, 0, 0, 0.95);\n      border: 2px solid #00ffff;\n      border-radius: 8px;\n      color: #00ffff;\n      font-family: monospace;\n      font-size: 12px;\n      z-index: 1000000;\n      overflow-y: auto;\n      backdrop-filter: blur(10px);\n      box-shadow: 0 4px 20px rgba(0, 255, 255, 0.3);\n      cursor: move;\n      user-select: none;\n      ${this.state.resizable?"resize: horizontal; min-width: 300px; max-width: 600px;":""}\n    `,this.setupDragging(),document.body.appendChild(this.hudElement),this.updateHudContent(),this._attachDelegatedEvents())}_attachDelegatedEvents(){!this._delegatedEventsAttached&&this.hudElement&&(this._delegatedEventsAttached=!0,["click","change","input","blur","focus"].forEach((e=>{this.hudElement.addEventListener(e,(t=>{const s=t.target.closest("[data-bus-event]");if(!s||!this.hudElement.contains(s))return;const{busEvent:n,...r}=Object.fromEntries(Object.entries(s.dataset).map((([e,t])=>[e.replace(/-[a-z]/g,(e=>e[1].toUpperCase())),t])));Object.keys(r).forEach((e=>{/^-?\d+(\.\d+)?$/.test(r[e])&&(r[e]=Number(r[e]))})),this.bus.emit(s.dataset.busEvent,r),"click"===e&&t.preventDefault()}),!0)})),this.hudElement.addEventListener("input",(e=>{const t=e.target;t&&"msd-hud-filter"===t.id&&this.setFilterTerm(t.value)}),!0))}updateHudContent(){if(!this.hudElement)return;if(this.panels.routing?.shouldSkipRefresh?.())return;const e=this.state.panelManagerOpen,t={};Object.entries(this.panels).forEach((([e,s])=>{try{s.captureData&&(t[e]=s.captureData())}catch(s){console.warn(`[MsdHudManager] Panel ${e} data capture failed:`,s),t[e]={error:s.message}}})),this.state.lastRefresh=Date.now();try{const s=this.renderHudHtml(t);this.hudElement.innerHTML=s,this.state.compactMode?this.hudElement.classList.add("msd-hud-compact"):this.hudElement.classList.remove("msd-hud-compact"),this._attachPanelManagerEventListeners(),this._updateSelectionBadge(),this._applySelectionHighlight();const n=this.hudElement.querySelector("#msd-hud-filter");if(n&&n.value!==this.state.filterTerm&&(n.value=this.state.filterTerm),e){this.state.panelManagerOpen=!0;const e=document.getElementById("msd-panel-manager");e&&(e.style.display="block")}}catch(e){console.error("[MsdHudManager] HUD render failed:",e),this.hudElement.innerHTML=`\n        <div class="msd-hud-header">\n          <span class="msd-hud-title">MSD Debug HUD - Error</span>\n          <span class="msd-hud-close" onclick="window.__msdDebug?.hud?.hide?.()" title="Close">✕</span>\n        </div>\n        <div style="padding:8px;color:#ff6666;">\n          Render failed: ${e.message}\n        </div>\n      `}}renderHudHtml(e){this.state.compactMode;let t=`\n      <style>\n        #msd-debug-hud .msd-hud-header {\n          padding: 8px;\n          background: rgba(0,255,255,0.2);\n          border-bottom: 1px solid #00ffff;\n          display:flex;\n          justify-content:space-between;\n          align-items:center;\n          cursor:grab;\n        }\n        #msd-debug-hud .msd-hud-title { font-weight:bold; pointer-events:none; }\n        #msd-debug-hud .msd-hud-controls { font-size:10px; display:flex; gap:4px; }\n        #msd-debug-hud .msd-hud-close, #msd-debug-hud .msd-hud-refresh, #msd-debug-hud .msd-hud-menu {\n          cursor:pointer; padding:2px 6px; border-radius:3px;\n        }\n        #msd-debug-hud .msd-hud-close { background:rgba(255,0,0,0.7); }\n        #msd-debug-hud .msd-hud-refresh { background:rgba(0,255,0,0.7); }\n        #msd-debug-hud .msd-hud-menu { background:rgba(255,170,0,0.7); }\n        #msd-debug-hud .msd-hud-panel { padding:${this.state.compactMode?"4px":"8px"}; border-bottom:1px solid rgba(0,255,255,0.3); }\n        #msd-debug-hud .msd-hud-panel.hidden { display:none; }\n        #msd-debug-hud .msd-hud-panel h3 {\n          margin:0 0 ${this.state.compactMode?"4px":"8px"} 0;\n          color:#ffaa00; font-size:${this.state.compactMode?"12px":"14px"};\n        }\n        #msd-debug-hud .msd-hud-section h4 { margin:6px 0 4px 0; color:#fff; font-size:12px; }\n        #msd-debug-hud .msd-hud-metric { display:flex; justify-content:space-between; margin:2px 0; font-size:11px; }\n        #msd-debug-hud .msd-hud-metric-name { color:#aaa; }\n        #msd-debug-hud .msd-hud-metric-value { color:#0ff; font-weight:bold; }\n        #msd-debug-hud .msd-hud-error { border-left:3px solid #ff0000; padding-left:6px; }\n        #msd-debug-hud .msd-hud-warning { border-left:3px solid #ffaa00; padding-left:6px; }\n        #msd-debug-hud .msd-hud-success { color:#00ff00; font-size:11px; text-align:center; padding:4px; }\n        #msd-debug-hud .msd-hud-summary { text-align:center; font-size:11px; padding:4px; background:rgba(255,170,0,0.2); }\n        #msd-debug-hud .msd-selected { outline:2px solid #ffaa00; background:rgba(255,170,0,0.12)!important; position:relative; }\n        #msd-debug-hud .msd-selected::after { content:'●'; position:absolute; top:2px; right:4px; font-size:8px; color:#ffaa00; }\n        #msd-debug-hud .msd-panel-controls {\n          padding:6px 8px;\n          background:rgba(0,0,0,0.35);\n          border-bottom:1px solid rgba(0,255,255,0.25);\n          font-size:10px;\n        }\n        #msd-debug-hud .msd-panel-controls h4 {\n          margin:4px 0 6px;\n          font-size:11px;\n          color:#ffaa00;\n        }\n        #msd-debug-hud .msd-panel-toggle-buttons {\n          display:flex;\n          flex-wrap:wrap;\n          gap:6px;\n          margin:4px 0 8px;\n        }\n        #msd-debug-hud .msd-panel-toggle-btn {\n          cursor:pointer;\n          padding:3px 8px;\n          font-size:10px;\n          border:1px solid #044;\n          background:linear-gradient(#022,#011);\n          color:#0ff;\n          border-radius:14px;\n          line-height:1;\n          letter-spacing:.5px;\n          transition:all .18s;\n          position:relative;\n        }\n        #msd-debug-hud .msd-panel-toggle-btn.active {\n          background:linear-gradient(#0ff,#066);\n          color:#000;\n          font-weight:bold;\n          box-shadow:0 0 6px #0ff;\n          border-color:#0aa;\n        }\n        #msd-debug-hud .msd-panel-toggle-btn.inactive {\n          opacity:.45;\n        }\n        #msd-debug-hud .msd-panel-toggle-btn:not(.active):hover {\n          opacity:.8;\n          border-color:#088;\n        }\n        #msd-debug-hud .msd-panel-toggle-btn:focus {\n          outline:1px solid #0ff;\n        }\n        #msd-debug-hud .msd-panel-controls .msd-panel-meta {\n          font-size:9px;\n          opacity:.65;\n          margin-top:2px;\n        }\n      </style>\n    `;t+='\n      <div class="msd-hud-header">\n        <span class="msd-hud-title">MSD v1 Debug HUD</span>\n        <div id="msd-selection-badge" style="flex:1;display:flex;justify-content:center;"></div>\n        <div class="msd-hud-controls">\n          <span class="msd-hud-menu" onclick="window.__msdHudPanelControls?.togglePanelManager?.()" title="Panel Settings">⚙</span>\n          <span class="msd-hud-refresh" onclick="window.__msdDebug?.hud?.refresh?.()" title="Refresh">⟳</span>\n          <span class="msd-hud-close" onclick="window.__msdDebug?.hud?.hide?.()" title="Close">✕</span>\n        </div>\n      </div>\n    ',t+=this._renderPanelControls();let s=0,n=0;this.state.panelOrder.forEach((r=>{const i=this.panels[r];if(!i)return void console.warn(`[MsdHudManager] Panel '${r}' not found in panels object`);const o=this.state.panelVisibility[r],a=o?"":"hidden";o&&n++;try{const n=e[r]||{},o=i.renderHtml(n);t+=`<div class="msd-hud-panel ${a}" data-panel="${r}">\n          ${o}\n        </div>`,s++}catch(e){console.error(`[MsdHudManager] Panel ${r} render failed:`,e),t+=`<div class="msd-hud-panel ${a}" data-panel="${r}">\n          <h3>${r} (Error)</h3>\n          <div class="msd-hud-section">Panel render failed: ${e.message}</div>\n        </div>`,s++}}));const r=Math.round((Date.now()-this.state.lastRefresh)/1e3);return t+=`<div style="padding: 4px; font-size: 10px; text-align: center; color: #666;">\n      ${n}/${s} panels visible • Updated ${r}s ago • ${this.state.refreshRate/1e3}s\n      <div style="font-size: 9px; margin-top: 2px; opacity: 0.7;">\n        Shortcuts: Ctrl+H toggle • Ctrl+R refresh • Ctrl+P panels • Ctrl+K compact • 1-9 toggle panels\n      </div>\n      <div style="font-size: 8px; margin-top: 1px; opacity: 0.5;">\n        Panels: [${this.state.panelOrder.join(", ")}] | Available: [${Object.keys(this.panels).join(", ")}]\n      </div>\n    </div>`,t}startRefresh(){this.stopRefresh(),this.state.refreshRate>0&&(this.refreshInterval=setInterval((()=>{this.state.visible&&this.updateHudContent()}),this.state.refreshRate))}stopRefresh(){this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null)}toggle(){this&&this.state&&(this.state.visible?"function"==typeof this.hide&&this.hide():"function"==typeof this.show&&this.show())}setRefreshRate(e){const t=parseInt(e);isNaN(t)||t<0||(this.state.refreshRate=t,this.state.visible&&this.startRefresh())}setupDragging(){const e=e=>{if(!this.dragState.isDragging)return;const t=e.clientX-this.dragState.startX,s=e.clientY-this.dragState.startY;let n=this.dragState.startLeft+t,r=this.dragState.startTop+s;const i=this.hudElement.getBoundingClientRect();n=Math.max(0,Math.min(window.innerWidth-i.width,n)),r=Math.max(0,Math.min(window.innerHeight-i.height,r)),this.hudElement.style.left=n+"px",this.hudElement.style.top=r+"px",this.hudElement.style.right="auto"},t=()=>{this.dragState.isDragging=!1,this.hudElement.style.cursor="move",document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)};this.hudElement.addEventListener("mousedown",(s=>{s.preventDefault(),this.dragState.isDragging=!0,this.dragState.startX=s.clientX,this.dragState.startY=s.clientY;const n=this.hudElement.getBoundingClientRect();this.dragState.startLeft=n.left,this.dragState.startTop=n.top,this.hudElement.style.cursor="grabbing",document.addEventListener("mousemove",e),document.addEventListener("mouseup",t)}))}refresh(){this.state.visible&&this.hudElement&&(this.updateHudContent(),console.log("[MsdHudManager] Manual refresh triggered"))}_renderPanelControls(){let e=`<div class="msd-panel-controls" id="msd-panel-manager" style="display:${this.state.panelManagerOpen?"block":"none"};">\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">\n        <strong style="letter-spacing:.5px;">Panel Settings</strong>\n        <div style="display:flex;gap:4px;">\n          <button data-action="compact"\n            style="font-size:9px;padding:2px 6px;background:${this.state.compactMode?"#ffaa00":"#222"};color:${this.state.compactMode?"#000":"#ccc"};border:1px solid #555;border-radius:4px;cursor:pointer;">\n            Compact\n          </button>\n          <button data-action="reset"\n            style="font-size:9px;padding:2px 6px;background:#333;color:#ccc;border:1px solid #555;border-radius:4px;cursor:pointer;">\n            Reset\n          </button>\n          <button data-action="close"\n            style="font-size:9px;padding:2px 6px;background:#ff4444;color:#fff;border:1px solid #a00;border-radius:4px;cursor:pointer;">\n            ✕\n          </button>\n        </div>\n      </div>\n      <div class="msd-panel-toggle-buttons">`;return this.state.panelOrder.forEach((t=>{const s=!!this.state.panelVisibility[t];e+=`<button\n        class="msd-panel-toggle-btn ${s?"active":"inactive"}"\n        data-panel-toggle="${t}"\n        aria-pressed="${s}"\n        title="Toggle ${t} panel">\n        ${t}\n      </button>`})),e+=`</div>\n      <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">\n        <label style="font-size:9px;opacity:.75;">Refresh:</label>\n        <select id="msd-hud-refresh-rate" name="refresh-rate" data-action="refresh-rate"\n          style="font-size:9px;background:#111;color:#0ff;border:1px solid #044;padding:2px 4px;border-radius:4px;">\n          <option value="1000" ${1e3===this.state.refreshRate?"selected":""}>1s</option>\n          <option value="2000" ${2e3===this.state.refreshRate?"selected":""}>2s</option>\n          <option value="5000" ${5e3===this.state.refreshRate?"selected":""}>5s</option>\n          <option value="10000" ${1e4===this.state.refreshRate?"selected":""}>10s</option>\n        </select>\n        <div style="margin-left:auto;display:flex;gap:4px;">\n          <button data-action="width-down" title="Narrower"\n            style="font-size:9px;padding:2px 6px;background:#222;color:#0ff;border:1px solid #044;border-radius:4px;cursor:pointer;">◀</button>\n          <button data-action="width-up" title="Wider"\n            style="font-size:9px;padding:2px 6px;background:#222;color:#0ff;border:1px solid #044;border-radius:4px;cursor:pointer;">▶</button>\n        </div>\n      </div>\n      <div class="msd-panel-meta">\n        Click buttons to toggle panels • Order: ${this.state.panelOrder.join(", ")}\n      </div>\n    </div>`,e}_attachPanelManagerEventListeners(){try{const e=document.getElementById("msd-panel-manager");if(!e)return;const t=e.querySelector('[data-action="compact"]');t&&(t.onclick=e=>{e.preventDefault(),e.stopPropagation(),window.__msdHudPanelControls?.setCompactMode(!this.state.compactMode)});const s=e.querySelector('[data-action="reset"]');s&&(s.onclick=e=>{e.preventDefault(),e.stopPropagation(),window.__msdHudPanelControls?.resetPanelLayout()});const n=e.querySelector('[data-action="close"]');n&&(n.onclick=e=>{e.preventDefault(),e.stopPropagation(),window.__msdHudPanelControls?.closePanelManager()}),e.querySelectorAll("[data-panel-toggle]").forEach((e=>{const t=e.getAttribute("data-panel-toggle");t&&(e.onclick=e=>{e.preventDefault(),e.stopPropagation(),window.__msdHudPanelControls?.togglePanel(t)})}));const r=e.querySelector('[data-action="refresh-rate"]');r&&(r.onchange=e=>{e.preventDefault(),e.stopPropagation(),window.__msdDebug?.hud?.setRefreshRate?.(parseInt(r.value))});const i=e.querySelector('[data-action="width-down"]');i&&(i.onclick=e=>{e.preventDefault(),e.stopPropagation(),this.adjustWidth(-20)});const o=e.querySelector('[data-action="width-up"]');o&&(o.onclick=e=>{e.preventDefault(),e.stopPropagation(),this.adjustWidth(20)})}catch(e){console.warn("[MsdHudManager] Failed to attach panel manager event listeners:",e)}}adjustWidth(e){const t=Math.max(300,Math.min(600,this.state.hudWidth+e));t!==this.state.hudWidth&&(this.state.hudWidth=t,this.hudElement&&(this.hudElement.style.width=t+"px"),console.log(`[MsdHudManager] HUD width adjusted to ${t}px`),setTimeout((()=>this.updateHudContent()),100))}_setupKeyboardShortcuts(){if(this._keyboardSetup)return;this._keyboardSetup=!0;const e=this;document.addEventListener("keydown",(t=>{if(e.keyboardEnabled&&e.state.visible&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName){if(t.ctrlKey||t.metaKey)switch(t.key.toLowerCase()){case"h":t.preventDefault(),e.toggle();break;case"r":e.state.visible&&(t.preventDefault(),e.refresh());break;case"p":e.state.visible&&(t.preventDefault(),window.__msdHudPanelControls?.togglePanelManager?.());break;case"k":e.state.visible&&(t.preventDefault(),e.state.compactMode=!e.state.compactMode,e.updateHudContent())}if(e.state.visible&&!t.ctrlKey&&!t.metaKey){const s=parseInt(t.key);if(s>=1&&s<=9){const n=e.state.panelOrder[s-1];n&&(t.preventDefault(),window.__msdHudPanelControls?.togglePanel(n))}}}})),document.addEventListener("keydown",(t=>{t.ctrlKey&&t.shiftKey&&"h"===t.key.toLowerCase()&&(t.preventDefault(),e.toggle())}))}show(){this.state.visible||(this.state.visible=!0,this.createHudElement(),this.startRefresh(),this._setupResizeHandler(),window.__msdDebug&&(window.__msdDebug.hud={manager:this,refresh:()=>this.refresh(),hide:()=>this.hide(),show:()=>this.show(),toggle:()=>this.toggle(),setRefreshRate:e=>this.setRefreshRate(e),bus:this.bus}),this.state.autoPosition&&setTimeout((()=>this._autoPositionHud()),100),console.log("[MsdHudManager] HUD activated and exposed globally"))}hide(){this.state.visible&&(this.state.visible=!1,this.stopRefresh(),this.hudElement&&(this.hudElement.remove(),this.hudElement=null),console.log("[MsdHudManager] HUD deactivated"))}}class dc{constructor(e=100){if(e<1)throw new Error("RollingBuffer capacity must be at least 1");this.capacity=Math.min(e,1e3),this._timestamps=new Array(e),this._values=new Array(e),this._head=0,this._size=0,this._full=!1,this._stats={pushes:0,overwrites:0,queries:0},this._lastPushTime=0,this._coalescingThresholdMs=10}push(e,t){const s=Date.now();if((e<s-31536e6||e>s+36e5)&&console.warn(`[RollingBuffer] Suspicious timestamp: ${e} (${new Date(e).toISOString()}), current: ${s} (${new Date(s).toISOString()})`),!Number.isFinite(e)||e<0)console.warn("[RollingBuffer] Invalid timestamp:",e);else if("number"==typeof t&&isFinite(t)){if(this._size>0&&s-this._lastPushTime<this._coalescingThresholdMs){const n=0===this._head?this.capacity-1:this._head-1,r=this._timestamps[n];if(Math.abs(e-r)<1e3)return this._values[n]=t,this._stats.overwrites++,void(this._lastPushTime=s)}this._timestamps[this._head]=e,this._values[this._head]=t,this._stats.pushes++,this._full&&this._stats.overwrites++,this._head=(this._head+1)%this.capacity,this._size<this.capacity?this._size++:this._full=!0,this._lastPushTime=s,console.log(`[RollingBuffer] Added point: ${t} at ${new Date(e).toISOString()} (buffer size: ${this._size})`)}else console.warn(`[RollingBuffer] Invalid value: ${t} for timestamp ${e}`)}getArrays(){if(this._stats.queries++,0===this._size)return{t:[],v:[]};const e=new Array(this._size),t=new Array(this._size),s=this._full?this._head:0;for(let n=0;n<this._size;n++){const r=(s+n)%this.capacity;e[n]=this._timestamps[r],t[n]=this._values[r]}return{t:e,v:t}}getAll(){if(this._stats.queries++,0===this._size)return[];const e=new Array(this._size),t=this._full?this._head:0;for(let s=0;s<this._size;s++){const n=(t+s)%this.capacity;e[s]={t:this._timestamps[n],v:this._values[n]}}return e}sliceSince(e){if(this._stats.queries++,0===this._size||!Number.isFinite(e)||e<=0)return{t:[],v:[]};const t=Date.now()-e,{t:s,v:n}=this.getArrays();let r=0;for(let e=0;e<s.length;e++)if(s[e]>=t){r=e;break}return{t:s.slice(r),v:n.slice(r)}}last(){if(0===this._size)return null;const e=0===this._head?this.capacity-1:this._head-1;return{t:this._timestamps[e],v:this._values[e]}}first(){if(0===this._size)return null;const e=this._full?this._head:0;return{t:this._timestamps[e],v:this._values[e]}}clear(){this._head=0,this._size=0,this._full=!1}getStats(){return{capacity:this.capacity,size:this._size,utilization:this._size/this.capacity,pushes:this._stats.pushes,overwrites:this._stats.overwrites,queries:this._stats.queries,overwriteRate:this._stats.pushes>0?this._stats.overwrites/this._stats.pushes:0}}isFull(){return this._full}size(){return this._size}_validateConsistency(){const e=[];if((this._size<0||this._size>this.capacity)&&e.push(`Invalid size: ${this._size} (capacity: ${this.capacity})`),(this._head<0||this._head>=this.capacity)&&e.push(`Invalid head: ${this._head} (capacity: ${this.capacity})`),this._full&&this._size!==this.capacity&&e.push(`Full flag inconsistent: full=${this._full}, size=${this._size}, capacity=${this.capacity}`),this._size>1){const{t}=this.getArrays();for(let s=1;s<t.length;s++)if(t[s]<t[s-1]){e.push(`Timestamp ordering violation at index ${s}: ${t[s-1]} -> ${t[s]}`);break}}return!(e.length>0&&(console.warn("[RollingBuffer] Consistency issues:",e),1))}}const uc="undefined"==typeof window,hc=uc?e=>setTimeout(e,16):window.requestAnimationFrame,pc=uc?e=>clearTimeout(e):window.cancelAnimationFrame;class gc{constructor(e,t){this.cfg={...e},this.hass=t,this.cfg.entity||(console.warn("[MsdDataSource] No entity specified in config"),this.cfg.entity="");let s=60;if("number"==typeof e.windowSeconds&&isFinite(e.windowSeconds))s=Math.max(1,e.windowSeconds);else if("string"==typeof e.windowSeconds){const t=this._parseTimeWindowMs(e.windowSeconds);Number.isFinite(t)&&(s=Math.max(1,Math.floor(t/1e3)))}const n=Math.max(60,Math.floor(10*s));this.buffer=new dc(n);const r=Number.isFinite(e.minEmitMs)?e.minEmitMs:Number.isFinite(e.sampleMs)?e.sampleMs:100;this.minEmitMs=Math.max(10,r),this.coalesceMs=Number.isFinite(e.coalesceMs)?Math.max(20,e.coalesceMs):Math.max(20,Math.round(.4*this.minEmitMs)),this.maxDelayMs=Number.isFinite(e.maxDelayMs)?Math.max(this.minEmitMs,e.maxDelayMs):Math.max(this.minEmitMs,3*this.coalesceMs),this.emitOnSameValue=!1!==e.emitOnSameValue,this.subscribers=new Set,this.haUnsubscribe=null,this._lastEmitTime=0,this._lastEmittedValue=null,this._pendingRaf=0,this._pending=!1,this._pendingFirstTs=0,this._pendingCount=0,this._stats={emits:0,coalesced:0,skipsSameValue:0,received:0,invalid:0,historyLoaded:0},this._started=!1,this._destroyed=!1}async _preloadHistory(){if(!this.hass?.callService||!this.cfg.entity)return;const e=this.cfg.history||{};if(!1===e.enabled)return;const t=Math.max(1,Math.min(168,e.hours||6)),s=new Date,n=new Date(s.getTime()-36e5*t);console.log(`[MsdDataSource] 📊 Preloading ${t}h history for ${this.cfg.entity}`);try{await this._preloadWithHistoryService(n,s)}catch(e){console.warn(`[MsdDataSource] History service failed for ${this.cfg.entity}, trying statistics:`,e.message);try{await this._preloadWithStatistics(n,s)}catch(e){console.warn("[MsdDataSource] Statistics failed, trying state history:",e.message),await this._preloadStateHistory(n,s)}}console.log(`[MsdDataSource] History preload complete: ${this._stats.historyLoaded} points loaded`)}async _preloadWithHistoryService(e,t){const s=await this.hass.callService("history","get_history",{entity_ids:[this.cfg.entity],start_time:e.toISOString(),end_time:t.toISOString()});if(s&&s[0]){const e=s[0];console.log(`[MsdDataSource] History service returned ${e.length} states for ${this.cfg.entity}`);for(const t of e){const e=new Date(t.last_changed||t.last_updated).getTime(),s=this.cfg.attribute?t.attributes?.[this.cfg.attribute]:t.state,n=this._toNumber(s);null!==n&&(this.buffer.push(e,n),this._stats.historyLoaded++)}}}async _preloadWithStatistics(e,t){const s=await this.hass.callService("recorder","get_statistics",{statistic_ids:[this.cfg.entity],start_time:e.toISOString(),end_time:t.toISOString(),period:"5minute"});if(s&&s[0]?.statistics){const e=s[0].statistics;console.log(`[MsdDataSource] Statistics returned ${e.length} points for ${this.cfg.entity}`);for(const t of e){const e=new Date(t.start).getTime(),s=this._extractStatisticValue(t);null!==s&&(this.buffer.push(e,s),this._stats.historyLoaded++)}}}async start(){if(!this._started&&!this._destroyed)try{if(console.log(`[MsdDataSource] 🚀 Starting initialization for ${this.cfg.entity}`),this.hass?.callService&&await this._preloadHistory(),this.hass.states&&this.hass.states[this.cfg.entity]){const e=this.hass.states[this.cfg.entity];console.log(`[MsdDataSource] 🔄 Loading initial state for ${this.cfg.entity}:`,e.state);const t=Date.now(),s=this.cfg.attribute?e.attributes?.[this.cfg.attribute]:e.state,n=this._toNumber(s);null!==n&&(console.log(`[MsdDataSource] Adding current state: ${n} at ${t}`),this.buffer.push(t,n),this._stats.currentValue=n)}this.haUnsubscribe=await this.hass.connection.subscribeEvents((e=>{"state_changed"===e.event_type&&e.data?.entity_id===this.cfg.entity&&(console.log(`[MsdDataSource] 📊 HA event received for ${this.cfg.entity}:`,e.data.new_state?.state),this._handleStateChange(e.data))}),"state_changed"),this._started=!0,console.log(`[MsdDataSource] ✅ Full initialization complete for ${this.cfg.entity} - Buffer: ${this.buffer.size()} points`),this._emitInitialData()}catch(e){throw console.error(`[MsdDataSource] ❌ Failed to initialize ${this.cfg.entity}:`,e),e}}_emitInitialData(){if(this.subscribers.size>0){const e=this.buffer.last();if(e){console.log(`[MsdDataSource] 📤 Emitting initial data for ${this.cfg.entity} to ${this.subscribers.size} subscribers`);const t={t:e.t,v:e.v,buffer:this.buffer,stats:{...this._stats},entity:this.cfg.entity,historyReady:this._stats.historyLoaded>0};this.subscribers.forEach((e=>{try{e(t)}catch(e){console.error(`[MsdDataSource] Initial callback error for ${this.cfg.entity}:`,e)}}))}}}async _preloadHistory(){if(!this.hass?.connection||!this.cfg.entity)return void console.warn("[MsdDataSource] No HASS connection or entity for history preload");const e=Math.max(1,Math.min(168,this.cfg.history?.hours||6)),t=new Date,s=new Date(t.getTime()-36e5*e);console.log(`[MsdDataSource] 🔄 Preloading ${e}h history for ${this.cfg.entity}`);try{const e=await this.hass.connection.sendMessagePromise({type:"recorder/statistics_during_period",start_time:s.toISOString(),end_time:t.toISOString(),statistic_ids:[this.cfg.entity],period:"hour"});if(e&&e[this.cfg.entity]){const t=e[this.cfg.entity];console.log(`[MsdDataSource] 📊 Got ${t.length} statistics points`);for(const e of t){const t=new Date(e.start).getTime(),s=this._extractStatisticValue(e);null!==s&&(this.buffer.push(t,s),this._stats.historyLoaded++)}return void console.log(`[MsdDataSource] ✅ Loaded ${this._stats.historyLoaded} statistics points`)}}catch(e){console.warn("[MsdDataSource] Statistics failed, trying state history:",e.message)}await this._preloadStateHistoryWS(s,t)}async _preloadStateHistoryWS(e,t){try{console.log(`[MsdDataSource] 📚 Trying WebSocket state history for ${this.cfg.entity}`);const s=await this.hass.connection.sendMessagePromise({type:"history/history_during_period",start_time:e.toISOString(),end_time:t.toISOString(),entity_ids:[this.cfg.entity],minimal_response:!0,no_attributes:!0});if(s&&s[0]){const e=s[0];console.log(`[MsdDataSource] 📊 Got ${e.length} history states`);for(const t of e){const e=new Date(t.last_changed||t.last_updated).getTime(),s=this.cfg.attribute?t.attributes?.[this.cfg.attribute]:t.state,n=this._toNumber(s);null!==n&&(this.buffer.push(e,n),this._stats.historyLoaded++)}console.log(`[MsdDataSource] ✅ Loaded ${this._stats.historyLoaded} history points`)}else console.warn("[MsdDataSource] No history data returned from WebSocket call")}catch(s){console.error("[MsdDataSource] WebSocket state history also failed:",s),await this._preloadHistoryREST(e,t)}}async _preloadHistoryREST(e,t){try{console.log(`[MsdDataSource] 🌐 Trying REST API history for ${this.cfg.entity}`);const t=`/api/history/period/${e.toISOString()}?filter_entity_id=${this.cfg.entity}&minimal_response&no_attributes`,s=await fetch(t,{headers:{Authorization:`Bearer ${this.hass.auth?.accessToken}`,"Content-Type":"application/json"}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const n=await s.json();if(n&&n[0]){const e=n[0];console.log(`[MsdDataSource] 📊 Got ${e.length} REST history states`);for(const t of e){const e=new Date(t.last_changed||t.last_updated).getTime(),s=this.cfg.attribute?t.attributes?.[this.cfg.attribute]:t.state,n=this._toNumber(s);null!==n&&(this.buffer.push(e,n),this._stats.historyLoaded++)}console.log(`[MsdDataSource] ✅ Loaded ${this._stats.historyLoaded} REST history points`)}}catch(e){console.error("[MsdDataSource] REST history fallback also failed:",e)}}_handleStateChange(e){if(console.log("[MSD DEBUG] 📊 MsdDataSource._handleStateChange() ENTRY:",{entity:this.cfg.entity,timestamp:(new Date).toISOString(),hasEventData:!!e,hasNewState:!!e?.new_state,newStateValue:e?.new_state?.state,subscriberCount:this.subscribers.size,stackTrace:(new Error).stack.split("\n").slice(1,3).join("\n")}),!e?.new_state||this._destroyed)return void console.log("[MSD DEBUG] ⏭️ Skipping state change - no new state or destroyed");this._lastOriginalState=e.new_state;const t=Date.now(),s=this.cfg.attribute?e.new_state.attributes?.[this.cfg.attribute]:e.new_state.state,n=this._toNumber(s);if(null!==n){console.log(`[MSD DEBUG] 📊 Processing state change for ${this.cfg.entity}:`,{value:n,timestamp:t,subscriberCount:this.subscribers.size,originalState:this._lastOriginalState.state}),this.buffer.push(t,n),this._stats.updates++,this._stats.currentValue=n,console.log(`[MSD DEBUG] 📤 Emitting to ${this.subscribers.size} subscribers:`,n);const e={t,v:n,buffer:this.buffer,stats:{...this._stats},entity:this.cfg.entity,historyReady:this._stats.historyLoaded>0};this.subscribers.forEach(((t,s)=>{try{console.log(`[MSD DEBUG] 📞 Calling subscriber ${s} for ${this.cfg.entity}`),t(e),console.log(`[MSD DEBUG] ✅ Subscriber ${s} completed successfully`)}catch(e){console.error(`[MSD DEBUG] ❌ Subscriber ${s} callback FAILED for ${this.cfg.entity}:`,e),console.error("[MSD DEBUG] ❌ Subscriber error stack:",e.stack)}}))}else console.log("[MSD DEBUG] ⚠️ Skipping state change - invalid value:",{rawValue:s,entity:this.cfg.entity})}_shouldEmit(e,t){return Date.now(),this._lastEmitTime&&t-this._lastEmitTime<this.minEmitMs?(this._stats.coalesced++,!1):!(!this.emitOnSameValue&&e===this._lastEmittedValue&&(this._stats.skipsSameValue++,1))}_emit(e){const t=Date.now();this._lastEmitTime=t,this._lastEmittedValue=e.v,this._stats.emits++,console.log(`[MsdDataSource] 📤 Emitting to ${this.subscribers.size} subscribers:`,e.v),this.subscribers.forEach((t=>{try{t(e)}catch(e){console.warn("[MsdDataSource] Subscriber callback error:",e)}}))}async _subscribeLive(){if(!this.hass?.connection?.subscribeEvents||!this.cfg.entity)return;const e=this.cfg.entity;try{this.haUnsubscribe=await this.hass.connection.subscribeEvents((t=>{const s=t?.data?.new_state;if(!s||s.entity_id!==e)return;const n=new Date(s.last_changed||s.last_updated||Date.now()).getTime(),r=this.cfg.attribute?s.attributes?.[this.cfg.attribute]:s.state,i=this._toNumber(r);this._onRawEventValue(n,i)}),"state_changed")}catch(e){console.warn("[MsdDataSource] Failed to subscribe to HA events:",e.message)}}_onRawEventValue(e,t){if(null===t)return void this._stats.invalid++;const s=uc?Date.now():performance.now();this.buffer.push(e,t),this._stats.received++,this._pending?(this._pendingCount++,s-this._pendingFirstTs>=this.coalesceMs?(this._emit(),this._pending=!0,this._pendingFirstTs=s,this._pendingCount=1,this._ensureScheduleEmit()):this._stats.coalesced++):(this._pending=!0,this._pendingFirstTs=s,this._pendingCount=1,this._stats.received>10?setTimeout((()=>this._ensureScheduleEmit()),5):this.subscribers.size>0&&0===this._stats.emits?this._emit():this._ensureScheduleEmit())}_ensureScheduleEmit(){this._pendingRaf||(this._pendingRaf=hc((()=>{this._pendingRaf=0,this._frameEmitCheck()})))}_frameEmitCheck(){if(!this._pending||this._destroyed)return;const e=uc?Date.now():performance.now(),t=e-this._lastEmitTime,s=e-this._pendingFirstTs;let n=!1;if(t>=this.minEmitMs&&s>=this.coalesceMs&&(n=!0),s>=this.maxDelayMs&&(n=!0),n)this._emit();else{const e=Math.max(0,this.minEmitMs-t),n=Math.max(0,this.coalesceMs-s),r=Math.max(0,this.maxDelayMs-s),i=Math.min(e||1/0,n||1/0,r||1/0);i<1/0&&i>0&&setTimeout((()=>{this._ensureScheduleEmit()}),Math.max(1,Math.min(50,i)))}}subscribe(e){if("function"!=typeof e)return console.warn("[MsdDataSource] Subscribe requires a function callback"),()=>{};this.subscribers.add(e);const t=this.buffer.last();if(t)try{const s={t:t.t,v:t.v,buffer:this.buffer,stats:{...this._stats}};console.log("[MsdDataSource] Providing immediate hydration for new subscriber:",{entity:this.cfg.entity,value:t.v,bufferSize:this.buffer.size(),timestamp:new Date(t.t).toISOString()}),setTimeout((()=>{e(s)}),0)}catch(e){console.warn("[MsdDataSource] Initial callback error:",e)}else console.log("[MsdDataSource] No data available for immediate hydration:",{entity:this.cfg.entity,bufferSize:this.buffer.size(),started:this._started});return()=>{this.subscribers.delete(e)}}_toNumber(e){if(console.log("[MSD DEBUG] 📊 _toNumber() converting:",{raw:e,type:typeof e,entity:this.cfg.entity}),null==e)return console.log("[MSD DEBUG] ⚠️ _toNumber() - null/undefined value"),null;if("number"==typeof e){const t=isNaN(e)?null:e;return console.log("[MSD DEBUG] 📊 _toNumber() - numeric:",{raw:e,result:t}),t}if("string"==typeof e){const t=parseFloat(e);if(!isNaN(t)&&isFinite(t))return console.log("[MSD DEBUG] 📊 _toNumber() - string numeric:",{raw:e,num:t}),t;const s=e.toLowerCase().trim();return"on"===s||"true"===s||"active"===s||"open"===s?(console.log("[MSD DEBUG] 📊 _toNumber() - boolean TRUE:",{raw:e,converted:1}),1):"off"===s||"false"===s||"inactive"===s||"closed"===s?(console.log("[MSD DEBUG] 📊 _toNumber() - boolean FALSE:",{raw:e,converted:0}),0):"unavailable"===s||"unknown"===s?(console.log("[MSD DEBUG] 📊 _toNumber() - unavailable state:",{raw:e,converted:null}),null):(console.log("[MSD DEBUG] ⚠️ _toNumber() - unhandled string:",{raw:e}),null)}if("boolean"==typeof e){const t=e?1:0;return console.log("[MSD DEBUG] 📊 _toNumber() - boolean:",{raw:e,result:t}),t}return console.log("[MSD DEBUG] ⚠️ _toNumber() - unsupported type:",{raw:e,type:typeof e}),null}_parseTimeWindowMs(e){if("string"!=typeof e)return NaN;const t=e.match(/^(\d+(?:\.\d+)?)\s*(s|sec|m|min|h|hr|d|day)s?$/i);if(!t)return NaN;const s=parseFloat(t[1]);switch(t[2].toLowerCase()){case"s":case"sec":return 1e3*s;case"m":case"min":return 60*s*1e3;case"h":case"hr":return 60*s*60*1e3;case"d":case"day":return 24*s*60*60*1e3;default:return NaN}}getStats(){return{...this._stats,config:{entity:this.cfg.entity,windowSeconds:this.cfg.windowSeconds,minEmitMs:this.minEmitMs,coalesceMs:this.coalesceMs,maxDelayMs:this.maxDelayMs},buffer:this.buffer.getStats(),subscribers:this.subscribers.size,state:{started:this._started,pending:this._pending,destroyed:this._destroyed}}}getCurrentData(){const e=this.buffer.last();return e?{t:e.t,v:e.v,buffer:this.buffer,stats:{...this._stats},entity:this.cfg.entity,historyReady:this._stats.historyLoaded>0,bufferSize:this.buffer.size(),started:this._started}:{t:null,v:null,buffer:this.buffer,stats:{...this._stats},entity:this.cfg.entity,historyReady:this._stats.historyLoaded>0,bufferSize:0,started:this._started}}getEntity(){return this.currentState?{state:this.currentState.state,attributes:this.currentState.attributes||{}}:null}async stop(){if(this._started=!1,this.haUnsubscribe){try{this.haUnsubscribe()}catch(e){console.warn("[MsdDataSource] HA unsubscribe error:",e)}this.haUnsubscribe=null}this._pendingRaf&&(pc(this._pendingRaf),this._pendingRaf=0),this._pending=!1}destroy(){this._destroyed=!0,this.stop(),this.subscribers.clear(),this.buffer.clear()}_extractStatisticValue(e){return Number.isFinite(e.mean)?e.mean:Number.isFinite(e.state)?e.state:Number.isFinite(e.sum)?e.sum:Number.isFinite(e.max)?e.max:Number.isFinite(e.min)?e.min:null}}class mc{constructor(e){this.hass=e,this.sources=new Map,this.overlaySubscriptions=new Map,this.entityIndex=new Map,this.globalEntityChangeListeners=new Set,this._stats={sourcesCreated:0,subscriptionsActive:0,dataUpdates:0,errors:0},this._destroyed=!1}async initializeFromConfig(e){if(this._destroyed)throw new Error("DataSourceManager has been destroyed");console.log(`[DataSourceManager] 🚀 Initializing ${Object.keys(e||{}).length} data sources`);const t=Object.entries(e||{}).map((async([e,t])=>{try{const s=await this.createDataSource(e,t);return this._stats.sourcesCreated++,s}catch(t){throw console.warn(`[DataSourceManager] Failed to create source ${e}:`,t),this._stats.errors++,t}}));await Promise.all(t),this.sources.size>0&&await this._waitForHistoryPreloading();const s=this.sources.size,n=Object.keys(e||{}).length-s;return console.log(`[DataSourceManager] ✅ Initialization complete: ${s} successful, ${n} failed`),s}async createDataSource(e,t){if(this.sources.has(e))return this.sources.get(e);const s=new gc(t,this.hass);this.sources.set(e,s),t.entity&&(this.entityIndex.set(t.entity,s),s.subscribe((e=>{this._notifyGlobalEntityChangeListeners([t.entity])})));try{if(await s.start(),t.entity&&this.hass.states&&this.hass.states[t.entity]){const e=this.hass.states[t.entity];s._handleStateChange({entity_id:t.entity,new_state:e,old_state:null})}}catch(s){throw console.warn(`[DataSourceManager] Failed to start source ${e}:`,s),this.sources.delete(e),this.entityIndex.delete(t.entity),this._stats.errors++,s}return s}async _waitForHistoryPreloading(e=1e4){const t=Date.now();for(console.log("[DataSourceManager] ⏳ Waiting for history preloading...");Date.now()-t<e;){let e=!0,s=0,n=0;for(const[t,r]of this.sources)s++,r.getStats().historyLoaded>0||!r.cfg.history?.enabled?n++:e=!1;if(n>0&&console.log(`[DataSourceManager] History loading progress: ${n}/${s} sources ready`),e||0===s){console.log(`[DataSourceManager] ✅ History preloading complete in ${Date.now()-t}ms`);break}await new Promise((e=>setTimeout(e,100)))}}getEntity(e){const t=this.entityIndex.get(e);if(!t){if(this.hass.states&&this.hass.states[e]){const t=this.hass.states[e];return{state:t.state,attributes:t.attributes||{}}}return null}const s=t.getCurrentData();if(s)return{state:s.v.toString(),attributes:{}};if(this.hass.states&&this.hass.states[e]){const t=this.hass.states[e];return{state:t.state,attributes:t.attributes||{}}}return null}listIds(){return Array.from(this.entityIndex.keys())}addEntityChangeListener(e){return this.globalEntityChangeListeners.add(e),()=>this.globalEntityChangeListeners.delete(e)}_notifyGlobalEntityChangeListeners(e){0!==this.globalEntityChangeListeners.size&&this.globalEntityChangeListeners.forEach((t=>{try{t(e)}catch(e){console.warn("[DataSourceManager] Global entity listener error:",e)}}))}subscribeOverlay(e,t){if(!e.source)return void console.warn("[DataSourceManager] subscribeOverlay: No source specified for overlay",e.id);const s=this.sources.get(e.source);if(!s)return void console.warn("[DataSourceManager] subscribeOverlay: Source not found:",e.source);console.log(`[DataSourceManager] 🔗 Setting up subscription for ${e.id} to ${e.source}`);const n=s.subscribe((s=>{const n={...s,sourceId:e.source,overlayId:e.id,overlayType:e.type,buffer:"sparkline"===e.type?s.buffer:void 0,historicalData:"sparkline"===e.type&&s.buffer?s.buffer.getAll().map((e=>({timestamp:e.t,value:e.v}))):void 0};console.log(`[DataSourceManager] 📤 Calling callback for ${e.id}:`,{hasBuffer:!!n.buffer,bufferSize:n.buffer?.size?.()||0,hasHistoricalData:!!n.historicalData,historicalDataLength:n.historicalData?.length||0,currentValue:n.v}),t(e,n)})),r=s.getCurrentData();if(r&&(r.buffer?.size?.()>0||void 0!==r.v)){console.log(`[DataSourceManager] 🔄 Providing immediate data for ${e.id}`);const s={...r,sourceId:e.source,overlayId:e.id,overlayType:e.type,buffer:"sparkline"===e.type?r.buffer:void 0,historicalData:"sparkline"===e.type&&r.buffer?r.buffer.getAll().map((e=>({timestamp:e.t,value:e.v}))):void 0};setTimeout((()=>{t(e,s)}),0)}return this.overlaySubscriptions.has(e.id)||this.overlaySubscriptions.set(e.id,[]),this.overlaySubscriptions.get(e.id).push(n),this._stats.subscriptionsActive++,console.log(`[DataSourceManager] ✅ Subscribed ${e.type} overlay ${e.id} to source ${e.source} (${s.subscribers?.size||0} total subscribers)`),n}unsubscribeOverlay(e){const t=this.overlaySubscriptions.get(e);t&&(t.forEach((t=>{try{t()}catch(t){console.warn(`[DataSourceManager] Error unsubscribing overlay ${e}:`,t),this._stats.errors++}})),this.overlaySubscriptions.delete(e),this._stats.subscriptionsActive--)}getSource(e){return this.sources.get(e)}getAllSources(){return Array.from(this.sources.values())}getDataSource(e){return this._dataSources.get(e)||null}getStats(){const e={};for(const[t,s]of this.sources)e[t]=s.getStats?s.getStats():{error:"No stats available"};return{manager:this._stats,sources:e,summary:{totalSources:this.sources.size,activeSubscriptions:this.overlaySubscriptions.size,entityCount:this.entityIndex.size,destroyed:this._destroyed}}}async destroy(){if(this._destroyed)return;this._destroyed=!0;for(const e of this.overlaySubscriptions.keys())this.unsubscribeOverlay(e);const e=[];for(const[t,s]of this.sources)try{s.stop?e.push(s.stop()):s.destroy&&e.push(s.destroy())}catch(e){console.warn(`[DataSourceManager] Error stopping source ${t}:`,e)}await Promise.all(e),this.sources.clear(),this.overlaySubscriptions.clear(),this.entityIndex.clear(),this.globalEntityChangeListeners.clear()}debugDump(){return{sources:Array.from(this.sources.keys()),subscriptions:Array.from(this.overlaySubscriptions.keys()),entities:Array.from(this.entityIndex.keys()),stats:this.getStats()}}}const fc=Object.create(null);function yc(e,t=1){fc[e]=(fc[e]||0)+t}function bc(){return{...fc}}function _c(e,t){const s=performance.now(),n=t(),r=()=>{const t=performance.now()-s;yc(e+".samples",1),yc(e+".totalMs",t),function(e,t){fc[e]=t}(e+".lastMs",t)};return n&&"function"==typeof n.then?n.then((e=>(r(),e))):(r(),n)}class vc{constructor(e,t,s){this.config=e||{},this.anchors=t||{},this.viewBox=s,this._cache=new Map,this._cacheOrder=[],this._maxCache=256,this._rev=0,this._overlaysRef=null,this._obstacles=[],this._obsVersion=0,this._gridCache=new Map,this._channels=this._normalizeChannels(this.config.channels||[]),this._channelForcePenalty=Number(this.config.channel_force_penalty||800),this._channelAvoidMultiplier=Number(this.config.channel_avoid_multiplier||1),this._channelTargetCoverage=Number(this.config.channel_target_coverage??.6),this._channelShapingMaxAttempts=Number(this.config.channel_shaping_max_attempts??12),this._channelShapingSpan=Number(this.config.channel_shaping_span??32),this._channelMinCoverageGain=Number(this.config.channel_min_coverage_gain??.04)}invalidate(e="*"){if("*"===e)this._cache.clear(),this._cacheOrder.length=0,this._rev++;else for(const t of Array.from(this._cache.keys()))if(t.includes(`@${e}|`)){this._cache.delete(t);const e=this._cacheOrder.indexOf(t);e>=0&&this._cacheOrder.splice(e,1)}yc("routing.invalidate.events",1)}setOverlays(e){if(!Array.isArray(e))return;if(e===this._overlaysRef)return;this._overlaysRef=e;const t=[];for(const s of e){if(!s||!s.id)continue;const e=s._raw||s.raw||{};if(!0!==e.obstacle&&"ribbon"!==s.type)continue;let n=0,r=0,i=0,o=0;if(Array.isArray(e.position)&&Array.isArray(e.size))[n,r]=e.position,[i,o]=e.size;else{if(!e.anchor||!this.anchors[e.anchor])continue;{const[t,s]=this.anchors[e.anchor];n=t-1,r=s-1,i=2,o=2}}!Number.isFinite(n+r+i+o)||i<=0||o<=0||t.push({id:s.id,x1:n,y1:r,x2:n+i,y2:r+o})}this._obstacles=t,this._obsVersion++,this._gridCache.clear(),this.invalidate("*"),yc("routing.obstacles.count",t.length)}stats(){return{size:this._cache.size,max:this._maxCache,rev:this._rev,obstacles:this._obstacles.length,obsVersion:this._obsVersion}}buildRouteRequest(e,t,s){const n=e._raw||e.raw||{},r=e.finalStyle||{};let i=(n.route_channel_mode||n.routeChannelMode||n.channel_mode||"prefer").toLowerCase();["prefer","avoid","force"].includes(i)||(yc&&yc("routing.channel.mode.invalid",1),i="prefer");let o=(n.smoothing_mode||n.corner_smoothing_mode||r.smoothing_mode||this.config.smoothing_mode||this.config.smoothing&&this.config.smoothing.mode||"none").toLowerCase();if(!["none","chaikin"].includes(o)){try{yc("routing.smooth.mode.invalid",1)}catch(e){}o="none"}let a=(n.route_mode||"").toLowerCase(),l=(n.route_mode_last||"").toLowerCase(),c=a?"explicit":"auto",d=l?"explicit":null,u=!1;if(n.attach_side?u=!0:"string"==typeof n.attach_to&&n.attach_to&&(this.anchors[n.attach_to]||(u=!0)),!l&&u){const e=(n.attach_side||"").toLowerCase();if("left"===e||"right"===e){l="yx",d="attach_side";try{yc("routing.hint.attach_side.horizontal",1)}catch(e){}}else if("top"===e||"bottom"===e){l="xy",d="attach_side";try{yc("routing.hint.attach_side.vertical",1)}catch(e){}}}if(!a){const[e,n]=t,[r,i]=s;a=Number.isFinite(e+n+r+i)?Math.abs(r-e)>=Math.abs(i-n)?"xy":"yx":"xy",c="geometry"}l||(l=a,d||(d=c));const h=Number(n.smoothing_iterations||n.corner_smoothing_iterations||r.smoothing_iterations||this.config.smoothing_iterations||this.config.smoothing&&this.config.smoothing.iterations||0),p=Number(n.smoothing_max_points||r.smoothing_max_points||this.config.smoothing_max_points||this.config.smoothing&&this.config.smoothing.max_points||160);return{id:e.id,a:t,b:s,modeFull:(n.route_mode_full||n.route_mode||"manhattan").toLowerCase(),modeHint:a,modeHintLast:l,_hintSourceFirst:c,_hintSourceLast:d,avoidIds:Array.isArray(n.avoid)?n.avoid.slice():[],channels:n.route_channels||n.routeChannels||[],channelMode:i,cornerRadius:Number(n.corner_radius||n.cornerRadius||r.corner_radius||0),cornerStyle:(n.corner_style||n.cornerStyle||r.corner_style||"miter").toLowerCase(),smoothingMode:o,smoothingIterations:h,smoothingMaxPoints:p,clearance:Number(n.clearance||this.config.clearance||0),proximity:Number(n.smart_proximity||this.config.smart_proximity||0),smart:{detourSpan:Number(this.config.smart_detour_span||48),maxExtraBends:Number(this.config.smart_max_extra_bends||3),minImprovement:Number(this.config.smart_min_improvement||4),maxDetoursPerElbow:Number(this.config.smart_max_detours_per_elbow||4)},_rev:this._rev}}_cacheKey(e){const[t,s]=e.a,[n,r]=e.b,i=e.avoidIds.sort().join(","),o=e.channels.sort().join(",");return`${e.id}@${t},${s}-${n},${r}|${e.modeFull}|${e.modeHint}|A:${i}|C:${o}|${e.channelMode}|R:${e._rev}|O:${this._obsVersion}|P:${e.proximity}|CR:${e.cornerRadius}|CS:${e.cornerStyle}|SM:${e.smoothingMode}|SI:${e.smoothingIterations}`}computePath(e){return _c("routing.compute.ms",(()=>{const t=this._cacheKey(e),s=this._cache.get(t);if(s)return yc("routing.cache.hit",1),{...s,meta:{...s.meta,cache_hit:!0}};let n;yc("routing.cache.miss",1);const r=e.modeFull;try{if("grid"===r)n=this._computeGrid(e);else if("smart"===r){yc("routing.strategy.smart",1);const t=this._computeGrid(e,{smart:!0});t&&(n=this._refineSmart(e,t))}}catch(e){console.warn("[MSD v1] smart/grid router error; fallback to manhattan",e)}if(n||("smart"===r&&yc("routing.strategy.smart",1),n=this._computeManhattan(e)),n&&"round"===e.cornerStyle&&e.cornerRadius>0){const t=this._applyCornerRounding(n,e.cornerRadius);t&&(n=t)}if(n&&"none"!==e.smoothingMode&&e.smoothingIterations>0){const t=this._applySmoothing(n,e);t&&(n=t)}if(this._cache.set(t,n),this._cacheOrder.push(t),this._cacheOrder.length>this._maxCache){const e=this._cacheOrder.shift();e&&this._cache.delete(e)}return{...n,meta:{...n.meta,cache_hit:!1}}}))}_computeGrid(e,t={}){yc("routing.strategy.grid",1);const s=this.viewBox||[0,0,400,200],n=s[2],r=s[3],i=Number(this.config.grid_resolution||64),o=i>4?i:32,a=Math.max(2,Math.ceil(n/o)),l=Math.max(2,Math.ceil(r/o)),c=Math.max(0,e.clearance||this.config.clearance||0),d=`${o}|${this._obsVersion}|${c}`;let u=this._gridCache.get(d);u||(u=this._buildOccupancy(a,l,o,c),this._gridCache.set(d,u));const h=e=>Math.min(a-1,Math.max(0,Math.round(e/o))),p=e=>Math.min(l-1,Math.max(0,Math.round(e/o))),g=e=>e*o,m=e=>e*o,f={c:h(e.a[0]),r:p(e.a[1])},y={c:h(e.b[0]),r:p(e.b[1])},b=new wc,_=(e,t)=>`${e},${t}`,v=new Map,w=new Map,S=(e,t)=>Math.abs(e-y.c)+Math.abs(t-y.r);v.set(_(f.c,f.r),0),b.push({c:f.c,r:f.r,f:S(f.c,f.r)});const x=(e,t)=>u[t]&&1===u[t][e],$=a*l*4;let C=0,k=!1;for(;!b.isEmpty()&&C++<$;){const e=b.pop();if(e.c===y.c&&e.r===y.r){k=!0;break}const t=v.get(_(e.c,e.r));for(const[s,n]of[[1,0],[-1,0],[0,1],[0,-1]]){const r=e.c+s,i=e.r+n;if(r<0||i<0||r>=a||i>=l)continue;if(x(r,i))continue;const o=_(r,i),c=t+1;if(c<(v.get(o)??1/0)){v.set(o,c),w.set(o,[e.c,e.r]);const t=c+S(r,i);b.push({c:r,r:i,f:t})}}}if(!k)return null;const A=[];let M=y.c,D=y.r;for(;A.push([M,D]),M!==f.c||D!==f.r;){const e=w.get(_(M,D));if(!e)break;[M,D]=e}A.reverse();const E=[];let T=null;for(let e=0;e<A.length;e++){const[t,s]=A[e],n=g(t),r=m(s);if(0===e){E.push([n,r]);continue}const[i,o]=A[e-1],a=[t-i,s-o].join(",");a!==T?(E.push([n,r]),T=a):E[E.length-1]=[n,r]}if(E[0]=[e.a[0],e.a[1]],E[E.length-1]=[e.b[0],e.b[1]],2===E.length){const[t,s]=E[0],[n,r]=E[1];t!==n&&s!==r&&("yx"==("yx"===e.modeHint?"yx":"xy")?E.splice(1,0,[t,r]):E.splice(1,0,[n,s]))}const R=this.config?.cost_defaults?.bend??10,O=this.config?.cost_defaults?.proximity??4,{penalty:L}=this._segmentProximityPenalty(E,e.clearance,e.proximity,O);let P=this._channelDelta(E,e),N=null;if(e.channels?.length&&("prefer"===e.channelMode||"force"===e.channelMode)){const t="force"===e.channelMode?1:this._channelTargetCoverage;if(P.coverage<t){const s=this._shapeForChannels(e,E,P,t);s&&s.accepted?(E=s.pts,P=this._channelDelta(E,e),N=s.meta,yc("routing.channel.shape.accept",1)):s&&(N=s.meta)}}const F=this._costComposite(E,R,O,L,P.delta);return{d:this._polylineToPath(E),pts:E,meta:{strategy:t.smart?"grid-smart-preface":"grid",cost:F,segments:E.length-1,bends:Math.max(0,E.length-2),grid:{resolution:o,iterations:C},...e.channels?.length?{channel:{mode:P.mode,insidePx:P.inside,outsidePx:P.outside,coveragePct:Number((100*P.coverage).toFixed(1)),deltaCost:P.delta,forcedOutside:P.forcedOutside,...N?{shaping:N}:{}}}:{}}}}_buildOccupancy(e,t,s,n){const r=Array.from({length:t},(()=>new Uint8Array(e)));if(!this._obstacles.length)return r;for(const i of this._obstacles){const o=i.x1-n,a=i.y1-n,l=i.x2+n,c=i.y2+n,d=Math.max(0,Math.floor(o/s)),u=Math.max(0,Math.floor(a/s)),h=Math.min(e-1,Math.ceil(l/s)),p=Math.min(t-1,Math.ceil(c/s));for(let e=u;e<=p;e++){const t=r[e];for(let e=d;e<=h;e++)t[e]=1}}return r}_computeManhattan(e){const[t,s]=e.a,[n,r]=e.b,i=(e.modeHint,"yx"===e.modeHintLast?"yx":"xy");let o;return o=t===n||s===r?[[t,s],[n,r]]:"xy"===i?[[t,s],[n,s],[n,r]]:[[t,s],[t,r],[n,r]],{d:this._polylineToPath(o),pts:o,meta:{strategy:"manhattan-basic",cost:this._costSimple(o),segments:o.length-1,bends:Math.max(0,o.length-2),hint:{first:e.modeHint,last:e.modeHintLast,sourceFirst:e._hintSourceFirst,sourceLast:e._hintSourceLast}}}}_polylineToPath(e){if(!e.length)return"";let t=`M${e[0][0]},${e[0][1]}`;for(let s=1;s<e.length;s++)t+=` L${e[s][0]},${e[s][1]}`;return t}_costSimple(e){let t=0;for(let s=1;s<e.length;s++){const n=e[s][0]-e[s-1][0],r=e[s][1]-e[s-1][1];t+=Math.abs(n)+Math.abs(r)}return t+Math.max(0,e.length-2)*(this.config?.cost_defaults?.bend??10)}_costComposite(e,t,s,n,r=0){let i=0;for(let t=1;t<e.length;t++)i+=Math.abs(e[t][0]-e[t-1][0])+Math.abs(e[t][1]-e[t-1][1]);return i+Math.max(0,e.length-2)*t+n*s+r}_segmentProximityPenalty(e,t,s,n){if(!s||!this._obstacles.length)return{penalty:0,detail:[]};const r=t+s;let i=0;const o=[];for(let t=1;t<e.length;t++){const s=e[t-1],n=e[t],a=this._nearestObstacleBandOverlap(s,n,r);a>0&&(i+=a,o.push({i:t,segPenalty:a}))}return{penalty:i,detail:o}}_nearestObstacleBandOverlap(e,t,s){const n=e[0]===t[0],r=Math.min(e[0],t[0]),i=Math.max(e[0],t[0]),o=Math.min(e[1],t[1]),a=Math.max(e[1],t[1]);let l=0;for(const t of this._obstacles){if(i<t.x1-s||r>t.x2+s||a<t.y1-s||o>t.y2+s)continue;let c;if(c=n?e[0]<t.x1?t.x1-e[0]:e[0]>t.x2?e[0]-t.x2:0:e[1]<t.y1?t.y1-e[1]:e[1]>t.y2?e[1]-t.y2:0,c<s){const e=s-c;e>l&&(l=e)}}return l}_normalizeChannels(e){return Array.isArray(e)?e.filter((e=>e&&Array.isArray(e.rect)&&4===e.rect.length)).map((e=>{const[t,s,n,r]=e.rect;return{id:e.id||`chan_${t}_${s}`,x1:t,y1:s,x2:t+n,y2:s+r,weight:Number(e.weight||e.w||.5)}})):[]}_channelDelta(e,t){if(!this._channels.length||!t.channels||!t.channels.length)return{delta:0,inside:0,outside:0,coverage:0,forcedOutside:!1,mode:t.channelMode};const s=new Set(t.channels),n=this._channels.filter((e=>s.has(e.id)));if(!n.length)return{delta:0,inside:0,outside:0,coverage:0,forcedOutside:!1};let r=0,i=0;for(let t=1;t<e.length;t++){const s=e[t-1],o=e[t],a=Math.abs(s[0]-o[0])+Math.abs(s[1]-o[1]);if(0===a)continue;const l=(s[0]+o[0])/2,c=(s[1]+o[1])/2,d=n.some((e=>l>=e.x1&&l<=e.x2&&c>=e.y1&&c<=e.y2));d?r+=a:i+=a}const o=r/(r+i||1);let a=0;const l=(t.channelMode||"prefer").toLowerCase();let c=!1;if("prefer"===l){const e=n.reduce(((e,t)=>e+t.weight),0)/n.length;a-=r*e}else if("avoid"===l){const e=n.reduce(((e,t)=>e+t.weight),0)/n.length;a+=r*e*this._channelAvoidMultiplier}else if("force"===l)if(i>0)c=!0,a+=this._channelForcePenalty;else{const e=n.reduce(((e,t)=>e+t.weight),0)/n.length;a-=r*e}return 0!==a&&yc("routing.channel.applied",1),c&&yc("routing.channel.force.penalty",1),{delta:a,inside:r,outside:i,coverage:o,forcedOutside:c,mode:t.channelMode}}_refineSmart(e,t){if(!t||!Array.isArray(t.pts)||t.pts.length<2)return t;const s=this.config?.cost_defaults?.bend??10,n=this.config?.cost_defaults?.proximity??4,{penalty:r}=this._segmentProximityPenalty(t.pts,e.clearance,e.proximity,n);let i=t.pts.slice(),o=r,a=this._costComposite(i,s,n,o),l=0,c=0;if(e.proximity>0&&i.length>2){const t=e.smart.detourSpan,r=e.smart.maxExtraBends,d=e.smart.min_improvement;for(let u=1;u<i.length-1;u++){const h=i[u],p=i[u-1],g=i[u+1],m=p[0]===h[0],f=h[1]===g[1];if(m&&f||!m&&!f){const p=[];p.push([h[0]+t,h[1]]),p.push([h[0]-t,h[1]]),p.push([h[0],h[1]+t]),p.push([h[0],h[1]-t]);let g=0;for(const t of p){if(g++>=e.smart.maxDetoursPerElbow)break;l++;const h=i.slice();h[u]=t;const p=this._compactPolyline(h);if(p.length-i.length>r)continue;const{penalty:m}=this._segmentProximityPenalty(p,e.clearance,e.proximity,n),f=this._costComposite(p,s,n,m);f+d<=a&&(a=f,i=p,o=m,c++)}}}}const d=this._channelDelta(i,e);let u=null;if(e.channels?.length&&("prefer"===e.channelMode||"force"===e.channelMode)){const t="force"===e.channelMode?1:this._channelTargetCoverage;if(d.coverage<t){const r=this._shapeForChannels(e,i,d,t);if(r&&r.accepted){i=r.pts;const t=this._channelDelta(i,e),{penalty:l}=this._segmentProximityPenalty(i,e.clearance,e.proximity,n);o=l,u=r.meta,a=this._costComposite(i,s,n,o,t.delta),d.inside=t.inside,d.outside=t.outside,d.coverage=t.coverage,d.delta=t.delta,d.forcedOutside=t.forcedOutside,yc("routing.channel.shape.accept",1)}else r&&(u=r.meta)}}a=this._costComposite(i,s,n,o,d.delta);const h=this._polylineToPath(i),p=t.meta||{};return p.strategy="smart",p.cost=a,p.bends=Math.max(0,i.length-2),p.segments=i.length-1,p.smart={penaltyBefore:r,penaltyAfter:o,detoursTried:l,detoursAccepted:c},e.channels?.length&&(p.channel={mode:d.mode,insidePx:d.inside,outsidePx:d.outside,coveragePct:Number((100*d.coverage).toFixed(1)),deltaCost:d.delta,forcedOutside:d.forcedOutside,...u?{shaping:u}:{}}),yc("routing.smart.refine.attempt",l),yc("routing.smart.refine.accept",c),{d:h,pts:i,meta:p}}_compactPolyline(e){if(e.length<=2)return e;const t=[e[0]];for(let s=1;s<e.length-1;s++){const n=t[t.length-1],r=e[s],i=e[s+1];n[0]===r[0]&&r[0]===i[0]||n[1]===r[1]&&r[1]===i[1]||t.push(r)}return t.push(e[e.length-1]),t}_shapeForChannels(e,t,s,n){yc("routing.channel.shape.attempt",1);const r=this._channelShapingMaxAttempts,i=this._channelShapingSpan,o=this._channelMinCoverageGain,a=new Set(e.channels),l=this._channels.filter((e=>a.has(e.id)));if(!l.length)return null;const c=s.coverage;let d=t.slice(),u=c,h=!1,p=0,g=[Number(c.toFixed(4))];const m="force"===e.channelMode;function f(e,t){return[(e[0]+t[0])/2,(e[1]+t[1])/2]}const y=(e,t)=>l.some((s=>e>=s.x1&&e<=s.x2&&t>=s.y1&&t<=s.y2)),b=()=>{const e=[];for(let t=1;t<d.length;t++){const s=d[t-1],n=d[t],r=Math.abs(s[0]-n[0])+Math.abs(s[1]-n[1]);if(!r)continue;const[i,o]=f(s,n);y(i,o)||e.push({i:t,len:r,a:s,b:n,mx:i,my:o})}return e.sort(((e,t)=>t.len-e.len))};for(;p<r;){p++;const t=b();if(!t.length)break;const s=t[0],r=[];s.i-1>0&&r.push(s.i-1),s.i<d.length-1&&r.push(s.i);let a=!1;for(const t of r){const s=d.map((e=>e.slice())),r=s[t];let c=null,h=1/0;if(l.forEach((e=>{const t=r[0]<e.x1?e.x1-r[0]:r[0]>e.x2?e.x2-r[0]:0,s=r[1]<e.y1?e.y1-r[1]:r[1]>e.y2?e.y2-r[1]:0;if(0!==t&&0!==s)Math.abs(t)<Math.abs(s)?Math.abs(t)<h&&(h=Math.abs(t),c=[t,0]):Math.abs(s)<h&&(h=Math.abs(s),c=[0,s]);else if(0!==t||0!==s){const e=Math.abs(t||s);e<h&&(h=e,c=[t,s])}})),!c)continue;const p=[0===c[0]?0:Math.sign(c[0])*Math.min(Math.abs(c[0]),i),0===c[1]?0:Math.sign(c[1])*Math.min(Math.abs(c[1]),i)];s[t]=[r[0]+p[0],r[1]+p[1]];const f=this._compactPolyline(s),y=this._channelDelta(f,e);if(y.coverage-u>=o){if(d=f,u=y.coverage,g.push(Number(u.toFixed(4))),a=!0,m&&u>=.999)break;if(!m&&u>=n)break}}if(!a)break;if(m&&u>=.999||!m&&u>=n){h=!0;break}}let _=!1;return m&&u<.999&&(_=!0,yc("routing.channel.shape.downgrade",1)),{accepted:h,pts:d,meta:{attempts:p,coverageBefore:Number(c.toFixed(4)),coverageAfter:Number(u.toFixed(4)),coverageHistory:g,accepted:h,downgraded:_}}}_applyCornerRounding(e,t){const s=e.pts;if(!Array.isArray(s)||s.length<3)return yc("routing.arc.none",1),null;let n=0,r=0;const i=[];let o=s[0].slice();i.push(`M${o[0]},${o[1]}`);for(let e=1;e<s.length-1;e++){const a=s[e-1],l=s[e],c=s[e+1],d=[l[0]-a[0],l[1]-a[1]],u=[c[0]-l[0],c[1]-l[1]];if(0!==d[0]&&0!==d[1]||0!==u[0]&&0!==u[1]||0===d[0]&&0===d[1]||0===u[0]&&0===u[1]||Math.sign(d[0])===Math.sign(u[0])&&0!==d[0]||Math.sign(d[1])===Math.sign(u[1])&&0!==d[1]){l[0]===o[0]&&l[1]===o[1]||(i.push(`L${l[0]},${l[1]}`),o=l.slice());continue}const h=Math.abs(d[0])+Math.abs(d[1]),p=Math.abs(u[0])+Math.abs(u[1]);let g=Math.min(t,h/2,p/2);if(g<1){l[0]===o[0]&&l[1]===o[1]||(i.push(`L${l[0]},${l[1]}`),o=l.slice());continue}let m=l.slice();0!==d[0]?m[0]=l[0]-Math.sign(d[0])*g:m[1]=l[1]-Math.sign(d[1])*g;let f=l.slice();0!==u[0]?f[0]=l[0]+Math.sign(u[0])*g:f[1]=l[1]+Math.sign(u[1])*g,m[0]===o[0]&&m[1]===o[1]||i.push(`L${m[0]},${m[1]}`);const y=d[0]*u[1]-d[1]*u[0]<0?0:1;i.push(`A${g},${g} 0 0 ${y} ${f[0]},${f[1]}`),r+=2*g,n++,o=f}const a=s[s.length-1];return a[0]===o[0]&&a[1]===o[1]||i.push(`L${a[0]},${a[1]}`),n?(yc("routing.arc.apply",1),{...e,d:i.join(" "),meta:{...e.meta,arc:{count:n,trimPx:Math.round(r)}}}):(yc("routing.arc.none",1),null)}_applySmoothing(e,t){const s=t.smoothingMode;if("none"===s||t.smoothingIterations<=0)return null;let n=Math.min(5,Math.max(1,0|t.smoothingIterations));if(!Array.isArray(e.pts)||e.pts.length<3)return null;if("chaikin"!==s)return null;let r=e.pts.map((e=>[e[0],e[1]]));for(let e=0;e<n;e++){const e=[r[0]];for(let s=0;s<r.length-1;s++){const n=r[s],i=r[s+1],o=[.75*n[0]+.25*i[0],.75*n[1]+.25*i[1]],a=[.25*n[0]+.75*i[0],.25*n[1]+.75*i[1]];if(e.push(o,a),e.length>=t.smoothingMaxPoints)break}if(e.push(r[r.length-1]),r=e,r.length>=t.smoothingMaxPoints)break}const i=r.reduce(((e,t,s)=>e+(s?` L${t[0]},${t[1]}`:`M${t[0]},${t[1]}`)),""),o={...e.meta,smooth:{mode:s,iterations:n,points:r.length,addedPoints:r.length-e.pts.length}};return yc("routing.smooth.apply",1),{...e,d:i,pts:r,meta:o}}}class wc{constructor(){this.a=[]}push(e){this.a.push(e),this._up(this.a.length-1)}pop(){if(!this.a.length)return null;const e=this.a[0],t=this.a.pop();return this.a.length&&(this.a[0]=t,this._down(0)),e}isEmpty(){return 0===this.a.length}_up(e){for(;e>0;){const t=e-1>>1;if(this.a[t].f<=this.a[e].f)break;[this.a[t],this.a[e]]=[this.a[e],this.a[t]],e=t}}_down(e){const t=this.a.length;for(;;){let s=2*e+1,n=s+1,r=e;if(s<t&&this.a[s].f<this.a[r].f&&(r=s),n<t&&this.a[n].f<this.a[r].f&&(r=n),r===e)break;[this.a[r],this.a[e]]=[this.a[e],this.a[r]],e=r}}}function Sc(e){return function(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return Math.abs(t).toString(36)}($c(xc(e)))}function xc(e){if(null==e)return null;if("object"!=typeof e)return e;if(Array.isArray(e))return e.map(xc);const t={};return Object.keys(e).sort().forEach((s=>{t[s]=xc(e[s])})),t}function $c(e){if("object"!=typeof e||null===e)return JSON.stringify(e);if(Array.isArray(e))return"["+e.map($c).join(",")+"]";const t=Object.keys(e).sort().map((t=>`"${t}":${$c(e[t])}`));return"{"+t.join(",")+"}"}class Cc{constructor(){this.cache=new Map,this.instanceToHash=new WeakMap,this.usageStats=new Map,this.maxCacheSize=500,this.cleanupThreshold=600,this.perfStats={cacheHits:0,cacheMisses:0,instancesCreated:0,instancesReused:0,cleanupRuns:0}}getOrCreateInstance(e,t){return Dl("animation.getInstance",(()=>{const s=this.computeInstanceHash(e);if(this.cache.has(s)){const e=this.cache.get(s);if(this.targetsCompatible(e.targets,t))return this.recordCacheHit(s),Tl("animation.instance.reuse",1),this.perfStats.instancesReused++,this.reuseInstance(e,t);this.cache.delete(s),this.perfStats.cacheMisses++}const n=this.createAnimationInstance(e,t);return this.cacheInstance(s,n,e),Tl("animation.instance.new",1),this.perfStats.instancesCreated++,this.perfStats.cacheMisses++,n}))}computeInstanceHash(e){const t={preset:e.preset,params:this.normalizeParams(e.params),duration:this.normalizeNumber(e.duration),easing:e.easing,loop:e.loop,alternate:e.alternate,delay:this.normalizeNumber(e.delay)};return e.animation_ref&&(t.animation_ref=e.animation_ref,e.override&&(t.override=this.normalizeParams(e.override.params))),Sc(t)}normalizeNumber(e){return"number"==typeof e?Math.round(1e3*e)/1e3:e}normalizeParams(e){if(!e||"object"!=typeof e)return e;const t={};return Object.entries(e).forEach((([e,s])=>{"number"==typeof s?t[e]=Math.round(1e3*s)/1e3:Array.isArray(s)?t[e]=s.map((e=>"number"==typeof e?Math.round(1e3*e)/1e3:e)):t[e]="object"==typeof s&&null!==s?this.normalizeParams(s):s})),t}targetsCompatible(e,t){if(!e||!t)return!1;const s=Array.isArray(e)?e:[e],n=Array.isArray(t)?t:[t];if(s.length!==n.length)return!1;for(let e=0;e<s.length;e++){const t=s[e],r=n[e];if("string"!=typeof t||"string"!=typeof r){if(!t?.id||!r?.id)return!1;if(t.id!==r.id)return!1}else if(t!==r)return!1}return!0}createAnimationInstance(e,t){try{return"undefined"!=typeof window&&window.cblcars?.anim?.create?window.cblcars.anim.create(e,t):{definition:{...e},targets:Array.isArray(t)?[...t]:[t],id:`anim_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,play:()=>{},pause:()=>{},stop:()=>{},restart:()=>{}}}catch(e){return console.warn("[AnimationRegistry] Failed to create animation instance:",e),null}}reuseInstance(e,t){try{return e.retarget&&"function"==typeof e.retarget?e.retarget(t):{...e,targets:Array.isArray(t)?[...t]:[t],id:`${e.id}_reused_${Date.now()}`}}catch(s){return console.warn("[AnimationRegistry] Failed to reuse animation instance:",s),this.createAnimationInstance(e.definition,t)}}cacheInstance(e,t,s){this.cache.set(e,{instance:t,definition:s,targets:t.targets,createdAt:Date.now(),hash:e}),this.usageStats.set(e,{count:1,lastUsed:Date.now(),hash:e}),this.instanceToHash.set(t,e),this.cache.size>this.maxCacheSize&&this.cleanupCache()}recordCacheHit(e){const t=this.usageStats.get(e);t&&(t.count++,t.lastUsed=Date.now()),this.perfStats.cacheHits++}cleanupCache(){Dl("animation.cache.cleanup",(()=>{const e=Array.from(this.usageStats.entries());e.sort((([,e],[,t])=>e.lastUsed-t.lastUsed));const t=e.slice(0,e.length-this.maxCacheSize);t.forEach((([e])=>{this.cache.delete(e),this.usageStats.delete(e)})),this.perfStats.cleanupRuns++,Tl("animation.cache.cleanup",t.length)}))}getStats(){const e={...this.perfStats};return e.cacheSize=this.cache.size,e.hitRate=e.cacheHits/(e.cacheHits+e.cacheMisses)||0,e.reuseRate=e.instancesReused/(e.instancesReused+e.instancesCreated)||0,e}getCacheContents(){const e={};return this.cache.forEach(((t,s)=>{const n=this.usageStats.get(s);e[s]={definition:t.definition,createdAt:t.createdAt,usage:n?{count:n.count,lastUsed:n.lastUsed}:null}})),e}clear(){this.cache.clear(),this.usageStats.clear(),this.perfStats={cacheHits:0,cacheMisses:0,instancesCreated:0,instancesReused:0,cleanupRuns:0},Tl("animation.cache.cleared",1)}exportStats(e={}){const t=this.getStats();return e.includeCache&&(t.cacheContents=this.getCacheContents()),"csv"===e.format?this.exportToCsv(t):JSON.stringify(t,null,2)}exportToCsv(e){return["metric,value",`cacheHits,${e.cacheHits}`,`cacheMisses,${e.cacheMisses}`,`instancesCreated,${e.instancesCreated}`,`instancesReused,${e.instancesReused}`,`cacheSize,${e.cacheSize}`,`hitRate,${e.hitRate.toFixed(3)}`,`reuseRate,${e.reuseRate.toFixed(3)}`,`cleanupRuns,${e.cleanupRuns}`].join("\n")}}const kc=new Cc,Ac="undefined"!=typeof window?window:r.g;Ac&&(Ac.__msdAnimRegistry={registry:kc,getStats:()=>kc.getStats(),getCacheContents:()=>kc.getCacheContents(),clear:()=>kc.clear(),export:e=>kc.exportStats(e)});const Mc=new class{constructor(e=1e3){this.buffer=[],this.maxSize=e,this.index=0,this.totalTraces=0}addTrace(e,t,s,n,r={}){const i={ruleId:e,matched:t,conditions:s,evaluationTime:n,timestamp:Date.now(),metadata:{...r}};this.buffer.length<this.maxSize?this.buffer.push(i):(this.buffer[this.index]=i,this.index=(this.index+1)%this.maxSize),this.totalTraces++}getRecentTraces(e=50,t={}){const s=[];let n=this.index-1;for(let r=0;r<Math.min(e,this.buffer.length);r++){n<0&&(n=this.buffer.length-1);const e=this.buffer[n];this.matchesFilter(e,t)&&s.unshift(e),n--}return s}getRuleHistory(e,t=20){return this.getRecentTraces(this.buffer.length,{ruleId:e}).slice(0,t)}getMatchedRules(e=6e4,t=100){const s=Date.now()-e;return this.getRecentTraces(this.buffer.length,{matched:!0}).filter((e=>e.timestamp>s)).slice(0,t)}getStats(){const e=this.getRecentTraces(this.buffer.length),t=e.filter((e=>e.matched)).length,s=e.length>0?e.reduce(((e,t)=>e+t.evaluationTime),0)/e.length:0;return{totalTraces:this.totalTraces,bufferedTraces:this.buffer.length,recentMatched:t,recentTotal:e.length,matchRate:e.length>0?t/e.length:0,avgEvaluationTime:s}}matchesFilter(e,t){return!(t.ruleId&&e.ruleId!==t.ruleId||void 0!==t.matched&&e.matched!==t.matched||t.minTime&&e.timestamp<t.minTime||t.maxTime&&e.timestamp>t.maxTime||t.minEvalTime&&e.evaluationTime<t.minEvalTime)}clear(){this.buffer=[],this.index=0,this.totalTraces=0}exportTraces(e={}){const{format:t="json",limit:s=100,includeConditions:n=!0,includeMetadata:r=!1}=e,i=this.getRecentTraces(s).map((e=>{const t={ruleId:e.ruleId,matched:e.matched,evaluationTime:e.evaluationTime,timestamp:e.timestamp};return n&&(t.conditions=e.conditions),r&&(t.metadata=e.metadata),t}));return"csv"===t?this.exportToCsv(i):JSON.stringify(i,null,2)}exportToCsv(e){if(0===e.length)return"No traces available\n";const t=e.map((e=>[e.ruleId,e.matched,e.evaluationTime.toFixed(3),new Date(e.timestamp).toISOString()]));return[["ruleId","matched","evaluationTime","timestamp"].join(","),...t.map((e=>e.join(",")))].join("\n")}},Dc="undefined"!=typeof window?window:r.g;Dc&&(Dc.__msdRuleTrace={buffer:Mc,getRecent:e=>Mc.getRecentTraces(e),getStats:()=>Mc.getStats(),getRuleHistory:e=>Mc.getRuleHistory(e),export:e=>Mc.exportTraces(e),clear:()=>Mc.clear()});class Ec{constructor(e=[]){this.rules=Array.isArray(e)?e:[],this.rulesById=new Map,this.dependencyIndex=null,this.dirtyRules=new Set,this.lastEvaluation=new Map,this.traceBuffer=Mc,this.stopProcessing=new Map,this.evalCounts={total:0,dirty:0,matched:0,skipped:0},this.buildRulesIndex(),this.buildDependencyIndex(),this.markAllDirty()}buildRulesIndex(){this.rulesById.clear(),this.rules.forEach((e=>{e.id&&this.rulesById.set(e.id,e)}))}buildDependencyIndex(){const e=new Map,t=new Map;this.rules.forEach((s=>{const n=this.extractEntityReferences(s);t.set(s.id,n),n.forEach((t=>{e.has(t)||e.set(t,new Set),e.get(t).add(s.id)}))})),this.dependencyIndex={entityToRules:e,ruleToEntities:t};try{const s="undefined"!=typeof window?window:r.g;s.__msdDebug&&(s.__msdDebug.rulesDeps={entityToRules:Object.fromEntries(e),ruleToEntities:Object.fromEntries(t),totalEntities:e.size,totalRules:this.rules.length})}catch(e){}}extractEntityReferences(e){const t=new Set;return e.when?([...e.when.all||[],...e.when.any||[]].forEach((e=>{if(e.entity&&t.add(e.entity),e.entity_attr){const s=e.entity_attr.split(".")[0];t.add(s)}e.map_range_cond?.entity&&t.add(e.map_range_cond.entity),e.value_map?.entity&&t.add(e.value_map.entity)})),Array.from(t)):Array.from(t)}markEntitiesDirty(e){Array.isArray(e)||(e=[e]);let t=0;return e.forEach((e=>{const s=this.dependencyIndex.entityToRules.get(e);s&&s.forEach((e=>{this.dirtyRules.has(e)||(this.dirtyRules.add(e),t++)}))})),Tl("rules.dirty.entities",e.length),Tl("rules.dirty.affected",t),t}markAllDirty(){this.dirtyRules.clear(),this.rules.forEach((e=>{e.id&&this.dirtyRules.add(e.id)})),Tl("rules.dirty.all",this.dirtyRules.size)}evaluateDirty(e={}){return Dl("rules.evaluate",(()=>{const{getEntity:t}=e;if(!t||"function"!=typeof t)return console.warn("[RulesEngine] evaluateDirty called without getEntity function"),this.createEmptyResult();const s=this.dirtyRules.size,n=[],r=new Set,i=Array.from(this.dirtyRules).map((e=>this.rulesById.get(e))).filter((e=>e)).sort(((e,t)=>(t.priority||0)-(e.priority||0)));return i.forEach((e=>{if(r.has(e.id))return;const s=this.evaluateRule(e,t);r.add(e.id),this.lastEvaluation.set(e.id,{matched:s.matched,timestamp:Date.now(),conditions:s.conditions}),s.matched&&(n.push(s),this.evalCounts.matched++),this.dirtyRules.delete(e.id)})),this.evalCounts.total+=s,this.evalCounts.dirty+=s,this.evalCounts.skipped+=this.rules.length-s,Tl("rules.eval.total",s),Tl("rules.eval.matched",n.length),Tl("rules.eval.skipped",this.rules.length-s),this.aggregateResults(n)}))}evaluateRule(e,t){const s=performance.now();try{const n=this.evaluateConditions(e.when,t),r=this.determineMatch(e.when,n),i=performance.now()-s,o={ruleId:e.id,priority:e.priority||0,matched:r,conditions:n,rule:e,evaluationTime:i};return this.traceBuffer.addTrace(e.id,r,n,i,{priority:e.priority||0,conditionCount:this.countConditions(e.when),entityRefs:this.dependencyIndex?.ruleToEntities.get(e.id)||[]}),r&&e.apply&&(o.overlayPatches=e.apply.overlays||[],o.profilesAdd=e.apply.profiles_add||[],o.profilesRemove=e.apply.profiles_remove||[],o.animations=e.apply.animations||[],o.stopAfter=!0===e.stop),o}catch(t){const n=performance.now()-s;return this.traceBuffer.addTrace(e.id,!1,{},n,{error:t.message}),console.warn(`[RulesEngine] Error evaluating rule ${e.id}:`,t),{ruleId:e.id,matched:!1,error:t.message,evaluationTime:n}}}evaluateConditions(e,t){if(!e)return{};const s={};return e.all&&(s.all=e.all.map((e=>this.evaluateCondition(e,t)))),e.any&&(s.any=e.any.map((e=>this.evaluateCondition(e,t)))),s}evaluateCondition(e,t){const s={condition:e,matched:!1,value:null,error:null};try{if(e.entity){const n=t(e.entity);if(!n)return s.error=`Entity ${e.entity} not found`,s;if(s.value=n.state,void 0!==e.above){const t=parseFloat(n.state);s.matched=!isNaN(t)&&t>e.above}else if(void 0!==e.below){const t=parseFloat(n.state);s.matched=!isNaN(t)&&t<e.below}else void 0!==e.equals?s.matched=n.state==e.equals:s.matched=!0}e.time_between&&(s.matched=this.evaluateTimeBetween(e.time_between),s.value=(new Date).toTimeString().substring(0,5)),e.map_range_cond&&(s.matched=this.evaluateMapRangeCondition(e.map_range_cond,t))}catch(e){s.error=e.message}return s}evaluateTimeBetween(e){const[t,s]=e.split("-"),n=new Date,r=60*n.getHours()+n.getMinutes(),[i,o]=t.split(":").map(Number),[a,l]=s.split(":").map(Number),c=60*i+o,d=60*a+l;return c<=d?r>=c&&r<=d:r>=c||r<=d}evaluateMapRangeCondition(e,t){const{entity:s,input:n,output:r,above:i,below:o,equals:a}=e,l=t(s);if(!l)return!1;const c=parseFloat(l.state);if(isNaN(c))return!1;const d=this.mapRange(c,n,r);return void 0!==i?d>i:void 0!==o?d<o:void 0!==a&&Math.abs(d-a)<.001}mapRange(e,t,s){const[n,r]=t,[i,o]=s;return i+(Math.max(n,Math.min(r,e))-n)/(r-n)*(o-i)}determineMatch(e,t){if(!e)return!1;let s=!0,n=!1;return e.all&&t.all&&(s=t.all.every((e=>e.matched))),e.any&&t.any&&(n=t.any.some((e=>e.matched))),e.all&&e.any?s&&n:e.all?s:!!e.any&&n}aggregateResults(e){const t={overlayPatches:[],profilesAdd:[],profilesRemove:[],animations:[]},s=new Map;return e.forEach((e=>{e.overlayPatches&&e.overlayPatches.forEach((t=>{s.has(t.id)||s.set(t.id,[]),s.get(t.id).push({...e,overlayPatch:t})}))})),s.forEach(((e,s)=>{this.processOverlayRules(s,e,t)})),e.sort(((e,t)=>(t.priority||0)-(e.priority||0))).forEach((e=>{e.profilesAdd&&t.profilesAdd.push(...e.profilesAdd),e.profilesRemove&&t.profilesRemove.push(...e.profilesRemove),e.animations&&t.animations.push(...e.animations)})),t}processOverlayRules(e,t,s){const n=t.sort(((e,t)=>(t.priority||0)-(e.priority||0)));let r=!1;n.forEach((t=>{if(r)return this.traceBuffer.addTrace(t.ruleId,t.matched,t.conditions,t.evaluationTime,{stopped:!0,stoppedBy:e,reason:"stop_semantics"}),void Tl("rules.stopped",1);t.overlayPatch&&s.overlayPatches.push(t.overlayPatch),t.stopAfter&&(r=!0,Tl("rules.stop.triggered",1),this.traceBuffer.addTrace(t.ruleId,t.matched,t.conditions,t.evaluationTime,{stopTriggered:!0,affectedOverlay:e}))}))}countConditions(e){return e?(e.all?.length||0)+(e.any?.length||0):0}createEmptyResult(){return{overlayPatches:[],profilesAdd:[],profilesRemove:[],animations:[]}}getTrace(){const e={totalRules:this.rules.length,dirtyRules:this.dirtyRules.size,lastEvaluations:Object.fromEntries(this.lastEvaluation),evalCounts:{...this.evalCounts},dependencyStats:{entitiesTracked:this.dependencyIndex?.entityToRules.size||0,avgRulesPerEntity:this.dependencyIndex?Array.from(this.dependencyIndex.entityToRules.values()).reduce(((e,t)=>e+t.size),0)/this.dependencyIndex.entityToRules.size:0}},t=this.traceBuffer.getStats();return e.traceStats=t,e}getRuleTrace(e,t=20){return this.traceBuffer.getRuleHistory(e,t)}getRecentMatches(e=6e4){return this.traceBuffer.getMatchedRules(e)}exportTrace(e={}){return this.traceBuffer.exportTraces(e)}clearTrace(){this.traceBuffer.clear(),Tl("rules.trace.cleared",1)}getRuleDependencies(e){return this.dependencyIndex?.ruleToEntities.get(e)||[]}getEntityDependents(e){return Array.from(this.dependencyIndex?.entityToRules.get(e)||[])}}class Tc{constructor(){this.state={anchors:!1,bounding_boxes:!1,routing:!1,performance:!1,scale:1},this.callbacks=new Set,this.initialized=!1,this.routerReady=!1,this.pendingRouterActions=[],this.pendingInitActions=[],this._notifyTimeout=null,this._pendingNotification=null}init(e={}){e&&Object.keys(e).length>0&&console.log("[DebugManager] Initializing with config:",e),e.overlays?Object.keys(this.state).forEach((t=>{"scale"!==t&&void 0!==e.overlays[t]&&(this.state[t]=e.overlays[t])})):Object.keys(this.state).forEach((t=>{void 0!==e[t]&&(this.state[t]=e[t])})),void 0!==e.scale&&(this.state.scale=e.scale),this.initialized=!0,this.isAnyEnabled()&&console.log("[DebugManager] State after config init:",this.state),this.pendingInitActions.forEach((e=>e())),this.pendingInitActions=[],this.routerReady&&(this.pendingRouterActions.forEach((e=>e())),this.pendingRouterActions=[]),this._scheduleNotification("init")}markRouterReady(){this.routerReady=!0,this.initialized&&(this.pendingRouterActions.forEach((e=>e())),this.pendingRouterActions=[],this._scheduleNotification("router-ready"))}enable(e){this._setFeature(e,!0)}disable(e){this._setFeature(e,!1)}toggle(e){this._setFeature(e,!this.state[e])}setScale(e){this._executeWhenReady((()=>{const t=Math.max(.1,Math.min(3,Number(e)||1));t!==this.state.scale&&(this.state.scale=t,this._scheduleNotification("scale",{scale:t}))}),!1)}getSnapshot(){return{...this.state,enabled:this.isAnyEnabled(),initialized:this.initialized,routerReady:this.routerReady}}status(){const e=this.getSnapshot();return console.table(e),e}isAnyEnabled(){return["anchors","bounding_boxes","routing","performance"].some((e=>this.state[e]))}canRenderRouting(){return this.state.routing&&this.routerReady}onChange(e){return this.callbacks.add(e),()=>this.callbacks.delete(e)}enableMultiple(e){e.forEach((e=>this.enable(e)))}disableMultiple(e){e.forEach((e=>this.disable(e)))}getAvailableFeatures(){return Object.keys(this.state).filter((e=>"scale"!==e))}isEnabled(e){return Boolean(this.state[e])}_scheduleNotification(e,t){this._notifyTimeout&&clearTimeout(this._notifyTimeout),this._pendingNotification={type:e,details:t},this._notifyTimeout=setTimeout((()=>{this._pendingNotification&&(this._notifyChange(this._pendingNotification.type,this._pendingNotification.details),this._pendingNotification=null),this._notifyTimeout=null}),16)}_notifyChange(e,t={}){const s={type:e,details:t,snapshot:this.getSnapshot(),timestamp:Date.now()};this.callbacks.forEach((e=>{try{e(s)}catch(e){console.warn("[DebugManager] Callback error:",e)}}))}_setFeature(e,t){if(!this.state.hasOwnProperty(e)||"scale"===e)return void console.warn(`[DebugManager] Invalid debug feature: ${e}`);const s="routing"===e;this._executeWhenReady((()=>{this.state[e]!==t&&(console.log(`[DebugManager] Setting ${e} to ${t}`),this.state[e]=t,this._scheduleNotification("feature",{feature:e,enabled:t}),setTimeout((()=>{try{const s=window.__msdDebug?.pipelineInstance;s?.reRender&&(console.log(`[DebugManager] Auto re-render after ${e} ${t?"enable":"disable"}`),s.reRender())}catch(e){console.warn("[DebugManager] Auto re-render failed:",e)}}),5))}),s)}_executeWhenReady(e,t=!1){this.initialized?!t||this.routerReady?e():this.pendingRouterActions.push(e):this.pendingInitActions.push((()=>this._executeWhenReady(e,t)))}}class Rc{constructor(){this.dataSourceManager=null,this.renderer=null,this.debugRenderer=null,this.controlsRenderer=null,this.hudManager=null,this.router=null,this.animRegistry=null,this.rulesEngine=null,this.debugManager=new Tc,this._renderTimeout=null,this._reRenderCallback=null,this._renderInProgress=!1,this._debugControlsRendering=!1,this.mergedConfig=null,this._originalHass=null,this._currentHass=null}async initializeSystems(e,t,s,n){console.log("[MSD v1] Initializing runtime systems"),this.mergedConfig=e,this._currentHass=n;const r=e.debug||{};if(console.log("[MSD v1] Raw debug config from mergedConfig:",r),this.debugManager.init(r),console.log("[MSD v1] DebugManager initialized with config:",r),this.rulesEngine=new Ec(e.rules),this.rulesEngine.markAllDirty(),this._instrumentRulesEngine(e),await this._initializeDataSources(n,e),this.dataSourceManager){const e=this._createEntityChangeHandler();this.dataSourceManager.addEntityChangeListener(e),console.log("[MSD v1] DataSourceManager connected to rules engine"),console.log("[MSD v1] DataSourceManager entity count:",this.dataSourceManager.listIds().length)}else console.warn("[MSD v1] DataSourceManager not initialized - no data sources configured or HASS unavailable");return this.router=new vc(e.routing,t.anchors,t.viewBox),this.renderer=new Wl(s,this.router),this.debugRenderer=new Yl,this.controlsRenderer=new Xl(this.renderer),this._currentHass&&this.controlsRenderer&&(console.log("[MSD v1] Setting initial HASS context on controls renderer"),this.controlsRenderer.setHass(this._currentHass)),this.hudManager=new cc,this.hudManager.init(s),this._setupGlobalHudInterface(),this.debugRenderer.init(this),this.debugManager.markRouterReady(),console.log("[MSD v1] RouterCore marked ready for debug system"),this.animRegistry=new Cc,this.mergedConfig&&this.mergedConfig.overlays&&(console.log("[MSD v1] Applying status indicator fix to prevent NaN coordinate errors"),this.mergedConfig.overlays=this.mergedConfig.overlays.map((e=>e&&e.status_indicator?(console.log(`[MSD v1] DISABLED status indicator for ${e.id} to prevent NaN coordinates`),{...e,status_indicator:!1}):e))),console.log("[MSD v1] All systems initialized successfully"),this}setReRenderCallback(e){this._reRenderCallback=e}_createEntityChangeHandler(){return(e,t=null)=>{const s=Date.now();console.log("[MSD DEBUG] 🔔 Entity change handler TRIGGERED:",{timestamp:(new Date).toISOString(),changedIds:e,hasEnhancedData:!!t,stackTrace:(new Error).stack.split("\n").slice(1,5).join("\n"),renderTimeout:!!this._renderTimeout,renderInProgress:!!this._renderInProgress});const n=this._extractControlEntities(this.mergedConfig),r=e.filter((e=>n.includes(e)));r.length>0&&this.controlsRenderer&&(console.log("[SystemsManager] 📡 Control entities changed:",r),console.log("[SystemsManager] ℹ️ Direct subscription will handle these updates automatically"));const i=this.getCurrentHass();if(i&&this.dataSourceManager){console.log("[MSD DEBUG] 📤 Refreshing MSD internal HASS context with converted entity states");const t={};e.forEach((e=>{const s=this.dataSourceManager.getEntity(e);s&&void 0!==s.state?(t[e]={state:s.state.toString(),last_changed:(new Date).toISOString(),last_updated:(new Date).toISOString(),attributes:s.attributes||i.states[e]?.attributes||{},entity_id:e,context:{id:Date.now().toString(),user_id:null}},console.log("[MSD DEBUG] 🔄 Updated MSD internal state for",e,{originalState:this._originalHass?.states[e]?.state,convertedState:t[e].state,rawValue:s.state})):console.log("[MSD DEBUG] ⚠️ No data source found for entity:",e,"(entity will not be updated in MSD internal HASS)")})),Object.keys(t).length>0?(this._currentHass={...i,states:{...i.states,...t}},console.log("[MSD DEBUG] ✅ MSD internal HASS context refreshed with",Object.keys(t).length,"converted entities")):console.log("[MSD DEBUG] ℹ️ No data source entities changed - MSD internal HASS unchanged")}else console.log("[MSD DEBUG] ⚠️ Skipping MSD internal HASS update:",{hasWorkingHass:!!i,hasDataSourceManager:!!this.dataSourceManager,dataSourceManagerIsNull:null===this.dataSourceManager});if(this.rulesEngine){const t=e.filter((e=>this.dataSourceManager&&this.dataSourceManager.getEntity(e)));t.length>0?(this.rulesEngine.markEntitiesDirty(t),console.log("[MSD DEBUG] 📏 Marked rules dirty for data source entities:",t)):console.log("[MSD DEBUG] 📏 No data source entities to mark dirty in rules engine")}else console.log("[MSD DEBUG] ⚠️ No rules engine available to mark dirty");this._renderTimeout&&(console.log("[MSD DEBUG] ⏰ Clearing existing render timeout"),clearTimeout(this._renderTimeout));const o=e.some((e=>n.includes(e))),a=e.some((e=>this.dataSourceManager&&this.dataSourceManager.getEntity(e)));this._lastEntityAnalysis={isControlTriggered:o,hasDataSourceChanges:a,timestamp:s,changedIds:e,controlEntities:n,matchingEntities:e.filter((e=>n.includes(e)))},console.log("[MSD DEBUG] 🎯 Entity change analysis:",this._lastEntityAnalysis),o&&!a?console.log("[MSD DEBUG] ⏭️ SKIPPING re-render - only control entities changed (no data sources affected)"):a?(console.log("[MSD DEBUG] 🔄 Scheduling re-render for data source entity changes"),this._renderTimeout=setTimeout((()=>{if(this._reRenderCallback&&!this._renderInProgress)try{this._renderInProgress=!0,console.log("[MSD DEBUG] 🚀 TRIGGERING re-render from data source entity change timeout"),this._reRenderCallback()}catch(e){console.error("[MSD DEBUG] ❌ Re-render FAILED in entity change handler:",e)}finally{this._renderInProgress=!1}this._renderTimeout=null}),100)):console.log("[MSD DEBUG] ⏭️ SKIPPING re-render - no relevant entity changes for MSD")}}setOriginalHass(e){console.log("[SystemsManager] 📚 Setting original HASS reference:",{hasStates:!!e?.states,entityCount:e?.states?Object.keys(e.states).length:0,hasAuth:!!e?.auth,hasConnection:!!e?.connection,lightDeskState:e?.states?.["light.desk"]?.state,timestamp:(new Date).toISOString()}),this._originalHass=e,this._currentHass||(this._currentHass=e,console.log("[SystemsManager] 📚 Also setting _currentHass (first time)")),this.setupDirectHassSubscription(e)}getCurrentHass(){return this._currentHass}getOriginalHass(){return this._originalHass}_instrumentRulesEngine(e){try{const t=new Map;(e.rules||[]).forEach((e=>{(e.when&&(e.when.all||e.when.any)||[]).forEach((s=>{const n=s?.entity;n&&(t.has(n)||t.set(n,new Set),t.get(n).add(e.id))}))})),this.rulesEngine.__hudDeps=t;const s="undefined"!=typeof window?window:{};s.__msdDebug=s.__msdDebug||{};const n=s.__msdDebug.__perfStore=s.__msdDebug.__perfStore||{counters:{},timings:{}};function r(e,t=1){n.counters[e]=(n.counters[e]||0)+t}if(!this.rulesEngine.__perfWrapped&&"function"==typeof this.rulesEngine.evaluateDirty){const i=this.rulesEngine.evaluateDirty;this.rulesEngine.evaluateDirty=function(){r("rules.eval.count",(e.rules||[]).length||0);const t=i.apply(this,arguments);try{const e=this.getTrace&&this.getTrace()||[],t=Array.isArray(e)?e.filter((e=>e&&e.matched)).length:0;r("rules.match.count",t)}catch{}return t},this.rulesEngine.__perfWrapped=!0}}catch(o){console.warn("[MSD v1][rules instrumentation] failed",o)}}async _initializeDataSources(e,t){if(this.dataSourceManager=null,!e)return void console.warn("[MSD v1] No HASS provided - DataSourceManager will not be initialized");const s=t.data_sources||{};console.log("[MSD v1] 🔍 Using explicit-only data sources mode"),console.log("[MSD v1] 🔍 Configured data sources:",Object.keys(s));const n=this._extractControlEntities(t);console.log("[MSD v1] 🔍 Control entities (using direct HASS):",n);const r={...s};if(console.log("[MSD v1] 📊 Data source summary:",{configured:Object.keys(s).length,total:Object.keys(r).length,allDataSourceIds:Object.keys(r)}),0===Object.keys(r).length)return console.log("[MSD v1] No explicit data sources configured - DataSourceManager will not be initialized"),void console.log("[MSD v1] Note: Control overlays will use direct HASS (no data sources needed)");console.log("[MSD v1] Initializing DataSourceManager with",Object.keys(r).length,"explicit data sources");try{this.dataSourceManager=new mc(e);const t=await this.dataSourceManager.initializeFromConfig(r);console.log("[MSD v1] ✅ DataSourceManager initialized -",t,"sources started");const s=this.dataSourceManager.listIds();console.log("[MSD v1] ✅ DataSourceManager entities available:",s)}catch(e){console.error("[MSD v1] ❌ DataSourceManager initialization failed:",e),console.error("[MSD v1] Error details:",e.stack),this.dataSourceManager=null}}_extractControlEntities(e){const t=new Set;return(e.overlays||[]).forEach((e=>{if("control"===e.type&&e.card){const s=e.card.config?.entity||e.card.config?.variables?.entity||e.card.entity;s&&t.add(s)}})),Array.from(t)}destroy(){this.debugRenderer&&this.debugRenderer.destroy(),this._renderTimeout&&(clearTimeout(this._renderTimeout),this._renderTimeout=null),this._reRenderCallback=null}async renderDebugAndControls(e,t=null){if(this._debugControlsRendering)console.log("[SystemsManager] renderDebugAndControls already in progress, skipping");else{this._debugControlsRendering=!0;try{const s=this.debugManager.getSnapshot();if(console.log("[SystemsManager] renderDebugAndControls called:",{anyEnabled:this.debugManager.isAnyEnabled(),controlOverlays:e.overlays.filter((e=>"control"===e.type)).length,hasHass:!!this._currentHass,hasResolvedModel:!!e,hasOverlays:!!e?.overlays}),!e||!e.overlays)return void console.warn("[SystemsManager] Invalid resolved model for renderDebugAndControls");if(this.debugManager.isAnyEnabled())try{const n={anchors:e.anchors||{},overlays:e.overlays||[],showAnchors:s.anchors,showBoundingBoxes:s.bounding_boxes,showRouting:this.debugManager.canRenderRouting(),showPerformance:s.performance,scale:s.scale};this.debugRenderer.render(t||this.renderer?.mountEl,e.viewBox,n),console.log("[SystemsManager] ✅ Debug renderer completed")}catch(e){console.error("[SystemsManager] ❌ Debug renderer failed:",e)}const n=e.overlays.filter((e=>"control"===e.type));if(n.length>0){console.log("[SystemsManager] Rendering control overlays:",n.map((e=>e.id)));try{if(!this.controlsRenderer)return void console.error("[SystemsManager] No controls renderer available");this._currentHass&&this.controlsRenderer?(this.controlsRenderer.setHass(this._currentHass),console.log("[SystemsManager] HASS context applied to controls renderer")):console.warn("[SystemsManager] No HASS context available for controls");const t=this.controlsRenderer.renderControls(n,e),s=new Promise(((e,t)=>setTimeout((()=>t(new Error("Controls render timeout"))),5e3)));await Promise.race([t,s]),console.log("[SystemsManager] ✅ Controls rendered successfully")}catch(e){console.error("[SystemsManager] ❌ Controls rendering failed:",e),console.error("[SystemsManager] Error stack:",e.stack)}}}catch(e){console.error("[SystemsManager] renderDebugAndControls failed completely:",e),console.error("[SystemsManager] Error stack:",e.stack)}finally{this._debugControlsRendering=!1}}}_shouldRenderDebugFromConfig(e){return!(!e||!e.overlays)&&(e.overlays.anchors||e.overlays.bounding_boxes||e.overlays.routing||e.overlays.performance)}_getDebugFlags(){return window.cblcars?._debugFlags||{}}_shouldRenderDebug(e){return e&&(e.overlay||e.connectors||e.geometry)}ingestHass(e){console.log("[SystemsManager] ingestHass called with:",{hasHass:!!e,hasStates:!!e?.states,entityCount:e?.states?Object.keys(e.states).length:0,hasLightDesk:!!e?.states?.["light.desk"],lightDeskState:e?.states?.["light.desk"]?.state,timestamp:(new Date).toISOString()}),e&&e.states?(this._currentHass=e,this._originalHass=e,console.log("[SystemsManager] Updated both _currentHass and _originalHass with fresh data"),this.controlsRenderer?(console.log("[SystemsManager] Updating HASS context in controls renderer immediately"),this.controlsRenderer.setHass(e)):console.warn("[SystemsManager] No controls renderer available for HASS update"),console.log("[MSD v1] HASS ingestion handled by individual data sources")):console.warn("[MSD v1] ingestHass called without valid hass.states")}updateEntities(e){e&&"object"==typeof e&&(console.log("[MSD v1] Manual entity updates not supported in DataSources system"),console.warn("[MSD v1] Use direct HASS state updates instead of manual entity updates"))}listEntities(){return this.dataSourceManager?this.dataSourceManager.listIds():[]}getEntity(e){return this.dataSourceManager?this.dataSourceManager.getEntity(e):null}setupDirectHassSubscription(e){e&&e.connection&&!this._directHassSubscription&&(console.log("[SystemsManager] 🔗 Setting up direct HASS subscription for fresh control updates"),this._directHassSubscription=e.connection.subscribeEvents((e=>{if("state_changed"===e.event_type&&e.data&&e.data.entity_id){const t=e.data.entity_id,s=e.data.new_state;if(this._extractControlEntities(this.mergedConfig).includes(t)&&s&&(console.log("[SystemsManager] 📡 Direct HASS update for control entity:",t,"new state:",s.state),this._originalHass&&this._originalHass.states)){const e={...this._originalHass,states:{...this._originalHass.states,[t]:s}};console.log("[SystemsManager] 📊 Updated HASS with fresh state for",t,":",s.state),this._originalHass=e,this._currentHass=e,this.controlsRenderer&&(console.log("[SystemsManager] 📤 Immediately forwarding fresh HASS to controls"),this.controlsRenderer.setHass(e))}}}),"state_changed"),console.log("[SystemsManager] ✅ Direct HASS subscription established"))}_setupGlobalHudInterface(){console.log("[SystemsManager] Global HUD interface setup completed")}}const Oc=new class{constructor(){this.profileIndex=new Map,this.activeProfiles=[],this.styleCache=new Map,this.lastActiveProfiles=null,this.perfStats={profileLoads:0,styleMerges:0,cacheHits:0,cacheMisses:0,invalidations:0}}loadProfiles(e){Dl("profile.load",(()=>{this.profileIndex.clear(),e.forEach((e=>{e.id&&(this.profileIndex.set(e.id,e),this.perfStats.profileLoads++)})),Tl("profile.loaded",e.length)}))}setActiveProfiles(e){const t=Array.isArray(e)?e:[];JSON.stringify(this.activeProfiles)!==JSON.stringify(t)&&(this.activeProfiles=[...t],this.invalidateStyleCache(),Tl("profile.active.changed",1))}resolveOverlayStyles(e){return Dl("profile.resolve.overlays",(()=>{const t=e.map((e=>{const t={...e};return t.style=this.resolveOverlayStyle(e),t}));return Tl("profile.overlays.processed",e.length),t}))}resolveOverlayStyle(e){return Dl("profile.resolve.single",(()=>{const t=this.buildStyleCacheKey(e);if(this.styleCache.has(t))return this.perfStats.cacheHits++,Tl("profile.cache.hits",1),this.styleCache.get(t);const s=this.buildStyleLayers(e),n=this.mergeStyleLayers(s);return this.styleCache.set(t,n),this.perfStats.cacheMisses++,this.perfStats.styleMerges++,Tl("profile.cache.misses",1),n}))}buildStyleLayers(e){const t=[];return this.activeProfiles.forEach(((s,n)=>{const r=this.profileIndex.get(s);if(r){const i=this.getProfileOverlayStyle(r,e.id,e.type);i&&t.push({source:"profile",sourceId:s,style:i,precedence:100+n})}})),e.style&&t.push({source:"overlay",sourceId:e.id,style:e.style,precedence:1e3}),t.sort(((e,t)=>e.precedence-t.precedence))}getProfileOverlayStyle(e,t,s){return e.overlays&&e.overlays[t]?e.overlays[t]:e.defaults&&e.defaults[s]?e.defaults[s]:null}mergeStyleLayers(e){const t={},s={};return e.forEach((e=>{Object.entries(e.style).forEach((([n,r])=>{t[n]=r,s[n]={source:e.source,sourceId:e.sourceId,precedence:e.precedence}}))})),Object.defineProperty(t,"__styleProvenance",{value:s,enumerable:!1,writable:!1}),t}buildStyleCacheKey(e){return[e.id,e.type||"unknown",this.getOverlayStyleHash(e.style),this.activeProfiles.join(",")].join("|")}getOverlayStyleHash(e){return e&&"object"==typeof e?JSON.stringify(e).length.toString(36):"empty"}invalidateStyleCache(){this.styleCache.clear(),this.perfStats.invalidations++,Tl("profile.cache.invalidated",1)}getProfile(e){return this.profileIndex.get(e)}getActiveProfiles(){return[...this.activeProfiles]}getAvailableProfiles(){return Array.from(this.profileIndex.keys())}isProfileActive(e){return this.activeProfiles.includes(e)}getStats(){return{...this.perfStats,profileCount:this.profileIndex.size,activeProfileCount:this.activeProfiles.length,cacheSize:this.styleCache.size,hitRate:this.perfStats.cacheHits/(this.perfStats.cacheHits+this.perfStats.cacheMisses)||0}}getDebugInfo(){const e={availableProfiles:{},activeProfiles:this.activeProfiles,cacheSize:this.styleCache.size,stats:this.getStats()};return this.profileIndex.forEach(((t,s)=>{e.availableProfiles[s]={hasDefaults:!!(t.defaults&&Object.keys(t.defaults).length>0),hasOverlays:!!(t.overlays&&Object.keys(t.overlays).length>0),defaultTypes:t.defaults?Object.keys(t.defaults):[],overlayIds:t.overlays?Object.keys(t.overlays):[]}})),e}exportStats(e={}){const t=this.getStats();return e.includeDebug&&(t.debug=this.getDebugInfo()),"json"===e.format?JSON.stringify(t,null,2):t}},Lc="undefined"!=typeof window?window:r.g;function Pc(e){return e&&"object"==typeof e&&!Array.isArray(e)}function Nc(e,t){if(!Pc(t))return t;Pc(e)||(e={});for(const s of Object.keys(t)){const n=t[s],r=e[s];Pc(n)&&Pc(r)?e[s]=Nc(r,n):e[s]=n}return e}Lc&&(Lc.__msdProfile={resolver:Oc,getStats:()=>Oc.getStats(),getDebugInfo:()=>Oc.getDebugInfo(),getActiveProfiles:()=>Oc.getActiveProfiles(),getAvailableProfiles:()=>Oc.getAvailableProfiles(),export:e=>Oc.exportStats(e)});class Fc{constructor(e,t,s){this.mergedConfig=e,this.cardModel=t,this.systems=s,Oc.loadProfiles(e.profiles||[]),this.animationIndex=new Map((e.animations||[]).map((e=>[e.id,e]))),this.timelineDefs=e.timelines||[],this.runtimeActiveProfiles=Array.isArray(e.active_profiles)?e.active_profiles.slice():[],this._resolvedModelRef=null}computeResolvedModel(){this._ensureAnchors();const e=this._assembleBaseOverlays();this._subscribeOverlaysToDataSources(e);const t=this._applyRules();this._updateActiveProfiles(t);const s=this._applyOverlayPatches(e,t);this._resolveValueMaps(s);const{activeAnimations:n,animDiff:r,tlDiff:i}=this._processAnimations(s,t),o={viewBox:this.cardModel.viewBox,anchors:{...this.cardModel.anchors},overlays:s,animations:r.active,timelines:i.active,config:this.mergedConfig,active_profiles:this.runtimeActiveProfiles.slice()};try{this.systems.router.setOverlays&&this.systems.router.setOverlays(o.overlays)}catch(e){}return this._resolvedModelRef=o,o}getResolvedModel(){return this._resolvedModelRef}_ensureAnchors(){this.cardModel.anchors&&0!==Object.keys(this.cardModel.anchors).length||(this.mergedConfig.anchors&&Object.keys(this.mergedConfig.anchors).length?(console.warn("[MSD v1] computeResolvedModel: anchors missing – repairing from merged.anchors"),this.cardModel.anchors={...this.mergedConfig.anchors}):console.warn("[MSD v1] computeResolvedModel: anchors missing and no merged fallback available."))}_assembleBaseOverlays(){return _c("profiles.assemble",(()=>(Oc.setActiveProfiles(this.runtimeActiveProfiles),this.cardModel.overlaysBase.map((e=>{const t=Oc.resolveOverlayStyle(e),s=t.__styleProvenance?Object.entries(t.__styleProvenance).map((([e,t])=>({kind:t.source,id:t.sourceId}))):[],n={id:e.id,type:e.type,style:t,finalStyle:{...t},_styleSources:s,_raw:e.raw,anchor:e.raw?.anchor,attach_to:e.raw?.attach_to,position:e.raw?.position,size:e.raw?.size};return e.raw?.source&&(n.source=e.raw.source),e.raw?.route&&(n.route=e.raw.route),n})))))}_subscribeOverlaysToDataSources(e){if(!this.systems.dataSourceManager||!e)return void console.log("[MSD v1] Skipping overlay subscriptions - no DataSourceManager or overlays");let t=0,s=0;e.forEach((e=>{if(("sparkline"===e.type||"ribbon"===e.type)&&e.source)try{const n=this.systems.dataSourceManager.getSource(e.source);if(!n)return void console.warn(`[MSD v1] Data source '${e.source}' not found for overlay ${e.id}`);const r=n.getCurrentData(),i=r&&(r.bufferSize>0||void 0!==r.v);console.log(`[MSD v1] Subscribing overlay ${e.id} to source ${e.source}:`,{sourceReady:i,bufferSize:r?.bufferSize||0,hasValue:void 0!==r?.v});const o=this.systems.dataSourceManager.subscribeOverlay(e,((e,t)=>{if(console.log(`[MSD v1] 📊 Data update for overlay ${e.id}:`,{value:t.v,bufferSize:t.buffer?.size?.()||0,hasHistoricalData:!!t.historicalData?.length,sourceReady:!0}),this.systems.renderer&&this.systems.renderer.updateOverlayData)try{this.systems.renderer.updateOverlayData(e.id,t)}catch(t){console.error(`[MSD v1] Error updating overlay ${e.id}:`,t)}else console.warn(`[MSD v1] Renderer not available for overlay update: ${e.id}`)}));o&&(t++,i?console.log(`[MSD v1] ✅ Subscribed overlay ${e.id} to ready source ${e.source}`):(s++,console.log(`[MSD v1] ⏳ Subscribed overlay ${e.id} to pending source ${e.source}`)),this._overlayUnsubscribers||(this._overlayUnsubscribers=new Map),this._overlayUnsubscribers.has(e.id)||this._overlayUnsubscribers.set(e.id,[]),this._overlayUnsubscribers.get(e.id).push(o))}catch(t){console.warn(`[MSD v1] ⚠️ Failed to subscribe overlay ${e.id} to source ${e.source}:`,t.message)}})),t>0&&console.log(`[MSD v1] ✅ Established ${t} overlay data subscriptions (${s} pending data)`),s>0&&this._monitorPendingSubscriptions(e,s)}_monitorPendingSubscriptions(e,t){let s=0;const n=setInterval((()=>{s++;let t=0;e.forEach((e=>{if(("sparkline"===e.type||"ribbon"===e.type)&&e.source){const s=this.systems.dataSourceManager.getSource(e.source);if(s){const e=s.getCurrentData();e&&(e.bufferSize>0||void 0!==e.v)||t++}}})),0===t?(console.log(`[MSD v1] 🎉 All overlay data sources are now ready (checked ${s} times)`),clearInterval(n)):s>=50?(console.warn(`[MSD v1] ⏰ Timeout waiting for ${t} data sources to become ready`),clearInterval(n)):s%10==0&&console.log(`[MSD v1] ⏳ Still waiting for ${t} data sources (${100*s}ms elapsed)`)}),100)}_applyRules(){return this.systems.rulesEngine.evaluateDirty({getEntity:e=>this.systems.entityRuntime.getEntity(e)})}_updateActiveProfiles(e){if(e.profilesAdd?.length||e.profilesRemove?.length){const t=new Set(this.runtimeActiveProfiles);e.profilesAdd.forEach((e=>t.add(e))),e.profilesRemove.forEach((e=>t.delete(e))),this.runtimeActiveProfiles=Array.from(t),Oc.setActiveProfiles(this.runtimeActiveProfiles)}}_applyOverlayPatches(e,t){return _c("styles.patch",(()=>function(e,t){if(!Array.isArray(t)||0===t.length)return e;const s=e.map((e=>({...e}))),n=new Map(s.map((e=>[e.id,e])));return t.forEach((e=>{const t=n.get(e.id);t&&e.style&&(t.style={...t.style,...e.style})})),s}(e,t.overlayPatches)))}_resolveValueMaps(e){_c("value_map.subst",(()=>{return t=e,s={getEntity:e=>this.systems.entityRuntime.getEntity(e)},_c("value_map.resolve",(()=>{let e=0,n=0;for(const e of t)e.finalStyle&&(e.finalStyle=r(e.finalStyle));function r(t){if(!t||"object"!=typeof t)return t;if(t.value_map&&1===Object.keys(t).length){const r=function(t){try{const r=t.entity;if(!r)return n++,i(t);const o=s?.getEntity?s.getEntity(r):null;if(!o)return n++,i(t);let a=o.state;t.attribute&&o.attributes&&(a=o.attributes[t.attribute]);let l=Number(a);if(!Number.isFinite(l))return n++,i(t);const[c,d]=t.input||[],[u,h]=t.output||[];if(![c,d,u,h].every(Number.isFinite))return n++,i(t);let p=function(e,t,s,n,r,i){if(s===t)return n;let o=(e-t)/(s-t);return i&&(o<0?o=0:o>1&&(o=1)),n+o*(r-n)}(l,c,d,u,h,!!t.clamp);if(Number.isFinite(t.round)){const e=Math.pow(10,t.round);p=Math.round(p*e)/e}return e++,p}catch{return n++,i(t)}}(t.value_map);return r}if(Array.isArray(t))return t.map(r);const o={};for(const e of Object.keys(t))o[e]=r(t[e]);return o}function i(e){return e&&Number.isFinite(e.default)?e.default:Array.isArray(e?.output)&&Number.isFinite(e.output[0])?e.output[0]:1}yc("value_map.resolve.count",e),yc("value_map.fail.count",n)}));var t,s}))}_processAnimations(e,t){const s=function(e,t,s){const n=[],r=function(e){const t=new Map;return(e||[]).forEach((e=>{e.ref&&(t.has(e.ref)||t.set(e.ref,[]),t.get(e.ref).push(e))})),t.forEach((e=>e.sort(((e,t)=>(t.priority||0)-(e.priority||0))))),t}(s);for(const s of e){const e=s._raw||s.raw||{};if(!e.animation_ref)continue;const i=t.get(e.animation_ref);if(!i)continue;let o={};i.params&&(o=Nc(o,i.params)),e.animation_override?.params&&(o=Nc(o,e.animation_override.params));const a=r.get(e.animation_ref);if(a&&a.length)for(const e of a){e.override?.params&&(o=Nc(o,e.override.params));break}n.push({key:`overlay:${s.id}:${e.animation_ref}`,preset:i.preset,params:o,targets:[`#${s.id}`],ref:e.animation_ref,overlayId:s.id})}for(const[e,s]of t.entries())s.targets&&n.push({key:`standalone:${e}`,preset:s.preset,params:s.params||{},targets:Array.isArray(s.targets)?s.targets.slice():[s.targets],ref:e});return n}(e,this.animationIndex,t.animations),n=function(e=[]){return e.map((e=>{const t={...e.globals||{}},s=(e.steps||[]).map((e=>({targets:e.targets,preset:e.preset,params:Nc({},e.params||{}),offset:e.offset})));return{id:e.id,globals:t,steps:s}}))}(this.timelineDefs),r=[];s.forEach((e=>{const t=this.systems.animRegistry.getOrCreateInstance(e.definition,e.targets);t&&r.push({id:e.id,instance:t,hash:this.systems.animRegistry.computeInstanceHash(e.definition)})}));const i={active:r},o={active:n},a=new Map;return i.active.forEach((e=>{e.overlayId&&a.set(e.overlayId,e.hash)})),e.forEach((e=>{const t=a.get(e.id);t&&(e.animation_hash=t)})),{activeAnimations:r,animDiff:i,tlDiff:o}}destroy(){if(this._overlayUnsubscribers){console.log(`[MSD v1] Cleaning up ${this._overlayUnsubscribers.size} overlay subscriptions`);for(const[e,t]of this._overlayUnsubscribers)t.forEach((t=>{try{t()}catch(t){console.warn(`[MSD v1] Error unsubscribing overlay ${e}:`,t)}}));this._overlayUnsubscribers.clear()}}}class Bc{static getOverlaysSvg(e){return e?.querySelector?.("#msd_svg_overlays svg")||e?.querySelector?.("#cblcars-msd-wrapper svg")||null}static listOverlays(e){const t=[],s=this.getOverlaysSvg(e);if(!s)return t;const n=e.__msdResolvedModel||{},r=new Map((n.overlays||[]).map((e=>[e.id,e])));let i=Array.from(s.querySelectorAll('[id][data-cblcars-root="true"]'));i.length||(i=Array.from(s.querySelectorAll("[id]")).filter((e=>e.id&&"cblcars-debug-layer"!==e.id&&"cblcars-highlight-layer"!==e.id)));for(const s of i){const n=s.id,i=r.get(n),o=this.getOverlayBBox(n,e);t.push({id:n,type:i?.type||s.getAttribute?.("data-cblcars-type")||s.tagName?.toLowerCase()||"unknown",bbox:o,hasErrors:!1,hasWarnings:!1,element:s,config:i})}return t}static getOverlayBBox(e,t){if(!e||!t)return null;let s=t.getElementById?.(e);if(s&&"function"==typeof s.getBBox)try{const e=s.getBBox();if(e&&Number.isFinite(e.width)&&Number.isFinite(e.height))return{x:e.x,y:e.y,w:e.width,h:e.height}}catch(e){}const n=t.getElementById?.(`${e}_backdrop`);if(n&&"function"==typeof n.getBBox)try{const e=n.getBBox();if(e&&(e.width>0||e.height>0))return{x:e.x,y:e.y,w:e.width,h:e.height}}catch(e){}const r=t.__msdResolvedModel||{},i=r.overlays?.find((t=>t.id===e));if(i&&i.position&&i.size){const e=r.anchors||{},t=r.viewBox||[0,0,100,100],s=this.resolvePointFromConfig(i.position,e,t),n=this.resolveSizeFromConfig(i.size,t);if(s&&n)return{x:s[0],y:s[1],w:n.w,h:n.h}}return null}static highlight(e,t={}){const s=Array.isArray(e)?e:[e],n=t.root;if(!n)return void console.warn("[MsdIntrospection] Root element required for highlighting");const r=this.getOverlaysSvg(n);if(!r)return void console.warn("[MsdIntrospection] No SVG found for highlighting");const i=this.getViewBox(n,r)||[0,0,400,200],o=t.color||"#ffcc00",a=Number.isFinite(t.strokeWidth)?t.strokeWidth:Math.max(1.5,Math.round(.004*i[3])),l=Math.max(250,t.duration||1500),c=n.ownerDocument||n.document;if(!c||!c.createElementNS)return void console.warn("[MsdIntrospection] createElementNS not available");let d=r.querySelector("#cblcars-highlight-layer");d||(d=c.createElementNS("http://www.w3.org/2000/svg","g"),d.setAttribute("id","cblcars-highlight-layer"),d.style.pointerEvents="none",r.appendChild(d)),d.innerHTML="";for(const e of s){const t=this.getOverlayBBox(e,n);if(t){const e=c.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("x",t.x),e.setAttribute("y",t.y),e.setAttribute("width",t.w),e.setAttribute("height",t.h),e.setAttribute("fill","none"),e.setAttribute("stroke",o),e.setAttribute("stroke-width",a),e.setAttribute("opacity","0.9"),d.appendChild(e)}}setTimeout((()=>{d&&d.parentNode&&(d.innerHTML="")}),l)}static getViewBox(e,t){if(!t)return null;const s=t.getAttribute("viewBox");if(s){const e=s.split(/\s+/).map(Number);if(4===e.length)return e}return[0,0,400,200]}static resolvePointFromConfig(e,t={},s=[0,0,400,200]){const[n,r,i,o]=s;if(!e)return null;if("string"==typeof e&&t[e])return t[e];if(Array.isArray(e)&&2===e.length){const t=(e,t)=>"string"==typeof e&&e.trim().endsWith("%")?"x"===t?n+parseFloat(e)/100*i:r+parseFloat(e)/100*o:Number(e),s=t(e[0],"x"),a=t(e[1],"y");if(Number.isFinite(s)&&Number.isFinite(a))return[s,a]}return null}static resolveSizeFromConfig(e,t=[0,0,400,200]){if(!Array.isArray(e)||2!==e.length)return null;const[,,s,n]=t,r=(e,t)=>"string"==typeof e&&e.trim().endsWith("%")?parseFloat(e)/100*t:Number(e),i=r(e[0],s),o=r(e[1],n);return Number.isFinite(i)&&Number.isFinite(o)?{w:i,h:o}:null}}async function Ic(e){return _c("cardModel.build",(()=>{const t=e.overlays.map((e=>({id:e.id,type:e.type,style:e.style||{},raw:e})));return{viewBox:[0,0,400,200],anchors:{},overlaysBase:t,__raw:e}}))}class zc{static attach(){"undefined"!=typeof window&&(window.cblcars=window.cblcars||{},window.cblcars.msd=window.cblcars.msd||{},window.cblcars.msd.api={overlays:{list:e=>this.listOverlays(e),highlight:(e,t)=>this.highlightOverlays(e,t),getBBox:(e,t)=>this.getOverlayBBox(e,t),update:(e,t)=>this.updateOverlay(e,t)},anchors:{list:()=>this.listAnchors(),get:e=>this.getAnchor(e),set:(e,t,s)=>this.setAnchor(e,t,s),dump:()=>this.dumpAnchors()},debug:{enable:e=>this.enableDebugFeature(e),disable:e=>this.disableDebugFeature(e),toggle:e=>this.toggleDebugFeature(e),setScale:e=>this.setDebugScale(e),status:()=>this.getDebugStatus(),showAnchors:()=>{console.warn('[MsdApi] debug.showAnchors deprecated, use debug.enable("anchors")'),this.enableDebugFeature("anchors")},showOverlays:()=>{console.warn('[MsdApi] debug.showOverlays deprecated, use debug.enable("bounding_boxes")'),this.enableDebugFeature("bounding_boxes")},clear:()=>{console.warn('[MsdApi] debug.clear deprecated, use debug.disable("all")'),this.disableDebugFeature("all")}},performance:{dump:()=>this.getPerformanceData(),counters:()=>this.getPerformanceData().counters||{},timers:()=>this.getPerformanceData().timers||{}},pipeline:{getResolvedModel:()=>this.getResolvedModel(),reRender:()=>this.reRender(),validate:()=>this.getValidationIssues()}},window.cblcars.msd.listOverlays=e=>this.listOverlays(e),window.cblcars.msd.listAnchors=()=>this.listAnchors(),window.cblcars.msd.getOverlayBBox=(e,t)=>this.getOverlayBBox(e,t),window.cblcars.msd.highlight=(e,t)=>this.highlightOverlays(e,t))}static getWindow(){return"undefined"!=typeof window?window:void 0!==r.g&&r.g.window?r.g.window:null}static listOverlays(e){try{const t=this.getWindow(),s=t?.MsdIntrospection;if(s&&s.listOverlays)return s.listOverlays(e);const n=[],r=this.getResolvedModel();return r&&r.overlays&&r.overlays.forEach((t=>{n.push({id:t.id,type:t.type,bbox:this.getOverlayBBox(t.id,e),hasErrors:!1,hasWarnings:!1})})),n}catch(e){return[]}}static listAnchors(){try{const e=this.getResolvedModel();return Object.keys(e?.anchors||{})}catch(e){return[]}}static getAnchor(e){try{const t=this.getResolvedModel();return t?.anchors?.[e]||null}catch(e){return null}}static dumpAnchors(){try{const e=this.getResolvedModel();return{...e?.anchors}||{}}catch(e){return{}}}static getOverlayBBox(e,t){try{const s=this.getWindow(),n=s?.MsdIntrospection;if(n&&n.getOverlayBBox)return n.getOverlayBBox(e,t);const r=this.getResolvedModel(),i=r?.overlays?.find((t=>t.id===e));if(i&&i.position&&i.size){const e=Array.isArray(i.position)?i.position:[0,0],t=Array.isArray(i.size)?i.size:[100,50];return{x:Number(e[0])||0,y:Number(e[1])||0,w:Number(t[0])||100,h:Number(t[1])||50}}return null}catch(e){return null}}static highlightOverlays(e,t){try{const s=this.getWindow(),n=s?.MsdIntrospection;if(n&&n.highlight)return n.highlight(e,t);console.log("[MSD API] Highlight request:",e,t)}catch(e){}}static getResolvedModel(){try{const e=this.getWindow();return e?.__msdDebug?.pipelineInstance?.getResolvedModel?.()||null}catch(e){return null}}static getPerformanceData(){try{const e=this.getWindow();return e?.__msdDebug?.getPerf?.()||{timers:{},counters:{}}}catch(e){return{timers:{},counters:{}}}}static getValidationIssues(){try{const e=this.getWindow();return e?.__msdDebug?.validation?.issues?.()||[]}catch(e){return[]}}static setDebugFlag(e,t){try{const s=this.getWindow();s.cblcars=s.cblcars||{},s.cblcars._debugFlags=s.cblcars._debugFlags||{},s.cblcars._debugFlags[e]=t}catch(e){}}static clearDebugFlags(){try{const e=this.getWindow();e.cblcars=e.cblcars||{},e.cblcars._debugFlags={overlay:!1,connectors:!1,geometry:!1}}catch(e){}}static updateOverlay(e,t){return console.warn("[MSD API] Dynamic overlay updates not yet implemented"),!1}static setAnchor(e,t,s){try{const n=this.getWindow(),r=n?.__msdDebug?.pipelineInstance?.setAnchor?.(e,[t,s]);return r||{id:e,position:[t,s]}}catch(e){return null}}static reRender(){try{const e=this.getWindow();return e?.__msdDebug?.pipelineInstance?.reRender?.()||{success:!1}}catch(e){return{success:!1}}}static enableDebugFeature(e){const t=this.getDebugManager();t&&("all"===e?t.enableMultiple(["anchors","bounding_boxes","routing","performance"]):t.enable(e))}static disableDebugFeature(e){const t=this.getDebugManager();t&&("all"===e?t.disableMultiple(["anchors","bounding_boxes","routing","performance"]):t.disable(e))}static toggleDebugFeature(e){const t=this.getDebugManager();t&&t.toggle(e)}static setDebugScale(e){const t=this.getDebugManager();t&&t.setScale(e)}static getDebugStatus(){const e=this.getDebugManager();return e?e.getSnapshot():{error:"DebugManager not available"}}static getDebugManager(){const e=this.getWindow();return e?.__msdDebug?.debugManager||e?.__msdDebug?.pipelineInstance?.systemsManager?.debugManager}}function jc(e){if(!e||"object"!=typeof e)return e;const{__meta:t,...s}=e;return s}function Hc(e){const t=e.__raw_msd||{};function s(t){return(e[t]||[]).filter((e=>"user"===e.__meta?.origin_pack&&!e.__meta.removed)).map(jc)}const n={msd:{version:t.version||1,base_svg:t.base_svg,view_box:t.view_box,use_packs:t.use_packs,anchors:t.anchors,palettes:t.palettes,remove:t.remove,profiles:s("profiles"),animations:s("animations"),timelines:s("timelines"),overlays:s("overlays"),rules:s("rules"),routing:t.routing,active_profiles:t.active_profiles,hud:t.hud}};return Object.keys(n.msd).forEach((e=>{null==n.msd[e]||Array.isArray(n.msd[e])&&!n.msd[e].length?delete n.msd[e]:"object"!=typeof n.msd[e]||Array.isArray(n.msd[e])||Object.keys(n.msd[e]).length||delete n.msd[e]})),n}function Uc(e,t={}){const s=!!t.include_meta;function n(t){return(e[t]||[]).filter((e=>!e.__meta?.removed)).map((e=>function(e,t){if(t)return e;if(!e||"object"!=typeof e)return e;const{__meta:s,...n}=e;return n}(e,s)))}return{msd:{version:e.__raw_msd&&e.__raw_msd.version||1,base_svg:e.__raw_msd?.base_svg,view_box:e.__raw_msd?.view_box,use_packs:e.__raw_msd?.use_packs,anchors:e.__raw_msd?.anchors,palettes:e.palettes,remove:e.__raw_msd?.remove,profiles:n("profiles"),animations:n("animations"),timelines:n("timelines"),overlays:n("overlays"),rules:n("rules"),routing:e.routing,active_profiles:e.active_profiles,hud:e.hud,__provenance:s?e.__provenance:void 0,__issues:s?e.__issues:void 0}}}function Gc(e){if(!e)return null;const t={...e};return delete t.__meta,JSON.parse(function(e){const t=new WeakSet;return function e(s){return null===s||"object"!=typeof s?JSON.stringify(s):t.has(s)?'"[Circular]"':(t.add(s),Array.isArray(s)?"["+s.map(e).join(",")+"]":"{"+Object.keys(s).sort().map((t=>JSON.stringify(t)+":"+e(s[t]))).join(",")+"}")}(e)}(t))}async function Vc(e,t,s=null){const{mergedConfig:n,issues:r,provenance:i}=await async function(e){const t=await Ol(e),s=t.__provenance;"undefined"!=typeof window&&(window.__msdDebug=window.__msdDebug||{},window.__msdDebug._originalUserConfig=e);const n=performance.now(),r=function(e){const t={errors:[],warnings:[]};return e&&"object"==typeof e?(function(e,t){if(e.version?"number"==typeof e.version&&1===e.version||t.errors.push({code:"version.invalid",message:"Version must be 1 (only supported version)"}):t.warnings.push({code:"version.missing",message:"Missing version field - assuming version 1"}),void 0!==e.view_box){const s=e.view_box;"auto"===s||Array.isArray(s)&&4===s.length&&s.every((e=>"number"==typeof e))||t.errors.push({code:"view_box.invalid",message:'view_box must be "auto" or array of 4 numbers [x, y, width, height]'})}}(e,t),function(e,t){e.anchors&&Object.entries(e.anchors).forEach((([e,s])=>{Array.isArray(s)&&2===s.length?s.forEach(((s,n)=>{const r=0===n?"x":"y";"string"==typeof s?s.endsWith("%")&&!isNaN(parseFloat(s.slice(0,-1)))||t.errors.push({code:"anchor.coordinates.invalid",anchor_id:e,message:`Anchor '${e}' ${r}-coordinate '${s}' must be number or percentage string`}):"number"!=typeof s&&t.errors.push({code:"anchor.coordinates.invalid",anchor_id:e,message:`Anchor '${e}' ${r}-coordinate must be number or percentage string`})})):t.errors.push({code:"anchor.coordinates.invalid",anchor_id:e,message:`Anchor '${e}' coordinates must be array of 2 elements [x, y]`})}))}(e,t),function(e,t){if(!e.overlays)return;const s=new Set(Object.keys(e.anchors||{}));e.overlays.forEach((e=>{e&&e.id&&s.add(e.id)})),e.overlays.forEach((n=>{n.id?(n.type||t.errors.push({code:"overlay.type.missing",overlay_id:n.id,message:`Overlay '${n.id}' missing required type field`}),["anchor","attach_to"].forEach((e=>{n[e]&&("string"!=typeof n[e]||s.has(n[e])?Array.isArray(n[e])&&jl(n[e],t,`Overlay '${n.id}' ${e}`):t.errors.push({code:"anchor.missing",collection:"overlays",item_id:n.id,anchor:n[e],message:`Overlay '${n.id}' references missing anchor '${n[e]}'`}))})),n.position&&Array.isArray(n.position)&&jl(n.position,t,`Overlay '${n.id}' position`),n.animation_ref&&e.animations&&(e.animations.some((e=>e.id===n.animation_ref))||t.errors.push({code:"animation.missing",overlay_id:n.id,animation_ref:n.animation_ref,message:`Overlay '${n.id}' references missing animation '${n.animation_ref}'`}))):t.errors.push({code:"id.missing",collection:"overlays",message:"Overlay missing required id field"})}))}(e,t),function(e,t){e.rules&&e.rules.forEach((e=>{if(!e.id)return void t.errors.push({code:"id.missing",collection:"rules",message:"Rule missing required id field"});if(!e.when)return void t.errors.push({code:"rule.when.missing",rule_id:e.id,message:`Rule '${e.id}' missing required when conditions`});const s=Array.isArray(e.when.all),n=Array.isArray(e.when.any);s||n||t.errors.push({code:"rule.when.invalid",rule_id:e.id,message:`Rule '${e.id}' when must have 'all' or 'any' array of conditions`}),[...e.when.all||[],...e.when.any||[]].forEach((s=>{if(s.time_between&&(/^\d{2}:\d{2}-\d{2}:\d{2}$/.test(s.time_between)||t.errors.push({code:"rule.time_between.invalid",rule_id:e.id,message:`Rule '${e.id}' time_between must be format "HH:MM-HH:MM"`})),s.regex)try{new RegExp(s.regex)}catch(s){t.warnings.push({code:"rule.regex.invalid",rule_id:e.id,message:`Rule '${e.id}' has invalid regex pattern - rule will be ignored`})}})),void 0===e.priority||Number.isInteger(e.priority)||t.errors.push({code:"rule.priority.invalid",rule_id:e.id,message:`Rule '${e.id}' priority must be an integer`})}))}(e,t),function(e,t){e.animations&&e.animations.forEach((e=>{e.id?(e.preset||t.errors.push({code:"animation.preset.missing",animation_id:e.id,message:`Animation '${e.id}' missing required preset field`}),e.params?.duration&&"number"!=typeof e.params.duration&&t.errors.push({code:"animation.duration.invalid",animation_id:e.id,message:`Animation '${e.id}' duration must be a number (milliseconds)`})):t.errors.push({code:"id.missing",collection:"animations",message:"Animation missing required id field"})}))}(e,t),function(e,t){if(e.profiles&&(e.profiles.forEach((e=>{e.id||t.errors.push({code:"id.missing",collection:"profiles",message:"Profile missing required id field"})})),e.active_profiles))if(Array.isArray(e.active_profiles)){const s=new Set((e.profiles||[]).map((e=>e.id)));e.active_profiles.forEach((e=>{s.has(e)||t.warnings.push({code:"profile.missing",profile_id:e,message:`active_profiles references missing profile '${e}'`})}))}else t.errors.push({code:"active_profiles.invalid",message:"active_profiles must be an array of profile IDs"})}(e,t),function(e,t){e.palettes&&Object.entries(e.palettes).forEach((([e,s])=>{("object"!=typeof s||Array.isArray(s))&&t.errors.push({code:"palette.tokens.invalid",palette_name:e,message:`Palette '${e}' tokens must be an object`})}))}(e,t),function(e,t){if(!e.routing)return;const s=e.routing;void 0!==s.clearance&&"number"!=typeof s.clearance&&t.errors.push({code:"routing.clearance.invalid",message:"routing.clearance must be a number"}),void 0!==s.grid_resolution&&"number"!=typeof s.grid_resolution&&t.errors.push({code:"routing.grid_resolution.invalid",message:"routing.grid_resolution must be a number"}),void 0!==s.smoothing_mode&&(["none","chaikin"].includes(s.smoothing_mode)||t.warnings.push({code:"routing.smoothing_mode.invalid",message:`routing.smoothing_mode '${s.smoothing_mode}' invalid, using 'none'`}))}(e,t),function(e,t){["overlays","rules","animations","profiles","timelines"].forEach((s=>{const n=e[s]||[],r=new Set;n.forEach(((e,n)=>{e&&e.id?r.has(e.id)?t.errors.push({code:"duplicate.id",collection:s,id:e.id,message:`Duplicate ${s} ID: ${e.id}`}):r.add(e.id):t.errors.push({code:"id.missing",collection:s,index:n,message:`Missing id in ${s} item at index ${n}`})}))}))}(e,t),t):(t.errors.push({code:"config.invalid",message:"Configuration must be an object"}),t)}(t);t.__issues=r;const i=performance.now();try{window.__msdDebug&&(window.__msdDebug._validationMs=i-n)}catch{}try{const e=new Set(r.errors.map((e=>e.code))),s=new Set(Object.keys(t.anchors||{})),n=new Set;(t.overlays||[]).forEach((e=>{e&&e.id&&(n.add(e.id),s.add(e.id))})),(t.overlays||[]).forEach((t=>{if(!t||!t.id)return;const n=[];"string"==typeof t.anchor&&n.push(t.anchor),"string"==typeof t.attach_to&&n.push(t.attach_to),"string"==typeof t.attachTo&&n.push(t.attachTo),n.forEach((n=>{if(n&&!s.has(n)){const s="anchor.missing";e.has(`${s}:${n}:${t.id}`)||(r.errors.push({code:s,severity:"error",overlay:t.id,anchor:n,msg:`Overlay ${t.id} references missing anchor '${n}'`}),e.add(`${s}:${n}:${t.id}`))}}))}))}catch(e){}return{mergedConfig:t,issues:r,provenance:s}}(e);if(r.errors.length)return console.error("[MSD v1] Validation errors – pipeline disabled",r.errors),function(e,t,s){const n={enabled:!1,errors:t.errors,warnings:t.warnings,getResolvedModel:()=>null,ingestHass:()=>{},updateEntities:()=>{},listEntities:()=>[],getEntity:()=>null,getActiveProfiles:()=>[],getAnchors:()=>e.anchors||{},repairAnchorsFromMerged:()=>!1,exportCollapsed:()=>null,exportCollapsedJson:()=>"null",exportFullSnapshot:()=>null,exportFullSnapshotJson:()=>"null",diffItem:()=>null,getPerf:()=>({})};return"undefined"!=typeof window&&(window.__msdDebug=window.__msdDebug||{},window.__msdDebug.validation={issues:()=>e.__issues},window.__msdDebug.pipelineInstance=n,window.__msdDebug._provenance=s),n}(n,r,i);const o=await Ic(n);o.anchors||(o.anchors={}),Object.keys(o.anchors).length||n.anchors&&Object.keys(n.anchors).length&&(o.anchors={...n.anchors},console.info("[MSD v1] Adopted user anchors"));const a=new Rc;if(await a.initializeSystems(n,o,t,s),s&&a.setOriginalHass(s),"undefined"!=typeof window&&(window.__msdDebug=window.__msdDebug||{},window.__msdDebug.debugManager=a.debugManager,window.__msdDebug.routing=a.router),"undefined"!=typeof window){window.__msdDebug=window.__msdDebug||{},window.__msdDebug.routing||(window.__msdDebug.routing=a.router),window.__msdDebug.getPerf||(window.__msdDebug.getPerf=()=>bc()),window.__msdDebug.systemsManager||(window.__msdDebug.systemsManager=a);try{window.dispatchEvent(new CustomEvent("msd-routing-ready"))}catch(e){}}const l=new Fc(n,o,a);async function c(){if(console.log("[MSD DEBUG] 🔄 reRender() ENTRY",{timestamp:(new Date).toISOString(),renderInProgress:a._renderInProgress,stackTrace:(new Error).stack.split("\n").slice(1,4).join("\n")}),a._renderInProgress)return console.log("[MSD DEBUG] ⚠️ reRender() SKIPPED - already in progress"),{success:!1,reason:"render_in_progress"};a._renderInProgress=!0;try{console.log("[MSD DEBUG] 📊 Computing resolved model...");const e=performance.now(),s=l.computeResolvedModel();let n;console.log("[MSD DEBUG] ✅ Resolved model computed:",{overlayCount:s.overlays.length,controlOverlays:s.overlays.filter((e=>"control"===e.type)).length,hasAnchors:!!s.anchors,hasViewBox:!!s.viewBox}),console.log(`[MSD DEBUG] 🎨 Starting AdvancedRenderer.render() - overlays: ${s.overlays.length}`);try{n=a.renderer.render(s),console.log("[MSD DEBUG] ✅ AdvancedRenderer.render() completed successfully:",n)}catch(e){return console.error("[MSD DEBUG] ❌ AdvancedRenderer.render() FAILED:",e),console.error("[MSD DEBUG] ❌ Render error stack:",e.stack),{success:!1,error:e.message,phase:"advanced_renderer"}}console.log("[MSD DEBUG] 🎮 Starting renderDebugAndControls()...");try{await a.renderDebugAndControls(s,t),console.log("[MSD DEBUG] ✅ renderDebugAndControls() completed successfully")}catch(e){console.error("[MSD DEBUG] ❌ renderDebugAndControls() FAILED:",e),console.error("[MSD DEBUG] ❌ Debug/Controls error stack:",e.stack),console.warn("[MSD DEBUG] ⚠️ Continuing without debug/controls rendering due to error")}const r=performance.now()-e;return console.log(`[MSD DEBUG] ✅ reRender() COMPLETED in ${r.toFixed(2)}ms`),n||{success:!0}}catch(e){return console.error("[MSD DEBUG] ❌ reRender() COMPLETELY FAILED:",e),console.error("[MSD DEBUG] ❌ Complete failure stack:",e.stack),{success:!1,error:e.message}}finally{a._renderInProgress=!1,console.log("[MSD DEBUG] 🏁 reRender() FINALLY block - _renderInProgress reset to false")}}a.setReRenderCallback(c),console.log("[MSD v1] Computing initial resolved model"),console.log("[MSD v1] DataSourceManager status:",{sourcesCount:a.dataSourceManager?.getAllSources?.()?.length||0,entityCount:a.dataSourceManager?.listIds?.()?.length||0});const d=await c();console.log("[MSD v1] Initial render completed:",{overlayCount:d?.overlayCount||0,errors:d?.errors||0});const u=qc(n,o,a,l,c);if(function(e,t,s,n,r){if("undefined"==typeof window)return;const i=window.__msdDebug=window.__msdDebug||{},o=t?.debug||{};console.log("[MSD v1] Debug interface ready - type window.__msdDebug.help() for usage"),i.pipelineInstance=e,i.hasOwnProperty("pipeline")||Object.defineProperty(i,"pipeline",{get(){return console.warn("[MSD Debug] window.__msdDebug.pipeline is deprecated. Use window.__msdDebug.pipelineInstance instead."),this.pipelineInstance},configurable:!0}),i._provenance=s,function(e,t,s){e.routing={inspect:e=>t.routingInspect(e),invalidate:(e="*")=>s.router.invalidate(e),stats:()=>{try{return s.router.stats?.()||{cacheHits:0,pathsComputed:0,invalidations:0}}catch(e){return console.warn("[MSD v1] routing.stats failed:",e),{cacheHits:0,pathsComputed:0,invalidations:0,error:e.message}}},inspectAs:(n,r="smart")=>{try{const i=t.getResolvedModel?.();if(!i)return null;const o=i.overlays.find((e=>e.id===n));if(!o)return null;o._raw=o._raw||{};const a=o._raw.route_mode_full;o._raw.route_mode_full=r,s.router.invalidate&&s.router.invalidate("*");const l=e.routing.inspect(n);return o._raw.route_mode_full=a,s.router.invalidate&&s.router.invalidate("*"),l}catch(e){return console.warn("[MSD v1] inspectAs failed",e),null}}}}(i,e,n),function(e,t){if(e.hasOwnProperty("dataSources"))try{Object.assign(e.dataSources,{list:()=>t.dataSourceManager?Array.from(t.dataSourceManager.sources.keys()):[],get:e=>t.dataSourceManager?.getSource(e)?.getStats()||null,dump:()=>t.dataSourceManager?.debugDump()||{error:"DataSourceManager not initialized"}})}catch(s){e.dataSourcesDebug={stats:()=>t.dataSourceManager?.getStats()||{error:"DataSourceManager not initialized"},list:()=>t.dataSourceManager?Array.from(t.dataSourceManager.sources.keys()):[],get:e=>t.dataSourceManager?.getSource(e)?.getStats()||null,dump:()=>t.dataSourceManager?.debugDump()||{error:"DataSourceManager not initialized"},manager:()=>t.dataSourceManager},console.log("[DebugInterface] Created dataSourcesDebug as alternative access due to getter conflict")}else e.dataSources={stats:()=>t.dataSourceManager?.getStats()||{error:"DataSourceManager not initialized"},list:()=>t.dataSourceManager?Array.from(t.dataSourceManager.sources.keys()):[],get:e=>t.dataSourceManager?.getSource(e)?.getStats()||null,dump:()=>t.dataSourceManager?.debugDump()||{error:"DataSourceManager not initialized"},manager:()=>t.dataSourceManager};e.entities={list:()=>(console.warn("[MSD Debug] entities.list() is deprecated. Use window.__msdDebug.dataSourceManager.listIds() instead."),t.dataSourceManager?.listIds()||[]),get:e=>(console.warn("[MSD Debug] entities.get() is deprecated. Use window.__msdDebug.dataSourceManager.getEntity() instead."),t.dataSourceManager?.getEntity(e)||null),stats:()=>{console.warn("[MSD Debug] entities.stats() is deprecated. Use window.__msdDebug.dataSources.stats() instead.");const e=t.dataSourceManager?.getStats()||{};return{count:t.dataSourceManager?.listIds()?.length||0,subscribed:Object.keys(e.sources||{}).length,updated:Object.values(e.sources||{}).reduce(((e,t)=>e+(t.received||0)),0),cacheHits:Object.values(e.sources||{}).reduce(((e,t)=>e+(t.cacheHits||0)),0)}}}}(i,n),function(e,t,s,n,r){const i=t.debugManager;e.debug={enable:e=>{"all"===e?i.enableMultiple(["anchors","bounding_boxes","routing","performance"]):i.enable(e),setTimeout((()=>{try{const t=window.__msdDebug?.pipelineInstance;t?.reRender&&(console.log("[MSD Debug] Force re-render after enable:",e),t.reRender())}catch(e){console.warn("[MSD Debug] Failed to trigger re-render:",e)}}),10)},disable:e=>{"all"===e?i.disableMultiple(["anchors","bounding_boxes","routing","performance"]):i.disable(e),setTimeout((()=>{try{const t=window.__msdDebug?.pipelineInstance;t?.reRender&&(console.log("[MSD Debug] Force re-render after disable:",e),t.reRender())}catch(e){console.warn("[MSD Debug] Failed to trigger re-render:",e)}}),10)},testRender:()=>{console.log("[MSD Debug] Testing debug render directly...");try{const e=i.getSnapshot();console.log("[MSD Debug] Current state:",e);const t=window.__msdDebug?.pipelineInstance;if(!t)return void console.warn("[MSD Debug] No pipeline instance available");const s=t.systemsManager;if(!s)return void console.warn("[MSD Debug] No systems manager available");const n=s.renderer?.mountEl;if(!n)return void console.warn("[MSD Debug] No mount element found in renderer");console.log("[MSD Debug] Found mount element:",n.constructor.name);const r=t.getResolvedModel();if(!r)return void console.warn("[MSD Debug] No resolved model available");console.log("[MSD Debug] Calling renderDebugAndControls with shadowRoot context"),s.renderDebugAndControls(r,n)}catch(e){console.error("[MSD Debug] testRender failed:",e)}},setScale:e=>i.setScale(e),status:()=>{const e=i.getSnapshot();return console.table(e),e},getStatus:()=>i.getSnapshot(),onChange:e=>i.onChange(e),refresh:()=>{try{const e=window.__msdDebug?.pipelineInstance;e?.reRender&&(e.reRender(),console.log("[MSD Debug] Debug overlays refreshed"))}catch(e){console.warn("[MSD Debug] Failed to trigger pipeline re-render:",e)}},anchors:{show:()=>i.enable("anchors"),hide:()=>i.disable("anchors"),toggle:()=>i.toggle("anchors")},bounding:{show:()=>i.enable("bounding_boxes"),hide:()=>i.disable("bounding_boxes"),toggle:()=>i.toggle("bounding_boxes")},routing:{show:()=>i.enable("routing"),hide:()=>i.disable("routing"),toggle:()=>i.toggle("routing")},performance:{show:()=>i.enable("performance"),hide:()=>i.disable("performance"),toggle:()=>i.toggle("performance")}},e.renderAdvanced=e=>{try{console.log("[MSD v1] renderAdvanced called - using AdvancedRenderer");const e=s.getResolvedModel();return e?t.renderer.render(e):(console.warn("[MSD v1] renderAdvanced: No resolved model available"),{svgMarkup:""})}catch(e){return console.error("[MSD v1] renderAdvanced failed:",e),{svgMarkup:"",error:e.message}}},e.hud={show:()=>t.hudManager.show(),hide:()=>t.hudManager.hide(),toggle:()=>t.hudManager.toggle(),state:()=>({visible:t.hudManager.state?.visible||!1,activePanel:t.hudManager.state?.activePanel||"unknown",refreshRate:t.hudManager.state?.refreshRate||2e3}),init:()=>{r?.hud?.auto_show&&setTimeout((()=>{t.hudManager.show(),console.log("[MSD v1] HUD auto-shown based on config")}),2e3)}},setTimeout((()=>e.hud.init()),100),e.introspection={listOverlays:e=>Bc.listOverlays(e),getOverlayBBox:(e,t)=>Bc.getOverlayBBox(e,t),highlight:(e,t)=>Bc.highlight(e,t)},e.controls={render:(e,s)=>t.controlsRenderer.renderControls(e,s),relayout:()=>t.controlsRenderer.relayout()},e.help=function(){console.log("\n╔══════════════════════════════════════════════════════════════════════════════╗\n║                          MSD Debug Interface Help                            ║\n╠══════════════════════════════════════════════════════════════════════════════╣\n║ Debug Features:                                                              ║\n║   __msdDebug.debug.enable('anchors')       - Show anchor point markers      ║\n║   __msdDebug.debug.enable('bounding_boxes') - Show overlay bounding boxes   ║\n║   __msdDebug.debug.enable('routing')       - Show routing path visualization║\n║   __msdDebug.debug.enable('performance')   - Show performance metrics       ║\n║   __msdDebug.debug.enable('all')           - Enable all features            ║\n║                                                                              ║\n║   __msdDebug.debug.disable('feature')      - Disable specific feature       ║\n║   __msdDebug.debug.status()                - Show current debug state       ║\n║   __msdDebug.debug.setScale(1.5)           - Set debug element scale        ║\n║   __msdDebug.debug.refresh()               - Force re-render debug overlays ║\n║                                                                              ║\n║ Quick Access:                                                                ║\n║   __msdDebug.debug.anchors.toggle()        - Toggle anchor markers          ║\n║   __msdDebug.debug.bounding.toggle()       - Toggle bounding boxes          ║\n║   __msdDebug.debug.routing.toggle()        - Toggle routing guides          ║\n║   __msdDebug.debug.performance.toggle()    - Toggle performance overlay     ║\n║                                                                              ║\n║ Data & Entities:                                                             ║\n║   __msdDebug.dataSources.stats()           - Data source statistics         ║\n║   __msdDebug.dataSources.list()            - List all data sources          ║\n║   __msdDebug.dataSources.get('name')       - Get specific data source       ║\n║                                                                              ║\n║ Routing:                                                                     ║\n║   __msdDebug.routing.inspect('overlay_id') - Inspect routing path           ║\n║   __msdDebug.routing.stats()               - Routing system statistics      ║\n║   __msdDebug.routing.invalidate()          - Clear routing cache            ║\n║                                                                              ║\n║ Performance:                                                                 ║\n║   __msdDebug.getPerf()                     - Get performance metrics        ║\n║   __msdDebug.perf()                        - Alternative performance data   ║\n║                                                                              ║\n║ Other Tools:                                                                 ║\n║   __msdDebug.hud.toggle()                  - Toggle HUD overlay             ║\n║   __msdDebug.rules.trace()                 - Show rules engine trace        ║\n║   __msdDebug.validation.issues()           - Show configuration issues      ║\n║   __msdDebug.usage()                       - Show simplified usage examples ║\n║                                                                              ║\n║ Pipeline:                                                                    ║\n║   __msdDebug.pipelineInstance              - Direct pipeline access         ║\n╚══════════════════════════════════════════════════════════════════════════════╝\n    ")},e.usage=function(){console.log("\n🔧 Quick MSD Debug Commands:\n\nEnable debug features:\n  __msdDebug.debug.enable('anchors')      # Show anchor points\n  __msdDebug.debug.enable('bounding_boxes') # Show overlay bounds\n  __msdDebug.debug.enable('all')          # Enable everything\n\nCheck status:\n  __msdDebug.debug.status()               # Current debug state\n  __msdDebug.dataSources.stats()          # Data source info\n  __msdDebug.getPerf()                    # Performance metrics\n\nQuick toggles:\n  __msdDebug.debug.anchors.toggle()       # Toggle anchors\n  __msdDebug.debug.routing.toggle()       # Toggle routing guides\n\nFor full help: __msdDebug.help()\n    ")},r.enabled&&console.log("[MSD v1] Debug mode enabled")}(i,n,r,0,o),function(e,t,s){e.rules={trace:()=>s.rulesEngine.getTrace()},e.animations={active:()=>s.animRegistry.getActive()},e.getPerf=()=>{const t=e.__perfStore||{},s={timers:{},counters:t.counters||{}};return t.timings&&Object.entries(t.timings).forEach((([e,t])=>{t&&"object"==typeof t&&(s.timers[e]={count:t.count||0,total:t.total||0,avg:t.count>0?t.total/t.count:0,last:t.last||0,max:t.max||0})})),s},e.perf=()=>bc(),e.validation={issues:()=>{try{return t.__issues||{errors:[],warnings:[]}}catch(e){return console.warn("[MSD v1] validation.issues failed:",e),{errors:[],warnings:[]}}}},e.packs={list:e=>e?t[e]||[]:{animations:t.animations?.length||0,overlays:t.overlays?.length||0,rules:t.rules?.length||0,profiles:t.profiles?.length||0,timelines:t.timelines?.length||0},get:(e,s)=>(t[e]||[]).find((e=>e.id===s)),issues:()=>t.__issues},e.lines={markersEnabled:!1,showMarkers(e=!0){this.markersEnabled=!!e,console.info("[MSD v1] line endpoint markers",this.markersEnabled?"ENABLED":"DISABLED")},forceRedraw:()=>!!s._reRenderCallback&&(s._reRenderCallback(),!0)}}(i,t,n),console.log("[MSD v1] Debug interface setup complete"),console.log("[MSD v1] Available methods:",Object.keys(i)),o.enabled&&console.log("[MSD v1] Debug mode enabled")}(u,n,i,a,l),"undefined"!=typeof window&&window.__msdDebug?.hud?.setMountElement&&window.__msdDebug.hud.setMountElement(t),console.log("[MSD v1] Attaching unified API"),zc.attach(),"undefined"!=typeof window&&(window.__msdDebug=window.__msdDebug||{},window.__msdDebug.validation={issues:()=>n.__issues},window.__msdDebug.pipelineInstance=u,window.__msdDebug._provenance=i,!window.__msdDebug.routing)){window.__msdDebug.routing=a.router;try{window.dispatchEvent(new CustomEvent("msd-routing-ready"))}catch(e){}}return console.log("[MSD v1] Pipeline initialization complete"),u}function qc(e,t,s,n,r){const i={enabled:!0,version:e.version||1,config:e,systemsManager:s,dataSourceManager:s.dataSourceManager,rulesEngine:s.rulesEngine,renderer:s.renderer,router:s.router,routingInspect:e=>{const r=n.getResolvedModel(),i=(r?.overlays||[]).find((t=>t.id===e));if(!i)return null;const o=i._raw||i.raw||{},a=t.anchors[o.anchor],l=t.anchors[o.attach_to]||t.anchors[o.attachTo];if(!a||!l)return null;const c=s.router.buildRouteRequest(i,a,l);return s.router.computePath(c)},getResolvedModel:()=>n.getResolvedModel(),reRender:()=>{try{return console.log("[MSD v1] Manual re-render triggered"),r()}catch(e){return console.error("[MSD v1] Manual re-render failed:",e),{success:!1,error:e.message}}},setAnchor(e,r){if(!e||!Array.isArray(r)||2!==r.length)return!1;t.anchors||(t.anchors={}),t.anchors[e]=[Number(r[0]),Number(r[1])];const i=n.getResolvedModel();i?.anchors&&(i.anchors[e]=t.anchors[e]),s.router.invalidate&&s.router.invalidate("*");try{s.renderer&&i&&(s.renderer._routerOverlaySync=!1,s.renderer.render(i))}catch(e){}return!0},ingestHass:e=>s.ingestHass(e),updateEntities:e=>s.updateEntities(e),listEntities:()=>s.entityRuntime.listIds(),getEntity:e=>s.entityRuntime.getEntity(e),getActiveProfiles:()=>n.runtimeActiveProfiles.slice(),getAnchors:()=>({...t.anchors}),exportCollapsed:()=>Hc(userMsdConfig),exportCollapsedJson:()=>JSON.stringify(Hc(userMsdConfig)),exportFullSnapshot:()=>Uc(e),exportFullSnapshotJson:()=>JSON.stringify(Uc(e)),diffItem:e=>function(e,t,s){const n=e.__provenance?.[void 0]?.[s];if(!n)return{id:s,collection:t,chain:[],final:null,removed:!1};const r=(e[void 0]||[]).filter((e=>e.id===s)),i=r.length?r[r.length-1]:null;return{id:s,collection:t,chain:n,removed:n.some((e=>e.removed)),final_summary:i?Gc(i):null,chain_summaries:n.map((e=>({layer:e.layer_id,overridden:e.overridden,removed:e.removed,checksum:e.checksum,diff:e.diff})))}}(e),getPerf:()=>bc(),debug:{enable:e=>s.debugManager.enable(e),disable:e=>s.debugManager.disable(e),toggle:e=>s.debugManager.toggle(e),setScale:e=>s.debugManager.setScale(e),status:()=>s.debugManager.getSnapshot(),onChange:e=>s.debugManager.onChange(e)},getDataSourceManager:()=>s.dataSourceManager,_reRenderCallback:r};return i}let Wc,Yc,Xc;r(372),r(157),r(388),r(733),r(786),"undefined"!=typeof window&&(window.__msdDebug=window.__msdDebug||{},Object.assign(window.__msdDebug,{mergePacks:Ol,buildCardModel:Ic,initMsdPipeline:Vc,initMsdHud:function(e,t){if(!e?.enabled)return null;r.e(268).then(r.bind(r,268)).then((s=>{const n=new s.HudController(e,t);n.refresh(),window.__msdDebug&&(window.__msdDebug.hud={refresh:()=>n.refresh(),hud:n})})).catch((e=>{console.warn("[MSD v1] HudController import failed:",e)}))}}),Object.assign(window.__msdDebug,{pipelineInstance:null,async initMsdPipeline(e,t,s){try{const n=await Vc(e,t,s);return this.pipelineInstance=n,n}catch(e){throw console.error("[MSD Debug] Pipeline initialization failed:",e),e}}}),Object.defineProperty(window.__msdDebug,"dataSourceManager",{get:()=>window.__msdDebug.pipelineInstance?.dataSourceManager||window.__msdDebug.pipelineInstance?.systemsManager?.dataSourceManager,configurable:!0})),window.cblcars=window.cblcars||{};let Jc={},Zc={};function Kc(e,t="green",s=!1){const n=e[`${t}_alert`];if(!n)return void Is.lr.error(`[setThemeColors] Theme for alert condition ${t} is not defined.`,"",(0,Is.mZ)());const r=n.colors;for(const[e,t]of Object.entries(r))for(const[e,n]of Object.entries(t)){const t=`--${e}`,r=getComputedStyle(document.documentElement).getPropertyValue(t).trim();s||!r?(Is.lr.warn(`[setThemeColors] Color undefined or overridden - Setting ${t}=${n}`,"",(0,Is.mZ)()),document.documentElement.style.setProperty(t,n)):Is.lr.debug(`[setThemeColors] Skipping ${t} as it is already defined with value ${r}`,"",(0,Is.mZ)())}}window.cblcars.loadFont=Wr,console.log("[CB-LCARS] File loaded, setting up debugging"),async function(){(0,Is.zf)(),window.cblcars.cblcarsLog=Is.lr,window.cblcars.debug=window.cblcars.debug||{},window.cblcars.debug.setLevel=Is.mD,window.cblcars.anim={animejs:e,anime:Ft,utils:cs,animateElement:_l.animateElement,animateWithRoot:_l.animateWithRoot,waitForElement:_l.waitForElement,presets:vl.m,scopes:new Map},window.cblcars.animejs=window.cblcars.anim.animejs,window.cblcars.anime=window.cblcars.anim.anime,window.cblcars.animateElement=window.cblcars.anim.animateElement,window.cblcars.animateWithRoot=window.cblcars.anim.animateWithRoot,window.cblcars.waitForElement=window.cblcars.anim.waitForElement,window.cblcars.svgHelpers=wl,window.cblcars.anchorHelpers=t,window.cblcars.findSvgAnchors=Sl,window.cblcars.getSvgContent=xl,window.cblcars.getSvgViewBox=$l,window.cblcars.getSvgAspectRatio=Cl,window.cblcars.loadFont=Wr,window.cblcars.loadUserSVG=async function(e,t){return await Hr(e,t)},window.cblcars.getSVGFromCache=Ur,Wc=async function(e){try{const t=await zr(e);window.cblcars_card_templates=t.cblcars_card_templates,t.cblcars&&(window.cblcars={...window.cblcars,...t.cblcars}),Jc=t||{},Is.lr.debug(`[loadTemplates] CB-LCARS dashboard templates loaded from source file [${e}]`,Jc)}catch(e){Is.lr.error("[loadTemplates] Failed to get the CB-LCARS lovelace templates from source file.",e)}}(Bs.FS),Yc=async function(e){try{const t=await zr(e);Zc=t||{},Is.lr.debug(`[loadStubConfig] CB-LCARS stub configuration loaded from source file [${Bs.ZU}]`,Zc)}catch(e){Is.lr.error("[loadStubConfig] Failed to get the CB-LCARS stub configuration from source file.",e)}}(Bs.ZU),Xc=async function(e){try{const t=await zr(e);t.cblcars&&(window.cblcars={...window.cblcars,...t.cblcars}),Is.lr.info(`[loadThemeColors] CB-LCARS theme colors loaded from source file [${e}]`,t),Kc(window.cblcars.themes,"green")}catch(e){Is.lr.error("[loadThemeColors] Failed to get the CB-LCARS theme colors from source file.",e)}}(Bs.CZ),await async function(e,t){const s=e.map((e=>Hr(e,`${t}${e}.svg`)));await Promise.all(s),Is.lr.info(`[preloadSVGs] Preloaded SVGs: ${e.join(", ")} from ${t}`)}(Bs.ur,Bs.A1).catch((e=>Is.lr.error("[initializeCustomCard] Error preloading built-in SVGs:",e)));const s=[customElements.whenDefined("cblcars-button-card"),customElements.whenDefined("my-slider-v2")];await Promise.all(s),await async function(){try{const e=Array.isArray(Bs.ry)?Bs.ry:[Bs.ry];for(const t of e)window.cblcars.loadFont(t)}catch(e){Is.lr.error(`[loadCoreFonts] Failed to preload core fonts: ${e.message}`)}}(),await Promise.all([Wc,Yc,Xc]),customElements.get("cblcars-button-card")||Is.lr.error("[initializeCustomCard] Custom Button Card for LCARS [cblcars-button-card] was not found!"),customElements.get("my-slider-v2")||Is.lr.error("[initializeCustomCard] 'My Cards' MySliderV2 Custom Card [my-slider-v2] was not found!")}().then((()=>{cd("cb-lcars-base-card",ed,"cb-lcars-base-card-editor",qr),cd("cb-lcars-label-card",sd,"cb-lcars-label-card-editor",qr),cd("cb-lcars-elbow-card",nd,"cb-lcars-elbow-card-editor",qr),cd("cb-lcars-double-elbow-card",id,"cb-lcars-double-elbow-card-editor",qr),cd("cb-lcars-multimeter-card",od,"cb-lcars-multimeter-card-editor",qr),cd("cb-lcars-dpad-card",ad,"cb-lcars-dpad-card-editor",qr),cd("cb-lcars-button-card",ld,"cb-lcars-button-card-editor",qr),cd("cb-lcars-msd-card",rd,"cb-lcars-msd-card-editor",qr)})).catch((e=>{Is.lr.error("[initializeCustomCard.then()] Error initializing custom card:",e)})),window.cblcars.setAlertCondition=function(e){Kc(window.cblcars.themes,e,!0)};class Qc{constructor(e){this.id=e,this.scope=window.cblcars.animejs.createScope(),this.animations=[],this._runningByTarget=new Map}_getRoot(e){return e&&e.root||document}_resolveTargets(e){const t=this._getRoot(e),s=e&&e.targets;if(!s)return[];if(s instanceof Element)return[s];if(Array.isArray(s))return s.filter(Boolean);if("string"==typeof s){if(s.startsWith("#")){const e=t.querySelector(s);return e?[e]:[]}return Array.from(t.querySelectorAll(s))}return[]}_cleanupArtifactsForTargetId(e,t){if(!t)return;e.querySelectorAll(`#${t}_trail[data-cblcars-owned]`).forEach((e=>e.parentElement&&e.parentElement.removeChild(e))),e.querySelectorAll(`#${t}_tracer[data-cblcars-owned]`).forEach((e=>e.parentElement&&e.parentElement.removeChild(e)));const s=e.getElementById(t);s&&(s.style&&(s.style.animation=""),s.removeAttribute("data-march-anim-id"))}_cancelAndCleanupTargets(e){const t=this._getRoot(e),s=this._resolveTargets(e);return s.forEach((e=>{const s=e&&e.id;if(s){if(this.scope&&"function"==typeof this.scope.remove)try{this.scope.remove(e)}catch(e){}this._cleanupArtifactsForTargetId(t,s),e.style&&(e.style.animation=""),this._runningByTarget.delete(s)}})),s}animate(e,t=null){const s=this._cancelAndCleanupTargets(e),n=window.cblcars.anim.animateElement(this,e,t);n&&(this.animations.push({config:e,animation:n,targets:s}),s.forEach((e=>e&&e.id&&this._runningByTarget.set(e.id,n))))}destroy(){if(this.scope&&"function"==typeof this.scope.remove)try{const e=window.cblcars.animejs.get(this.scope);e&&this.scope.remove(e.map((e=>e.targets)).flat())}catch(e){}try{this.animations.forEach((e=>{const t=this._getRoot(e.config);(e.targets||[]).forEach((e=>{e&&e.id&&(this._cleanupArtifactsForTargetId(t,e.id),e.style&&(e.style.animation=""))}))}))}catch(e){}this._runningByTarget.clear(),this.animations=[]}}class ed extends bl{_isResizeObserverEnabled=!1;_resizeObserver;_logLevel=(0,Is.mZ)();_resizeObserverTarget="this";_lastWidth=0;_lastHeight=0;_resizeObserverTolerance=16;_debounceWait=100;_isUsingLovelaceTemplate=!1;_overrideTemplates=[];constructor(){super(),this._resizeObserverTolerance=window.cblcars.resizeObserverTolerance||this._resizeObserverTolerance,this._debounceWait=window.cblcars.debounceWait||this._debounceWait,this._resizeObserver=new ResizeObserver((()=>{Is.lr.debug("[CBLCARSBaseCard.constructor()] Resize observer fired",this,this._logLevel),this._debouncedResizeHandler()})),this._debouncedResizeHandler=this._debounce((()=>this._updateCardSize()),this._debounceWait)}setHass(e){console.log("[CBLCARSBaseCard.setHass()] 🎯 RECEIVED setHass call:",{cardType:this.constructor.cardType,entity:this._config?.entity,oldState:this.hass?.states?.[this._config?.entity]?.state,newState:e?.states?.[this._config?.entity]?.state,stateChanged:this.hass?.states?.[this._config?.entity]?.state!==e?.states?.[this._config?.entity]?.state,timestamp:(new Date).toISOString(),callerStack:(new Error).stack.split("\n").slice(1,3).map((e=>e.trim())).join(" → ")});const t=this.hass;if(this._config?.entity&&e?.states?.[this._config.entity]){const t=e.states[this._config.entity];this._stateObj!==t&&(console.log("[CBLCARSBaseCard.setHass()] Updating _stateObj for entity:",this._config.entity,{oldState:this._stateObj?.state,newState:t?.state}),this._stateObj=t)}this.hass=e,this._hass=e,"function"==typeof this.requestUpdate&&(this.requestUpdate("hass",t),this.requestUpdate("_hass",t),this._config?.entity&&this._stateObj&&this.requestUpdate("_stateObj")),console.log("[CBLCARSBaseCard.setHass()] Completed with property assignment approach")}setConfig(e){if(!e)throw new Error("The 'cblcars_card_config' section is required in the configuration.");console.log("[CBLCARSBaseCard.setConfig()] Called with config:",{type:e.type,entity:e.entity,triggersUpdate:e.triggers_update,hasSetConfigFromMSD:e._msdGenerated||!1,fullConfig:e});const t=["cb-lcars-base",...e.template?[...e.template]:[]];this._logLevel=e.cblcars_log_level||(0,Is.mZ)();let s=[];if("cb-lcars-msd-card"===e.type||"cb-lcars-msd-card"===this.constructor.cardType||t.includes("cb-lcars-msd"))s=[],console.log("[CBLCARSBaseCard.setConfig()] MSD card detected: Completely disabling triggers_update");else{const t=td(e);s=Array.isArray(e.triggers_update)?e.triggers_update:[],"all"===e.triggers_update?s="all":t.length>0&&(s=Array.from(new Set([...s,...t])),console.log("[CBLCARSBaseCard.setConfig()] Found entities for triggers_update:",t))}this._config={...e,template:t,triggers_update:s},console.log("[CBLCARSBaseCard.setConfig()] Final config triggers_update:",this._config.triggers_update),function(e){const t=new Set;!function e(s){if(s&&"object"==typeof s)for(const n in s)"font_family"===n&&"string"==typeof s[n]?t.add(s[n]):"object"==typeof s[n]&&e(s[n])}(e),t.forEach((e=>window.cblcars.loadFont(e)))}(this._config);const{isUsingLovelaceTemplate:n,overriddenTemplates:r}=function(e){const t=function(){let e=document.querySelector("home-assistant");if(e=e&&e.shadowRoot,e=e&&e.querySelector("home-assistant-main"),e=e&&e.shadowRoot,e=e&&e.querySelector("app-drawer-layout partial-panel-resolver, ha-drawer partial-panel-resolver"),e=e&&e.shadowRoot||e,e=e&&e.querySelector("ha-panel-lovelace"),e=e&&e.shadowRoot,e=e&&e.querySelector("hui-root"),e){const t=e.lovelace;return t.current_view=e.___curView,t}return null}(),s=t&&t.config&&t.config.cblcars_card_templates?t.config.cblcars_card_templates:{};let n=!1,r=[],i=e.template||[];for(const e of i)s.hasOwnProperty(e)&&(n=!0,r.push(e));return r=[...new Set(r)].sort(),{isUsingLovelaceTemplate:n,overriddenTemplates:r}}(this._config);this._isUsingLovelaceTemplate=n,this._overrideTemplates=r,n&&(Is.lr.warn(`[CBLCARSBaseCard.setConfig()] Card configuration templates are being overridden with local dashboard YAML configuration.  Templates: ${r.join(", ")}`,this,this._logLevel),window.cblcars.taintedCards=window.cblcars.taintedCards||[],window.cblcars.taintedCards.push({card:this,templates:r})),this._resizeObserverTarget=e.resize_observer_target||"this",this._isResizeObserverEnabled=e.enable_resize_observer||e.variables&&e.variables.enable_resize_observer||!1,this._resizeObserverTolerance=e.resize_observer_tolerance||this._resizeObserverTolerance,this._debounceWait=e.debounce_wait||this._debounceWait,t.some((e=>e.includes("animation")||e.includes("symbiont")))&&(this._isResizeObserverEnabled=!0),this._isResizeObserverEnabled&&this.enableResizeObserver(),super.setConfig(this._config),console.log("[CBLCARSBaseCard.setConfig()] Called super.setConfig with final config:",{triggers_update:this._config.triggers_update,entity:this._config.entity,type:this._config.type}),this.hass&&this._config.entity&&(console.log("[CBLCARSBaseCard.setConfig()] Forcing state re-evaluation after setConfig"),setTimeout((()=>{try{console.log("[CBLCARSBaseCard.setConfig()] Skipping forced setHass - will rely on normal HA update cycle"),"function"==typeof this.requestUpdate&&(console.log("[CBLCARSBaseCard.setConfig()] Forcing requestUpdate"),this.requestUpdate())}catch(e){console.warn("[CBLCARSBaseCard.setConfig()] Failed to force state re-evaluation:",e)}}),100)),Is.lr.debug("[CBLCARSBaseCard.setConfig()] called with:",this._config,this._logLevel)}static get editorType(){return"cb-lcars-base-card-editor"}static get cardType(){return"cb-lcars-base-card"}static get defaultConfig(){return{label:"CB-LCARS Base Card",show_label:!0}}static getConfigElement(){const e=this.editorType;try{return customElements.get(e)?document.createElement(e):(Is.lr.error(`[CBLCARSBaseCard.getConfigElement()] Graphical editor element [${e}] is not defined defined in Home Assistant!`,null,this._logLevel),null)}catch(t){return Is.lr.error(`[CBLCARSBaseCard.getConfigElement()] Error creating element ${e}: `,t,this._logLevel),null}}static getStubConfig(){const e=this.cardType;return Zc[e]?Zc[e]:this.defaultConfig}getCardSize(){super.getCardSize()}getLayoutOptions(){return{grid_rows:1,grid_columns:4}}connectedCallback(){super.connectedCallback(),this._animationScopeId=`card-${this.id||this.cardType||Math.random().toString(36).slice(2)}`,this._animationScope=new Qc(this._animationScopeId),window.cblcars.anim.scopes.set(this._animationScopeId,this._animationScope),this._timelines&&Array.isArray(this._timelines)&&(this._timelines.forEach((e=>e&&"function"==typeof e.pause&&e.pause())),this._timelines=null);const e=this._config?.variables?.msd||{},t=e.timelines||null,s=(Array.isArray(e.overlays)?e.overlays:[]).reduce(((e,t)=>(t&&t.id&&(e[t.id]=t),e)),{});t&&requestAnimationFrame((()=>{requestAnimationFrame((async()=>{try{this._timelines=await _l.createTimelines(t,this._animationScopeId,this.shadowRoot,s,this.hass||null,e.presets||{})}catch(e){Is.lr.error("[CBLCARSBaseCard.connectedCallback] Error creating timelines:",e)}}))})),this.parentElement&&this.parentElement.classList.contains("preview")?(this.style.height="60px",this.style.minHeight="60px"):(this.style.height="100%",this._isResizeObserverEnabled&&(this.enableResizeObserver(),window.addEventListener("resize",this._debouncedResizeHandler)))}disconnectedCallback(){super.disconnectedCallback();const e=window.cblcars.anim.scopes.get(this._animationScopeId);e&&(e.destroy(),window.cblcars.anim.scopes.delete(this._animationScopeId)),this.disableResizeObserver(),window.removeEventListener("resize",this._debouncedResizeHandler)}_updateCardSize(){const e=this.parentElement.offsetWidth,t=this.parentElement.offsetHeight,s=this._resizeObserverTolerance;if(e>0&&t>0&&(Math.abs(e-this._lastWidth)>s||Math.abs(t-this._lastHeight)>s)){if(this._lastWidth=e,this._lastHeight=t,this.style.setProperty("--button-card-width",`${e}px`),this.style.setProperty("--button-card-height",`${t}px`),!this._config)return void Is.lr.debug("[CBLCARSBaseCard._updateCardSize()] Config is not defined. Skipping resize handling.",this,this._logLevel);this._config.variables||(this._config.variables={card:{}}),this._config.variables.card.width=`${e}px`,this._config.variables.card.height=`${t}px`,this.setConfig(this._config)}}_updateResizeObserver(){this._isResizeObserverEnabled?this.enableResizeObserver():this.disableResizeObserver()}enableResizeObserver(){const e=this.resolveTargetElement(this._resizeObserverTarget);e&&this.isConnected&&(this._resizeObserver.observe(e),Is.lr.debug(`[CBLCARSBaseCard.enableResizeObserver()] Resize observer enabled on [${this._resizeObserverTarget}]`,this,this._logLevel))}disableResizeObserver(){this._resizeObserver&&this._resizeObserver.disconnect(),Is.lr.debug("[CBLCARSBaseCard.disableResizeObserver()] Resize observer disabled",this._logLevel)}toggleResizeObserver(){this._isResizeObserverEnabled=!this._isResizeObserverEnabled,this._updateResizeObserver()}resolveTargetElement(e){const t={this:()=>this,"this.parentElement":()=>this.parentElement,"this.offsetParent":()=>this.offsetParent};return t[e]?t[e]():this}_debounce(e,t){let s;return function(...n){clearTimeout(s),s=setTimeout((()=>e.apply(this,n)),t)}}_rebuildTimelines(e,t={},s={}){e&&(this._timelines&&Array.isArray(this._timelines)&&(this._timelines.forEach((e=>e&&"function"==typeof e.pause&&e.pause())),this._timelines=null),requestAnimationFrame((()=>{requestAnimationFrame((async()=>{try{this._timelines=await window.cblcars.anim.createTimelines?window.cblcars.anim.createTimelines(e,this._animationScopeId,this.shadowRoot,t,this.hass||null,s||{}):(await Promise.resolve().then(r.bind(r,625))).createTimelines(e,this._animationScopeId,this.shadowRoot,t,this.hass||null,s||{})}catch(e){Is.lr.error("[CBLCARSBaseCard._rebuildTimelines] Error creating timelines:",e)}}))})))}}function td(e,t=[]){if(Array.isArray(e))e.forEach((e=>td(e,t)));else if(e&&"object"==typeof e)for(const[s,n]of Object.entries(e))"entity"!==s&&"entity_id"!==s||"string"!=typeof n?td(n,t):t.push(n);return t}class sd extends ed{static get editorType(){return"cb-lcars-label-card-editor"}static get cardType(){return"cb-lcars-label-card"}static get defaultConfig(){return{label:"CB-LCARS Label",show_label:!0}}setConfig(e){const t=[e.cblcars_card_type?e.cblcars_card_type:"cb-lcars-label",...e.template?[...e.template]:[]],s={...e,template:t};super.setConfig(s)}}class nd extends ed{static get editorType(){return"cb-lcars-elbow-card-editor"}static get cardType(){return"cb-lcars-elbow-card"}static get defaultConfig(){return{variables:{card:{border:{left:{size:90},top:{size:20}}}}}}setConfig(e){const t=[e.cblcars_card_type?e.cblcars_card_type:"cb-lcars-header",...e.template?[...e.template]:[]],s={...e,template:t};super.setConfig(s)}getLayoutOptions(){return{grid_rows:1,grid_columns:4}}}class rd extends ed{static get editorType(){return"cb-lcars-msd-card-editor"}static get cardType(){return"cb-lcars-msd-card"}static get defaultConfig(){return{enable_resize_observer:!0,variables:{card:{border:{left:{size:0},right:{size:0},top:{size:0},bottom:{size:0}}}}}}setConfig(e){console.log("[MSD DEBUG] 🔧 CBLCARSMSDCard.setConfig() CALLED:",{timestamp:(new Date).toISOString(),hasExistingConfig:!!this._config,configType:e.type,configEntity:e.entity,msdAlreadyBooted:!!this._msdV1ComprehensiveBoot,stackTrace:(new Error).stack.split("\n").slice(1,6).map((e=>e.trim())).join(" → ")});const t=["cb-lcars-msd",...e.template?[...e.template]:[]],s={...e,template:t,entity:void 0,entities:void 0,triggers_update:[],show_state:!1,show_icon:!1,show_name:!1,show_label:!1,state:void 0,tap_action:{action:"none"},hold_action:{action:"none"},double_tap_action:{action:"none"}},n=s?.msd;super.setConfig(s);try{n&&window.__msdDebug?.initMsdPipeline&&(this._msdConfig=n,console.log("[CBLCARSMSDCard] MSD v1 config prepared for pipeline initialization"))}catch(e){console.warn("[CBLCARSMSDCard] Failed to prepare MSD v1 pipeline:",e)}if(console.log("[CBLCARSMSDCard] msdConfig:",n),n&&n.base_svg?.source){console.log("[CBLCARSMSDCard] Found base SVG:",n.base_svg.source);let e=null,t=null;n.base_svg.source.startsWith("builtin:")?e=n.base_svg.source.replace("builtin:",""):n.base_svg.source.startsWith("/local/")&&(e=n.base_svg.source.split("/").pop().replace(".svg",""),t=n.base_svg.source,window.cblcars.getSVGFromCache(e)||window.cblcars.loadUserSVG(e,t).then((()=>{console.log("[CBLCARSMSDCard] SVG loaded, scheduling safe update"),setTimeout((()=>{this.requestUpdate&&!this._blockUpdates&&this.requestUpdate()}),100)})).catch((e=>{console.warn("[CBLCARSMSDCard] Failed to load user SVG:",e)}))),this._svgKey=e,console.log("[CBLCARSMSDCard] SVG key stored:",e)}console.log("[CBLCARSMSDCard] Config set with disabled entity tracking and SVG handling preserved")}getLayoutOptions(){return{grid_rows:4,grid_columns:4}}setHass(e){console.log("[MSD DEBUG] 🏠 CBLCARSMSDCard.setHass() CALLED:",{timestamp:(new Date).toISOString(),hasHass:!!e,lightDeskState:e?.states?.["light.desk"]?.state,callerStack:(new Error).stack.split("\n").slice(1,4).map((e=>e.trim())).join(" → ")}),this.hass=e,this._msdPipeline&&this._msdPipeline.systemsManager&&(console.log("[MSD DEBUG] 📤 IMMEDIATELY updating SystemsManager with FRESH HASS"),console.log("[MSD DEBUG] 📊 Fresh HASS light.desk state being sent:",e?.states?.["light.desk"]?.state),this._msdPipeline.systemsManager.controlsRenderer&&(console.log("[MSD DEBUG] 📤 Immediately forwarding fresh HASS to controls"),this._msdPipeline.systemsManager.controlsRenderer.setHass(e))),this._msdPipeline&&"function"==typeof this._msdPipeline.ingestHass&&(console.log("[MSD DEBUG] 📤 Forwarding HASS to MSD pipeline via ingestHass"),this._msdPipeline.ingestHass(e)),console.log("[MSD DEBUG] 📤 Calling super.setHass() to maintain HA compatibility"),super.setHass(e),console.log("[MSD DEBUG] ✅ CBLCARSMSDCard.setHass() COMPLETED - SystemsManager should now have fresh HASS")}updated(e){if(console.log("[MSD DEBUG] 🔄 CBLCARSMSDCard.updated() CALLED:",{timestamp:(new Date).toISOString(),changedProperties:Array.from(e.keys()),stackTrace:(new Error).stack.split("\n").slice(1,4).map((e=>e.trim())).join(" → ")}),e.has("hass")||e.has("_hass")){if(this._isControlTriggeredUpdate())return void console.log("[MSD DEBUG] ⏭️ BLOCKED super.updated() for control-triggered HASS change");console.log("[MSD DEBUG] 🔄 Allowing super.updated() for non-control HASS change")}console.log("[MSD DEBUG] 🔄 Calling super.updated() for changes:",Array.from(e.keys())),super.updated(e)}requestUpdate(e,t,s){return console.log("[MSD DEBUG] 🔃 CBLCARSMSDCard.requestUpdate() CALLED:",{timestamp:(new Date).toISOString(),name:e,hasOldValue:void 0!==t,stackTrace:(new Error).stack.split("\n").slice(1,4).map((e=>e.trim())).join(" → ")}),"hass"===e||"_hass"===e?(console.log("[MSD DEBUG] 🚫 BLOCKED requestUpdate() for HASS change:",e),console.log("[MSD DEBUG] ⏭️ MSD system manages its own HASS updates internally"),Promise.resolve()):(console.log("[MSD DEBUG] ✅ Allowing requestUpdate() for:",e),super.requestUpdate(e,t,s))}_isControlTriggeredUpdate(){if(window.__msdDebug?.systemsManager){const e=window.__msdDebug.systemsManager._lastEntityAnalysis;if(e&&e.isControlTriggered)return Date.now()-e.timestamp<100}return!1}connectedCallback(){console.log("[CBLCARSMSDCard.connectedCallback] MSD card connected to DOM"),super.connectedCallback()}disconnectedCallback(){console.log("[CBLCARSMSDCard.disconnectedCallback] MSD card disconnected from DOM"),this.msdSystem&&console.log("[CBLCARSMSDCard.disconnectedCallback] Cleaning up MSD system"),super.disconnectedCallback()}}class id extends ed{static get editorType(){return"cb-lcars-double-elbow-card-editor"}static get cardType(){return"cb-lcars-double-elbow-card"}static get defaultConfig(){return{}}setConfig(e){const t=[e.cblcars_card_type?e.cblcars_card_type:"cb-lcars-header-picard",...e.template?[...e.template]:[]],s={...e,template:t};super.setConfig(s)}getLayoutOptions(){return{grid_rows:1,grid_columns:4}}}class od extends ed{static get editorType(){return"cb-lcars-multimeter-card-editor"}static get cardType(){return"cb-lcars-multimeter-card"}static get defaultConfig(){return{variables:{_mode:"gauge"}}}constructor(){super(),this._enableResizeObserver=!0}setConfig(e){const t=["cb-lcars-multimeter",...e.template?[...e.template]:[]],s={...e,template:t};super.setConfig(s)}getLayoutOptions(){return{grid_rows:1,grid_columns:4}}render(){return customElements.get("my-slider-v2")?super.render():Gr.html`<ha-alert alert-type="error" title="CB-LCARS - Dependency Error">Required 'my-slider-v2' card is not available - Please refer to the documentation.</ha-alert>`}}class ad extends ed{static get editorType(){return"cb-lcars-dpad-card-editor"}static get cardType(){return"cb-lcars-dpad-card"}static get defaultConfig(){return{}}setConfig(e){const t=["cb-lcars-dpad",...e.template?[...e.template]:[]],s={...e,template:t};super.setConfig(s)}getLayoutOptions(){return{grid_rows:4,grid_columns:2}}}class ld extends ed{static get editorType(){return"cb-lcars-button-card-editor"}static get cardType(){return"cb-lcars-button-card"}static get defaultConfig(){return{label:"CB-LCARS Button",show_label:!0}}setConfig(e){const t=[e.cblcars_card_type?e.cblcars_card_type:"cb-lcars-button-lozenge",...e.template?[...e.template]:[]],s={...e,template:t};super.setConfig(s)}getLayoutOptions(){return{grid_min_rows:1,grid_rows:1,grid_columns:2,grid_min_columns:1}}}function cd(e,t,s,n){customElements.define(e,t),customElements.define(s,class extends n{constructor(){super(e)}})}window.customCards=window.customCards||[],window.customCards.push({type:"cb-lcars-base-card",name:"CB-LCARS Base Card",description:"For advanced use: the CB-LCARS base card for full manual configuration.",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-label-card",name:"CB-LCARS Label",preview:!0,description:"CB-LCARS label card for text.",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-elbow-card",name:"CB-LCARS Elbow",preview:!0,description:"CB-LCARS Elbow card",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-double-elbow-card",name:"CB-LCARS Double Elbow",preview:!0,description:"CB-LCARS Double Elbow card",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-multimeter-card",name:"CB-LCARS Multimeter",preview:!0,description:"CB-LCARS Multimeter card",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-dpad-card",name:"CB-LCARS D-Pad",preview:!0,description:"CB-LCARS D-Pad card",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-button-card",name:"CB-LCARS Button",preview:!0,description:"CB-LCARS Buttons [various styles]",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-msd-card",name:"CB-LCARS MSD",preview:!0,description:"CB-LCARS Master Systems Display (MSD) card",documentationURL:"https://cb-lcars.unimatrix01.ca"})})()})();
//# sourceMappingURL=cb-lcars.js.map