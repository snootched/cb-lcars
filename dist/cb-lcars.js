/*! For license information please see cb-lcars.js.LICENSE.txt */
(()=>{var e={356:(e,t,n)=>{"use strict";n.r(t),n.d(t,{DEFAULT_DOMAIN_ICON:()=>K,DEFAULT_PANEL:()=>Z,DEFAULT_VIEW_ENTITY_ID:()=>ae,DOMAINS_HIDE_MORE_INFO:()=>te,DOMAINS_MORE_INFO_NO_HISTORY:()=>ne,DOMAINS_TOGGLE:()=>re,DOMAINS_WITH_CARD:()=>Q,DOMAINS_WITH_MORE_INFO:()=>ee,NumberFormat:()=>s,STATES_OFF:()=>se,TimeFormat:()=>r,UNIT_C:()=>ie,UNIT_F:()=>oe,applyThemesOnElement:()=>z,computeCardSize:()=>B,computeDomain:()=>I,computeEntity:()=>j,computeRTL:()=>H,computeRTLDirection:()=>U,computeStateDisplay:()=>J,computeStateDomain:()=>G,createThing:()=>ue,debounce:()=>he,domainIcon:()=>ge,evaluateFilter:()=>me,fireEvent:()=>le,fixedIcons:()=>pe,formatDate:()=>d,formatDateMonth:()=>b,formatDateMonthYear:()=>f,formatDateNumeric:()=>h,formatDateShort:()=>g,formatDateTime:()=>x,formatDateTimeNumeric:()=>A,formatDateTimeWithSeconds:()=>C,formatDateWeekday:()=>l,formatDateYear:()=>v,formatNumber:()=>Y,formatTime:()=>D,formatTimeWeekday:()=>O,formatTimeWithSeconds:()=>T,forwardHaptic:()=>fe,getLovelace:()=>Ae,handleAction:()=>we,handleActionConfig:()=>ve,handleClick:()=>Se,hasAction:()=>xe,hasConfigOrEntityChanged:()=>$e,hasDoubleClick:()=>Ce,isNumericState:()=>q,navigate:()=>ye,numberFormatToLocale:()=>V,relativeTime:()=>N,round:()=>W,stateIcon:()=>Ee,timerTimeRemaining:()=>P,toggleEntity:()=>_e,turnOnOffEntities:()=>Me,turnOnOffEntity:()=>be});var s,r,i,o=function(){return o=Object.assign||function(e){for(var t,n=1,s=arguments.length;n<s;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},o.apply(this,arguments)},a={second:45,minute:45,hour:22,day:5},l=function(e,t){return c(t).format(e)},c=function(e){return new Intl.DateTimeFormat(e.language,{weekday:"long",month:"long",day:"numeric"})},d=function(e,t){return u(t).format(e)},u=function(e){return new Intl.DateTimeFormat(e.language,{year:"numeric",month:"long",day:"numeric"})},h=function(e,t){return p(t).format(e)},p=function(e){return new Intl.DateTimeFormat(e.language,{year:"numeric",month:"numeric",day:"numeric"})},g=function(e,t){return m(t).format(e)},m=function(e){return new Intl.DateTimeFormat(e.language,{day:"numeric",month:"short"})},f=function(e,t){return y(t).format(e)},y=function(e){return new Intl.DateTimeFormat(e.language,{month:"long",year:"numeric"})},b=function(e,t){return _(t).format(e)},_=function(e){return new Intl.DateTimeFormat(e.language,{month:"long"})},v=function(e,t){return w(t).format(e)},w=function(e){return new Intl.DateTimeFormat(e.language,{year:"numeric"})};(i=s||(s={})).language="language",i.system="system",i.comma_decimal="comma_decimal",i.decimal_comma="decimal_comma",i.space_comma="space_comma",i.none="none",function(e){e.language="language",e.system="system",e.am_pm="12",e.twenty_four="24"}(r||(r={}));var S=function(e){if(e.time_format===r.language||e.time_format===r.system){var t=e.time_format===r.language?e.language:void 0,n=(new Date).toLocaleString(t);return n.includes("AM")||n.includes("PM")}return e.time_format===r.am_pm},x=function(e,t){return $(t).format(e)},$=function(e){return new Intl.DateTimeFormat(e.language,{year:"numeric",month:"long",day:"numeric",hour:S(e)?"numeric":"2-digit",minute:"2-digit",hour12:S(e)})},C=function(e,t){return M(t).format(e)},M=function(e){return new Intl.DateTimeFormat(e.language,{year:"numeric",month:"long",day:"numeric",hour:S(e)?"numeric":"2-digit",minute:"2-digit",second:"2-digit",hour12:S(e)})},A=function(e,t){return k(t).format(e)},k=function(e){return new Intl.DateTimeFormat(e.language,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"2-digit",hour12:S(e)})},D=function(e,t){return E(t).format(e)},E=function(e){return new Intl.DateTimeFormat(e.language,{hour:"numeric",minute:"2-digit",hour12:S(e)})},T=function(e,t){return R(t).format(e)},R=function(e){return new Intl.DateTimeFormat(e.language,{hour:S(e)?"numeric":"2-digit",minute:"2-digit",second:"2-digit",hour12:S(e)})},O=function(e,t){return F(t).format(e)},F=function(e){return new Intl.DateTimeFormat(e.language,{hour:S(e)?"numeric":"2-digit",minute:"2-digit",second:"2-digit",hour12:S(e)})},N=function(e,t,n,s){void 0===s&&(s=!0);var r=function(e,t,n){void 0===t&&(t=Date.now()),void 0===n&&(n={});var s=o(o({},a),n||{}),r=(+e-+t)/1e3;if(Math.abs(r)<s.second)return{value:Math.round(r),unit:"second"};var i=r/60;if(Math.abs(i)<s.minute)return{value:Math.round(i),unit:"minute"};var l=r/3600;if(Math.abs(l)<s.hour)return{value:Math.round(l),unit:"hour"};var c=r/86400;if(Math.abs(c)<s.day)return{value:Math.round(c),unit:"day"};var d=new Date(e),u=new Date(t),h=d.getFullYear()-u.getFullYear();if(Math.round(Math.abs(h))>0)return{value:Math.round(h),unit:"year"};var p=12*h+d.getMonth()-u.getMonth();if(Math.round(Math.abs(p))>0)return{value:Math.round(p),unit:"month"};var g=r/604800;return{value:Math.round(g),unit:"week"}}(e,n);return s?function(e){return new Intl.RelativeTimeFormat(e.language,{numeric:"auto"})}(t).format(r.value,r.unit):Intl.NumberFormat(t.language,{style:"unit",unit:r.unit,unitDisplay:"long"}).format(Math.abs(r.value))};function P(e){var t,n=3600*(t=e.attributes.remaining.split(":").map(Number))[0]+60*t[1]+t[2];if("active"===e.state){var s=(new Date).getTime(),r=new Date(e.last_changed).getTime();n=Math.max(n-(s-r)/1e3,0)}return n}function L(){return(L=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e}).apply(this,arguments)}var z=function(e,t,n,s){void 0===s&&(s=!1),e._themes||(e._themes={});var r=t.default_theme;("default"===n||n&&t.themes[n])&&(r=n);var i=L({},e._themes);if("default"!==r){var o=t.themes[r];Object.keys(o).forEach((function(t){var n="--"+t;e._themes[n]="",i[n]=o[t]}))}if(e.updateStyles?e.updateStyles(i):window.ShadyCSS&&window.ShadyCSS.styleSubtree(e,i),s){var a=document.querySelector("meta[name=theme-color]");if(a){a.hasAttribute("default-content")||a.setAttribute("default-content",a.getAttribute("content"));var l=i["--primary-color"]||a.getAttribute("default-content");a.setAttribute("content",l)}}},B=function(e){return"function"==typeof e.getCardSize?e.getCardSize():4};function I(e){return e.substr(0,e.indexOf("."))}function j(e){return e.substr(e.indexOf(".")+1)}function H(e){var t,n=(null==e||null==(t=e.locale)?void 0:t.language)||"en";return e.translationMetadata.translations[n]&&e.translationMetadata.translations[n].isRTL||!1}function U(e){return H(e)?"rtl":"ltr"}function G(e){return I(e.entity_id)}var q=function(e){return!!e.attributes.unit_of_measurement||!!e.attributes.state_class},V=function(e){switch(e.number_format){case s.comma_decimal:return["en-US","en"];case s.decimal_comma:return["de","es","it"];case s.space_comma:return["fr","sv","cs"];case s.system:return;default:return e.language}},W=function(e,t){return void 0===t&&(t=2),Math.round(e*Math.pow(10,t))/Math.pow(10,t)},Y=function(e,t,n){var r=t?V(t):void 0;if(Number.isNaN=Number.isNaN||function e(t){return"number"==typeof t&&e(t)},(null==t?void 0:t.number_format)!==s.none&&!Number.isNaN(Number(e))&&Intl)try{return new Intl.NumberFormat(r,X(e,n)).format(Number(e))}catch(t){return console.error(t),new Intl.NumberFormat(void 0,X(e,n)).format(Number(e))}return"string"==typeof e?e:W(e,null==n?void 0:n.maximumFractionDigits).toString()+("currency"===(null==n?void 0:n.style)?" "+n.currency:"")},X=function(e,t){var n=L({maximumFractionDigits:2},t);if("string"!=typeof e)return n;if(!t||!t.minimumFractionDigits&&!t.maximumFractionDigits){var s=e.indexOf(".")>-1?e.split(".")[1].length:0;n.minimumFractionDigits=s,n.maximumFractionDigits=s}return n},J=function(e,t,n,s){var r=void 0!==s?s:t.state;if("unknown"===r||"unavailable"===r)return e("state.default."+r);if(q(t)){if("monetary"===t.attributes.device_class)try{return Y(r,n,{style:"currency",currency:t.attributes.unit_of_measurement})}catch(e){}return Y(r,n)+(t.attributes.unit_of_measurement?" "+t.attributes.unit_of_measurement:"")}var i=G(t);if("input_datetime"===i){var o;if(void 0===s)return t.attributes.has_date&&t.attributes.has_time?(o=new Date(t.attributes.year,t.attributes.month-1,t.attributes.day,t.attributes.hour,t.attributes.minute),x(o,n)):t.attributes.has_date?(o=new Date(t.attributes.year,t.attributes.month-1,t.attributes.day),d(o,n)):t.attributes.has_time?((o=new Date).setHours(t.attributes.hour,t.attributes.minute),D(o,n)):t.state;try{var a=s.split(" ");if(2===a.length)return x(new Date(a.join("T")),n);if(1===a.length){if(s.includes("-"))return d(new Date(s+"T00:00"),n);if(s.includes(":")){var l=new Date;return D(new Date(l.toISOString().split("T")[0]+"T"+s),n)}}return s}catch(e){return s}}return"humidifier"===i&&"on"===r&&t.attributes.humidity?t.attributes.humidity+" %":"counter"===i||"number"===i||"input_number"===i?Y(r,n):t.attributes.device_class&&e("component."+i+".state."+t.attributes.device_class+"."+r)||e("component."+i+".state._."+r)||r},K="mdi:bookmark",Z="lovelace",Q=["climate","cover","configurator","input_select","input_number","input_text","lock","media_player","scene","script","timer","vacuum","water_heater","weblink"],ee=["alarm_control_panel","automation","camera","climate","configurator","cover","fan","group","history_graph","input_datetime","light","lock","media_player","script","sun","updater","vacuum","water_heater","weather"],te=["input_number","input_select","input_text","scene","weblink"],ne=["camera","configurator","history_graph","scene"],se=["closed","locked","off"],re=new Set(["fan","input_boolean","light","switch","group","automation"]),ie="°C",oe="°F",ae="group.default_view",le=function(e,t,n,s){s=s||{},n=null==n?{}:n;var r=new Event(t,{bubbles:void 0===s.bubbles||s.bubbles,cancelable:Boolean(s.cancelable),composed:void 0===s.composed||s.composed});return r.detail=n,e.dispatchEvent(r),r},ce=new Set(["call-service","divider","section","weblink","cast","select"]),de={alert:"toggle",automation:"toggle",climate:"climate",cover:"cover",fan:"toggle",group:"group",input_boolean:"toggle",input_number:"input-number",input_select:"input-select",input_text:"input-text",light:"toggle",lock:"lock",media_player:"media-player",remote:"toggle",scene:"scene",script:"script",sensor:"sensor",timer:"timer",switch:"toggle",vacuum:"toggle",water_heater:"climate",input_datetime:"input-datetime"},ue=function(e,t){void 0===t&&(t=!1);var n=function(e,t){return s("hui-error-card",{type:"error",error:e,config:t})},s=function(e,t){var s=window.document.createElement(e);try{if(!s.setConfig)return;s.setConfig(t)}catch(s){return console.error(e,s),n(s.message,t)}return s};if(!e||"object"!=typeof e||!t&&!e.type)return n("No type defined",e);var r=e.type;if(r&&r.startsWith("custom:"))r=r.substr(7);else if(t)if(ce.has(r))r="hui-"+r+"-row";else{if(!e.entity)return n("Invalid config given.",e);var i=e.entity.split(".",1)[0];r="hui-"+(de[i]||"text")+"-entity-row"}else r="hui-"+r+"-card";if(customElements.get(r))return s(r,e);var o=n("Custom element doesn't exist: "+e.type+".",e);o.style.display="None";var a=setTimeout((function(){o.style.display=""}),2e3);return customElements.whenDefined(e.type).then((function(){clearTimeout(a),le(o,"ll-rebuild",{},o)})),o},he=function(e,t,n){var s;return void 0===n&&(n=!1),function(){var r=[].slice.call(arguments),i=this,o=n&&!s;clearTimeout(s),s=setTimeout((function(){s=null,n||e.apply(i,r)}),t),o&&e.apply(i,r)}},pe={alert:"mdi:alert",automation:"mdi:playlist-play",calendar:"mdi:calendar",camera:"mdi:video",climate:"mdi:thermostat",configurator:"mdi:settings",conversation:"mdi:text-to-speech",device_tracker:"mdi:account",fan:"mdi:fan",group:"mdi:google-circles-communities",history_graph:"mdi:chart-line",homeassistant:"mdi:home-assistant",homekit:"mdi:home-automation",image_processing:"mdi:image-filter-frames",input_boolean:"mdi:drawing",input_datetime:"mdi:calendar-clock",input_number:"mdi:ray-vertex",input_select:"mdi:format-list-bulleted",input_text:"mdi:textbox",light:"mdi:lightbulb",mailbox:"mdi:mailbox",notify:"mdi:comment-alert",person:"mdi:account",plant:"mdi:flower",proximity:"mdi:apple-safari",remote:"mdi:remote",scene:"mdi:google-pages",script:"mdi:file-document",sensor:"mdi:eye",simple_alarm:"mdi:bell",sun:"mdi:white-balance-sunny",switch:"mdi:flash",timer:"mdi:timer",updater:"mdi:cloud-upload",vacuum:"mdi:robot-vacuum",water_heater:"mdi:thermometer",weblink:"mdi:open-in-new"};function ge(e,t){if(e in pe)return pe[e];switch(e){case"alarm_control_panel":switch(t){case"armed_home":return"mdi:bell-plus";case"armed_night":return"mdi:bell-sleep";case"disarmed":return"mdi:bell-outline";case"triggered":return"mdi:bell-ring";default:return"mdi:bell"}case"binary_sensor":return t&&"off"===t?"mdi:radiobox-blank":"mdi:checkbox-marked-circle";case"cover":return"closed"===t?"mdi:window-closed":"mdi:window-open";case"lock":return t&&"unlocked"===t?"mdi:lock-open":"mdi:lock";case"media_player":return t&&"off"!==t&&"idle"!==t?"mdi:cast-connected":"mdi:cast";case"zwave":switch(t){case"dead":return"mdi:emoticon-dead";case"sleeping":return"mdi:sleep";case"initializing":return"mdi:timer-sand";default:return"mdi:z-wave"}default:return console.warn("Unable to find icon for domain "+e+" ("+t+")"),"mdi:bookmark"}}var me=function(e,t){var n=t.value||t,s=t.attribute?e.attributes[t.attribute]:e.state;switch(t.operator||"=="){case"==":return s===n;case"<=":return s<=n;case"<":return s<n;case">=":return s>=n;case">":return s>n;case"!=":return s!==n;case"regex":return s.match(n);default:return!1}},fe=function(e){le(window,"haptic",e)},ye=function(e,t,n){void 0===n&&(n=!1),n?history.replaceState(null,"",t):history.pushState(null,"",t),le(window,"location-changed",{replace:n})},be=function(e,t,n){void 0===n&&(n=!0);var s,r=I(t),i="group"===r?"homeassistant":r;switch(r){case"lock":s=n?"unlock":"lock";break;case"cover":s=n?"open_cover":"close_cover";break;default:s=n?"turn_on":"turn_off"}return e.callService(i,s,{entity_id:t})},_e=function(e,t){var n=se.includes(e.states[t].state);return be(e,t,n)},ve=function(e,t,n,s){if(s||(s={action:"more-info"}),!s.confirmation||s.confirmation.exemptions&&s.confirmation.exemptions.some((function(e){return e.user===t.user.id}))||(fe("warning"),confirm(s.confirmation.text||"Are you sure you want to "+s.action+"?")))switch(s.action){case"more-info":(n.entity||n.camera_image)&&le(e,"hass-more-info",{entityId:n.entity?n.entity:n.camera_image});break;case"navigate":s.navigation_path&&ye(0,s.navigation_path);break;case"url":s.url_path&&window.open(s.url_path);break;case"toggle":n.entity&&(_e(t,n.entity),fe("success"));break;case"call-service":if(!s.service)return void fe("failure");var r=s.service.split(".",2);t.callService(r[0],r[1],s.service_data,s.target),fe("success");break;case"fire-dom-event":le(e,"ll-custom",s)}},we=function(e,t,n,s){var r;"double_tap"===s&&n.double_tap_action?r=n.double_tap_action:"hold"===s&&n.hold_action?r=n.hold_action:"tap"===s&&n.tap_action&&(r=n.tap_action),ve(e,t,n,r)},Se=function(e,t,n,s,r){var i;if(r&&n.double_tap_action?i=n.double_tap_action:s&&n.hold_action?i=n.hold_action:!s&&n.tap_action&&(i=n.tap_action),i||(i={action:"more-info"}),!i.confirmation||i.confirmation.exemptions&&i.confirmation.exemptions.some((function(e){return e.user===t.user.id}))||confirm(i.confirmation.text||"Are you sure you want to "+i.action+"?"))switch(i.action){case"more-info":(i.entity||n.entity||n.camera_image)&&(le(e,"hass-more-info",{entityId:i.entity?i.entity:n.entity?n.entity:n.camera_image}),i.haptic&&fe(i.haptic));break;case"navigate":i.navigation_path&&(ye(0,i.navigation_path),i.haptic&&fe(i.haptic));break;case"url":i.url_path&&window.open(i.url_path),i.haptic&&fe(i.haptic);break;case"toggle":n.entity&&(_e(t,n.entity),i.haptic&&fe(i.haptic));break;case"call-service":if(!i.service)return;var o=i.service.split(".",2),a=o[0],l=o[1],c=L({},i.service_data);"entity"===c.entity_id&&(c.entity_id=n.entity),t.callService(a,l,c,i.target),i.haptic&&fe(i.haptic);break;case"fire-dom-event":le(e,"ll-custom",i),i.haptic&&fe(i.haptic)}};function xe(e){return void 0!==e&&"none"!==e.action}function $e(e,t,n){if(t.has("config")||n)return!0;if(e.config.entity){var s=t.get("hass");return!s||s.states[e.config.entity]!==e.hass.states[e.config.entity]}return!1}function Ce(e){return void 0!==e&&"none"!==e.action}var Me=function(e,t,n){void 0===n&&(n=!0);var s={};t.forEach((function(t){if(se.includes(e.states[t].state)===n){var r=I(t),i=["cover","lock"].includes(r)?r:"homeassistant";i in s||(s[i]=[]),s[i].push(t)}})),Object.keys(s).forEach((function(t){var r;switch(t){case"lock":r=n?"unlock":"lock";break;case"cover":r=n?"open_cover":"close_cover";break;default:r=n?"turn_on":"turn_off"}e.callService(t,r,{entity_id:s[t]})}))},Ae=function(){var e=document.querySelector("home-assistant");if(e=(e=(e=(e=(e=(e=(e=(e=e&&e.shadowRoot)&&e.querySelector("home-assistant-main"))&&e.shadowRoot)&&e.querySelector("app-drawer-layout partial-panel-resolver"))&&e.shadowRoot||e)&&e.querySelector("ha-panel-lovelace"))&&e.shadowRoot)&&e.querySelector("hui-root")){var t=e.lovelace;return t.current_view=e.___curView,t}return null},ke={humidity:"mdi:water-percent",illuminance:"mdi:brightness-5",temperature:"mdi:thermometer",pressure:"mdi:gauge",power:"mdi:flash",signal_strength:"mdi:wifi"},De={binary_sensor:function(e,t){var n="off"===e;switch(null==t?void 0:t.attributes.device_class){case"battery":return n?"mdi:battery":"mdi:battery-outline";case"battery_charging":return n?"mdi:battery":"mdi:battery-charging";case"cold":return n?"mdi:thermometer":"mdi:snowflake";case"connectivity":return n?"mdi:server-network-off":"mdi:server-network";case"door":return n?"mdi:door-closed":"mdi:door-open";case"garage_door":return n?"mdi:garage":"mdi:garage-open";case"power":case"plug":return n?"mdi:power-plug-off":"mdi:power-plug";case"gas":case"problem":case"safety":case"tamper":return n?"mdi:check-circle":"mdi:alert-circle";case"smoke":return n?"mdi:check-circle":"mdi:smoke";case"heat":return n?"mdi:thermometer":"mdi:fire";case"light":return n?"mdi:brightness-5":"mdi:brightness-7";case"lock":return n?"mdi:lock":"mdi:lock-open";case"moisture":return n?"mdi:water-off":"mdi:water";case"motion":return n?"mdi:walk":"mdi:run";case"occupancy":case"presence":return n?"mdi:home-outline":"mdi:home";case"opening":return n?"mdi:square":"mdi:square-outline";case"running":return n?"mdi:stop":"mdi:play";case"sound":return n?"mdi:music-note-off":"mdi:music-note";case"update":return n?"mdi:package":"mdi:package-up";case"vibration":return n?"mdi:crop-portrait":"mdi:vibrate";case"window":return n?"mdi:window-closed":"mdi:window-open";default:return n?"mdi:radiobox-blank":"mdi:checkbox-marked-circle"}},cover:function(e){var t="closed"!==e.state;switch(e.attributes.device_class){case"garage":return t?"mdi:garage-open":"mdi:garage";case"door":return t?"mdi:door-open":"mdi:door-closed";case"shutter":return t?"mdi:window-shutter-open":"mdi:window-shutter";case"blind":return t?"mdi:blinds-open":"mdi:blinds";case"window":return t?"mdi:window-open":"mdi:window-closed";default:return ge("cover",e.state)}},sensor:function(e){var t=e.attributes.device_class;if(t&&t in ke)return ke[t];if("battery"===t){var n=Number(e.state);if(isNaN(n))return"mdi:battery-unknown";var s=10*Math.round(n/10);return s>=100?"mdi:battery":s<=0?"mdi:battery-alert":"hass:battery-"+s}var r=e.attributes.unit_of_measurement;return"°C"===r||"°F"===r?"mdi:thermometer":ge("sensor")},input_datetime:function(e){return e.attributes.has_date?e.attributes.has_time?ge("input_datetime"):"mdi:calendar":"mdi:clock"}},Ee=function(e){if(!e)return"mdi:bookmark";if(e.attributes.icon)return e.attributes.icon;var t=I(e.entity_id);return t in De?De[t](e):ge(t,e.state)}},835:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getNestedProperty=void 0,t.deepMerge=function e(t,n){const s={...t};for(const t of Object.keys(n)){const r=s[t],o=n[t];"type"===t||Array.isArray(r)&&Array.isArray(o)?s[t]=o:i(r)&&i(o)?s[t]=e({...r},o):s[t]=o}return s},t.isObject=i,t.generateControl=function(e,n){const i={...n,hass:n._hass,window},o=!e.visibilityCondition||n._evaluateCondition(e.visibilityCondition,i),a=!!e.disabledCondition&&n._evaluateCondition(e.disabledCondition,i),l=!!e.requiredCondition&&n._evaluateCondition(e.requiredCondition,i);if(!o)return null;if("selector"in e&&e.selector&&e.selector.select&&e.selector.select.optionsCondition){const t=n._evaluateCondition(e.selector.select.optionsCondition,i);e.selector.select.options=t}switch(e.type){case"Selector":return s.html`
                <div class="form-control">
                <ha-selector
                    .hass=${n._hass}
                    .selector=${e.selector}
                    .configValue=${e.configValue}
                    .value=${(0,t.getNestedProperty)(n._config,e.configValue)}
                    .label=${e.label}
                    .helper=${e.helper}
                    .disabled=${a}
                    .required=${l}
                    @value-changed=${n._valueChanged}
                ></ha-selector>
                </div>
                `;case"Filler":return s.html`<div class="form-control"></div>`;case"Divider":return s.html`<hr>`;case"Message":return s.html`
                <div class="form-control">
                    <ha-alert alert-type=${e.alertType||"info"} title=${e.title||""}>
                        ${e.message||""}
                    </ha-alert>
                </div>
            `;case"RawHTML":return s.html`
                <div class="form-control">
                    ${(0,r.unsafeHTML)(e.html||"")}
                </div>
            `;case"ColorPreview":let i,o=(0,t.getNestedProperty)(n._config,e.configValue);o?i=o:(o="#1B1B249A",i="Color Not Set");const c=o.startsWith("var(");let d=o;if(c){const e=o.match(/var\((--[^,)]+)\)/),t=e?e[1]:o;d=getComputedStyle(document.documentElement).getPropertyValue(t).trim(),d||(console.warn(`CSS variable ${t} is not defined. Using fallback color.`),d="#0000ff")}else"#1B1B249A"!==o&&(i="User Defined Color");const u=e=>{let t,n,s,r,i;return 8===(e=e.replace(/^#/,"")).length?(t=parseInt(e,16),n=t>>24&255,s=t>>16&255,r=t>>8&255,i=255&t,[n,s,r,i/255]):(t=parseInt(e,16),n=t>>16&255,s=t>>8&255,r=255&t,[n,s,r])},h=(e=>{const[t,n,s]=u(e),[r,i,o]=[t,n,s].map((e=>e/255)).map((e=>e<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4)));return.2126*r+.7152*i+.0722*o})(d)>.5?"#000":"#fff";return s.html`
                <div class="form-control">
                    <div style="-webkit-fill-available; height: 50px; background-color: ${o}; border-radius: 25px; border: 1px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: ${h};">
                        <div>${i}</div>
                        <div>${d}</div>
                    </div>
                </div>
            `;default:return s.html`
                <div class="form-control">
                    <ha-alert alert-type="error" title="Unsupported Control Type">
                    The control type "${e.type}" is not supported.
                </ha-alert>
                </div>
                `}};const s=n(243),r=n(534);function i(e){return null!==e&&"object"==typeof e}t.getNestedProperty=(e,t)=>t.split(".").reduce(((e,t)=>e&&e[t]),e)},41:(e,t,n)=>{"use strict";const s=n(356),r=n(243),i=n(534),o=n(369),a=n(835);class l extends r.LitElement{constructor(){super(...arguments),this._selectedTab="panel-0",this._userStyles=r.css``,this._mergeUserStyles=!0}setConfig(e){this._config=e,this.requestUpdate("_config")}set hass(e){this._hass=e}generateForm(e){if(!e)return r.html``;if(e.tabs)return this.generateTabs(e.tabs);{const t=e.render_form.map((e=>(0,o.isSection)(e)?this.generateSection(e):this.generateRow(e)));return r.html`
            <div class="card-form">
                ${t}
            </div>
        `}}_handleTabActivated(e){this._selectedTab=e.detail.name,this.requestUpdate()}generateTabs(e){const t=e.filter((e=>this._evaluateCondition(e.visibilityCondition||"true")));return r.html`
            <sl-tab-group @sl-tab-show=${this._handleTabActivated}>
                ${t.map(((e,t)=>r.html`
                    <sl-tab slot="nav" panel="panel-${t}" ?active=${this._selectedTab===`panel-${t}`}>
                        ${e.label}
                    </sl-tab>
                `))}
            </sl-tab-group>
            <div class="tab-content">
                ${t.map(((e,t)=>r.html`
                    <sl-tab-panel name="panel-${t}" ?hidden=${this._selectedTab!==`panel-${t}`}>
                        ${e.content.map((e=>"Section"===e.type?this.generateSection(e):this.generateRow(e)))}
                    </sl-tab-panel>
                `))}
            </div>
        `}generateSection(e){var t;if(e.visibilityCondition&&!this._evaluateCondition(e.visibilityCondition))return r.html``;const n=e.cssClass?`form-row ${e.cssClass}`:"form-row",s=`h${e.headerLevel||4}`,a=`\n            <${s} slot="header">\n                ${e.icon?`<ha-icon icon="${e.icon}"></ha-icon>`:""}\n                ${e.label}\n                ${e.secondary?`<div slot="secondary">${e.secondary}</div>`:""}\n            </${s}>\n        `;return r.html`
            <div class="${n}">
                <ha-expansion-panel
                    .expanded=${e.expanded||!1}
                    .noCollapse=${e.noCollapse||!1}
                    .outlined=${e.outlined||!0}
                    .leftChevron=${e.leftChevron||!1}
                    .secondary=${e.secondary||""}
                >
                    ${(0,i.unsafeHTML)(a)}
                    <div>
                        ${null===(t=e.rows)||void 0===t?void 0:t.map((e=>(0,o.isSection)(e)?this.generateSection(e):this.generateRow(e)))}
                    </div>
                </ha-expansion-panel>
            </div>
        `}generateRow(e){if(e.visibilityCondition&&!this._evaluateCondition(e.visibilityCondition))return r.html``;const t=e.cssClass?`form-row ${e.cssClass}`:"form-row";return r.html`
            <div class="${t}">
                ${e.label?r.html`<label>${e.label}</label>`:""}
                ${e.controls.map((e=>e.visibilityCondition&&!this._evaluateCondition(e.visibilityCondition)?r.html``:(0,a.generateControl)(e,this)))}
            </div>
        `}_evaluateCondition(e,t={}){try{return new Function("context","with(context) { return "+e+"; }").call(this,t)}catch(t){return console.error("Error evaluating condition:",e,t),!1}}_valueChanged(e){var t,n;if(!this._config||!this._hass)return;const r=e.target,i=null!==(n=null===(t=r.configValue)||void 0===t?void 0:t.split("."))&&void 0!==n?n:[],o=this._getNewValue(r,e.detail),a="HA-SELECTOR"===r.tagName&&Array.isArray(e.detail.value);this._updateConfig(i,o,a),(0,s.fireEvent)(this,"config-changed",{config:this._config},{bubbles:!0,composed:!0}),this.requestUpdate()}_getNewValue(e,t){var n,s,r;switch(e.tagName){case"HA-SELECTOR":return null==t?void 0:t.value;case"HA-SWITCH":return null!==(n=e.checked)&&void 0!==n?n:e.__checked;case"HA-CHECKBOX":return e.value;case"HA-FORM":return Object.values(null!==(s=null==t?void 0:t.value)&&void 0!==s?s:{})[0];default:return null!==(r=null==t?void 0:t.value)&&void 0!==r?r:e.value}}_updateConfig(e,t,n=!1){if(!e.length)return;e.join(".");let s={...this._config},r=s;for(let t=0;t<e.length-1;t++)r[e[t]]=r[e[t]]||{},r=r[e[t]];const i=e[e.length-1];""===t||null==t?delete r[i]:r[i]=t,this._config=(0,a.deepMerge)(this._config,s)}updated(e){super.updated(e);const t=this.constructor;this._mergeUserStyles?this.shadowRoot.adoptedStyleSheets=[t.styles.styleSheet,this._userStyles.styleSheet]:this.shadowRoot.adoptedStyleSheets=[this._userStyles.styleSheet]}static get styles(){return r.css`
            /* Base styles for the form container */
            .card-form {
                display: grid;
                grid-gap: 8px;
            }

             /* Styles for tabs */
            mwc-tab-bar {
                border-bottom: 1px solid var(--divider-color);
            }
            .tab-content {
                padding: 10px;
            }
            .tab-panel {
                display: none;
            }
            .tab-panel:not([hidden]) {
                display: block;
            }
            /* Base styles for form rows */
            .form-row {
                display: grid;
                grid-template-columns: 1fr;
                grid-gap: 8px;
                /* margin-bottom: 10px; */
                border-radius: 10px;
            }

            /* Styles for form rows with two controls */
            .form-row.two-controls {
                grid-template-columns: 1fr 1fr;
            }
            /* Labels in form rows with two controls */
            .form-row.two-controls label {
                grid-column: span 2; /* Make the label span across both columns */
                justify-self: start; /* Left-justify the label */
                font-weight: bold;
                height: auto;
                margin-bottom: 5px; /* Add some space below the label */
                padding-left: 8px;
            }

            /* ensure full width for form controls not in two-controls class */

            .form-row:not(.two-controls) .form-control > * {
                width: -webkit-fill-available;
            }

            /* Base styles for form controls */
            .form-control {
                display: flex; /* Use flexbox for internal alignment */
                align-items: center;
                padding: 8px;
                border-radius: 10px;
            }

            /* Label styles within form controls */
            .form-control label {
                font-weight: bold;
                padding-left: 8px;
            }

            /* Styles for expandable sections */
            ha-expansion-panel {
                margin-bottom: 10px;
                border-radius: var(--ha-card-border-radius, 34px);
            }
            ha-expansion-panel[outlined] {
                border: 2px solid var(--chip-background-color);
            }
            ha-expansion-panel[expanded] {
                background-color: var(--chip-background-color);
            }
            h1 > ha-icon,
            h2 > ha-icon,
            h3 > ha-icon,
            h4 > ha-icon,
            h5 > ha-icon,
            h6 > ha-icon {
                margin: 0 8px;
            }

            hr {
                width: 95%;
                border: 1px solid var(--chip-background-color);
            }

            /* Styles for form errors */
            .form-error {
                color: var(--error-color); /* Home Assistant theme color */
                font-size: 0.875em;
                margin-top: 5px;
            }
        `}}t.A=l},369:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSection=function(e){return"Section"===e.type},t.isControlRow=function(e){return"ControlRow"===e.type}},640:(e,t,n)=>{"use strict";n.d(t,{A1:()=>u,CZ:()=>l,FS:()=>o,WG:()=>s,ZU:()=>a,iM:()=>c,i_:()=>r,ry:()=>i,ur:()=>d});const s=n(330).version,r="https://cb-lcars.unimatrix01.ca",i=["https://fonts.googleapis.com/css2?family=Antonio:wght@100;700&display=swap","cb-lcars_jeffries","cb-lcars_microgramma"],o="/hacsfiles/cb-lcars/cb-lcars-lovelace.yaml",a="/hacsfiles/cb-lcars/cb-lcars-stub-config.yaml",l="/hacsfiles/cb-lcars/cb-lcars-themes.yaml",c="/hacsfiles/cb-lcars/editor",d=["ncc-1701-a","ncc-1701-a-blue","enterprise-d-shuttlecraft15-anomaly"],u="/hacsfiles/cb-lcars/msd/"},953:(e,t,n)=>{"use strict";n.d(t,{z:()=>s});class s{static resolveContent(e,t,n="Renderer"){let s=t.value||e.text||e.content||e.label||"";if(!s&&e._raw?.content&&(s=e._raw.content),!s&&e._raw?.text&&(s=e._raw.text),!s&&e._raw?.label&&(s=e._raw.label),!e.data_source&&e._raw?.data_source&&(e.data_source=e._raw.data_source),s&&"string"==typeof s&&s.includes("{"))return s=this.processEnhancedTemplateStrings(s,n),s;if(s)return s;if(e.data_source||t.data_source){const s=this.resolveDataSourceContent(e.data_source||t.data_source,t,n);if(null!==s)return s}return s}static resolveDataSourceContent(e,t,n="Renderer"){try{const s=window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager;if(!s)return null;const{sourceName:r,dataKey:i,isTransformation:o,isAggregation:a}=this.parseDataSourceReference(e),l=s.getSource(r);if(!l)return console.warn(`[${n}] DataSource '${r}' not found`),`[Source: ${r} not found]`;const c=l.getCurrentData();let d=c?.v;if(i&&o&&c?.transformations)d=c.transformations[i];else if(i&&a&&c?.aggregations){const e=c.aggregations[i];d="object"==typeof e&&null!==e?void 0!==e.avg?e.avg:void 0!==e.value?e.value:void 0!==e.last?e.last:JSON.stringify(e):e}return null!=d?this.formatDataSourceValue(d,t,c):`[${e}: no data]`}catch(e){return console.error(`[${n}] Error resolving DataSource content:`,e),`[DataSource Error: ${e.message}]`}}static parseDataSourceReference(e){const t=e.split("."),n=t[0];if(1===t.length)return{sourceName:n,dataKey:null,isTransformation:!1,isAggregation:!1};if(t.length>=3){const e=t[1];return{sourceName:n,dataKey:t.slice(2).join("."),isTransformation:"transformations"===e,isAggregation:"aggregations"===e}}return{sourceName:n,dataKey:null,isTransformation:!1,isAggregation:!1}}static formatDataSourceValue(e,t,n=null){const s=t.value_format||t.format;return"function"==typeof s?s(e):"string"==typeof s?s.includes("{value")?s.replace(/\{value(?::([^}]+))?\}/g,((t,s)=>s?this.applyNumberFormat(e,s,n?.unit_of_measurement):String(e))):s.replace("{value}",String(e)):"number"==typeof e?Number.isInteger(e)?String(e):e.toFixed(1):String(e)}static applyNumberFormat(e,t,n){if("number"!=typeof e)return String(e);if(t.endsWith("%")){const s=parseInt(t.slice(1,-1))||0;return"%"===n?(console.log(`[DataSourceMixin] Unit-aware formatting: ${e} with unit="${n}" → ${e.toFixed(s)}% (no conversion)`),`${e.toFixed(s)}%`):(console.log(`[DataSourceMixin] Unit-aware formatting: ${e} with unit="${n||"none"}" → ${(100*e).toFixed(s)}% (×100 conversion)`),`${(100*e).toFixed(s)}%`)}if(t.endsWith("f")){const n=parseInt(t.slice(1,-1))||1;return e.toFixed(n)}return"d"===t?Math.round(e).toString():String(e)}static processEnhancedTemplateStrings(e,t="Renderer"){return this.processEnhancedTemplateStringsWithFallback(e,t,!0)}static processTemplateForInitialRender(e,t="Renderer"){if(!e||"string"!=typeof e||!e.includes("{"))return e;console.log(`[${t}] Processing template for initial render: "${e}"`);const n=this.processEnhancedTemplateStringsWithFallback(e,t,!0);return n===e&&console.log(`[${t}] Templates not resolved during initial render, will update when DataSources become available`),n}static processEnhancedTemplateStringsWithFallback(e,t="Renderer",n=!0){try{const s=window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager;if(!s)return console.log(`[${t}] DataSourceManager not available, ${n?"returning original content":"returning null"}`),n?e:null;let r=!1;const i=e.replace(/\{([^}]+)\}/g,((e,i)=>{try{const[o,a]=i.split(":"),l=o.trim(),{sourceName:c,dataKey:d,isTransformation:u,isAggregation:h}=this.parseDataSourceReference(l),p=s.getSource(c);if(!p)return console.warn(`[${t}] DataSource '${c}' not found`),r=!0,n?e:`[Source: ${c} not found]`;const g=p.getCurrentData();let m=g?.v;if(d&&u&&g?.transformations)m=g.transformations[d];else if(d&&h&&g?.aggregations){const e=g.aggregations[d];if("object"==typeof e&&null!==e){const t=d.split(".");if(t.length>1){const e=t[0],n=t.slice(1).join("."),s=g.aggregations[e];s&&"object"==typeof s&&(m=this.getNestedValue(s,n))}else m=void 0!==e.avg?e.avg:void 0!==e.value?e.value:void 0!==e.last?e.last:void 0!==e.direction?e.direction:JSON.stringify(e)}else m=e}return null==m?(console.warn(`[${t}] No value found for reference '${i}'`),r=!0,n?e:`[No data: ${i}]`):a?this.applyNumberFormat(m,a.trim(),g?.unit_of_measurement):String(m)}catch(s){return console.error(`[${t}] Template processing error for '${i}':`,s),r=!0,n?e:`[Error: ${i}]`}}));return r||i===e||console.log(`[${t}] Successfully resolved all templates in: "${e}" → "${i}"`),i}catch(s){return console.error(`[${t}] Enhanced template processing failed:`,s),n?e:null}}static getNestedValue(e,t){return t.split(".").reduce(((e,t)=>e&&void 0!==e[t]?e[t]:void 0),e)}static getDataSourceManager(){return window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager||null}static getAvailableDataSources(){const e=this.getDataSourceManager();return e?Array.from(e.sources.keys()):[]}}},778:(e,t,n)=>{"use strict";n.d(t,{Q:()=>s});class s{static resolvePosition(e,t){if(Array.isArray(e)&&e.length>=2)return[Number(e[0]),Number(e[1])];if("string"==typeof e&&t[e]){const n=t[e];if(Array.isArray(n)&&n.length>=2)return[Number(n[0]),Number(n[1])]}return console.warn("[PositionResolver] Could not resolve position:",e),null}}},659:(e,t,n)=>{"use strict";n.d(t,{T:()=>s});class s{static _getTextMeasureContext(){return window.cblcars||(window.cblcars={}),window.cblcars._textMeasureCanvas||(window.cblcars._textMeasureCanvas=document.createElement("canvas"),window.cblcars._textMeasureContext=window.cblcars._textMeasureCanvas.getContext("2d"),window.cblcars._textMeasureCache=new Map),window.cblcars._textMeasureContext}static _getSvgTransformInfo(e){try{const t=e?.querySelector("svg");if(!t)return null;const n=t.viewBox.baseVal,s=t.getBoundingClientRect(),r=n.width/s.width,i=n.height/s.height;return{svg:t,viewBox:[n.x,n.y,n.width,n.height],screenRect:{width:s.width,height:s.height},scaleX:r,scaleY:i,pixelToViewBox:e=>e*Math.max(r,i)}}catch(e){return console.warn("[RendererUtils] Failed to get SVG transform info:",e),null}}static measureText(e,t="16px Arial",n=!0,s=null){if(!e)return{width:0,height:0,ascent:0,descent:0};const r=`${e}::${t}`,i=window.cblcars?._textMeasureCache;if(n&&i&&i.has(r)){const e=i.get(r);return s?this._transformTextMetrics(e,s):e}const o=this._getTextMeasureContext();o.font=t;const a=o.measureText(e),l={width:a.width,height:a.actualBoundingBoxAscent+a.actualBoundingBoxDescent,ascent:a.actualBoundingBoxAscent,descent:a.actualBoundingBoxDescent,actualLeft:a.actualBoundingBoxLeft||0,actualRight:a.actualBoundingBoxRight||a.width,_pixelWidth:a.width,_pixelHeight:a.actualBoundingBoxAscent+a.actualBoundingBoxDescent,_pixelAscent:a.actualBoundingBoxAscent,_pixelDescent:a.actualBoundingBoxDescent};return n&&i&&i.set(r,l),s?this._transformTextMetrics(l,s):l}static _transformTextMetrics(e,t){const n=this._getSvgTransformInfo(t);if(!n)return console.warn("[RendererUtils] No transform info available, using pixel metrics"),e;const{pixelToViewBox:s}=n,r={...e,width:s(e._pixelWidth||e.width),height:s(e._pixelHeight||e.height),ascent:s(e._pixelAscent||e.ascent),descent:s(e._pixelDescent||e.descent),actualLeft:s(e.actualLeft),actualRight:s(e.actualRight)};return console.log("[RendererUtils] Transformed text metrics:",{original:{width:e.width,height:e.height},transformed:{width:r.width,height:r.height},scaleInfo:{scaleX:n.scaleX,scaleY:n.scaleY}}),r}static measureMultilineText(e,t="16px Arial",n=1.2,s=!0,r=null){if(!e)return{width:0,height:0,lines:[],lineMetrics:[]};const i=e.split("\n"),o=i.map((e=>this.measureText(e,t,s,r))),a=Math.max(...o.map((e=>e.width))),l=this._parseFontSize(t);let c=l,d=n;if(r){const e=this._getSvgTransformInfo(r);e&&(c=e.pixelToViewBox(l),d=n)}return{width:a,height:i.length>1?o[0].ascent+(i.length-1)*c*d+o[o.length-1].descent:o[0]?.height||0,lines:i,lineMetrics:o,_transformApplied:!!r,_adjustedFontSize:c}}static getTextBoundingBox(e,t,n,s="16px Arial",r="start",i="auto",o=null){const a=this.measureText(e,s,!0,o);let l=t;"middle"===r?l=t-a.width/2:"end"===r&&(l=t-a.width);let c=n-a.ascent;"middle"===i?c=n-a.height/2:"hanging"===i&&(c=n);const d={left:l,right:l+a.width,top:c,bottom:c+a.height,width:a.width,height:a.height,centerX:l+a.width/2,centerY:c+a.height/2};return console.log("[RendererUtils] Text bounding box calculation:",{text:e.substring(0,20)+(e.length>20?"...":""),inputPosition:{x:t,y:n},textAnchor:r,dominantBaseline:i,metrics:{width:a.width,height:a.height,ascent:a.ascent,descent:a.descent},bbox:d,hasContainer:!!o}),d}static getTextAttachmentPoints(e,t,n,s="16px Arial",r="start",i="auto",o=null){const a=this.getTextBoundingBox(e,t,n,s,r,i,o),l=this._getSvgTransformInfo(o),c=l?l.pixelToViewBox(4):4;return{top:[a.centerX,a.top],bottom:[a.centerX,a.bottom],left:[a.left,a.centerY],right:[a.right,a.centerY],center:[a.centerX,a.centerY],topLeft:[a.left,a.top],topRight:[a.right,a.top],bottomLeft:[a.left,a.bottom],bottomRight:[a.right,a.bottom],topPadded:[a.centerX,a.top-c],bottomPadded:[a.centerX,a.bottom+c],leftPadded:[a.left-c,a.centerY],rightPadded:[a.right+c,a.centerY]}}static _parseFontSize(e){const t=e.match(/(\d+(?:\.\d+)?)px/);return t?parseFloat(t[1]):16}static buildFontString(e){const t=[];return e.fontStyle&&"normal"!==e.fontStyle&&t.push(e.fontStyle),e.fontWeight&&"normal"!==e.fontWeight&&t.push(e.fontWeight),t.push(`${e.fontSize}px`),e.fontFamily&&"inherit"!==e.fontFamily?t.push(e.fontFamily):t.push("Arial, sans-serif"),t.join(" ")}static resolveFontFamily(e,t){if(e.fontFamily&&"inherit"!==e.fontFamily)return e.fontFamily;try{const e=t?.querySelector?.("svg"),n=e||t||document.documentElement,s=window.getComputedStyle(n).fontFamily;if(s&&"inherit"!==s)return s}catch(e){console.warn("[RendererUtils] resolveFontFamily failed:",e)}return"Arial, sans-serif"}static buildMeasurementFontString(e,t){const n=this.resolveFontFamily(e,t),s=e.fontStyle&&"normal"!==e.fontStyle?`${e.fontStyle} `:"",r=e.fontWeight&&"normal"!==e.fontWeight?`${e.fontWeight} `:"";let i=e.fontSize;if(t){const n=this._getSvgTransformInfo(t);if(n){const t=n.screenRect.width/n.viewBox[2];i=e.fontSize*t}}return`${s}${r}${i}px ${n}`}static clearTextMeasureCache(){window.cblcars?._textMeasureCache&&window.cblcars._textMeasureCache.clear()}static getTextMeasureCacheStats(){const e=window.cblcars?._textMeasureCache;return{size:e?.size||0,keys:e?Array.from(e.keys()):[]}}static parseGradientConfig(e){if(!e)return null;if("string"==typeof e){if(e.includes(",")){const t=e.split(",").map((e=>e.trim()));return{type:"linear",direction:"horizontal",stops:t.map(((e,n)=>({offset:n/(t.length-1)*100+"%",color:e})))}}if(e.includes("-to-")){const[t,n]=e.split("-to-").map((e=>e.trim()));return{type:"linear",direction:"horizontal",stops:[{offset:"0%",color:t},{offset:"100%",color:n}]}}return null}return"object"==typeof e?{type:e.type||"linear",direction:e.direction||"horizontal",x1:e.x1||"0%",y1:e.y1||"0%",x2:e.x2||"100%",y2:e.y2||"0%",cx:e.cx||"50%",cy:e.cy||"50%",r:e.r||"50%",stops:e.stops||[{offset:"0%",color:e.from||"var(--lcars-orange)"},{offset:"100%",color:e.to||"var(--lcars-red)"}]}:null}static parsePatternConfig(e){return e?"string"==typeof e?{dots:{type:"dots",size:8,color:"currentColor",opacity:.5},lines:{type:"lines",size:4,color:"currentColor",opacity:.5},diagonal:{type:"diagonal",size:8,color:"currentColor",opacity:.5},grid:{type:"grid",size:10,color:"currentColor",opacity:.3}}[e]||null:"object"==typeof e?{type:e.type||"dots",size:Number(e.size||8),color:e.color||"currentColor",opacity:Number(e.opacity||.5),content:e.content||null}:null:null}static parseGlowConfig(e){return e?{color:e.color||"var(--lcars-blue)",blur:Number(e.blur||3),intensity:Number(e.intensity||.8)}:null}static parseStandardTextStyles(e){return{fontSize:Number(e.font_size||e.fontSize||12),fontFamily:e.font_family||e.fontFamily||"monospace",fontWeight:e.font_weight||e.fontWeight||"normal",fontStyle:e.font_style||e.fontStyle||"normal",textColor:e.text_color||e.textColor||e.color||"var(--lcars-white)",labelColor:e.label_color||e.labelColor||e.text_color||e.textColor||"var(--lcars-white)",valueColor:e.value_color||e.valueColor||e.text_color||e.textColor||"var(--lcars-white)",textAlign:e.text_align||e.textAlign||"left",verticalAlign:e.vertical_align||e.verticalAlign||"middle",textShadow:this.parseTextShadowConfig(e.text_shadow||e.textShadow),textStroke:this.parseTextStrokeConfig(e.text_stroke||e.textStroke),lineHeight:Number(e.line_height||e.lineHeight||1.2),letterSpacing:e.letter_spacing||e.letterSpacing||"normal"}}static parseStandardColorStyles(e){return{primaryColor:e.color||e.primary_color||e.primaryColor||"var(--lcars-blue)",backgroundColor:e.background_color||e.backgroundColor||"transparent",borderColor:e.border_color||e.borderColor||"var(--lcars-gray)",hoverColor:e.hover_color||e.hoverColor||"var(--lcars-yellow)",activeColor:e.active_color||e.activeColor||"var(--lcars-cyan)",focusColor:e.focus_color||e.focusColor||"var(--lcars-white)",disabledColor:e.disabled_color||e.disabledColor||"var(--lcars-gray)",successColor:e.success_color||e.successColor||"var(--lcars-green)",warningColor:e.warning_color||e.warningColor||"var(--lcars-yellow)",errorColor:e.error_color||e.errorColor||"var(--lcars-red)",infoColor:e.info_color||e.infoColor||"var(--lcars-cyan)"}}static parseStandardLayoutStyles(e){return{borderWidth:Number(e.border_width||e.borderWidth||1),borderRadius:Number(e.border_radius||e.borderRadius||0),borderStyle:e.border_style||e.borderStyle||"solid",padding:this.parsePaddingConfig(e.padding),margin:this.parseMarginConfig(e.margin),opacity:Number(e.opacity||1),visible:!1!==e.visible,minWidth:e.min_width||e.minWidth||null,maxWidth:e.max_width||e.maxWidth||null,minHeight:e.min_height||e.minHeight||null,maxHeight:e.max_height||e.maxHeight||null}}static parseStandardInteractionStyles(e){return{hoverEnabled:!1!==e.hover_enabled,hoverScale:Number(e.hover_scale||e.hoverScale||1.05),hoverOpacity:Number(e.hover_opacity||e.hoverOpacity||1),hoverTransition:e.hover_transition||e.hoverTransition||"all 0.2s ease",clickable:!1!==e.clickable,activeScale:Number(e.active_scale||e.activeScale||.95),focusEnabled:!1!==e.focus_enabled,focusOutline:e.focus_outline||e.focusOutline||!0,cursor:e.cursor||"default"}}static parseStandardAnimationStyles(e){return{animatable:!1!==e.animatable,transition:e.transition||"all 0.3s ease",transitionDelay:e.transition_delay||e.transitionDelay||"0s",transitionDuration:e.transition_duration||e.transitionDuration||"0.3s",transitionTimingFunction:e.transition_timing_function||e.transitionTimingFunction||"ease",animationDuration:e.animation_duration||e.animationDuration||"1s",animationTimingFunction:e.animation_timing_function||e.animationTimingFunction||"ease",animationDelay:e.animation_delay||e.animationDelay||"0s",animationIterationCount:e.animation_iteration_count||e.animationIterationCount||"1",animationDirection:e.animation_direction||e.animationDirection||"normal",animationFillMode:e.animation_fill_mode||e.animationFillMode||"both",cascadeSpeed:Number(e.cascade_speed||e.cascadeSpeed||0),cascadeDirection:e.cascade_direction||e.cascadeDirection||"row",revealAnimation:e.reveal_animation||e.revealAnimation||!1,pulseOnChange:e.pulse_on_change||e.pulseOnChange||!1}}static parseAllStandardStyles(e){return{text:this.parseStandardTextStyles(e),colors:this.parseStandardColorStyles(e),layout:this.parseStandardLayoutStyles(e),interaction:this.parseStandardInteractionStyles(e),animation:this.parseStandardAnimationStyles(e),gradient:this.parseGradientConfig(e.gradient),pattern:this.parsePatternConfig(e.pattern),glow:this.parseGlowConfig(e.glow),shadow:this.parseShadowConfig(e.shadow),blur:this.parseBlurConfig(e.blur)}}static parseTextShadowConfig(e){return e?{offsetX:Number(e.offset_x||e.offsetX||1),offsetY:Number(e.offset_y||e.offsetY||1),blur:Number(e.blur||2),color:e.color||"rgba(0,0,0,0.5)"}:null}static parseTextStrokeConfig(e){return e?{width:Number(e.width||1),color:e.color||"var(--lcars-gray)",opacity:Number(e.opacity||1)}:null}static parsePaddingConfig(e){return"number"==typeof e?{top:e,right:e,bottom:e,left:e}:"object"==typeof e&&null!==e?{top:Number(e.top||e.vertical||0),right:Number(e.right||e.horizontal||0),bottom:Number(e.bottom||e.vertical||0),left:Number(e.left||e.horizontal||0)}:{top:0,right:0,bottom:0,left:0}}static parseMarginConfig(e){return"number"==typeof e?{top:e,right:e,bottom:e,left:e}:"object"==typeof e&&null!==e?{top:Number(e.top||e.vertical||0),right:Number(e.right||e.horizontal||0),bottom:Number(e.bottom||e.vertical||0),left:Number(e.left||e.horizontal||0)}:{top:0,right:0,bottom:0,left:0}}static applyStandardTextStyles(e){const t=[];return t.push(`font-family="${e.fontFamily}"`),t.push(`font-size="${e.fontSize}"`),t.push(`font-weight="${e.fontWeight}"`),t.push(`font-style="${e.fontStyle}"`),t.push(`fill="${e.textColor}"`),t.push(`text-anchor="${e.textAlign}"`),t.push(`dominant-baseline="${e.verticalAlign}"`),t.push(`letter-spacing="${e.letterSpacing}"`),e.textStroke&&(t.push(`stroke="${e.textStroke.color}"`),t.push(`stroke-width="${e.textStroke.width}"`),t.push(`stroke-opacity="${e.textStroke.opacity}"`)),t.join(" ")}static applyStandardLayoutStyles(e){const t=[];return e.borderWidth>0&&t.push(`stroke-width="${e.borderWidth}"`),e.borderRadius>0&&(t.push(`rx="${e.borderRadius}"`),t.push(`ry="${e.borderRadius}"`)),t.push(`opacity="${e.opacity}"`),e.visible||t.push('style="display: none"'),t.join(" ")}static createTextShadowCSS(e){return e?`${e.offsetX}px ${e.offsetY}px ${e.blur}px ${e.color}`:""}static createAnimationDataAttributes(e){const t=[];return e.animatable&&t.push('data-animatable="true"'),e.cascadeSpeed>0&&(t.push(`data-cascade-speed="${e.cascadeSpeed}"`),t.push(`data-cascade-direction="${e.cascadeDirection}"`)),e.revealAnimation&&t.push('data-reveal-animation="true"'),e.pulseOnChange&&t.push('data-pulse-on-change="true"'),t.join(" ")}static parseShadowConfig(e){if(!e)return null;if(!0===e)return{color:"rgba(0,0,0,0.3)",offsetX:2,offsetY:2,blur:3};if("string"==typeof e){const t=e.split(" ");return{offsetX:Number(t[0])||2,offsetY:Number(t[1])||2,blur:Number(t[2])||3,color:t[3]||"rgba(0,0,0,0.3)"}}return"object"==typeof e?{color:e.color||"rgba(0,0,0,0.3)",offsetX:Number(e.offsetX||e.offset?.[0]||2),offsetY:Number(e.offsetY||e.offset?.[1]||2),blur:Number(e.blur||3)}:null}static parseBlurConfig(e){return e?"number"==typeof e?{amount:e}:"string"==typeof e?{amount:Number(e)||1}:"object"==typeof e?{amount:Number(e.amount||e.blur||1)}:null:null}static createGradientDefinition(e,t){if("radial"===e.type){const n=e.stops.map((e=>`<stop offset="${e.offset}" stop-color="${e.color}"/>`)).join("");return`<radialGradient id="${t}" cx="${e.cx}" cy="${e.cy}" r="${e.r}">\n                ${n}\n              </radialGradient>`}return`<linearGradient id="${t}" ${this.getLinearGradientCoords(e.direction,e)}>\n                ${e.stops.map((e=>`<stop offset="${e.offset}" stop-color="${e.color}"/>`)).join("")}\n              </linearGradient>`}static getLinearGradientCoords(e,t={}){if(void 0!==t.x1)return`x1="${t.x1}" y1="${t.y1}" x2="${t.x2}" y2="${t.y2}"`;const n={horizontal:'x1="0%" y1="0%" x2="100%" y2="0%"',vertical:'x1="0%" y1="0%" x2="0%" y2="100%"',diagonal:'x1="0%" y1="0%" x2="100%" y2="100%"',"diagonal-reverse":'x1="100%" y1="0%" x2="0%" y2="100%"',"to-right":'x1="0%" y1="0%" x2="100%" y2="0%"',"to-left":'x1="100%" y1="0%" x2="0%" y2="0%"',"to-bottom":'x1="0%" y1="0%" x2="0%" y2="100%"',"to-top":'x1="0%" y1="100%" x2="0%" y2="0%"'};return n[e]||n.horizontal}static createPatternDefinition(e,t){const n=e.size,s=e.color,r=e.opacity;let i="";switch(e.type){case"dots":default:i=`<circle cx="${n/2}" cy="${n/2}" r="1"\n                                  fill="${s}" opacity="${r}"/>`;break;case"lines":i=`<path d="M 0,${n} l ${n},-${n} M -1,1 l 2,-2 M ${n-1},${n+1} l 2,-2"\n                                stroke="${s}" stroke-width="1" opacity="${r}"/>`;break;case"diagonal":i=`<path d="M0,${n} L${n},0"\n                                stroke="${s}" stroke-width="1" opacity="${r}"/>`;break;case"grid":i=`\n          <path d="M0,0 L0,${n}" stroke="${s}" stroke-width="0.5" opacity="${r}"/>\n          <path d="M0,0 L${n},0" stroke="${s}" stroke-width="0.5" opacity="${r}"/>\n        `;break;case"custom":i=e.content||""}return`<pattern id="${t}" x="0" y="0" width="${n}" height="${n}"\n                     patternUnits="userSpaceOnUse">\n              ${i}\n            </pattern>`}static createGlowFilter(e,t){return`<filter id="${t}" x="-50%" y="-50%" width="200%" height="200%">\n              <feGaussianBlur stdDeviation="${e.size||4}" result="coloredBlur"/>\n              <feFlood flood-color="${e.color||"currentColor"}" flood-opacity="${e.intensity||1}"/>\n              <feComposite in="flood" in2="coloredBlur" operator="in" result="glowColor"/>\n              <feMerge>\n                <feMergeNode in="glowColor"/>\n                <feMergeNode in="SourceGraphic"/>\n              </feMerge>\n            </filter>`}static createShadowFilter(e,t){return`<filter id="${t}" x="-50%" y="-50%" width="200%" height="200%">\n              <feDropShadow dx="${e.offsetX||2}" dy="${e.offsetY||2}"\n                           stdDeviation="${e.blur||3}"\n                           flood-color="${e.color||"rgba(0,0,0,0.3)"}"/>\n            </filter>`}static createBlurFilter(e,t){return`<filter id="${t}" x="-50%" y="-50%" width="200%" height="200%">\n              <feGaussianBlur stdDeviation="${e.amount||1}"/>\n            </filter>`}static createLcarsBracket(e,t,n="left",s={}){s.bracketWidth;const r=s.cornerRadius||2,i=s.strokeWidth||2;let o="";return o="left"===n?`M ${e} 0 L ${r} 0\n                  Q 0 0 0 ${r}\n                  L 0 ${t-r}\n                  Q 0 ${t} ${r} ${t}\n                  L ${e} ${t}`:`M 0 0 L ${e-r} 0\n                  Q ${e} 0 ${e} ${r}\n                  L ${e} ${t-r}\n                  Q ${e} ${t} ${e-r} ${t}\n                  L 0 ${t}`,`<path d="${o}"\n                  stroke="${s.color||"var(--lcars-orange)"}"\n                  stroke-width="${i}"\n                  fill="none"/>`}static createMarkerDefinition(e,t){const n=this.getMarkerSize(e.size||"medium"),s="inherit"===e.color?"currentColor":e.color;let r="",i=`0 0 ${n} ${n}`,o=n/2,a=n/2;switch(e.type){case"arrow":i="0 0 10 10",o=8,a=5,r=`<path d="M2,2 L8,5 L2,8 z" fill="${s}"/>`;break;case"dot":case"circle":default:r=`<circle cx="${n/2}" cy="${n/2}" r="${n/4}" fill="${s}"/>`;break;case"diamond":r=`<path d="M${n/2},2 L${n-2},${n/2} L${n/2},${n-2} L2,${n/2} z" fill="${s}"/>`;break;case"square":r=`<rect x="2" y="2" width="${n-4}" height="${n-4}" fill="${s}"/>`;break;case"triangle":r=`<path d="M${n/2},2 L${n-2},${n-2} L2,${n-2} z" fill="${s}"/>`}return`<marker id="${t}"\n                    viewBox="${i}"\n                    refX="${o}" refY="${a}"\n                    markerWidth="${n}" markerHeight="${n}"\n                    markerUnits="strokeWidth"\n                    orient="${!1!==e.rotate?"auto":"0"}">\n              ${r}\n            </marker>`}static getMarkerSize(e){return"number"==typeof e?e:{small:6,medium:8,large:12,xlarge:16}[e]||8}static escapeXml(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}static generateId(e="element",t=""){return`${e}-${Date.now().toString(36)}-${Math.random().toString(36).substr(2,5)}${t?"-"+t:""}`}static parseColor(e){const t=document.createElement("div");t.style.color=e,document.body.appendChild(t);const n=getComputedStyle(t).color;document.body.removeChild(t);const s=n.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(s){const t=parseInt(s[1]),r=parseInt(s[2]),i=parseInt(s[3]);return{rgb:[t,r,i],hex:this.rgbToHex(t,r,i),hsl:this.rgbToHsl(t,r,i),original:e,computed:n}}return{original:e,computed:n}}static rgbToHex(e,t,n){return"#"+((1<<24)+(e<<16)+(t<<8)+n).toString(16).slice(1)}static rgbToHsl(e,t,n){e/=255,t/=255,n/=255;const s=Math.max(e,t,n),r=Math.min(e,t,n);let i,o,a=(s+r)/2;if(s===r)i=o=0;else{const l=s-r;switch(o=a>.5?l/(2-s-r):l/(s+r),s){case e:i=(t-n)/l+(t<n?6:0);break;case t:i=(n-e)/l+2;break;case n:i=(e-t)/l+4}i/=6}return[Math.round(360*i),Math.round(100*o),Math.round(100*a)]}static getContrastColor(e){const t=this.parseColor(e);if(!t.rgb)return"#ffffff";const[n,s,r]=t.rgb;return(.299*n+.587*s+.114*r)/255>.5?"#000000":"#ffffff"}static interpolateColor(e,t,n){const s=this.parseColor(e),r=this.parseColor(t);return s.rgb&&r.rgb?`rgb(${Math.round(s.rgb[0]+(r.rgb[0]-s.rgb[0])*n)}, ${Math.round(s.rgb[1]+(r.rgb[1]-s.rgb[1])*n)}, ${Math.round(s.rgb[2]+(r.rgb[2]-s.rgb[2])*n)})`:e}static createAnimationAttributes(e={}){const t=[];if(!1!==e.animatable&&t.push('data-animatable="true"'),Object.keys(e).forEach((n=>{if(n.endsWith("_speed")||n.endsWith("Speed")){const s=e[n];if(s>0){const e=n.replace(/([A-Z])/g,"-$1").toLowerCase().replace("_","-");t.push(`data-${e}="${s}"`)}}})),e.animation_ref||e.animationRef){const n=e.animation_ref||e.animationRef;t.push(`data-animation-ref="${n}"`)}return t}static sanitizeStyles(e){const t={},n={color:e=>this.isValidColor(e),opacity:e=>this.isValidOpacity(e),width:e=>this.isValidNumber(e),height:e=>this.isValidNumber(e),stroke:e=>this.isValidColor(e),fill:e=>this.isValidColor(e)||"none"===e,fontSize:e=>this.isValidNumber(e),fontFamily:e=>this.isValidString(e)};return Object.keys(e).forEach((s=>{const r=n[s]||n[this.camelToKebab(s)];r&&r(e[s])&&(t[s]=e[s])})),t}static isValidColor(e){return"string"==typeof e&&/^(#[0-9a-f]{3,8}|rgb\(|rgba\(|hsl\(|hsla\(|var\(--|\w+)/.test(e.toLowerCase())}static isValidOpacity(e){const t=Number(e);return!isNaN(t)&&t>=0&&t<=1}static isValidNumber(e){return!isNaN(Number(e))&&isFinite(Number(e))}static isValidString(e){return"string"==typeof e&&e.length>0}static camelToKebab(e){return e.replace(/([A-Z])/g,"-$1").toLowerCase()}static getDomTextBBox(e){try{if(!e)return null;const t=e.querySelector("text");if(!t)return null;const n=t.getBBox();return{width:n.width,height:n.height,left:n.x,top:n.y,right:n.x+n.width,bottom:n.y+n.height,centerX:n.x+n.width/2,centerY:n.y+n.height/2}}catch(e){return null}}}},254:(e,t,n)=>{"use strict";n.r(t),n.d(t,{StatusGridRenderer:()=>o});var s=n(778),r=n(659),i=n(953);class o{constructor(){this.gradientCache=new Map,this.patternCache=new Map,this.filterCache=new Map}static render(e,t,n){return(new o).renderStatusGrid(e,t,n)}renderStatusGrid(e,t,n){const r=s.Q.resolvePosition(e.position,t);if(!r)return console.warn("[StatusGridRenderer] Status grid overlay position could not be resolved:",e.id),"";const[i,o]=r,a=e.size||[200,150],[l,c]=a;try{const t=e.finalStyle||e.style||{},n=this._resolveStatusGridStyles(t,e.id,e),s=this._prepareAnimationAttributes(e,t),r=this._resolveCellConfigurations(e,n);return console.log(`[StatusGridRenderer] Rendering ${r.length} cells for grid ${e.id}`),this._renderEnhancedStatusGrid(e,i,o,l,c,r,n,s)}catch(t){return console.error(`[StatusGridRenderer] Enhanced rendering failed for status grid ${e.id}:`,t),this._renderFallbackStatusGrid(e,i,o,l,c)}}_resolveStatusGridStyles(e,t,n=null){const s=r.T.parseAllStandardStyles(e),i={rows:Number(e.rows||3),columns:Number(e.columns||4),cell_width:Number(e.cell_width||e.cellWidth||0),cell_height:Number(e.cell_height||e.cellHeight||0),cell_gap:Number(e.cell_gap||e.cellGap||2),cell_color:s.colors.primaryColor,cell_opacity:s.layout.opacity,cell_radius:s.layout.borderRadius||2,cell_border:e.cell_border||!1!==e.cellBorder,border_color:s.colors.borderColor,border_width:s.layout.borderWidth,show_labels:!1!==e.show_labels,show_values:e.show_values||!1,label_color:s.text.labelColor,value_color:s.text.valueColor,font_size:s.text.fontSize,font_family:s.text.fontFamily,font_weight:s.text.fontWeight,status_mode:(e.status_mode||e.statusMode||"auto").toLowerCase(),status_ranges:this._parseStatusRanges(e.status_ranges||e.statusRanges),unknown_color:s.colors.disabledColor,show_grid_lines:e.show_grid_lines||e.showGridLines||!1,grid_line_color:e.grid_line_color||e.gridLineColor||s.colors.borderColor,grid_line_opacity:Number(e.grid_line_opacity||e.gridLineOpacity||.3),gradient:s.gradient,pattern:s.pattern,glow:s.glow,shadow:s.shadow,blur:s.blur,bracket_style:e.bracket_style||e.bracketStyle||!1,bracket_color:e.bracket_color||e.bracketColor||s.colors.primaryColor,status_indicator:e.status_indicator||e.statusIndicator||!1,lcars_corners:e.lcars_corners||e.lcarsCorners||!1,hover_enabled:s.interaction.hoverEnabled,hover_color:s.colors.hoverColor,hover_scale:s.interaction.hoverScale,animatable:s.animation.animatable,cascade_speed:s.animation.cascadeSpeed,cascade_direction:s.animation.cascadeDirection,reveal_animation:s.animation.revealAnimation,pulse_on_change:s.animation.pulseOnChange,update_throttle:Number(e.update_throttle||e.updateThrottle||100),features:[],standardStyles:s};return i.gradient&&i.features.push("gradient"),i.pattern&&i.features.push("pattern"),i.status_ranges&&i.status_ranges.length>0&&i.features.push("status-ranges"),i.glow&&i.features.push("glow"),i.shadow&&i.features.push("shadow"),i.blur&&i.features.push("blur"),i.show_grid_lines&&i.features.push("grid-lines"),i.show_labels&&i.features.push("labels"),i.show_values&&i.features.push("values"),i.bracket_style&&i.features.push("brackets"),i.status_indicator&&i.features.push("status"),i.lcars_corners&&i.features.push("lcars-corners"),i.hover_enabled&&i.features.push("hover"),i.cascade_speed>0&&i.features.push("cascade"),i.reveal_animation&&i.features.push("reveal"),i.pulse_on_change&&i.features.push("pulse"),i}_parseStatusRanges(e){return e&&Array.isArray(e)?e.map((e=>({min:Number(e.min??-1/0),max:Number(e.max??1/0),color:e.color||"var(--lcars-blue)",label:e.label||null,value:e.value||null,state:e.state||null}))):[]}_prepareAnimationAttributes(e,t){const n=r.T.parseStandardAnimationStyles(t),s={gridAttributes:[],cellAttributes:[],hasAnimations:!1},i=r.T.createAnimationDataAttributes(n);return i&&(s.gridAttributes.push(i),s.hasAnimations=!0),s}_renderEnhancedStatusGrid(e,t,n,s,r,i,o,a){const l=o.cell_width||s/o.columns,c=o.cell_height||r/o.rows,d=o.cell_gap;let u=`<g data-overlay-id="${e.id}"\n                data-overlay-type="status_grid"\n                data-grid-rows="${o.rows}"\n                data-grid-columns="${o.columns}"\n                data-grid-features="${o.features.join(",")}"\n                data-animation-ready="${!!a.hasAnimations}"\n                data-cascade-direction="${o.cascade_direction}"\n                transform="translate(${t}, ${n})">`;return o.show_grid_lines&&(u+=`<rect width="${s}" height="${r}"\n                     fill="none" stroke="${o.grid_line_color}"\n                     stroke-width="1" opacity="${o.grid_line_opacity}"/>`),i.forEach((e=>{const t=e.col*(l+d),n=e.row*(c+d),s=this._determineCellColor(e,o);if(u+=`<rect x="${t}" y="${n}"\n                     width="${l-d}" height="${c-d}"\n                     fill="${s}"\n                     stroke="${o.border_color}"\n                     stroke-width="${o.border_width}"\n                     rx="${o.cell_radius}"\n                     data-cell-id="${e.id}"\n                     data-cell-row="${e.row}"\n                     data-cell-col="${e.col}"/>`,o.show_labels&&e.label){const s=t+(l-d)/2,r=n+(c-d)/2-o.font_size/4;u+=`<text x="${s}" y="${r}"\n                       text-anchor="middle" dominant-baseline="middle"\n                       fill="${o.label_color}"\n                       font-size="${.7*o.font_size}"\n                       font-family="${o.font_family}"\n                       data-cell-label="${e.id}">\n                       ${this._escapeXml(e.label)}\n                     </text>`}if(o.show_values&&e.content){const s=t+(l-d)/2,r=n+(c-d)/2+o.font_size/4;u+=`<text x="${s}" y="${r}"\n                       text-anchor="middle" dominant-baseline="middle"\n                       fill="${o.value_color}"\n                       font-size="${.6*o.font_size}"\n                       font-family="${o.font_family}"\n                       data-cell-content="${e.id}">\n                       ${this._escapeXml(e.content||String(e.data.value))}\n                     </text>`}})),u+="</g>",u}_determineCellColor(e,t){if(t.status_ranges&&t.status_ranges.length>0){const n="number"==typeof e.data.value?e.data.value:parseFloat(e.data.value);if(!isNaN(n))for(const e of t.status_ranges)if(n>=e.min&&n<=e.max)return e.color;for(const n of t.status_ranges){if(n.value&&e.data.value===n.value)return n.color;if(n.state&&e.data.state===n.state)return n.color}}return t.cell_color}_escapeXml(e){return"string"!=typeof e?String(e):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}_renderFallbackStatusGrid(e,t,n,s,r){const i=e.finalStyle||e.style||{},o=i.cell_color||i.color||"var(--lcars-gray)";return console.warn(`[StatusGridRenderer] Using fallback rendering for status grid ${e.id}`),`<g data-overlay-id="${e.id}" data-overlay-type="status_grid" data-fallback="true">\n              <g transform="translate(${t}, ${n})">\n                <rect width="${s}" height="${r}"\n                      fill="none" stroke="${o}" stroke-width="2"/>\n                <text x="${s/2}" y="${r/2}" text-anchor="middle"\n                      fill="${o}" font-size="12" dominant-baseline="middle">\n                  Status Grid Error\n                </text>\n              </g>\n            </g>`}_resolveCellContent(e,t){const n=e.content||e._raw?.content||e.label||"";if(console.log("[StatusGridRenderer] Resolving content for cell:",{cellId:e.id||"unknown",hasContent:!!e.content,hasRawContent:!!e._raw?.content,hasLabel:!!e.label,content:n,rawContent:e._raw?.content,label:e.label}),n&&"string"==typeof n&&n.includes("?")&&n.includes(":"))return console.log(`[StatusGridRenderer] Detected conditional expression, handling locally: "${n}"`),n;const s=i.z.resolveContent(e,t,"StatusGridRenderer");return console.log(`[StatusGridRenderer] Resolved content: "${s}" for cell ${e.id||"unknown"}`),s}_resolveCellConfigurations(e,t){const n=[],s=e.cells||e._raw?.cells||e.raw?.cells;if(console.log(`[StatusGridRenderer] Resolving cells for ${e.id}:`,{hasCells:!(!s||!Array.isArray(s)),cellCount:s?.length||0,cellsData:s,checkedSources:{"overlay.cells":!!e.cells,"overlay._raw?.cells":!!e._raw?.cells,"overlay.raw?.cells":!!e.raw?.cells}}),s&&Array.isArray(s))s.forEach(((e,s)=>{console.log(`[StatusGridRenderer] Processing cell ${s}:`,e);const r=this._resolveCellContent(e,t),i={id:e.id||`cell-${s}`,row:e.position?e.position[0]:Math.floor(s/t.columns),col:e.position?e.position[1]:s%t.columns,index:s,source:e.source||e.data_source,label:e.label||`Cell ${s+1}`,content:r,data:{value:e.value||r||null,state:e.state||"unknown",timestamp:Date.now()},lastUpdate:Date.now(),animationDelay:s*(t.cascade_speed||50),_raw:e._raw||e},o=this._resolveCellContentForInitialRender(i,t);console.log("[StatusGridRenderer] Created cell:",o),n.push(o)}));else{console.log(`[StatusGridRenderer] No explicit cells found, generating ${t.rows}x${t.columns} grid`);const e=t.rows*t.columns;for(let s=0;s<e;s++){const e=Math.floor(s/t.columns),r=s%t.columns;n.push({id:`cell-${e}-${r}`,row:e,col:r,index:s,source:null,label:`${String.fromCharCode(65+e)}${r+1}`,content:null,data:{value:Math.random()>.5?"ONLINE":"OFFLINE",state:Math.random()>.5?"good":"bad",timestamp:Date.now()},lastUpdate:Date.now(),animationDelay:s*(t.cascade_speed||50)})}}return console.log("[StatusGridRenderer] Final cells array:",n),n}updateCellsWithData(e,t,n){console.log(`[StatusGridRenderer] Updating cells with new DataSource data for ${e.id}`);const s=this._resolveStatusGridStyles(t,e.id,e);return this._resolveCellConfigurations(e,s).map((e=>{const t=e._raw?.content||e._raw?.label||e.label||"";if(t&&"string"==typeof t&&t.includes("{")){console.log(`[StatusGridRenderer] Processing template for cell ${e.id}: "${t}"`);const s=t.includes("?")&&t.includes(":")?this._processConditionalWithDataSourceMixin(t):i.z.processEnhancedTemplateStringsWithFallback(t,"StatusGridRenderer"),r="object"==typeof s?JSON.stringify(s):String(s);return{...e,label:s===t?e.label:r,content:r,data:{...e.data,value:this._extractValueFromTemplate(r,n),timestamp:Date.now()},lastUpdate:Date.now()}}return e}))}_getDataSourceForCell(e,t){const n=e.match(/\{([^}]+)\}/);if(!n)return t;const s=n[1],[r]=s.split(":"),i=r.split(".")[0];if(console.log(`[StatusGridRenderer] Cell needs DataSource: ${i}`),"undefined"!=typeof window&&window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager){const e=window.__msdDebug.pipelineInstance.systemsManager.dataSourceManager.getSource(i);if(e){const t=e.getCurrentData();return console.log(`[StatusGridRenderer] Found DataSource ${i}: value=${t?.v}, unit="${t?.unit_of_measurement||"none"}"`),t}console.warn(`[StatusGridRenderer] DataSource ${i} not found`)}return t}_resolveCellContentForInitialRender(e,t){const n=e._raw?.content||e._raw?.label||e.label||e.content||"";if(n&&"string"==typeof n&&n.includes("{")){if(console.log(`[StatusGridRenderer] Processing template for initial render in cell ${e.id}: "${n}"`),n.includes("?")&&n.includes(":")){console.log("[StatusGridRenderer] Conditional expression detected, extracting DataSource references");const t=this._processConditionalWithDataSourceMixin(n);return t!==n?(console.log(`[StatusGridRenderer] Conditional resolved for ${e.id}: "${n}" → "${t}"`),{...e,content:t,_originalContent:n}):(console.log(`[StatusGridRenderer] Conditional not resolved for ${e.id}, will resolve during updates`),{...e,content:n,_originalContent:n,_isConditional:!0})}const t=i.z.processEnhancedTemplateStringsWithFallback(n,"StatusGridRenderer");if(t!==n)return console.log(`[StatusGridRenderer] Template resolved for ${e.id}: "${n}" → "${t}"`),{...e,content:t,_originalContent:n};console.log(`[StatusGridRenderer] Template not resolved for ${e.id}, will resolve during updates`)}return e}_extractValueFromTemplate(e,t){const n=parseFloat(e);return isNaN(n)?t&&"number"==typeof t.v?t.v:e:n}_processConditionalWithDataSourceMixin(e){try{const t=e.match(/\{([^}]+)\}/);if(!t)return e;const n=t[1];console.log(`[StatusGridRenderer] Extracted conditional expression: "${n}"`);const s=n.match(/^(.+?)\s*([><=!]+)\s*(.+?)\s*\?\s*'(.+?)'\s*:\s*'(.+?)'$/);if(!s)return console.warn(`[StatusGridRenderer] Could not parse conditional: ${n}`),e;const[,r,o,a,l,c]=s;console.log(`[StatusGridRenderer] Parsed conditional: "${r.trim()}" ${o} ${a} ? "${l}" : "${c}"`);const d=`{${r.trim()}}`;console.log(`[StatusGridRenderer] Resolving DataSource template: "${d}"`);const u=i.z.processEnhancedTemplateStringsWithFallback(d,"StatusGridRenderer");if(console.log(`[StatusGridRenderer] DataSourceMixin resolved: "${d}" → "${u}"`),u===d)return console.log("[StatusGridRenderer] DataSource not resolved, returning original template"),e;const h=parseFloat(u),p=parseFloat(a.trim());if(isNaN(h)||isNaN(p))return console.warn(`[StatusGridRenderer] Could not parse numeric values: left="${u}" (${h}), right="${a.trim()}" (${p})`),e;let g=!1;switch(o.trim()){case">":g=h>p;break;case"<":g=h<p;break;case">=":g=h>=p;break;case"<=":g=h<=p;break;case"==":g=h==p;break;case"!=":g=h!=p;break;default:return console.warn(`[StatusGridRenderer] Unknown operator: ${o}`),e}const m=g?l:c;return console.log(`[StatusGridRenderer] Conditional result: ${h} ${o} ${p} = ${g} → "${m}"`),m}catch(t){return console.error("[StatusGridRenderer] Error processing conditional with DataSourceMixin:",t),e}}}"undefined"!=typeof window&&(window.StatusGridRenderer=o)},333:(e,t,n)=>{"use strict";n.r(t),n.d(t,{TextOverlayRenderer:()=>o});var s=n(953),r=n(778),i=n(659);class o{constructor(){this.gradientCache=new Map,this.patternCache=new Map,this.filterCache=new Map}static render(e,t,n,s){const r=new o;return r.container=s,r.viewBox=n,r.renderText(e,t,n)}renderText(e,t,n){console.log(`[TextOverlayRenderer] DEBUG: renderText called for overlay "${e.id}"`),console.log("[TextOverlayRenderer] DEBUG: Full overlay object:",e),console.log("[TextOverlayRenderer] DEBUG: Anchors:",t);const s=r.Q.resolvePosition(e.position,t);if(!s)return console.warn("[TextOverlayRenderer] Text overlay position could not be resolved:",e.id),console.log("[TextOverlayRenderer] DEBUG: Position resolution failed for:",{overlayId:e.id,position:e.position,anchors:t}),"";const[i,o]=s;try{const t=e.finalStyle||e.style||{};console.log(`[TextOverlayRenderer] DEBUG: Style object for "${e.id}":`,t);const n=this._resolveTextStyles(t,e.id);if(this.container&&"undefined"!=typeof window)try{const e=this.container,s=e?getComputedStyle(e):null;if(s&&("inherit"===n.fontFamily&&s.fontFamily&&(n.fontFamily=s.fontFamily),!t.font_size&&!t.fontSize&&s.fontSize)){const e=parseFloat(s.fontSize);!isNaN(e)&&e>0&&(n.fontSize=e)}}catch(e){}const s=this._prepareAnimationAttributes(e,t),r=this._resolveTextContent(e,t);if(console.log(`[TextOverlayRenderer] DEBUG: Final text content for "${e.id}": "${r}"`),!r)return console.warn(`[TextOverlayRenderer] No text content for overlay ${e.id}`),console.log("[TextOverlayRenderer] DEBUG: Content resolution chain failed - check the debug logs above"),"";n._cachedContent=r;const a=this._measureTextBlock(r,i,o,n),l=[this._buildDefinitions(n,e.id),this._buildMainText(r,i,o,n,e.id,s),this._buildTextDecorations(r,i,o,n,e.id),this._buildEffects(r,i,o,n,e.id)].filter(Boolean);return console.log(`[TextOverlayRenderer] Rendered enhanced text ${e.id} with ${n.features.length} features`),`<g data-overlay-id="${e.id}"\n                  data-overlay-type="text"\n                  data-text-features="${n.features.join(",")}"\n                  data-animation-ready="${!!s.hasAnimations}"\n                  data-text-width="${a.width||0}"\n                  data-text-height="${a.height||0}"\n                  data-font-family="${n.fontFamily}"\n                  data-font-size="${n.fontSize}"\n                  data-dominant-baseline="${n.dominantBaseline}"\n                  data-text-anchor="${n.textAnchor}"\n                  data-font-stabilized="0">\n                ${l.join("\n")}\n              </g>`}catch(t){return console.error(`[TextOverlayRenderer] Enhanced rendering failed for text ${e.id}:`,t),this._renderFallbackText(e,i,o)}}_resolveTextStyles(e,t){const n=i.T.parseAllStandardStyles(e),s={color:n.text.textColor||e.fill||"var(--lcars-orange)",fontSize:n.text.fontSize,fontFamily:"monospace"!==n.text.fontFamily?n.text.fontFamily:e.font_family||e.fontFamily||"inherit",fontWeight:n.text.fontWeight,fontStyle:n.text.fontStyle,textAnchor:("left"===n.text.textAlign?"start":"right"===n.text.textAlign?"end":"center"===n.text.textAlign?"middle":e.text_anchor||e.textAnchor||"start").toLowerCase(),dominantBaseline:("top"===n.text.verticalAlign?"hanging":"bottom"===n.text.verticalAlign?"text-after-edge":"middle"===n.text.verticalAlign?"central":e.dominant_baseline||e.dominantBaseline||"auto").toLowerCase(),alignmentBaseline:(e.alignment_baseline||e.alignmentBaseline||"auto").toLowerCase(),letterSpacing:n.text.letterSpacing,wordSpacing:e.word_spacing||e.wordSpacing||"normal",textDecoration:e.text_decoration||e.textDecoration||"none",opacity:n.layout.opacity,visibility:n.layout.visible?"visible":"hidden",stroke:e.stroke||null,strokeWidth:Number(e.stroke_width||e.strokeWidth||0),strokeOpacity:Number(e.stroke_opacity||e.strokeOpacity||1),strokeLinecap:(e.stroke_linecap||e.strokeLinecap||"butt").toLowerCase(),strokeLinejoin:(e.stroke_linejoin||e.strokeLinejoin||"miter").toLowerCase(),strokeDasharray:e.stroke_dasharray||e.strokeDasharray||null,strokeDashoffset:Number(e.stroke_dashoffset||e.strokeDashoffset||0),gradient:n.gradient,pattern:n.pattern,glow:n.glow,shadow:n.shadow,blur:n.blur,multiline:e.multiline||!1,lineHeight:n.text.lineHeight,maxWidth:n.layout.maxWidth||Number(e.max_width||e.maxWidth||0),textWrapping:e.text_wrapping||e.textWrapping||"none",animatable:n.animation.animatable,pulseSpeed:Number(e.pulse_speed||n.animation.pulseOnChange?1:0),fadeSpeed:Number(e.fade_speed||0),typewriterSpeed:Number(e.typewriter_speed||0),status_indicator:e.status_indicator||null,status_indicator_position:e.status_indicator_position||e.statusIndicatorPosition||"left-center",bracket_style:e.bracket_style||null,highlight:e.highlight||!1,standardStyles:n,features:[]};return s.gradient&&s.features.push("gradient"),s.pattern&&s.features.push("pattern"),s.stroke&&s.strokeWidth>0&&s.features.push("stroke"),s.glow&&s.features.push("glow"),s.shadow&&s.features.push("shadow"),s.blur&&s.features.push("blur"),s.multiline&&s.features.push("multiline"),s.pulseSpeed>0&&s.features.push("pulse"),s.fadeSpeed>0&&s.features.push("fade"),s.typewriterSpeed>0&&s.features.push("typewriter"),s.status_indicator&&s.features.push("status"),s.bracket_style&&s.features.push("brackets"),s.highlight&&s.features.push("highlight"),s}_resolveTextContent(e,t){console.log(`[TextOverlayRenderer] DEBUG: Resolving text content for ${e.id}`),console.log("[TextOverlayRenderer] DEBUG: Available sources:",{"style.value":t.value,"overlay.text":e.text,"overlay.content":e.content,"_raw.content":e._raw?.content,"_raw.text":e._raw?.text});let n=t.value||e.text||e.content||"";!n&&e._raw?.content&&(n=e._raw.content,console.log(`[TextOverlayRenderer] DEBUG: Found content in _raw.content: "${n}"`)),!n&&e._raw?.text&&(n=e._raw.text,console.log(`[TextOverlayRenderer] DEBUG: Found content in _raw.text: "${n}"`));let r=e.data_source||e._raw?.data_source||t.data_source;if(!n&&t.value_format&&"string"==typeof t.value_format&&r){const e=s.z.resolveDataSourceContent(r,t,"TextOverlayRenderer");if(null!==e){const i=parseFloat(e);return n=isNaN(i)||String(i)!==String(e).trim()?e:t.value_format.includes("{value")?t.value_format.replace(/\{value(?::([^}]+))?\}/g,((e,t)=>{if(t){const e=s.z.getDataSourceManager(),n=e?.getSource(r.split(".")[0]),o=n?.getCurrentData()?.unit_of_measurement;return s.z.applyNumberFormat(i,t,o)}return String(i)})):t.value_format.replace("{value}",String(i)),n}return n=t.value_format.replace(/\{value[^}]*\}/g,"[Loading...]"),n}if(!n&&t.value_format&&"string"==typeof t.value_format&&(n=t.value_format),n&&"string"==typeof n&&n.includes("{"))return n=s.z.processTemplateForInitialRender(n,"TextOverlayRenderer"),n;if(n)return n;if(r||(r=e.data_source||e._raw?.data_source||t.data_source),r){const e=s.z.resolveDataSourceContent(r,t,"TextOverlayRenderer");return null!==e?e:`[Loading: ${r}]`}return n}_processEnhancedTemplateStrings(e){return s.z.processEnhancedTemplateStrings(e,"TextOverlayRenderer")}_buildDefinitions(e,t){const n=[];return e.gradient&&n.push(this._createGradientDefinition(e.gradient,t)),e.pattern&&n.push(this._createPatternDefinition(e.pattern,t)),e.glow&&n.push(this._createGlowFilter(e.glow,t)),e.shadow&&n.push(this._createShadowFilter(e.shadow,t)),e.blur&&n.push(this._createBlurFilter(e.blur,t)),0===n.length?"":`<defs>${n.join("\n")}</defs>`}_buildMainText(e,t,n,s,r,i){if(s.multiline)return this._buildMultilineText(e,t,n,s,r,i);const o=[];o.push(`x="${t}"`),o.push(`y="${n}"`),this._applyTextAttributes(o,s,r),o.push(...i.textAttributes);const a=this.escapeXml(e);return`<text ${o.join(" ")}>${a}</text>`}_buildMultilineText(e,t,n,s,r,i){const o=e.split("\n"),a=s.fontSize*s.lineHeight,l=[];o.forEach(((e,n)=>{const s=0===n?0:a,r=this.escapeXml(e);l.push(`<tspan x="${t}" dy="${s}">${r}</tspan>`)}));const c=[];return c.push(`y="${n}"`),this._applyTextAttributes(c,s,r),c.push(...i.textAttributes),`<text ${c.join(" ")}>${l.join("")}</text>`}_applyTextAttributes(e,t,n){t.gradient?e.push(`fill="url(#text-gradient-${n})"`):t.pattern?e.push(`fill="url(#text-pattern-${n})"`):e.push(`fill="${t.color}"`),e.push(`fill-opacity="${t.opacity}"`),e.push(`font-size="${t.fontSize}"`),"inherit"!==t.fontFamily&&e.push(`font-family="${t.fontFamily}"`),"normal"!==t.fontWeight&&e.push(`font-weight="${t.fontWeight}"`),"normal"!==t.fontStyle&&e.push(`font-style="${t.fontStyle}"`),"start"!==t.textAnchor&&e.push(`text-anchor="${t.textAnchor}"`),"auto"!==t.dominantBaseline&&e.push(`dominant-baseline="${t.dominantBaseline}"`),"auto"!==t.alignmentBaseline&&e.push(`alignment-baseline="${t.alignmentBaseline}"`),"normal"!==t.letterSpacing&&e.push(`letter-spacing="${t.letterSpacing}"`),"normal"!==t.wordSpacing&&e.push(`word-spacing="${t.wordSpacing}"`),"none"!==t.textDecoration&&e.push(`text-decoration="${t.textDecoration}"`),t.stroke&&t.strokeWidth>0&&(e.push(`stroke="${t.stroke}"`),e.push(`stroke-width="${t.strokeWidth}"`),e.push(`stroke-opacity="${t.strokeOpacity}"`),e.push(`stroke-linecap="${t.strokeLinecap}"`),e.push(`stroke-linejoin="${t.strokeLinejoin}"`),t.strokeDasharray&&(e.push(`stroke-dasharray="${t.strokeDasharray}"`),0!==t.strokeDashoffset&&e.push(`stroke-dashoffset="${t.strokeDashoffset}"`))),"visible"!==t.visibility&&e.push(`visibility="${t.visibility}"`);const s=[];t.glow&&s.push(`url(#text-glow-${n})`),t.shadow&&s.push(`url(#text-shadow-${n})`),t.blur&&s.push(`url(#text-blur-${n})`),s.length>0&&e.push(`filter="${s.join(" ")}"`)}_buildTextDecorations(e,t,n,s,r){const i=[];return s.bracket_style&&i.push(this._buildBrackets(e,t,n,s,r)),s.highlight&&i.push(this._buildHighlight(e,t,n,s,r)),s.status_indicator&&i.push(this._buildStatusIndicator(t,n,s,r)),i.filter(Boolean).join("\n")}_buildEffects(e,t,n,s,r){return s.features.includes("typewriter"),s.features.includes("pulse"),s.features.includes("fade"),[].join("\n")}_buildBrackets(e,t,n,s,r){const o=i.T.buildMeasurementFontString(s,this.container);let a;if(s.multiline){const r=i.T.measureMultilineText(e,o,s.lineHeight);let l=t;"middle"===s.textAnchor?l=t-r.width/2:"end"===s.textAnchor&&(l=t-r.width);let c=n-r.lineMetrics[0]?.ascent||0;"middle"===s.dominantBaseline?c=n-r.height/2:"hanging"===s.dominantBaseline&&(c=n),a={left:l,right:l+r.width,top:c,bottom:c+r.height,width:r.width,height:r.height}}else a=i.T.getTextBoundingBox(e,t,n,o,s.textAnchor,s.dominantBaseline);const l=a.left-8-4,c=a.right+4,d=a.top-4,u=a.bottom+4,h=s.color,p=Math.max(1,s.fontSize/16);return`<g data-decoration="brackets">\n              <path d="M ${l+8} ${d} L ${l} ${d} L ${l} ${u} L ${l+8} ${u}"\n                    stroke="${h}" stroke-width="${p}" fill="none"/>\n              <path d="M ${c-8} ${d} L ${c} ${d} L ${c} ${u} L ${c-8} ${u}"\n                    stroke="${h}" stroke-width="${p}" fill="none"/>\n            </g>`}_buildHighlight(e,t,n,s,r){const o=i.T.buildMeasurementFontString(s,this.container);let a;if(s.multiline){const r=i.T.measureMultilineText(e,o,s.lineHeight,!0,this.container);let l=t;"middle"===s.textAnchor?l=t-r.width/2:"end"===s.textAnchor&&(l=t-r.width);let c=n-r.lineMetrics[0]?.ascent||0;"middle"===s.dominantBaseline?c=n-r.height/2:"hanging"===s.dominantBaseline&&(c=n),a={left:l,right:l+r.width,top:c,bottom:c+r.height,width:r.width,height:r.height}}else a=i.T.getTextBoundingBox(e,t,n,o,s.textAnchor,s.dominantBaseline,this.container);const l=i.T._getSvgTransformInfo(this.container),c=l?l.pixelToViewBox(2):2;return`<rect x="${a.left-c}" y="${a.top-c}"\n                  width="${a.width+2*c}" height="${a.height+2*c}"\n                  fill="${"string"==typeof s.highlight?s.highlight:"var(--lcars-blue-light)"}" fill-opacity="${"number"==typeof s.highlight_opacity?s.highlight_opacity:.3}"\n                  data-decoration="highlight"/>`}_buildStatusIndicator(e,t,n,s){const r=.4*n.fontSize,o="string"==typeof n.status_indicator?n.status_indicator:"var(--lcars-green)",a=n.status_indicator_position||"left-center",l=n._cachedContent||n.value||"",c=i.T.buildMeasurementFontString(n,this.container),d=i.T._getSvgTransformInfo(this.container);let u;if(console.log(`[TextOverlayRenderer] Transform info for ${s}:`,{transformInfo:d,containerTag:this.container?.tagName,hasSvg:!!this.container?.querySelector("svg")}),n.multiline){const s=i.T.measureMultilineText(l,c,n.lineHeight,!0,this.container);let r=e;"middle"===n.textAnchor?r=e-s.width/2:"end"===n.textAnchor&&(r=e-s.width);let o=t-(s.lineMetrics[0]?.ascent||0);"middle"===n.dominantBaseline?o=t-s.height/2:"hanging"===n.dominantBaseline&&(o=t),u={left:r,right:r+s.width,top:o,bottom:o+s.height,width:s.width,height:s.height,centerX:r+s.width/2,centerY:o+s.height/2}}else{const s=i.T.measureText(l,c,!0,this.container);let r=e;"middle"===n.textAnchor?r=e-s.width/2:"end"===n.textAnchor&&(r=e-s.width);let o=t-s.ascent;"middle"===n.dominantBaseline?o=t-s.height/2:"hanging"===n.dominantBaseline&&(o=t),u={left:r,right:r+s.width,top:o,bottom:o+s.height,width:s.width,height:s.height,centerX:r+s.width/2,centerY:o+s.height/2}}console.log(`[TextOverlayRenderer] Status indicator debug for ${s}:`,{textContent:l,x:e,y:t,textAnchor:n.textAnchor,dominantBaseline:n.dominantBaseline,position:a,bbox:u,fontSize:n.fontSize,hasContainer:!!this.container,containerType:this.container?.tagName,transformInfo:d?{scaleX:d.scaleX,scaleY:d.scaleY,viewBox:d.viewBox}:null});let h=e,p=t;const g=d?d.pixelToViewBox(8):r;switch(a){case"top-left":h=u.left-g,p=u.top-g;break;case"top-right":h=u.right+g,p=u.top-g;break;case"bottom-left":h=u.left-g,p=u.bottom+g;break;case"bottom-right":h=u.right+g,p=u.bottom+g;break;case"top":h=u.centerX,p=u.top-g;break;case"bottom":h=u.centerX,p=u.bottom+g;break;case"left-center":case"left":default:h=u.left-g,p=u.centerY;break;case"right-center":case"right":h=u.right+g,p=u.centerY;break;case"center":h=u.centerX,p=u.centerY}return console.log(`[TextOverlayRenderer] Status indicator final position for ${s}:`,{indicatorX:h,indicatorY:p,padding:g,pixelPadding:8,transformInfo:d?"present":"missing"}),`<circle cx="${h}" cy="${p}" r="${r}"\n                    fill="${o}"\n                    data-status-pos="${a}"\n                    data-decoration="status-indicator"/>`}_createGradientDefinition(e,t){const n=`text-gradient-${t}`;if("string"==typeof e){const[t,s]=e.split(",").map((e=>e.trim()));return`<linearGradient id="${n}">\n                <stop offset="0%" stop-color="${t||"var(--lcars-orange)"}"/>\n                <stop offset="100%" stop-color="${s||"var(--lcars-red)"}"/>\n              </linearGradient>`}const s=e.type||"linear",r=e.stops||[{offset:"0%",color:"var(--lcars-orange)"},{offset:"100%",color:"var(--lcars-red)"}];return"radial"===s?`<radialGradient id="${n}" cx="${e.cx||"50%"}" cy="${e.cy||"50%"}" r="${e.r||"50%"}">\n                ${r.map((e=>`<stop offset="${e.offset}" stop-color="${e.color}"/>`)).join("")}\n              </radialGradient>`:`<linearGradient id="${n}" x1="${e.x1||"0%"}" y1="${e.y1||"0%"}" x2="${e.x2||"100%"}" y2="${e.y2||"0%"}">\n                ${r.map((e=>`<stop offset="${e.offset}" stop-color="${e.color}"/>`)).join("")}\n              </linearGradient>`}_createPatternDefinition(e,t){const n=`text-pattern-${t}`;if("string"==typeof e)switch(e){case"dots":return`<pattern id="${n}" patternUnits="userSpaceOnUse" width="8" height="8">\n                    <circle cx="4" cy="4" r="1" fill="currentColor"/>\n                  </pattern>`;case"lines":return`<pattern id="${n}" patternUnits="userSpaceOnUse" width="4" height="4">\n                    <path d="M 0,4 l 4,-4 M -1,1 l 2,-2 M 3,5 l 2,-2" stroke="currentColor" stroke-width="1"/>\n                  </pattern>`;default:return""}const s=e.width||10,r=e.height||10;return`<pattern id="${n}" patternUnits="${e.patternUnits||"userSpaceOnUse"}" width="${s}" height="${r}">\n              ${e.content||""}\n            </pattern>`}_createGlowFilter(e,t){const n=`text-glow-${t}`;let s,r,i;return"string"==typeof e?(s=e,r=3,i=1):(s=e.color||"var(--lcars-orange)",r=Number(e.blur||3),i=Number(e.intensity||1)),`<filter id="${n}">\n              <feGaussianBlur stdDeviation="${r}" result="blur"/>\n              <feFlood flood-color="${s}" flood-opacity="${i}" result="color"/>\n              <feComposite in="color" in2="blur" operator="in" result="coloredBlur"/>\n              <feMerge>\n                <feMergeNode in="coloredBlur"/>\n                <feMergeNode in="SourceGraphic"/>\n              </feMerge>\n            </filter>`}_createShadowFilter(e,t){const n=`text-shadow-${t}`;let s,r,i,o;return"string"==typeof e?([s,r,i,o]=e.split(" "),s=Number(s)||2,r=Number(r)||2,i=Number(i)||2,o=o||"rgba(0,0,0,0.5)"):(s=Number(e.offsetX||2),r=Number(e.offsetY||2),i=Number(e.blur||2),o=e.color||"rgba(0,0,0,0.5)"),`<filter id="${n}">\n              <feDropShadow dx="${s}" dy="${r}" stdDeviation="${i}" flood-color="${o}"/>\n            </filter>`}_createBlurFilter(e,t){return`<filter id="text-blur-${t}">\n              <feGaussianBlur stdDeviation="${"number"==typeof e?e:Number(e)||1}"/>\n            </filter>`}_prepareAnimationAttributes(e,t){const n=i.T.parseStandardAnimationStyles(t),s={textAttributes:[],hasAnimations:!1},r=i.T.createAnimationDataAttributes(n);return r&&(s.textAttributes.push(r),s.hasAnimations=!0),(t.pulse_speed||t.pulseSpeed)&&(s.textAttributes.push(`data-pulse-speed="${t.pulse_speed||t.pulseSpeed}"`),s.hasAnimations=!0),(t.fade_speed||t.fadeSpeed)&&(s.textAttributes.push(`data-fade-speed="${t.fade_speed||t.fadeSpeed}"`),s.hasAnimations=!0),(t.typewriter_speed||t.typewriterSpeed)&&(s.textAttributes.push(`data-typewriter-speed="${t.typewriter_speed||t.typewriterSpeed}"`),s.hasAnimations=!0),s}_renderFallbackText(e,t,n){const s=e.finalStyle||e.style||{},r=s.value||e.text||"",i=s.color||"var(--lcars-orange)",o=s.font_size||s.fontSize||16;return console.warn(`[TextOverlayRenderer] Using fallback rendering for text ${e.id}`),`<g data-overlay-id="${e.id}" data-overlay-type="text" data-fallback="true">\n              <text x="${t}" y="${n}"\n                    fill="${i}"\n                    font-size="${o}"\n                    text-anchor="start"\n                    dominant-baseline="auto">\n                ${this.escapeXml(r)}\n              </text>\n            </g>`}updateTextStyle(e,t){console.log(`[TextOverlayRenderer] Style update requested for text ${e}`)}getCapabilities(){return{multiline:!0,gradients:!0,patterns:!0,effects:["glow","shadow","blur"],decorations:["brackets","highlight","status"],animations:["pulse","fade","typewriter"],textWrapping:!0,advancedTypography:!0,strokeText:!0,advanced:!0}}static escapeXml(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}escapeXml(e){return o.escapeXml(e)}getAttachmentPoints(e,t,n){const s=this._resolveTextContent(e,e.finalStyle||{}),r=this._resolveTextStyles(e.finalStyle||{},e.id),o=i.T.buildMeasurementFontString(r,this.container);return i.T.getTextAttachmentPoints(s,t,n,o,r.textAnchor,r.dominantBaseline,this.container)}static computeAttachmentPoints(e,t,n){if(!e||"text"!==e.type)return null;const s=r.Q.resolvePosition(e.position,t);if(!s)return null;const[a,l]=s,c=new o,d=e.finalStyle||e.style||{},u=c._resolveTextStyles(d,e.id),h=c._resolveTextContent(e,d);if(!h)return null;const p=i.T.buildMeasurementFontString(u,n),g=i.T.getTextBoundingBox(h,a,l,p,u.textAnchor,u.dominantBaseline,n),m=i.T.getTextAttachmentPoints(h,a,l,p,u.textAnchor,u.dominantBaseline,n);return{id:e.id,center:m.center,points:m,bbox:g,textStyle:u,x:a,y:l}}_measureTextBlock(e,t,n,s){try{const t=i.T.buildMeasurementFontString(s,this.container);if(s.multiline){const n=i.T.measureMultilineText(e,t,s.lineHeight,!0,this.container);return{width:n.width,height:n.height}}{const n=i.T.measureText(e,t,!0,this.container);return{width:n.width,height:n.height}}}catch(e){return{width:0,height:0}}}_resolveTextContentWithData(e,t,n){console.log(`[TextOverlayRenderer] Resolving text content with updated data for ${e.id}`);let r=t.value||e.text||e.content||"";return!r&&e._raw?.content&&(r=e._raw.content),!r&&e._raw?.text&&(r=e._raw.text),r&&"string"==typeof r&&r.includes("{")&&n?(console.log("[TextOverlayRenderer] DEBUG: Processing template with DataSourceMixin for unified handling"),r=s.z.processEnhancedTemplateStringsWithFallback(r,"TextOverlayRenderer"),r):this._resolveTextContent(e,t)}_processTemplateWithData(e,t){return console.log(`[TextOverlayRenderer] DEBUG: Processing template: "${e}"`),console.log("[TextOverlayRenderer] DEBUG: With data:",t),e.replace(/\{([^}]+)\}/g,((e,n)=>{console.log(`[TextOverlayRenderer] DEBUG: Processing reference: "${n}"`);const[r,i]=n.split(":"),o=r.split(".");console.log("[TextOverlayRenderer] DEBUG: Path parts:",o),console.log("[TextOverlayRenderer] DEBUG: Format spec:",i);let a=t;if(1===o.length)a=t&&"object"==typeof t&&"v"in t?t.v:t&&"object"==typeof t&&"value"in t?t.value:t;else for(const t of o.slice(1)){if(!a||"object"!=typeof a||!(t in a))return console.log(`[TextOverlayRenderer] DEBUG: Path navigation failed at "${t}"`),e;a=a[t]}if(console.log("[TextOverlayRenderer] DEBUG: Resolved value:",a),i&&null!=a){console.log(`[TextOverlayRenderer] DEBUG: Applying format spec: "${i}"`);const e=s.z.applyNumberFormat(a,i,t?.unit_of_measurement);return console.log(`[TextOverlayRenderer] DEBUG: Formatted value: "${e}"`),e}return String(a)}))}}},733:()=>{!function(){if("undefined"==typeof window)return;const e=window;function t(){const t=e.__msdDebug?.pipelineInstance;if(!t||!t.enabled)throw new Error("pipeline disabled");return t}function n(t){return e.__msdDebug?.routing?.inspect(t)}function s(t="*"){e.__msdDebug?.routing?.invalidate(t)}e.__msdScenarios=e.__msdScenarios||{};const r="line_grid_forced";function i(e){const n=t().getResolvedModel().overlays.find((t=>t.id===e));if(!n)throw new Error("overlay not found");n._raw=n._raw||{},n._raw.corner_style="round",n._raw.corner_radius=n._raw.corner_radius||40}const o={arc_presence:function(){i(r),s("*");const e=n(r);return{ok:!!e&&/A\d+/.test(e.d)&&e.meta.arc&&e.meta.arc.count>0,details:{dSample:e?.d?.slice(0,120)+"...",arc:e?.meta?.arc}}},radius_clamp:function(){i(r);const e=t().getResolvedModel().overlays.find((e=>e.id===r)),o=e._raw.corner_radius;e._raw.corner_radius=1e3,s("*");const a=n(r);return e._raw.corner_radius=o,s("*"),{ok:!!a&&a.meta.arc&&a.meta.arc.count>0,details:{trimPx:a?.meta?.arc?.trimPx,count:a?.meta?.arc?.count}}},arc_cache_reuse:function(){i(r),s("*");const e=n(r),t=n(r);return{ok:!!e&&!!t&&!1===e.meta.cache_hit&&!0===t.meta.cache_hit&&t.meta.arc?.count>=0,details:{firstHit:e?.meta.cache_hit,secondHit:t?.meta.cache_hit,arcCount:t?.meta?.arc?.count}}},miter_fallback:function(){const e=t().getResolvedModel().overlays.find((e=>e.id===r));if(!e)return{ok:!1,details:"overlay missing"};e._raw=e._raw||{};const i=e._raw.corner_style;e._raw.corner_style="miter",s("*");const o=n(r);return e._raw.corner_style=i,s("*"),{ok:!!o&&!o.meta.arc,details:{hasArcMeta:!!o.meta.arc}}}},a={list:()=>Object.keys(o),run:e=>{if(!o[e])return console.warn("[MSD Arc Scenario] Unknown",e),null;try{const t=o[e]();return console.log(`[MSD Arc Scenario] ${e}: ${t.ok?"OK":"FAIL"}`,t),t}catch(t){const n={ok:!1,details:String(t)};return console.log(`[MSD Arc Scenario] ${e}: FAIL`,n),n}},runAll:()=>{const e={};for(const t of Object.keys(o))e[t]=a.run(t);const t=Object.values(e).every((e=>e&&e.ok));return console.log("[MSD Arc Scenario] Summary:",t?"ALL PASS":"FAILURES",e),e}};e.__msdScenarios.arcs=a,console.info("[MSD v1] Arc routing scenario harness installed. Use: window.__msdScenarios.arcs.list()")}()},388:()=>{!function(){if("undefined"==typeof window)return;const e=window;function t(){const t=e.__msdDebug?.pipelineInstance;if(!t||!t.enabled)throw new Error("pipeline disabled");return t}function n(t){return e.__msdDebug?.routing?.inspect(t)}function s(t="*"){e.__msdDebug?.routing?.invalidate(t)}function r(){const e="line_channel_demo",r=t().getResolvedModel().overlays.find((t=>t.id===e));if(!r)return{ok:!1,details:"overlay missing"};r._raw=r._raw||{};const i=r._raw.route_channels?r._raw.route_channels.slice():[],o=r._raw.route_channel_mode;r._raw.route_channels=[],r._raw.route_channel_mode="prefer",s("*");const a=n(e);r._raw.route_channels=["main_bus"],r._raw.route_channel_mode="prefer",s("*");const l=n(e);return r._raw.route_channels=i,r._raw.route_channel_mode=o,s("*"),{ok:!!a&&!!l&&l.meta.cost<=a.meta.cost,details:{baseCost:a?.meta.cost,preferCost:l?.meta.cost}}}function i(){const e="line_channel_demo",r=t().getResolvedModel().overlays.find((t=>t.id===e));if(!r)return{ok:!1,details:"overlay missing"};r._raw=r._raw||{};const i=r._raw.route_channels?r._raw.route_channels.slice():[],o=r._raw.route_channel_mode;r._raw.route_channels=["main_bus"],r._raw.route_channel_mode="prefer",s("*");const a=n(e);r._raw.route_channel_mode="avoid",s("*");const l=n(e);return r._raw.route_channels=i,r._raw.route_channel_mode=o,s("*"),{ok:!!a&&!!l&&l.meta.cost>=a.meta.cost,details:{preferCost:a?.meta.cost,avoidCost:l?.meta.cost}}}function o(){const e="line_channel_demo",r=t().getResolvedModel().overlays.find((t=>t.id===e));if(!r)return{ok:!1,details:"overlay missing"};r._raw=r._raw||{};const i=r._raw.route_channels?r._raw.route_channels.slice():[],o=r._raw.route_channel_mode;r._raw.route_channels=["main_bus","aux_bus"],r._raw.route_channel_mode="force",s("*");const a=n(e);return r._raw.route_channels=i,r._raw.route_channel_mode=o,s("*"),{ok:!!a&&a.meta.channel&&(!0===a.meta.channel.forcedOutside||100===a.meta.channel.coveragePct),details:a?.meta.channel||{}}}function a(){const e="line_channel_demo",r=t().getResolvedModel().overlays.find((t=>t.id===e));if(!r)return{ok:!1,details:"overlay missing"};r._raw=r._raw||{};const i={channels:r._raw.route_channels?r._raw.route_channels.slice():[],mode:r._raw.route_channel_mode,modeFull:r._raw.route_mode_full};r._raw.route_mode_full="grid",r._raw.route_channels=["main_bus"],r._raw.route_channel_mode="prefer",s("*");const o=n(e);if(!o||!o.meta.channel)return r._raw.route_channels=i.channels,r._raw.route_channel_mode=i.mode,r._raw.route_mode_full=i.modeFull,s("*"),{ok:!1,details:"channel meta missing"};const a=o.meta.channel.coveragePct;try{if(t().setAnchor&&t().setAnchor){const e=r._raw.anchor,n=t().getResolvedModel();if(n?.anchors?.[e]){const r=n.anchors[e].slice();t().setAnchor(e,[r[0]-120,r[1]]),s("*")}}}catch{}const l=n(e),c=l?.meta?.channel?.coveragePct??a;return r._raw.route_channels=i.channels,r._raw.route_channel_mode=i.mode,r._raw.route_mode_full=i.modeFull,s("*"),{ok:c>=a,details:{coverageBefore:a,coverageAfter:c}}}e.__msdScenarios=e.__msdScenarios||{};const l={prefer_improves_cost:r,avoid_increases_cost:i,force_penalty_or_full_coverage:o,prefer_shaping_coverage:a,force_downgrade_or_full:function(){const e="line_channel_demo",r=t().getResolvedModel().overlays.find((t=>t.id===e));if(!r)return{ok:!1,details:"overlay missing"};r._raw=r._raw||{};const i={channels:r._raw.route_channels?r._raw.route_channels.slice():[],mode:r._raw.route_channel_mode};r._raw.route_channels=["main_bus","aux_bus"],r._raw.route_channel_mode="force",s("*");const o=n(e),a=o?.meta?.channel;return r._raw.route_channels=i.channels,r._raw.route_channel_mode=i.mode,s("*"),a?{ok:100===a.coveragePct||a.shaping&&a.shaping.downgraded,details:a}:{ok:!1,details:"no channel meta"}},channel_acceptance:function(){const e=r(),t=i(),n=o(),s=a();return{ok:[e,t,n,s].every((e=>e&&e.ok)),details:{prefer:e,avoid:t,force:n,shaping:s}}}},c={list:()=>Object.keys(l),run:e=>{if(!l[e])return console.warn("[MSD Channel Scenario] Unknown",e),null;try{const t=l[e]();return console.log(`[MSD Channel Scenario] ${e}: ${t.ok?"OK":"FAIL"}`,t),t}catch(t){const n={ok:!1,details:String(t)};return console.log(`[MSD Channel Scenario] ${e}: FAIL`,n),n}},runAll:()=>{const e={};for(const t of Object.keys(l))e[t]=c.run(t);const t=Object.values(e).every((e=>e&&e.ok));return console.log("[MSD Channel Scenario] Summary:",t?"ALL PASS":"FAILURES",e),e}};e.__msdScenarios.channels=c,console.info("[MSD v1] Channel routing scenario harness installed. Use: window.__msdScenarios.channels.list()")}()},372:()=>{!function(){if("undefined"==typeof window)return;const e=window;function t(){const t=e.__msdDebug?.pipelineInstance;if(!t||!1===t.enabled)throw new Error("Pipeline disabled or missing.");return t}function n(){return e.__msdDebug?.lastRenderModel||t().getResolvedModel?.()||null}function s(e){return function(){const e=n();return e?.overlays||[]}().find((t=>t.id===e))}function r(t){return e.__msdDebug?.routing?.inspect(t)}function i(t="*"){e.__msdDebug?.routing?.invalidate(t)}function o(e,t){const n=t.ok?"color:#4caf50":"color:#f44336";console.log(`%c[MSD Scenario] ${e}: ${t.ok?"OK":"FAIL"}`,n,t)}e.__msdScenarios=e.__msdScenarios||{};const a={cache:function(){const e="line_grid_forced";i("*");const t=r(e),n=r(e);return{ok:!!t&&!!n&&!1===t.meta.cache_hit&&!0===n.meta.cache_hit,details:{firstHit:t?.meta.cache_hit,secondHit:n?.meta.cache_hit}}},grid_vs_manhattan:function(){const e=r("line_grid_forced"),t=r("line_manhattan_baseline");return{ok:!!e&&!!t&&e.meta.strategy.startsWith("grid")&&t.meta.strategy.startsWith("manhattan"),details:{gridStrategy:e?.meta.strategy,manStrategy:t?.meta.strategy}}},avoid_creates_bend:function(){const e="line_smart_clear",t=s(e);if(!t)return{ok:!1,details:"overlay not found"};const n=r(e);t._raw=t._raw||{};const o=Array.isArray(t._raw.avoid)?t._raw.avoid.slice():void 0;t._raw.avoid||(t._raw.avoid=[]),t._raw.avoid.includes("obstacle_vertical")||t._raw.avoid.push("obstacle_vertical"),i("*");const a=r(e);return void 0===o?delete t._raw.avoid:t._raw.avoid=o,i("*"),{ok:!!n&&!!a&&a.meta.bends>=n.meta.bends,details:{bendsBefore:n?.meta.bends,bendsAfter:a?.meta.bends}}},mode_hint_yx:function(){const e="line_grid_forced",t=s(e);if(!t)return{ok:!1,details:"overlay not found"};t._raw=t._raw||{},t._raw.route_mode="xy",i("*");const n=r(e);t._raw.route_mode="yx",i("*");const o=r(e);delete t._raw.route_mode,i("*");const a=n?.pts||[],l=o?.pts||[],c=a.length>=3&&a[1][1]===a[0][1],d=l.length>=3&&l[1][0]===l[0][0];return{ok:c&&d,details:{basePts:a,yxPts:l,baseHorizontalFirst:c,yxVerticalFirst:d}}},clearance_shift:function(){const e="line_grid_forced",n=t().router;if(!n)return{ok:!1,details:"router missing"};i("*");const s=r(e),o=n.config.clearance;n.config.clearance=(o||8)+24,i("*");const a=r(e);return n.config.clearance=o,i("*"),{ok:!!s&&!!a&&a.meta.cost>=s.meta.cost,details:{baseCost:s?.meta.cost,raisedCost:a?.meta.cost}}},anchor_move:function(){const e="smart_far_anchor",s=t(),o=n();if(!o?.anchors||!o.anchors[e])return{ok:!1,details:"anchor not present"};const a="line_smart_far_avoid";i("*");const l=r(a),c=o.anchors[e].slice(),d=s.setAnchor(e,[c[0]+40,c[1]]);i("*");const u=r(a);return s.setAnchor(e,c),i("*"),{ok:d&&!!l&&!!u&&l.pts[0][0]!==u.pts[0][0],details:{from:l?.pts[0],to:u?.pts[0],moved:d}}},fallback_impossible_grid:function(){const e=t().router;if(!e)return{ok:!1,details:"router missing"};const n=e._computeGrid;e._computeGrid=function(e){return"line_grid_forced"===e.id?null:n.call(this,e)},i("*");const s=r("line_grid_forced");return e._computeGrid=n,i("*"),{ok:!!s&&/manhattan|fallback/.test(s.meta.strategy),details:{strategy:s?.meta.strategy}}}},l={list:()=>Object.keys(a),run:e=>{if(!a[e])return console.warn("[MSD Scenario] Unknown",e),null;try{const t=a[e]();return o(e,t),t}catch(t){const n={ok:!1,details:String(t)};return o(e,n),n}},runAll:()=>{const e={};for(const t of Object.keys(a))e[t]=l.run(t);const t=Object.values(e).every((e=>e&&e.ok));return console.log("[MSD Scenario] Summary:",t?"ALL PASS":"FAILURES",e),e}};e.__msdScenarios.routing=l,console.info("[MSD v1] Routing scenario harness installed. Use: window.__msdScenarios.routing.list()")}()},157:()=>{!function(){if("undefined"==typeof window)return;const e=window;function t(t){return e.__msdDebug?.routing?.inspect(t)}function n(t="*"){e.__msdDebug?.routing?.invalidate(t)}function s(t,s,r){const i=e.__msdDebug?.lastRenderModel,o=i?.overlays?.find((e=>e.id===t));if(!o)throw new Error("overlay not found: "+t);o._raw=o._raw||{};const a=o._raw.route_mode_full;o._raw.route_mode_full=s;try{return n("*"),r()}finally{o._raw.route_mode_full=a,n("*")}}e.__msdScenarios=e.__msdScenarios||{};const r={smart_vs_grid_cost:function(){const e="line_grid_forced",n=s(e,"grid",(()=>t(e))),r=s(e,"smart",(()=>t(e)));return{ok:!!n&&!!r&&"smart"===r.meta.strategy&&r.meta.cost<=n.meta.cost+40,details:{gridCost:n?.meta.cost,smartCost:r?.meta.cost}}},smart_refinement_attempt:function(){const e="line_grid_forced",n=s(e,"smart",(()=>t(e))),r=n?.meta?.smart;return{ok:!!r&&r.detoursTried>=0,details:r}},smart_penalty_reduction:function(){const e="line_smart_blocked",n=s(e,"smart",(()=>t(e))),r=n?.meta;return r?.smart?{ok:r.smart.penaltyAfter<=r.smart.penaltyBefore,details:r.smart}:{ok:!1,details:"no smart meta"}},smart_cache_behavior:function(){const s="line_smart_forced_xy",r=e.__msdDebug?.lastRenderModel,i=r?.overlays?.find((e=>e.id===s));if(!i)return{ok:!1,details:"overlay not found"};i._raw=i._raw||{};const o=i._raw.route_mode_full;try{!function(t){const n=e.__msdDebug?.lastRenderModel,s=n?.overlays?.find((e=>e.id===t));if(!s)throw new Error("overlay not found: "+t);s._raw=s._raw||{},s._raw.route_mode_full="smart"}(s),n("*");const r=t(s),i=t(s);return{ok:!!r&&!!i&&!1===r.meta.cache_hit&&!0===i.meta.cache_hit,details:{firstHit:r?.meta.cache_hit,secondHit:i?.meta.cache_hit}}}catch(e){return{ok:!1,details:String(e)}}finally{i._raw.route_mode_full=o,n("*")}}},i={list:()=>Object.keys(r),run:e=>{if(!r[e])return console.warn("[MSD Smart Scenario] Unknown",e),null;try{const t=r[e]();return console.log(`[MSD Smart Scenario] ${e}: ${t.ok?"OK":"FAIL"}`,t),t}catch(t){const n={ok:!1,details:String(t)};return console.log(`[MSD Smart Scenario] ${e}: FAIL`,n),n}},runAll:()=>{const e={};for(const t of Object.keys(r))e[t]=i.run(t);const t=Object.values(e).every((e=>e&&e.ok));return console.log("[MSD Smart Scenario] Summary:",t?"ALL PASS":"FAILURES",e),e}};e.__msdScenarios.smart=i,console.info("[MSD v1] Smart routing scenario harness installed. Use: window.__msdScenarios.smart.list()")}()},786:()=>{!function(){if("undefined"==typeof window)return;const e=window;function t(t){return e.__msdDebug?.routing?.inspect(t)}function n(){e.__msdDebug?.routing?.invalidate("*")}e.__msdScenarios=e.__msdScenarios||{};const s="line_grid_forced";function r(){const t=function(){const t=e.__msdDebug?.pipelineInstance;if(!t||!t.enabled)throw new Error("pipeline disabled");return t}().getResolvedModel().overlays.find((e=>e.id===s));if(!t)throw new Error("overlay not found");return t._raw=t._raw||{},t}const i={smoothing_increases_points:function(){const e=r();e._raw.smoothing_mode="none",e._raw.smoothing_iterations=0,n();const i=t(s);e._raw.smoothing_mode="chaikin",e._raw.smoothing_iterations=2,n();const o=t(s);return delete e._raw.smoothing_mode,delete e._raw.smoothing_iterations,n(),{ok:!!i&&!!o&&o.pts.length>i.pts.length&&o.meta.smooth,details:{basePts:i?.pts.length,smoothPts:o?.pts.length,meta:o?.meta?.smooth}}},smoothing_cache_hit:function(){const e=r();e._raw.smoothing_mode="chaikin",e._raw.smoothing_iterations=1,n();const i=t(s),o=t(s);return delete e._raw.smoothing_mode,delete e._raw.smoothing_iterations,n(),{ok:!!i&&!!o&&!1===i.meta.cache_hit&&!0===o.meta.cache_hit,details:{firstHit:i?.meta.cache_hit,secondHit:o?.meta.cache_hit}}},smoothing_disabled_no_meta:function(){const e=r();e._raw.smoothing_mode="none",e._raw.smoothing_iterations=0,n();const i=t(s);return delete e._raw.smoothing_mode,delete e._raw.smoothing_iterations,n(),{ok:!!i&&!i.meta.smooth,details:{hasSmoothMeta:!!i.meta.smooth}}},smoothing_invalid_mode_fallback:function(){const e=r();e._raw.smoothing_mode="bogus_mode",e._raw.smoothing_iterations=2,n();const i=t(s);return delete e._raw.smoothing_mode,delete e._raw.smoothing_iterations,n(),{ok:!!i&&!i.meta.smooth,details:{hasSmoothMeta:!!i.meta.smooth}}}},o={list:()=>Object.keys(i),run:e=>{if(!i[e])return console.warn("[MSD Smooth Scenario] Unknown",e),null;try{const t=i[e]();return console.log(`[MSD Smooth Scenario] ${e}: ${t.ok?"OK":"FAIL"}`,t),t}catch(t){const n={ok:!1,details:String(t)};return console.log(`[MSD Smooth Scenario] ${e}: FAIL`,n),n}},runAll:()=>{const e={};for(const t of Object.keys(i))e[t]=o.run(t);const t=Object.values(e).every((e=>e&&e.ok));return console.log("[MSD Smooth Scenario] Summary:",t?"ALL PASS":"FAILURES",e),e}};e.__msdScenarios.smoothing=o,console.info("[MSD v1] Smoothing scenario harness installed. Use: window.__msdScenarios.smoothing.list()")}()},625:(e,t,n)=>{"use strict";n.r(t),n.d(t,{animateElement:()=>l,animateWithRoot:()=>a,applyPresets:()=>u,createTimeline:()=>c,createTimelines:()=>d,waitForElement:()=>i,waitForElements:()=>o});var s=n(191),r=n(152);function i(e,t=document,n=2e3){return new Promise(((s,r)=>{const i=t.querySelector(e);if(i)return s(i);const o=new MutationObserver((()=>{const n=t.querySelector(e);if(n){try{o.disconnect()}catch(e){}clearTimeout(a),s(n)}}));o.observe(t,{childList:!0,subtree:!0});const a=setTimeout((()=>{try{o.disconnect()}catch(e){}r(new Error(`[CB-LCARS] Timeout waiting for element: ${e}`))}),n)}))}async function o(e,t=document,n=2e3){const r=(o=e,Array.isArray(o)?o:o&&"number"==typeof o.length&&"function"==typeof o.item?Array.from(o):[o]).filter(Boolean);var o;const a=[];for(const e of r)try{if(e instanceof Element){a.push(e);continue}if("string"==typeof e){const s=e.split(",").map((e=>e.trim())).filter(Boolean);for(const e of s){const s=await i(e,t,n);s&&a.push(s);const r=t.querySelectorAll(e);for(const e of Array.from(r))a.includes(e)||a.push(e)}continue}s.lr.warn("[waitForElements] Unsupported target type, skipping.",{item:e})}catch(t){s.lr.error("[waitForElements] Failed to resolve target:",{item:e,error:t})}return a}async function a(e){const{targets:t,root:n=document,scopeId:r,...i}=e;if(t)try{const e=await o(t,n);if(0===e.length)return void s.lr.warn("[animateWithRoot] No targets resolved.",{targets:t});for(const t of e)try{let e;if(r&&window.cblcars.anim.scopes.has(r)){const n=window.cblcars.anim.scopes.get(r);e=window.cblcars.anime(t,{...i,scope:n.scope}),n.addAnimation(e)}else e=window.cblcars.anime(t,i)}catch(e){s.lr.error("[animateWithRoot] Failed to animate a resolved element.",{element:t?.id,error:e})}}catch(e){s.lr.error("[animateWithRoot] Failed to animate element(s):",{targets:t,error:e})}else s.lr.warn("[animateWithRoot] Animation missing targets.",{options:e})}async function l(e,t,n=null){const{type:a,targets:l,root:c=document,...d}=t;a&&l&&e?(s.lr.debug("[animateElement] Received options:",{options:t}),e.scope.add((async()=>{try{const h=await o(l,c);if(!h||0===h.length)return void s.lr.error("[animateElement] Target element(s) not found:",{targets:l});for(const o of h){const l={duration:1e3,easing:"easeInOutQuad",...d};if(t.state_resolver&&t.entity&&window.cblcars.styleHelpers?.resolveStateStyles){const e=window.cblcars.styleHelpers.resolveStateStyles(t.state_resolver,n,t.entity);Object.assign(l,e)}if(Array.isArray(a))u(a,l,o,t);else{const e=r.m[String(a).toLowerCase()];if(e)await e(l,o,t);else if("morph"===String(a).toLowerCase()){if(!t.morph_to_selector){s.lr.error("[animateElement] morph animation requires a `morph_to_selector`.",{options:t});continue}const e=await i(t.morph_to_selector,c);if(!e){s.lr.error(`[animateElement] morph could not find target shape for selector: ${t.morph_to_selector}`);continue}const n=t.precision?parseInt(t.precision,10):void 0;Object.assign(l,{d:window.cblcars.animejs.svg.morphTo(e,n)})}else s.lr.debug(`[animateElement] Using standard animation for type: ${a}`,{params:l})}l._cssAnimation||null===l.targets||(window.cblcars.anim.anime(o,l),s.lr.debug(`[animateElement] Animation constructor added to scope: ${e.id}`,{params:l,element:o.id}))}}catch(e){s.lr.error("[animateElement] Failed to animate element(s):",{targets:l,type:a,error:e})}}))):s.lr.warn("[animateElement] Animation missing type, targets, or scope.",{options:t,scope:e})}async function c(e,t,n=document){const s=window.cblcars.anim.scopes.get(t),r=window.cblcars.anim.animejs.createTimeline({scope:s?.scope});if(!Array.isArray(e))return r;for(const t of e){const{targets:e,offset:s,...i}=t||{};if(!e)continue;const o=await window.cblcars.anim.waitForElement(e,n);o&&r.add(o,i,s)}return s&&s.addAnimation?.(r),r}async function d(e,t,n=document,i={},a=null,l={}){const c=window.cblcars.anim.scopes.get(t);if(!c)return s.lr.error("[createTimelines] Scope not found:",t),{};const d={},u=window.cblcars.styleHelpers?.resolveAllDynamicValues;for(const[t,h]of Object.entries(e||{})){const{steps:e,...p}=h||{},g=u?u(p,a):p,m=window.cblcars.anim.animejs.createTimeline({scope:c.scope,...g});if(e&&Array.isArray(e)){for(const c of e){let e=[];try{e=await o(c.targets,n)}catch(e){s.lr.error(`[createTimelines] Failed to find target(s) for "${t}":`,{targets:c.targets,error:e});continue}if(e&&0!==e.length)for(const n of e){let e={...i?.[n.id]?.animation||{},...g,...c};if(c?.state_resolver&&window.cblcars.styleHelpers?.resolveStatePreset)try{const t=window.cblcars.styleHelpers.resolveStatePreset({state_resolver:c.state_resolver,entity:c.entity,attribute:c.attribute},l,a);t&&"object"==typeof t&&(e=t.animation&&"object"==typeof t.animation?{...e,...t.animation}:{...e,...t})}catch(e){s.lr.warn("[createTimelines] step.state_resolver failed",{timelineName:t,step:c,error:e})}e=u?u(e,a):e,"pulse"!==e.type&&"glow"!==e.type||"text"!==n.tagName&&"TEXT"!==n.tagName||(n.style.transformOrigin="center",n.style.transformBox="fill-box"),e.type&&r.m[e.type]&&(e.__timeline=!0,await r.m[e.type](e,n,e));const{targets:o,offset:d,direction:h,state_resolver:p,preset:f,entity:y,attribute:b,__timeline:_,deep:v,descendants:w,apply_to:S,...x}=e,$=!0===e.descendants||!0===e.deep||"descendants"===e.apply_to,C=["fill","stroke","stroke-width","filter","color","opacity"],M={};for(const e of C)void 0===x[e]||Array.isArray(x[e])||"object"==typeof x[e]||(M[e]=x[e]);if(Object.keys(M).length){const e=x.onBegin;x.onBegin=()=>{try{const e=$?n.querySelectorAll("*"):[n];window.cblcars?.anim?.utils?.set?e.forEach((e=>window.cblcars.anim.utils.set(e,M))):e.forEach((e=>{for(const[t,n]of Object.entries(M))t in e.style?e.style[t]=n:e.setAttribute(t,n)}))}catch(e){}"function"==typeof e&&e()}}m.add(n,x,d)}else s.lr.warn(`[createTimelines] No elements found for timeline "${t}" step:`,{targets:c.targets})}"function"==typeof c.addAnimation&&c.addAnimation(m),d[t]=m,!1===g?.autoplay&&s.lr.info(`[createTimelines] Timeline "${t}" created with autoplay: false.`)}else s.lr.warn(`[createTimelines] Timeline "${t}" has no steps array.`),d[t]=m}return d}function u(e,t,n,s){const i=Array.isArray(e)?e:[e];for(const e of i){const i=r.m[e.toLowerCase()];i&&i(t,n,s?.[e]||s)}}},152:(e,t,n)=>{"use strict";n.d(t,{m:()=>i});var s=n(191),r=n(988);const i={draw:(e,t,n={})=>{const[s]=window.cblcars.animejs.svg.createDrawable(t),r=e.duration??n.duration??1200,i=e.easing??n.easing??"easeInOutSine",o=e.loop??n.loop??!1,a=e.alternate??n.alternate??!1,l=e.draw||n.draw||{};let c;c=Array.isArray(l)?l:l&&Array.isArray(l.values)?l.values:["0 0","0 1"],Object.assign(e,{targets:s,draw:c,duration:r,easing:i,loop:o,alternate:a}),delete e.opacity,delete e["stroke-width"]},pulse:(e,t,n={})=>{s.lr.debug("[pulse preset] Before mutation:",{params:e,element:t,options:n});const r=e.pulse||n.pulse||n||{},i=void 0!==r.max_scale?r.max_scale:"text"===t.tagName||"TEXT"===t.tagName?1.1:1.5,o=void 0!==r.min_opacity?r.min_opacity:.7;delete e["stroke-width"],delete e.opacity;const a=e.duration??n.duration??1200,l=e.easing??n.easing??"easeInOutSine",c=e.loop??n.loop??!0,d=e.alternate??n.alternate??!0;if("text"===t.tagName||"TEXT"===t.tagName)Object.assign(e,{scale:[1,i],opacity:[1,o],easing:l,duration:a,loop:c,alternate:d}),t.style.transformOrigin="center",t.style.transformBox="fill-box",s.lr.debug("[pulse preset] Set transformOrigin/transformBox for text:",{id:t.id,style:t.style.cssText});else if(t.hasAttribute("stroke-width")){const n=parseFloat(t.getAttribute("stroke-width"))||4;Object.assign(e,{"stroke-width":[n,n*i],opacity:[1,o],easing:l,duration:a,loop:c,alternate:d}),s.lr.debug("[pulse preset] Pulsing line:",{id:t.id,strokeWidth:n,maxScale:i})}else Object.assign(e,{opacity:[1,o],easing:l,duration:a,loop:c,alternate:d});s.lr.debug("[pulse preset] After mutation:",{params:e,element:t})},blink:(e,t,n)=>{Object.assign(e,{opacity:[n.max_opacity??1,n.min_opacity??.3],alternate:!0,loop:!0,easing:n.easing||"linear",duration:n.duration??1200})},fade:(e,t,n={})=>{const s=e.duration??n.duration??1e3,r=e.easing??n.easing??"linear",i=e.loop??n.loop??!1,o=e.alternate??n.alternate??!1;Object.assign(e,{opacity:[0,1],duration:s,easing:r,loop:i,alternate:o})},motionpath:async function(e,t,n={}){try{const i=n.root??document;!window.cblcars.waitForElement&&window.cblcars.anim?.waitForElement&&(window.cblcars.waitForElement=window.cblcars.anim.waitForElement);const o=n.tracer;if(!o){const n="[motionpath] tracer is required";return s.lr.warn(n,{element:t}),void(e.targets=null)}const a=n.path_selector;let l=a?await window.cblcars.waitForElement(a,i).catch((()=>null)):t;if(!l){const t=`Motionpath: path not found for selector "${a||"(self)"}"`;return s.lr.error(t),void(e.targets=null)}if("path"!==String(l.tagName).toLowerCase()){const t="[motionpath] Target is not an SVG <path>";return s.lr.warn(t,{id:l.id}),void(e.targets=null)}const c=l.id||"msd_path",d=e=>!(!e||"string"!=typeof e)&&/[LCHQAVZlchqavz]/.test(e),u=e=>{try{return e.getTotalLength()>.5}catch(e){return!1}},h=e=>"true"===e?.getAttribute("data-cblcars-pending"),p=()=>{const e=l.ownerSVGElement||l.closest("svg")||i;if(!e)return;const t=e.querySelector(`#${c}_tracer[data-cblcars-owned="motionpath"]`),n=e.querySelector(`#${c}_trail[data-cblcars-owned="motionpath"]`);t?.parentNode&&t.parentNode.removeChild(t),n?.parentNode&&n.parentNode.removeChild(n)};let g=null,m=null,f=null,y=!0;const b=()=>{const t=n.trail;if(t)try{g=l.cloneNode(!0),g.id=`${c}_trail`,g.setAttribute("data-cblcars-owned","motionpath");const s=t.stroke||l.getAttribute("stroke")||"var(--lcars-yellow)",r=t["stroke-width"]??n["stroke-width"]??l.getAttribute("stroke-width")??4;g.setAttribute("stroke",s),g.setAttribute("stroke-width",r),void 0!==t.opacity&&g.setAttribute("opacity",t.opacity),"single"===(t.mode||"overlay")&&(l.setAttribute("opacity","0"),l.setAttribute("stroke","none")),h(l)&&g.setAttribute("visibility","hidden"),l.parentNode.insertBefore(g,l.nextSibling);const[i]=window.cblcars.animejs.svg.createDrawable(g),o={draw:"0 1",duration:t.duration??e.duration??1e3,easing:t.easing??e.easing??"linear",loop:t.loop??e.loop??!0};window.cblcars.anim.anime(i,o)}catch(e){s.lr.error("[motionpath] Trail setup failed:",e)}},_=()=>{let e=o.id||`${c}_tracer`;const t=l.ownerSVGElement||l.closest("svg")||l.parentNode,n=t?t.getElementById?.(e):null;let s;n&&"motionpath"!==n.getAttribute("data-cblcars-owned")&&(e=`${e}_mptrc`),s="rect"===o.shape?r.drawRect({x:-(o.width||8)/2,y:-(o.height||8)/2,width:o.width||8,height:o.height||8,id:e,attrs:{fill:o.fill||"var(--lcars-orange)"},style:o.style||{}}):r.drawCircle({cx:0,cy:0,r:o.r||4,id:e,attrs:{fill:o.fill||"var(--lcars-orange)"},style:o.style||{}});const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.innerHTML=s,m=i.firstElementChild,m.setAttribute("data-cblcars-owned","motionpath"),(t||l.parentNode).appendChild(m)},v=()=>{if(!m||!l)return;const{translateX:t,translateY:s,rotate:r}=window.cblcars.animejs.svg.createMotionPath(l),i=new Set(["tracer","trail","path_selector","root","targets","type","animation","stroke","stroke-width","corner_style","corner_radius","waypoints","steps","rounded","smooth","smooth_tension","id"]),o={};Object.entries({...e,...n}).forEach((([e,t])=>{i.has(e)||(o[e]=t)}));try{m.__cblcars_motion&&"function"==typeof m.__cblcars_motion.pause&&m.__cblcars_motion.pause()}catch(e){}m.__cblcars_motion=window.cblcars.anim.anime(m,{...o,translateX:t,translateY:s,rotate:r})},w=(e="")=>{try{if(!d(l.getAttribute("d"))||!u(l))return;g&&(g.setAttribute("d",l.getAttribute("d")||""),h(l)?g.setAttribute("visibility","hidden"):g.removeAttribute("visibility")),v()}catch(t){s.lr.warn("[motionpath] rebind failed",{reason:e,e:t})}},S=()=>{b(),_(),w("initial")},x=Number.isFinite(n.wait_max_ms)?n.wait_max_ms:12e3,$=120,C=performance.now(),M=()=>new Promise((e=>{const t=()=>{if(!y)return e(!1);const n=l.getAttribute("d")||"",s=h(l),r=d(n)&&u(l);return!s&&r?e(!0):!s&&performance.now()-C>=x?e(!1):void setTimeout(t,$)};t()}));if(p(),!await M()){const t=`[motionpath] Timed out waiting for usable path geometry (id=${l.id})`;return s.lr.warn(t),void(e.targets=null)}S();try{f=new MutationObserver((e=>{let t=!1;for(const n of e)if("attributes"===n.type&&("d"===n.attributeName||"data-cblcars-pending"===n.attributeName)){t=!0;break}t&&(g&&h(l)&&g.setAttribute("visibility","hidden"),w("mutation"))})),f.observe(l,{attributes:!0,attributeFilter:["d","data-cblcars-pending"]})}catch(e){}const A=l.id,k=()=>{if(!y)return;const e=i.getElementById&&i.getElementById(A)||l;if(e!==l&&e instanceof SVGPathElement){s.lr.debug("[motionpath] Path element replaced; reinitializing",{id:A});try{f?.disconnect()}catch(e){}l=e,p(),g=null,m=null,M().then((e=>{if(e){S();try{f=new MutationObserver((e=>{let t=!1;for(const n of e)if("attributes"===n.type&&("d"===n.attributeName||"data-cblcars-pending"===n.attributeName)){t=!0;break}t&&w("mutation(replaced)")})),f.observe(l,{attributes:!0,attributeFilter:["d","data-cblcars-pending"]})}catch(e){}}}))}setTimeout(k,2e3)};setTimeout(k,2e3),e.targets=null,t.__cblcars_motionpath_cleanup=()=>{y=!1;try{f?.disconnect()}catch(e){}try{m?.__cblcars_motion?.pause&&m.__cblcars_motion.pause()}catch(e){}try{p()}catch(e){}}}catch(t){s.lr.error("[motionpath] Unhandled error",t),e.targets=null}},march:(e,t,n={})=>{let r=e.stroke_dasharray??n.stroke_dasharray??[25,15];(!Array.isArray(r)||r.length<2)&&(r=[25,15]);const[i,o]=r;t.style.strokeDasharray=`${i} ${o}`,t.style.strokeDashoffset=0;const a=e.stroke_linecap??n.stroke_linecap;a&&(t.style.strokeLinecap=a);const l=i+o,c=(e.duration??n.duration??2e3)/1e3;let d=e.reversed??n.reversed??!1;const u=t.id||`march_${Math.random().toString(36).substring(2,9)}`;t.dataset.marchAnimId=u;const h=d?l:-l;let p=e.loop??n.loop??!0;const g=!0===p?"infinite":!1===p||0===p?"1":"number"==typeof p?Math.max(1,p):"infinite",m=t.getRootNode(),f=m!==document,y=`march_${u}`,b=`@keyframes ${y} { to { stroke-dashoffset: ${h}px; } }`,_=c/(e.playbackRate??n.playbackRate??1)+"s";if(t.style.animation=`${y} ${_} linear ${g}`,f&&m.adoptedStyleSheets)try{let e=Array.from(m.adoptedStyleSheets).find((e=>e.marchAnimations));e||(e=new CSSStyleSheet,e.marchAnimations=!0,m.adoptedStyleSheets=[...m.adoptedStyleSheets,e]),e.insertRule(b,e.cssRules.length)}catch(e){s.lr.error("Failed to add CSS animation to Shadow DOM:",e),v()}else v();function v(){const e="march-smooth-css-animations";let t=m.getElementById?m.getElementById(e):null;t||(t=document.createElement("style"),t.id=e,(f?m:document.head).appendChild(t)),t.textContent.includes(y)||(t.textContent+=b)}Object.assign(e,{_cssAnimation:!0,duration:1,loop:!1,autoplay:!1})},glow:(e,t,n={})=>{s.lr.debug("[glow preset] Before mutation:",{params:e,element:t,options:n});const r=n.glow||{},i=r.color||n.color||"var(--picard-light-blue)",o=r.intensity??n.intensity??.8,a=r.blur_min??0,l=r.blur_max??12,c=r.opacity_min??.4,d=r.opacity_max??o,u=n.duration??r.duration??900,h=n.easing??r.easing??"easeInOutSine",p=n.loop??r.loop??!0,g=n.alternate??r.alternate??!0,m={blur:a,opacity:c};Object.assign(e,{targets:m,blur:[a,l,a],opacity:[c,d,c],duration:u,easing:h,loop:p,alternate:g,onUpdate(){"text"===t.tagName||"TEXT"===t.tagName?t.style.filter=`drop-shadow(0 0 ${m.blur}px ${i}) opacity(${m.opacity})`:t.style.filter=`drop-shadow(0 0 ${m.blur}px ${i})`}}),delete e.fill,delete e.stroke,t.style.transformOrigin="center",t.style.transformBox="fill-box",s.lr.debug("[glow preset] Animating drop-shadow:",{color:i,intensity:o,blurMin:a,blurMax:l,opacityMin:c,opacityMax:d,duration:u,easing:h,loop:p,alternate:g}),s.lr.debug("[glow preset] After mutation:",{params:e,element:t})},shimmer:(e,t,n={})=>{const s=n.color||"var(--lcars-yellow)";Object.assign(e,{opacity:[1,.5,1],fill:[t.getAttribute("fill")||s,s],alternate:!0,loop:!0,easing:"easeInOutSine",duration:n.duration??1200})},strobe:(e,t,n={})=>{Object.assign(e,{opacity:[1,.1],alternate:!0,loop:!0,easing:"steps(2, end)",duration:n.duration??400})},cascade:(e,t,n={})=>{Object.assign(e,{opacity:[0,1],delay:window.cblcars.animejs.stagger(n.stagger??100),easing:"easeOutQuad",duration:n.duration??800})},ripple:(e,t,n={})=>{Object.assign(e,{scale:[1,n.max_scale??2,1],opacity:[1,.3,1],alternate:!0,loop:!0,easing:"easeInOutSine",duration:n.duration??1200})},flicker:(e,t,n={})=>{Object.assign(e,{opacity:[1,.7+.3*Math.random(),.4+.3*Math.random(),1],alternate:!1,loop:!0,easing:"steps(4, end)",duration:n.duration??600})},set:(e,t,n={})=>{if(n&&n.__timeline)return;const r=["type","targets","root","animation","id","offset","__timeline"],i={...e,...n},o={};Object.entries(i).forEach((([e,t])=>{r.includes(e)||void 0===t||(o[e]=t)}));let a=!1;try{window.cblcars?.anim?.utils?.set&&(window.cblcars.anim.utils.set(t,o),a=!0)}catch(e){s.lr.warn("[set preset] animejs.utils.set() failed, will fallback to manual mutation.",{e})}if(!a)for(const[e,n]of Object.entries(o))try{e in t.style?t.style[e]=n:t.setAttribute(e,n)}catch(t){s.lr.warn(`[set preset] Could not set "${e}"="${n}" manually`,{e:t})}e._cssAnimation=!0,e.targets=null}}},191:(e,t,n)=>{"use strict";n.d(t,{lr:()=>l,mD:()=>i,mZ:()=>o,zf:()=>c});var s=n(640);let r="info";function i(e){r=e,l.info(`Setting CBLCARS global log level set to: ${e}`,{},"info")}function o(){return r}function a(e,...t){const n=["error","warn","info","debug"],s=n.indexOf(r);if(n.indexOf(e)>s)return;const i={info:"background-color: #37a6d1",warn:"background-color: #ff6753",error:"background-color: #ef1d10",debug:"background-color: #8e44ad",default:"background-color: #6d748c"},o=`%c    CB-LCARS | ${e} `,a=`${i[e]||i.default}; color: white; padding: 1px 4px; border-radius: 15px;`;switch(e){case"info":default:console.log(o,a,...t);break;case"warn":console.warn(o,a,...t);break;case"error":console.error(o,a,...t);break;case"debug":console.debug(o,a,...t)}}function l(e,...t){return a(e,...t)}function c(){const e=s.WG,t=s.i_,n="CB-LCARS v"+e,r=t.length+4-n.length,i=r>0?" ".repeat(r):"",o=" ".repeat(4)+t;console.info(`%c${i}${n}  %c\n%c${o}  `,["color: white","font-weight: bold","padding: 2px 4px","border-radius: 5em 5em 0 0","background-color: #37a6d1"].join(";"),["color: transparent","padding: 0","border: none"].join(";"),["color: white","padding: 2px 4px","border-radius: 0 0 5em 5em","background-color: #37a6d1"].join(";"))}window.cblcars=window.cblcars||{},window.cblcars.setGlobalLogLevel=i,window.cblcars.getGlobalLogLevel=o,["error","warn","info","debug"].forEach((e=>{window.cblcars.setGlobalLogLevel[e]=()=>i(e)})),l.log=(...e)=>a("info",...e),l.info=(...e)=>a("info",...e),l.warn=(...e)=>a("warn",...e),l.error=(...e)=>a("error",...e),l.debug=(...e)=>a("debug",...e)},988:(e,t,n)=>{"use strict";function s({x1:e,y1:t,x2:n,y2:s,id:r,attrs:i={},style:o={}}){return`<line id="${r||""}" x1="${e}" y1="${t}" x2="${n}" y2="${s}"${c(i)}${d(o)} />`}function r({points:e,id:t,attrs:n={},style:s={}}){return`<polyline id="${t||""}" points="${e.map((e=>e.join(","))).join(" ")}"${c(n)}${d(s)} />`}function i({d:e,id:t,attrs:n={},style:s={}}){return`<path id="${t||""}" d="${e}"${c(n)}${d(s)} />`}function o({x:e,y:t,text:n,id:s,attrs:r={},style:i={}}){return`<text id="${s||""}" x="${e}" y="${t}"${c(r)}${d(i)}>${n}</text>`}function a({cx:e,cy:t,r:n,id:s,attrs:r={},style:i={}}){return`<circle id="${s||""}" cx="${e}" cy="${t}" r="${n}"${c(r)}${d(i)} />`}function l({x:e,y:t,width:n,height:s,id:r,attrs:i={},style:o={}}){return`<rect id="${r||""}" x="${e}" y="${t}" width="${n}" height="${s}"${c(i)}${d(o)} />`}function c(e){return e&&"object"==typeof e?Object.entries(e).map((([e,t])=>` ${e.replace(/[A-Z]/g,(e=>"-"+e.toLowerCase()))}="${t}"`)).join(""):""}function d(e){if(!e||"object"!=typeof e)return"";const t=Object.entries(e).map((([e,t])=>`${e.replace(/[A-Z]/g,(e=>"-"+e.toLowerCase()))}:${t}`)).join(";");return t?` style="${t}"`:""}n.r(t),n.d(t,{attrsToString:()=>c,drawCircle:()=>a,drawLine:()=>s,drawPath:()=>i,drawPolyline:()=>r,drawRect:()=>l,drawText:()=>o,styleToString:()=>d})},752:(e,t,n)=>{"use strict";n.d(t,{JW:()=>C,XX:()=>G,c0:()=>A,ej:()=>M,ge:()=>H,qy:()=>$,s6:()=>k});const s=globalThis,r=s.trustedTypes,i=r?r.createPolicy("lit-html",{createHTML:e=>e}):void 0,o="$lit$",a=`lit$${Math.random().toFixed(9).slice(2)}$`,l="?"+a,c=`<${l}>`,d=document,u=()=>d.createComment(""),h=e=>null===e||"object"!=typeof e&&"function"!=typeof e,p=Array.isArray,g=e=>p(e)||"function"==typeof e?.[Symbol.iterator],m="[ \t\n\f\r]",f=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,y=/-->/g,b=/>/g,_=RegExp(`>|${m}(?:([^\\s"'>=/]+)(${m}*=${m}*(?:[^ \t\n\f\r"'\`<>=]|("|')|))|$)`,"g"),v=/'/g,w=/"/g,S=/^(?:script|style|textarea|title)$/i,x=e=>(t,...n)=>({_$litType$:e,strings:t,values:n}),$=x(1),C=x(2),M=x(3),A=Symbol.for("lit-noChange"),k=Symbol.for("lit-nothing"),D=new WeakMap,E=d.createTreeWalker(d,129);function T(e,t){if(!p(e)||!e.hasOwnProperty("raw"))throw Error("invalid template strings array");return void 0!==i?i.createHTML(t):t}const R=(e,t)=>{const n=e.length-1,s=[];let r,i=2===t?"<svg>":3===t?"<math>":"",l=f;for(let t=0;t<n;t++){const n=e[t];let d,u,h=-1,p=0;for(;p<n.length&&(l.lastIndex=p,u=l.exec(n),null!==u);)p=l.lastIndex,l===f?"!--"===u[1]?l=y:void 0!==u[1]?l=b:void 0!==u[2]?(S.test(u[2])&&(r=RegExp("</"+u[2],"g")),l=_):void 0!==u[3]&&(l=_):l===_?">"===u[0]?(l=r??f,h=-1):void 0===u[1]?h=-2:(h=l.lastIndex-u[2].length,d=u[1],l=void 0===u[3]?_:'"'===u[3]?w:v):l===w||l===v?l=_:l===y||l===b?l=f:(l=_,r=void 0);const g=l===_&&e[t+1].startsWith("/>")?" ":"";i+=l===f?n+c:h>=0?(s.push(d),n.slice(0,h)+o+n.slice(h)+a+g):n+a+(-2===h?t:g)}return[T(e,i+(e[n]||"<?>")+(2===t?"</svg>":3===t?"</math>":"")),s]};class O{constructor({strings:e,_$litType$:t},n){let s;this.parts=[];let i=0,c=0;const d=e.length-1,h=this.parts,[p,g]=R(e,t);if(this.el=O.createElement(p,n),E.currentNode=this.el.content,2===t||3===t){const e=this.el.content.firstChild;e.replaceWith(...e.childNodes)}for(;null!==(s=E.nextNode())&&h.length<d;){if(1===s.nodeType){if(s.hasAttributes())for(const e of s.getAttributeNames())if(e.endsWith(o)){const t=g[c++],n=s.getAttribute(e).split(a),r=/([.?@])?(.*)/.exec(t);h.push({type:1,index:i,name:r[2],strings:n,ctor:"."===r[1]?z:"?"===r[1]?B:"@"===r[1]?I:L}),s.removeAttribute(e)}else e.startsWith(a)&&(h.push({type:6,index:i}),s.removeAttribute(e));if(S.test(s.tagName)){const e=s.textContent.split(a),t=e.length-1;if(t>0){s.textContent=r?r.emptyScript:"";for(let n=0;n<t;n++)s.append(e[n],u()),E.nextNode(),h.push({type:2,index:++i});s.append(e[t],u())}}}else if(8===s.nodeType)if(s.data===l)h.push({type:2,index:i});else{let e=-1;for(;-1!==(e=s.data.indexOf(a,e+1));)h.push({type:7,index:i}),e+=a.length-1}i++}}static createElement(e,t){const n=d.createElement("template");return n.innerHTML=e,n}}function F(e,t,n=e,s){if(t===A)return t;let r=void 0!==s?n._$Co?.[s]:n._$Cl;const i=h(t)?void 0:t._$litDirective$;return r?.constructor!==i&&(r?._$AO?.(!1),void 0===i?r=void 0:(r=new i(e),r._$AT(e,n,s)),void 0!==s?(n._$Co??=[])[s]=r:n._$Cl=r),void 0!==r&&(t=F(e,r._$AS(e,t.values),r,s)),t}class N{constructor(e,t){this._$AV=[],this._$AN=void 0,this._$AD=e,this._$AM=t}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}u(e){const{el:{content:t},parts:n}=this._$AD,s=(e?.creationScope??d).importNode(t,!0);E.currentNode=s;let r=E.nextNode(),i=0,o=0,a=n[0];for(;void 0!==a;){if(i===a.index){let t;2===a.type?t=new P(r,r.nextSibling,this,e):1===a.type?t=new a.ctor(r,a.name,a.strings,this,e):6===a.type&&(t=new j(r,this,e)),this._$AV.push(t),a=n[++o]}i!==a?.index&&(r=E.nextNode(),i++)}return E.currentNode=d,s}p(e){let t=0;for(const n of this._$AV)void 0!==n&&(void 0!==n.strings?(n._$AI(e,n,t),t+=n.strings.length-2):n._$AI(e[t])),t++}}class P{get _$AU(){return this._$AM?._$AU??this._$Cv}constructor(e,t,n,s){this.type=2,this._$AH=k,this._$AN=void 0,this._$AA=e,this._$AB=t,this._$AM=n,this.options=s,this._$Cv=s?.isConnected??!0}get parentNode(){let e=this._$AA.parentNode;const t=this._$AM;return void 0!==t&&11===e?.nodeType&&(e=t.parentNode),e}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(e,t=this){e=F(this,e,t),h(e)?e===k||null==e||""===e?(this._$AH!==k&&this._$AR(),this._$AH=k):e!==this._$AH&&e!==A&&this._(e):void 0!==e._$litType$?this.$(e):void 0!==e.nodeType?this.T(e):g(e)?this.k(e):this._(e)}O(e){return this._$AA.parentNode.insertBefore(e,this._$AB)}T(e){this._$AH!==e&&(this._$AR(),this._$AH=this.O(e))}_(e){this._$AH!==k&&h(this._$AH)?this._$AA.nextSibling.data=e:this.T(d.createTextNode(e)),this._$AH=e}$(e){const{values:t,_$litType$:n}=e,s="number"==typeof n?this._$AC(e):(void 0===n.el&&(n.el=O.createElement(T(n.h,n.h[0]),this.options)),n);if(this._$AH?._$AD===s)this._$AH.p(t);else{const e=new N(s,this),n=e.u(this.options);e.p(t),this.T(n),this._$AH=e}}_$AC(e){let t=D.get(e.strings);return void 0===t&&D.set(e.strings,t=new O(e)),t}k(e){p(this._$AH)||(this._$AH=[],this._$AR());const t=this._$AH;let n,s=0;for(const r of e)s===t.length?t.push(n=new P(this.O(u()),this.O(u()),this,this.options)):n=t[s],n._$AI(r),s++;s<t.length&&(this._$AR(n&&n._$AB.nextSibling,s),t.length=s)}_$AR(e=this._$AA.nextSibling,t){for(this._$AP?.(!1,!0,t);e&&e!==this._$AB;){const t=e.nextSibling;e.remove(),e=t}}setConnected(e){void 0===this._$AM&&(this._$Cv=e,this._$AP?.(e))}}class L{get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}constructor(e,t,n,s,r){this.type=1,this._$AH=k,this._$AN=void 0,this.element=e,this.name=t,this._$AM=s,this.options=r,n.length>2||""!==n[0]||""!==n[1]?(this._$AH=Array(n.length-1).fill(new String),this.strings=n):this._$AH=k}_$AI(e,t=this,n,s){const r=this.strings;let i=!1;if(void 0===r)e=F(this,e,t,0),i=!h(e)||e!==this._$AH&&e!==A,i&&(this._$AH=e);else{const s=e;let o,a;for(e=r[0],o=0;o<r.length-1;o++)a=F(this,s[n+o],t,o),a===A&&(a=this._$AH[o]),i||=!h(a)||a!==this._$AH[o],a===k?e=k:e!==k&&(e+=(a??"")+r[o+1]),this._$AH[o]=a}i&&!s&&this.j(e)}j(e){e===k?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,e??"")}}class z extends L{constructor(){super(...arguments),this.type=3}j(e){this.element[this.name]=e===k?void 0:e}}class B extends L{constructor(){super(...arguments),this.type=4}j(e){this.element.toggleAttribute(this.name,!!e&&e!==k)}}class I extends L{constructor(e,t,n,s,r){super(e,t,n,s,r),this.type=5}_$AI(e,t=this){if((e=F(this,e,t,0)??k)===A)return;const n=this._$AH,s=e===k&&n!==k||e.capture!==n.capture||e.once!==n.once||e.passive!==n.passive,r=e!==k&&(n===k||s);s&&this.element.removeEventListener(this.name,this,n),r&&this.element.addEventListener(this.name,this,e),this._$AH=e}handleEvent(e){"function"==typeof this._$AH?this._$AH.call(this.options?.host??this.element,e):this._$AH.handleEvent(e)}}class j{constructor(e,t,n){this.element=e,this.type=6,this._$AN=void 0,this._$AM=t,this.options=n}get _$AU(){return this._$AM._$AU}_$AI(e){F(this,e)}}const H={M:o,P:a,A:l,C:1,L:R,R:N,D:g,V:F,I:P,H:L,N:B,U:I,B:z,F:j},U=s.litHtmlPolyfillSupport;U?.(O,P),(s.litHtmlVersions??=[]).push("3.3.0");const G=(e,t,n)=>{const s=n?.renderBefore??t;let r=s._$litPart$;if(void 0===r){const e=n?.renderBefore??null;s._$litPart$=r=new P(t.insertBefore(u(),e),e,void 0,n??{})}return r._$AI(e),r}},534:(e,t,n)=>{"use strict";n.r(t),n.d(t,{UnsafeHTMLDirective:()=>i,unsafeHTML:()=>o});var s=n(752);class r{constructor(e){}get _$AU(){return this._$AM._$AU}_$AT(e,t,n){this._$Ct=e,this._$AM=t,this._$Ci=n}_$AS(e,t){return this.update(e,t)}update(e,t){return this.render(...t)}}class i extends r{constructor(e){if(super(e),this.it=s.s6,2!==e.type)throw Error(this.constructor.directiveName+"() can only be used in child bindings")}render(e){if(e===s.s6||null==e)return this._t=void 0,this.it=e;if(e===s.c0)return e;if("string"!=typeof e)throw Error(this.constructor.directiveName+"() called with a non-string value");if(e===this.it)return this._t;this.it=e;const t=[e];return t.raw=t,this._t={_$litType$:this.constructor.resultType,strings:t,values:[]}}}i.directiveName="unsafeHTML",i.resultType=1;const o=(a=i,(...e)=>({_$litDirective$:a,values:e}));var a},243:(e,t,n)=>{"use strict";n.r(t),n.d(t,{CSSResult:()=>a,LitElement:()=>D,ReactiveElement:()=>M,_$LE:()=>T,_$LH:()=>A.ge,adoptStyles:()=>d,css:()=>c,defaultConverter:()=>x,getCompatibleStyle:()=>u,html:()=>A.qy,isServer:()=>R,mathml:()=>A.ej,noChange:()=>A.c0,notEqual:()=>$,nothing:()=>A.s6,render:()=>A.XX,supportsAdoptingStyleSheets:()=>r,svg:()=>A.JW,unsafeCSS:()=>l});const s=globalThis,r=s.ShadowRoot&&(void 0===s.ShadyCSS||s.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,i=Symbol(),o=new WeakMap;class a{constructor(e,t,n){if(this._$cssResult$=!0,n!==i)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=e,this.t=t}get styleSheet(){let e=this.o;const t=this.t;if(r&&void 0===e){const n=void 0!==t&&1===t.length;n&&(e=o.get(t)),void 0===e&&((this.o=e=new CSSStyleSheet).replaceSync(this.cssText),n&&o.set(t,e))}return e}toString(){return this.cssText}}const l=e=>new a("string"==typeof e?e:e+"",void 0,i),c=(e,...t)=>{const n=1===e.length?e[0]:t.reduce(((t,n,s)=>t+(e=>{if(!0===e._$cssResult$)return e.cssText;if("number"==typeof e)return e;throw Error("Value passed to 'css' function must be a 'css' function result: "+e+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(n)+e[s+1]),e[0]);return new a(n,e,i)},d=(e,t)=>{if(r)e.adoptedStyleSheets=t.map((e=>e instanceof CSSStyleSheet?e:e.styleSheet));else for(const n of t){const t=document.createElement("style"),r=s.litNonce;void 0!==r&&t.setAttribute("nonce",r),t.textContent=n.cssText,e.appendChild(t)}},u=r?e=>e:e=>e instanceof CSSStyleSheet?(e=>{let t="";for(const n of e.cssRules)t+=n.cssText;return l(t)})(e):e,{is:h,defineProperty:p,getOwnPropertyDescriptor:g,getOwnPropertyNames:m,getOwnPropertySymbols:f,getPrototypeOf:y}=Object,b=globalThis,_=b.trustedTypes,v=_?_.emptyScript:"",w=b.reactiveElementPolyfillSupport,S=(e,t)=>e,x={toAttribute(e,t){switch(t){case Boolean:e=e?v:null;break;case Object:case Array:e=null==e?e:JSON.stringify(e)}return e},fromAttribute(e,t){let n=e;switch(t){case Boolean:n=null!==e;break;case Number:n=null===e?null:Number(e);break;case Object:case Array:try{n=JSON.parse(e)}catch(e){n=null}}return n}},$=(e,t)=>!h(e,t),C={attribute:!0,type:String,converter:x,reflect:!1,useDefault:!1,hasChanged:$};Symbol.metadata??=Symbol("metadata"),b.litPropertyMetadata??=new WeakMap;class M extends HTMLElement{static addInitializer(e){this._$Ei(),(this.l??=[]).push(e)}static get observedAttributes(){return this.finalize(),this._$Eh&&[...this._$Eh.keys()]}static createProperty(e,t=C){if(t.state&&(t.attribute=!1),this._$Ei(),this.prototype.hasOwnProperty(e)&&((t=Object.create(t)).wrapped=!0),this.elementProperties.set(e,t),!t.noAccessor){const n=Symbol(),s=this.getPropertyDescriptor(e,n,t);void 0!==s&&p(this.prototype,e,s)}}static getPropertyDescriptor(e,t,n){const{get:s,set:r}=g(this.prototype,e)??{get(){return this[t]},set(e){this[t]=e}};return{get:s,set(t){const i=s?.call(this);r?.call(this,t),this.requestUpdate(e,i,n)},configurable:!0,enumerable:!0}}static getPropertyOptions(e){return this.elementProperties.get(e)??C}static _$Ei(){if(this.hasOwnProperty(S("elementProperties")))return;const e=y(this);e.finalize(),void 0!==e.l&&(this.l=[...e.l]),this.elementProperties=new Map(e.elementProperties)}static finalize(){if(this.hasOwnProperty(S("finalized")))return;if(this.finalized=!0,this._$Ei(),this.hasOwnProperty(S("properties"))){const e=this.properties,t=[...m(e),...f(e)];for(const n of t)this.createProperty(n,e[n])}const e=this[Symbol.metadata];if(null!==e){const t=litPropertyMetadata.get(e);if(void 0!==t)for(const[e,n]of t)this.elementProperties.set(e,n)}this._$Eh=new Map;for(const[e,t]of this.elementProperties){const n=this._$Eu(e,t);void 0!==n&&this._$Eh.set(n,e)}this.elementStyles=this.finalizeStyles(this.styles)}static finalizeStyles(e){const t=[];if(Array.isArray(e)){const n=new Set(e.flat(1/0).reverse());for(const e of n)t.unshift(u(e))}else void 0!==e&&t.push(u(e));return t}static _$Eu(e,t){const n=t.attribute;return!1===n?void 0:"string"==typeof n?n:"string"==typeof e?e.toLowerCase():void 0}constructor(){super(),this._$Ep=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this._$Em=null,this._$Ev()}_$Ev(){this._$ES=new Promise((e=>this.enableUpdating=e)),this._$AL=new Map,this._$E_(),this.requestUpdate(),this.constructor.l?.forEach((e=>e(this)))}addController(e){(this._$EO??=new Set).add(e),void 0!==this.renderRoot&&this.isConnected&&e.hostConnected?.()}removeController(e){this._$EO?.delete(e)}_$E_(){const e=new Map,t=this.constructor.elementProperties;for(const n of t.keys())this.hasOwnProperty(n)&&(e.set(n,this[n]),delete this[n]);e.size>0&&(this._$Ep=e)}createRenderRoot(){const e=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return d(e,this.constructor.elementStyles),e}connectedCallback(){this.renderRoot??=this.createRenderRoot(),this.enableUpdating(!0),this._$EO?.forEach((e=>e.hostConnected?.()))}enableUpdating(e){}disconnectedCallback(){this._$EO?.forEach((e=>e.hostDisconnected?.()))}attributeChangedCallback(e,t,n){this._$AK(e,n)}_$ET(e,t){const n=this.constructor.elementProperties.get(e),s=this.constructor._$Eu(e,n);if(void 0!==s&&!0===n.reflect){const r=(void 0!==n.converter?.toAttribute?n.converter:x).toAttribute(t,n.type);this._$Em=e,null==r?this.removeAttribute(s):this.setAttribute(s,r),this._$Em=null}}_$AK(e,t){const n=this.constructor,s=n._$Eh.get(e);if(void 0!==s&&this._$Em!==s){const e=n.getPropertyOptions(s),r="function"==typeof e.converter?{fromAttribute:e.converter}:void 0!==e.converter?.fromAttribute?e.converter:x;this._$Em=s,this[s]=r.fromAttribute(t,e.type)??this._$Ej?.get(s)??null,this._$Em=null}}requestUpdate(e,t,n){if(void 0!==e){const s=this.constructor,r=this[e];if(n??=s.getPropertyOptions(e),!((n.hasChanged??$)(r,t)||n.useDefault&&n.reflect&&r===this._$Ej?.get(e)&&!this.hasAttribute(s._$Eu(e,n))))return;this.C(e,t,n)}!1===this.isUpdatePending&&(this._$ES=this._$EP())}C(e,t,{useDefault:n,reflect:s,wrapped:r},i){n&&!(this._$Ej??=new Map).has(e)&&(this._$Ej.set(e,i??t??this[e]),!0!==r||void 0!==i)||(this._$AL.has(e)||(this.hasUpdated||n||(t=void 0),this._$AL.set(e,t)),!0===s&&this._$Em!==e&&(this._$Eq??=new Set).add(e))}async _$EP(){this.isUpdatePending=!0;try{await this._$ES}catch(e){Promise.reject(e)}const e=this.scheduleUpdate();return null!=e&&await e,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??=this.createRenderRoot(),this._$Ep){for(const[e,t]of this._$Ep)this[e]=t;this._$Ep=void 0}const e=this.constructor.elementProperties;if(e.size>0)for(const[t,n]of e){const{wrapped:e}=n,s=this[t];!0!==e||this._$AL.has(t)||void 0===s||this.C(t,void 0,n,s)}}let e=!1;const t=this._$AL;try{e=this.shouldUpdate(t),e?(this.willUpdate(t),this._$EO?.forEach((e=>e.hostUpdate?.())),this.update(t)):this._$EM()}catch(t){throw e=!1,this._$EM(),t}e&&this._$AE(t)}willUpdate(e){}_$AE(e){this._$EO?.forEach((e=>e.hostUpdated?.())),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(e)),this.updated(e)}_$EM(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$ES}shouldUpdate(e){return!0}update(e){this._$Eq&&=this._$Eq.forEach((e=>this._$ET(e,this[e]))),this._$EM()}updated(e){}firstUpdated(e){}}M.elementStyles=[],M.shadowRootOptions={mode:"open"},M[S("elementProperties")]=new Map,M[S("finalized")]=new Map,w?.({ReactiveElement:M}),(b.reactiveElementVersions??=[]).push("2.1.0");var A=n(752);const k=globalThis;class D extends M{constructor(){super(...arguments),this.renderOptions={host:this},this._$Do=void 0}createRenderRoot(){const e=super.createRenderRoot();return this.renderOptions.renderBefore??=e.firstChild,e}update(e){const t=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(e),this._$Do=(0,A.XX)(t,this.renderRoot,this.renderOptions)}connectedCallback(){super.connectedCallback(),this._$Do?.setConnected(!0)}disconnectedCallback(){super.disconnectedCallback(),this._$Do?.setConnected(!1)}render(){return A.c0}}D._$litElement$=!0,D.finalized=!0,k.litElementHydrateSupport?.({LitElement:D});const E=k.litElementPolyfillSupport;E?.({LitElement:D});const T={_$AK:(e,t,n)=>{e._$AK(t,n)},_$AL:e=>e._$AL};(k.litElementVersions??=[]).push("4.2.0");const R=!1},330:e=>{"use strict";e.exports=JSON.parse('{"name":"cb-lcars","version":"2025.08.1-fuk.83-69","description":"Home Assistant LCARS libary built on custom-button-card","main":"index.js","author":"Jason Weyermars","license":"MIT","homepage":"https://cb-lcars.unimatrix01.ca","directories":{"doc":"doc"},"keywords":["HomeAssistant","Home Assistant","HASS","LCARS","Star Trek"],"scripts":{"clean":"rimraf dist","build":"webpack --mode production","generate-editor-json":"node src/editor/cb-lcars_generate_editor_forms.js","test:msd":"node scripts/msd/test-runner.js","test:msd:fast":"node scripts/msd/test-runner.js --fail-fast","test:msd:m1.1":"node scripts/msd/test-runner.js --milestone=1.1","test:msd:m1.2":"node scripts/msd/test-runner.js --milestone=1.2","test:msd:m1.3":"node scripts/msd/test-runner.js --milestone=1.3","test:msd:determinism":"node scripts/msd/test-determinism.js","test:msd:legacy":"node scripts/msd/test-legacy-removal.js","test:msd:validation":"node scripts/msd/test-validation-integration.js","test:msd:anchor":"node scripts/msd/test-anchor-validation.js","test:msd:performance":"node scripts/msd/test-performance.js","test:msd:export":"node scripts/msd/test-export-parity.js","test:msd:rules":"node scripts/msd/test-rules-engine.js","test:msd:palette":"node scripts/msd/test-palette-deep-merge.js","test:msd:anchor-prov":"node scripts/msd/test-anchor-provenance.js","test:msd:external":"node scripts/msd/test-external-packs.js","test:msd:rules-deps":"node scripts/msd/test-rule-dependencies.js","test:msd:rules-trace":"node scripts/msd/test-rule-tracing.js","test:msd:m2.1":"node scripts/msd/test-runner.js --milestone=2.1","test:msd:m2.2":"node scripts/msd/test-runner.js --milestone=2.2","test:msd:anim-registry":"node scripts/msd/test-animation-registry.js","test:msd:profile-system":"node scripts/msd/test-profile-system.js","test:msd:m3.1":"node scripts/msd/test-runner.js --milestone=3.1","test:msd:m3.2":"node scripts/msd/test-runner.js --milestone=3.2","test:msd:rendering":"node scripts/msd/test-advanced-rendering.js","test:msd:export-completion":"node scripts/msd/test-export-completion.js","test:msd:m4.1":"node scripts/msd/test-runner.js --milestone=4.1","test:msd:m4.2":"node scripts/msd/test-runner.js --milestone=4.2","test:msd:phase1":"node scripts/msd/test-phase1-data-layer.js","test:msd:phase2":"node scripts/msd/test-phase2-comprehensive.js","test:msd:phase3":"node scripts/msd/test-phase3-hud-system.js","test:msd:phase4":"node scripts/msd/test-phase4-controls-api.js","test:msd:real-data":"node scripts/msd/test-real-data-integration.js","test:msd:phase2-complete":"node scripts/msd/test-phase2-complete.js","test:msd:templates":"node scripts/msd/test-phase2-complete.js","test:msd:datasource":"node scripts/msd/test-datasource-integration.js","test:msd:sparkline-debug":"node scripts/msd/test-sparkline-debug.js","test:msd:debug-enhancements":"node scripts/msd/test-debug-enhancements.js","test:msd:export-panel":"node scripts/msd/test-export-panel.js","test:msd:status-grid-debug":"node scripts/msd/test-status-grid-debug-fixed.js","test:msd:status-grid-initial":"node scripts/msd/test-status-grid-initial-render.js","test:msd:bounding-boxes":"node scripts/msd/test-bounding-box-accuracy.js","test:all":"npm run test:msd","audit:form-ids":"node scripts/audit-form-ids.js"},"devDependencies":{"clean-webpack-plugin":"^4.0.0","js-yaml":"^4.1.0","rimraf":"^6.0.1","webpack":"^5.94.0","webpack-bundle-analyzer":"^4.10.2","webpack-cli":"^5.1.4","webpack-dev-server":"^5.0.4"},"dependencies":{"ha-editor-formbuilder-yaml":"github:snootched/ha-card-formbuilder","animejs":"^4.0.0"}}')}},t={};function n(s){var r=t[s];if(void 0!==r)return r.exports;var i=t[s]={exports:{}};return e[s](i,i.exports,n),i.exports}n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";var e={};n.r(e),n.d(e,{Animatable:()=>mn,Draggable:()=>$n,JSAnimation:()=>Pt,Scope:()=>Mn,ScrollObserver:()=>Pn,Spring:()=>yn,Timeline:()=>pn,Timer:()=>rt,WAAPIAnimation:()=>Kt,animate:()=>Lt,createAnimatable:()=>fn,createDraggable:()=>Cn,createScope:()=>An,createSpring:()=>bn,createTimeline:()=>gn,createTimer:()=>it,eases:()=>bt,engine:()=>ke,onScroll:()=>Ln,scrollContainers:()=>Dn,stagger:()=>zn,svg:()=>ze,utils:()=>dn,waapi:()=>Zt});var t={};n.r(t),n.d(t,{findSvgAnchors:()=>Sl,getSvgAspectRatio:()=>Cl,getSvgContent:()=>xl,getSvgViewBox:()=>$l});const s="undefined"!=typeof window,r=s?window:null,i=s?document:null,o={replace:0,none:1,blend:2},a=Symbol(),l=Symbol(),c=Symbol(),d=Symbol(),u=Symbol(),h=Symbol(),p=1e-11,g=1e12,m=1e3,f="",y=new Map;y.set("x","translateX"),y.set("y","translateY"),y.set("z","translateZ");const b=["translateX","translateY","translateZ","rotate","rotateX","rotateY","rotateZ","scale","scaleX","scaleY","scaleZ","skew","skewX","skewY","perspective","matrix","matrix3d"],_=b.reduce(((e,t)=>({...e,[t]:t+"("})),{}),v=()=>{},w=/(^#([\da-f]{3}){1,2}$)|(^#([\da-f]{4}){1,2}$)/i,S=/rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i,x=/rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(-?\d+|-?\d*.\d+)\s*\)/i,$=/hsl\(\s*(-?\d+|-?\d*.\d+)\s*,\s*(-?\d+|-?\d*.\d+)%\s*,\s*(-?\d+|-?\d*.\d+)%\s*\)/i,C=/hsla\(\s*(-?\d+|-?\d*.\d+)\s*,\s*(-?\d+|-?\d*.\d+)%\s*,\s*(-?\d+|-?\d*.\d+)%\s*,\s*(-?\d+|-?\d*.\d+)\s*\)/i,M=/[-+]?\d*\.?\d+(?:e[-+]?\d)?/gi,A=/^([-+]?\d*\.?\d+(?:e[-+]?\d+)?)([a-z]+|%)$/i,k=/([a-z])([A-Z])/g,D=/(\w+)(\([^)]+\)+)/g,E=/(\*=|\+=|-=)/,T={id:null,keyframes:null,playbackEase:null,playbackRate:1,frameRate:120,loop:0,reversed:!1,alternate:!1,autoplay:!0,duration:m,delay:0,loopDelay:0,ease:"out(2)",composition:o.replace,modifier:e=>e,onBegin:v,onBeforeUpdate:v,onUpdate:v,onLoop:v,onPause:v,onComplete:v,onRender:v},R={defaults:T,root:i,scope:null,precision:4,timeScale:1,tickThreshold:200},O={version:"4.0.2",engine:null};s&&(r.AnimeJS||(r.AnimeJS=[]),r.AnimeJS.push(O));const F=e=>e.replace(k,"$1-$2").toLowerCase(),N=(e,t)=>0===e.indexOf(t),P=Date.now,L=Array.isArray,z=e=>e&&e.constructor===Object,B=e=>"number"==typeof e&&!isNaN(e),I=e=>"string"==typeof e,j=e=>"function"==typeof e,H=e=>void 0===e,U=e=>H(e)||null===e,G=e=>s&&e instanceof SVGElement,q=e=>w.test(e),V=e=>N(e,"rgb"),W=e=>N(e,"hsl"),Y=e=>!R.defaults.hasOwnProperty(e),X=e=>I(e)?parseFloat(e):e,J=Math.pow,K=Math.sqrt,Z=Math.sin,Q=Math.cos,ee=Math.abs,te=Math.exp,ne=Math.ceil,se=Math.floor,re=Math.asin,ie=Math.max,oe=Math.atan2,ae=Math.PI,le=Math.round,ce=(e,t,n)=>e<t?t:e>n?n:e,de={},ue=(e,t)=>{if(t<0)return e;if(!t)return le(e);let n=de[t];return n||(n=de[t]=10**t),le(e*n)/n},he=(e,t)=>L(t)?t.reduce(((t,n)=>ee(n-e)<ee(t-e)?n:t)):t?le(e/t)*t:e,pe=(e,t,n)=>e+(t-e)*n,ge=e=>e===1/0?g:e===-1/0?-1e12:e,me=e=>e<=p?p:ge(ue(e,11)),fe=e=>L(e)?[...e]:e,ye=(e,t)=>{const n={...e};for(let s in t){const r=e[s];n[s]=H(r)?t[s]:r}return n},be=(e,t,n,s="_prev",r="_next")=>{let i=e._head,o=r;for(n&&(i=e._tail,o=s);i;){const e=i[o];t(i),i=e}},_e=(e,t,n="_prev",s="_next")=>{const r=t[n],i=t[s];r?r[s]=i:e._head=i,i?i[n]=r:e._tail=r,t[n]=null,t[s]=null},ve=(e,t,n,s="_prev",r="_next")=>{let i=e._tail;for(;i&&n&&n(i,t);)i=i[s];const o=i?i[r]:e._head;i?i[r]=t:e._head=t,o?o[s]=t:e._tail=t,t[s]=i,t[r]=o};class we{constructor(e=0){this.deltaTime=0,this._currentTime=e,this._elapsedTime=e,this._startTime=e,this._lastTime=e,this._scheduledTime=0,this._frameDuration=ue(m/120,0),this._fps=120,this._speed=1,this._hasChildren=!1,this._head=null,this._tail=null}get fps(){return this._fps}set fps(e){const t=this._frameDuration,n=+e,s=n<p?p:n,r=ue(m/s,0);this._fps=s,this._frameDuration=r,this._scheduledTime+=r-t}get speed(){return this._speed}set speed(e){const t=+e;this._speed=t<p?p:t}requestTick(e){const t=this._scheduledTime,n=this._elapsedTime;if(this._elapsedTime+=e-n,n<t)return 0;const s=this._frameDuration,r=n-t;return this._scheduledTime+=r<s?s:r,1}computeDeltaTime(e){const t=e-this._lastTime;return this.deltaTime=t,this._lastTime=e,t}}const Se=(e,t,n,s,r)=>{const i=e.parent,a=e.duration,l=e.completed,c=e.iterationDuration,u=e.iterationCount,h=e._currentIteration,g=e._loopDelay,m=e._reversed,y=e._alternate,b=e._hasChildren,v=e._delay,w=e._currentTime,S=v+c,x=t-v,$=ce(w,-v,a),C=ce(x,-v,a),M=x-w,A=C>0,k=C>=a,D=a<=p,E=2===r;let T=0,O=x,F=0;if(u>1){const t=~~(C/(c+(k?0:g)));e._currentIteration=ce(t,0,u),k&&e._currentIteration--,T=e._currentIteration%2,O=C%(c+g)||0}const N=m^(y&&T),P=e._ease;let L=k?N?0:a:N?c-O:O;P&&(L=c*P(L/c)||0);const z=(i?i.backwards:x<w)?!N:!!N;if(e._currentTime=x,e._iterationTime=L,e.backwards=z,A&&!e.began?(e.began=!0,n||i&&(z||!i.began)||e.onBegin(e)):x<=0&&(e.began=!1),n||b||!A||e._currentIteration===h||e.onLoop(e),E||1===r&&(t>=v&&t<=S||t<=v&&$>v||t>=S&&$!==a)||L>=S&&$!==a||L<=v&&$>0||t<=$&&$===a&&l||k&&!l&&D){if(A&&(e.computeDeltaTime($),n||e.onBeforeUpdate(e)),!b){const t=E||(z?-1*M:M)>=R.tickThreshold,r=e._offset+(i?i._offset:0)+v+L;let a,l,c,u,h=e._head,p=0;for(;h;){const e=h._composition,n=h._currentTime,i=h._changeDuration,g=h._absoluteStartTime+h._changeDuration,m=h._nextRep,y=h._prevRep,b=e!==o.none;if((t||(n!==i||r<=g+(m?m._delay:0))&&(0!==n||r>=h._absoluteStartTime))&&(!b||!h._isOverridden&&(!h._isOverlapped||r<=g)&&(!m||m._isOverridden||r<=m._absoluteStartTime)&&(!y||y._isOverridden||r>=y._absoluteStartTime+y._changeDuration+h._delay))){const t=h._currentTime=ce(L-h._startTime,0,i),n=h._ease(t/h._updateDuration),r=h._modifier,g=h._valueType,m=h._tweenType,f=0===m,y=0===g,_=y&&f||0===n||1===n?-1:R.precision;let v,w;if(y)v=w=r(ue(pe(h._fromNumber,h._toNumber,n),_));else if(1===g)w=r(ue(pe(h._fromNumber,h._toNumber,n),_)),v=`${w}${h._unit}`;else if(2===g){const e=h._fromNumbers,t=h._toNumbers,s=ue(ce(r(pe(e[0],t[0],n)),0,255),0),i=ue(ce(r(pe(e[1],t[1],n)),0,255),0),o=ue(ce(r(pe(e[2],t[2],n)),0,255),0),a=ce(r(ue(pe(e[3],t[3],n),_)),0,1);if(v=`rgba(${s},${i},${o},${a})`,b){const e=h._numbers;e[0]=s,e[1]=i,e[2]=o,e[3]=a}}else if(3===g){v=h._strings[0];for(let e=0,t=h._toNumbers.length;e<t;e++){const t=r(ue(pe(h._fromNumbers[e],h._toNumbers[e],n),_)),s=h._strings[e+1];v+=`${s?t+s:t}`,b&&(h._numbers[e]=t)}}if(b&&(h._number=w),s||e===o.blend)h._value=v;else{const e=h.property;a=h.target,f?a[e]=v:1===m?a.setAttribute(e,v):(l=a.style,3===m?(a!==c&&(c=a,u=a[d]),u[e]=v,p=1):2===m?l[e]=v:4===m&&l.setProperty(e,v)),A&&(F=1)}}if(p&&h._renderTransforms){let e=f;for(let t in u)e+=`${_[t]}${u[t]}) `;l.transform=e,p=0}h=h._next}!n&&F&&e.onRender(e)}!n&&A&&e.onUpdate(e)}return i&&D?!n&&(i.began&&!z&&x>=a&&!l||z&&x<=p&&l)&&(e.onComplete(e),e.completed=!z):A&&k?u===1/0?e._startTime+=e.duration:e._currentIteration>=u-1&&(e.paused=!0,l||b||(e.completed=!0,n||i&&(z||!i.began)||(e.onComplete(e),e._resolve(e)))):e.completed=!1,F},xe=(e,t,n,s,r)=>{const i=e._currentIteration;if(Se(e,t,n,s,r),e._hasChildren){const o=e,a=o.backwards,l=s?t:o._iterationTime,c=P();let d=0,u=!0;if(!s&&o._currentIteration!==i){const e=o.iterationDuration;be(o,(t=>{if(a){const s=t.duration,r=t._offset+t._delay;n||!(s<=p)||r&&r+s!==e||t.onComplete(t)}else!t.completed&&!t.backwards&&t._currentTime<t.iterationDuration&&Se(t,e,n,1,2),t.began=!1,t.completed=!1})),n||o.onLoop(o)}be(o,(e=>{const t=ue((l-e._offset)*e._speed,12),i=e._fps<o._fps?e.requestTick(c):r;d+=Se(e,t,n,s,i),!e.completed&&u&&(u=!1)}),a),!n&&d&&o.onRender(o),u&&o._currentTime>=o.duration&&(o.paused=!0,o.completed||(o.completed=!0,n||(o.onComplete(o),o._resolve(o))))}},$e={animation:null,update:v},Ce=s?requestAnimationFrame:setImmediate,Me=s?cancelAnimationFrame:clearImmediate;class Ae extends we{constructor(e){super(e),this.useDefaultMainLoop=!0,this.pauseOnDocumentHidden=!0,this.defaults=T,this.paused=!(!s||!i.hidden),this.reqId=null}update(){const e=this._currentTime=P();if(this.requestTick(e)){this.computeDeltaTime(e);const t=this._speed,n=this._fps;let s=this._head;for(;s;){const r=s._next;s.paused?(_e(this,s),this._hasChildren=!!this._tail,s._running=!1,s.completed&&!s._cancelled&&s.cancel()):xe(s,(e-s._startTime)*s._speed*t,0,0,s._fps<n?s.requestTick(e):1),s=r}$e.update()}}wake(){return!this.useDefaultMainLoop||this.reqId||this.paused||(this.reqId=Ce(De)),this}pause(){return this.paused=!0,Ee()}resume(){if(this.paused)return this.paused=!1,be(this,(e=>e.resetTime())),this.wake()}get speed(){return this._speed*(1===R.timeScale?1:m)}set speed(e){this._speed=e*R.timeScale,be(this,(e=>e.speed=e._speed))}get timeUnit(){return 1===R.timeScale?"ms":"s"}set timeUnit(e){const t="s"===e,n=t?.001:1;if(R.timeScale!==n){R.timeScale=n,R.tickThreshold=200*n;const e=t?.001:m;this.defaults.duration*=e,this._speed*=e}}get precision(){return R.precision}set precision(e){R.precision=e}}const ke=(()=>{const e=new Ae(P());return s&&(O.engine=e,i.addEventListener("visibilitychange",(()=>{e.pauseOnDocumentHidden&&(i.hidden?e.pause():e.resume())}))),e})(),De=()=>{ke._head?(ke.reqId=Ce(De),ke.update()):ke.reqId=0},Ee=()=>(Me(ke.reqId),ke.reqId=0,ke);function Te(e){const t=I(e)?R.root.querySelectorAll(e):e;if(t instanceof NodeList||t instanceof HTMLCollection)return t}function Re(e){if(U(e))return[];if(L(e)){const t=e.flat(1/0),n=[];for(let e=0,s=t.length;e<s;e++){const s=t[e];if(!U(s)){const e=Te(s);if(e)for(let t=0,s=e.length;t<s;t++){const s=e[t];if(!U(s)){let e=!1;for(let t=0,r=n.length;t<r;t++)if(n[t]===s){e=!0;break}e||n.push(s)}}else{let e=!1;for(let t=0,r=n.length;t<r;t++)if(n[t]===s){e=!0;break}e||n.push(s)}}}return n}if(!s)return[e];const t=Te(e);return t?Array.from(t):[e]}function Oe(e){const t=Re(e),n=t.length;if(n)for(let e=0;e<n;e++){const n=t[e];if(!n[a]){n[a]=!0;const e=G(n);(n.nodeType||e)&&(n[l]=!0,n[c]=e,n[d]={})}}return t}const Fe=e=>{const t=Re(e)[0];if(t&&G(t))return t},Ne=(e,t,n=0)=>e.getPointAtLength(t+n>=1?t+n:0),Pe=(e,t)=>n=>{const s=+e.getTotalLength(),r=n[c],i=e.getCTM();return{from:0,to:s,modifier:n=>{if("a"===t){const t=Ne(e,n,-1),s=Ne(e,n,1);return 180*oe(s.y-t.y,s.x-t.x)/ae}{const s=Ne(e,n,0);return"x"===t?r||!i?s.x:s.x*i.a+s.y*i.c+i.e:r||!i?s.y:s.x*i.b+s.y*i.d+i.f}}}},Le=["opacity","rotate","overflow","color"],ze={morphTo:(e,t=.33)=>n=>{const s=Fe(e);if(!s)return;const r="path"===n.tagName,i=r?" ":",",o=n[u];o&&n.setAttribute(r?"d":"points",o);let a="",l="";if(t){const e=n.getTotalLength(),o=s.getTotalLength(),c=Math.max(Math.ceil(e*t),Math.ceil(o*t));for(let t=0;t<c;t++){const d=t/(c-1),u=n.getPointAtLength(e*d),h=s.getPointAtLength(o*d),p=r?0===t?"M":"L":"";a+=p+ue(u.x,3)+i+u.y+" ",l+=p+ue(h.x,3)+i+h.y+" "}}else a=n.getAttribute(r?"d":"points"),l=s.getAttribute(r?"d":"points");return n[u]=l,[a,l]},createMotionPath:e=>{const t=Fe(e);if(t)return{translateX:Pe(t,"x"),translateY:Pe(t,"y"),rotate:Pe(t,"a")}},createDrawable:(e,t=0,n=0)=>Re(e).map((e=>((e,t,n)=>{const s=m,r=getComputedStyle(e),i=r.strokeLinecap,o="non-scaling-stroke"===r.vectorEffect?e:null;let a=i;const l=new Proxy(e,{get(e,t){const n=e[t];return t===h?e:"setAttribute"===t?(...t)=>{if("draw"===t[0]){const n=t[1].split(" "),r=+n[0],l=+n[1],c=(e=>{let t=1;if(e&&e.getCTM){const n=e.getCTM();n&&(t=(K(n.a*n.a+n.b*n.b)+K(n.c*n.c+n.d*n.d))/2)}return t})(o),d=-1e3*r*c,u=l*s*c+d,h=s*c+(0===r&&1===l||1===r&&0===l?0:10*c)-u;if("butt"!==i){const t=r===l?"butt":i;a!==t&&(e.style.strokeLinecap=`${t}`,a=t)}e.setAttribute("stroke-dashoffset",`${d}`),e.setAttribute("stroke-dasharray",`${u} ${h}`)}return Reflect.apply(n,e,t)}:j(n)?(...t)=>Reflect.apply(n,e,t):n}});return"1000"!==e.getAttribute("pathLength")&&(e.setAttribute("pathLength","1000"),l.setAttribute("draw",`${t} ${n}`)),l})(e,t,n)))},Be=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e),Ie=(e,t)=>H(e)?t:e,je=(e,t,n,s,r)=>{if(j(e)){const i=()=>{const r=e(t,n,s);return isNaN(+r)?r||0:+r};return r&&(r.func=i),i()}return e},He=(e,t)=>e[l]?e[c]&&((e,t)=>{if(Le.includes(t))return!1;if(e.getAttribute(t)||t in e){if("scale"===t){const t=e.parentNode;return t&&"filter"===t.tagName}return!0}})(e,t)?1:b.includes(t)||y.get(t)?3:N(t,"--")?4:t in e.style?2:t in e?0:1:0,Ue=(e,t,n)=>{const s=e.style[t];s&&n&&(n[t]=s);const r=s||getComputedStyle(e[h]||e).getPropertyValue(t);return"auto"===r?"0":r},Ge=(e,t,n,s)=>{const r=H(n)?He(e,t):n;return 0===r?e[t]||0:1===r?e.getAttribute(t):3===r?((e,t,n)=>{const s=e.style.transform;let r;if(s){const i=e[d];let o;for(;o=D.exec(s);){const e=o[1],s=o[2].slice(1,-1);i[e]=s,e===t&&(r=s,n&&(n[t]=s))}}return s&&!H(r)?r:N(t,"scale")?"1":N(t,"rotate")||N(t,"skew")?"0deg":"0px"})(e,t,s):4===r?Ue(e,t,s).trimStart():Ue(e,t,s)},qe=(e,t,n)=>"-"===n?e-t:"+"===n?e+t:e*t,Ve=(e,t)=>{if(t.t=0,t.n=0,t.u=null,t.o=null,t.d=null,t.s=null,!e)return t;const n=+e;if(isNaN(n)){let n=e;"="===n[1]&&(t.o=n[0],n=n.slice(2));const r=!n.includes(" ")&&A.exec(n);if(r)return t.t=1,t.n=+r[1],t.u=r[2],t;if(t.o)return t.n=+n,t;if((e=>q(e)||V(e)||W(e))(n))return t.t=2,t.d=V(s=n)?(e=>{const t=S.exec(e)||x.exec(e),n=H(t[4])?1:+t[4];return[+t[1],+t[2],+t[3],n]})(s):q(s)?(e=>{const t=e.length,n=4===t||5===t;return[+("0x"+e[1]+e[n?1:2]),+("0x"+e[n?2:3]+e[n?2:4]),+("0x"+e[n?3:5]+e[n?3:6]),5===t||9===t?+(+("0x"+e[n?4:7]+e[n?4:8])/255).toFixed(3):1]})(s):W(s)?(e=>{const t=$.exec(e)||C.exec(e),n=+t[1]/360,s=+t[2]/100,r=+t[3]/100,i=H(t[4])?1:+t[4];let o,a,l;if(0===s)o=a=l=r;else{const e=r<.5?r*(1+s):r+s-r*s,t=2*r-e;o=ue(255*Be(t,e,n+1/3),0),a=ue(255*Be(t,e,n),0),l=ue(255*Be(t,e,n-1/3),0)}return[o,a,l,i]})(s):[0,0,0,1],t;{const e=n.match(M);return t.t=3,t.d=e?e.map(Number):[],t.s=n.split(M)||[],t}}var s;return t.n=n,t},We=(e,t)=>(t.t=e._valueType,t.n=e._toNumber,t.u=e._unit,t.o=null,t.d=fe(e._toNumbers),t.s=fe(e._strings),t),Ye={t:0,n:0,u:null,o:null,d:null,s:null},Xe={_rep:new WeakMap,_add:new Map},Je=(e,t,n="_rep")=>{const s=Xe[n];let r=s.get(e);return r||(r={},s.set(e,r)),r[t]?r[t]:r[t]={_head:null,_tail:null}},Ke=(e,t)=>e._isOverridden||e._absoluteStartTime>t._absoluteStartTime,Ze=e=>{e._isOverlapped=1,e._isOverridden=1,e._changeDuration=p,e._currentTime=p},Qe=(e,t)=>{const n=e._composition;if(n===o.replace){const n=e._absoluteStartTime;ve(t,e,Ke,"_prevRep","_nextRep");const s=e._prevRep;if(s){const t=s.parent,r=s._absoluteStartTime+s._changeDuration;if(e.parent.id!==t.id&&t.iterationCount>1&&r+(t.duration-t.iterationDuration)>n){Ze(s);let e=s._prevRep;for(;e&&e.parent.id===t.id;)Ze(e),e=e._prevRep}const i=n-e._delay;if(r>i){const e=s._startTime,t=r-(e+s._updateDuration);s._changeDuration=i-t-e,s._currentTime=s._changeDuration,s._isOverlapped=1,s._changeDuration<p&&Ze(s)}let o=!0;if(be(t,(e=>{e._isOverlapped||(o=!1)})),o){const e=t.parent;if(e){let n=!0;be(e,(e=>{e!==t&&be(e,(e=>{e._isOverlapped||(n=!1)}))})),n&&e.cancel()}else t.cancel()}}}else if(n===o.blend){const t=Je(e.target,e.property,"_add"),n=(e=>{let t=$e.animation;return t||(t={duration:p,computeDeltaTime:v,_offset:0,_delay:0,_head:null,_tail:null},$e.animation=t,$e.update=()=>{e.forEach((e=>{for(let t in e){const n=e[t],s=n._head;if(s){const e=s._valueType,t=3===e||2===e?fe(s._fromNumbers):null;let r=s._fromNumber,i=n._tail;for(;i&&i!==s;){if(t)for(let e=0,n=i._numbers.length;e<n;e++)t[e]+=i._numbers[e];else r+=i._number;i=i._prevAdd}s._toNumber=r,s._toNumbers=t}}})),Se(t,1,1,0,2)}),t})(Xe._add);let s=t._head;s||(s={...e},s._composition=o.replace,s._updateDuration=p,s._startTime=0,s._numbers=fe(e._fromNumbers),s._number=0,s._next=null,s._prev=null,ve(t,s),ve(n,s));const r=e._toNumber;if(e._fromNumber=s._fromNumber-r,e._toNumber=0,e._numbers=fe(e._fromNumbers),e._number=0,s._fromNumber=r,e._toNumbers){const t=fe(e._toNumbers);t&&t.forEach(((t,n)=>{e._fromNumbers[n]=s._fromNumbers[n]-t,e._toNumbers[n]=0})),s._fromNumbers=t}ve(t,e,null,"_prevAdd","_nextAdd")}return e},et=e=>{const t=e._composition;if(t!==o.none){const n=e.target,s=e.property,r=Xe._rep.get(n)[s];if(_e(r,e,"_prevRep","_nextRep"),t===o.blend){const t=Xe._add,r=t.get(n);if(!r)return;const i=r[s],o=$e.animation;_e(i,e,"_prevAdd","_nextAdd");const a=i._head;if(a&&a===i._tail){_e(i,a,"_prevAdd","_nextAdd"),_e(o,a);let e=!0;for(let t in r)if(r[t]._head){e=!1;break}e&&t.delete(n)}}}return e},tt=e=>(e.paused=!0,e.began=!1,e.completed=!1,e),nt=e=>e._cancelled?(e._hasChildren?be(e,nt):be(e,(e=>{e._composition!==o.none&&Qe(e,Je(e.target,e.property))})),e._cancelled=0,e):e;let st=0;class rt extends we{constructor(e={},t=null,n=0){super(0);const{id:s,delay:r,duration:i,reversed:o,alternate:a,loop:l,loopDelay:c,autoplay:d,frameRate:u,playbackRate:h,onComplete:g,onLoop:m,onPause:f,onBegin:y,onBeforeUpdate:b,onUpdate:_}=e;R.scope&&R.scope.revertibles.push(this);const w=t?0:ke._elapsedTime,S=t?t.defaults:R.defaults,x=j(r)||H(r)?S.delay:+r,$=j(i)||H(i)?1/0:+i,C=Ie(l,S.loop),M=Ie(c,S.loopDelay),A=!0===C||C===1/0||C<0?1/0:C+1;let k=0;if(t)k=n;else{let e=P();ke.paused&&(ke.requestTick(e),e=ke._elapsedTime),k=e-ke._startTime}this.id=H(s)?++st:s,this.parent=t,this.duration=ge(($+M)*A-M)||p,this.backwards=!1,this.paused=!0,this.began=!1,this.completed=!1,this.onBegin=y||S.onBegin,this.onBeforeUpdate=b||S.onBeforeUpdate,this.onUpdate=_||S.onUpdate,this.onLoop=m||S.onLoop,this.onPause=f||S.onPause,this.onComplete=g||S.onComplete,this.iterationDuration=$,this.iterationCount=A,this._autoplay=!t&&Ie(d,S.autoplay),this._offset=k,this._delay=x,this._loopDelay=M,this._iterationTime=0,this._currentIteration=0,this._resolve=v,this._running=!1,this._reversed=+Ie(o,S.reversed),this._reverse=this._reversed,this._cancelled=0,this._alternate=Ie(a,S.alternate),this._prev=null,this._next=null,this._elapsedTime=w,this._startTime=w,this._lastTime=w,this._fps=Ie(u,S.frameRate),this._speed=Ie(h,S.playbackRate)}get cancelled(){return!!this._cancelled}set cancelled(e){e?this.cancel():this.reset(1).play()}get currentTime(){return ce(ue(this._currentTime,R.precision),-this._delay,this.duration)}set currentTime(e){const t=this.paused;this.pause().seek(+e),t||this.resume()}get iterationCurrentTime(){return ue(this._iterationTime,R.precision)}set iterationCurrentTime(e){this.currentTime=this.iterationDuration*this._currentIteration+e}get progress(){return ce(ue(this._currentTime/this.duration,5),0,1)}set progress(e){this.currentTime=this.duration*e}get iterationProgress(){return ce(ue(this._iterationTime/this.iterationDuration,5),0,1)}set iterationProgress(e){const t=this.iterationDuration;this.currentTime=t*this._currentIteration+t*e}get currentIteration(){return this._currentIteration}set currentIteration(e){this.currentTime=this.iterationDuration*ce(+e,0,this.iterationCount-1)}get reversed(){return!!this._reversed}set reversed(e){e?this.reverse():this.play()}get speed(){return super.speed}set speed(e){super.speed=e,this.resetTime()}reset(e=0){return nt(this),this._reversed&&!this._reverse&&(this.reversed=!1),this._iterationTime=this.iterationDuration,xe(this,0,1,e,2),tt(this),this._hasChildren&&be(this,tt),this}init(e=0){this.fps=this._fps,this.speed=this._speed,!e&&this._hasChildren&&xe(this,this.duration,1,e,2),this.reset(e);const t=this._autoplay;return!0===t?this.resume():t&&!H(t.linked)&&t.link(this),this}resetTime(){const e=1/(this._speed*ke._speed);return this._startTime=P()-(this._currentTime+this._delay)*e,this}pause(){return this.paused||(this.paused=!0,this.onPause(this)),this}resume(){return this.paused?(this.paused=!1,this.duration<=p&&!this._hasChildren?xe(this,p,0,0,2):(this._running||(ve(ke,this),ke._hasChildren=!0,this._running=!0),this.resetTime(),this._startTime-=12,ke.wake()),this):this}restart(){return this.reset(0).resume()}seek(e,t=0,n=0){nt(this),this.completed=!1;const s=this.paused;return this.paused=!0,xe(this,e+this._delay,~~t,~~n,1),s?this:this.resume()}alternate(){const e=this._reversed,t=this.iterationCount,n=this.iterationDuration,s=t===1/0?se(g/n):t;return this._reversed=+(!this._alternate||s%2?!e:e),t===1/0?this.iterationProgress=this._reversed?1-this.iterationProgress:this.iterationProgress:this.seek(n*s-this._currentTime),this.resetTime(),this}play(){return this._reversed&&this.alternate(),this.resume()}reverse(){return this._reversed||this.alternate(),this.resume()}cancel(){return this._hasChildren?be(this,(e=>e.cancel()),!0):be(this,et),this._cancelled=1,this.pause()}stretch(e){const t=this.duration,n=me(e);if(t===n)return this;const s=e/t,r=e<=p;return this.duration=r?p:n,this.iterationDuration=r?p:me(this.iterationDuration*s),this._offset*=s,this._delay*=s,this._loopDelay*=s,this}revert(){xe(this,0,1,0,1);const e=this._autoplay;return e&&e.linked&&e.linked===this&&e.revert(),this.cancel()}complete(){return this.seek(this.duration).cancel()}then(e=v){const t=this.then,n=()=>{this.then=null,e(this),this.then=t,this._resolve=v};return new Promise((e=>(this._resolve=()=>e(n()),this.completed&&this._resolve(),this)))}}const it=e=>new rt(e,null,0).init(),ot=e=>e,at=(e,t,n)=>(((1-3*n+3*t)*e+(3*n-6*t))*e+3*t)*e,lt=(e=.5,t=0,n=.5,s=1)=>e===t&&n===s?ot:r=>0===r||1===r?r:at(((e,t,n)=>{let s,r,i=0,o=1,a=0;do{r=i+(o-i)/2,s=at(r,t,n)-e,s>0?o=r:i=r}while(ee(s)>1e-7&&++a<100);return r})(r,e,n),t,s),ct=(e=10,t)=>{const n=t?ne:se;return t=>n(ce(t,0,1)*e)*(1/e)},dt=(...e)=>{const t=e.length;if(!t)return ot;const n=t-1,s=e[0],r=e[n],i=[0],o=[X(s)];for(let t=1;t<n;t++){const s=e[t],r=I(s)?s.trim().split(" "):[s],a=r[0],l=r[1];i.push(H(l)?t/n:X(l)/100),o.push(X(a))}return o.push(X(r)),i.push(1),function(e){for(let t=1,n=i.length;t<n;t++){const n=i[t];if(e<=n){const s=i[t-1],r=o[t-1];return r+(o[t]-r)*(e-s)/(n-s)}}return o[o.length-1]}},ut=(e=10,t=1)=>{const n=[0],s=e-1;for(let e=1;e<s;e++){const r=n[e-1],i=e/s,o=i*(1-t)+(i+((e+1)/s-i)*Math.random())*t;n.push(ce(o,r,1))}return n.push(1),dt(...n)},ht=ae/2,pt=2*ae,gt=(e=1.68)=>t=>J(t,+e),mt={[f]:gt,Quad:gt(2),Cubic:gt(3),Quart:gt(4),Quint:gt(5),Sine:e=>1-Q(e*ht),Circ:e=>1-K(1-e*e),Expo:e=>e?J(2,10*e-10):0,Bounce:e=>{let t,n=4;for(;e<((t=J(2,--n))-1)/11;);return 1/J(4,3-n)-7.5625*J((3*t-2)/22-e,2)},Back:(e=1.70158)=>t=>(+e+1)*t*t*t-+e*t*t,Elastic:(e=1,t=.3)=>{const n=ce(+e,1,10),s=ce(+t,p,2),r=s/pt*re(1/n),i=pt/s;return e=>0===e||1===e?e:-n*J(2,-10*(1-e))*Z((1-e-r)*i)}},ft={in:e=>t=>e(t),out:e=>t=>1-e(1-t),inOut:e=>t=>t<.5?e(2*t)/2:1-e(-2*t+2)/2,outIn:e=>t=>t<.5?(1-e(1-2*t))/2:(e(2*t-1)+1)/2},yt=(e,t,n)=>{if(n[e])return n[e];if(e.indexOf("(")<=-1){const s=ft[e]||e.includes("Back")||e.includes("Elastic")?t[e]():t[e];return s?n[e]=s:ot}{const s=e.slice(0,-1).split("("),r=t[s[0]];return r?n[e]=r(...s[1].split(",")):ot}},bt=(()=>{const e={linear:dt,irregular:ut,steps:ct,cubicBezier:lt};for(let t in ft)for(let n in mt){const s=mt[n],r=ft[t];e[t+n]=n===f||"Back"===n||"Elastic"===n?(e,t)=>r(s(e,t)):r(s)}return e})(),_t={linear:ot},vt=e=>j(e)?e:I(e)?yt(e,bt,_t):ot,wt={},St=(e,t,n)=>{if(3===n){return y.get(e)||e}if(2===n||1===n&&G(t)&&e in t.style){const t=wt[e];if(t)return t;{const t=e?F(e):e;return wt[e]=t,t}}return e},xt={deg:1,rad:180/ae,turn:360},$t={},Ct=(e,t,n,s=!1)=>{const r=t.u,o=t.n;if(1===t.t&&r===n)return t;const a=o+r+n,l=$t[a];if(H(l)||s){let s;if(r in xt)s=o*xt[r]/xt[n];else{const t=100,a=e.cloneNode(),l=e.parentNode,c=l&&l!==i?l:i.body;c.appendChild(a);const d=a.style;d.width=t+r;const u=a.offsetWidth||t;d.width=t+n;const h=u/(a.offsetWidth||t);c.removeChild(a),s=h*o}t.n=s,$t[a]=s}else t.n=l;return t.t,t.u=n,t},Mt=e=>{if(e._hasChildren)be(e,Mt,!0);else{const t=e;t.pause(),be(t,(e=>{const n=e.property,s=e.target;if(s[l]){const r=s.style,i=t._inlineStyles[n];if(3===e._tweenType){const t=s[d];if(H(i)||i===f?delete t[n]:t[n]=i,e._renderTransforms)if(Object.keys(t).length){let e=f;for(let n in t)e+=_[n]+t[n]+") ";r.transform=e}else r.removeProperty("transform")}else H(i)||i===f?r.removeProperty(n):r[n]=i;t._tail===e&&t.targets.forEach((e=>{e.getAttribute&&e.getAttribute("style")===f&&e.removeAttribute("style")}))}}))}return e},At={t:0,n:0,u:null,o:null,d:null,s:null},kt={t:0,n:0,u:null,o:null,d:null,s:null},Dt={func:null},Et=[null],Tt=[null,null],Rt={to:null};let Ot,Ft,Nt=0;class Pt extends rt{constructor(e,t,n,s,r=!1,i=0,a=0){super(t,n,s);const l=Oe(e),c=l.length,d=t.keyframes,u=d?ye(((e,t)=>{const n={};if(L(e)){const t=[].concat(...e.map((e=>Object.keys(e)))).filter(Y);for(let s=0,r=t.length;s<r;s++){const r=t[s],i=e.map((e=>{const t={};for(let n in e){const s=e[n];Y(n)?n===r&&(t.to=s):t[n]=s}return t}));n[r]=i}}else{const s=Ie(t.duration,R.defaults.duration),r=Object.keys(e).map((t=>({o:parseFloat(t)/100,p:e[t]}))).sort(((e,t)=>e.o-t.o));r.forEach((e=>{const t=e.o,r=e.p;for(let e in r)if(Y(e)){let i=n[e];i||(i=n[e]=[]);const o=t*s;let a=i.length,l=i[a-1];const c={to:r[e]};let d=0;for(let e=0;e<a;e++)d+=i[e].duration;1===a&&(c.from=l.to),r.ease&&(c.ease=r.ease),c.duration=o-(a?d:0),i.push(c)}return e}));for(let e in n){const t=n[e];let s;for(let e=0,n=t.length;e<n;e++){const n=t[e],r=n.ease;n.ease=s||void 0,s=r}t[0].duration||t.shift()}}return n})(d,t),t):t,{delay:h,duration:g,ease:f,playbackEase:y,modifier:b,composition:_,onRender:v}=u,w=n?n.defaults:R.defaults,S=Ie(y,w.playbackEase),x=S?vt(S):null,$=!H(f)&&!H(f.ease),C=$?f.ease:Ie(f,x?"linear":w.ease),M=$?f.duration:Ie(g,w.duration),A=Ie(h,w.delay),k=b||w.modifier,D=H(_)&&c>=m?o.none:H(_)?w.composition:_,E={},T=this._offset+(n?n._offset:0);let O=NaN,F=NaN,N=0,P=0;for(let e=0;e<c;e++){const t=l[e],s=i||e,d=a||c;let h=NaN,g=NaN;for(let e in u)if(Y(e)){const i=He(t,e),a=St(e,t,i);let l=u[e];const c=L(l);if(r&&!c&&(Tt[0]=l,Tt[1]=l,l=Tt),c){const e=l.length,t=!z(l[0]);2===e&&t?(Rt.to=l,Et[0]=Rt,Ot=Et):e>2&&t?(Ot=[],l.forEach(((e,t)=>{t?1===t?(Tt[1]=e,Ot.push(Tt)):Ot.push(e):Tt[0]=e}))):Ot=l}else Et[0]=l,Ot=Et;let m=null,f=null,y=NaN,b=0,_=0;for(let e=Ot.length;_<e;_++){const r=Ot[_];z(r)?Ft=r:(Rt.to=r,Ft=Rt),Dt.func=null;const l=je(Ft.to,t,s,d,Dt);let c;z(l)&&!H(l.to)?(Ft=l,c=l.to):c=l;const u=je(Ft.from,t,s,d),h=Ft.ease,g=!H(h)&&!H(h.ease),v=g?h.ease:h||C,w=g?h.duration:je(Ie(Ft.duration,e>1?je(M,t,s,d)/e:M),t,s,d),S=je(Ie(Ft.delay,_?0:A),t,s,d),x=je(Ie(Ft.composition,D),t,s,d),$=B(x)?x:o[x],R=Ft.modifier||k,O=!H(u),F=!H(c),I=L(c),j=I||O&&F,U=f?b+S:S,G=T+U;P||!O&&!I||(P=1);let q=f;if($!==o.none){m||(m=Je(t,a));let e=m._head;for(;e&&!e._isOverridden&&e._absoluteStartTime<=G;)if(q=e,e=e._nextRep,e&&e._absoluteStartTime>=G)for(;e;)Ze(e),e=e._nextRep}if(j?(Ve(I?je(c[0],t,s,d):u,At),Ve(I?je(c[1],t,s,d,Dt):c,kt),0===At.t&&(q?1===q._valueType&&(At.t=1,At.u=q._unit):(Ve(Ge(t,a,i,E),Ye),1===Ye.t&&(At.t=1,At.u=Ye.u)))):(F?Ve(c,kt):f?We(f,kt):Ve(n&&q&&q.parent.parent===n?q._value:Ge(t,a,i,E),kt),O?Ve(u,At):f?We(f,At):Ve(n&&q&&q.parent.parent===n?q._value:Ge(t,a,i,E),At)),At.o&&(At.n=qe(q?q._toNumber:Ve(Ge(t,a,i,E),Ye).n,At.n,At.o)),kt.o&&(kt.n=qe(At.n,kt.n,kt.o)),At.t!==kt.t)if(3===At.t||3===kt.t){const e=3===At.t?At:kt,t=3===At.t?kt:At;t.t=3,t.s=fe(e.s),t.d=e.d.map((()=>t.n))}else if(1===At.t||1===kt.t){const e=1===At.t?At:kt,t=1===At.t?kt:At;t.t=1,t.u=e.u}else if(2===At.t||2===kt.t){const e=2===At.t?At:kt,t=2===At.t?kt:At;t.t=2,t.s=e.s,t.d=[0,0,0,1]}if(At.u!==kt.u){let e=kt.u?At:kt;e=Ct(t,e,kt.u?kt.u:At.u,!1)}if(kt.d&&At.d&&kt.d.length!==At.d.length){const e=At.d.length>kt.d.length?At:kt,t=e===At?kt:At;t.d=e.d.map(((e,n)=>H(t.d[n])?0:t.d[n])),t.s=fe(e.s)}const V=ue(+w||p,12),W={parent:this,id:Nt++,property:a,target:t,_value:null,_func:Dt.func,_ease:vt(v),_fromNumbers:fe(At.d),_toNumbers:fe(kt.d),_strings:fe(kt.s),_fromNumber:At.n,_toNumber:kt.n,_numbers:fe(At.d),_number:At.n,_unit:kt.u,_modifier:R,_currentTime:0,_startTime:U,_delay:+S,_updateDuration:V,_changeDuration:V,_absoluteStartTime:G,_tweenType:i,_valueType:kt.t,_composition:$,_isOverlapped:0,_isOverridden:0,_renderTransforms:0,_prevRep:null,_nextRep:null,_prevAdd:null,_nextAdd:null,_prev:null,_next:null};$!==o.none&&Qe(W,m),isNaN(y)&&(y=W._startTime),b=ue(U+V,12),f=W,N++,ve(this,W)}(isNaN(F)||y<F)&&(F=y),(isNaN(O)||b>O)&&(O=b),3===i&&(h=N-_,g=N)}if(!isNaN(h)){let e=0;be(this,(t=>{e>=h&&e<g&&(t._renderTransforms=1,t._composition===o.blend&&be($e.animation,(e=>{e.id===t.id&&(e._renderTransforms=1)}))),e++}))}}c||console.warn("No target found. Make sure the element you're trying to animate is accessible before creating your animation."),F?(be(this,(e=>{e._startTime-e._delay||(e._delay-=F),e._startTime-=F})),O-=F):F=0,O||(O=p,this.iterationCount=0),this.targets=l,this.duration=O===p?p:ge((O+this._loopDelay)*this.iterationCount-this._loopDelay)||p,this.onRender=v||w.onRender,this._ease=x,this._delay=F,this.iterationDuration=O,this._inlineStyles=E,!this._autoplay&&P&&this.onRender(this)}stretch(e){const t=this.duration;if(t===me(e))return this;const n=e/t;return be(this,(e=>{e._updateDuration=me(e._updateDuration*n),e._changeDuration=me(e._changeDuration*n),e._currentTime*=n,e._startTime*=n,e._absoluteStartTime*=n})),super.stretch(e)}refresh(){return be(this,(e=>{const t=Ge(e.target,e.property,e._tweenType);Ve(t,Ye),e._fromNumbers=fe(Ye.d),e._fromNumber=Ye.n,e._func&&(Ve(e._func(),kt),e._toNumbers=fe(kt.d),e._strings=fe(kt.s),e._toNumber=kt.n)})),this}revert(){return super.revert(),Mt(this)}then(e){return super.then(e)}}const Lt=(e,t)=>new Pt(e,t,null,0,!1).init(),zt=(e,t=100)=>{const n=[];for(let s=0;s<=t;s++)n.push(e(s/t));return`linear(${n.join(", ")})`},Bt={in:"ease-in",out:"ease-out",inOut:"ease-in-out"},It=(()=>{const e={};for(let t in ft)e[t]=e=>ft[t](gt(e));return e})(),jt=e=>{let t=Bt[e];if(t)return t;if(t="linear",I(e)){if(N(e,"linear")||N(e,"cubic-")||N(e,"steps")||N(e,"ease"))t=e;else if(N(e,"cubicB"))t=F(e);else{const n=yt(e,It,Bt);j(n)&&(t=n===ot?"linear":zt(n))}Bt[e]=t}else if(j(e)){const n=zt(e);n&&(t=n)}else e.ease&&(t=zt(e.ease));return t},Ht=["x","y","z"],Ut=["perspective","width","height","margin","padding","top","right","bottom","left","borderWidth","fontSize","borderRadius",...Ht],Gt=[...Ht,...b.filter((e=>["X","Y","Z"].some((t=>e.endsWith(t)))))];let qt=s&&(H(CSS)||!Object.hasOwnProperty.call(CSS,"registerProperty"));const Vt={_head:null,_tail:null},Wt=(e,t,n)=>{let s=Vt._head;for(;s;){const r=s._next,i=s.$el===e,o=!t||s.property===t,a=!n||s.parent===n;if(i&&o&&a){const e=s.animation;try{e.commitStyles()}catch{}e.cancel(),_e(Vt,s);const t=s.parent;t&&(t._completed++,t.animations.length===t._completed&&(t.completed=!0,t.muteCallbacks||(t.paused=!0,t.onComplete(t),t._resolve(t))))}s=r}},Yt=(e,t,n,s,r)=>{const i=t.animate(s,r),o=r.delay+ +r.duration*r.iterations;i.playbackRate=e._speed,e.paused&&i.pause(),e.duration<o&&(e.duration=o,e.controlAnimation=i),e.animations.push(i),Wt(t,n),ve(Vt,{parent:e,animation:i,$el:t,property:n,_next:null,_prev:null});const a=()=>{Wt(t,n,e)};return i.onremove=a,i.onfinish=a,i},Xt=(e,t,n,s,r)=>{let i=je(t,n,s,r);return B(i)?Ut.includes(e)||N(e,"translate")?`${i}px`:N(e,"rotate")||N(e,"skew")?`${i}deg`:`${i}`:i},Jt=(e,t,n,s,r,i)=>{let o="0";const a=H(s)?getComputedStyle(e)[t]:Xt(t,s,e,r,i);return o=H(n)?L(s)?s.map((n=>Xt(t,n,e,r,i))):a:[Xt(t,n,e,r,i),a],o};class Kt{constructor(e,t){R.scope&&R.scope.revertibles.push(this),qt||(b.forEach((e=>{const t=N(e,"skew"),n=N(e,"scale"),s=N(e,"rotate"),r=N(e,"translate"),i=s||t,o=i?"<angle>":n?"<number>":r?"<length-percentage>":"*";try{CSS.registerProperty({name:"--"+e,syntax:o,inherits:!1,initialValue:r?"0px":i?"0deg":n?"1":"0"})}catch{}})),qt=!0);const n=Oe(e),s=n.length;s||console.warn("No target found. Make sure the element you're trying to animate is accessible before creating your animation.");const r=Ie(t.ease,jt(R.defaults.ease)),i=r.ease&&r,o=Ie(t.autoplay,R.defaults.autoplay),a=!(!o||!o.link)&&o,l=t.alternate&&!0===t.alternate,c=t.reversed&&!0===t.reversed,u=Ie(t.loop,R.defaults.loop),h=!0===u||u===1/0?1/0:B(u)?u+1:1,p=l?c?"alternate-reverse":"alternate":c?"reverse":"normal",g=jt(r),w=1===R.timeScale?1:m;this.targets=n,this.animations=[],this.controlAnimation=null,this.onComplete=t.onComplete||v,this.duration=0,this.muteCallbacks=!1,this.completed=!1,this.paused=!o||!1!==a,this.reversed=c,this.autoplay=o,this._speed=Ie(t.playbackRate,R.defaults.playbackRate),this._resolve=v,this._completed=0,this._inlineStyles=n.map((e=>e.getAttribute("style"))),n.forEach(((e,n)=>{const o=e[d],a=Gt.some((e=>t.hasOwnProperty(e))),l=(i?i.duration:je(Ie(t.duration,R.defaults.duration),e,n,s))*w,c=je(Ie(t.delay,R.defaults.delay),e,n,s)*w,u=Ie(t.composition,"replace");for(let i in t){if(!Y(i))continue;const d={},m={iterations:h,direction:p,fill:"forwards",easing:g,duration:l,delay:c,composite:u},f=t[i],_=!!a&&(b.includes(i)?i:y.get(i));let v;if(z(f)){const t=f,a=Ie(t.ease,r),h=a.ease&&a,p=t.to,g=t.from;if(m.duration=(h?h.duration:je(Ie(t.duration,l),e,n,s))*w,m.delay=je(Ie(t.delay,c),e,n,s)*w,m.composite=Ie(t.composition,u),m.easing=jt(a),v=Jt(e,i,g,p,n,s),_?(d[`--${_}`]=v,o[_]=v):d[i]=Jt(e,i,g,p,n,s),Yt(this,e,i,d,m),!H(g))if(_){const t=`--${_}`;e.style.setProperty(t,d[t][0])}else e.style[i]=d[i][0]}else v=L(f)?f.map((t=>Xt(i,t,e,n,s))):Xt(i,f,e,n,s),_?(d[`--${_}`]=v,o[_]=v):d[i]=v,Yt(this,e,i,d,m)}if(a){let t=f;for(let e in o)t+=`${_[e]}var(--${e})) `;e.style.transform=t}})),a&&this.autoplay.link(this)}forEach(e){const t=I(e)?t=>t[e]():e;return this.animations.forEach(t),this}get speed(){return this._speed}set speed(e){this._speed=+e,this.forEach((t=>t.playbackRate=e))}get currentTime(){const e=this.controlAnimation,t=R.timeScale;return this.completed?this.duration:e?+e.currentTime*(1===t?1:t):0}set currentTime(e){const t=e*(1===R.timeScale?1:m);this.forEach((e=>{t>=this.duration&&e.play(),e.currentTime=t}))}get progress(){return this.currentTime/this.duration}set progress(e){this.forEach((t=>t.currentTime=e*this.duration||0))}resume(){return this.paused?(this.paused=!1,this.forEach("play")):this}pause(){return this.paused?this:(this.paused=!0,this.forEach("pause"))}alternate(){return this.reversed=!this.reversed,this.forEach("reverse"),this.paused&&this.forEach("pause"),this}play(){return this.reversed&&this.alternate(),this.resume()}reverse(){return this.reversed||this.alternate(),this.resume()}seek(e,t=!1){return t&&(this.muteCallbacks=!0),e<this.duration&&(this.completed=!1),this.currentTime=e,this.muteCallbacks=!1,this.paused&&this.pause(),this}restart(){return this.completed=!1,this.seek(0,!0).resume()}commitStyles(){return this.forEach("commitStyles")}complete(){return this.seek(this.duration)}cancel(){return this.forEach("cancel"),this.pause()}revert(){return this.cancel(),this.targets.forEach(((e,t)=>e.setAttribute("style",this._inlineStyles[t]))),this}then(e=v){const t=this.then,n=()=>{this.then=null,e(this),this.then=t,this._resolve=v};return new Promise((e=>(this._resolve=()=>e(n()),this.completed&&this._resolve(),this)))}}const Zt={animate:(e,t)=>new Kt(e,t),convertEase:zt},Qt=(e=v)=>new rt({duration:1*R.timeScale,onComplete:e},null,0).resume();function en(e,t,n){const s=Oe(e);if(!s.length)return;const[r]=s,i=He(r,t),o=St(t,r,i);let a=Ge(r,o);if(H(n))return a;if(Ve(a,Ye),0===Ye.t||1===Ye.t){if(!1===n)return Ye.n;{const e=Ct(r,Ye,n,!1);return`${ue(e.n,R.precision)}${e.u}`}}}const tn=(e,t)=>{if(!H(t))return t.duration=p,t.composition=Ie(t.composition,o.none),new Pt(e,t,null,0,!0).resume()},nn=(e,t,n)=>{let s=!1;return be(t,(r=>{const i=r.target;if(e.includes(i)){const e=r.property,o=r._tweenType,a=St(n,i,o);(!a||a&&a===e)&&(r.parent._tail===r&&3===r._tweenType&&r._prev&&3===r._prev._tweenType&&(r._prev._renderTransforms=1),_e(t,r),et(r),s=!0)}}),!0),s},sn=(e,t,n)=>{const s=Re(e),r=t||ke,i=t&&t.controlAnimation&&t;for(let e=0,t=s.length;e<t;e++){const t=s[e];Wt(t,n,i)}let o;if(r._hasChildren){let t=0;be(r,(i=>{if(!i._hasChildren)if(o=nn(s,i,n),o&&!i._head)i.cancel(),_e(r,i);else{const e=i._offset+i._delay+i.duration;e>t&&(t=e)}i._head?sn(e,i,n):i._hasChildren=!1}),!0),H(r.iterationDuration)||(r.iterationDuration=t)}else o=nn(s,r,n);return o&&!r._head&&(r._hasChildren=!1,r.cancel&&r.cancel()),s},rn=(e,t,n)=>{const s=10**(n||0);return se((Math.random()*(t-e+1/s)+e)*s)/s},on=(e,t,n,s,r)=>s+(e-t)/(n-t)*(r-s),an=(e,t,n,s)=>{let r=m/R.defaults.frameRate;if(!1!==s){const e=s||ke._hasChildren&&ke;e&&e.deltaTime&&(r=e.deltaTime)}const i=1-Math.exp(-n*r*.1);return n?1===n?t:(1-i)*e+i*t:e},ln=e=>(...t)=>{const n=e(...t);return new Proxy(v,{apply:(e,t,[s])=>n(s),get:(e,t)=>ln(((...e)=>{const s=dn[t](...e);return e=>s(n(e))}))})},cn=(e,t=0)=>(...n)=>(n.length<e.length?ln(((e,t=0)=>(...n)=>t?t=>e(...n,t):t=>e(t,...n))(e,t)):e)(...n),dn={$:Oe,get:en,set:tn,remove:sn,cleanInlineStyles:Mt,random:rn,randomPick:e=>e[rn(0,e.length-1)],shuffle:e=>{let t,n,s=e.length;for(;s;)n=rn(0,--s),t=e[s],e[s]=e[n],e[n]=t;return e},lerp:an,sync:Qt,clamp:cn(ce),round:cn(ue),snap:cn(he),wrap:cn(((e,t,n)=>((e-t)%(n-t)+(n-t))%(n-t)+t)),interpolate:cn(pe,1),mapRange:cn(on),roundPad:cn(((e,t)=>(+e).toFixed(t))),padStart:cn(((e,t,n)=>`${e}`.padStart(t,n))),padEnd:cn(((e,t,n)=>`${e}`.padEnd(t,n))),degToRad:cn((e=>e*ae/180)),radToDeg:cn((e=>180*e/ae))},un=(e,t)=>{let n=e.iterationDuration;if(n===p&&(n=0),H(t))return n;if(B(+t))return+t;const s=t,r=e?e.labels:null,i=!U(r),o=((e,t)=>{if(N(t,"<")){const n="<"===t[1],s=e._tail,r=s?s._offset+s._delay:0;return n?r:r+s.duration}})(e,s),a=!H(o),l=E.exec(s);if(l){const e=l[0],t=s.split(e),c=i&&t[0]?r[t[0]]:n,d=a?o:i?c:n,u=+t[1];return qe(d,u,e[0])}return a?o:i?H(r[s])?n:r[s]:n};function hn(e,t,n,s,r,i){const o=B(e.duration)&&e.duration<=p?n-p:n;xe(t,o,1,1,1);const a=s?new Pt(s,e,t,o,!1,r,i):new rt(e,t,o);return a.init(1),ve(t,a),be(t,(e=>{const n=e._offset+e._delay+e.duration;n>t.iterationDuration&&(t.iterationDuration=n)})),t.duration=function(e){return ge((e.iterationDuration+e._loopDelay)*e.iterationCount-e._loopDelay)||p}(t),t}class pn extends rt{constructor(e={}){super(e,null,0),this.duration=0,this.labels={};const t=e.defaults,n=R.defaults;this.defaults=t?ye(t,n):n,this.onRender=e.onRender||n.onRender;const s=Ie(e.playbackEase,n.playbackEase);this._ease=s?vt(s):null,this.iterationDuration=0}add(e,t,n){const s=z(t),r=z(e);if(s||r){if(this._hasChildren=!0,s){const s=t;if(j(n)){const t=n,r=Re(e),i=this.duration,o=this.iterationDuration,a=s.id;let l=0;const c=r.length;r.forEach((e=>{const n={...s};this.duration=i,this.iterationDuration=o,H(a)||(n.id=a+"-"+l),hn(n,this,t(e,l,c,this),e,l,c),l++}))}else hn(s,this,un(this,n),e)}else hn(e,this,un(this,t));return this.init(1)}}sync(e,t){if(H(e)||e&&H(e.pause))return this;e.pause();const n=+(e.effect?e.effect.getTiming().duration:e.duration);return this.add(e,{currentTime:[0,n],duration:n,ease:"linear"},t)}set(e,t,n){return H(t)?this:(t.duration=p,t.composition=o.replace,this.add(e,t,n))}call(e,t){return H(e)||e&&!j(e)?this:this.add({duration:0,onComplete:()=>e(this)},t)}label(e,t){return H(e)||e&&!I(e)||(this.labels[e]=un(this,t)),this}remove(e,t){return sn(e,this,t),this}stretch(e){const t=this.duration;if(t===me(e))return this;const n=e/t,s=this.labels;be(this,(e=>e.stretch(e.duration*n)));for(let e in s)s[e]*=n;return super.stretch(e)}refresh(){return be(this,(e=>{e.refresh&&e.refresh()})),this}revert(){return super.revert(),be(this,(e=>e.revert),!0),Mt(this)}then(e){return super.then(e)}}const gn=e=>new pn(e).init();class mn{constructor(e,t){R.scope&&R.scope.revertibles.push(this);const n={},s={};if(this.targets=[],this.animations={},!H(e)&&!H(t)){for(let e in t){const r=t[e];Y(e)?s[e]=r:n[e]=r}for(let t in s){const r=s[t],i=z(r);let a={},l="+=0";if(i){const e=r.unit;I(e)&&(l+=e)}else a.duration=r;a[t]=i?ye({to:l},r):l;const c=ye(n,a);c.composition=o.replace,c.autoplay=!1;const d=this.animations[t]=new Pt(e,c,null,0,!1).init();this.targets.length||this.targets.push(...d.targets),this[t]=(e,t,n)=>{const s=d._head;if(H(e)&&s){const e=s._numbers;return e&&e.length?e:s._modifier(s._number)}return be(d,(t=>{if(L(e))for(let n=0,s=e.length;n<s;n++)H(t._numbers[n])||(t._fromNumbers[n]=t._modifier(t._numbers[n]),t._toNumbers[n]=e[n]);else t._fromNumber=t._modifier(t._number),t._toNumber=e;H(n)||(t._ease=vt(n)),t._currentTime=0})),H(t)||d.stretch(t),d.reset(1).resume(),this}}}}revert(){for(let e in this.animations)this[e]=v,this.animations[e].revert();return this.animations={},this.targets.length=0,this}}const fn=(e,t)=>new mn(e,t);class yn{constructor(e={}){this.timeStep=.02,this.restThreshold=5e-4,this.restDuration=200,this.maxDuration=6e4,this.maxRestSteps=this.restDuration/this.timeStep/m,this.maxIterations=this.maxDuration/this.timeStep/m,this.m=ce(Ie(e.mass,1),0,m),this.s=ce(Ie(e.stiffness,100),1,m),this.d=ce(Ie(e.damping,10),.1,m),this.v=ce(Ie(e.velocity,0),-1e3,m),this.w0=0,this.zeta=0,this.wd=0,this.b=0,this.solverDuration=0,this.duration=0,this.compute(),this.ease=e=>0===e||1===e?e:this.solve(e*this.solverDuration)}solve(e){const{zeta:t,w0:n,wd:s,b:r}=this;let i=e;return i=t<1?te(-i*t*n)*(1*Q(s*i)+r*Z(s*i)):(1+r*i)*te(-i*n),1-i}compute(){const{maxRestSteps:e,maxIterations:t,restThreshold:n,timeStep:s,m:r,d:i,s:o,v:a}=this,l=this.w0=ce(K(o/r),p,m),c=this.zeta=i/(2*K(o*r)),d=this.wd=c<1?l*K(1-c*c):0;this.b=c<1?(c*l-a)/d:-a+l;let u=0,h=0,g=0;for(;h<e&&g<t;)ee(1-this.solve(u))<n?h++:h=0,this.solverDuration=u,u+=s,g++;this.duration=ue(this.solverDuration*m,0)*R.timeScale}get mass(){return this.m}set mass(e){this.m=ce(Ie(e,1),0,m),this.compute()}get stiffness(){return this.s}set stiffness(e){this.s=ce(Ie(e,100),1,m),this.compute()}get damping(){return this.d}set damping(e){this.d=ce(Ie(e,10),.1,m),this.compute()}get velocity(){return this.v}set velocity(e){this.v=ce(Ie(e,0),-1e3,m),this.compute()}}const bn=e=>new yn(e),_n=e=>{e.cancelable&&e.preventDefault()};class vn{constructor(e){this.el=e,this.zIndex=0,this.parentElement=null,this.classList={add:v,remove:v}}get x(){return this.el.x||0}set x(e){this.el.x=e}get y(){return this.el.y||0}set y(e){this.el.y=e}get width(){return this.el.width||0}set width(e){this.el.width=e}get height(){return this.el.height||0}set height(e){this.el.height=e}getBoundingClientRect(){return{top:this.y,right:this.x,bottom:this.y+this.height,left:this.x+this.width}}}class wn{constructor(e){this.$el=e,this.inlineTransforms=[],this.point=new DOMPoint,this.inversedMatrix=this.getMatrix().inverse()}normalizePoint(e,t){return this.point.x=e,this.point.y=t,this.point.matrixTransform(this.inversedMatrix)}traverseUp(e){let t=this.$el.parentElement,n=0;for(;t&&t!==i;)e(t,n),t=t.parentElement,n++}getMatrix(){const e=new DOMMatrix;return this.traverseUp((t=>{const n=getComputedStyle(t).transform;if(n){const t=new DOMMatrix(n);e.preMultiplySelf(t)}})),e}remove(){this.traverseUp(((e,t)=>{this.inlineTransforms[t]=e.style.transform,e.style.transform="none"}))}revert(){this.traverseUp(((e,t)=>{const n=this.inlineTransforms[t];""===n?e.style.removeProperty("transform"):e.style.transform=n}))}}const Sn=(e,t)=>e&&j(e)?e(t):e;let xn=0;class $n{constructor(e,t={}){if(!e)return;R.scope&&R.scope.revertibles.push(this);const n=t.x,s=t.y,o=t.trigger,a=t.modifier,l=t.releaseEase,c=l&&vt(l),d=!H(l)&&!H(l.ease),u=z(n)&&!H(n.mapTo)?n.mapTo:"translateX",h=z(s)&&!H(s.mapTo)?s.mapTo:"translateY",p=Sn(t.container,this);this.containerArray=L(p)?p:null,this.$container=p&&!this.containerArray?Re(p)[0]:i.body,this.useWin=this.$container===i.body,this.$scrollContainer=this.useWin?r:this.$container,this.$target=z(e)?new vn(e):Re(e)[0],this.$trigger=Re(o||e)[0],this.fixed="fixed"===en(this.$target,"position"),this.isFinePointer=!0,this.containerPadding=[0,0,0,0],this.containerFriction=0,this.releaseContainerFriction=0,this.snapX=0,this.snapY=0,this.scrollSpeed=0,this.scrollThreshold=0,this.dragSpeed=0,this.maxVelocity=0,this.minVelocity=0,this.velocityMultiplier=0,this.cursor=!1,this.releaseXSpring=d?l:bn({mass:Ie(t.releaseMass,1),stiffness:Ie(t.releaseStiffness,80),damping:Ie(t.releaseDamping,20)}),this.releaseYSpring=d?l:bn({mass:Ie(t.releaseMass,1),stiffness:Ie(t.releaseStiffness,80),damping:Ie(t.releaseDamping,20)}),this.releaseEase=c||bt.outQuint,this.hasReleaseSpring=d,this.onGrab=t.onGrab||v,this.onDrag=t.onDrag||v,this.onRelease=t.onRelease||v,this.onUpdate=t.onUpdate||v,this.onSettle=t.onSettle||v,this.onSnap=t.onSnap||v,this.onResize=t.onResize||v,this.onAfterResize=t.onAfterResize||v,this.disabled=[0,0];const m={};if(a&&(m.modifier=a),H(n)||!0===n)m[u]=0;else if(z(n)){const e=n,t={};e.modifier&&(t.modifier=e.modifier),e.composition&&(t.composition=e.composition),m[u]=t}else!1===n&&(m[u]=0,this.disabled[0]=1);if(H(s)||!0===s)m[h]=0;else if(z(s)){const e=s,t={};e.modifier&&(t.modifier=e.modifier),e.composition&&(t.composition=e.composition),m[h]=t}else!1===s&&(m[h]=0,this.disabled[1]=1);this.animate=new mn(this.$target,m),this.xProp=u,this.yProp=h,this.destX=0,this.destY=0,this.deltaX=0,this.deltaY=0,this.scroll={x:0,y:0},this.coords=[this.x,this.y,0,0],this.snapped=[0,0],this.pointer=[0,0,0,0,0,0,0,0],this.scrollView=[0,0],this.dragArea=[0,0,0,0],this.containerBounds=[-1e12,g,g,-1e12],this.scrollBounds=[0,0,0,0],this.targetBounds=[0,0,0,0],this.window=[0,0],this.velocityStack=[0,0,0],this.velocityStackIndex=0,this.velocityTime=P(),this.velocity=0,this.angle=0,this.cursorStyles=null,this.triggerStyles=null,this.bodyStyles=null,this.targetStyles=null,this.touchActionStyles=null,this.transforms=new wn(this.$target),this.overshootCoords={x:0,y:0},this.overshootXTicker=new rt({autoplay:!1},null,0).init(),this.overshootYTicker=new rt({autoplay:!1},null,0).init(),this.updateTicker=new rt({autoplay:!1},null,0).init(),this.overshootXTicker.onUpdate=()=>{this.disabled[0]||(this.updated=!0,this.manual=!0,this.animate[this.xProp](this.overshootCoords.x,0))},this.overshootXTicker.onComplete=()=>{this.disabled[0]||(this.manual=!1,this.animate[this.xProp](this.overshootCoords.x,0))},this.overshootYTicker.onUpdate=()=>{this.disabled[1]||(this.updated=!0,this.manual=!0,this.animate[this.yProp](this.overshootCoords.y,0))},this.overshootYTicker.onComplete=()=>{this.disabled[1]||(this.manual=!1,this.animate[this.yProp](this.overshootCoords.y,0))},this.updateTicker.onUpdate=()=>this.update(),this.contained=!H(p),this.manual=!1,this.grabbed=!1,this.dragged=!1,this.updated=!1,this.released=!1,this.canScroll=!1,this.enabled=!1,this.initialized=!1,this.activeProp=this.disabled[1]?u:h,this.animate.animations[this.activeProp].onRender=()=>{const e=this.updated,t=!(this.grabbed&&e)&&this.released,n=this.x,s=this.y,r=n-this.coords[2],i=s-this.coords[3];this.deltaX=r,this.deltaY=i,this.coords[2]=n,this.coords[3]=s,e&&this.onUpdate(this),t?(this.computeVelocity(r,i),this.angle=oe(i,r)):this.updated=!1},this.animate.animations[this.activeProp].onComplete=()=>{!this.grabbed&&this.released&&(this.released=!1),this.manual||(this.deltaX=0,this.deltaY=0,this.velocity=0,this.velocityStack[0]=0,this.velocityStack[1]=0,this.velocityStack[2]=0,this.velocityStackIndex=0,this.onSettle(this))},this.resizeTicker=new rt({autoplay:!1,duration:150*R.timeScale,onComplete:()=>{this.onResize(this),this.refresh(),this.onAfterResize(this)}}).init(),this.parameters=t,this.resizeObserver=new ResizeObserver((()=>{this.initialized?this.resizeTicker.restart():this.initialized=!0})),this.enable(),this.refresh(),this.resizeObserver.observe(this.$container),z(e)||this.resizeObserver.observe(this.$target)}computeVelocity(e,t){const n=this.velocityTime,s=P(),r=s-n;if(r<17)return this.velocity;this.velocityTime=s;const i=this.velocityStack,o=this.velocityMultiplier,a=this.minVelocity,l=this.maxVelocity,c=this.velocityStackIndex;i[c]=ue(ce(K(e*e+t*t)/r*o,a,l),5);const d=ie(i[0],i[1],i[2]);return this.velocity=d,this.velocityStackIndex=(c+1)%3,d}setX(e,t=!1){if(this.disabled[0])return;const n=ue(e,5);return this.overshootXTicker.pause(),this.manual=!0,this.updated=!t,this.destX=n,this.snapped[0]=he(n,this.snapX),this.animate[this.xProp](n,0),this.manual=!1,this}setY(e,t=!1){if(this.disabled[1])return;const n=ue(e,5);return this.overshootYTicker.pause(),this.manual=!0,this.updated=!t,this.destY=n,this.snapped[1]=he(n,this.snapY),this.animate[this.yProp](n,0),this.manual=!1,this}get x(){return ue(this.animate[this.xProp](),R.precision)}set x(e){this.setX(e,!1)}get y(){return ue(this.animate[this.yProp](),R.precision)}set y(e){this.setY(e,!1)}get progressX(){return on(this.x,this.containerBounds[3],this.containerBounds[1],0,1)}set progressX(e){this.setX(on(e,0,1,this.containerBounds[3],this.containerBounds[1]),!1)}get progressY(){return on(this.y,this.containerBounds[0],this.containerBounds[2],0,1)}set progressY(e){this.setY(on(e,0,1,this.containerBounds[0],this.containerBounds[2]),!1)}updateScrollCoords(){const e=ue(this.useWin?r.scrollX:this.$container.scrollLeft,0),t=ue(this.useWin?r.scrollY:this.$container.scrollTop,0),[n,s,i,o]=this.containerPadding,a=this.scrollThreshold;this.scroll.x=e,this.scroll.y=t,this.scrollBounds[0]=t-this.targetBounds[0]+n-a,this.scrollBounds[1]=e-this.targetBounds[1]-s+a,this.scrollBounds[2]=t-this.targetBounds[2]-i+a,this.scrollBounds[3]=e-this.targetBounds[3]+o-a}updateBoundingValues(){const e=this.$container,t=this.x,n=this.y,s=this.coords[2],o=this.coords[3];this.coords[2]=0,this.coords[3]=0,this.setX(0,!0),this.setY(0,!0),this.transforms.remove();const a=this.window[0]=r.innerWidth,l=this.window[1]=r.innerHeight,c=this.useWin,d=e.scrollWidth,u=e.scrollHeight,h=this.fixed,p=e.getBoundingClientRect(),[g,m,f,y]=this.containerPadding;this.dragArea[0]=c?0:p.left,this.dragArea[1]=c?0:p.top,this.scrollView[0]=c?ce(d,a,d):d,this.scrollView[1]=c?ce(u,l,u):u,this.updateScrollCoords();const{width:b,height:_,left:v,top:w,right:S,bottom:x}=e.getBoundingClientRect();this.dragArea[2]=ue(c?ce(b,a,a):b,0),this.dragArea[3]=ue(c?ce(_,l,l):_,0);const $=en(e,"overflow"),C="visible"===$,M="hidden"===$;if(this.canScroll=!h&&this.contained&&(e===i.body&&C||!M&&!C)&&(d>this.dragArea[2]+y-m||u>this.dragArea[3]+g-f)&&(!this.containerArray||this.containerArray&&!L(this.containerArray)),this.contained){const t=this.scroll.x,n=this.scroll.y,s=this.canScroll,r=this.$target.getBoundingClientRect(),i=s?c?0:e.scrollLeft:0,o=s?c?0:e.scrollTop:0,d=s?this.scrollView[0]-i-b:0,u=s?this.scrollView[1]-o-_:0;this.targetBounds[0]=ue(r.top+n-(c?0:w),0),this.targetBounds[1]=ue(r.right+t-(c?a:S),0),this.targetBounds[2]=ue(r.bottom+n-(c?l:x),0),this.targetBounds[3]=ue(r.left+t-(c?0:v),0),this.containerArray?(this.containerBounds[0]=this.containerArray[0]+g,this.containerBounds[1]=this.containerArray[1]-m,this.containerBounds[2]=this.containerArray[2]-f,this.containerBounds[3]=this.containerArray[3]+y):(this.containerBounds[0]=-ue(r.top-(h?ce(w,0,l):w)+o-g,0),this.containerBounds[1]=-ue(r.right-(h?ce(S,0,a):S)-d+m,0),this.containerBounds[2]=-ue(r.bottom-(h?ce(x,0,l):x)-u+f,0),this.containerBounds[3]=-ue(r.left-(h?ce(v,0,a):v)+i-y,0))}this.transforms.revert(),this.coords[2]=s,this.coords[3]=o,this.setX(t,!0),this.setY(n,!0)}isOutOfBounds(e,t,n){if(!this.contained)return 0;const[s,r,i,o]=e,[a,l]=this.disabled,c=!a&&t<o||!a&&t>r,d=!l&&n<s||!l&&n>i;return c&&!d?1:!c&&d?2:c&&d?3:0}refresh(){const e=this.parameters,t=e.x,n=e.y,s=Sn(e.container,this),o=Sn(e.containerPadding,this)||0,a=L(o)?o:[o,o,o,o],l=this.x,c=this.y,d=Sn(e.cursor,this),u={onHover:"grab",onGrab:"grabbing"};if(d){const{onHover:e,onGrab:t}=d;e&&(u.onHover=e),t&&(u.onGrab=t)}this.containerArray=L(s)?s:null,this.$container=s&&!this.containerArray?Re(s)[0]:i.body,this.useWin=this.$container===i.body,this.$scrollContainer=this.useWin?r:this.$container,this.isFinePointer=matchMedia("(pointer:fine)").matches,this.containerPadding=Ie(a,[0,0,0,0]),this.containerFriction=ce(Ie(Sn(e.containerFriction,this),.8),0,1),this.releaseContainerFriction=ce(Ie(Sn(e.releaseContainerFriction,this),this.containerFriction),0,1),this.snapX=Sn(z(t)&&!H(t.snap)?t.snap:e.snap,this),this.snapY=Sn(z(n)&&!H(n.snap)?n.snap:e.snap,this),this.scrollSpeed=Ie(Sn(e.scrollSpeed,this),1.5),this.scrollThreshold=Ie(Sn(e.scrollThreshold,this),20),this.dragSpeed=Ie(Sn(e.dragSpeed,this),1),this.minVelocity=Ie(Sn(e.minVelocity,this),0),this.maxVelocity=Ie(Sn(e.maxVelocity,this),50),this.velocityMultiplier=Ie(Sn(e.velocityMultiplier,this),1),this.cursor=!1!==d&&u,this.updateBoundingValues();const[h,p,g,m]=this.containerBounds;this.setX(ce(l,m,p),!0),this.setY(ce(c,h,g),!0)}update(){if(this.updateScrollCoords(),this.canScroll){const[e,t,n,s]=this.containerPadding,[r,i]=this.scrollView,o=this.dragArea[2],a=this.dragArea[3],l=this.scroll.x,c=this.scroll.y,d=this.$container.scrollWidth,u=this.$container.scrollHeight,h=this.useWin?ce(d,this.window[0],d):d,p=this.useWin?ce(u,this.window[1],u):u,g=r-h,m=i-p;this.dragged&&g>0&&(this.coords[0]-=g,this.scrollView[0]=h),this.dragged&&m>0&&(this.coords[1]-=m,this.scrollView[1]=p);const f=10*this.scrollSpeed,y=this.scrollThreshold,[b,_]=this.coords,[v,w,S,x]=this.scrollBounds,$=ue(ce((_-v+e)/y,-1,0)*f,0),C=ue(ce((b-w-t)/y,0,1)*f,0),M=ue(ce((_-S-n)/y,0,1)*f,0),A=ue(ce((b-x+s)/y,-1,0)*f,0);if($||M||A||C){const[e,t]=this.disabled;let n=l,s=c;e||(n=ue(ce(l+(A||C),0,r-o),0),this.coords[0]-=l-n),t||(s=ue(ce(c+($||M),0,i-a),0),this.coords[1]-=c-s),this.useWin?this.$scrollContainer.scrollBy(-(l-n),-(c-s)):this.$scrollContainer.scrollTo(n,s)}}const[e,t,n,s]=this.containerBounds,[r,i,o,a,l,c]=this.pointer;this.coords[0]+=(r-l)*this.dragSpeed,this.coords[1]+=(i-c)*this.dragSpeed,this.pointer[4]=r,this.pointer[5]=i;const[d,u]=this.coords,[h,p]=this.snapped,g=(1-this.containerFriction)*this.dragSpeed;this.setX(d>t?t+(d-t)*g:d<s?s+(d-s)*g:d,!1),this.setY(u>n?n+(u-n)*g:u<e?e+(u-e)*g:u,!1),this.computeVelocity(r-l,i-c),this.angle=oe(i-a,r-o);const[m,f]=this.snapped;(m!==h&&this.snapX||f!==p&&this.snapY)&&this.onSnap(this)}stop(){this.updateTicker.pause(),this.overshootXTicker.pause(),this.overshootYTicker.pause();for(let e in this.animate.animations)this.animate.animations[e].pause();return sn(this,null,"x"),sn(this,null,"y"),sn(this,null,"progressX"),sn(this,null,"progressY"),sn(this.scroll),sn(this.overshootCoords),this}scrollInView(e,t=0,n=bt.inOutQuad){this.updateScrollCoords();const s=this.destX,r=this.destY,i=this.scroll,o=this.scrollBounds,a=this.canScroll;if(!this.containerArray&&this.isOutOfBounds(o,s,r)){const[l,c,d,u]=o,h=ue(ce(r-l,-1e12,0),0),p=ue(ce(s-c,0,g),0),m=ue(ce(r-d,0,g),0),f=ue(ce(s-u,-1e12,0),0);new Pt(i,{x:ue(i.x+(f?f-t:p?p+t:0),0),y:ue(i.y+(h?h-t:m?m+t:0),0),duration:H(e)?350*R.timeScale:e,ease:n,onUpdate:()=>{this.canScroll=!1,this.$scrollContainer.scrollTo(i.x,i.y)}}).init().then((()=>{this.canScroll=a}))}return this}handleHover(){this.isFinePointer&&this.cursor&&!this.cursorStyles&&(this.cursorStyles=tn(this.$trigger,{cursor:this.cursor.onHover}))}animateInView(e,t=0,n=bt.inOutQuad){this.stop(),this.updateBoundingValues();const s=this.x,r=this.y,[i,o,a,l]=this.containerPadding,c=this.scroll.y-this.targetBounds[0]+i+t,d=this.scroll.x-this.targetBounds[1]-o-t,u=this.scroll.y-this.targetBounds[2]-a-t,h=this.scroll.x-this.targetBounds[3]+l+t,p=this.isOutOfBounds([c,d,u,h],s,r);if(p){const[t,i]=this.disabled,o=ce(he(s,this.snapX),h,d),a=ce(he(r,this.snapY),c,u),l=H(e)?350*R.timeScale:e;t||1!==p&&3!==p||this.animate[this.xProp](o,l,n),i||2!==p&&3!==p||this.animate[this.yProp](a,l,n)}return this}handleDown(e){const t=e.target;if(this.grabbed||"range"===t.type)return;e.stopPropagation(),this.grabbed=!0,this.released=!1,this.stop(),this.updateBoundingValues();const n=e.changedTouches,s=n?n[0].clientX:e.clientX,r=n?n[0].clientY:e.clientY,{x:o,y:a}=this.transforms.normalizePoint(s,r),[l,c,d,u]=this.containerBounds,h=(1-this.containerFriction)*this.dragSpeed,p=this.x,g=this.y;this.coords[0]=this.coords[2]=h?p>c?c+(p-c)/h:p<u?u+(p-u)/h:p:p,this.coords[1]=this.coords[3]=h?g>d?d+(g-d)/h:g<l?l+(g-l)/h:g:g,this.pointer[0]=o,this.pointer[1]=a,this.pointer[2]=o,this.pointer[3]=a,this.pointer[4]=o,this.pointer[5]=a,this.pointer[6]=o,this.pointer[7]=a,this.deltaX=0,this.deltaY=0,this.velocity=0,this.velocityStack[0]=0,this.velocityStack[1]=0,this.velocityStack[2]=0,this.velocityStackIndex=0,this.angle=0,this.targetStyles&&(this.targetStyles.revert(),this.targetStyles=null);const m=en(this.$target,"zIndex",!1);xn=(m>xn?m:xn)+1,this.targetStyles=tn(this.$target,{zIndex:xn}),this.triggerStyles&&(this.triggerStyles.revert(),this.triggerStyles=null),this.cursorStyles&&(this.cursorStyles.revert(),this.cursorStyles=null),this.isFinePointer&&this.cursor&&(this.bodyStyles=tn(i.body,{cursor:this.cursor.onGrab})),this.scrollInView(100,0,bt.out(3)),this.onGrab(this),i.addEventListener("touchmove",this),i.addEventListener("touchend",this),i.addEventListener("touchcancel",this),i.addEventListener("mousemove",this),i.addEventListener("mouseup",this),i.addEventListener("selectstart",this)}handleMove(e){if(!this.grabbed)return;const t=e.changedTouches,n=t?t[0].clientX:e.clientX,s=t?t[0].clientY:e.clientY,{x:r,y:i}=this.transforms.normalizePoint(n,s),o=r-this.pointer[6],a=i-this.pointer[7];let l=e.target,c=!1,d=!1,u=!1;for(;t&&l&&l!==this.$trigger;){const e=en(l,"overflow-y");if("hidden"!==e&&"visible"!==e){const{scrollTop:e,scrollHeight:t,clientHeight:n}=l;if(t>n){u=!0,c=e<=3,d=e>=t-n-3;break}}l=l.parentNode}u&&(!c&&!d||c&&a<0||d&&a>0)?(this.pointer[0]=r,this.pointer[1]=i,this.pointer[2]=r,this.pointer[3]=i,this.pointer[4]=r,this.pointer[5]=i,this.pointer[6]=r,this.pointer[7]=i):(_n(e),this.triggerStyles||(this.triggerStyles=tn(this.$trigger,{pointerEvents:"none"})),this.$trigger.addEventListener("touchstart",_n,{passive:!1}),this.$trigger.addEventListener("touchmove",_n,{passive:!1}),this.$trigger.addEventListener("touchend",_n),(!this.disabled[0]&&ee(o)>3||!this.disabled[1]&&ee(a)>3)&&(this.updateTicker.resume(),this.pointer[2]=this.pointer[0],this.pointer[3]=this.pointer[1],this.pointer[0]=r,this.pointer[1]=i,this.dragged=!0,this.released=!1,this.onDrag(this)))}handleUp(){if(!this.grabbed)return;this.updateTicker.pause(),this.triggerStyles&&(this.triggerStyles.revert(),this.triggerStyles=null),this.bodyStyles&&(this.bodyStyles.revert(),this.bodyStyles=null);const[e,t]=this.disabled,[n,s,r,a,l,c]=this.pointer,[d,u,h,p]=this.containerBounds,[g,m]=this.snapped,f=this.releaseXSpring,y=this.releaseYSpring,b=this.releaseEase,_=this.hasReleaseSpring,v=this.overshootCoords,w=this.x,S=this.y,x=this.computeVelocity(n-l,s-c),$=this.angle=oe(s-a,n-r),C=150*x,M=(1-this.releaseContainerFriction)*this.dragSpeed,A=w+Q($)*C,k=S+Z($)*C,D=A>u?u+(A-u)*M:A<p?p+(A-p)*M:A,E=k>h?h+(k-h)*M:k<d?d+(k-d)*M:k,T=this.destX=ce(ue(he(D,this.snapX),5),p,u),O=this.destY=ce(ue(he(E,this.snapY),5),d,h),F=this.isOutOfBounds(this.containerBounds,A,k);let N=0,P=0,L=b,z=b,B=0;if(v.x=w,v.y=S,!e){const e=T===u?w>u?-1:1:w<p?-1:1,n=ue(w-T,0);f.velocity=t&&_?n?C*e/ee(n):0:x;const{ease:s,duration:r,restDuration:i}=f;N=w===T?0:_?r:r-i*R.timeScale,_&&(L=s),N>B&&(B=N)}if(!t){const t=O===h?S>h?-1:1:S<d?-1:1,n=ue(S-O,0);y.velocity=e&&_?n?C*t/ee(n):0:x;const{ease:s,duration:r,restDuration:i}=y;P=S===O?0:_?r:r-i*R.timeScale,_&&(z=s),P>B&&(B=P)}if(!_&&F&&M&&(N||P)){const e=o.blend;new Pt(v,{x:{to:D,duration:.65*N},y:{to:E,duration:.65*P},ease:b,composition:e}).init(),new Pt(v,{x:{to:T,duration:N},y:{to:O,duration:P},ease:b,composition:e}).init(),this.overshootXTicker.stretch(N).restart(),this.overshootYTicker.stretch(P).restart()}else e||this.animate[this.xProp](T,N,L),t||this.animate[this.yProp](O,P,z);this.scrollInView(B,this.scrollThreshold,b);let I=!1;T!==g&&(this.snapped[0]=T,this.snapX&&(I=!0)),O!==m&&this.snapY&&(this.snapped[1]=O,this.snapY&&(I=!0)),I&&this.onSnap(this),this.grabbed=!1,this.dragged=!1,this.updated=!0,this.released=!0,this.onRelease(this),this.$trigger.removeEventListener("touchstart",_n),this.$trigger.removeEventListener("touchmove",_n),this.$trigger.removeEventListener("touchend",_n),i.removeEventListener("touchmove",this),i.removeEventListener("touchend",this),i.removeEventListener("touchcancel",this),i.removeEventListener("mousemove",this),i.removeEventListener("mouseup",this),i.removeEventListener("selectstart",this)}reset(){return this.stop(),this.resizeTicker.pause(),this.grabbed=!1,this.dragged=!1,this.updated=!1,this.released=!1,this.canScroll=!1,this.setX(0,!0),this.setY(0,!0),this.coords[0]=0,this.coords[1]=0,this.pointer[0]=0,this.pointer[1]=0,this.pointer[2]=0,this.pointer[3]=0,this.pointer[4]=0,this.pointer[5]=0,this.pointer[6]=0,this.pointer[7]=0,this.velocity=0,this.velocityStack[0]=0,this.velocityStack[1]=0,this.velocityStack[2]=0,this.velocityStackIndex=0,this.angle=0,this}enable(){return this.enabled||(this.enabled=!0,this.$target.classList.remove("is-disabled"),this.touchActionStyles=tn(this.$trigger,{touchAction:this.disabled[0]?"pan-x":this.disabled[1]?"pan-y":"none"}),this.$trigger.addEventListener("touchstart",this,{passive:!0}),this.$trigger.addEventListener("mousedown",this,{passive:!0}),this.$trigger.addEventListener("mouseenter",this)),this}disable(){return this.enabled=!1,this.grabbed=!1,this.dragged=!1,this.updated=!1,this.released=!1,this.canScroll=!1,this.touchActionStyles.revert(),this.cursorStyles&&(this.cursorStyles.revert(),this.cursorStyles=null),this.triggerStyles&&(this.triggerStyles.revert(),this.triggerStyles=null),this.bodyStyles&&(this.bodyStyles.revert(),this.bodyStyles=null),this.targetStyles&&(this.targetStyles.revert(),this.targetStyles=null),this.stop(),this.$target.classList.add("is-disabled"),this.$trigger.removeEventListener("touchstart",this),this.$trigger.removeEventListener("mousedown",this),this.$trigger.removeEventListener("mouseenter",this),i.removeEventListener("touchmove",this),i.removeEventListener("touchend",this),i.removeEventListener("touchcancel",this),i.removeEventListener("mousemove",this),i.removeEventListener("mouseup",this),i.removeEventListener("selectstart",this),this}revert(){return this.reset(),this.disable(),this.$target.classList.remove("is-disabled"),this.updateTicker.revert(),this.overshootXTicker.revert(),this.overshootYTicker.revert(),this.resizeTicker.revert(),this.animate.revert(),this}handleEvent(e){switch(e.type){case"mousedown":case"touchstart":this.handleDown(e);break;case"mousemove":case"touchmove":this.handleMove(e);break;case"mouseup":case"touchend":case"touchcancel":this.handleUp();break;case"mouseenter":this.handleHover();break;case"selectstart":_n(e)}}}const Cn=(e,t)=>new $n(e,t);class Mn{constructor(e={}){R.scope&&R.scope.revertibles.push(this);const t=e.root;let n=i;t&&(n=t.current||t.nativeElement||Re(t)[0]||i);const s=e.defaults,o=R.defaults,a=e.mediaQueries;if(this.defaults=s?ye(s,o):o,this.root=n,this.constructors=[],this.revertConstructors=[],this.revertibles=[],this.methods={},this.matches={},this.mediaQueryLists={},this.data={},a)for(let e in a){const t=r.matchMedia(a[e]);this.mediaQueryLists[e]=t,t.addEventListener("change",this)}}execute(e){let t=R.scope,n=R.root,s=R.defaults;R.scope=this,R.root=this.root,R.defaults=this.defaults;const r=this.mediaQueryLists;for(let e in r)this.matches[e]=r[e].matches;const i=e(this);return R.scope=t,R.root=n,R.defaults=s,i}refresh(){return this.execute((()=>{let e=this.revertibles.length,t=this.revertConstructors.length;for(;e--;)this.revertibles[e].revert();for(;t--;)this.revertConstructors[t](this);this.revertibles.length=0,this.revertConstructors.length=0,this.constructors.forEach((e=>{const t=e(this);t&&this.revertConstructors.push(t)}))})),this}add(e,t){if(j(e)){const t=e;this.constructors.push(t),this.execute((()=>{const e=t(this);e&&this.revertConstructors.push(e)}))}else this.methods[e]=(...e)=>this.execute((()=>t(...e)));return this}handleEvent(e){"change"===e.type&&this.refresh()}revert(){const e=this.revertibles,t=this.revertConstructors,n=this.mediaQueryLists;let s=e.length,r=t.length;for(;s--;)e[s].revert();for(;r--;)t[r](this);for(let e in n)n[e].removeEventListener("change",this);e.length=0,t.length=0,this.constructors.length=0,this.matches={},this.methods={},this.mediaQueryLists={},this.data={}}}const An=e=>new Mn(e),kn=(e,t)=>e&&j(e)?e(t):e,Dn=new Map;class En{constructor(e){this.element=e,this.useWin=this.element===i.body,this.winWidth=0,this.winHeight=0,this.width=0,this.height=0,this.left=0,this.top=0,this.zIndex=0,this.scrollX=0,this.scrollY=0,this.prevScrollX=0,this.prevScrollY=0,this.scrollWidth=0,this.scrollHeight=0,this.velocity=0,this.backwardX=!1,this.backwardY=!1,this.scrollTicker=new rt({autoplay:!1,onBegin:()=>this.dataTimer.resume(),onUpdate:()=>{const e=this.backwardX||this.backwardY;be(this,(e=>e.handleScroll()),e)},onComplete:()=>this.dataTimer.pause()}).init(),this.dataTimer=new rt({autoplay:!1,frameRate:30,onUpdate:e=>{const t=e.deltaTime,n=this.prevScrollX,s=this.prevScrollY,r=this.scrollX,i=this.scrollY,o=n-r,a=s-i;this.prevScrollX=r,this.prevScrollY=i,o&&(this.backwardX=n>r),a&&(this.backwardY=s>i),this.velocity=ue(t>0?Math.sqrt(o*o+a*a)/t:0,5)}}).init(),this.resizeTicker=new rt({autoplay:!1,duration:250*R.timeScale,onComplete:()=>{this.updateWindowBounds(),this.refreshScrollObservers(),this.handleScroll()}}).init(),this.wakeTicker=new rt({autoplay:!1,duration:500*R.timeScale,onBegin:()=>{this.scrollTicker.resume()},onComplete:()=>{this.scrollTicker.pause()}}).init(),this._head=null,this._tail=null,this.updateScrollCoords(),this.updateWindowBounds(),this.updateBounds(),this.refreshScrollObservers(),this.handleScroll(),this.resizeObserver=new ResizeObserver((()=>this.resizeTicker.restart())),this.resizeObserver.observe(this.element),(this.useWin?r:this.element).addEventListener("scroll",this,!1)}updateScrollCoords(){const e=this.useWin,t=this.element;this.scrollX=ue(e?r.scrollX:t.scrollLeft,0),this.scrollY=ue(e?r.scrollY:t.scrollTop,0)}updateWindowBounds(){this.winWidth=r.innerWidth,this.winHeight=(()=>{const e=document.createElement("div");i.body.appendChild(e),e.style.height="100lvh";const t=e.offsetHeight;return i.body.removeChild(e),t})()}updateBounds(){const e=getComputedStyle(this.element),t=this.element;let n,s;if(this.scrollWidth=t.scrollWidth+parseFloat(e.marginLeft)+parseFloat(e.marginRight),this.scrollHeight=t.scrollHeight+parseFloat(e.marginTop)+parseFloat(e.marginBottom),this.updateWindowBounds(),this.useWin)n=this.winWidth,s=this.winHeight;else{const e=t.getBoundingClientRect();n=e.width,s=e.height,this.top=e.top,this.left=e.left}this.width=n,this.height=s}refreshScrollObservers(){be(this,(e=>{e._debug&&e.removeDebug()})),this.updateBounds(),be(this,(e=>{e.refresh(),e._debug&&e.debug()}))}refresh(){this.updateWindowBounds(),this.updateBounds(),this.refreshScrollObservers(),this.handleScroll()}handleScroll(){this.updateScrollCoords(),this.wakeTicker.restart()}handleEvent(e){"scroll"===e.type&&this.handleScroll()}revert(){this.scrollTicker.cancel(),this.dataTimer.cancel(),this.resizeTicker.cancel(),this.wakeTicker.cancel(),this.resizeObserver.unobserve(this.element),(this.useWin?r:this.element).removeEventListener("scroll",this),Dn.delete(this.element)}}const Tn=(e,t,n,s,r)=>{const i="min"===t,o="max"===t,a="top"===t||"left"===t||"start"===t||i?0:"bottom"===t||"right"===t||"end"===t||o?"100%":"center"===t?"50%":t,{n:l,u:c}=Ve(a,Ye);let d=l;return"%"===c?d=l/100*n:c&&(d=Ct(e,Ye,"px",!0).n),o&&s<0&&(d+=s),i&&r>0&&(d+=r),d},Rn=(e,t,n,s,r)=>{let i;if(I(t)){const o=E.exec(t);if(o){const a=o[0],l=a[0],c=t.split(a),d="min"===c[0],u="max"===c[0],h=Tn(e,c[0],n,s,r),p=Tn(e,c[1],n,s,r);if(d){const t=qe(Tn(e,"min",n),p,l);i=t<h?h:t}else if(u){const t=qe(Tn(e,"max",n),p,l);i=t>h?h:t}else i=qe(h,p,l)}else i=Tn(e,t,n,s,r)}else i=t;return ue(i,0)},On=e=>{let t;const n=e.targets;for(let e=0,s=n.length;e<s;e++){const s=n[e];if(s[l]){t=s;break}}return t};let Fn=0;const Nn=["#FF4B4B","#FF971B","#FFC730","#F9F640","#7AFF5A","#18FF74","#17E09B","#3CFFEC","#05DBE9","#33B3F1","#638CF9","#C563FE","#FF4FCF","#F93F8A"];class Pn{constructor(e={}){R.scope&&R.scope.revertibles.push(this);const t=Ie(e.sync,"play pause"),n=t?vt(t):null,s=t&&("linear"===t||t===ot),r=t&&!(n===ot&&!s),o=t&&(B(t)||!0===t||s),a=t&&I(t)&&!r&&!o,l=a?t.split(" ").map((e=>()=>{const t=this.linked;return t&&t[e]?t[e]():null})):null,c=a&&l.length>2;this.index=Fn++,this.id=H(e.id)?this.index:e.id,this.container=(e=>{const t=e&&Re(e)[0]||i.body;let n=Dn.get(t);return n||(n=new En(t),Dn.set(t,n)),n})(e.container),this.target=null,this.linked=null,this.repeat=null,this.horizontal=null,this.enter=null,this.leave=null,this.sync=r||o||!!l,this.syncEase=r?n:null,this.syncSmooth=o?!0===t||s?1:t:null,this.onSyncEnter=l&&!c&&l[0]?l[0]:v,this.onSyncLeave=l&&!c&&l[1]?l[1]:v,this.onSyncEnterForward=l&&c&&l[0]?l[0]:v,this.onSyncLeaveForward=l&&c&&l[1]?l[1]:v,this.onSyncEnterBackward=l&&c&&l[2]?l[2]:v,this.onSyncLeaveBackward=l&&c&&l[3]?l[3]:v,this.onEnter=e.onEnter||v,this.onLeave=e.onLeave||v,this.onEnterForward=e.onEnterForward||v,this.onLeaveForward=e.onLeaveForward||v,this.onEnterBackward=e.onEnterBackward||v,this.onLeaveBackward=e.onLeaveBackward||v,this.onUpdate=e.onUpdate||v,this.onSyncComplete=e.onSyncComplete||v,this.reverted=!1,this.completed=!1,this.began=!1,this.isInView=!1,this.forceEnter=!1,this.hasEntered=!1,this.offsets=[],this.offset=0,this.offsetStart=0,this.offsetEnd=0,this.distance=0,this.prevProgress=0,this.thresholds=["start","end","end","start"],this.coords=[0,0,0,0],this.debugStyles=null,this.$debug=null,this._params=e,this._debug=Ie(e.debug,!1),this._next=null,this._prev=null,ve(this.container,this),Qt((()=>{if(!this.reverted){if(!this.target){const t=Re(e.target)[0];this.target=t||i.body,this.refresh()}this._debug&&this.debug()}}))}link(e){if(e&&(e.pause(),this.linked=e,!this._params.target)){let t;H(e.targets)?be(e,(e=>{e.targets&&!t&&(t=On(e))})):t=On(e),this.target=t||i.body,this.refresh()}return this}get velocity(){return this.container.velocity}get backward(){return this.horizontal?this.container.backwardX:this.container.backwardY}get scroll(){return this.horizontal?this.container.scrollX:this.container.scrollY}get progress(){const e=(this.scroll-this.offsetStart)/this.distance;return e===1/0||isNaN(e)?0:ue(ce(e,0,1),6)}refresh(){this.reverted=!1;const e=this._params;return this.repeat=Ie(kn(e.repeat,this),!0),this.horizontal="x"===Ie(kn(e.axis,this),"y"),this.enter=Ie(kn(e.enter,this),"end start"),this.leave=Ie(kn(e.leave,this),"start end"),this.updateBounds(),this.handleScroll(),this}removeDebug(){return this.$debug&&(this.$debug.parentNode.removeChild(this.$debug),this.$debug=null),this.debugStyles&&(this.debugStyles.revert(),this.$debug=null),this}debug(){this.removeDebug();const e=this.container,t=this.horizontal,n=e.element.querySelector(":scope > .animejs-onscroll-debug"),s=i.createElement("div"),r=i.createElement("div"),o=i.createElement("div"),a=Nn[this.index%Nn.length],l=e.useWin,c=l?e.winWidth:e.width,d=l?e.winHeight:e.height,u=e.scrollWidth,h=e.scrollHeight,p=this.container.width>360?320:260,g=t?0:10,m=t?10:0,f=t?24:p/2,y=t?f:15,b=t?60:f,_=t?b:y,v=t?"repeat-x":"repeat-y",w=e=>t?"0px "+e+"px":e+"px 2px",S=e=>`linear-gradient(${t?90:0}deg, ${e} 2px, transparent 1px)`,x=(e,t,n,s,r)=>`position:${e};left:${t}px;top:${n}px;width:${s}px;height:${r}px;`;s.style.cssText=`${x("absolute",g,m,t?u:p,t?p:h)}\n      pointer-events: none;\n      z-index: ${this.container.zIndex++};\n      display: flex;\n      flex-direction: ${t?"column":"row"};\n      filter: drop-shadow(0px 1px 0px rgba(0,0,0,.75));\n    `,r.style.cssText=`${x("sticky",0,0,t?c:f,t?f:d)}`,n||(r.style.cssText+=`background:\n        ${S("#FFFF")}${w(f-10)} / 100px 100px ${v},\n        ${S("#FFF8")}${w(f-10)} / 10px 10px ${v};\n      `),o.style.cssText=`${x("relative",0,0,t?u:f,t?f:h)}`,n||(o.style.cssText+=`background:\n        ${S("#FFFF")}${w(0)} / ${t?"100px 10px":"10px 100px"} ${v},\n        ${S("#FFF8")}${w(0)} / ${t?"10px 0px":"0px 10px"} ${v};\n      `);const $=[" enter: "," leave: "];this.coords.forEach(((e,n)=>{const s=n>1,l=(s?0:this.offset)+e,g=n%2,m=l<_,f=l>(s?t?c:d:t?u:h)-_,v=(s?g&&!m:!g&&!m)||f,w=i.createElement("div"),S=i.createElement("div"),C=t?v?"right":"left":v?"bottom":"top",M=v?(t?b:y)+(s?t?-1:f?0:-2:t?-1:-2):t?1:0;S.innerHTML=`${this.id}${$[g]}${this.thresholds[n]}`,w.style.cssText=`${x("absolute",0,0,b,y)}\n        display: flex;\n        flex-direction: ${t?"column":"row"};\n        justify-content: flex-${s?"start":"end"};\n        align-items: flex-${v?"end":"start"};\n        border-${C}: 2px solid ${a};\n      `,S.style.cssText=`\n        overflow: hidden;\n        max-width: ${p/2-10}px;\n        height: ${y};\n        margin-${t?v?"right":"left":v?"bottom":"top"}: -2px;\n        padding: 1px;\n        font-family: ui-monospace, monospace;\n        font-size: 10px;\n        letter-spacing: -.025em;\n        line-height: 9px;\n        font-weight: 600;\n        text-align: ${t&&v||!t&&!s?"right":"left"};\n        white-space: pre;\n        text-overflow: ellipsis;\n        color: ${g?a:"rgba(0,0,0,.75)"};\n        background-color: ${g?"rgba(0,0,0,.65)":a};\n        border: 2px solid ${g?a:"transparent"};\n        border-${t?v?"top-left":"top-right":v?"top-left":"bottom-left"}-radius: 5px;\n        border-${t?v?"bottom-left":"bottom-right":v?"top-right":"bottom-right"}-radius: 5px;\n      `,w.appendChild(S);let A=l-M+(t?1:0);w.style[t?"left":"top"]=`${A}px`,(s?r:o).appendChild(w)})),s.appendChild(r),s.appendChild(o),e.element.appendChild(s),n||s.classList.add("animejs-onscroll-debug"),this.$debug=s,"static"===en(e.element,"position")&&(this.debugStyles=tn(e.element,{position:"relative "}))}updateBounds(){let e;this._debug&&this.removeDebug();const t=this.target,n=this.container,s=this.horizontal,r=this.linked;let o,a=t,l=0,c=0,d=a;r&&(o=r.currentTime,r.seek(0,!0));const u="static"===en(n.element,"position")&&tn(n.element,{position:"relative "});for(;a&&a!==n.element&&a!==i.body;){const t="sticky"===en(a,"position")&&tn(a,{position:"static"});a===d&&(l+=a.offsetLeft||0,c+=a.offsetTop||0,d=a.offsetParent),a=a.parentElement,t&&(e||(e=[]),e.push(t))}u&&u.revert();const h=s?l:c,p=s?t.offsetWidth:t.offsetHeight,g=s?n.width:n.height,m=(s?n.scrollWidth:n.scrollHeight)-g,f=this.enter,y=this.leave;let b="start",_="end",v="end",w="start";if(I(f)){const e=f.split(" ");v=e[0],b=e.length>1?e[1]:b}else if(z(f)){const e=f;H(e.container)||(v=e.container),H(e.target)||(b=e.target)}else B(f)&&(v=f);if(I(y)){const e=y.split(" ");w=e[0],_=e.length>1?e[1]:_}else if(z(y)){const e=y;H(e.container)||(w=e.container),H(e.target)||(_=e.target)}else B(y)&&(w=y);const S=Rn(t,b,p),x=Rn(t,_,p),$=S+h-g,C=x+h-m,M=Rn(t,v,g,$,C),A=Rn(t,w,g,$,C),k=S+h-M,D=x+h-A,E=D-k;this.offsets[0]=l,this.offsets[1]=c,this.offset=h,this.offsetStart=k,this.offsetEnd=D,this.distance=E<=0?0:E,this.thresholds=[b,_,v,w],this.coords=[S,x,M,A],e&&e.forEach((e=>e.revert())),r&&r.seek(o,!0),this._debug&&this.debug()}handleScroll(){const e=this.linked,t=this.sync,n=this.syncEase,s=this.syncSmooth,r=e&&(n||s),i=this.horizontal,o=this.container,a=this.scroll,l=a<=this.offsetStart,c=a>=this.offsetEnd,d=!l&&!c,u=a===this.offsetStart||a===this.offsetEnd,h=!this.hasEntered&&u,p=this._debug&&this.$debug;let g=!1,m=!1,f=this.progress;if(l&&this.began&&(this.began=!1),f>0&&!this.began&&(this.began=!0),r){const t=e.progress;if(s&&B(s)){if(s<1){const e=t<f&&1===f?1e-4:t>f&&!f?-1e-4:0;f=ue(an(t,f,pe(.01,.2,s),!1)+e,6)}}else n&&(f=n(f));g=f!==this.prevProgress,m=1===t,g&&!m&&s&&t&&o.wakeTicker.restart()}if(p){const e=i?o.scrollY:o.scrollX;p.style[i?"top":"left"]=e+10+"px"}(d&&!this.isInView||h&&!this.forceEnter&&!this.hasEntered)&&(d&&(this.isInView=!0),this.forceEnter&&this.hasEntered?d&&(this.forceEnter=!1):(p&&d&&(p.style.zIndex=""+this.container.zIndex++),this.onSyncEnter(this),this.onEnter(this),this.backward?(this.onSyncEnterBackward(this),this.onEnterBackward(this)):(this.onSyncEnterForward(this),this.onEnterForward(this)),this.hasEntered=!0,h&&(this.forceEnter=!0))),(d||!d&&this.isInView)&&(g=!0),g&&(r&&e.seek(e.duration*f),this.onUpdate(this)),!d&&this.isInView&&(this.isInView=!1,this.onSyncLeave(this),this.onLeave(this),this.backward?(this.onSyncLeaveBackward(this),this.onLeaveBackward(this)):(this.onSyncLeaveForward(this),this.onLeaveForward(this)),t&&!s&&(m=!0)),f>=1&&this.began&&!this.completed&&(t&&m||!t)&&(t&&this.onSyncComplete(this),this.completed=!0,(!this.repeat&&!e||!this.repeat&&e&&e.completed)&&this.revert()),f<1&&this.completed&&(this.completed=!1),this.prevProgress=f}revert(){if(this.reverted)return;const e=this.container;return _e(e,this),e._head||e.revert(),this._debug&&this.removeDebug(),this.reverted=!0,this}}const Ln=(e={})=>new Pn(e),zn=(e,t={})=>{let n=[],s=0;const r=t.from,i=t.reversed,o=t.ease,a=!H(o),l=a&&!H(o.ease)?o.ease:a?vt(o):null,c=t.grid,d=t.axis,u=H(r)||0===r||"first"===r,h="center"===r,p="last"===r,g=L(e),m=X(g?e[0]:e),y=g?X(e[1]):0,b=A.exec((g?e[1]:e)+f),_=t.start||0+(g?m:0);let v=u?0:B(r)?r:0;return(e,r,o,a)=>{if(h&&(v=(o-1)/2),p&&(v=o-1),!n.length){for(let e=0;e<o;e++){if(c){const t=h?(c[0]-1)/2:v%c[0],s=h?(c[1]-1)/2:se(v/c[0]),r=t-e%c[0],i=s-se(e/c[0]);let o=K(r*r+i*i);"x"===d&&(o=-r),"y"===d&&(o=-i),n.push(o)}else n.push(ee(v-e));s=ie(...n)}l&&(n=n.map((e=>l(e/s)*s))),i&&(n=n.map((e=>d?e<0?-1*e:-e:ee(s-e))))}const u=g?(y-m)/s:m;let f=(a?un(a,H(t.start)?a.iterationDuration:_):_)+(u*ue(n[r],2)||0);return t.modifier&&(f=t.modifier(f)),b&&(f=`${f}${b[2]}`),f}};var Bn=n(640),In=n(191);function jn(e){return null==e}var Hn={isNothing:jn,isObject:function(e){return"object"==typeof e&&null!==e},toArray:function(e){return Array.isArray(e)?e:jn(e)?[]:[e]},repeat:function(e,t){var n,s="";for(n=0;n<t;n+=1)s+=e;return s},isNegativeZero:function(e){return 0===e&&Number.NEGATIVE_INFINITY===1/e},extend:function(e,t){var n,s,r,i;if(t)for(n=0,s=(i=Object.keys(t)).length;n<s;n+=1)e[r=i[n]]=t[r];return e}};function Un(e,t){var n="",s=e.reason||"(unknown reason)";return e.mark?(e.mark.name&&(n+='in "'+e.mark.name+'" '),n+="("+(e.mark.line+1)+":"+(e.mark.column+1)+")",!t&&e.mark.snippet&&(n+="\n\n"+e.mark.snippet),s+" "+n):s}function Gn(e,t){Error.call(this),this.name="YAMLException",this.reason=e,this.mark=t,this.message=Un(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack||""}Gn.prototype=Object.create(Error.prototype),Gn.prototype.constructor=Gn,Gn.prototype.toString=function(e){return this.name+": "+Un(this,e)};var qn=Gn;function Vn(e,t,n,s,r){var i="",o="",a=Math.floor(r/2)-1;return s-t>a&&(t=s-a+(i=" ... ").length),n-s>a&&(n=s+a-(o=" ...").length),{str:i+e.slice(t,n).replace(/\t/g,"→")+o,pos:s-t+i.length}}function Wn(e,t){return Hn.repeat(" ",t-e.length)+e}var Yn=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],Xn=["scalar","sequence","mapping"],Jn=function(e,t){if(t=t||{},Object.keys(t).forEach((function(t){if(-1===Yn.indexOf(t))throw new qn('Unknown option "'+t+'" is met in definition of "'+e+'" YAML type.')})),this.options=t,this.tag=e,this.kind=t.kind||null,this.resolve=t.resolve||function(){return!0},this.construct=t.construct||function(e){return e},this.instanceOf=t.instanceOf||null,this.predicate=t.predicate||null,this.represent=t.represent||null,this.representName=t.representName||null,this.defaultStyle=t.defaultStyle||null,this.multi=t.multi||!1,this.styleAliases=function(e){var t={};return null!==e&&Object.keys(e).forEach((function(n){e[n].forEach((function(e){t[String(e)]=n}))})),t}(t.styleAliases||null),-1===Xn.indexOf(this.kind))throw new qn('Unknown kind "'+this.kind+'" is specified for "'+e+'" YAML type.')};function Kn(e,t){var n=[];return e[t].forEach((function(e){var t=n.length;n.forEach((function(n,s){n.tag===e.tag&&n.kind===e.kind&&n.multi===e.multi&&(t=s)})),n[t]=e})),n}function Zn(e){return this.extend(e)}Zn.prototype.extend=function(e){var t=[],n=[];if(e instanceof Jn)n.push(e);else if(Array.isArray(e))n=n.concat(e);else{if(!e||!Array.isArray(e.implicit)&&!Array.isArray(e.explicit))throw new qn("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");e.implicit&&(t=t.concat(e.implicit)),e.explicit&&(n=n.concat(e.explicit))}t.forEach((function(e){if(!(e instanceof Jn))throw new qn("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(e.loadKind&&"scalar"!==e.loadKind)throw new qn("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(e.multi)throw new qn("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")})),n.forEach((function(e){if(!(e instanceof Jn))throw new qn("Specified list of YAML types (or a single Type object) contains a non-Type object.")}));var s=Object.create(Zn.prototype);return s.implicit=(this.implicit||[]).concat(t),s.explicit=(this.explicit||[]).concat(n),s.compiledImplicit=Kn(s,"implicit"),s.compiledExplicit=Kn(s,"explicit"),s.compiledTypeMap=function(){var e,t,n={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}};function s(e){e.multi?(n.multi[e.kind].push(e),n.multi.fallback.push(e)):n[e.kind][e.tag]=n.fallback[e.tag]=e}for(e=0,t=arguments.length;e<t;e+=1)arguments[e].forEach(s);return n}(s.compiledImplicit,s.compiledExplicit),s};var Qn=Zn,es=new Jn("tag:yaml.org,2002:str",{kind:"scalar",construct:function(e){return null!==e?e:""}}),ts=new Jn("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(e){return null!==e?e:[]}}),ns=new Jn("tag:yaml.org,2002:map",{kind:"mapping",construct:function(e){return null!==e?e:{}}}),ss=new Qn({explicit:[es,ts,ns]}),rs=new Jn("tag:yaml.org,2002:null",{kind:"scalar",resolve:function(e){if(null===e)return!0;var t=e.length;return 1===t&&"~"===e||4===t&&("null"===e||"Null"===e||"NULL"===e)},construct:function(){return null},predicate:function(e){return null===e},represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"}),is=new Jn("tag:yaml.org,2002:bool",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t=e.length;return 4===t&&("true"===e||"True"===e||"TRUE"===e)||5===t&&("false"===e||"False"===e||"FALSE"===e)},construct:function(e){return"true"===e||"True"===e||"TRUE"===e},predicate:function(e){return"[object Boolean]"===Object.prototype.toString.call(e)},represent:{lowercase:function(e){return e?"true":"false"},uppercase:function(e){return e?"TRUE":"FALSE"},camelcase:function(e){return e?"True":"False"}},defaultStyle:"lowercase"});function os(e){return 48<=e&&e<=57||65<=e&&e<=70||97<=e&&e<=102}function as(e){return 48<=e&&e<=55}function ls(e){return 48<=e&&e<=57}var cs=new Jn("tag:yaml.org,2002:int",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t,n=e.length,s=0,r=!1;if(!n)return!1;if("-"!==(t=e[s])&&"+"!==t||(t=e[++s]),"0"===t){if(s+1===n)return!0;if("b"===(t=e[++s])){for(s++;s<n;s++)if("_"!==(t=e[s])){if("0"!==t&&"1"!==t)return!1;r=!0}return r&&"_"!==t}if("x"===t){for(s++;s<n;s++)if("_"!==(t=e[s])){if(!os(e.charCodeAt(s)))return!1;r=!0}return r&&"_"!==t}if("o"===t){for(s++;s<n;s++)if("_"!==(t=e[s])){if(!as(e.charCodeAt(s)))return!1;r=!0}return r&&"_"!==t}}if("_"===t)return!1;for(;s<n;s++)if("_"!==(t=e[s])){if(!ls(e.charCodeAt(s)))return!1;r=!0}return!(!r||"_"===t)},construct:function(e){var t,n=e,s=1;if(-1!==n.indexOf("_")&&(n=n.replace(/_/g,"")),"-"!==(t=n[0])&&"+"!==t||("-"===t&&(s=-1),t=(n=n.slice(1))[0]),"0"===n)return 0;if("0"===t){if("b"===n[1])return s*parseInt(n.slice(2),2);if("x"===n[1])return s*parseInt(n.slice(2),16);if("o"===n[1])return s*parseInt(n.slice(2),8)}return s*parseInt(n,10)},predicate:function(e){return"[object Number]"===Object.prototype.toString.call(e)&&e%1==0&&!Hn.isNegativeZero(e)},represent:{binary:function(e){return e>=0?"0b"+e.toString(2):"-0b"+e.toString(2).slice(1)},octal:function(e){return e>=0?"0o"+e.toString(8):"-0o"+e.toString(8).slice(1)},decimal:function(e){return e.toString(10)},hexadecimal:function(e){return e>=0?"0x"+e.toString(16).toUpperCase():"-0x"+e.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),ds=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$"),us=/^[-+]?[0-9]+e/,hs=new Jn("tag:yaml.org,2002:float",{kind:"scalar",resolve:function(e){return null!==e&&!(!ds.test(e)||"_"===e[e.length-1])},construct:function(e){var t,n;return n="-"===(t=e.replace(/_/g,"").toLowerCase())[0]?-1:1,"+-".indexOf(t[0])>=0&&(t=t.slice(1)),".inf"===t?1===n?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:".nan"===t?NaN:n*parseFloat(t,10)},predicate:function(e){return"[object Number]"===Object.prototype.toString.call(e)&&(e%1!=0||Hn.isNegativeZero(e))},represent:function(e,t){var n;if(isNaN(e))switch(t){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===e)switch(t){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===e)switch(t){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(Hn.isNegativeZero(e))return"-0.0";return n=e.toString(10),us.test(n)?n.replace("e",".e"):n},defaultStyle:"lowercase"}),ps=ss.extend({implicit:[rs,is,cs,hs]}),gs=ps,ms=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),fs=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$"),ys=new Jn("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:function(e){return null!==e&&(null!==ms.exec(e)||null!==fs.exec(e))},construct:function(e){var t,n,s,r,i,o,a,l,c=0,d=null;if(null===(t=ms.exec(e))&&(t=fs.exec(e)),null===t)throw new Error("Date resolve error");if(n=+t[1],s=+t[2]-1,r=+t[3],!t[4])return new Date(Date.UTC(n,s,r));if(i=+t[4],o=+t[5],a=+t[6],t[7]){for(c=t[7].slice(0,3);c.length<3;)c+="0";c=+c}return t[9]&&(d=6e4*(60*+t[10]+ +(t[11]||0)),"-"===t[9]&&(d=-d)),l=new Date(Date.UTC(n,s,r,i,o,a,c)),d&&l.setTime(l.getTime()-d),l},instanceOf:Date,represent:function(e){return e.toISOString()}}),bs=new Jn("tag:yaml.org,2002:merge",{kind:"scalar",resolve:function(e){return"<<"===e||null===e}}),_s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\n\r",vs=new Jn("tag:yaml.org,2002:binary",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t,n,s=0,r=e.length,i=_s;for(n=0;n<r;n++)if(!((t=i.indexOf(e.charAt(n)))>64)){if(t<0)return!1;s+=6}return s%8==0},construct:function(e){var t,n,s=e.replace(/[\r\n=]/g,""),r=s.length,i=_s,o=0,a=[];for(t=0;t<r;t++)t%4==0&&t&&(a.push(o>>16&255),a.push(o>>8&255),a.push(255&o)),o=o<<6|i.indexOf(s.charAt(t));return 0==(n=r%4*6)?(a.push(o>>16&255),a.push(o>>8&255),a.push(255&o)):18===n?(a.push(o>>10&255),a.push(o>>2&255)):12===n&&a.push(o>>4&255),new Uint8Array(a)},predicate:function(e){return"[object Uint8Array]"===Object.prototype.toString.call(e)},represent:function(e){var t,n,s="",r=0,i=e.length,o=_s;for(t=0;t<i;t++)t%3==0&&t&&(s+=o[r>>18&63],s+=o[r>>12&63],s+=o[r>>6&63],s+=o[63&r]),r=(r<<8)+e[t];return 0==(n=i%3)?(s+=o[r>>18&63],s+=o[r>>12&63],s+=o[r>>6&63],s+=o[63&r]):2===n?(s+=o[r>>10&63],s+=o[r>>4&63],s+=o[r<<2&63],s+=o[64]):1===n&&(s+=o[r>>2&63],s+=o[r<<4&63],s+=o[64],s+=o[64]),s}}),ws=Object.prototype.hasOwnProperty,Ss=Object.prototype.toString,xs=new Jn("tag:yaml.org,2002:omap",{kind:"sequence",resolve:function(e){if(null===e)return!0;var t,n,s,r,i,o=[],a=e;for(t=0,n=a.length;t<n;t+=1){if(s=a[t],i=!1,"[object Object]"!==Ss.call(s))return!1;for(r in s)if(ws.call(s,r)){if(i)return!1;i=!0}if(!i)return!1;if(-1!==o.indexOf(r))return!1;o.push(r)}return!0},construct:function(e){return null!==e?e:[]}}),$s=Object.prototype.toString,Cs=new Jn("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:function(e){if(null===e)return!0;var t,n,s,r,i,o=e;for(i=new Array(o.length),t=0,n=o.length;t<n;t+=1){if(s=o[t],"[object Object]"!==$s.call(s))return!1;if(1!==(r=Object.keys(s)).length)return!1;i[t]=[r[0],s[r[0]]]}return!0},construct:function(e){if(null===e)return[];var t,n,s,r,i,o=e;for(i=new Array(o.length),t=0,n=o.length;t<n;t+=1)s=o[t],r=Object.keys(s),i[t]=[r[0],s[r[0]]];return i}}),Ms=Object.prototype.hasOwnProperty,As=new Jn("tag:yaml.org,2002:set",{kind:"mapping",resolve:function(e){if(null===e)return!0;var t,n=e;for(t in n)if(Ms.call(n,t)&&null!==n[t])return!1;return!0},construct:function(e){return null!==e?e:{}}}),ks=gs.extend({implicit:[ys,bs],explicit:[vs,xs,Cs,As]}),Ds=Object.prototype.hasOwnProperty,Es=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,Ts=/[\x85\u2028\u2029]/,Rs=/[,\[\]\{\}]/,Os=/^(?:!|!!|![a-z\-]+!)$/i,Fs=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function Ns(e){return Object.prototype.toString.call(e)}function Ps(e){return 10===e||13===e}function Ls(e){return 9===e||32===e}function zs(e){return 9===e||32===e||10===e||13===e}function Bs(e){return 44===e||91===e||93===e||123===e||125===e}function Is(e){var t;return 48<=e&&e<=57?e-48:97<=(t=32|e)&&t<=102?t-97+10:-1}function js(e){return 120===e?2:117===e?4:85===e?8:0}function Hs(e){return 48<=e&&e<=57?e-48:-1}function Us(e){return 48===e?"\0":97===e?"":98===e?"\b":116===e||9===e?"\t":110===e?"\n":118===e?"\v":102===e?"\f":114===e?"\r":101===e?"":32===e?" ":34===e?'"':47===e?"/":92===e?"\\":78===e?"":95===e?" ":76===e?"\u2028":80===e?"\u2029":""}function Gs(e){return e<=65535?String.fromCharCode(e):String.fromCharCode(55296+(e-65536>>10),56320+(e-65536&1023))}for(var qs=new Array(256),Vs=new Array(256),Ws=0;Ws<256;Ws++)qs[Ws]=Us(Ws)?1:0,Vs[Ws]=Us(Ws);function Ys(e,t){this.input=e,this.filename=t.filename||null,this.schema=t.schema||ks,this.onWarning=t.onWarning||null,this.legacy=t.legacy||!1,this.json=t.json||!1,this.listener=t.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=e.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function Xs(e,t){var n={name:e.filename,buffer:e.input.slice(0,-1),position:e.position,line:e.line,column:e.position-e.lineStart};return n.snippet=function(e,t){if(t=Object.create(t||null),!e.buffer)return null;t.maxLength||(t.maxLength=79),"number"!=typeof t.indent&&(t.indent=1),"number"!=typeof t.linesBefore&&(t.linesBefore=3),"number"!=typeof t.linesAfter&&(t.linesAfter=2);for(var n,s=/\r?\n|\r|\0/g,r=[0],i=[],o=-1;n=s.exec(e.buffer);)i.push(n.index),r.push(n.index+n[0].length),e.position<=n.index&&o<0&&(o=r.length-2);o<0&&(o=r.length-1);var a,l,c="",d=Math.min(e.line+t.linesAfter,i.length).toString().length,u=t.maxLength-(t.indent+d+3);for(a=1;a<=t.linesBefore&&!(o-a<0);a++)l=Vn(e.buffer,r[o-a],i[o-a],e.position-(r[o]-r[o-a]),u),c=Hn.repeat(" ",t.indent)+Wn((e.line-a+1).toString(),d)+" | "+l.str+"\n"+c;for(l=Vn(e.buffer,r[o],i[o],e.position,u),c+=Hn.repeat(" ",t.indent)+Wn((e.line+1).toString(),d)+" | "+l.str+"\n",c+=Hn.repeat("-",t.indent+d+3+l.pos)+"^\n",a=1;a<=t.linesAfter&&!(o+a>=i.length);a++)l=Vn(e.buffer,r[o+a],i[o+a],e.position-(r[o]-r[o+a]),u),c+=Hn.repeat(" ",t.indent)+Wn((e.line+a+1).toString(),d)+" | "+l.str+"\n";return c.replace(/\n$/,"")}(n),new qn(t,n)}function Js(e,t){throw Xs(e,t)}function Ks(e,t){e.onWarning&&e.onWarning.call(null,Xs(e,t))}var Zs={YAML:function(e,t,n){var s,r,i;null!==e.version&&Js(e,"duplication of %YAML directive"),1!==n.length&&Js(e,"YAML directive accepts exactly one argument"),null===(s=/^([0-9]+)\.([0-9]+)$/.exec(n[0]))&&Js(e,"ill-formed argument of the YAML directive"),r=parseInt(s[1],10),i=parseInt(s[2],10),1!==r&&Js(e,"unacceptable YAML version of the document"),e.version=n[0],e.checkLineBreaks=i<2,1!==i&&2!==i&&Ks(e,"unsupported YAML version of the document")},TAG:function(e,t,n){var s,r;2!==n.length&&Js(e,"TAG directive accepts exactly two arguments"),s=n[0],r=n[1],Os.test(s)||Js(e,"ill-formed tag handle (first argument) of the TAG directive"),Ds.call(e.tagMap,s)&&Js(e,'there is a previously declared suffix for "'+s+'" tag handle'),Fs.test(r)||Js(e,"ill-formed tag prefix (second argument) of the TAG directive");try{r=decodeURIComponent(r)}catch(t){Js(e,"tag prefix is malformed: "+r)}e.tagMap[s]=r}};function Qs(e,t,n,s){var r,i,o,a;if(t<n){if(a=e.input.slice(t,n),s)for(r=0,i=a.length;r<i;r+=1)9===(o=a.charCodeAt(r))||32<=o&&o<=1114111||Js(e,"expected valid JSON character");else Es.test(a)&&Js(e,"the stream contains non-printable characters");e.result+=a}}function er(e,t,n,s){var r,i,o,a;for(Hn.isObject(n)||Js(e,"cannot merge mappings; the provided source object is unacceptable"),o=0,a=(r=Object.keys(n)).length;o<a;o+=1)i=r[o],Ds.call(t,i)||(t[i]=n[i],s[i]=!0)}function tr(e,t,n,s,r,i,o,a,l){var c,d;if(Array.isArray(r))for(c=0,d=(r=Array.prototype.slice.call(r)).length;c<d;c+=1)Array.isArray(r[c])&&Js(e,"nested arrays are not supported inside keys"),"object"==typeof r&&"[object Object]"===Ns(r[c])&&(r[c]="[object Object]");if("object"==typeof r&&"[object Object]"===Ns(r)&&(r="[object Object]"),r=String(r),null===t&&(t={}),"tag:yaml.org,2002:merge"===s)if(Array.isArray(i))for(c=0,d=i.length;c<d;c+=1)er(e,t,i[c],n);else er(e,t,i,n);else e.json||Ds.call(n,r)||!Ds.call(t,r)||(e.line=o||e.line,e.lineStart=a||e.lineStart,e.position=l||e.position,Js(e,"duplicated mapping key")),"__proto__"===r?Object.defineProperty(t,r,{configurable:!0,enumerable:!0,writable:!0,value:i}):t[r]=i,delete n[r];return t}function nr(e){var t;10===(t=e.input.charCodeAt(e.position))?e.position++:13===t?(e.position++,10===e.input.charCodeAt(e.position)&&e.position++):Js(e,"a line break is expected"),e.line+=1,e.lineStart=e.position,e.firstTabInLine=-1}function sr(e,t,n){for(var s=0,r=e.input.charCodeAt(e.position);0!==r;){for(;Ls(r);)9===r&&-1===e.firstTabInLine&&(e.firstTabInLine=e.position),r=e.input.charCodeAt(++e.position);if(t&&35===r)do{r=e.input.charCodeAt(++e.position)}while(10!==r&&13!==r&&0!==r);if(!Ps(r))break;for(nr(e),r=e.input.charCodeAt(e.position),s++,e.lineIndent=0;32===r;)e.lineIndent++,r=e.input.charCodeAt(++e.position)}return-1!==n&&0!==s&&e.lineIndent<n&&Ks(e,"deficient indentation"),s}function rr(e){var t,n=e.position;return!(45!==(t=e.input.charCodeAt(n))&&46!==t||t!==e.input.charCodeAt(n+1)||t!==e.input.charCodeAt(n+2)||(n+=3,0!==(t=e.input.charCodeAt(n))&&!zs(t)))}function ir(e,t){1===t?e.result+=" ":t>1&&(e.result+=Hn.repeat("\n",t-1))}function or(e,t){var n,s,r=e.tag,i=e.anchor,o=[],a=!1;if(-1!==e.firstTabInLine)return!1;for(null!==e.anchor&&(e.anchorMap[e.anchor]=o),s=e.input.charCodeAt(e.position);0!==s&&(-1!==e.firstTabInLine&&(e.position=e.firstTabInLine,Js(e,"tab characters must not be used in indentation")),45===s)&&zs(e.input.charCodeAt(e.position+1));)if(a=!0,e.position++,sr(e,!0,-1)&&e.lineIndent<=t)o.push(null),s=e.input.charCodeAt(e.position);else if(n=e.line,cr(e,t,3,!1,!0),o.push(e.result),sr(e,!0,-1),s=e.input.charCodeAt(e.position),(e.line===n||e.lineIndent>t)&&0!==s)Js(e,"bad indentation of a sequence entry");else if(e.lineIndent<t)break;return!!a&&(e.tag=r,e.anchor=i,e.kind="sequence",e.result=o,!0)}function ar(e){var t,n,s,r,i=!1,o=!1;if(33!==(r=e.input.charCodeAt(e.position)))return!1;if(null!==e.tag&&Js(e,"duplication of a tag property"),60===(r=e.input.charCodeAt(++e.position))?(i=!0,r=e.input.charCodeAt(++e.position)):33===r?(o=!0,n="!!",r=e.input.charCodeAt(++e.position)):n="!",t=e.position,i){do{r=e.input.charCodeAt(++e.position)}while(0!==r&&62!==r);e.position<e.length?(s=e.input.slice(t,e.position),r=e.input.charCodeAt(++e.position)):Js(e,"unexpected end of the stream within a verbatim tag")}else{for(;0!==r&&!zs(r);)33===r&&(o?Js(e,"tag suffix cannot contain exclamation marks"):(n=e.input.slice(t-1,e.position+1),Os.test(n)||Js(e,"named tag handle cannot contain such characters"),o=!0,t=e.position+1)),r=e.input.charCodeAt(++e.position);s=e.input.slice(t,e.position),Rs.test(s)&&Js(e,"tag suffix cannot contain flow indicator characters")}s&&!Fs.test(s)&&Js(e,"tag name cannot contain such characters: "+s);try{s=decodeURIComponent(s)}catch(t){Js(e,"tag name is malformed: "+s)}return i?e.tag=s:Ds.call(e.tagMap,n)?e.tag=e.tagMap[n]+s:"!"===n?e.tag="!"+s:"!!"===n?e.tag="tag:yaml.org,2002:"+s:Js(e,'undeclared tag handle "'+n+'"'),!0}function lr(e){var t,n;if(38!==(n=e.input.charCodeAt(e.position)))return!1;for(null!==e.anchor&&Js(e,"duplication of an anchor property"),n=e.input.charCodeAt(++e.position),t=e.position;0!==n&&!zs(n)&&!Bs(n);)n=e.input.charCodeAt(++e.position);return e.position===t&&Js(e,"name of an anchor node must contain at least one character"),e.anchor=e.input.slice(t,e.position),!0}function cr(e,t,n,s,r){var i,o,a,l,c,d,u,h,p,g=1,m=!1,f=!1;if(null!==e.listener&&e.listener("open",e),e.tag=null,e.anchor=null,e.kind=null,e.result=null,i=o=a=4===n||3===n,s&&sr(e,!0,-1)&&(m=!0,e.lineIndent>t?g=1:e.lineIndent===t?g=0:e.lineIndent<t&&(g=-1)),1===g)for(;ar(e)||lr(e);)sr(e,!0,-1)?(m=!0,a=i,e.lineIndent>t?g=1:e.lineIndent===t?g=0:e.lineIndent<t&&(g=-1)):a=!1;if(a&&(a=m||r),1!==g&&4!==n||(h=1===n||2===n?t:t+1,p=e.position-e.lineStart,1===g?a&&(or(e,p)||function(e,t,n){var s,r,i,o,a,l,c,d=e.tag,u=e.anchor,h={},p=Object.create(null),g=null,m=null,f=null,y=!1,b=!1;if(-1!==e.firstTabInLine)return!1;for(null!==e.anchor&&(e.anchorMap[e.anchor]=h),c=e.input.charCodeAt(e.position);0!==c;){if(y||-1===e.firstTabInLine||(e.position=e.firstTabInLine,Js(e,"tab characters must not be used in indentation")),s=e.input.charCodeAt(e.position+1),i=e.line,63!==c&&58!==c||!zs(s)){if(o=e.line,a=e.lineStart,l=e.position,!cr(e,n,2,!1,!0))break;if(e.line===i){for(c=e.input.charCodeAt(e.position);Ls(c);)c=e.input.charCodeAt(++e.position);if(58===c)zs(c=e.input.charCodeAt(++e.position))||Js(e,"a whitespace character is expected after the key-value separator within a block mapping"),y&&(tr(e,h,p,g,m,null,o,a,l),g=m=f=null),b=!0,y=!1,r=!1,g=e.tag,m=e.result;else{if(!b)return e.tag=d,e.anchor=u,!0;Js(e,"can not read an implicit mapping pair; a colon is missed")}}else{if(!b)return e.tag=d,e.anchor=u,!0;Js(e,"can not read a block mapping entry; a multiline key may not be an implicit key")}}else 63===c?(y&&(tr(e,h,p,g,m,null,o,a,l),g=m=f=null),b=!0,y=!0,r=!0):y?(y=!1,r=!0):Js(e,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),e.position+=1,c=s;if((e.line===i||e.lineIndent>t)&&(y&&(o=e.line,a=e.lineStart,l=e.position),cr(e,t,4,!0,r)&&(y?m=e.result:f=e.result),y||(tr(e,h,p,g,m,f,o,a,l),g=m=f=null),sr(e,!0,-1),c=e.input.charCodeAt(e.position)),(e.line===i||e.lineIndent>t)&&0!==c)Js(e,"bad indentation of a mapping entry");else if(e.lineIndent<t)break}return y&&tr(e,h,p,g,m,null,o,a,l),b&&(e.tag=d,e.anchor=u,e.kind="mapping",e.result=h),b}(e,p,h))||function(e,t){var n,s,r,i,o,a,l,c,d,u,h,p,g=!0,m=e.tag,f=e.anchor,y=Object.create(null);if(91===(p=e.input.charCodeAt(e.position)))o=93,c=!1,i=[];else{if(123!==p)return!1;o=125,c=!0,i={}}for(null!==e.anchor&&(e.anchorMap[e.anchor]=i),p=e.input.charCodeAt(++e.position);0!==p;){if(sr(e,!0,t),(p=e.input.charCodeAt(e.position))===o)return e.position++,e.tag=m,e.anchor=f,e.kind=c?"mapping":"sequence",e.result=i,!0;g?44===p&&Js(e,"expected the node content, but found ','"):Js(e,"missed comma between flow collection entries"),h=null,a=l=!1,63===p&&zs(e.input.charCodeAt(e.position+1))&&(a=l=!0,e.position++,sr(e,!0,t)),n=e.line,s=e.lineStart,r=e.position,cr(e,t,1,!1,!0),u=e.tag,d=e.result,sr(e,!0,t),p=e.input.charCodeAt(e.position),!l&&e.line!==n||58!==p||(a=!0,p=e.input.charCodeAt(++e.position),sr(e,!0,t),cr(e,t,1,!1,!0),h=e.result),c?tr(e,i,y,u,d,h,n,s,r):a?i.push(tr(e,null,y,u,d,h,n,s,r)):i.push(d),sr(e,!0,t),44===(p=e.input.charCodeAt(e.position))?(g=!0,p=e.input.charCodeAt(++e.position)):g=!1}Js(e,"unexpected end of the stream within a flow collection")}(e,h)?f=!0:(o&&function(e,t){var n,s,r,i,o=1,a=!1,l=!1,c=t,d=0,u=!1;if(124===(i=e.input.charCodeAt(e.position)))s=!1;else{if(62!==i)return!1;s=!0}for(e.kind="scalar",e.result="";0!==i;)if(43===(i=e.input.charCodeAt(++e.position))||45===i)1===o?o=43===i?3:2:Js(e,"repeat of a chomping mode identifier");else{if(!((r=Hs(i))>=0))break;0===r?Js(e,"bad explicit indentation width of a block scalar; it cannot be less than one"):l?Js(e,"repeat of an indentation width identifier"):(c=t+r-1,l=!0)}if(Ls(i)){do{i=e.input.charCodeAt(++e.position)}while(Ls(i));if(35===i)do{i=e.input.charCodeAt(++e.position)}while(!Ps(i)&&0!==i)}for(;0!==i;){for(nr(e),e.lineIndent=0,i=e.input.charCodeAt(e.position);(!l||e.lineIndent<c)&&32===i;)e.lineIndent++,i=e.input.charCodeAt(++e.position);if(!l&&e.lineIndent>c&&(c=e.lineIndent),Ps(i))d++;else{if(e.lineIndent<c){3===o?e.result+=Hn.repeat("\n",a?1+d:d):1===o&&a&&(e.result+="\n");break}for(s?Ls(i)?(u=!0,e.result+=Hn.repeat("\n",a?1+d:d)):u?(u=!1,e.result+=Hn.repeat("\n",d+1)):0===d?a&&(e.result+=" "):e.result+=Hn.repeat("\n",d):e.result+=Hn.repeat("\n",a?1+d:d),a=!0,l=!0,d=0,n=e.position;!Ps(i)&&0!==i;)i=e.input.charCodeAt(++e.position);Qs(e,n,e.position,!1)}}return!0}(e,h)||function(e,t){var n,s,r;if(39!==(n=e.input.charCodeAt(e.position)))return!1;for(e.kind="scalar",e.result="",e.position++,s=r=e.position;0!==(n=e.input.charCodeAt(e.position));)if(39===n){if(Qs(e,s,e.position,!0),39!==(n=e.input.charCodeAt(++e.position)))return!0;s=e.position,e.position++,r=e.position}else Ps(n)?(Qs(e,s,r,!0),ir(e,sr(e,!1,t)),s=r=e.position):e.position===e.lineStart&&rr(e)?Js(e,"unexpected end of the document within a single quoted scalar"):(e.position++,r=e.position);Js(e,"unexpected end of the stream within a single quoted scalar")}(e,h)||function(e,t){var n,s,r,i,o,a;if(34!==(a=e.input.charCodeAt(e.position)))return!1;for(e.kind="scalar",e.result="",e.position++,n=s=e.position;0!==(a=e.input.charCodeAt(e.position));){if(34===a)return Qs(e,n,e.position,!0),e.position++,!0;if(92===a){if(Qs(e,n,e.position,!0),Ps(a=e.input.charCodeAt(++e.position)))sr(e,!1,t);else if(a<256&&qs[a])e.result+=Vs[a],e.position++;else if((o=js(a))>0){for(r=o,i=0;r>0;r--)(o=Is(a=e.input.charCodeAt(++e.position)))>=0?i=(i<<4)+o:Js(e,"expected hexadecimal character");e.result+=Gs(i),e.position++}else Js(e,"unknown escape sequence");n=s=e.position}else Ps(a)?(Qs(e,n,s,!0),ir(e,sr(e,!1,t)),n=s=e.position):e.position===e.lineStart&&rr(e)?Js(e,"unexpected end of the document within a double quoted scalar"):(e.position++,s=e.position)}Js(e,"unexpected end of the stream within a double quoted scalar")}(e,h)?f=!0:function(e){var t,n,s;if(42!==(s=e.input.charCodeAt(e.position)))return!1;for(s=e.input.charCodeAt(++e.position),t=e.position;0!==s&&!zs(s)&&!Bs(s);)s=e.input.charCodeAt(++e.position);return e.position===t&&Js(e,"name of an alias node must contain at least one character"),n=e.input.slice(t,e.position),Ds.call(e.anchorMap,n)||Js(e,'unidentified alias "'+n+'"'),e.result=e.anchorMap[n],sr(e,!0,-1),!0}(e)?(f=!0,null===e.tag&&null===e.anchor||Js(e,"alias node should not have any properties")):function(e,t,n){var s,r,i,o,a,l,c,d,u=e.kind,h=e.result;if(zs(d=e.input.charCodeAt(e.position))||Bs(d)||35===d||38===d||42===d||33===d||124===d||62===d||39===d||34===d||37===d||64===d||96===d)return!1;if((63===d||45===d)&&(zs(s=e.input.charCodeAt(e.position+1))||n&&Bs(s)))return!1;for(e.kind="scalar",e.result="",r=i=e.position,o=!1;0!==d;){if(58===d){if(zs(s=e.input.charCodeAt(e.position+1))||n&&Bs(s))break}else if(35===d){if(zs(e.input.charCodeAt(e.position-1)))break}else{if(e.position===e.lineStart&&rr(e)||n&&Bs(d))break;if(Ps(d)){if(a=e.line,l=e.lineStart,c=e.lineIndent,sr(e,!1,-1),e.lineIndent>=t){o=!0,d=e.input.charCodeAt(e.position);continue}e.position=i,e.line=a,e.lineStart=l,e.lineIndent=c;break}}o&&(Qs(e,r,i,!1),ir(e,e.line-a),r=i=e.position,o=!1),Ls(d)||(i=e.position+1),d=e.input.charCodeAt(++e.position)}return Qs(e,r,i,!1),!!e.result||(e.kind=u,e.result=h,!1)}(e,h,1===n)&&(f=!0,null===e.tag&&(e.tag="?")),null!==e.anchor&&(e.anchorMap[e.anchor]=e.result)):0===g&&(f=a&&or(e,p))),null===e.tag)null!==e.anchor&&(e.anchorMap[e.anchor]=e.result);else if("?"===e.tag){for(null!==e.result&&"scalar"!==e.kind&&Js(e,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+e.kind+'"'),l=0,c=e.implicitTypes.length;l<c;l+=1)if((u=e.implicitTypes[l]).resolve(e.result)){e.result=u.construct(e.result),e.tag=u.tag,null!==e.anchor&&(e.anchorMap[e.anchor]=e.result);break}}else if("!"!==e.tag){if(Ds.call(e.typeMap[e.kind||"fallback"],e.tag))u=e.typeMap[e.kind||"fallback"][e.tag];else for(u=null,l=0,c=(d=e.typeMap.multi[e.kind||"fallback"]).length;l<c;l+=1)if(e.tag.slice(0,d[l].tag.length)===d[l].tag){u=d[l];break}u||Js(e,"unknown tag !<"+e.tag+">"),null!==e.result&&u.kind!==e.kind&&Js(e,"unacceptable node kind for !<"+e.tag+'> tag; it should be "'+u.kind+'", not "'+e.kind+'"'),u.resolve(e.result,e.tag)?(e.result=u.construct(e.result,e.tag),null!==e.anchor&&(e.anchorMap[e.anchor]=e.result)):Js(e,"cannot resolve a node with !<"+e.tag+"> explicit tag")}return null!==e.listener&&e.listener("close",e),null!==e.tag||null!==e.anchor||f}function dr(e){var t,n,s,r,i=e.position,o=!1;for(e.version=null,e.checkLineBreaks=e.legacy,e.tagMap=Object.create(null),e.anchorMap=Object.create(null);0!==(r=e.input.charCodeAt(e.position))&&(sr(e,!0,-1),r=e.input.charCodeAt(e.position),!(e.lineIndent>0||37!==r));){for(o=!0,r=e.input.charCodeAt(++e.position),t=e.position;0!==r&&!zs(r);)r=e.input.charCodeAt(++e.position);for(s=[],(n=e.input.slice(t,e.position)).length<1&&Js(e,"directive name must not be less than one character in length");0!==r;){for(;Ls(r);)r=e.input.charCodeAt(++e.position);if(35===r){do{r=e.input.charCodeAt(++e.position)}while(0!==r&&!Ps(r));break}if(Ps(r))break;for(t=e.position;0!==r&&!zs(r);)r=e.input.charCodeAt(++e.position);s.push(e.input.slice(t,e.position))}0!==r&&nr(e),Ds.call(Zs,n)?Zs[n](e,n,s):Ks(e,'unknown document directive "'+n+'"')}sr(e,!0,-1),0===e.lineIndent&&45===e.input.charCodeAt(e.position)&&45===e.input.charCodeAt(e.position+1)&&45===e.input.charCodeAt(e.position+2)?(e.position+=3,sr(e,!0,-1)):o&&Js(e,"directives end mark is expected"),cr(e,e.lineIndent-1,4,!1,!0),sr(e,!0,-1),e.checkLineBreaks&&Ts.test(e.input.slice(i,e.position))&&Ks(e,"non-ASCII line breaks are interpreted as content"),e.documents.push(e.result),e.position===e.lineStart&&rr(e)?46===e.input.charCodeAt(e.position)&&(e.position+=3,sr(e,!0,-1)):e.position<e.length-1&&Js(e,"end of the stream or a document separator is expected")}function ur(e,t){t=t||{},0!==(e=String(e)).length&&(10!==e.charCodeAt(e.length-1)&&13!==e.charCodeAt(e.length-1)&&(e+="\n"),65279===e.charCodeAt(0)&&(e=e.slice(1)));var n=new Ys(e,t),s=e.indexOf("\0");for(-1!==s&&(n.position=s,Js(n,"null byte is not allowed in input")),n.input+="\0";32===n.input.charCodeAt(n.position);)n.lineIndent+=1,n.position+=1;for(;n.position<n.length-1;)dr(n);return n.documents}var hr={loadAll:function(e,t,n){null!==t&&"object"==typeof t&&void 0===n&&(n=t,t=null);var s=ur(e,n);if("function"!=typeof t)return s;for(var r=0,i=s.length;r<i;r+=1)t(s[r])},load:function(e,t){var n=ur(e,t);if(0!==n.length){if(1===n.length)return n[0];throw new qn("expected a single document in the stream, but found more")}}},pr=Object.prototype.toString,gr=Object.prototype.hasOwnProperty,mr=65279,fr={0:"\\0",7:"\\a",8:"\\b",9:"\\t",10:"\\n",11:"\\v",12:"\\f",13:"\\r",27:"\\e",34:'\\"',92:"\\\\",133:"\\N",160:"\\_",8232:"\\L",8233:"\\P"},yr=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],br=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function _r(e){var t,n,s;if(t=e.toString(16).toUpperCase(),e<=255)n="x",s=2;else if(e<=65535)n="u",s=4;else{if(!(e<=4294967295))throw new qn("code point within a string may not be greater than 0xFFFFFFFF");n="U",s=8}return"\\"+n+Hn.repeat("0",s-t.length)+t}function vr(e){this.schema=e.schema||ks,this.indent=Math.max(1,e.indent||2),this.noArrayIndent=e.noArrayIndent||!1,this.skipInvalid=e.skipInvalid||!1,this.flowLevel=Hn.isNothing(e.flowLevel)?-1:e.flowLevel,this.styleMap=function(e,t){var n,s,r,i,o,a,l;if(null===t)return{};for(n={},r=0,i=(s=Object.keys(t)).length;r<i;r+=1)o=s[r],a=String(t[o]),"!!"===o.slice(0,2)&&(o="tag:yaml.org,2002:"+o.slice(2)),(l=e.compiledTypeMap.fallback[o])&&gr.call(l.styleAliases,a)&&(a=l.styleAliases[a]),n[o]=a;return n}(this.schema,e.styles||null),this.sortKeys=e.sortKeys||!1,this.lineWidth=e.lineWidth||80,this.noRefs=e.noRefs||!1,this.noCompatMode=e.noCompatMode||!1,this.condenseFlow=e.condenseFlow||!1,this.quotingType='"'===e.quotingType?2:1,this.forceQuotes=e.forceQuotes||!1,this.replacer="function"==typeof e.replacer?e.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function wr(e,t){for(var n,s=Hn.repeat(" ",t),r=0,i=-1,o="",a=e.length;r<a;)-1===(i=e.indexOf("\n",r))?(n=e.slice(r),r=a):(n=e.slice(r,i+1),r=i+1),n.length&&"\n"!==n&&(o+=s),o+=n;return o}function Sr(e,t){return"\n"+Hn.repeat(" ",e.indent*t)}function xr(e){return 32===e||9===e}function $r(e){return 32<=e&&e<=126||161<=e&&e<=55295&&8232!==e&&8233!==e||57344<=e&&e<=65533&&e!==mr||65536<=e&&e<=1114111}function Cr(e){return $r(e)&&e!==mr&&13!==e&&10!==e}function Mr(e,t,n){var s=Cr(e),r=s&&!xr(e);return(n?s:s&&44!==e&&91!==e&&93!==e&&123!==e&&125!==e)&&35!==e&&!(58===t&&!r)||Cr(t)&&!xr(t)&&35===e||58===t&&r}function Ar(e,t){var n,s=e.charCodeAt(t);return s>=55296&&s<=56319&&t+1<e.length&&(n=e.charCodeAt(t+1))>=56320&&n<=57343?1024*(s-55296)+n-56320+65536:s}function kr(e){return/^\n* /.test(e)}function Dr(e,t,n,s,r){e.dump=function(){if(0===t.length)return 2===e.quotingType?'""':"''";if(!e.noCompatMode&&(-1!==yr.indexOf(t)||br.test(t)))return 2===e.quotingType?'"'+t+'"':"'"+t+"'";var i=e.indent*Math.max(1,n),o=-1===e.lineWidth?-1:Math.max(Math.min(e.lineWidth,40),e.lineWidth-i),a=s||e.flowLevel>-1&&n>=e.flowLevel;switch(function(e,t,n,s,r,i,o,a){var l,c=0,d=null,u=!1,h=!1,p=-1!==s,g=-1,m=function(e){return $r(e)&&e!==mr&&!xr(e)&&45!==e&&63!==e&&58!==e&&44!==e&&91!==e&&93!==e&&123!==e&&125!==e&&35!==e&&38!==e&&42!==e&&33!==e&&124!==e&&61!==e&&62!==e&&39!==e&&34!==e&&37!==e&&64!==e&&96!==e}(Ar(e,0))&&function(e){return!xr(e)&&58!==e}(Ar(e,e.length-1));if(t||o)for(l=0;l<e.length;c>=65536?l+=2:l++){if(!$r(c=Ar(e,l)))return 5;m=m&&Mr(c,d,a),d=c}else{for(l=0;l<e.length;c>=65536?l+=2:l++){if(10===(c=Ar(e,l)))u=!0,p&&(h=h||l-g-1>s&&" "!==e[g+1],g=l);else if(!$r(c))return 5;m=m&&Mr(c,d,a),d=c}h=h||p&&l-g-1>s&&" "!==e[g+1]}return u||h?n>9&&kr(e)?5:o?2===i?5:2:h?4:3:!m||o||r(e)?2===i?5:2:1}(t,a,e.indent,o,(function(t){return function(e,t){var n,s;for(n=0,s=e.implicitTypes.length;n<s;n+=1)if(e.implicitTypes[n].resolve(t))return!0;return!1}(e,t)}),e.quotingType,e.forceQuotes&&!s,r)){case 1:return t;case 2:return"'"+t.replace(/'/g,"''")+"'";case 3:return"|"+Er(t,e.indent)+Tr(wr(t,i));case 4:return">"+Er(t,e.indent)+Tr(wr(function(e,t){for(var n,s,r,i=/(\n+)([^\n]*)/g,o=(r=-1!==(r=e.indexOf("\n"))?r:e.length,i.lastIndex=r,Rr(e.slice(0,r),t)),a="\n"===e[0]||" "===e[0];s=i.exec(e);){var l=s[1],c=s[2];n=" "===c[0],o+=l+(a||n||""===c?"":"\n")+Rr(c,t),a=n}return o}(t,o),i));case 5:return'"'+function(e){for(var t,n="",s=0,r=0;r<e.length;s>=65536?r+=2:r++)s=Ar(e,r),!(t=fr[s])&&$r(s)?(n+=e[r],s>=65536&&(n+=e[r+1])):n+=t||_r(s);return n}(t)+'"';default:throw new qn("impossible error: invalid scalar style")}}()}function Er(e,t){var n=kr(e)?String(t):"",s="\n"===e[e.length-1];return n+(!s||"\n"!==e[e.length-2]&&"\n"!==e?s?"":"-":"+")+"\n"}function Tr(e){return"\n"===e[e.length-1]?e.slice(0,-1):e}function Rr(e,t){if(""===e||" "===e[0])return e;for(var n,s,r=/ [^ ]/g,i=0,o=0,a=0,l="";n=r.exec(e);)(a=n.index)-i>t&&(s=o>i?o:a,l+="\n"+e.slice(i,s),i=s+1),o=a;return l+="\n",e.length-i>t&&o>i?l+=e.slice(i,o)+"\n"+e.slice(o+1):l+=e.slice(i),l.slice(1)}function Or(e,t,n,s){var r,i,o,a="",l=e.tag;for(r=0,i=n.length;r<i;r+=1)o=n[r],e.replacer&&(o=e.replacer.call(n,String(r),o)),(Nr(e,t+1,o,!0,!0,!1,!0)||void 0===o&&Nr(e,t+1,null,!0,!0,!1,!0))&&(s&&""===a||(a+=Sr(e,t)),e.dump&&10===e.dump.charCodeAt(0)?a+="-":a+="- ",a+=e.dump);e.tag=l,e.dump=a||"[]"}function Fr(e,t,n){var s,r,i,o,a,l;for(i=0,o=(r=n?e.explicitTypes:e.implicitTypes).length;i<o;i+=1)if(((a=r[i]).instanceOf||a.predicate)&&(!a.instanceOf||"object"==typeof t&&t instanceof a.instanceOf)&&(!a.predicate||a.predicate(t))){if(n?a.multi&&a.representName?e.tag=a.representName(t):e.tag=a.tag:e.tag="?",a.represent){if(l=e.styleMap[a.tag]||a.defaultStyle,"[object Function]"===pr.call(a.represent))s=a.represent(t,l);else{if(!gr.call(a.represent,l))throw new qn("!<"+a.tag+'> tag resolver accepts not "'+l+'" style');s=a.represent[l](t,l)}e.dump=s}return!0}return!1}function Nr(e,t,n,s,r,i,o){e.tag=null,e.dump=n,Fr(e,n,!1)||Fr(e,n,!0);var a,l=pr.call(e.dump),c=s;s&&(s=e.flowLevel<0||e.flowLevel>t);var d,u,h="[object Object]"===l||"[object Array]"===l;if(h&&(u=-1!==(d=e.duplicates.indexOf(n))),(null!==e.tag&&"?"!==e.tag||u||2!==e.indent&&t>0)&&(r=!1),u&&e.usedDuplicates[d])e.dump="*ref_"+d;else{if(h&&u&&!e.usedDuplicates[d]&&(e.usedDuplicates[d]=!0),"[object Object]"===l)s&&0!==Object.keys(e.dump).length?(function(e,t,n,s){var r,i,o,a,l,c,d="",u=e.tag,h=Object.keys(n);if(!0===e.sortKeys)h.sort();else if("function"==typeof e.sortKeys)h.sort(e.sortKeys);else if(e.sortKeys)throw new qn("sortKeys must be a boolean or a function");for(r=0,i=h.length;r<i;r+=1)c="",s&&""===d||(c+=Sr(e,t)),a=n[o=h[r]],e.replacer&&(a=e.replacer.call(n,o,a)),Nr(e,t+1,o,!0,!0,!0)&&((l=null!==e.tag&&"?"!==e.tag||e.dump&&e.dump.length>1024)&&(e.dump&&10===e.dump.charCodeAt(0)?c+="?":c+="? "),c+=e.dump,l&&(c+=Sr(e,t)),Nr(e,t+1,a,!0,l)&&(e.dump&&10===e.dump.charCodeAt(0)?c+=":":c+=": ",d+=c+=e.dump));e.tag=u,e.dump=d||"{}"}(e,t,e.dump,r),u&&(e.dump="&ref_"+d+e.dump)):(function(e,t,n){var s,r,i,o,a,l="",c=e.tag,d=Object.keys(n);for(s=0,r=d.length;s<r;s+=1)a="",""!==l&&(a+=", "),e.condenseFlow&&(a+='"'),o=n[i=d[s]],e.replacer&&(o=e.replacer.call(n,i,o)),Nr(e,t,i,!1,!1)&&(e.dump.length>1024&&(a+="? "),a+=e.dump+(e.condenseFlow?'"':"")+":"+(e.condenseFlow?"":" "),Nr(e,t,o,!1,!1)&&(l+=a+=e.dump));e.tag=c,e.dump="{"+l+"}"}(e,t,e.dump),u&&(e.dump="&ref_"+d+" "+e.dump));else if("[object Array]"===l)s&&0!==e.dump.length?(e.noArrayIndent&&!o&&t>0?Or(e,t-1,e.dump,r):Or(e,t,e.dump,r),u&&(e.dump="&ref_"+d+e.dump)):(function(e,t,n){var s,r,i,o="",a=e.tag;for(s=0,r=n.length;s<r;s+=1)i=n[s],e.replacer&&(i=e.replacer.call(n,String(s),i)),(Nr(e,t,i,!1,!1)||void 0===i&&Nr(e,t,null,!1,!1))&&(""!==o&&(o+=","+(e.condenseFlow?"":" ")),o+=e.dump);e.tag=a,e.dump="["+o+"]"}(e,t,e.dump),u&&(e.dump="&ref_"+d+" "+e.dump));else{if("[object String]"!==l){if("[object Undefined]"===l)return!1;if(e.skipInvalid)return!1;throw new qn("unacceptable kind of an object to dump "+l)}"?"!==e.tag&&Dr(e,e.dump,t,i,c)}null!==e.tag&&"?"!==e.tag&&(a=encodeURI("!"===e.tag[0]?e.tag.slice(1):e.tag).replace(/!/g,"%21"),a="!"===e.tag[0]?"!"+a:"tag:yaml.org,2002:"===a.slice(0,18)?"!!"+a.slice(18):"!<"+a+">",e.dump=a+" "+e.dump)}return!0}function Pr(e,t){var n,s,r=[],i=[];for(Lr(e,r,i),n=0,s=i.length;n<s;n+=1)t.duplicates.push(r[i[n]]);t.usedDuplicates=new Array(s)}function Lr(e,t,n){var s,r,i;if(null!==e&&"object"==typeof e)if(-1!==(r=t.indexOf(e)))-1===n.indexOf(r)&&n.push(r);else if(t.push(e),Array.isArray(e))for(r=0,i=e.length;r<i;r+=1)Lr(e[r],t,n);else for(r=0,i=(s=Object.keys(e)).length;r<i;r+=1)Lr(e[s[r]],t,n)}function zr(e,t){return function(){throw new Error("Function yaml."+e+" is removed in js-yaml 4. Use yaml."+t+" instead, which is now safe by default.")}}const Br={Type:Jn,Schema:Qn,FAILSAFE_SCHEMA:ss,JSON_SCHEMA:ps,CORE_SCHEMA:gs,DEFAULT_SCHEMA:ks,load:hr.load,loadAll:hr.loadAll,dump:function(e,t){var n=new vr(t=t||{});n.noRefs||Pr(e,n);var s=e;return n.replacer&&(s=n.replacer.call({"":s},"",s)),Nr(n,0,s,!0,!0)?n.dump+"\n":""},YAMLException:qn,types:{binary:vs,float:hs,map:ns,null:rs,pairs:Cs,set:As,timestamp:ys,bool:is,int:cs,merge:bs,omap:xs,seq:ts,str:es},safeLoad:zr("safeLoad","load"),safeLoadAll:zr("safeLoadAll","loadAll"),safeDump:zr("safeDump","dump")};try{"undefined"==typeof window||window.jsyaml||(window.jsyaml={load:Br.load,dump:Br.dump})}catch{}async function Ir(e){try{const t=await async function(e){try{const t=await fetch(e);if(t.ok)return await t.text()}catch(e){throw In.lr.error("[fetchYAML] Error fetching YAML file ",e),e}}(e);return Br.load(t)}catch(e){throw In.lr.error("[readYamlFile] Failed to parse YAML file",e.message),e}}function jr(){return window.cblcars=window.cblcars||{},window.cblcars.msd=window.cblcars.msd||{},window.cblcars.msd.svg_templates=window.cblcars.msd.svg_templates||{},window.cblcars.msd.svg_templates}async function Hr(e,t){const n=jr();if(n[e])return n[e];try{const s=await fetch(t);if(!s.ok)return void In.lr.error(`[loadSVGToCache] Failed to fetch SVG [${t}] for key [${e}]: ${s.status} ${s.statusText}`);let r=await s.text();return r=r.replace(/<svg([^>]*)>/i,((e,t)=>`<svg width="100%" height="100%"${t.replace(/\s(width|height)=["'][^"']*["']/gi,"")}>`)),n[e]=r,In.lr.debug(`[loadSVGToCache] Loaded SVG [${e}] from [${t}]`),r}catch(n){return void In.lr.error(`[loadSVGToCache] Error loading SVG [${e}] from [${t}]`,n)}}function Ur(e){return jr()[e]}var Gr=n(243),qr=n(41);class Vr extends qr.A{_formControls;_cardType;constructor(e){super(),this._formControls={},this._cardType="",this._cardType=e,this._initializationPromise=this._initialize()}async _initialize(){try{const e=await fetch(`${Bn.iM}/${this._cardType}.json`);if(!e.ok)throw new Error(`Form definition not found for card type: ${this._cardType}`);const t=await e.json();In.lr.debug("Loaded formControls:",t),this._formControls=t,this._userStyles=Gr.css`${(0,Gr.unsafeCSS)(t.css&&t.css.cssText||"")}`,this._mergeUserStyles=t?.css?.mergeUserStyles??!0,this.requestUpdate()}catch(e){In.lr.error("Error fetching editor form definition: ",e)}}async setConfig(e){await this._initializationPromise,super.setConfig(e),this.requestUpdate()}render(){if(!this._hass)return Gr.html`<ha-alert alert-type="error" title="Error">Home Assistant instance is missing.</ha-alert>`;if(!this._config)return Gr.html`<ha-alert alert-type="error" title="Error">Card configuration is missing.</ha-alert>`;if(!this._formControls)return Gr.html`<ha-alert alert-type="error" title="Error">Form controls are missing.</ha-alert>`;try{const e=this._formControls;return this.generateForm(e)}catch(e){return In.lr.error("Error rendering configuration form:",e),Gr.html`<ha-alert alert-type="error" title="Error">Error rendering form: ${e.message}</ha-alert>`}}}function Wr(e){window.cblcars._loadedFonts=window.cblcars._loadedFonts||new Set;const t=e.split(",").map((e=>e.trim().replace(/^['"]|['"]$/g,"")));t.forEach((e=>{if(e.startsWith("http://")||e.startsWith("https://")){const t=e;if(window.cblcars._loadedFonts.has(t))return;if(document.querySelector(`link[href="${t}"]`))return void window.cblcars._loadedFonts.add(t);const n=document.createElement("link");return n.rel="stylesheet",n.href=t,document.head.appendChild(n),window.cblcars._loadedFonts.add(t),void In.lr.info(`[loadFont] Loaded remote font from: ${t}`)}if(!e.startsWith("cb-lcars_"))return;const t=`/hacsfiles/cb-lcars/fonts/${e}.css`,n=e;if(window.cblcars._loadedFonts.has(n))return;if(document.querySelector(`link[href="${t}"]`))return void window.cblcars._loadedFonts.add(n);const s=document.createElement("link");s.rel="stylesheet",s.href=t,document.head.appendChild(s),window.cblcars._loadedFonts.add(n),In.lr.info(`[loadFont] Loaded local font: ${e}`)}))}function Yr(e,t,n,s){var r,i=arguments.length,o=i<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(i<3?r(o):i>3?r(t,n,o):r(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o}const Xr=window,Jr=Xr.ShadowRoot&&(void 0===Xr.ShadyCSS||Xr.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,Kr=Symbol(),Zr=new WeakMap;class Qr{constructor(e,t,n){if(this._$cssResult$=!0,n!==Kr)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=e,this.t=t}get styleSheet(){let e=this.o;const t=this.t;if(Jr&&void 0===e){const n=void 0!==t&&1===t.length;n&&(e=Zr.get(t)),void 0===e&&((this.o=e=new CSSStyleSheet).replaceSync(this.cssText),n&&Zr.set(t,e))}return e}toString(){return this.cssText}}const ei=Jr?e=>e:e=>e instanceof CSSStyleSheet?(e=>{let t="";for(const n of e.cssRules)t+=n.cssText;return(e=>new Qr("string"==typeof e?e:e+"",void 0,Kr))(t)})(e):e;var ti;const ni=window,si=ni.trustedTypes,ri=si?si.emptyScript:"",ii=ni.reactiveElementPolyfillSupport,oi={toAttribute(e,t){switch(t){case Boolean:e=e?ri:null;break;case Object:case Array:e=null==e?e:JSON.stringify(e)}return e},fromAttribute(e,t){let n=e;switch(t){case Boolean:n=null!==e;break;case Number:n=null===e?null:Number(e);break;case Object:case Array:try{n=JSON.parse(e)}catch(e){n=null}}return n}},ai=(e,t)=>t!==e&&(t==t||e==e),li={attribute:!0,type:String,converter:oi,reflect:!1,hasChanged:ai},ci="finalized";class di extends HTMLElement{constructor(){super(),this._$Ei=new Map,this.isUpdatePending=!1,this.hasUpdated=!1,this._$El=null,this.u()}static addInitializer(e){var t;this.finalize(),(null!==(t=this.h)&&void 0!==t?t:this.h=[]).push(e)}static get observedAttributes(){this.finalize();const e=[];return this.elementProperties.forEach(((t,n)=>{const s=this._$Ep(n,t);void 0!==s&&(this._$Ev.set(s,n),e.push(s))})),e}static createProperty(e,t=li){if(t.state&&(t.attribute=!1),this.finalize(),this.elementProperties.set(e,t),!t.noAccessor&&!this.prototype.hasOwnProperty(e)){const n="symbol"==typeof e?Symbol():"__"+e,s=this.getPropertyDescriptor(e,n,t);void 0!==s&&Object.defineProperty(this.prototype,e,s)}}static getPropertyDescriptor(e,t,n){return{get(){return this[t]},set(s){const r=this[e];this[t]=s,this.requestUpdate(e,r,n)},configurable:!0,enumerable:!0}}static getPropertyOptions(e){return this.elementProperties.get(e)||li}static finalize(){if(this.hasOwnProperty(ci))return!1;this[ci]=!0;const e=Object.getPrototypeOf(this);if(e.finalize(),void 0!==e.h&&(this.h=[...e.h]),this.elementProperties=new Map(e.elementProperties),this._$Ev=new Map,this.hasOwnProperty("properties")){const e=this.properties,t=[...Object.getOwnPropertyNames(e),...Object.getOwnPropertySymbols(e)];for(const n of t)this.createProperty(n,e[n])}return this.elementStyles=this.finalizeStyles(this.styles),!0}static finalizeStyles(e){const t=[];if(Array.isArray(e)){const n=new Set(e.flat(1/0).reverse());for(const e of n)t.unshift(ei(e))}else void 0!==e&&t.push(ei(e));return t}static _$Ep(e,t){const n=t.attribute;return!1===n?void 0:"string"==typeof n?n:"string"==typeof e?e.toLowerCase():void 0}u(){var e;this._$E_=new Promise((e=>this.enableUpdating=e)),this._$AL=new Map,this._$Eg(),this.requestUpdate(),null===(e=this.constructor.h)||void 0===e||e.forEach((e=>e(this)))}addController(e){var t,n;(null!==(t=this._$ES)&&void 0!==t?t:this._$ES=[]).push(e),void 0!==this.renderRoot&&this.isConnected&&(null===(n=e.hostConnected)||void 0===n||n.call(e))}removeController(e){var t;null===(t=this._$ES)||void 0===t||t.splice(this._$ES.indexOf(e)>>>0,1)}_$Eg(){this.constructor.elementProperties.forEach(((e,t)=>{this.hasOwnProperty(t)&&(this._$Ei.set(t,this[t]),delete this[t])}))}createRenderRoot(){var e;const t=null!==(e=this.shadowRoot)&&void 0!==e?e:this.attachShadow(this.constructor.shadowRootOptions);return((e,t)=>{Jr?e.adoptedStyleSheets=t.map((e=>e instanceof CSSStyleSheet?e:e.styleSheet)):t.forEach((t=>{const n=document.createElement("style"),s=Xr.litNonce;void 0!==s&&n.setAttribute("nonce",s),n.textContent=t.cssText,e.appendChild(n)}))})(t,this.constructor.elementStyles),t}connectedCallback(){var e;void 0===this.renderRoot&&(this.renderRoot=this.createRenderRoot()),this.enableUpdating(!0),null===(e=this._$ES)||void 0===e||e.forEach((e=>{var t;return null===(t=e.hostConnected)||void 0===t?void 0:t.call(e)}))}enableUpdating(e){}disconnectedCallback(){var e;null===(e=this._$ES)||void 0===e||e.forEach((e=>{var t;return null===(t=e.hostDisconnected)||void 0===t?void 0:t.call(e)}))}attributeChangedCallback(e,t,n){this._$AK(e,n)}_$EO(e,t,n=li){var s;const r=this.constructor._$Ep(e,n);if(void 0!==r&&!0===n.reflect){const i=(void 0!==(null===(s=n.converter)||void 0===s?void 0:s.toAttribute)?n.converter:oi).toAttribute(t,n.type);this._$El=e,null==i?this.removeAttribute(r):this.setAttribute(r,i),this._$El=null}}_$AK(e,t){var n;const s=this.constructor,r=s._$Ev.get(e);if(void 0!==r&&this._$El!==r){const e=s.getPropertyOptions(r),i="function"==typeof e.converter?{fromAttribute:e.converter}:void 0!==(null===(n=e.converter)||void 0===n?void 0:n.fromAttribute)?e.converter:oi;this._$El=r,this[r]=i.fromAttribute(t,e.type),this._$El=null}}requestUpdate(e,t,n){let s=!0;void 0!==e&&(((n=n||this.constructor.getPropertyOptions(e)).hasChanged||ai)(this[e],t)?(this._$AL.has(e)||this._$AL.set(e,t),!0===n.reflect&&this._$El!==e&&(void 0===this._$EC&&(this._$EC=new Map),this._$EC.set(e,n))):s=!1),!this.isUpdatePending&&s&&(this._$E_=this._$Ej())}async _$Ej(){this.isUpdatePending=!0;try{await this._$E_}catch(e){Promise.reject(e)}const e=this.scheduleUpdate();return null!=e&&await e,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){var e;if(!this.isUpdatePending)return;this.hasUpdated,this._$Ei&&(this._$Ei.forEach(((e,t)=>this[t]=e)),this._$Ei=void 0);let t=!1;const n=this._$AL;try{t=this.shouldUpdate(n),t?(this.willUpdate(n),null===(e=this._$ES)||void 0===e||e.forEach((e=>{var t;return null===(t=e.hostUpdate)||void 0===t?void 0:t.call(e)})),this.update(n)):this._$Ek()}catch(e){throw t=!1,this._$Ek(),e}t&&this._$AE(n)}willUpdate(e){}_$AE(e){var t;null===(t=this._$ES)||void 0===t||t.forEach((e=>{var t;return null===(t=e.hostUpdated)||void 0===t?void 0:t.call(e)})),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(e)),this.updated(e)}_$Ek(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$E_}shouldUpdate(e){return!0}update(e){void 0!==this._$EC&&(this._$EC.forEach(((e,t)=>this._$EO(t,this[t],e))),this._$EC=void 0),this._$Ek()}updated(e){}firstUpdated(e){}}var ui;di[ci]=!0,di.elementProperties=new Map,di.elementStyles=[],di.shadowRootOptions={mode:"open"},null==ii||ii({ReactiveElement:di}),(null!==(ti=ni.reactiveElementVersions)&&void 0!==ti?ti:ni.reactiveElementVersions=[]).push("1.6.2");const hi=window,pi=hi.trustedTypes,gi=pi?pi.createPolicy("lit-html",{createHTML:e=>e}):void 0,mi="$lit$",fi=`lit$${(Math.random()+"").slice(9)}$`,yi="?"+fi,bi=`<${yi}>`,_i=document,vi=()=>_i.createComment(""),wi=e=>null===e||"object"!=typeof e&&"function"!=typeof e,Si=Array.isArray,xi="[ \t\n\f\r]",$i=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,Ci=/-->/g,Mi=/>/g,Ai=RegExp(`>|${xi}(?:([^\\s"'>=/]+)(${xi}*=${xi}*(?:[^ \t\n\f\r"'\`<>=]|("|')|))|$)`,"g"),ki=/'/g,Di=/"/g,Ei=/^(?:script|style|textarea|title)$/i,Ti=(e,...t)=>({_$litType$:1,strings:e,values:t}),Ri=Symbol.for("lit-noChange"),Oi=Symbol.for("lit-nothing"),Fi=new WeakMap,Ni=_i.createTreeWalker(_i,129,null,!1);function Pi(e,t){if(!Array.isArray(e)||!e.hasOwnProperty("raw"))throw Error("invalid template strings array");return void 0!==gi?gi.createHTML(t):t}class Li{constructor({strings:e,_$litType$:t},n){let s;this.parts=[];let r=0,i=0;const o=e.length-1,a=this.parts,[l,c]=((e,t)=>{const n=e.length-1,s=[];let r,i=2===t?"<svg>":"",o=$i;for(let t=0;t<n;t++){const n=e[t];let a,l,c=-1,d=0;for(;d<n.length&&(o.lastIndex=d,l=o.exec(n),null!==l);)d=o.lastIndex,o===$i?"!--"===l[1]?o=Ci:void 0!==l[1]?o=Mi:void 0!==l[2]?(Ei.test(l[2])&&(r=RegExp("</"+l[2],"g")),o=Ai):void 0!==l[3]&&(o=Ai):o===Ai?">"===l[0]?(o=null!=r?r:$i,c=-1):void 0===l[1]?c=-2:(c=o.lastIndex-l[2].length,a=l[1],o=void 0===l[3]?Ai:'"'===l[3]?Di:ki):o===Di||o===ki?o=Ai:o===Ci||o===Mi?o=$i:(o=Ai,r=void 0);const u=o===Ai&&e[t+1].startsWith("/>")?" ":"";i+=o===$i?n+bi:c>=0?(s.push(a),n.slice(0,c)+mi+n.slice(c)+fi+u):n+fi+(-2===c?(s.push(void 0),t):u)}return[Pi(e,i+(e[n]||"<?>")+(2===t?"</svg>":"")),s]})(e,t);if(this.el=Li.createElement(l,n),Ni.currentNode=this.el.content,2===t){const e=this.el.content,t=e.firstChild;t.remove(),e.append(...t.childNodes)}for(;null!==(s=Ni.nextNode())&&a.length<o;){if(1===s.nodeType){if(s.hasAttributes()){const e=[];for(const t of s.getAttributeNames())if(t.endsWith(mi)||t.startsWith(fi)){const n=c[i++];if(e.push(t),void 0!==n){const e=s.getAttribute(n.toLowerCase()+mi).split(fi),t=/([.?@])?(.*)/.exec(n);a.push({type:1,index:r,name:t[2],strings:e,ctor:"."===t[1]?Hi:"?"===t[1]?Gi:"@"===t[1]?qi:ji})}else a.push({type:6,index:r})}for(const t of e)s.removeAttribute(t)}if(Ei.test(s.tagName)){const e=s.textContent.split(fi),t=e.length-1;if(t>0){s.textContent=pi?pi.emptyScript:"";for(let n=0;n<t;n++)s.append(e[n],vi()),Ni.nextNode(),a.push({type:2,index:++r});s.append(e[t],vi())}}}else if(8===s.nodeType)if(s.data===yi)a.push({type:2,index:r});else{let e=-1;for(;-1!==(e=s.data.indexOf(fi,e+1));)a.push({type:7,index:r}),e+=fi.length-1}r++}}static createElement(e,t){const n=_i.createElement("template");return n.innerHTML=e,n}}function zi(e,t,n=e,s){var r,i,o,a;if(t===Ri)return t;let l=void 0!==s?null===(r=n._$Co)||void 0===r?void 0:r[s]:n._$Cl;const c=wi(t)?void 0:t._$litDirective$;return(null==l?void 0:l.constructor)!==c&&(null===(i=null==l?void 0:l._$AO)||void 0===i||i.call(l,!1),void 0===c?l=void 0:(l=new c(e),l._$AT(e,n,s)),void 0!==s?(null!==(o=(a=n)._$Co)&&void 0!==o?o:a._$Co=[])[s]=l:n._$Cl=l),void 0!==l&&(t=zi(e,l._$AS(e,t.values),l,s)),t}class Bi{constructor(e,t){this._$AV=[],this._$AN=void 0,this._$AD=e,this._$AM=t}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}u(e){var t;const{el:{content:n},parts:s}=this._$AD,r=(null!==(t=null==e?void 0:e.creationScope)&&void 0!==t?t:_i).importNode(n,!0);Ni.currentNode=r;let i=Ni.nextNode(),o=0,a=0,l=s[0];for(;void 0!==l;){if(o===l.index){let t;2===l.type?t=new Ii(i,i.nextSibling,this,e):1===l.type?t=new l.ctor(i,l.name,l.strings,this,e):6===l.type&&(t=new Vi(i,this,e)),this._$AV.push(t),l=s[++a]}o!==(null==l?void 0:l.index)&&(i=Ni.nextNode(),o++)}return Ni.currentNode=_i,r}v(e){let t=0;for(const n of this._$AV)void 0!==n&&(void 0!==n.strings?(n._$AI(e,n,t),t+=n.strings.length-2):n._$AI(e[t])),t++}}class Ii{constructor(e,t,n,s){var r;this.type=2,this._$AH=Oi,this._$AN=void 0,this._$AA=e,this._$AB=t,this._$AM=n,this.options=s,this._$Cp=null===(r=null==s?void 0:s.isConnected)||void 0===r||r}get _$AU(){var e,t;return null!==(t=null===(e=this._$AM)||void 0===e?void 0:e._$AU)&&void 0!==t?t:this._$Cp}get parentNode(){let e=this._$AA.parentNode;const t=this._$AM;return void 0!==t&&11===(null==e?void 0:e.nodeType)&&(e=t.parentNode),e}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(e,t=this){e=zi(this,e,t),wi(e)?e===Oi||null==e||""===e?(this._$AH!==Oi&&this._$AR(),this._$AH=Oi):e!==this._$AH&&e!==Ri&&this._(e):void 0!==e._$litType$?this.g(e):void 0!==e.nodeType?this.$(e):(e=>Si(e)||"function"==typeof(null==e?void 0:e[Symbol.iterator]))(e)?this.T(e):this._(e)}k(e){return this._$AA.parentNode.insertBefore(e,this._$AB)}$(e){this._$AH!==e&&(this._$AR(),this._$AH=this.k(e))}_(e){this._$AH!==Oi&&wi(this._$AH)?this._$AA.nextSibling.data=e:this.$(_i.createTextNode(e)),this._$AH=e}g(e){var t;const{values:n,_$litType$:s}=e,r="number"==typeof s?this._$AC(e):(void 0===s.el&&(s.el=Li.createElement(Pi(s.h,s.h[0]),this.options)),s);if((null===(t=this._$AH)||void 0===t?void 0:t._$AD)===r)this._$AH.v(n);else{const e=new Bi(r,this),t=e.u(this.options);e.v(n),this.$(t),this._$AH=e}}_$AC(e){let t=Fi.get(e.strings);return void 0===t&&Fi.set(e.strings,t=new Li(e)),t}T(e){Si(this._$AH)||(this._$AH=[],this._$AR());const t=this._$AH;let n,s=0;for(const r of e)s===t.length?t.push(n=new Ii(this.k(vi()),this.k(vi()),this,this.options)):n=t[s],n._$AI(r),s++;s<t.length&&(this._$AR(n&&n._$AB.nextSibling,s),t.length=s)}_$AR(e=this._$AA.nextSibling,t){var n;for(null===(n=this._$AP)||void 0===n||n.call(this,!1,!0,t);e&&e!==this._$AB;){const t=e.nextSibling;e.remove(),e=t}}setConnected(e){var t;void 0===this._$AM&&(this._$Cp=e,null===(t=this._$AP)||void 0===t||t.call(this,e))}}class ji{constructor(e,t,n,s,r){this.type=1,this._$AH=Oi,this._$AN=void 0,this.element=e,this.name=t,this._$AM=s,this.options=r,n.length>2||""!==n[0]||""!==n[1]?(this._$AH=Array(n.length-1).fill(new String),this.strings=n):this._$AH=Oi}get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}_$AI(e,t=this,n,s){const r=this.strings;let i=!1;if(void 0===r)e=zi(this,e,t,0),i=!wi(e)||e!==this._$AH&&e!==Ri,i&&(this._$AH=e);else{const s=e;let o,a;for(e=r[0],o=0;o<r.length-1;o++)a=zi(this,s[n+o],t,o),a===Ri&&(a=this._$AH[o]),i||(i=!wi(a)||a!==this._$AH[o]),a===Oi?e=Oi:e!==Oi&&(e+=(null!=a?a:"")+r[o+1]),this._$AH[o]=a}i&&!s&&this.j(e)}j(e){e===Oi?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,null!=e?e:"")}}class Hi extends ji{constructor(){super(...arguments),this.type=3}j(e){this.element[this.name]=e===Oi?void 0:e}}const Ui=pi?pi.emptyScript:"";class Gi extends ji{constructor(){super(...arguments),this.type=4}j(e){e&&e!==Oi?this.element.setAttribute(this.name,Ui):this.element.removeAttribute(this.name)}}class qi extends ji{constructor(e,t,n,s,r){super(e,t,n,s,r),this.type=5}_$AI(e,t=this){var n;if((e=null!==(n=zi(this,e,t,0))&&void 0!==n?n:Oi)===Ri)return;const s=this._$AH,r=e===Oi&&s!==Oi||e.capture!==s.capture||e.once!==s.once||e.passive!==s.passive,i=e!==Oi&&(s===Oi||r);r&&this.element.removeEventListener(this.name,this,s),i&&this.element.addEventListener(this.name,this,e),this._$AH=e}handleEvent(e){var t,n;"function"==typeof this._$AH?this._$AH.call(null!==(n=null===(t=this.options)||void 0===t?void 0:t.host)&&void 0!==n?n:this.element,e):this._$AH.handleEvent(e)}}class Vi{constructor(e,t,n){this.element=e,this.type=6,this._$AN=void 0,this._$AM=t,this.options=n}get _$AU(){return this._$AM._$AU}_$AI(e){zi(this,e)}}const Wi=hi.litHtmlPolyfillSupport;var Yi,Xi;null==Wi||Wi(Li,Ii),(null!==(ui=hi.litHtmlVersions)&&void 0!==ui?ui:hi.litHtmlVersions=[]).push("2.7.5");class Ji extends di{constructor(){super(...arguments),this.renderOptions={host:this},this._$Do=void 0}createRenderRoot(){var e,t;const n=super.createRenderRoot();return null!==(e=(t=this.renderOptions).renderBefore)&&void 0!==e||(t.renderBefore=n.firstChild),n}update(e){const t=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(e),this._$Do=((e,t,n)=>{var s,r;const i=null!==(s=null==n?void 0:n.renderBefore)&&void 0!==s?s:t;let o=i._$litPart$;if(void 0===o){const e=null!==(r=null==n?void 0:n.renderBefore)&&void 0!==r?r:null;i._$litPart$=o=new Ii(t.insertBefore(vi(),e),e,void 0,null!=n?n:{})}return o._$AI(e),o})(t,this.renderRoot,this.renderOptions)}connectedCallback(){var e;super.connectedCallback(),null===(e=this._$Do)||void 0===e||e.setConnected(!0)}disconnectedCallback(){var e;super.disconnectedCallback(),null===(e=this._$Do)||void 0===e||e.setConnected(!1)}render(){return Ri}}Ji.finalized=!0,Ji._$litElement$=!0,null===(Yi=globalThis.litElementHydrateSupport)||void 0===Yi||Yi.call(globalThis,{LitElement:Ji});const Ki=globalThis.litElementPolyfillSupport;null==Ki||Ki({LitElement:Ji}),(null!==(Xi=globalThis.litElementVersions)&&void 0!==Xi?Xi:globalThis.litElementVersions=[]).push("3.3.2");const Zi=(e,t)=>"method"===t.kind&&t.descriptor&&!("value"in t.descriptor)?{...t,finisher(n){n.createProperty(t.key,e)}}:{kind:"field",key:Symbol(),placement:"own",descriptor:{},originalKey:t.key,initializer(){"function"==typeof t.initializer&&(this[t.key]=t.initializer.call(this))},finisher(n){n.createProperty(t.key,e)}};function Qi(e){return(t,n)=>void 0!==n?((e,t,n)=>{t.constructor.createProperty(n,e)})(e,t,n):Zi(e,t)}const eo=({finisher:e,descriptor:t})=>(n,s)=>{var r;if(void 0===s){const s=null!==(r=n.originalKey)&&void 0!==r?r:n.key,i=null!=t?{kind:"method",placement:"prototype",key:s,descriptor:t(n.key)}:{...n,key:s};return null!=e&&(i.finisher=function(t){e(t,s)}),i}{const r=n.constructor;void 0!==t&&Object.defineProperty(n,s,t(s)),null==e||e(r,s)}};function to(e){return eo({finisher:(t,n)=>{Object.assign(t.prototype[n],e)}})}var no;null===(no=window.HTMLSlotElement)||void 0===no||no.prototype.assignedElements;class so{constructor(e){this.startPress=t=>{e().then((e=>{e&&e.startPress(t)}))},this.endPress=()=>{e().then((e=>{e&&e.endPress()}))},this.startFocus=()=>{e().then((e=>{e&&e.startFocus()}))},this.endFocus=()=>{e().then((e=>{e&&e.endFocus()}))},this.startHover=()=>{e().then((e=>{e&&e.startHover()}))},this.endHover=()=>{e().then((e=>{e&&e.endHover()}))}}}const ro=e=>(...t)=>({_$litDirective$:e,values:t});class io{constructor(e){}get _$AU(){return this._$AM._$AU}_$AT(e,t,n){this._$Ct=e,this._$AM=t,this._$Ci=n}_$AS(e,t){return this.update(e,t)}update(e,t){return this.render(...t)}}const oo="important",ao=" !"+oo,lo=ro(class extends io{constructor(e){var t;if(super(e),1!==e.type||"style"!==e.name||(null===(t=e.strings)||void 0===t?void 0:t.length)>2)throw Error("The `styleMap` directive must be used in the `style` attribute and must be the only part in the attribute.")}render(e){return Object.keys(e).reduce(((t,n)=>{const s=e[n];return null==s?t:t+`${n=n.includes("-")?n:n.replace(/(?:^(webkit|moz|ms|o)|)(?=[A-Z])/g,"-$&").toLowerCase()}:${s};`}),"")}update(e,[t]){const{style:n}=e.element;if(void 0===this.ut){this.ut=new Set;for(const e in t)this.ut.add(e);return this.render(t)}this.ut.forEach((e=>{null==t[e]&&(this.ut.delete(e),e.includes("-")?n.removeProperty(e):n[e]="")}));for(const e in t){const s=t[e];if(null!=s){this.ut.add(e);const t="string"==typeof s&&s.endsWith(ao);e.includes("-")||t?n.setProperty(e,t?s.slice(0,-11):s,t?oo:""):n[e]=s}}return Ri}});class co extends io{constructor(e){if(super(e),this.et=Oi,2!==e.type)throw Error(this.constructor.directiveName+"() can only be used in child bindings")}render(e){if(e===Oi||null==e)return this.ft=void 0,this.et=e;if(e===Ri)return e;if("string"!=typeof e)throw Error(this.constructor.directiveName+"() called with a non-string value");if(e===this.et)return this.ft;this.et=e;const t=[e];return t.raw=t,this.ft={_$litType$:this.constructor.resultType,strings:t,values:[]}}}co.directiveName="unsafeHTML",co.resultType=1;const uo=ro(co),ho=ro(class extends io{constructor(e){var t;if(super(e),1!==e.type||"class"!==e.name||(null===(t=e.strings)||void 0===t?void 0:t.length)>2)throw Error("`classMap()` can only be used in the `class` attribute and must be the only part in the attribute.")}render(e){return" "+Object.keys(e).filter((t=>e[t])).join(" ")+" "}update(e,[t]){var n,s;if(void 0===this.it){this.it=new Set,void 0!==e.strings&&(this.nt=new Set(e.strings.join(" ").split(/\s/).filter((e=>""!==e))));for(const e in t)t[e]&&!(null===(n=this.nt)||void 0===n?void 0:n.has(e))&&this.it.add(e);return this.render(t)}const r=e.element.classList;this.it.forEach((e=>{e in t||(r.remove(e),this.it.delete(e))}));for(const e in t){const n=!!t[e];n===this.it.has(e)||(null===(s=this.nt)||void 0===s?void 0:s.has(e))||(n?(r.add(e),this.it.add(e)):(r.remove(e),this.it.delete(e)))}return Ri}}),po=(e,t,n,s)=>{s=s||{},n=null==n?{}:n;const r=new Event(t,{bubbles:void 0===s.bubbles||s.bubbles,cancelable:Boolean(s.cancelable),composed:void 0===s.composed||s.composed});return r.detail=n,e.dispatchEvent(r),r},go=(e,t)=>{if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){if(e.constructor!==t.constructor)return!1;let n,s;if(Array.isArray(e)){if(s=e.length,s!==t.length)return!1;for(n=s;0!=n--;)if(!go(e[n],t[n]))return!1;return!0}if(e instanceof Map&&t instanceof Map){if(e.size!==t.size)return!1;for(n of e.entries())if(!t.has(n[0]))return!1;for(n of e.entries())if(!go(n[1],t.get(n[0])))return!1;return!0}if(e instanceof Set&&t instanceof Set){if(e.size!==t.size)return!1;for(n of e.entries())if(!t.has(n[0]))return!1;return!0}if(ArrayBuffer.isView(e)&&ArrayBuffer.isView(t)){if(s=e.length,s!==t.length)return!1;for(n=s;0!=n--;)if(e[n]!==t[n])return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();const r=Object.keys(e);if(s=r.length,s!==Object.keys(t).length)return!1;for(n=s;0!=n--;)if(!Object.prototype.hasOwnProperty.call(t,r[n]))return!1;for(n=s;0!=n--;){const s=r[n];if(!go(e[s],t[s]))return!1}return!0}return e!=e&&t!=t},mo="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;class fo extends HTMLElement{constructor(){super(),this.holdTime=500,this.held=!1,this.cancelled=!1,this.isRepeating=!1,this.repeatCount=0,this.ripple=document.createElement("mwc-ripple")}connectedCallback(){Object.assign(this.style,{position:"fixed",width:mo?"100px":"50px",height:mo?"100px":"50px",transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:"999"}),this.appendChild(this.ripple),this.ripple.primary=!0,["touchcancel","mouseout","mouseup","touchmove","mousewheel","wheel","scroll"].forEach((e=>{document.addEventListener(e,(()=>{this.cancelled=!0,this.timer&&(this.stopAnimation(),clearTimeout(this.timer),this.timer=void 0,this.isRepeating&&this.repeatTimeout&&(clearInterval(this.repeatTimeout),this.isRepeating=!1))}),{passive:!0})}))}bind(e,t){e.actionHandler&&go(t,e.actionHandler.options)||(e.actionHandler?(e.removeEventListener("touchstart",e.actionHandler.start),e.removeEventListener("touchend",e.actionHandler.end),e.removeEventListener("touchcancel",e.actionHandler.end),e.removeEventListener("mousedown",e.actionHandler.start),e.removeEventListener("click",e.actionHandler.end),e.removeEventListener("keyup",e.actionHandler.handleEnter)):e.addEventListener("contextmenu",(e=>{const t=e||window.event;return t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),t.cancelBubble=!0,t.returnValue=!1,!1})),e.actionHandler={options:t},t.disabled||(e.actionHandler.start=n=>{let s,r;this.cancelled=!1,n.touches?(s=n.touches[0].clientX,r=n.touches[0].clientY):(s=n.clientX,r=n.clientY),t.hasHold&&(this.held=!1,this.timer=window.setTimeout((()=>{this.startAnimation(s,r),this.held=!0,t.repeat&&!this.isRepeating&&(this.repeatCount=0,this.isRepeating=!0,this.repeatTimeout=setInterval((()=>{po(e,"action",{action:"hold"}),this.repeatCount++,this.repeatTimeout&&t.repeatLimit&&this.repeatCount>=t.repeatLimit&&(clearInterval(this.repeatTimeout),this.isRepeating=!1)}),t.repeat))}),this.holdTime))},e.actionHandler.end=e=>{if(["touchend","touchcancel"].includes(e.type)&&this.cancelled)return void(this.isRepeating&&this.repeatTimeout&&(clearInterval(this.repeatTimeout),this.isRepeating=!1));const n=e.target;e.cancelable&&e.preventDefault(),t.hasHold&&(clearTimeout(this.timer),this.isRepeating&&this.repeatTimeout&&clearInterval(this.repeatTimeout),this.isRepeating=!1,this.stopAnimation(),this.timer=void 0),t.hasHold&&this.held?t.repeat||po(n,"action",{action:"hold"}):t.hasDoubleClick?"click"===e.type&&e.detail<2||!this.dblClickTimeout?this.dblClickTimeout=window.setTimeout((()=>{this.dblClickTimeout=void 0,po(n,"action",{action:"tap"})}),250):(clearTimeout(this.dblClickTimeout),this.dblClickTimeout=void 0,po(n,"action",{action:"double_tap"})):po(n,"action",{action:"tap"})},e.actionHandler.handleEnter=e=>{13===e.keyCode&&e.currentTarget.actionHandler.end(e)},e.addEventListener("touchstart",e.actionHandler.start,{passive:!0}),e.addEventListener("touchend",e.actionHandler.end),e.addEventListener("touchcancel",e.actionHandler.end),e.addEventListener("mousedown",e.actionHandler.start,{passive:!0}),e.addEventListener("click",e.actionHandler.end),e.addEventListener("keyup",e.actionHandler.handleEnter)))}startAnimation(e,t){Object.assign(this.style,{left:`${e}px`,top:`${t}px`,display:null}),this.ripple.disabled=!1,this.ripple.startPress(),this.ripple.unbounded=!0}stopAnimation(){this.ripple.endPress(),this.ripple.disabled=!0,this.style.display="none"}}customElements.define("cblcars-button-card-action-handler",fo);const yo=ro(class extends io{update(e,[t]){return((e,t)=>{const n=(()=>{const e=document.body;if(e.querySelector("cblcars-button-card-action-handler"))return e.querySelector("cblcars-button-card-action-handler");const t=document.createElement("cblcars-button-card-action-handler");return e.appendChild(t),t})();n&&n.bind(e,t)})(e.element,t),Ri}render(e){}});function bo(e,t){(function(e){return"string"==typeof e&&-1!==e.indexOf(".")&&1===parseFloat(e)})(e)&&(e="100%");var n=function(e){return"string"==typeof e&&-1!==e.indexOf("%")}(e);return e=360===t?e:Math.min(t,Math.max(0,parseFloat(e))),n&&(e=parseInt(String(e*t),10)/100),Math.abs(e-t)<1e-6?1:e=360===t?(e<0?e%t+t:e%t)/parseFloat(String(t)):e%t/parseFloat(String(t))}function _o(e){return Math.min(1,Math.max(0,e))}function vo(e){return e=parseFloat(e),(isNaN(e)||e<0||e>1)&&(e=1),e}function wo(e){return e<=1?"".concat(100*Number(e),"%"):e}function So(e){return 1===e.length?"0"+e:String(e)}function xo(e,t,n){e=bo(e,255),t=bo(t,255),n=bo(n,255);var s=Math.max(e,t,n),r=Math.min(e,t,n),i=0,o=0,a=(s+r)/2;if(s===r)o=0,i=0;else{var l=s-r;switch(o=a>.5?l/(2-s-r):l/(s+r),s){case e:i=(t-n)/l+(t<n?6:0);break;case t:i=(n-e)/l+2;break;case n:i=(e-t)/l+4}i/=6}return{h:i,s:o,l:a}}function $o(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*n*(t-e):n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}function Co(e,t,n){e=bo(e,255),t=bo(t,255),n=bo(n,255);var s=Math.max(e,t,n),r=Math.min(e,t,n),i=0,o=s,a=s-r,l=0===s?0:a/s;if(s===r)i=0;else{switch(s){case e:i=(t-n)/a+(t<n?6:0);break;case t:i=(n-e)/a+2;break;case n:i=(e-t)/a+4}i/=6}return{h:i,s:l,v:o}}function Mo(e,t,n,s){var r=[So(Math.round(e).toString(16)),So(Math.round(t).toString(16)),So(Math.round(n).toString(16))];return s&&r[0].startsWith(r[0].charAt(1))&&r[1].startsWith(r[1].charAt(1))&&r[2].startsWith(r[2].charAt(1))?r[0].charAt(0)+r[1].charAt(0)+r[2].charAt(0):r.join("")}function Ao(e){return Math.round(255*parseFloat(e)).toString(16)}function ko(e){return Do(e)/255}function Do(e){return parseInt(e,16)}var Eo={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",goldenrod:"#daa520",gold:"#ffd700",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavenderblush:"#fff0f5",lavender:"#e6e6fa",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},To="(?:".concat("[-\\+]?\\d*\\.\\d+%?",")|(?:").concat("[-\\+]?\\d+%?",")"),Ro="[\\s|\\(]+(".concat(To,")[,|\\s]+(").concat(To,")[,|\\s]+(").concat(To,")\\s*\\)?"),Oo="[\\s|\\(]+(".concat(To,")[,|\\s]+(").concat(To,")[,|\\s]+(").concat(To,")[,|\\s]+(").concat(To,")\\s*\\)?"),Fo={CSS_UNIT:new RegExp(To),rgb:new RegExp("rgb"+Ro),rgba:new RegExp("rgba"+Oo),hsl:new RegExp("hsl"+Ro),hsla:new RegExp("hsla"+Oo),hsv:new RegExp("hsv"+Ro),hsva:new RegExp("hsva"+Oo),hex3:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex4:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex8:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/};function No(e){return Boolean(Fo.CSS_UNIT.exec(String(e)))}var Po=function(){function e(t,n){var s;if(void 0===t&&(t=""),void 0===n&&(n={}),t instanceof e)return t;"number"==typeof t&&(t=function(e){return{r:e>>16,g:(65280&e)>>8,b:255&e}}(t)),this.originalInput=t;var r=function(e){var t={r:0,g:0,b:0},n=1,s=null,r=null,i=null,o=!1,a=!1;return"string"==typeof e&&(e=function(e){if(0===(e=e.trim().toLowerCase()).length)return!1;var t=!1;if(Eo[e])e=Eo[e],t=!0;else if("transparent"===e)return{r:0,g:0,b:0,a:0,format:"name"};var n=Fo.rgb.exec(e);return n?{r:n[1],g:n[2],b:n[3]}:(n=Fo.rgba.exec(e))?{r:n[1],g:n[2],b:n[3],a:n[4]}:(n=Fo.hsl.exec(e))?{h:n[1],s:n[2],l:n[3]}:(n=Fo.hsla.exec(e))?{h:n[1],s:n[2],l:n[3],a:n[4]}:(n=Fo.hsv.exec(e))?{h:n[1],s:n[2],v:n[3]}:(n=Fo.hsva.exec(e))?{h:n[1],s:n[2],v:n[3],a:n[4]}:(n=Fo.hex8.exec(e))?{r:Do(n[1]),g:Do(n[2]),b:Do(n[3]),a:ko(n[4]),format:t?"name":"hex8"}:(n=Fo.hex6.exec(e))?{r:Do(n[1]),g:Do(n[2]),b:Do(n[3]),format:t?"name":"hex"}:(n=Fo.hex4.exec(e))?{r:Do(n[1]+n[1]),g:Do(n[2]+n[2]),b:Do(n[3]+n[3]),a:ko(n[4]+n[4]),format:t?"name":"hex8"}:!!(n=Fo.hex3.exec(e))&&{r:Do(n[1]+n[1]),g:Do(n[2]+n[2]),b:Do(n[3]+n[3]),format:t?"name":"hex"}}(e)),"object"==typeof e&&(No(e.r)&&No(e.g)&&No(e.b)?(t=function(e,t,n){return{r:255*bo(e,255),g:255*bo(t,255),b:255*bo(n,255)}}(e.r,e.g,e.b),o=!0,a="%"===String(e.r).substr(-1)?"prgb":"rgb"):No(e.h)&&No(e.s)&&No(e.v)?(s=wo(e.s),r=wo(e.v),t=function(e,t,n){e=6*bo(e,360),t=bo(t,100),n=bo(n,100);var s=Math.floor(e),r=e-s,i=n*(1-t),o=n*(1-r*t),a=n*(1-(1-r)*t),l=s%6;return{r:255*[n,o,i,i,a,n][l],g:255*[a,n,n,o,i,i][l],b:255*[i,i,a,n,n,o][l]}}(e.h,s,r),o=!0,a="hsv"):No(e.h)&&No(e.s)&&No(e.l)&&(s=wo(e.s),i=wo(e.l),t=function(e,t,n){var s,r,i;if(e=bo(e,360),t=bo(t,100),n=bo(n,100),0===t)r=n,i=n,s=n;else{var o=n<.5?n*(1+t):n+t-n*t,a=2*n-o;s=$o(a,o,e+1/3),r=$o(a,o,e),i=$o(a,o,e-1/3)}return{r:255*s,g:255*r,b:255*i}}(e.h,s,i),o=!0,a="hsl"),Object.prototype.hasOwnProperty.call(e,"a")&&(n=e.a)),n=vo(n),{ok:o,format:e.format||a,r:Math.min(255,Math.max(t.r,0)),g:Math.min(255,Math.max(t.g,0)),b:Math.min(255,Math.max(t.b,0)),a:n}}(t);this.originalInput=t,this.r=r.r,this.g=r.g,this.b=r.b,this.a=r.a,this.roundA=Math.round(100*this.a)/100,this.format=null!==(s=n.format)&&void 0!==s?s:r.format,this.gradientType=n.gradientType,this.r<1&&(this.r=Math.round(this.r)),this.g<1&&(this.g=Math.round(this.g)),this.b<1&&(this.b=Math.round(this.b)),this.isValid=r.ok}return e.prototype.isDark=function(){return this.getBrightness()<128},e.prototype.isLight=function(){return!this.isDark()},e.prototype.getBrightness=function(){var e=this.toRgb();return(299*e.r+587*e.g+114*e.b)/1e3},e.prototype.getLuminance=function(){var e=this.toRgb(),t=e.r/255,n=e.g/255,s=e.b/255;return.2126*(t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.7152*(n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4))+.0722*(s<=.03928?s/12.92:Math.pow((s+.055)/1.055,2.4))},e.prototype.getAlpha=function(){return this.a},e.prototype.setAlpha=function(e){return this.a=vo(e),this.roundA=Math.round(100*this.a)/100,this},e.prototype.isMonochrome=function(){return 0===this.toHsl().s},e.prototype.toHsv=function(){var e=Co(this.r,this.g,this.b);return{h:360*e.h,s:e.s,v:e.v,a:this.a}},e.prototype.toHsvString=function(){var e=Co(this.r,this.g,this.b),t=Math.round(360*e.h),n=Math.round(100*e.s),s=Math.round(100*e.v);return 1===this.a?"hsv(".concat(t,", ").concat(n,"%, ").concat(s,"%)"):"hsva(".concat(t,", ").concat(n,"%, ").concat(s,"%, ").concat(this.roundA,")")},e.prototype.toHsl=function(){var e=xo(this.r,this.g,this.b);return{h:360*e.h,s:e.s,l:e.l,a:this.a}},e.prototype.toHslString=function(){var e=xo(this.r,this.g,this.b),t=Math.round(360*e.h),n=Math.round(100*e.s),s=Math.round(100*e.l);return 1===this.a?"hsl(".concat(t,", ").concat(n,"%, ").concat(s,"%)"):"hsla(".concat(t,", ").concat(n,"%, ").concat(s,"%, ").concat(this.roundA,")")},e.prototype.toHex=function(e){return void 0===e&&(e=!1),Mo(this.r,this.g,this.b,e)},e.prototype.toHexString=function(e){return void 0===e&&(e=!1),"#"+this.toHex(e)},e.prototype.toHex8=function(e){return void 0===e&&(e=!1),function(e,t,n,s,r){var i=[So(Math.round(e).toString(16)),So(Math.round(t).toString(16)),So(Math.round(n).toString(16)),So(Ao(s))];return r&&i[0].startsWith(i[0].charAt(1))&&i[1].startsWith(i[1].charAt(1))&&i[2].startsWith(i[2].charAt(1))&&i[3].startsWith(i[3].charAt(1))?i[0].charAt(0)+i[1].charAt(0)+i[2].charAt(0)+i[3].charAt(0):i.join("")}(this.r,this.g,this.b,this.a,e)},e.prototype.toHex8String=function(e){return void 0===e&&(e=!1),"#"+this.toHex8(e)},e.prototype.toHexShortString=function(e){return void 0===e&&(e=!1),1===this.a?this.toHexString(e):this.toHex8String(e)},e.prototype.toRgb=function(){return{r:Math.round(this.r),g:Math.round(this.g),b:Math.round(this.b),a:this.a}},e.prototype.toRgbString=function(){var e=Math.round(this.r),t=Math.round(this.g),n=Math.round(this.b);return 1===this.a?"rgb(".concat(e,", ").concat(t,", ").concat(n,")"):"rgba(".concat(e,", ").concat(t,", ").concat(n,", ").concat(this.roundA,")")},e.prototype.toPercentageRgb=function(){var e=function(e){return"".concat(Math.round(100*bo(e,255)),"%")};return{r:e(this.r),g:e(this.g),b:e(this.b),a:this.a}},e.prototype.toPercentageRgbString=function(){var e=function(e){return Math.round(100*bo(e,255))};return 1===this.a?"rgb(".concat(e(this.r),"%, ").concat(e(this.g),"%, ").concat(e(this.b),"%)"):"rgba(".concat(e(this.r),"%, ").concat(e(this.g),"%, ").concat(e(this.b),"%, ").concat(this.roundA,")")},e.prototype.toName=function(){if(0===this.a)return"transparent";if(this.a<1)return!1;for(var e="#"+Mo(this.r,this.g,this.b,!1),t=0,n=Object.entries(Eo);t<n.length;t++){var s=n[t],r=s[0];if(e===s[1])return r}return!1},e.prototype.toString=function(e){var t=Boolean(e);e=null!=e?e:this.format;var n=!1,s=this.a<1&&this.a>=0;return t||!s||!e.startsWith("hex")&&"name"!==e?("rgb"===e&&(n=this.toRgbString()),"prgb"===e&&(n=this.toPercentageRgbString()),"hex"!==e&&"hex6"!==e||(n=this.toHexString()),"hex3"===e&&(n=this.toHexString(!0)),"hex4"===e&&(n=this.toHex8String(!0)),"hex8"===e&&(n=this.toHex8String()),"name"===e&&(n=this.toName()),"hsl"===e&&(n=this.toHslString()),"hsv"===e&&(n=this.toHsvString()),n||this.toHexString()):"name"===e&&0===this.a?this.toName():this.toRgbString()},e.prototype.toNumber=function(){return(Math.round(this.r)<<16)+(Math.round(this.g)<<8)+Math.round(this.b)},e.prototype.clone=function(){return new e(this.toString())},e.prototype.lighten=function(t){void 0===t&&(t=10);var n=this.toHsl();return n.l+=t/100,n.l=_o(n.l),new e(n)},e.prototype.brighten=function(t){void 0===t&&(t=10);var n=this.toRgb();return n.r=Math.max(0,Math.min(255,n.r-Math.round(-t/100*255))),n.g=Math.max(0,Math.min(255,n.g-Math.round(-t/100*255))),n.b=Math.max(0,Math.min(255,n.b-Math.round(-t/100*255))),new e(n)},e.prototype.darken=function(t){void 0===t&&(t=10);var n=this.toHsl();return n.l-=t/100,n.l=_o(n.l),new e(n)},e.prototype.tint=function(e){return void 0===e&&(e=10),this.mix("white",e)},e.prototype.shade=function(e){return void 0===e&&(e=10),this.mix("black",e)},e.prototype.desaturate=function(t){void 0===t&&(t=10);var n=this.toHsl();return n.s-=t/100,n.s=_o(n.s),new e(n)},e.prototype.saturate=function(t){void 0===t&&(t=10);var n=this.toHsl();return n.s+=t/100,n.s=_o(n.s),new e(n)},e.prototype.greyscale=function(){return this.desaturate(100)},e.prototype.spin=function(t){var n=this.toHsl(),s=(n.h+t)%360;return n.h=s<0?360+s:s,new e(n)},e.prototype.mix=function(t,n){void 0===n&&(n=50);var s=this.toRgb(),r=new e(t).toRgb(),i=n/100;return new e({r:(r.r-s.r)*i+s.r,g:(r.g-s.g)*i+s.g,b:(r.b-s.b)*i+s.b,a:(r.a-s.a)*i+s.a})},e.prototype.analogous=function(t,n){void 0===t&&(t=6),void 0===n&&(n=30);var s=this.toHsl(),r=360/n,i=[this];for(s.h=(s.h-(r*t>>1)+720)%360;--t;)s.h=(s.h+r)%360,i.push(new e(s));return i},e.prototype.complement=function(){var t=this.toHsl();return t.h=(t.h+180)%360,new e(t)},e.prototype.monochromatic=function(t){void 0===t&&(t=6);for(var n=this.toHsv(),s=n.h,r=n.s,i=n.v,o=[],a=1/t;t--;)o.push(new e({h:s,s:r,v:i})),i=(i+a)%1;return o},e.prototype.splitcomplement=function(){var t=this.toHsl(),n=t.h;return[this,new e({h:(n+72)%360,s:t.s,l:t.l}),new e({h:(n+216)%360,s:t.s,l:t.l})]},e.prototype.onBackground=function(t){var n=this.toRgb(),s=new e(t).toRgb(),r=n.a+s.a*(1-n.a);return new e({r:(n.r*n.a+s.r*s.a*(1-n.a))/r,g:(n.g*n.a+s.g*s.a*(1-n.a))/r,b:(n.b*n.a+s.b*s.a*(1-n.a))/r,a:r})},e.prototype.triad=function(){return this.polyad(3)},e.prototype.tetrad=function(){return this.polyad(4)},e.prototype.polyad=function(t){for(var n=this.toHsl(),s=n.h,r=[this],i=360/t,o=1;o<t;o++)r.push(new e({h:(s+o*i)%360,s:n.s,l:n.l}));return r},e.prototype.equals=function(t){return this.toRgbString()===new e(t).toRgbString()},e}();function Lo(e,t){return void 0===e&&(e=""),void 0===t&&(t={}),new Po(e,t)}const zo="unavailable",Bo=(Io=[zo,"unknown"],(e,t)=>Io.includes(e,t));var Io;const jo=new Set(["fan","input_boolean","light","switch","group","automation","humidifier"]),Ho=["auto","auto-no-temperature"],Uo=["card","label-card"],Go=["--ha-card-background","--card-background-color"],qo="var(--primary-text-color)";function Vo(e){return e.substr(0,e.indexOf("."))}function Wo(e,t){const n=[];let s=t;return"var"===t.trim().substring(0,3)&&(t.split(",").forEach((e=>{const t=e.match(/var\(\s*([a-zA-Z0-9-]*)/);t&&n.push(t[1])})),n.some((t=>{const n=window.getComputedStyle(e).getPropertyValue(t);return!!n&&(s=n,!0)}))),s}function Yo(...e){const t=e=>e&&"object"==typeof e;return e.reduce(((e,n)=>(Object.keys(n).forEach((s=>{const r=e[s],i=n[s];Array.isArray(r)&&Array.isArray(i)?e[s]=r.concat(...i):t(r)&&t(i)?e[s]=Yo(r,i):e[s]=i})),e)),{})}function Xo(e,t){let n=[];return e&&e.forEach((e=>{let s=e;t&&t.forEach((t=>{t.id&&e.id&&t.id==e.id&&(s=Yo(s,t))})),n.push(s)})),t&&(n=n.concat(t.filter((t=>!e||!e.find((e=>!(!e.id||!t.id)&&e.id==t.id)))))),n}function Jo(e,t){if(void 0===e)return!1;const n=Vo(e.entity_id),s=void 0!==t?t:null==e?void 0:e.state;if(["button","event","input_button","scene"].includes(n))return s!==zo;if(Bo(s))return!1;if("off"===s&&"alert"!==n)return!1;switch(n){case"alarm_control_panel":return"disarmed"!==s;case"alert":return"idle"!==s;case"cover":return"closed"!==s;case"device_tracker":case"person":return"not_home"!==s;case"lock":return"locked"!==s;case"media_player":return"standby"!==s;case"vacuum":return!["idle","docked","paused"].includes(s);case"plant":return"problem"===s;case"group":return["on","home","open","locked","problem"].includes(s);case"timer":return"active"===s;case"camera":return"streaming"===s}return!0}function Ko(e){return Array.isArray(e)?e.reverse().reduce(((e,t)=>`var(${t}${e?`, ${e}`:""})`),void 0):`var(${e})`}function Zo(e){const t=e.split(":").map(Number);return 3600*t[0]+60*t[1]+t[2]}const Qo=e=>e<10?`0${e}`:e,ea=new Set(["call-service","divider","section","weblink","cast","select"]),ta={alert:"toggle",automation:"toggle",climate:"climate",cover:"cover",fan:"toggle",group:"group",input_boolean:"toggle",input_number:"input-number",input_select:"input-select",input_text:"input-text",light:"toggle",lock:"lock",media_player:"media-player",remote:"toggle",scene:"scene",script:"script",sensor:"sensor",timer:"timer",switch:"toggle",vacuum:"toggle",water_heater:"climate",input_datetime:"input-datetime"},na=((e,...t)=>{const n=1===e.length?e[0]:t.reduce(((t,n,s)=>t+(e=>{if(!0===e._$cssResult$)return e.cssText;if("number"==typeof e)return e;throw Error("Value passed to 'css' function must be a 'css' function result: "+e+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(n)+e[s+1]),e[0]);return new Qr(n,e,Kr)})`
  :host {
    position: relative;
    display: block;
    --state-inactive-color: var(--paper-item-icon-color);
  }
  ha-card {
    cursor: pointer;
    overflow: hidden;
    box-sizing: border-box;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    line-height: normal;

    -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
    -khtml-user-select: none; /* Konqueror HTML */
    -moz-user-select: none; /* Old versions of Firefox */
    -ms-user-select: none; /* Internet Explorer/Edge */
    user-select: none; /* Non-prefixed version, currently
                          supported by Chrome, Opera and Firefox */
  }
  ha-card.disabled {
    pointer-events: none;
    cursor: default;
  }
  :host(.tooltip) .tooltiptext {
    pointer-events: none;
    opacity: 0;
    text-align: center;
    padding: 4px;
    border-radius: var(--ha-card-border-radius, 4px);
    box-shadow: var(
      --ha-card-box-shadow,
      0px 2px 1px -1px rgba(0, 0, 0, 0.2),
      0px 1px 1px 0px rgba(0, 0, 0, 0.14),
      0px 1px 3px 0px rgba(0, 0, 0, 0.12)
    );
    background: var(--ha-card-background, var(--card-background-color, white));
    border: 1px solid var(--primary-text-color);
    color: var(--primary-text-color);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  :host(.tooltip:hover) span.tooltiptext {
    opacity: 1;
    transition-delay: 1.5s;
  }
  :not(ha-state-icon) ha-icon,
  ha-state-icon {
    display: inline-block;
    margin: auto;
    --mdc-icon-size: 100%;
    --iron-icon-width: 100%;
    --iron-icon-height: 100%;
  }
  ha-card.button-card-main {
    padding: 4% 0px;
    text-transform: none;
    font-weight: 400;
    font-size: 1.2rem;
    align-items: center;
    text-align: center;
    letter-spacing: normal;
    width: 100%;
  }
  .ellipsis {
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
  }

  #overlay {
    align-items: flex-start;
    justify-content: flex-end;
    padding: 8px 7px;
    opacity: 0.5;
    /* DO NOT override items below */
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    display: flex;
  }
  #lock {
    -webkit-animation-fill-mode: both;
    animation-fill-mode: both;
    margin: unset;
    width: 24px;
  }
  .invalid {
    animation: blink 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
  }
  .hidden {
    visibility: hidden;
    opacity: 0;
    transition: visibility 0s 1s, opacity 1s linear;
  }
  @keyframes blink {
    0% {
      opacity: 0;
    }
    50% {
      opacity: 1;
    }
    100% {
      opacity: 0;
    }
  }
  @-webkit-keyframes rotating /* Safari and Chrome */ {
    from {
      -webkit-transform: rotate(0deg);
      -o-transform: rotate(0deg);
      transform: rotate(0deg);
    }
    to {
      -webkit-transform: rotate(360deg);
      -o-transform: rotate(360deg);
      transform: rotate(360deg);
    }
  }
  @keyframes rotating {
    from {
      -ms-transform: rotate(0deg);
      -moz-transform: rotate(0deg);
      -webkit-transform: rotate(0deg);
      -o-transform: rotate(0deg);
      transform: rotate(0deg);
    }
    to {
      -ms-transform: rotate(360deg);
      -moz-transform: rotate(360deg);
      -webkit-transform: rotate(360deg);
      -o-transform: rotate(360deg);
      transform: rotate(360deg);
    }
  }
  [rotating] {
    -webkit-animation: rotating 2s linear infinite;
    -moz-animation: rotating 2s linear infinite;
    -ms-animation: rotating 2s linear infinite;
    -o-animation: rotating 2s linear infinite;
    animation: rotating 2s linear infinite;
  }

  #container {
    display: grid;
    width: 100%;
    height: 100%;
    text-align: center;
    align-items: center;
  }
  #img-cell {
    display: flex;
    grid-area: i;
    height: 100%;
    width: 100%;
    max-width: 100%;
    max-height: 100%;
    align-self: center;
    justify-self: center;
    overflow: hidden;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  ha-state-icon#icon {
    height: 100%;
    width: 100%;
    max-height: 100%;
    position: absolute;
  }
  img#icon {
    display: block;
    height: auto;
    width: 100%;
    position: absolute;
  }
  #name {
    grid-area: n;
    max-width: 100%;
    align-self: center;
    justify-self: center;
    /* margin: auto; */
  }
  #state {
    grid-area: s;
    max-width: 100%;
    align-self: center;
    justify-self: center;
    /* margin: auto; */
  }

  #label {
    grid-area: l;
    max-width: 100%;
    align-self: center;
    justify-self: center;
  }

  #container.vertical {
    grid-template-areas: 'i' 'n' 's' 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr min-content min-content min-content;
  }
  /* Vertical No Icon */
  #container.vertical.no-icon {
    grid-template-areas: 'n' 's' 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr min-content 1fr;
  }
  #container.vertical.no-icon #state {
    align-self: center;
  }
  #container.vertical.no-icon #name {
    align-self: end;
  }
  #container.vertical.no-icon #label {
    align-self: start;
  }

  /* Vertical No Icon No Name */
  #container.vertical.no-icon.no-name {
    grid-template-areas: 's' 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 1fr;
  }
  #container.vertical.no-icon.no-name #state {
    align-self: end;
  }
  #container.vertical.no-icon.no-name #label {
    align-self: start;
  }

  /* Vertical No Icon No State */
  #container.vertical.no-icon.no-state {
    grid-template-areas: 'n' 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 1fr;
  }
  #container.vertical.no-icon.no-state #name {
    align-self: end;
  }
  #container.vertical.no-icon.no-state #label {
    align-self: start;
  }

  /* Vertical No Icon No Label */
  #container.vertical.no-icon.no-label {
    grid-template-areas: 'n' 's';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 1fr;
  }
  #container.vertical.no-icon.no-label #name {
    align-self: end;
  }
  #container.vertical.no-icon.no-label #state {
    align-self: start;
  }

  /* Vertical No Icon No Label No Name */
  #container.vertical.no-icon.no-label.no-name {
    grid-template-areas: 's';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
  }
  #container.vertical.no-icon.no-label.no-name #state {
    align-self: center;
  }
  /* Vertical No Icon No Label No State */
  #container.vertical.no-icon.no-label.no-state {
    grid-template-areas: 'n';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
  }
  #container.vertical.no-icon.no-label.no-state #name {
    align-self: center;
  }

  /* Vertical No Icon No Name No State */
  #container.vertical.no-icon.no-name.no-state {
    grid-template-areas: 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
  }
  #container.vertical.no-icon.no-name.no-state #label {
    align-self: center;
  }

  #container.icon_name_state {
    grid-template-areas: 'i n' 'l l';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr min-content;
  }

  #container.icon_name {
    grid-template-areas: 'i n' 's s' 'l l';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr min-content min-content;
  }

  #container.icon_state {
    grid-template-areas: 'i s' 'n n' 'l l';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr min-content min-content;
  }

  #container.name_state {
    grid-template-areas: 'i' 'n' 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr min-content min-content;
  }
  #container.name_state.no-icon {
    grid-template-areas: 'n' 'l';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 1fr;
  }
  #container.name_state.no-icon #name {
    align-self: end;
  }
  #container.name_state.no-icon #label {
    align-self: start;
  }

  #container.name_state.no-icon.no-label {
    grid-template-areas: 'n';
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
  }
  #container.name_state.no-icon.no-label #name {
    align-self: center;
  }

  /* icon_name_state2nd default */
  #container.icon_name_state2nd {
    grid-template-areas: 'i n' 'i s' 'i l';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr min-content 1fr;
  }
  #container.icon_name_state2nd #name {
    align-self: end;
  }
  #container.icon_name_state2nd #state {
    align-self: center;
  }
  #container.icon_name_state2nd #label {
    align-self: start;
  }

  /* icon_name_state2nd No Label */
  #container.icon_name_state2nd.no-label {
    grid-template-areas: 'i n' 'i s';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr 1fr;
  }
  #container.icon_name_state2nd #name {
    align-self: end;
  }
  #container.icon_name_state2nd #state {
    align-self: start;
  }

  /* icon_state_name2nd Default */
  #container.icon_state_name2nd {
    grid-template-areas: 'i s' 'i n' 'i l';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr min-content 1fr;
  }
  #container.icon_state_name2nd #state {
    align-self: end;
  }
  #container.icon_state_name2nd #name {
    align-self: center;
  }
  #container.icon_state_name2nd #label {
    align-self: start;
  }

  /* icon_state_name2nd No Label */
  #container.icon_state_name2nd.no-label {
    grid-template-areas: 'i s' 'i n';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr 1fr;
  }
  #container.icon_state_name2nd #state {
    align-self: end;
  }
  #container.icon_state_name2nd #name {
    align-self: start;
  }

  #container.icon_label {
    grid-template-areas: 'i l' 'n n' 's s';
    grid-template-columns: 40% 1fr;
    grid-template-rows: 1fr min-content min-content;
  }

  [style*='--aspect-ratio'] > :first-child {
    width: 100%;
  }
  [style*='--aspect-ratio'] > img {
    height: auto;
  }
  @supports (--custom: property) {
    [style*='--aspect-ratio'] {
      position: relative;
    }
    [style*='--aspect-ratio']::before {
      content: '';
      display: block;
      padding-bottom: calc(100% / (var(--aspect-ratio)));
    }
    [style*='--aspect-ratio'] > :first-child {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
    }
  }
`;var sa,ra,ia,oa,aa;!function(e){e.language="language",e.system="system",e.comma_decimal="comma_decimal",e.decimal_comma="decimal_comma",e.space_comma="space_comma",e.none="none"}(sa||(sa={})),function(e){e.language="language",e.system="system",e.am_pm="12",e.twenty_four="24"}(ra||(ra={})),function(e){e.local="local",e.server="server"}(ia||(ia={})),function(e){e.language="language",e.system="system",e.DMY="DMY",e.MDY="MDY",e.YMD="YMD"}(oa||(oa={})),function(e){e.language="language",e.monday="monday",e.tuesday="tuesday",e.wednesday="wednesday",e.thursday="thursday",e.friday="friday",e.saturday="saturday",e.sunday="sunday"}(aa||(aa={}));const la=(e,t,n)=>{const s=t?(e=>{switch(e.number_format){case sa.comma_decimal:return["en-US","en"];case sa.decimal_comma:return["de","es","it"];case sa.space_comma:return["fr","sv","cs"];case sa.system:return;default:return e.language}})(t):void 0;if(Number.isNaN=Number.isNaN||function e(t){return"number"==typeof t&&e(t)},(null==t?void 0:t.number_format)!==sa.none&&!Number.isNaN(Number(e))&&Intl)try{return new Intl.NumberFormat(s,da(e,n)).format(Number(e))}catch(t){return console.error(t),new Intl.NumberFormat(void 0,da(e,n)).format(Number(e))}return"string"==typeof e?e:`${((e,t=2)=>Math.round(e*10**t)/10**t)(e,null==n?void 0:n.maximumFractionDigits).toString()}${"currency"===(null==n?void 0:n.style)?` ${n.currency}`:""}`},ca=(e,t,n)=>{var s;let r=null==n?void 0:n.display_precision;return void 0!==t&&(r=t),null!=r?{maximumFractionDigits:r,minimumFractionDigits:r}:Number.isInteger(Number(null===(s=e.attributes)||void 0===s?void 0:s.step))&&Number.isInteger(Number(e.state))?{maximumFractionDigits:0}:null!=e.attributes.step?{maximumFractionDigits:Math.ceil(Math.log10(1/e.attributes.step))}:void 0},da=(e,t)=>{const n=Object.assign({maximumFractionDigits:2},t);if("string"!=typeof e)return n;if(!t||void 0===t.minimumFractionDigits&&void 0===t.maximumFractionDigits){const t=e.indexOf(".")>-1?e.split(".")[1].length:0;n.minimumFractionDigits=t,n.maximumFractionDigits=t}return n};var ua,ha,pa,ga,ma;!function(e){e.language="language",e.system="system",e.comma_decimal="comma_decimal",e.decimal_comma="decimal_comma",e.space_comma="space_comma",e.none="none"}(ua||(ua={})),function(e){e.language="language",e.system="system",e.am_pm="12",e.twenty_four="24"}(ha||(ha={})),function(e){e.local="local",e.server="server"}(pa||(pa={})),function(e){e.language="language",e.system="system",e.DMY="DMY",e.MDY="MDY",e.YMD="YMD"}(ga||(ga={})),function(e){e.language="language",e.monday="monday",e.tuesday="tuesday",e.wednesday="wednesday",e.thursday="thursday",e.friday="friday",e.saturday="saturday",e.sunday="sunday"}(ma||(ma={}));const fa=(e,t=2)=>{let n=""+e;for(let e=1;e<t;e++)n=parseInt(n)<10**e?`0${n}`:n;return n},ya={ms:1,s:1e3,min:6e4,h:36e5,d:864e5};var ba=Number.isNaN||function(e){return"number"==typeof e&&e!=e};function _a(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!((s=e[n])===(r=t[n])||ba(s)&&ba(r)))return!1;var s,r;return!0}function va(e,t){void 0===t&&(t=_a);var n=null;function s(){for(var s=[],r=0;r<arguments.length;r++)s[r]=arguments[r];if(n&&n.lastThis===this&&t(s,n.lastArgs))return n.lastResult;var i=e.apply(this,s);return n={lastResult:i,lastArgs:s,lastThis:this},i}return s.clear=function(){n=null},s}const wa=va(((e,t)=>new Intl.DateTimeFormat(e.language,{weekday:"long",month:"long",day:"numeric",timeZone:"server"===e.time_zone?t:void 0}))),Sa=(e,t,n)=>xa(t,n.time_zone).format(e),xa=va(((e,t)=>new Intl.DateTimeFormat(e.language,{year:"numeric",month:"long",day:"numeric",timeZone:"server"===e.time_zone?t:void 0}))),$a=(e,t,n)=>{var s,r,i,o;const a=Ca(t,n.time_zone);if(t.date_format===oa.language||t.date_format===oa.system)return a.format(e);const l=a.formatToParts(e),c=null===(s=l.find((e=>"literal"===e.type)))||void 0===s?void 0:s.value,d=null===(r=l.find((e=>"day"===e.type)))||void 0===r?void 0:r.value,u=null===(i=l.find((e=>"month"===e.type)))||void 0===i?void 0:i.value,h=null===(o=l.find((e=>"year"===e.type)))||void 0===o?void 0:o.value,p=l[l.length-1];let g="literal"===(null==p?void 0:p.type)?null==p?void 0:p.value:"";return"bg"===t.language&&t.date_format===oa.YMD&&(g=""),{[oa.DMY]:`${d}${c}${u}${c}${h}${g}`,[oa.MDY]:`${u}${c}${d}${c}${h}${g}`,[oa.YMD]:`${h}${c}${u}${c}${d}${g}`}[t.date_format]},Ca=va(((e,t)=>{const n=e.date_format===oa.system?void 0:e.language;return e.date_format===oa.language||(e.date_format,oa.system),new Intl.DateTimeFormat(n,{year:"numeric",month:"numeric",day:"numeric",timeZone:"server"===e.time_zone?t:void 0})})),Ma=va(((e,t)=>new Intl.DateTimeFormat(e.language,{day:"numeric",month:"short",timeZone:"server"===e.time_zone?t:void 0}))),Aa=va(((e,t)=>new Intl.DateTimeFormat(e.language,{month:"long",year:"numeric",timeZone:"server"===e.time_zone?t:void 0}))),ka=va(((e,t)=>new Intl.DateTimeFormat(e.language,{month:"long",timeZone:"server"===e.time_zone?t:void 0}))),Da=va(((e,t)=>new Intl.DateTimeFormat(e.language,{year:"numeric",timeZone:"server"===e.time_zone?t:void 0}))),Ea=va(((e,t)=>new Intl.DateTimeFormat(e.language,{weekday:"long",timeZone:"server"===e.time_zone?t:void 0}))),Ta=va(((e,t)=>new Intl.DateTimeFormat(e.language,{weekday:"short",timeZone:"server"===e.time_zone?t:void 0}))),Ra=va((e=>{if(e.time_format===ra.language||e.time_format===ra.system){const t=e.time_format===ra.language?e.language:void 0,n=(new Date).toLocaleString(t);return n.includes("AM")||n.includes("PM")}return e.time_format===ra.am_pm})),Oa=(e,t,n)=>Fa(t,n.time_zone).format(e),Fa=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{hour:"numeric",minute:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),Na=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{hour:Ra(e)?"numeric":"2-digit",minute:"2-digit",second:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),Pa=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{weekday:"long",hour:Ra(e)?"numeric":"2-digit",minute:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),La=va(((e,t)=>new Intl.DateTimeFormat("en-GB",{hour:"numeric",minute:"2-digit",hour12:!1,timeZone:"server"===e.time_zone?t:void 0}))),za=(e,t,n)=>Ba(t,n.time_zone).format(e),Ba=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{year:"numeric",month:"long",day:"numeric",hour:Ra(e)?"numeric":"2-digit",minute:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),Ia=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{year:"numeric",month:"short",day:"numeric",hour:Ra(e)?"numeric":"2-digit",minute:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),ja=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{month:"short",day:"numeric",hour:Ra(e)?"numeric":"2-digit",minute:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),Ha=va(((e,t)=>new Intl.DateTimeFormat("en"!==e.language||Ra(e)?e.language:"en-u-hc-h23",{year:"numeric",month:"long",day:"numeric",hour:Ra(e)?"numeric":"2-digit",minute:"2-digit",second:"2-digit",hour12:Ra(e),timeZone:"server"===e.time_zone?t:void 0}))),Ua=(e,t)=>!!(e.supported_features&t),Ga=(e,t,n,s,r,i,o)=>{const a=r[t.entity_id];return qa(e,n,s,a,t.entity_id,t.attributes,i,void 0!==o?o:t.state)},qa=(e,t,n,s,r,i,o,a)=>{var l;if("unknown"===a||"unavailable"===a)return e(`state.default.${a}`);if(function(e){return!!e.unit_of_measurement||!!e.state_class}(i)){if("duration"===i.device_class&&i.unit_of_measurement&&ya[i.unit_of_measurement])try{return((e,t)=>function(e){const t=Math.floor(e/1e3/3600),n=Math.floor(e/1e3%3600/60),s=Math.floor(e/1e3%3600%60),r=Math.floor(e%1e3);return t>0?`${t}:${fa(n)}:${fa(s)}`:n>0?`${n}:${fa(s)}`:s>0||r>0?`${s}${r>0?`.${fa(r,3)}`:""}`:null}(parseFloat(e)*ya[t])||"0")(a,i.unit_of_measurement)}catch(e){}if("monetary"===i.device_class)try{return la(a,t,Object.assign({style:"currency",currency:(null==o?void 0:o.units)||i.unit_of_measurement,minimumFractionDigits:2},ca({state:a,attributes:i},null==o?void 0:o.numeric_precision,s)))}catch(e){}const e=(null==o?void 0:o.show_units)?(null==o?void 0:o.units)?null==o?void 0:o.units:i.unit_of_measurement:void 0,n=e?"%"===e?(e=>{switch(e.language){case"cz":case"de":case"fi":case"fr":case"sk":case"sv":return" ";default:return""}})(t)+"%":` ${e}`:"";return`${la(a,t,ca({state:a,attributes:i},null==o?void 0:o.numeric_precision,s))}${n}`}const c=Vo(r);if("datetime"===c){const e=new Date(a);return za(e,t,n)}if(["date","input_datetime","time"].includes(c))try{const e=a.split(" ");if(2===e.length)return za(new Date(e.join("T")),Object.assign(Object.assign({},t),{time_zone:pa.local}),n);if(1===e.length){if(a.includes("-"))return Sa(new Date(`${a}T00:00`),Object.assign(Object.assign({},t),{time_zone:pa.local}),n);if(a.includes(":")){const e=new Date;return Oa(new Date(`${e.toISOString().split("T")[0]}T${a}`),Object.assign(Object.assign({},t),{time_zone:pa.local}),n)}}return a}catch(e){return a}if("counter"===c||"number"===c||"input_number"===c)return la(a,t,ca({state:a,attributes:i},null==o?void 0:o.numeric_precision,s));if(["button","event","input_button","scene","stt","tts"].includes(c)||"sensor"===c&&"timestamp"===i.device_class)try{return za(new Date(a),t,n)}catch(e){return a}return"update"===c?"on"===a?(e=>(e=>Ua(e,4)&&"number"==typeof e.in_progress)(e)||!!e.in_progress)(i)?Ua(i,4)&&"number"==typeof i.in_progress?e("ui.card.update.installing_with_progress",{progress:i.in_progress}):e("ui.card.update.installing"):i.latest_version:i.skipped_version===i.latest_version?null!==(l=i.latest_version)&&void 0!==l?l:e("state.default.unavailable"):e("ui.card.update.up_to_date"):(null==s?void 0:s.translation_key)&&e(`component.${s.platform}.entity.${c}.${s.translation_key}.state.${a}`)||i.device_class&&e(`component.${c}.entity_component.${i.device_class}.state.${a}`)||e(`component.${c}.entity_component._.state.${a}`)||a};var Va=Function.prototype.toString,Wa=Object.create,Ya=Object.defineProperty,Xa=Object.getOwnPropertyDescriptor,Ja=Object.getOwnPropertyNames,Ka=Object.getOwnPropertySymbols,Za=Object.getPrototypeOf,Qa=Object.prototype,el=Qa.hasOwnProperty,tl=Qa.propertyIsEnumerable,nl="function"==typeof Ka,sl="function"==typeof WeakMap,rl=function(){if(sl)return function(){return new WeakMap};var e=function(){function e(){this._keys=[],this._values=[]}return e.prototype.has=function(e){return!!~this._keys.indexOf(e)},e.prototype.get=function(e){return this._values[this._keys.indexOf(e)]},e.prototype.set=function(e,t){this._keys.push(e),this._values.push(t)},e}();return function(){return new e}}(),il=function(e,t){var n=e.__proto__||Za(e);if(!n)return Wa(null);var s=n.constructor;if(s===t.Object)return n===t.Object.prototype?{}:Wa(n);if(~Va.call(s).indexOf("[native code]"))try{return new s}catch(e){}return Wa(n)},ol=function(e,t,n,s){var r=il(e,t);for(var i in s.set(e,r),e)el.call(e,i)&&(r[i]=n(e[i],s));if(nl)for(var o=Ka(e),a=0,l=o.length,c=void 0;a<l;++a)c=o[a],tl.call(e,c)&&(r[c]=n(e[c],s));return r},al=function(e,t,n,s){var r=il(e,t);s.set(e,r);for(var i=nl?Ja(e).concat(Ka(e)):Ja(e),o=0,a=i.length,l=void 0,c=void 0;o<a;++o)if("callee"!==(l=i[o])&&"caller"!==l)if(c=Xa(e,l)){c.get||c.set||(c.value=n(e[l],s));try{Ya(r,l,c)}catch(e){r[l]=c.value}}else r[l]=n(e[l],s);return r},ll=Array.isArray,cl=Object.getPrototypeOf,dl=function(){return"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==n.g?n.g:(console&&console.error&&console.error('Unable to locate global object, returning "this".'),this)}();function ul(e,t){var n=!(!t||!t.isStrict),s=t&&t.realm||dl,r=n?al:ol,i=function(e,t){if(!e||"object"!=typeof e)return e;if(t.has(e))return t.get(e);var o,a,l,c=e.__proto__||cl(e),d=c&&c.constructor;if(!d||d===s.Object)return r(e,s,i,t);if(ll(e)){if(n)return al(e,s,i,t);o=new d,t.set(e,o);for(var u=0,h=e.length;u<h;++u)o[u]=i(e[u],t);return o}if(e instanceof s.Date)return new d(e.getTime());if(e instanceof s.RegExp)return(o=new d(e.source,e.flags||(l="",(a=e).global&&(l+="g"),a.ignoreCase&&(l+="i"),a.multiline&&(l+="m"),a.unicode&&(l+="u"),a.sticky&&(l+="y"),l))).lastIndex=e.lastIndex,o;if(s.Map&&e instanceof s.Map)return o=new d,t.set(e,o),e.forEach((function(e,n){o.set(n,i(e,t))})),o;if(s.Set&&e instanceof s.Set)return o=new d,t.set(e,o),e.forEach((function(e){o.add(i(e,t))})),o;if(s.Blob&&e instanceof s.Blob)return e.slice(0,e.size,e.type);if(s.Buffer&&s.Buffer.isBuffer(e))return o=s.Buffer.allocUnsafe?s.Buffer.allocUnsafe(e.length):new d(e.length),t.set(e,o),e.copy(o),o;if(s.ArrayBuffer){if(s.ArrayBuffer.isView(e))return o=new d(e.buffer.slice(0)),t.set(e,o),o;if(e instanceof s.ArrayBuffer)return o=e.slice(0),t.set(e,o),o}return"function"==typeof e.then||e instanceof Error||s.WeakMap&&e instanceof s.WeakMap||s.WeakSet&&e instanceof s.WeakSet?e:r(e,s,i,t)};return i(e,rl())}ul.default=ul,ul.strict=function(e,t){return ul(e,{isStrict:!0,realm:t?t.realm:void 0})};const hl=new Set(["alarm_control_panel","alert","automation","binary_sensor","calendar","camera","climate","cover","device_tracker","fan","group","humidifier","input_boolean","light","lock","media_player","person","plant","remote","schedule","script","siren","sun","switch","timer","update","vacuum"]),pl=(e,t,n)=>{if((void 0!==t?t:null==e?void 0:e.state)===zo)return"var(--state-unavailable-color)";const s=ml(e,t,n);return s?Ko(s):void 0},gl=(e,t,n,s)=>{const r=void 0!==n?n:t.state,i=Jo(t,n),o=[],a=function(e,t="_"){const n="àáäâãåăæąçćčđďèéěėëêęğǵḧìíïîįłḿǹńňñòóöôœøṕŕřßşśšșťțùúüûǘůűūųẃẍÿýźžż·/_,:;",s=`aaaaaaaaacccddeeeeeeegghiiiiilmnnnnooooooprrsssssttuuuuuuuuuwxyyzzz${t}${t}${t}${t}${t}${t}`,r=new RegExp(n.split("").join("|"),"g");return e.toString().toLowerCase().replace(/\s+/g,t).replace(r,(e=>s.charAt(n.indexOf(e)))).replace(/&/g,`${t}and${t}`).replace(/[^\w-]+/g,"").replace(/-/g,t).replace(new RegExp(`(${t})\\1+`,"g"),"$1").replace(new RegExp(`^${t}+`),"").replace(new RegExp(`${t}+$`),"")}(r,"_"),l=i?"active":"inactive";if(s&&Uo.includes(s)&&"inactive"==l)return Go;const c=t.attributes.device_class;return c&&o.push(`--state-${e}-${c}-${a}-color`),o.push(`--state-${e}-${a}-color`,`--state-${e}-${l}-color`,`--state-${l}-color`),o},ml=(e,t,n)=>{const s=void 0!==t?t:null==e?void 0:e.state,r=Vo(e.entity_id),i=e.attributes.device_class;if("sensor"===r&&"battery"===i){const e=(e=>{const t=Number(e);if(!isNaN(t))return t>=70?"--state-sensor-battery-high-color":t>=30?"--state-sensor-battery-medium-color":"--state-sensor-battery-low-color"})(s);if(e)return[e]}if("group"===r){const s=(e=>{const t=e.attributes.entity_id||[],n=[...new Set(t.map((e=>Vo(e))))];return 1===n.length?n[0]:void 0})(e);if(s&&hl.has(s))return gl(s,e,t,n)}return hl.has(r)?gl(r,e,t,n):n&&Uo.includes(n)?Go:void 0};let fl=window.cardHelpers;const yl=new Promise((async e=>{fl&&e(),window.loadCardHelpers&&(fl=await window.loadCardHelpers(),window.cardHelpers=fl,e())}));console.info("%c  BUTTON-CARD (mod for CB-LCARS)  \n%c Version 4.1.2-cblcars.3 ","color: white; font-weight: bold; background: #37a6d1","color: white; font-weight: bold; background: #37a6d1");let bl=class extends Ji{constructor(){super(...arguments),this._cards={},this._cardsConfig={},this._entities=[],this._initialSetupComplete=!1,this._rippleHandlers=new so((()=>this._ripple))}get _doIHaveEverything(){return!!this._hass&&!!this._config&&this.isConnected}set hass(e){this._hass=e,Object.keys(this._cards).forEach((e=>{this._cards[e].hass=this._hass})),this._initialSetupComplete||this._finishSetup()}disconnectedCallback(){super.disconnectedCallback(),this._clearInterval()}connectedCallback(){super.connectedCallback(),this._initialSetupComplete?this._startTimerCountdown():this._finishSetup()}_evaluateVariablesSkipError(e){var t;this._evaledVariables={},(null===(t=this._config)||void 0===t?void 0:t.variables)&&Object.keys(this._config.variables).sort().forEach((t=>{try{this._evaledVariables[t]=this._objectEvalTemplate(e,this._config.variables[t])}catch(e){}}))}_finishSetup(){if(!this._initialSetupComplete&&this._doIHaveEverything){if(this._evaluateVariablesSkipError(),this._config.entity){const e=this._getTemplateOrValue(void 0,this._config.entity);this._config.entity=e,this._stateObj=this._hass.states[e]}this._evaluateVariablesSkipError(this._stateObj),this._config.entity&&jo.has(Vo(this._config.entity))?this._config=Object.assign({tap_action:{action:"toggle"}},this._config):this._config.entity?this._config=Object.assign({tap_action:{action:"more-info"}},this._config):this._config=Object.assign({tap_action:{action:"none"}},this._config);const e=JSON.stringify(this._config);if(this._entities=[],Array.isArray(this._config.triggers_update))this._config.triggers_update.forEach((e=>{try{const t=this._getTemplateOrValue(this._stateObj,e);null==t||this._entities.includes(t)||this._entities.push(t)}catch(e){}}));else if("string"==typeof this._config.triggers_update){const e=this._getTemplateOrValue(this._stateObj,this._config.triggers_update);e&&"all"!==e?this._entities.push(e):this._config.triggers_update=e}if("all"!==this._config.triggers_update){const t=new RegExp(/states\[\s*('|\\")([a-zA-Z0-9_]+\.[a-zA-Z0-9_]+)\1\s*\]/,"gm"),n=new RegExp(/states\[\s*('|\\")([a-zA-Z0-9_]+\.[a-zA-Z0-9_]+)\1\s*\]/,"m"),s=e.match(t);null==s||s.forEach((e=>{const t=e.match(n);t&&!this._entities.includes(t[2])&&this._entities.push(t[2])}))}this._config.entity&&!this._entities.includes(this._config.entity)&&this._entities.push(this._config.entity),this._expandTriggerGroups();const t=new RegExp("\\[\\[\\[.*\\]\\]\\]","m");this._hasTemplate=!("all"!==this._config.triggers_update||!e.match(t)),this._startTimerCountdown(),this._initialSetupComplete=!0}}_startTimerCountdown(){if(this._config&&this._config.entity&&"timer"===Vo(this._config.entity)){const e=this._hass.states[this._config.entity];this._startInterval(e)}}_createCard(e){if(fl)return fl.createCardElement(e);{const t=((e,t=!1)=>{const n=(e,t)=>s("hui-error-card",{type:"error",error:e,config:t}),s=(e,t)=>{const s=window.document.createElement(e);try{if(!s.setConfig)return;s.setConfig(t)}catch(s){return console.error(e,s),n(s.message,t)}return s};if(!e||"object"!=typeof e||!t&&!e.type)return n("No type defined",e);let r=e.type;if(r&&r.startsWith("custom:"))r=r.substr(7);else if(t)if(ea.has(r))r=`hui-${r}-row`;else{if(!e.entity)return n("Invalid config given.",e);const t=e.entity.split(".",1)[0];r=`hui-${ta[t]||"text"}-entity-row`}else r=`hui-${r}-card`;if(customElements.get(r))return s(r,e);const i=n(`Custom element doesn't exist: ${e.type}.`,e);i.style.display="None";const o=setTimeout((()=>{i.style.display=""}),2e3);return customElements.whenDefined(e.type).then((()=>{clearTimeout(o),po(i,"ll-rebuild",{},i)})),i})(e);return yl.then((()=>{po(t,"ll-rebuild",{})})),t}}static get styles(){return na}render(){var e;if(!this._config||!this._hass)return Ti``;this._stateObj=this._config.entity?this._hass.states[this._config.entity]:void 0;try{return this._evaledVariables={},(null===(e=this._config)||void 0===e?void 0:e.variables)&&Object.keys(this._config.variables).sort().forEach((e=>{this._evaledVariables[e]=this._objectEvalTemplate(this._stateObj,this._config.variables[e])})),this._cardHtml()}catch(e){e.stack?console.error(e.stack):console.error(e);const t=document.createElement("hui-error-card");return t.setConfig({type:"error",error:e.toString(),origConfig:this._config}),Ti` ${t} `}}shouldUpdate(e){return!(!this._hasTemplate&&!e.has("_timeRemaining")&&!function(e,t){if(t.has("_config"))return!0;const n=t.get("_hass");return!!n&&e._entities.some((function(t){return(null==n?void 0:n.states[t])!==e._hass.states[t]}))}(this,e)||(this._expandTriggerGroups(),0))}updated(e){if(super.updated(e),this._config&&this._config.entity&&"timer"===Vo(this._config.entity)&&e.has("_hass")){const t=this._hass.states[this._config.entity],n=e.get("_hass");(n?n.states[this._config.entity]:void 0)!==t?this._startInterval(t):t||this._clearInterval()}}_clearInterval(){this._interval&&(window.clearInterval(this._interval),this._interval=void 0)}_startInterval(e){this._clearInterval(),this._calculateRemaining(e),"active"===e.state&&(this._interval=window.setInterval((()=>this._calculateRemaining(e)),1e3))}_calculateRemaining(e){e.attributes.remaining&&(this._timeRemaining=(e=>{if(!e.attributes.remaining)return;let t=Zo(e.attributes.remaining);if("active"===e.state){const n=(new Date).getTime(),s=new Date(e.last_changed).getTime();t=Math.max(t-(n-s)/1e3,0)}return t})(e))}_computeTimeDisplay(e){if(e)return function(e){const t=Math.floor(e/3600),n=Math.floor(e%3600/60),s=Math.floor(e%3600%60);return t>0?`${t}:${Qo(n)}:${Qo(s)}`:n>0?`${n}:${Qo(s)}`:s>0?""+s:null}(this._timeRemaining||Zo(e.attributes.duration))}_getMatchingConfigState(e){if(!this._config.state)return;const t=this._config.state.find((e=>"template"===e.operator));if(!e&&!t)return;let n;const s=this._config.state.find((t=>{if(!t.operator)return e&&this._getTemplateOrValue(e,t.value)==e.state;switch(t.operator){case"==":return e&&e.state==this._getTemplateOrValue(e,t.value);case"<=":return e&&e.state<=this._getTemplateOrValue(e,t.value);case"<":return e&&e.state<this._getTemplateOrValue(e,t.value);case">=":return e&&e.state>=this._getTemplateOrValue(e,t.value);case">":return e&&e.state>this._getTemplateOrValue(e,t.value);case"!=":return e&&e.state!=this._getTemplateOrValue(e,t.value);case"regex":return!(!e||!e.state.match(this._getTemplateOrValue(e,t.value)));case"template":return this._getTemplateOrValue(e,t.value);case"default":return n=t,!1;default:return!1}}));return!s&&n?n:s}_localize(e,t,n,s=!0,r){var i;return Ga(this._hass.localize,e,this._hass.locale,this._hass.config,this._hass.entities,{numeric_precision:"card"===n?null===(i=this._config)||void 0===i?void 0:i.numeric_precision:n,show_units:s,units:r},t)}_relativeTime(e,t=!1){return e?Ti`
        <ha-relative-time
          id="relative-time"
          class="ellipsis"
          .hass="${this._hass}"
          .datetime="${e}"
          .capitalize="${t}"
        ></ha-relative-time>
      `:""}_getTemplateHelpers(){return{localize:this._localize.bind(this),formatDateTime:e=>za(new Date(e),this._hass.locale,this._hass.config),formatShortDateTimeWithYear:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,Ia(n,s.time_zone).format(t);var t,n,s},formatShortDateTime:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,ja(n,s.time_zone).format(t);var t,n,s},formatDateTimeWithSeconds:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,Ha(n,s.time_zone).format(t);var t,n,s},formatDateTimeNumeric:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,`${$a(t,n,s)}, ${Oa(t,n,s)}`;var t,n,s},relativeTime:this._relativeTime.bind(this),formatTime:e=>Oa(new Date(e),this._hass.locale,this._hass.config),formatTimeWithSeconds:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,Na(n,s.time_zone).format(t);var t,n,s},formatTimeWeekday:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,Pa(n,s.time_zone).format(t);var t,n,s},formatTime24h:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,La(n,s.time_zone).format(t);var t,n,s},formatDateWeekdayDay:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,wa(n,s.time_zone).format(t);var t,n,s},formatDate:e=>Sa(new Date(e),this._hass.locale,this._hass.config),formatDateNumeric:e=>$a(new Date(e),this._hass.locale,this._hass.config),formatDateShort:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,Ma(n,s.time_zone).format(t);var t,n,s},formatDateMonthYear:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,Aa(n,s.time_zone).format(t);var t,n,s},formatDateMonth:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,ka(n,s.time_zone).format(t);var t,n,s},formatDateYear:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,Da(n,s.time_zone).format(t);var t,n,s},formatDateWeekday:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,Ea(n,s.time_zone).format(t);var t,n,s},formatDateWeekdayShort:e=>{return t=new Date(e),n=this._hass.locale,s=this._hass.config,Ta(n,s.time_zone).format(t);var t,n,s}}}_evalTemplate(e,t){try{return new Function("states","entity","user","hass","variables","html","helpers",`'use strict'; ${t}`).call(this,this._hass.states,e,this._hass.user,this._hass,this._evaledVariables,Ti,this._getTemplateHelpers())}catch(e){const n=t.length<=100?t.trim():`${t.trim().substring(0,98)}...`;throw e.message=`${e.name}: ${e.message} in '${n}'`,e.name="ButtonCardJSTemplateError",e}}_objectEvalTemplate(e,t){const n=ul(t);return this._getTemplateOrValue(e,n)}_getTemplateOrValue(e,t){if(["number","boolean"].includes(typeof t))return t;if(!t)return t;if("object"==typeof t)return Object.keys(t).forEach((n=>{t[n]=this._getTemplateOrValue(e,t[n])})),t;const n=t.trim();return"[[["===n.substring(0,3)&&"]]]"===n.slice(-3)?this._evalTemplate(e,n.slice(3,-3)):t}_getColorForLightEntity(e,t,n){let s=qo;return Uo.includes(s)&&(s=Ko(Go)),e&&(Jo(e)?(s=e.attributes.rgb_color?`rgb(${e.attributes.rgb_color.join(",")})`:t&&e.attributes.color_temp&&e.attributes.min_mireds&&e.attributes.max_mireds?function(e,t,n){const s=new Po("rgb(255, 160, 0)"),r=new Po("rgb(166, 209, 255)"),i=new Po("white"),o=(e-t)/(n-t)*100;return o<50?Lo(r).mix(i,2*o).toRgbString():Lo(i).mix(s,2*(o-50)).toRgbString()}(e.attributes.color_temp,e.attributes.min_mireds,e.attributes.max_mireds):pl(e,e.state,n)||qo,e.attributes.brightness&&(s=function(e,t,n){const s=new Po(Wo(e,t));if(s.isValid){const e=s.mix("black",100-n).toString();if(e)return e}return t}(this,s,(e.attributes.brightness+245)/5))):s=pl(e,e.state,n)||qo),s}_buildCssColorAttribute(e,t){var n,s;let r,i="";return(null==t?void 0:t.color)?i=t.color:this._config.color&&(i=this._config.color),Ho.includes(i)&&(!e||e&&"light"!==Vo(e.entity_id))&&(i=""),r=Ho.includes(i)?this._getColorForLightEntity(e,"auto-no-temperature"!==i,null===(n=this._config)||void 0===n?void 0:n.color_type):i||e&&pl(e,e.state,null===(s=this._config)||void 0===s?void 0:s.color_type)||qo,r}_buildIcon(e,t){if(!this._config.show_icon)return;let n;if(null==t?void 0:t.icon)n=t.icon;else{if(!this._config.icon)return;n=this._config.icon}return this._getTemplateOrValue(e,n)}_buildEntityPicture(e,t){if(!this._config.show_entity_picture||!e&&!t&&!this._config.entity_picture)return;let n;return(null==t?void 0:t.entity_picture)?n=t.entity_picture:this._config.entity_picture?n=this._config.entity_picture:e&&(n=e.attributes&&e.attributes.entity_picture?e.attributes.entity_picture:void 0),this._getTemplateOrValue(e,n)}_buildStyleGeneric(e,t,n){var s,r;let i={};if((null===(s=this._config.styles)||void 0===s?void 0:s[n])&&(i=Object.assign(i,...this._config.styles[n])),null===(r=null==t?void 0:t.styles)||void 0===r?void 0:r[n]){let e={};e=Object.assign(e,...t.styles[n]),i=Object.assign(Object.assign({},i),e)}return Object.keys(i).forEach((t=>{i[t]=this._getTemplateOrValue(e,i[t])})),i}_buildCustomStyleGeneric(e,t,n){var s,r,i,o;let a={};if((null===(r=null===(s=this._config.styles)||void 0===s?void 0:s.custom_fields)||void 0===r?void 0:r[n])&&(a=Object.assign(a,...this._config.styles.custom_fields[n])),null===(o=null===(i=null==t?void 0:t.styles)||void 0===i?void 0:i.custom_fields)||void 0===o?void 0:o[n]){let e={};e=Object.assign(e,...t.styles.custom_fields[n]),a=Object.assign(Object.assign({},a),e)}return Object.keys(a).forEach((t=>{a[t]=this._getTemplateOrValue(e,a[t])})),a}_buildName(e,t){if(!1===this._config.show_name)return;let n;var s;return(null==t?void 0:t.name)?n=t.name:this._config.name?n=this._config.name:e&&(n=e.attributes&&e.attributes.friendly_name?e.attributes.friendly_name:(s=e.entity_id).substr(s.indexOf(".")+1)),this._getTemplateOrValue(e,n)}_buildStateString(e){let t;return this._config.show_state&&e&&e.state&&("timer"===Vo(e.entity_id)?"idle"===e.state||0===this._timeRemaining?t=Ga(this._hass.localize,e,this._hass.locale,this._hass.config,this._hass.entities,this._config):(t=this._computeTimeDisplay(e),"paused"===e.state&&(t+=` (${Ga(this._hass.localize,e,this._hass.locale,this._hass.config,this._hass.entities,this._config)})`)):t=Ga(this._hass.localize,e,this._hass.locale,this._hass.config,this._hass.entities,this._config)),t}_buildLastChanged(e,t){return this._config.show_last_changed&&e?Ti`
          <ha-relative-time
            id="label"
            class="ellipsis"
            .hass="${this._hass}"
            .datetime="${e.last_changed}"
            style=${lo(t)}
          ></ha-relative-time>
        `:void 0}_buildLabel(e,t){if(!this._config.show_label)return;let n;return n=(null==t?void 0:t.label)?t.label:this._config.label,this._getTemplateOrValue(e,n)}_buildCustomFields(e,t){let n=Ti``;const s={},r={};return this._config.custom_fields&&Object.keys(this._config.custom_fields).forEach((t=>{const n=this._config.custom_fields[t];n.card?n.do_not_eval?r[t]=ul(n.card):r[t]=this._objectEvalTemplate(e,n.card):s[t]=this._getTemplateOrValue(e,n)})),(null==t?void 0:t.custom_fields)&&Object.keys(t.custom_fields).forEach((n=>{const i=t.custom_fields[n];i.card?i.do_not_eval?r[n]=ul(i.card):r[n]=this._objectEvalTemplate(e,i.card):s[n]=this._getTemplateOrValue(e,i)})),Object.keys(s).forEach((r=>{if(null!=s[r]){const i=Object.assign(Object.assign({},this._buildCustomStyleGeneric(e,t,r)),{"grid-area":r});n=Ti`
          ${n}
          <div id=${r} class="ellipsis" style=${lo(i)}>${this._unsafeHTMLorNot(s[r])}</div>
        `}})),Object.keys(r).forEach((s=>{if(null!=r[s]){const i=Object.assign(Object.assign({},this._buildCustomStyleGeneric(e,t,s)),{"grid-area":s});let o;go(this._cardsConfig[s],r[s])?o=this._cards[s]:(o=this._createCard(r[s]),this._cards[s]=o,this._cardsConfig[s]=ul(r[s])),o.hass=this._hass,n=Ti`
          ${n}
          <div
            id=${s}
            @action=${this._stopPropagation}
            @click=${this._stopPropagation}
            @touchstart=${this._stopPropagation}
            @mousedown=${this._stopPropagation}
            @mouseup=${this._stopPropagation}
            @touchend=${this._stopPropagation}
            @touchcancel=${this._stopPropagation}
            style=${lo(i)}
          >
            ${o}
          </div>
        `}})),n}_hasChildCards(e){return!!e&&Object.keys(e).some((t=>!!e[t].card))}_isClickable(e,t){const n=this._getTemplateOrValue(e,this._config.tap_action.action),s=this._getTemplateOrValue(e,this._config.hold_action.action),r=this._getTemplateOrValue(e,this._config.double_tap_action.action),i=this._hasChildCards(this._config.custom_fields)||!(!t||!this._hasChildCards(t.custom_fields));return"none"!=n||"none"!=s||"none"!=r||i}_rotate(e){return!!(null==e?void 0:e.spin)}_blankCardColoredHtml(e){const t=Object.assign({background:"none","box-shadow":"none","border-style":"none"},e);return Ti`
      <ha-card class="disabled" style=${lo(t)}>
        <div></div>
      </ha-card>
    `}_cardHtml(){var e,t,n,s;const r=this._getMatchingConfigState(this._stateObj);let i="var(--state-inactive-color)";(null==r?void 0:r.color)&&!Ho.includes(r.color)?i=r.color:(null===(e=this._config)||void 0===e?void 0:e.color)&&!Ho.includes(this._config.color)?this._stateObj?Jo(this._stateObj)&&(i=(null===(t=this._config)||void 0===t?void 0:t.color)||i):i=this._config.color:i=this._buildCssColorAttribute(this._stateObj,r);let o=i,a={},l={};const c={},d=this._buildStyleGeneric(this._stateObj,r,"lock"),u=this._buildStyleGeneric(this._stateObj,r,"card"),h=this._buildStyleGeneric(this._stateObj,r,"tooltip"),p={"button-card-main":!0,disabled:!this._isClickable(this._stateObj,r)};switch((null===(n=this._config)||void 0===n?void 0:n.tooltip)&&this.classList.add("tooltip"),u.width&&(this.style.setProperty("flex","0 0 auto"),this.style.setProperty("max-width","fit-content")),this._config.color_type){case"blank-card":return this._blankCardColoredHtml(u);case"card":case"label-card":{const e=function(e,t){const n=new Po(Wo(e,t)).getLuminance(),s=new Po({r:225,g:225,b:225}),r=s.getLuminance(),i=new Po({r:28,g:28,b:28}),o=i.getLuminance();return 0===n||(Math.max(n,r)+.05)/Math.min(n,r+.05)>(Math.max(n,o)+.05)/Math.min(n,o+.05)?s.toRgbString():i.toRgbString()}(this,i);a.color=e,l.color=e,a["background-color"]=i,a=Object.assign(Object.assign({},a),u),o="inherit";break}default:a=u}this._config.aspect_ratio?(c["--aspect-ratio"]=this._config.aspect_ratio,a.position="absolute"):c.display="inline",this.style.setProperty("--button-card-light-color",this._getColorForLightEntity(this._stateObj,!0)),this.style.setProperty("--button-card-light-color-no-temperature",this._getColorForLightEntity(this._stateObj,!1)),l=Object.assign(Object.assign({},l),d);const g=this._config.extra_styles?Ti`
          <style>
            ${this._getTemplateOrValue(this._stateObj,this._config.extra_styles)}
          </style>
        `:Ti``;return Ti`
      ${g}
      <div id="aspect-ratio" style=${lo(c)}>
        <ha-card
          id="card"
          class=${ho(p)}
          style=${lo(a)}
          @action=${this._handleAction}
          @focus="${this.handleRippleFocus}"
          @blur="${this.handleRippleBlur}"
          @mousedown="${this.handleRippleActivate}"
          @mouseup="${this.handleRippleDeactivate}"
          @touchstart="${this.handleRippleActivate}"
          @touchend="${this.handleRippleDeactivate}"
          @touchcancel="${this.handleRippleDeactivate}"
          .actionHandler=${yo({hasDoubleClick:"none"!==this._config.double_tap_action.action,hasHold:"none"!==this._config.hold_action.action,repeat:this._config.hold_action.repeat,repeatLimit:this._config.hold_action.repeat_limit})}
          .config="${this._config}"
        >
          ${this._buttonContent(this._stateObj,r,o)}
          <mwc-ripple id="ripple"></mwc-ripple>
        </ha-card>
        ${this._getLock(l)}
      </div>
      ${(null===(s=this._config)||void 0===s?void 0:s.tooltip)?Ti`
            <span class="tooltiptext" style=${lo(h)}>
              ${this._getTemplateOrValue(this._stateObj,this._config.tooltip)}
            </span>
          `:""}
    `}_getLock(e){return this._config.lock&&this._getTemplateOrValue(this._stateObj,this._config.lock.enabled)?Ti`
        <div
          id="overlay"
          style=${lo(e)}
          @action=${this._handleUnlockType}
          .actionHandler=${yo({hasDoubleClick:"double_tap"===this._config.lock.unlock,hasHold:"hold"===this._config.lock.unlock})}
          .config="${this._config}"
        >
          <ha-icon id="lock" icon="mdi:lock-outline"></ha-icon>
        </div>
      `:Ti``}_buttonContent(e,t,n){const s=this._buildName(e,t),r=(null==t?void 0:t.state_display)||this._config.state_display||void 0,i=(this._config.show_state&&r?this._getTemplateOrValue(e,r):void 0)||this._buildStateString(e),o=function(e,t){if(!e&&!t)return;let n;return n=t?e?`${e}: ${t}`:t:e,n}(s,i);switch(this._config.layout){case"icon_name_state":case"name_state":return this._gridHtml(e,t,this._config.layout,n,o,void 0);default:return this._gridHtml(e,t,this._config.layout,n,s,i)}}_unsafeHTMLorNot(e){return e.strings||e.values?e:uo(`${e}`)}_gridHtml(e,t,n,s,r,i){const o=this._getIconHtml(e,t,s),a=[n],l=this._buildLabel(e,t),c=this._buildStyleGeneric(e,t,"name"),d=this._buildStyleGeneric(e,t,"state"),u=this._buildStyleGeneric(e,t,"label"),h=this._buildLastChanged(e,u),p=this._buildStyleGeneric(e,t,"grid");return o||a.push("no-icon"),r||a.push("no-name"),i||a.push("no-state"),l||h||a.push("no-label"),Ti`
      <div id="container" class=${a.join(" ")} style=${lo(p)}>
        ${o||""}
        ${r?Ti`
              <div id="name" class="ellipsis" style=${lo(c)}>
                ${this._unsafeHTMLorNot(r)}
              </div>
            `:""}
        ${i?Ti`
              <div id="state" class="ellipsis" style=${lo(d)}>
                ${this._unsafeHTMLorNot(i)}
              </div>
            `:""}
        ${l&&!h?Ti`
              <div id="label" class="ellipsis" style=${lo(u)}>
                ${this._unsafeHTMLorNot(l)}
              </div>
            `:""}
        ${h||""} ${this._buildCustomFields(e,t)}
      </div>
    `}_getIconHtml(e,t,n){const s=this._buildIcon(e,t),r=this._buildEntityPicture(e,t),i=this._buildStyleGeneric(e,t,"entity_picture"),o=this._buildStyleGeneric(e,t,"icon"),a=this._buildStyleGeneric(e,t,"img_cell"),l=this._buildStyleGeneric(e,t,"card"),c=Object.assign({color:n,width:this._config.size,"--ha-icon-display":l.height?"inline":void 0,position:this._config.aspect_ratio||l.height?"absolute":"relative"},o),d=Object.assign(Object.assign({},c),i),u=this._buildLiveStream(d),h=this._config.show_icon&&(s||e);if(h||r){let n;return e&&(n=Vo(e.entity_id)),Ti`
        <div id="img-cell" style=${lo(a)}>
          ${!h||r||u?"":Ti`
                <ha-state-icon
                  .state=${e}
                  .stateObj=${e}
                  .hass=${this._hass}
                  ?data-domain=${n}
                  data-state=${(e=>null!=e?e:Oi)(null==e?void 0:e.state)}
                  style=${lo(c)}
                  .icon="${s}"
                  id="icon"
                  ?rotating=${this._rotate(t)}
                ></ha-state-icon>
              `}
          ${u||""}
          ${r&&!u?Ti`
                <img
                  src="${r}"
                  style=${lo(d)}
                  id="icon"
                  ?rotating=${this._rotate(t)}
                />
              `:""}
        </div>
      `}}_buildLiveStream(e){return this._config.show_live_stream&&this._config.entity&&"camera"===Vo(this._config.entity)?Ti`
        <hui-image
          .hass=${this._hass}
          .cameraImage=${this._config.entity}
          .entity=${this._config.entity}
          cameraView="live"
          style=${lo(e)}
        ></hui-image>
      `:void 0}_configFromLLTemplates(e,t){const n=t.template;if(!n)return t;let s,r={};const i=n&&Array.isArray(n)?n:[n];return null==i||i.forEach((t=>{var n,i;let o;if(null===(n=e.config.cblcars_card_templates)||void 0===n?void 0:n[t])o=e.config.cblcars_card_templates[t];else{if(!(null===(i=window.cblcars_card_templates)||void 0===i?void 0:i[t]))throw new Error(`LCARS Button-card template '${t}' is missing!`);o=window.cblcars_card_templates[t]}const a=this._configFromLLTemplates(e,o);r=Yo(r,a),s=Xo(s,a.state)})),r=Yo(r,t),r.state=Xo(s,t.state),r}setConfig(e){if(!e)throw new Error("Invalid configuration");this._initialSetupComplete&&(this._initialSetupComplete=!1),this._cards={},this._cardsConfig={};const t=function(){let e=document.querySelector("home-assistant");if(e=e&&e.shadowRoot,e=e&&e.querySelector("home-assistant-main"),e=e&&e.shadowRoot,e=e&&e.querySelector("app-drawer-layout partial-panel-resolver, ha-drawer partial-panel-resolver"),e=e&&e.shadowRoot||e,e=e&&e.querySelector("ha-panel-lovelace"),e=e&&e.shadowRoot,e=e&&e.querySelector("hui-root"),e){const t=e.lovelace;return t.current_view=e.___curView,t}return null}()||function(){let e=document.querySelector("hc-main");if(e=e&&e.shadowRoot,e=e&&e.querySelector("hc-lovelace"),e=e&&e.shadowRoot,e=e&&(e.querySelector("hui-view")||e.querySelector("hui-panel-view")),e){const t=e.lovelace;return t.current_view=e.___curView,t}return null}();let n=ul(e);n=this._configFromLLTemplates(t,n),this._config=Object.assign(Object.assign({type:"custom:cblcars-button-card",group_expand:!1,hold_action:{action:"none"},double_tap_action:{action:"none"},layout:"vertical",size:"40%",color_type:"icon",show_name:!0,show_state:!1,show_icon:!0,show_units:!0,show_label:!1,show_entity_picture:!1,show_live_stream:!1,card_size:3},n),{lock:Object.assign({enabled:!1,duration:5,unlock:"tap"},n.lock)}),this._initialSetupComplete||this._finishSetup()}_loopGroup(e){e&&e.forEach((e=>{var t,n;(null===(t=this._hass)||void 0===t?void 0:t.states[e])&&((null===(n=this._hass.states[e].attributes)||void 0===n?void 0:n.entity_id)?this._loopGroup(this._hass.states[e].attributes.entity_id):this._entities.includes(e)||this._entities.push(e))}))}_expandTriggerGroups(){var e;this._hass&&(null===(e=this._config)||void 0===e?void 0:e.group_expand)&&this._entities&&this._entities.forEach((e=>{var t,n,s,r,i;(null===(s=null===(n=null===(t=this._hass)||void 0===t?void 0:t.states[e])||void 0===n?void 0:n.attributes)||void 0===s?void 0:s.entity_id)&&this._loopGroup(null===(i=null===(r=this._hass)||void 0===r?void 0:r.states[e].attributes)||void 0===i?void 0:i.entity_id)}))}getCardSize(){var e;return(null===(e=this._config)||void 0===e?void 0:e.card_size)||3}_evalActions(e,t){var n,s,r,i,o;const a=ul(e),l=e=>e?(Object.keys(e).forEach((t=>{"object"==typeof e[t]?e[t]=l(e[t]):e[t]=this._getTemplateOrValue(this._stateObj,e[t])})),e):e;return"entity"===(null===(s=null===(n=a[t])||void 0===n?void 0:n.service_data)||void 0===s?void 0:s.entity_id)&&(a[t].service_data.entity_id=e.entity),"entity"===(null===(i=null===(r=a[t])||void 0===r?void 0:r.data)||void 0===i?void 0:i.entity_id)&&(a[t].data.entity_id=e.entity),a[t]=l(a[t]),!a[t].confirmation&&a.confirmation&&(a[t].confirmation=l(a.confirmation)),(null===(o=a[t])||void 0===o?void 0:o.entity)&&(a.entity=a[t].entity),a}handleRippleActivate(e){this._ripple.then((t=>t&&"function"==typeof t.startPress&&this._rippleHandlers.startPress(e)))}handleRippleDeactivate(){this._ripple.then((e=>e&&"function"==typeof e.endPress&&this._rippleHandlers.endPress()))}handleRippleFocus(){this._ripple.then((e=>e&&"function"==typeof e.startFocus&&this._rippleHandlers.startFocus()))}handleRippleBlur(){this._ripple.then((e=>e&&"function"==typeof e.endFocus&&this._rippleHandlers.endFocus()))}_handleAction(e){var t;if(null===(t=e.detail)||void 0===t?void 0:t.action)switch(e.detail.action){case"tap":case"hold":case"double_tap":const t=this._config;if(!t)return;const n=e.detail.action,s=this._evalActions(t,`${n}_action`);(async(e,t,n,s)=>{po(e,"hass-action",{config:n,action:s})})(this,this._hass,s,n)}}_handleUnlockType(e){const t=this._config;t&&t.lock.unlock===e.detail.action&&this._handleLock()}_handleLock(){var e;const t=this.shadowRoot.getElementById("lock");if(!t)return;if(this._config.lock.exemptions){if(!(null===(e=this._hass.user)||void 0===e?void 0:e.name)||!this._hass.user.id)return;let n=!1;if(this._config.lock.exemptions.forEach((e=>{var t,s;(!n&&e.user===(null===(t=this._hass.user)||void 0===t?void 0:t.id)||e.username===(null===(s=this._hass.user)||void 0===s?void 0:s.name))&&(n=!0)})),!n)return t.classList.add("invalid"),void window.setTimeout((()=>{t&&t.classList.remove("invalid")}),3e3)}const n=this.shadowRoot.getElementById("overlay");if(n.style.setProperty("pointer-events","none"),t){const e=document.createAttribute("icon");e.value="mdi:lock-open-outline",t.attributes.setNamedItem(e),t.classList.add("hidden")}window.setTimeout((()=>{if(n.style.setProperty("pointer-events",""),t){t.classList.remove("hidden");const e=document.createAttribute("icon");e.value="mdi:lock-outline",t.attributes.setNamedItem(e)}}),1e3*this._config.lock.duration)}_stopPropagation(e){e.stopPropagation()}};Yr([Qi()],bl.prototype,"_hass",void 0),Yr([Qi()],bl.prototype,"_config",void 0),Yr([Qi()],bl.prototype,"_timeRemaining",void 0),Yr([eo({descriptor:e=>({async get(){var e;return await this.updateComplete,null===(e=this.renderRoot)||void 0===e?void 0:e.querySelector("mwc-ripple")},enumerable:!0,configurable:!0})})],bl.prototype,"_ripple",void 0),Yr([to({passive:!0})],bl.prototype,"handleRippleActivate",null),Yr([to({passive:!0})],bl.prototype,"handleRippleDeactivate",null),Yr([to({passive:!0})],bl.prototype,"handleRippleFocus",null),Yr([to({passive:!0})],bl.prototype,"handleRippleBlur",null),Yr([to({passive:!0})],bl.prototype,"_handleAction",null),Yr([to({passive:!0})],bl.prototype,"_handleUnlockType",null),Yr([to({passive:!0})],bl.prototype,"_handleLock",null),Yr([to({passive:!0})],bl.prototype,"_stopPropagation",null),bl=Yr([(e=>t=>"function"==typeof t?((e,t)=>(customElements.define(e,t),t))(e,t):((e,t)=>{const{kind:n,elements:s}=t;return{kind:n,elements:s,finisher(t){customElements.define(e,t)}}})(e,t))("cblcars-button-card")],bl);var _l=n(625),vl=n(152),wl=n(988);function Sl(e){const t={},n=/<circle[^>]*id="([^"]+)"[^>]*>/g;let s;for(;null!==(s=n.exec(e));){const e=s[1],n=s[0],r=n.match(/\scx="([^"]+)"/),i=n.match(/\scy="([^"]+)"/);r&&i&&(t[e]=[parseFloat(r[1]),parseFloat(i[1])])}const r=/<text[^>]*id="([^"]+)"[^>]*>/g;for(;null!==(s=r.exec(e));){const e=s[1],n=s[0],r=n.match(/\sx="([^"]+)"/),i=n.match(/\sy="([^"]+)"/);r&&i&&(t[e]=[parseFloat(r[1]),parseFloat(i[1])])}const i=/<g[^>]*id="([^"]+)"[^>]*>/g;for(;null!==(s=i.exec(e));)t[s[1]]=null;return t}function xl(e){let t=null;return e&&e.startsWith("builtin:")?t=e.replace("builtin:",""):e&&e.startsWith("/local/")&&(t=e.split("/").pop().replace(".svg","")),t&&window.cblcars?.msd?.svg_templates?.[t]}function $l(e){const t=e&&e.match(/viewBox="([0-9.\-]+)\s+([0-9.\-]+)\s+([0-9.\-]+)\s+([0-9.\-]+)"/);return t?[parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]),parseFloat(t[4])]:[0,0,400,200]}function Cl(e){return e[2]&&e[3]?e[2]/e[3]:2}function Ml(e){if(null===e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(Ml);const t={};for(const[n,s]of Object.entries(e))n.startsWith("__")||"checksum"===n||"origin_pack"===n||"timestamp"===n||(t[n]=Ml(s));return t}function Al(e){if(null===e||"object"!=typeof e)return JSON.stringify(e);if(Array.isArray(e))return`[${e.map(Al).join(",")}]`;const t=Object.keys(e).sort().map((t=>`"${t}":${Al(e[t])}`));return`{${t.join(",")}}`}const kl=new class{constructor(){this.counters=new Map,this.timings=new Map,this.sessionStart=performance.now()}addTiming(e,t,n={}){this.timings.has(e)||this.timings.set(e,{last:0,totalMs:0,samples:0,avg:0,min:1/0,max:0,metadata:[]});const s=this.timings.get(e);s.last=t,s.totalMs+=t,s.samples++,s.avg=s.totalMs/s.samples,s.min=Math.min(s.min,t),s.max=Math.max(s.max,t),Object.keys(n).length>0&&(s.metadata.push({...n,ms:t,timestamp:Date.now()}),s.metadata.length>10&&(s.metadata=s.metadata.slice(-10)))}addCount(e,t=1,n={}){this.counters.has(e)||this.counters.set(e,{count:0,rate:0,lastUpdate:performance.now(),metadata:[]});const s=this.counters.get(e),r=performance.now(),i=(r-s.lastUpdate)/1e3;s.count+=t,s.rate=i>0?t/i:0,s.lastUpdate=r,Object.keys(n).length>0&&(s.metadata.push({...n,increment:t,timestamp:Date.now()}),s.metadata.length>10&&(s.metadata=s.metadata.slice(-10)))}async timeAsync(e,t,n={}){const s=performance.now();try{const r=await t(),i=performance.now()-s;return this.addTiming(e,i,n),r}catch(t){const r=performance.now()-s;throw this.addTiming(e,r,{...n,error:t.message}),t}}timeSync(e,t,n={}){const s=performance.now();try{const r=t(),i=performance.now()-s;return this.addTiming(e,i,n),r}catch(t){const r=performance.now()-s;throw this.addTiming(e,r,{...n,error:t.message}),t}}getAll(){const e=performance.now()-this.sessionStart;return{session:{duration_ms:e,started_at:Date.now()-e},timings:Object.fromEntries(this.timings),counters:Object.fromEntries(this.counters),summary:this.getSummary()}}getSummary(){const e={timings:{},counters:{},health:"good"};return["merge.total","validation.total","render.total"].forEach((t=>{if(this.timings.has(t)){const n=this.timings.get(t);e.timings[t]={avg:n.avg,last:n.last,samples:n.samples},n.avg>50&&(e.health="warning"),n.avg>100&&(e.health="critical")}})),["rules.eval.count","rules.match.count","animation.instance.reuse"].forEach((t=>{if(this.counters.has(t)){const n=this.counters.get(t);e.counters[t]={count:n.count,rate:n.rate}}})),e}reset(){this.counters.clear(),this.timings.clear(),this.sessionStart=performance.now()}export(e={}){const t=this.getAll();return"csv"===e.format?this.exportToCsv(t):e.minify?this.minifyData(t):t}minifyData(e){const t={session:e.session,timings:{},counters:{},summary:e.summary};for(const[n,s]of Object.entries(e.timings))t.timings[n]={avg:s.avg,last:s.last,samples:s.samples,min:s.min,max:s.max};for(const[n,s]of Object.entries(e.counters))t.counters[n]={count:s.count,rate:s.rate};return t}};function Dl(e,t,n={}){return"function"==typeof t?kl.timeSync(e,t,n):{end:(t={})=>{const n=performance.now()-Dl.start;kl.addTiming(e,n,t)}}}async function El(e,t,n={}){return kl.timeAsync(e,t,n)}function Tl(e,t=1,n={}){kl.addCount(e,t,n)}const Rl="undefined"!=typeof window?window:n.g;async function Ol(e){return await El("merge.total",(async()=>{const t=await El("merge.loadLayers",(()=>async function(e){const t=[],s=e.use_packs?.builtin||["core"];for(const e of s){const n=await Fl(e);n&&t.push({type:"builtin",pack:e,data:n,priority:100})}if(e.use_packs?.external?.length>0){const s=await async function(e,t={}){const{timeout:s=5e3,retries:r=2,retryDelay:i=1e3,enableCaching:o=!0}=t,a=[],l={total_packs:e.length,successful:0,failed:0,retried:0,cached_hits:0,total_time_ms:0},c=performance.now();for(let t=0;t<e.length;t++){const n=e[t],c=await Nl(n,{timeout:s,retries:r,retryDelay:i,enableCaching:o,index:t});a.push(c),c.error?l.failed++:l.successful++,c.retryCount>0&&l.retried++,c.cached&&l.cached_hits++}l.total_time_ms=performance.now()-c;try{const e="undefined"!=typeof window?window:n.g;e.__msdDebug=e.__msdDebug||{},e.__msdDebug._lastExternalPackPerf=l}catch(e){}return a}(e.use_packs.external);s.forEach(((e,n)=>{e.data&&!e.error&&t.push({type:"external",pack:e.url,data:e.data,priority:200+n})}))}return t.push({type:"user",pack:"user_config",data:e,priority:1e3}),t.sort(((e,t)=>e.priority-t.priority))}(e))),s=await El("merge.processSingle",(()=>async function(e){const t={version:1,anchors:{},palettes:{},profiles:[],overlays:[],rules:[],animations:[],timelines:[],routing:{},data_sources:{},active_profiles:["normal"],__provenance:{anchors:{},palettes:{},overlays:{},rules:{},animations:{},merge_order:[]}};for(const n of e)Dl("merge.processLayer",(()=>Bl(t,n)),{layer:n.pack,type:n.type}),t.__provenance.merge_order.push({type:n.type,pack:n.pack,priority:n.priority});return Dl("merge.applyRemovals",(()=>function(e,t){if(!t||"object"!=typeof t)return;const n=["overlays","rules","animations","profiles","timelines"];for(const s of n){const n=t[s];if(Array.isArray(n))for(const t of n){const n=e[s].findIndex((e=>e.id===t));n>=0&&(e[s].splice(n,1),e.__provenance[s][t]={...e.__provenance[s][t]||{},removed:!0,removal_source:"global"})}}}(t,e[e.length-1]?.data?.remove))),t.checksum=await El("merge.checksum",(()=>async function(e){const t=Al(Ml(e));if("undefined"!=typeof crypto&&crypto.subtle){const e=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",e),s=new Uint8Array(n),r=Array.from(s).map((e=>e.toString(16).padStart(2,"0"))).join("");return r.substring(0,10)}return function(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return Math.abs(t).toString(16)}(t).substring(0,10)}(t))),t}(t)));return s}),{config_overlays:e.overlays?.length||0,config_rules:e.rules?.length||0,config_anchors:Object.keys(e.anchors||{}).length,use_packs:e.use_packs?.builtin?.length||0})}async function Fl(e){try{const t=window.__msdDebug?.packs;if(t){const n="core"===e?t.core:t.builtin?.[e];if(n&&"object"==typeof n)return n}}catch(e){}return"core"===e?{version:1,anchors:{svg_bridge:[200,150],svg_warp:[350,200]},_extracted_anchors:["svg_bridge","svg_warp"],profiles:[{id:"normal",defaults:{line:{color:"var(--lcars-orange)",width:2},text:{color:"var(--lcars-orange)",font_size:14}}}],palettes:{default:{accent1:"var(--lcars-orange)",accent2:"var(--lcars-yellow)",danger:"var(--lcars-red)",info:"var(--lcars-cyan)"}}}:null}async function Nl(e,t){const{timeout:n,retries:s,retryDelay:r,enableCaching:i,index:o}=t;if(i&&zl.has(e)){const t=zl.get(e);if(Date.now()-t.timestamp<3e5)return{url:e,data:t.data,error:t.error,cached:!0,loadTime:0,retryCount:0,index:o}}let a=null,l=0;for(let t=0;t<=s;t++){const d=performance.now();try{const t=await Promise.race([Pl(e),Ll(n,e)]),s=performance.now()-d;return i&&zl.set(e,{data:t.data,error:null,timestamp:Date.now()}),{url:e,data:t.data,error:null,cached:!1,loadTime:s,retryCount:l,index:o,contentType:t.contentType,size:t.size}}catch(c){if(a=c,l=t,"ValidationError"===c.name||"SyntaxError"===c.name||c.message.includes("404"))break;t<s&&await new Promise((e=>setTimeout(e,r*(t+1))))}}return i&&zl.set(e,{data:null,error:a.message,timestamp:Date.now()}),{url:e,data:null,error:a?.message||"Unknown error",errorType:(c=a,c?"TimeoutError"===c.name?"timeout":"ValidationError"===c.name?"validation":"SyntaxError"===c.name?"syntax":c.message.includes("404")?"not_found":c.message.includes("403")?"forbidden":c.message.includes("network")?"network":"unknown":"unknown"),cached:!1,loadTime:0,retryCount:l,index:o};var c}async function Pl(e){try{new URL(e)}catch(t){const n=new Error(`Invalid URL format: ${e}`);throw n.name="ValidationError",n}const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText} for ${e}`);const n=t.headers.get("content-type")||"";n.includes("application/json")||n.includes("text/")||console.warn(`[MSD] External pack ${e} has unexpected content-type: ${n}`);const s=await t.text();if(s.length>1048576)throw new Error(`External pack ${e} too large: ${s.length} bytes (max 1MB)`);let r;try{r=JSON.parse(s)}catch(t){const n=new Error(`Invalid JSON in external pack ${e}: ${t.message}`);throw n.name="SyntaxError",n}return r&&"object"==typeof r&&function(e,t){const n=Object.keys(e);["version","anchors","overlays","rules","animations","profiles","palettes","timelines"].some((e=>n.includes(e)))||console.warn(`[MSD] External pack ${t} doesn't contain recognized MSD fields`),["overlays","rules","animations","profiles"].forEach((n=>{Array.isArray(e[n])&&e[n].forEach(((e,s)=>{e.id||console.warn(`[MSD] External pack ${t} ${n}[${s}] missing required 'id' field`)}))}))}(r,e),{data:r,contentType:n,size:s.length}}function Ll(e,t){return new Promise(((n,s)=>{setTimeout((()=>{const n=new Error(`Timeout loading external pack: ${t} (${e}ms)`);n.name="TimeoutError",s(n)}),e)}))}Rl&&(Rl.__msdPerf={getAll:function(){return kl.getAll()},getSummary:function(){return kl.getSummary()},reset:function(){kl.reset()},export:function(e={}){return kl.export(e)}});const zl=new Map;async function Bl(e,t){const n=["overlays","rules","animations","profiles","timelines"];for(const s of n)t.data[s]&&Array.isArray(t.data[s])&&Dl(`merge.collection.${s}`,(()=>{e.__provenance[s]||(e.__provenance[s]={});for(const n of t.data[s]){if(!n.id)continue;if(!0===n.remove){const r=e[s].findIndex((e=>e.id===n.id));r>=0&&(e[s].splice(r,1),e.__provenance[s][n.id]={...e.__provenance[s][n.id]||{},removed:!0,removal_source:t.pack});continue}const r=e[s].findIndex((e=>e.id===n.id)),i=structuredClone(n);delete i.remove,r>=0?(e[s][r]=i,e.__provenance[s][n.id]={origin_pack:e.__provenance[s][n.id]?.origin_pack||t.pack,overridden:!0,override_layer:t.pack}):(e[s].push(i),e.__provenance[s][n.id]={origin_pack:t.pack,overridden:!1})}Tl(`merge.items.${s}`,t.data[s].length)}));t.data.palettes&&Dl("merge.palettes",(()=>{e.palettes=e.palettes||{},e.__provenance.palettes||(e.__provenance.palettes={});for(const[n,s]of Object.entries(t.data.palettes))if("object"==typeof s&&!Array.isArray(s)){e.palettes[n]||(e.palettes[n]={},e.__provenance.palettes[n]={origin_pack:t.pack,tokens:{},overridden:!1}),e.__provenance.palettes[n].tokens||(e.__provenance.palettes[n].tokens={});for(const[r,i]of Object.entries(s)){const s=void 0!==e.palettes[n][r],o=e.palettes[n][r];e.palettes[n][r]=i,e.__provenance.palettes[n].tokens[r]=s?{origin_pack:e.__provenance.palettes[n].tokens[r]?.origin_pack||"unknown",current_value:i,previous_value:o,overridden:!0,override_pack:t.pack,override_history:[...e.__provenance.palettes[n].tokens[r]?.override_history||[],{pack:t.pack,value:i,timestamp:Date.now()}]}:{origin_pack:t.pack,current_value:i,overridden:!1,override_history:[]}}e.__provenance.palettes[n].origin_pack!==t.pack&&(e.__provenance.palettes[n].overridden=!0,e.__provenance.palettes[n].last_modified_by=t.pack)}let n=0;Object.values(t.data.palettes).forEach((e=>{"object"!=typeof e||Array.isArray(e)||(n+=Object.keys(e).length)})),Tl("merge.palette.tokens",n),Tl("merge.palettes",Object.keys(t.data.palettes).length)})),t.data.anchors&&Dl("merge.anchors",(()=>{for(const[n,s]of Object.entries(t.data.anchors)){const r=n in e.anchors,i=e.anchors[n];e.anchors[n]=s;const o=Il(t,n);if(r){const r=e.__provenance.anchors[n];e.__provenance.anchors[n]={origin_pack:r?.origin_pack||"unknown",origin_type:r?.origin_type||"unknown",coordinates:s,overridden:!0,override_source:t.pack,override_type:o,previous_coordinates:i,override_history:[...r?.override_history||[],{pack:t.pack,type:o,coordinates:s,previous_coordinates:i,timestamp:Date.now()}]}}else e.__provenance.anchors[n]={origin_pack:t.pack,origin_type:o,coordinates:s,overridden:!1,override_history:[]}}Tl("merge.anchors",Object.keys(t.data.anchors).length)})),t.data.routing&&(e.routing={...e.routing,...t.data.routing}),t.data.data_sources&&(e.data_sources={...e.data_sources,...t.data.data_sources}),t.data.debug&&(e.debug={...e.debug,...t.data.debug},e.__provenance.debug?(e.__provenance.debug.overridden=!0,e.__provenance.debug.override_layer=t.pack):e.__provenance.debug={origin_pack:t.pack,overridden:!1}),Array.isArray(t.data.active_profiles)&&(e.active_profiles=[...t.data.active_profiles])}function Il(e,t){return"builtin"===e.type||"external"===e.type?e.data._extracted_anchors&&e.data._extracted_anchors.includes(t)?"svg":"pack":"user"===e.type?"user":"unknown"}try{"undefined"!=typeof window&&(window.__msdDebug=window.__msdDebug||{},window.__msdDebug.packs=window.__msdDebug.packs||{},window.__msdDebug.packs.mergePacks=Ol,window.__msdDebug.exportCollapsed=()=>function(e){const t={};return["version","use_packs","anchors","overlays","animations","rules","profiles","timelines","palettes","routing","active_profiles","remove","debug"].forEach((n=>{e&&void 0!==e[n]&&(t[n]=e[n])})),t}(window.__msdDebug._hudUserMsdConfig||{}))}catch(Xr){}function jl(e,t,n){Array.isArray(e)&&2===e.length?e.forEach(((e,s)=>{const r=0===s?"x":"y";"string"==typeof e?e.endsWith("%")&&!isNaN(parseFloat(e.slice(0,-1)))||t.errors.push({code:"coordinates.invalid",message:`${n} ${r}-coordinate '${e}' must be number or percentage string`}):"number"!=typeof e&&t.errors.push({code:"coordinates.invalid",message:`${n} ${r}-coordinate must be number or percentage string`})})):t.errors.push({code:"coordinates.invalid",message:`${n} must be array of 2 elements [x, y]`})}var Hl=n(333),Ul=n(778),Gl=n(659);class ql{constructor(){this.gradientCache=new Map,this.patternCache=new Map,this.filterCache=new Map,this.pathCache=new Map}static render(e,t,n){return(new ql).renderSparkline(e,t,n)}renderSparkline(e,t,n){const s=Ul.Q.resolvePosition(e.position,t);if(!s)return console.warn("[SparklineRenderer] Sparkline overlay position could not be resolved:",e.id),"";const[r,i]=s,o=e.size||[200,60],[a,l]=o;try{const t=this._getHistoricalDataForSparkline(e.source),n=e.finalStyle||e.style||{},s=this._resolveSparklineStyles(n,e.id),o=this._prepareAnimationAttributes(e,n);return console.log(`[SparklineRenderer] Data result for ${e.id}:`,t.status,t.data?.length),"OK"===t.status&&t.data&&t.data.length>=2?this._renderEnhancedSparkline(e,r,i,a,l,t.data,s,o):this._renderEnhancedStatusIndicator(e,r,i,a,l,t,s,o)}catch(t){return console.error(`[SparklineRenderer] Enhanced rendering failed for sparkline ${e.id}:`,t),this._renderFallbackSparkline(e,r,i,a,l)}}_getHistoricalDataForSparkline(e){return ql.getHistoricalDataForSparkline(e)}_resolveSparklineStyles(e,t){const n={color:e.color||e.stroke||"var(--lcars-yellow)",width:Number(e.width||e.stroke_width||e.strokeWidth||2),opacity:Number(e.opacity||1),lineCap:(e.line_cap||e.lineCap||e.strokeLinecap||"round").toLowerCase(),lineJoin:(e.line_join||e.lineJoin||e.strokeLinejoin||"round").toLowerCase(),miterLimit:Number(e.miter_limit||e.miterLimit||4),dashArray:e.dash_array||e.dashArray||e.strokeDasharray||null,dashOffset:Number(e.dash_offset||e.dashOffset||e.strokeDashoffset||0),smoothing_mode:(e.smoothing_mode||e.smoothingMode||"none").toLowerCase(),interpolation:(e.interpolation||"linear").toLowerCase(),path_precision:Number(e.path_precision||e.pathPrecision||2),fill:e.fill||"none",fillOpacity:Number(e.fill_opacity||e.fillOpacity||.2),fillGradient:this._parseGradientConfig(e.fill_gradient||e.fillGradient),gradient:this._parseGradientConfig(e.gradient),pattern:this._parsePatternConfig(e.pattern),show_points:e.show_points||e.showPoints||!1,point_size:Number(e.point_size||e.pointSize||3),point_color:e.point_color||e.pointColor||null,show_last_value:e.show_last_value||e.showLastValue||!1,value_format:e.value_format||e.valueFormat||null,thresholds:this._parseThresholds(e.thresholds),zero_line:e.zero_line||e.zeroLine||!1,zero_line_color:e.zero_line_color||e.zeroLineColor||"var(--lcars-gray)",min_value:void 0!==e.min_value?Number(e.min_value):null,max_value:void 0!==e.max_value?Number(e.max_value):null,auto_scale:!1!==e.auto_scale,glow:this._parseGlowConfig(e.glow),shadow:this._parseShadowConfig(e.shadow),blur:this._parseBlurConfig(e.blur),bracket_style:e.bracket_style||e.bracketStyle||!1,bracket_width:Number(e.bracket_width||e.bracketWidth||2),bracket_color:e.bracket_color||e.bracketColor||null,bracket_gap:Number(e.bracket_gap||e.bracketGap||6),bracket_corner_radius:Number(e.bracket_corner_radius||e.bracketCornerRadius||0),bracket_style_mode:(e.bracket_style_mode||e.bracketStyleMode||"square").toLowerCase(),status_indicator:e.status_indicator||e.statusIndicator||!1,scan_line:e.scan_line||e.scanLine||!1,grid_lines:e.grid_lines||e.gridLines||!1,grid_color:e.grid_color||e.gridColor||"var(--lcars-gray)",grid_opacity:Number(e.grid_opacity||e.gridOpacity||.4),grid_stroke_width:Number(e.grid_stroke_width||e.gridStrokeWidth||1),grid_horizontal_count:Number(e.grid_horizontal_count||e.gridHorizontalCount||3),grid_vertical_count:Number(e.grid_vertical_count||e.gridVerticalCount||5),animatable:!1!==e.animatable,tracer_speed:Number(e.tracer_speed||e.tracerSpeed||0),pulse_speed:Number(e.pulse_speed||e.pulseSpeed||0),decimation:Number(e.decimation||0),max_points:Number(e.max_points||e.maxPoints||1e3),features:[]};return n.gradient&&n.features.push("gradient"),n.pattern&&n.features.push("pattern"),"none"!==n.fill&&n.features.push("area-fill"),n.fillGradient&&n.features.push("area-gradient"),n.show_points&&n.features.push("data-points"),n.thresholds&&n.thresholds.length>0&&n.features.push("thresholds"),n.zero_line&&n.features.push("zero-line"),n.glow&&n.features.push("glow"),n.shadow&&n.features.push("shadow"),n.blur&&n.features.push("blur"),n.bracket_style&&n.features.push("brackets"),n.status_indicator&&n.features.push("status"),n.scan_line&&n.features.push("scan-line"),n.grid_lines&&n.features.push("grid"),n.show_last_value&&n.features.push("value-label"),"none"!==n.smoothing_mode&&n.features.push("smoothing"),n.tracer_speed>0&&n.features.push("tracer"),n.pulse_speed>0&&n.features.push("pulse"),n}_renderEnhancedSparkline(e,t,n,s,r,i,o,a){const l=[this._buildDefinitions(o,e.id),this._buildSparklineBackground(s,r,o,e.id),this._buildGridLines(s,r,o,e.id),this._buildThresholdLines(i,s,r,o,e.id),this._buildZeroLine(i,s,r,o,e.id),this._buildAreaFill(i,s,r,o,e.id),this._buildMainSparklinePath(i,s,r,o,e.id,a),this._buildDataPoints(i,s,r,o,e.id),this._buildValueLabel(i,s,r,o,e.id),this._buildBrackets(s,r,o,e.id),this._buildStatusIndicator(s,r,o,e.id),this._buildScanLine(s,r,o,e.id)].filter(Boolean);return console.log(`[SparklineRenderer] Rendered enhanced sparkline ${e.id} with ${o.features.length} features`),`<g data-overlay-id="${e.id}"\n                data-overlay-type="sparkline"\n                data-source="${e.source}"\n                data-sparkline-features="${o.features.join(",")}"\n                data-animation-ready="${!!a.hasAnimations}"\n                transform="translate(${t}, ${n})">\n              ${l.join("\n")}\n            </g>`}_buildDefinitions(e,t){const n=[];return e.gradient&&n.push(Gl.T.createGradientDefinition(e.gradient,`sparkline-gradient-${t}`)),e.fillGradient&&n.push(Gl.T.createGradientDefinition(e.fillGradient,`sparkline-area-gradient-${t}`)),e.pattern&&n.push(Gl.T.createPatternDefinition(e.pattern,`sparkline-pattern-${t}`)),e.glow&&n.push(Gl.T.createGlowFilter(e.glow,`sparkline-glow-${t}`)),e.shadow&&n.push(Gl.T.createShadowFilter(e.shadow,`sparkline-shadow-${t}`)),e.blur&&n.push(Gl.T.createBlurFilter(e.blur,`sparkline-blur-${t}`)),n.length>0?`<defs>${n.join("\n")}</defs>`:""}_buildSparklineBackground(e,t,n,s){return""}_buildGridLines(e,t,n,s){if(!n.grid_lines)return"";const r=[];for(let s=1;s<n.grid_horizontal_count;s++){const i=t/n.grid_horizontal_count*s;r.push(`<line x1="0" y1="${i}" x2="${e}" y2="${i}"\n                        stroke="${n.grid_color}"\n                        stroke-width="${n.grid_stroke_width}"\n                        opacity="${n.grid_opacity}"/>`)}for(let s=1;s<n.grid_vertical_count;s++){const i=e/n.grid_vertical_count*s;r.push(`<line x1="${i}" y1="0" x2="${i}" y2="${t}"\n                        stroke="${n.grid_color}"\n                        stroke-width="${n.grid_stroke_width}"\n                        opacity="${n.grid_opacity}"/>`)}return`<g data-feature="grid-lines">${r.join("\n")}</g>`}_buildThresholdLines(e,t,n,s,r){if(!s.thresholds||0===s.thresholds.length)return"";const i=e.map((e=>e.value)),o=null!==s.min_value?s.min_value:Math.min(...i),a=(null!==s.max_value?s.max_value:Math.max(...i))-o||1,l=s.thresholds.map((e=>{const s=n-(e.value-o)/a*n,r=e.color||"var(--lcars-orange)",i=e.width||1,l=e.opacity||.7,c=e.dash?"4,2":null;return`<line x1="0" y1="${s}" x2="${t}" y2="${s}"\n                    stroke="${r}" stroke-width="${i}" opacity="${l}"\n                    ${c?`stroke-dasharray="${c}"`:""}\n                    data-threshold="${e.value}"/>`}));return`<g data-feature="threshold-lines">${l.join("\n")}</g>`}_buildZeroLine(e,t,n,s,r){if(!s.zero_line)return"";const i=e.map((e=>e.value)),o=null!==s.min_value?s.min_value:Math.min(...i),a=null!==s.max_value?s.max_value:Math.max(...i);if(o>0||a<0)return"";const l=n-(0-o)/(a-o||1)*n;return`<line x1="0" y1="${l}" x2="${t}" y2="${l}"\n                  stroke="${s.zero_line_color}" stroke-width="1" opacity="0.5"\n                  stroke-dasharray="2,2"\n                  data-feature="zero-line"/>`}_buildAreaFill(e,t,n,s,r){if("none"===s.fill&&!s.fillGradient)return"";const i=this._processDataForRendering(e,s),o=this._createSparklinePath(i,{width:t,height:n},s)+` L ${t} ${n} L 0 ${n} Z`;let a=s.fill;return s.fillGradient?a=`url(#sparkline-area-gradient-${r})`:"none"===a&&(a=s.color),`<path d="${o}"\n                  fill="${a}"\n                  fill-opacity="${s.fillOpacity}"\n                  data-feature="area-fill"/>`}_buildMainSparklinePath(e,t,n,s,r,i){const o=this._processDataForRendering(e,s),a=this._createSparklinePath(o,{width:t,height:n},s),l=[];l.push(`d="${a}"`),l.push('fill="none"'),s.gradient?l.push(`stroke="url(#sparkline-gradient-${r})"`):s.pattern?l.push(`stroke="url(#sparkline-pattern-${r})"`):l.push(`stroke="${s.color}"`),l.push(`stroke-width="${s.width}"`),l.push(`stroke-opacity="${s.opacity}"`),l.push(`stroke-linecap="${s.lineCap}"`),l.push(`stroke-linejoin="${s.lineJoin}"`),l.push('vector-effect="non-scaling-stroke"'),"miter"===s.lineJoin&&4!==s.miterLimit&&l.push(`stroke-miterlimit="${s.miterLimit}"`),s.dashArray&&(l.push(`stroke-dasharray="${s.dashArray}"`),0!==s.dashOffset&&l.push(`stroke-dashoffset="${s.dashOffset}"`));const c=[];return s.glow&&c.push(`url(#sparkline-glow-${r})`),s.shadow&&c.push(`url(#sparkline-shadow-${r})`),s.blur&&c.push(`url(#sparkline-blur-${r})`),c.length>0&&l.push(`filter="${c.join(" ")}"`),l.push(...i.pathAttributes),`<path ${l.join(" ")} data-feature="main-path"/>`}_buildDataPoints(e,t,n,s,r){if(!s.show_points)return"";const i=this._processDataForRendering(e,s),o=this._calculateDataPointPositions(i,{width:t,height:n},s),a=s.point_color||s.color,l=s.point_size;return`<g data-feature="data-points">${o.map(((e,t)=>`<circle cx="${e.x.toFixed(s.path_precision)}"\n                      cy="${e.y.toFixed(s.path_precision)}"\n                      r="${l}"\n                      fill="${a}"\n                      opacity="${s.opacity}"\n                      data-value="${e.value}"\n                      data-timestamp="${e.timestamp}"/>`)).join("\n")}</g>`}_buildValueLabel(e,t,n,s,r){if(!s.show_last_value||0===e.length)return"";const i=e[e.length-1].value,o=s.value_format?this._formatValue(i,s.value_format):i.toFixed(1),a=Math.min(t/10,n/3,12);return`<text x="${t+4}" y="${n/2}"\n                  fill="${s.color}"\n                  font-size="${a}"\n                  text-anchor="start"\n                  dominant-baseline="middle"\n                  font-family="var(--lcars-font-family, monospace)"\n                  data-feature="value-label">\n              ${o}\n            </text>`}_buildBrackets(e,t,n,s){if(!n.bracket_style)return"";const r=n.bracket_color||n.color,i=n.bracket_width;let o=n.bracket_gap;"none"!==n.smoothing_mode&&(o=Math.max(o,12));const a=n.bracket_corner_radius,l=n.bracket_style_mode;let c,d;return"rounded"===l&&a>0?(c=this._buildRoundedBracketPath("left",o,t,a),d=this._buildRoundedBracketPath("right",e,o,t,a)):"lcars"===l?(c=this._buildLcarsBracketPath("left",o,t),d=this._buildLcarsBracketPath("right",e,o,t)):(c=this._buildSquareBracketPath("left",o,t),d=this._buildSquareBracketPath("right",e,o,t)),`<g data-feature="brackets">\n              <path d="${c}" stroke="${r}" stroke-width="${i}" fill="none"/>\n              <path d="${d}" stroke="${r}" stroke-width="${i}" fill="none"/>\n            </g>`}_buildSquareBracketPath(e,t,n,s){return"left"===e?`M ${-t-4} 0 L ${-t-4} ${n} M ${-t-4} 0 L ${-t/2} 0 M ${-t-4} ${n} L ${-t/2} ${n}`:`M ${t+n/2} 0 L ${t+n+4} 0 M ${t+n+4} 0 L ${t+n+4} ${s} M ${t+n/2} ${s} L ${t+n+4} ${s}`}_buildRoundedBracketPath(e,t,n,s,r){if("left"===e){const e=t,r=n,i=s,o=Math.min(i,e/4,r/6);return`M ${-e-4} ${o}\n              A ${o} ${o} 0 0 1 ${-e-4+o} 0\n              L ${-e/2} 0\n              M ${-e-4} ${r-o}\n              A ${o} ${o} 0 0 0 ${-e-4+o} ${r}\n              L ${-e/2} ${r}\n              M ${-e-4} ${o}\n              L ${-e-4} ${r-o}`}{const e=t,i=n,o=s,a=r,l=Math.min(a,i/4,o/6);return`M ${e+i/2} 0\n              L ${e+i+4-l} 0\n              A ${l} ${l} 0 0 1 ${e+i+4} ${l}\n              M ${e+i/2} ${o}\n              L ${e+i+4-l} ${o}\n              A ${l} ${l} 0 0 0 ${e+i+4} ${o-l}\n              M ${e+i+4} ${l}\n              L ${e+i+4} ${o-l}`}}_buildLcarsBracketPath(e,t,n,s){if("left"===e){const e=t,s=n,r=Math.min(4,e/4,s/10);return`M ${-e-4} ${r}\n              L ${-e-4+r} 0\n              L ${-e/2} 0\n              M ${-e-4} ${s-r}\n              L ${-e-4+r} ${s}\n              L ${-e/2} ${s}\n              M ${-e-4} ${r}\n              L ${-e-4} ${s-r}`}{const e=t,r=n,i=s,o=Math.min(4,r/4,i/10);return`M ${e+r/2} 0\n              L ${e+r+4-o} 0\n              L ${e+r+4} ${o}\n              M ${e+r/2} ${i}\n              L ${e+r+4-o} ${i}\n              L ${e+r+4} ${i-o}\n              M ${e+r+4} ${o}\n              L ${e+r+4} ${i-o}`}}_buildStatusIndicator(e,t,n,s){return n.status_indicator?`<circle cx="-8" cy="${t/2}" r="4"\n                    fill="${"string"==typeof n.status_indicator?n.status_indicator:"var(--lcars-green)"}"\n                    data-feature="status-indicator"/>`:""}_buildScanLine(e,t,n,s){return n.scan_line?`<line x1="0" y1="0" x2="0" y2="${t}"\n                  stroke="${n.color}" stroke-width="1" opacity="0.8"\n                  data-feature="scan-line"\n                  data-scan-speed="${n.tracer_speed||2}">\n              <animate attributeName="x1" values="0;${e};0" dur="3s" repeatCount="indefinite"/>\n              <animate attributeName="x2" values="0;${e};0" dur="3s" repeatCount="indefinite"/>\n            </line>`:""}_createSparklinePath(e,t,n){if(!e||e.length<2)return`M 0 ${t.height/2} L ${t.width} ${t.height/2}`;const{width:s,height:r}=t,i=this._calculateDataPointPositions(e,t,n);let o;switch(n.smoothing_mode){case"chaikin":o=this._createChaikinPath(i,n.path_precision,s);break;case"constrained":o=this._createConstrainedSmoothPath(i,n.path_precision,s);break;case"bezier":o=this._createBezierPath(i,n.path_precision,s);break;case"spline":o=this._createSplinePath(i,n.path_precision,s);break;case"stepped":o=this._createSteppedPath(i,n.path_precision);break;default:o=this._createLinearPath(i,n.path_precision)}return o}_calculateDataPointPositions(e,t,n){const{width:s,height:r}=t,i=e.map((e=>e.value));let o=null!==n.min_value?n.min_value:Math.min(...i),a=null!==n.max_value?n.max_value:Math.max(...i);o===a&&(o-=.5,a+=.5);const l=a-o;return e.map(((t,n)=>({x:n/(e.length-1)*s,y:r-(t.value-o)/l*r,value:t.value,timestamp:t.timestamp})))}_createLinearPath(e,t){const n=[];return e.forEach(((e,s)=>{const r=e.x.toFixed(t),i=e.y.toFixed(t);0===s?n.push(`M ${r} ${i}`):n.push(`L ${r} ${i}`)})),n.join(" ")}_createSteppedPath(e,t){const n=[];return e.forEach(((s,r)=>{const i=s.x.toFixed(t),o=s.y.toFixed(t);if(0===r)n.push(`M ${i} ${o}`);else{const s=e[r-1].y.toFixed(t);n.push(`L ${i} ${s}`),n.push(`L ${i} ${o}`)}})),n.join(" ")}_createChaikinPath(e,t,n){if(e.length<3)return this._createLinearPath(e,t);let s=[...e];for(let e=0;e<2;e++){const e=[];for(let t=0;t<s.length-1;t++){const n=s[t],r=s[t+1];e.push({x:.75*n.x+.25*r.x,y:.75*n.y+.25*r.y}),e.push({x:.25*n.x+.75*r.x,y:.25*n.y+.75*r.y})}s=e}if(s.length>1){const e=Math.min(...s.map((e=>e.x))),t=Math.max(...s.map((e=>e.x))),r=t-e;r>0&&(s=s.map((t=>({x:(t.x-e)/r*n,y:t.y}))))}return this._createLinearPath(s,t)}_createBezierPath(e,t,n){if(e.length<3)return this._createLinearPath(e,t);const s=[`M ${e[0].x.toFixed(t)} ${e[0].y.toFixed(t)}`];for(let n=1;n<e.length-1;n++){const r=e[n-1],i=e[n],o=e[n+1],a=r.x+.5*(i.x-r.x),l=r.y+.5*(i.y-r.y);i.x,o.x,i.x,i.y,o.y,i.y,s.push(`Q ${a.toFixed(t)} ${l.toFixed(t)} ${i.x.toFixed(t)} ${i.y.toFixed(t)}`)}const r=e[e.length-1];return s.push(`L ${r.x.toFixed(t)} ${r.y.toFixed(t)}`),s.join(" ")}_createSplinePath(e,t,n){if(e.length<4)return this._createBezierPath(e,t,n);const s=[];s.push(e[0]);for(let t=1;t<e.length-2;t++){const n=e[t-1],r=e[t],i=e[t+1],o=e[t+2],a=10;for(let e=0;e<=a;e++){const t=e/a,l=t*t,c=l*t,d=-.5*c+l-.5*t,u=1.5*c-2.5*l+1,h=-1.5*c+2*l+.5*t,p=.5*c-.5*l,g=d*n.x+u*r.x+h*i.x+p*o.x,m=d*n.y+u*r.y+h*i.y+p*o.y;s.push({x:g,y:m})}}if(s.push(e[e.length-1]),s.length>1){const e=Math.min(...s.map((e=>e.x))),t=Math.max(...s.map((e=>e.x))),r=t-e;r>0&&s.forEach((t=>{t.x=(t.x-e)/r*n}))}return this._createLinearPath(s,t)}_createConstrainedSmoothPath(e,t,n){if(e.length<3)return this._createLinearPath(e,t);const s=[];s.push(`M ${e[0].x.toFixed(t)} ${e[0].y.toFixed(t)}`);for(let n=0;n<e.length-1;n++){const r=e[n],i=e[n+1];let o,a,l,c;if(0===n){const t=e[n+2]||i;o=r.x+.3*(i.x-r.x),a=r.y+.2*(i.y-r.y),l=i.x-.2*(t.x-r.x),c=i.y-.1*(t.y-r.y)}else if(n===e.length-2){const t=e[n-1];o=r.x+.2*(i.x-t.x),a=r.y+.1*(i.y-t.y),l=i.x-.3*(i.x-r.x),c=i.y-.2*(i.y-r.y)}else{const t=e[n-1],s=e[n+2],d={x:i.x-t.x,y:i.y-t.y},u={x:s.x-r.x,y:s.y-r.y};o=r.x+.25*d.x,a=r.y+.15*d.y,l=i.x-.25*u.x,c=i.y-.15*u.y}o=Math.max(r.x,Math.min(i.x,o)),l=Math.max(r.x,Math.min(i.x,l)),s.push(`C ${o.toFixed(t)} ${a.toFixed(t)} ${l.toFixed(t)} ${c.toFixed(t)} ${i.x.toFixed(t)} ${i.y.toFixed(t)}`)}return s.join(" ")}_processDataForRendering(e,t){let n=[...e];if(t.decimation>0&&n.length>t.decimation){const s=Math.floor(n.length/t.decimation);n=n.filter(((e,t)=>t%s==0)),n[n.length-1]!==e[e.length-1]&&n.push(e[e.length-1])}if(t.max_points>0&&n.length>t.max_points){const s=Math.floor(n.length/t.max_points);n=n.filter(((e,t)=>t%s==0)),n[n.length-1]!==e[e.length-1]&&n.push(e[e.length-1])}return n}_renderEnhancedStatusIndicator(e,t,n,s,r,i,o,a){const l={NO_SOURCE:"var(--lcars-red)",MANAGER_NOT_AVAILABLE:"var(--lcars-blue)",SOURCE_NOT_FOUND:"var(--lcars-orange)",NO_BUFFER:"var(--lcars-orange)",EMPTY_BUFFER:"var(--lcars-blue)",INSUFFICIENT_DATA:"var(--lcars-blue)",ERROR:"var(--lcars-red)"}[i.status]||o.color,c={NO_SOURCE:"NO SOURCE",MANAGER_NOT_AVAILABLE:"LOADING",SOURCE_NOT_FOUND:"NOT FOUND",NO_BUFFER:"NO BUFFER",EMPTY_BUFFER:"NO DATA",INSUFFICIENT_DATA:"LOADING",ERROR:"ERROR"}[i.status]||"UNKNOWN",d=Math.min(s/8,r/3,14),u=["MANAGER_NOT_AVAILABLE","INSUFFICIENT_DATA"].includes(i.status),h=u?'\n      <animate attributeName="opacity" values="0.3;1.0;0.3" dur="1s" repeatCount="indefinite"/>\n    ':'\n      <animate attributeName="opacity" values="0.3;0.8;0.3" dur="2s" repeatCount="indefinite"/>\n    ',p=[this._buildDefinitions(o,e.id),o.bracket_style?this._buildBrackets(s,r,{...o,color:l},e.id):"",`<rect width="${s}" height="${r}"\n             fill="none" stroke="${l}" stroke-width="2"\n             stroke-dasharray="${u?"4,2":"8,4"}" opacity="0.6">\n        ${h}\n       </rect>`,`<text x="${s/2}" y="${r/2}"\n             fill="${l}" text-anchor="middle" dominant-baseline="middle"\n             font-family="var(--lcars-font-family, monospace)"\n             font-size="${d}" font-weight="bold">\n        ${c}\n       </text>`,s>120?`<text x="${s/2}" y="${r/2+d+4}"\n                           fill="${l}" text-anchor="middle" dominant-baseline="middle"\n                           font-family="var(--lcars-font-family, monospace)"\n                           font-size="${Math.max(8,.6*d)}" opacity="0.7">\n                      ${e.source||"NO SOURCE ID"}\n                     </text>`:""].filter(Boolean);return`<g data-overlay-id="${e.id}"\n                data-overlay-type="sparkline"\n                data-source="${e.source||"unknown"}"\n                data-status="${i.status}"\n                data-animation-ready="${!!a.hasAnimations}"\n                transform="translate(${t}, ${n})">\n              ${p.join("\n")}\n            </g>`}_parseGradientConfig(e){return Gl.T.parseGradientConfig(e)}_parsePatternConfig(e){return Gl.T.parsePatternConfig(e)}_parseGlowConfig(e){return Gl.T.parseGlowConfig(e)}_parseShadowConfig(e){return Gl.T.parseShadowConfig(e)}_parseBlurConfig(e){return Gl.T.parseBlurConfig(e)}_parseThresholds(e){return e&&Array.isArray(e)?e.map((e=>({value:Number(e.value||e),color:e.color||"var(--lcars-orange)",width:Number(e.width||1),opacity:Number(e.opacity||.7),dash:e.dash||!1,label:e.label||null}))):[]}_formatValue(e,t){return"function"==typeof t?t(e):"string"==typeof t?t.replace("{value}",e.toFixed(1)):e.toFixed(1)}_prepareAnimationAttributes(e,t){const n={pathAttributes:[],hasAnimations:!1};return!1!==t.animatable&&n.pathAttributes.push('data-animatable="true"'),t.tracer_speed>0&&(n.pathAttributes.push(`data-tracer-speed="${t.tracer_speed}"`),n.hasAnimations=!0),t.pulse_speed>0&&(n.pathAttributes.push(`data-pulse-speed="${t.pulse_speed}"`),n.hasAnimations=!0),n}_renderFallbackSparkline(e,t,n,s,r){const i=e.finalStyle||e.style||{},o=i.color||"var(--lcars-yellow)",a=i.width||2;return console.warn(`[SparklineRenderer] Using fallback rendering for sparkline ${e.id}`),`<g data-overlay-id="${e.id}" data-overlay-type="sparkline" data-fallback="true">\n              <g transform="translate(${t}, ${n})">\n                <path d="M 0 ${r/2} L ${s} ${r/2}"\n                      fill="none" stroke="${o}" stroke-width="${a}"\n                      vector-effect="non-scaling-stroke"/>\n              </g>\n            </g>`}static getHistoricalDataForSparkline(e){if(!e)return{data:null,status:"NO_SOURCE",message:"No data source specified",metadata:{}};try{const{sourceName:t,dataKey:n,isTransformation:s,isAggregation:r}=ql.parseDataSourceReference(e),i=window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager;if(i){console.log(`[SparklineRenderer] 🔍 Checking DataSourceManager for '${t}' with data key: '${n}'`);const e=i.getSource(t);if(e){const i=e.getCurrentData();if(console.log(`[SparklineRenderer] Source data for '${t}':`,{bufferSize:i?.bufferSize||0,historyReady:i?.historyReady,started:i?.started,historyLoaded:i?.stats?.historyLoaded||0,hasTransformations:Object.keys(i?.transformations||{}).length,hasAggregations:Object.keys(i?.aggregations||{}).length,requestedDataKey:n}),n&&(s||r))return ql.getEnhancedDataSourceData(i,n,s,r,t);if(i?.buffer){const e=i.buffer.getAll();if(console.log(`[SparklineRenderer] Raw buffer data for '${t}':`,e),e&&e.length>=2){const n=e.map((e=>({timestamp:e.t,value:e.v})));return console.log(`[SparklineRenderer] ✅ Found ${n.length} data points for '${t}'`),{data:n,status:"OK",message:`${n.length} data points`,metadata:{sourceName:t,dataType:"raw",transformations:i.transformations,aggregations:i.aggregations}}}return e&&1===e.length?(console.log(`[SparklineRenderer] ⚠️ Only 1 data point available for '${t}'`),{data:null,status:"INSUFFICIENT_DATA",message:"Only 1 data point available (need 2+ for sparkline)",metadata:{sourceName:t,dataType:"raw"}}):(console.log(`[SparklineRenderer] ⚠️ Buffer exists but is empty for '${t}'`),{data:null,status:"EMPTY_BUFFER",message:"Buffer exists but contains no data",metadata:{sourceName:t,dataType:"raw"}})}return console.log(`[SparklineRenderer] ⚠️ Data source '${t}' found but no buffer`),{data:null,status:"NO_BUFFER",message:"Data source found but no buffer available",metadata:{sourceName:t}}}const o=Array.from(i.sources.keys());return console.warn(`[SparklineRenderer] ❌ Source '${t}' not found in DataSourceManager`),{data:null,status:"SOURCE_NOT_FOUND",message:`Source '${t}' not found. Available: ${o.join(", ")}`,metadata:{requestedSource:t,availableSources:o}}}return{data:null,status:"MANAGER_NOT_AVAILABLE",message:"DataSourceManager not available",metadata:{}}}catch(t){return console.error(`[SparklineRenderer] Error getting data for '${e}':`,t),{data:null,status:"ERROR",message:`Error occurred: ${t.message}`,metadata:{error:t.message}}}}static updateSparklineData(e,t,n){console.log(`[SparklineRenderer] updateSparklineData called for ${t.id}:`,{hasBuffer:!!n?.buffer,bufferSize:n?.buffer?.size?.()||0,currentStatus:e.getAttribute("data-status"),elementFound:!!e,currentValue:n?.v}),e&&t&&n?(new ql)._updateSparklineElementSynchronized(e,t,n):console.warn("[SparklineRenderer] updateSparklineData: Missing required parameters")}_updateSparklineElementSynchronized(e,t,n){if(null!==e.getAttribute("data-status")&&(n.buffer||n.historicalData))return void this._upgradeStatusIndicatorToSparkline(e,t,n);const s=this._extractHistoricalData(n);if(s.length<2)return console.warn(`[SparklineRenderer] Insufficient data for sparkline ${t.id}: ${s.length} points`),void e.setAttribute("data-status",0===s.length?"NO_DATA":"INSUFFICIENT_DATA");try{const n={width:t.size?.[0]||200,height:t.size?.[1]||60},r=t.finalStyle||t.style||{},i=this._resolveSparklineStyles(r,t.id);this._updateSparklinePathAndMarkers(e,s,n,i,t.id),this._updateSparklineFeatures(e,s,n,i,t.id),e.removeAttribute("data-status"),e.setAttribute("data-last-update",Date.now()),console.log(`[SparklineRenderer] ✅ Synchronized update for sparkline ${t.id} with ${s.length} points`)}catch(n){console.error(`[SparklineRenderer] Error in synchronized update for ${t.id}:`,n),e.setAttribute("data-status","ERROR")}}_updateSparklinePathAndMarkers(e,t,n,s,r){const i=this._processDataForRendering(t,s),o=e.querySelector('path[data-feature="main-path"]');if(o){const e=this._createSparklinePath(i,n,s);o.setAttribute("d",e)}const a=e.querySelector('g[data-feature="data-points"]');if(a&&s.show_points){const e=this._calculateDataPointPositions(i,n,s),t=a.querySelectorAll("circle");e.forEach(((e,n)=>{let r=t[n];r||(r=document.createElementNS("http://www.w3.org/2000/svg","circle"),a.appendChild(r)),r.setAttribute("cx",e.x.toFixed(s.path_precision)),r.setAttribute("cy",e.y.toFixed(s.path_precision)),r.setAttribute("r",s.point_size),r.setAttribute("data-value",e.value),r.setAttribute("data-timestamp",e.timestamp)}));for(let n=e.length;n<t.length;n++)t[n].remove()}const l=e.querySelector('path[data-feature="area-fill"]');if(l&&("none"!==s.fill||s.fillGradient)){const e=this._createSparklinePath(i,n,s)+` L ${n.width} ${n.height} L 0 ${n.height} Z`;l.setAttribute("d",e)}}_updateSparklineFeatures(e,t,n,s,r){const i=e.querySelector('text[data-feature="value-label"]');if(i&&s.show_last_value&&t.length>0){const e=t[t.length-1].value,n=s.value_format?this._formatValue(e,s.value_format):e.toFixed(1);i.textContent=n}const o=e.querySelector('g[data-feature="threshold-lines"]');if(o&&s.thresholds&&s.thresholds.length>0){const e=t.map((e=>e.value)),r=null!==s.min_value?s.min_value:Math.min(...e),i=(null!==s.max_value?s.max_value:Math.max(...e))-r||1;s.thresholds.forEach(((e,t)=>{const s=o.children[t];if(s){const t=n.height-(e.value-r)/i*n.height;s.setAttribute("y1",t),s.setAttribute("y2",t)}}))}const a=e.querySelector('line[data-feature="zero-line"]');if(a&&s.zero_line){const e=t.map((e=>e.value)),r=null!==s.min_value?s.min_value:Math.min(...e),i=null!==s.max_value?s.max_value:Math.max(...e);if(r<=0&&i>=0){const e=i-r||1,t=n.height-(0-r)/e*n.height;a.setAttribute("y1",t),a.setAttribute("y2",t),a.style.display=""}else a.style.display="none"}}_upgradeStatusIndicatorToSparkline(e,t,n){const s=this._extractHistoricalData(n);if(s.length>1){const n=t.size||[200,60],[r,i]=n,o=t.finalStyle||t.style||{},a=this._resolveSparklineStyles(o,t.id),l=this._prepareAnimationAttributes(t,o),c=[this._buildDefinitions(a,t.id),this._buildSparklineBackground(r,i,a,t.id),this._buildGridLines(r,i,a,t.id),this._buildThresholdLines(s,r,i,a,t.id),this._buildZeroLine(s,r,i,a,t.id),this._buildAreaFill(s,r,i,a,t.id),this._buildMainSparklinePath(s,r,i,a,t.id,l),this._buildDataPoints(s,r,i,a,t.id),this._buildValueLabel(s,r,i,a,t.id),this._buildBrackets(r,i,a,t.id),this._buildStatusIndicator(r,i,a,t.id),this._buildScanLine(r,i,a,t.id)].filter(Boolean);e.innerHTML=c.join("\n"),e.removeAttribute("data-status"),e.setAttribute("data-last-update",Date.now()),e.setAttribute("data-sparkline-features",a.features.join(",")),console.log(`[SparklineRenderer] ✅ Upgraded status indicator ${t.id} to full sparkline with ${a.features.length} features and ${s.length} data points`)}else e.setAttribute("data-status",0===s.length?"NO_DATA":"INSUFFICIENT_DATA")}_extractHistoricalData(e){let t=[];if(e.buffer&&"function"==typeof e.buffer.getAll)t=e.buffer.getAll().map((e=>({timestamp:e.t,value:e.v}))),console.log("[SparklineRenderer] Using buffer data:",t.length,"points");else if(e.historicalData&&Array.isArray(e.historicalData))t=e.historicalData,console.log("[SparklineRenderer] Using pre-formatted historical data:",t.length,"points");else if(void 0!==e.v&&void 0!==e.t){console.log("[SparklineRenderer] Generating demo data from current value:",e.v);const n=Date.now();for(let s=0;s<20;s++)t.push({timestamp:n-6e4*(19-s),value:e.v+(Math.random()-.5)*(.1*e.v)})}return t}getCapabilities(){return{pathSmoothing:["none","constrained","chaikin","bezier","spline","stepped"],dataVisualization:["points","thresholds","zero-line","value-labels"],styling:["gradients","patterns","area-fill","dash-patterns"],effects:["glow","shadow","blur"],lcarsFeatures:["brackets","status-indicator","scan-line","grid-lines"],animations:["tracer","pulse"],performance:["decimation","max-points","viewport-optimization"],advanced:!0}}static parseDataSourceReference(e){const t=e.split("."),n=t[0];if(1===t.length)return{sourceName:n,dataKey:null,isTransformation:!1,isAggregation:!1};if(t.length>=3){const e=t[1];return{sourceName:n,dataKey:t.slice(2).join("."),isTransformation:"transformations"===e,isAggregation:"aggregations"===e}}return{sourceName:n,dataKey:null,isTransformation:!1,isAggregation:!1}}static getEnhancedDataSourceData(e,t,n,s,r){try{let i=null,o="unknown";if(n&&e.transformations)i=e.transformations[t],o="transformation",console.log(`[SparklineRenderer] 🔄 Accessing transformation '${t}':`,i);else if(s&&e.aggregations){const n=e.aggregations[t];o="aggregation",i="object"==typeof n&&null!==n?void 0!==n.avg?n.avg:void 0!==n.value?n.value:void 0!==n.slope?n.slope:n:n,console.log(`[SparklineRenderer] 📊 Accessing aggregation '${t}':`,n,"-> value:",i)}return null==i?{data:null,status:"ENHANCED_DATA_NOT_FOUND",message:`${o} '${t}' not found or has no data`,metadata:{sourceName:r,dataKey:t,dataType:o,availableTransformations:Object.keys(e.transformations||{}),availableAggregations:Object.keys(e.aggregations||{})}}:"number"==typeof i?ql.generateSyntheticHistoricalData(i,e,r,t,o):"object"==typeof i?ql.extractHistoricalFromObject(i,e,r,t,o):{data:null,status:"ENHANCED_DATA_NOT_NUMERIC",message:`${o} '${t}' is not numeric: ${typeof i}`,metadata:{sourceName:r,dataKey:t,dataType:o,value:i}}}catch(e){return console.error("[SparklineRenderer] Error accessing enhanced data:",e),{data:null,status:"ENHANCED_DATA_ERROR",message:`Error accessing ${n?"transformation":"aggregation"} '${t}': ${e.message}`,metadata:{sourceName:r,dataKey:t,error:e.message}}}}static generateSyntheticHistoricalData(e,t,n,s,r){const i=[],o=Date.now();if(t.buffer){const o=t.buffer.getAll();if(o.length>1)return o.forEach((n=>{let s=e;if("transformation"===r){const r=t.v?e/t.v:1;s=n.v*r}else"aggregation"===r&&(s=e+(Math.random()-.5)*(.1*e));i.push({timestamp:n.t,value:s})})),console.log(`[SparklineRenderer] ✅ Generated ${i.length} synthetic ${r} points for '${s}'`),{data:i,status:"OK_SYNTHETIC",message:`${i.length} synthetic ${r} points`,metadata:{sourceName:n,dataKey:s,dataType:r,synthetic:!0,currentValue:e,basedOnRawData:!0}}}for(let t=19;t>=0;t--){const n=o-3e4*t,s=(Math.random()-.5)*(.05*e);i.push({timestamp:n,value:e+s})}return console.log(`[SparklineRenderer] ⚠️ Generated ${i.length} fallback synthetic ${r} points for '${s}'`),{data:i,status:"OK_SYNTHETIC_FALLBACK",message:`${i.length} fallback synthetic ${r} points`,metadata:{sourceName:n,dataKey:s,dataType:r,synthetic:!0,currentValue:e,basedOnRawData:!1}}}static extractHistoricalFromObject(e,t,n,s,r){return e.direction&&void 0!==e.slope?ql.generateSyntheticHistoricalData(e.slope,t,n,`${s}.slope`,"trend-slope"):void 0!==e.avg?ql.generateSyntheticHistoricalData(e.avg,t,n,`${s}.avg`,"stats-average"):void 0!==e.count&&void 0!==e.last?ql.generateSyntheticHistoricalData(e.last,t,n,`${s}.last`,"session-last"):(console.warn(`[SparklineRenderer] Unknown aggregation object structure for '${s}':`,e),{data:null,status:"ENHANCED_OBJECT_UNKNOWN",message:`Unknown aggregation object structure for '${s}'`,metadata:{sourceName:n,dataKey:s,dataType:r,objectKeys:Object.keys(e)}})}static debugSparklineUpdates(){console.log("🔍 Enhanced Sparkline Update Debug Report"),console.log("==========================================");const e=window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager;if(e){const t=e.getStats();console.log("DataSourceManager stats:",t)}else console.warn("DataSourceManager not accessible via debug interface")}static debugDataSource(e){console.log(`🔍 Enhanced Debugging data source: ${e}`),console.log("====================================================");const t=window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager;if(!t)return void console.error("❌ DataSourceManager not available");const n=t.getSource(e);return n?{source:n}:(console.error(`❌ Source '${e}' not found`),void console.log("Available sources:",Array.from(t.sources.keys())))}}"undefined"!=typeof window&&(window.SparklineRenderer=ql);class Vl{constructor(e){this.routerCore=e,this.markerCache=new Map,this.gradientCache=new Map,this.patternCache=new Map,this.textAttachmentPoints=new Map}setTextAttachmentPoints(e){this.textAttachmentPoints=e||new Map}render(e,t,n){if(!this.routerCore)return console.error("[LineOverlayRenderer] RouterCore not available for line rendering"),"";let s=Ul.Q.resolvePosition(e.anchor,t),r=Ul.Q.resolvePosition(e.attach_to,t),i=null;if(!r&&e.attach_to&&this.textAttachmentPoints.has(e.attach_to)&&(i=this.textAttachmentPoints.get(e.attach_to),r=this._computeTextAttachPoint(s,i,e)),!s||!r)return console.warn(`[LineOverlayRenderer] Line ${e.id} missing anchor points`),"";try{const t=this.routerCore.buildRouteRequest(e,s,r),n=this.routerCore.computePath(t);if(!n?.d)return console.warn(`[LineOverlayRenderer] No path computed for line ${e.id}`),"";const i=e.finalStyle||e.style||{},o=this._resolveLineStyles(i,e.id),a=this._prepareAnimationAttributes(e,i),l=[this._buildDefinitions(o,e.id),this._buildMainPath(n.d,o,e.id,a),this._buildMarkers(n,o,e.id),this._buildEffects(n,o,e.id)].filter(Boolean);return console.log(`[LineOverlayRenderer] Rendered enhanced line ${e.id} with ${o.features.length} features`),`<g data-overlay-id="${e.id}"\n                  data-overlay-type="line"\n                  data-routing-strategy="${n.meta?.strategy||"unknown"}"\n                  data-animation-ready="${!!a.hasAnimations}">\n                ${l.join("\n")}\n              </g>`}catch(t){return console.error(`[LineOverlayRenderer] Enhanced rendering failed for line ${e.id}:`,t),this._renderFallbackLine(e,s,r)}}_resolveLineStyles(e,t){const n={color:e.color||e.stroke||"var(--lcars-orange)",width:Number(e.width||e.stroke_width||e.strokeWidth||2),opacity:Number(e.opacity||1),lineCap:(e.line_cap||e.lineCap||e.strokeLinecap||"round").toLowerCase(),lineJoin:(e.line_join||e.lineJoin||e.strokeLinejoin||"round").toLowerCase(),miterLimit:Number(e.miter_limit||e.miterLimit||4),dashArray:e.dash_array||e.dashArray||e.strokeDasharray||null,dashOffset:Number(e.dash_offset||e.dashOffset||e.strokeDashoffset||0),fill:e.fill||"none",fillOpacity:Number(e.fill_opacity||e.fillOpacity||1),gradient:this._parseGradientConfig(e.gradient),pattern:this._parsePatternConfig(e.pattern),markerStart:this._parseMarkerConfig(e.marker_start||e.markerStart),markerMid:this._parseMarkerConfig(e.marker_mid||e.markerMid),markerEnd:this._parseMarkerConfig(e.marker_end||e.markerEnd),glow:this._parseGlowConfig(e.glow),shadow:this._parseShadowConfig(e.shadow),animatable:!1!==e.animatable,pulseSpeed:Number(e.pulse_speed||0),flowSpeed:Number(e.flow_speed||0),segment_colors:this._parseSegmentColors(e.segment_colors),status_indicator:e.status_indicator||null,features:[]};return n.gradient&&n.features.push("gradient"),n.pattern&&n.features.push("pattern"),(n.markerStart||n.markerMid||n.markerEnd)&&n.features.push("markers"),n.glow&&n.features.push("glow"),n.shadow&&n.features.push("shadow"),n.segment_colors&&n.features.push("segments"),n.pulseSpeed>0&&n.features.push("pulse"),n.flowSpeed>0&&n.features.push("flow"),n}_parseGradientConfig(e){if(!e)return null;if("string"==typeof e){const t=e.match(/^(.+?)-to-(.+)$/);return t?{type:"linear",direction:"horizontal",stops:[{offset:"0%",color:t[1].trim()},{offset:"100%",color:t[2].trim()}]}:null}return"object"==typeof e?{type:e.type||"linear",direction:e.direction||"horizontal",stops:e.stops||[{offset:"0%",color:e.from||"#ff6600"},{offset:"100%",color:e.to||"#ffcc00"}]}:null}_parsePatternConfig(e){return e?"string"==typeof e?{type:e,size:8,color:"currentColor"}:"object"==typeof e?{type:e.type||"dots",size:Number(e.size||8),color:e.color||"currentColor",opacity:Number(e.opacity||.5)}:null:null}_parseMarkerConfig(e){return e?"string"==typeof e?{type:e,size:"medium",color:"inherit"}:"object"==typeof e?{type:e.type||"arrow",size:e.size||"medium",color:e.color||"inherit",rotate:!1!==e.rotate}:null:null}_parseGlowConfig(e){return e?!0===e?{color:"currentColor",size:4,opacity:.6}:"object"==typeof e?{color:e.color||"currentColor",size:Number(e.size||4),opacity:Number(e.opacity||.6)}:null:null}_parseShadowConfig(e){return e?!0===e?{color:"rgba(0,0,0,0.3)",offset:[2,2],blur:3}:"object"==typeof e?{color:e.color||"rgba(0,0,0,0.3)",offset:e.offset||[2,2],blur:Number(e.blur||3)}:null:null}_parseSegmentColors(e){return e&&Array.isArray(e)?e.map((e=>({color:e.color||"var(--lcars-orange)",start:Number(e.start||0),end:Number(e.end||1)}))):null}_buildDefinitions(e,t){const n=[];return e.gradient&&n.push(this._createGradientDefinition(e.gradient,t)),e.pattern&&n.push(this._createPatternDefinition(e.pattern,t)),["markerStart","markerMid","markerEnd"].forEach((s=>{e[s]&&n.push(this._createMarkerDefinition(e[s],t,s))})),e.glow&&n.push(this._createGlowFilter(e.glow,t)),e.shadow&&n.push(this._createShadowFilter(e.shadow,t)),n.length>0?`<defs>${n.join("\n")}</defs>`:""}_createGradientDefinition(e,t){const n=`line-gradient-${t}`;return"radial"===e.type?`<radialGradient id="${n}">${e.stops.map((e=>`<stop offset="${e.offset}" stop-color="${e.color}"/>`)).join("")}</radialGradient>`:`<linearGradient id="${n}" ${this._getLinearGradientCoords(e.direction)}>${e.stops.map((e=>`<stop offset="${e.offset}" stop-color="${e.color}"/>`)).join("")}</linearGradient>`}_getLinearGradientCoords(e){const t={horizontal:'x1="0%" y1="0%" x2="100%" y2="0%"',vertical:'x1="0%" y1="0%" x2="0%" y2="100%"',diagonal:'x1="0%" y1="0%" x2="100%" y2="100%"',"diagonal-reverse":'x1="100%" y1="0%" x2="0%" y2="100%"'};return t[e]||t.horizontal}_createPatternDefinition(e,t){const n=`line-pattern-${t}`,s=e.size;let r="";switch(e.type){case"dots":r=`<circle cx="${s/2}" cy="${s/2}" r="1" fill="${e.color}" opacity="${e.opacity}"/>`;break;case"diagonal":r=`<path d="M0,${s} L${s},0" stroke="${e.color}" stroke-width="1" opacity="${e.opacity}"/>`;break;case"grid":r=`\n          <path d="M0,0 L0,${s}" stroke="${e.color}" stroke-width="0.5" opacity="${e.opacity}"/>\n          <path d="M0,0 L${s},0" stroke="${e.color}" stroke-width="0.5" opacity="${e.opacity}"/>\n        `}return`<pattern id="${n}" x="0" y="0" width="${s}" height="${s}" patternUnits="userSpaceOnUse">\n              ${r}\n            </pattern>`}_createMarkerDefinition(e,t,n){const s=`line-marker-${t}-${n}`,r=this._getMarkerSize(e.size);let i="",o=`0 0 ${r} ${r}`,a=r/2,l=r/2;switch(e.type){case"arrow":o="0 0 10 10",a=8,l=5,i=`<path d="M2,2 L8,5 L2,8 z" fill="${"inherit"===e.color?"currentColor":e.color}"/>`;break;case"dot":i=`<circle cx="${r/2}" cy="${r/2}" r="${r/4}" fill="${"inherit"===e.color?"currentColor":e.color}"/>`;break;case"diamond":i=`<path d="M${r/2},2 L${r-2},${r/2} L${r/2},${r-2} L2,${r/2} z" fill="${"inherit"===e.color?"currentColor":e.color}"/>`;break;case"square":i=`<rect x="2" y="2" width="${r-4}" height="${r-4}" fill="${"inherit"===e.color?"currentColor":e.color}"/>`}return`<marker id="${s}"\n                    viewBox="${o}"\n                    refX="${a}" refY="${l}"\n                    markerWidth="${r}" markerHeight="${r}"\n                    markerUnits="strokeWidth"\n                    orient="${e.rotate?"auto":"0"}">\n              ${i}\n            </marker>`}_getMarkerSize(e){return{small:6,medium:8,large:12,xlarge:16}[e]||Number(e)||8}_createGlowFilter(e,t){return`<filter id="line-glow-${t}" x="-50%" y="-50%" width="200%" height="200%">\n              <feGaussianBlur stdDeviation="${e.size}" result="coloredBlur"/>\n              <feMerge>\n                <feMergeNode in="coloredBlur"/>\n                <feMergeNode in="SourceGraphic"/>\n              </feMerge>\n            </filter>`}_createShadowFilter(e,t){const n=`line-shadow-${t}`,[s,r]=e.offset;return`<filter id="${n}" x="-50%" y="-50%" width="200%" height="200%">\n              <feDropShadow dx="${s}" dy="${r}"\n                           stdDeviation="${e.blur}"\n                           flood-color="${e.color}"/>\n            </filter>`}_buildMainPath(e,t,n,s){const r=[];r.push(`d="${e}"`),r.push(`fill="${t.fill}"`),r.push(`fill-opacity="${t.fillOpacity}"`),t.gradient?r.push(`stroke="url(#line-gradient-${n})"`):t.pattern?r.push(`stroke="url(#line-pattern-${n})"`):r.push(`stroke="${t.color}"`),r.push(`stroke-width="${t.width}"`),r.push(`stroke-opacity="${t.opacity}"`),r.push(`stroke-linecap="${t.lineCap}"`),r.push(`stroke-linejoin="${t.lineJoin}"`),"miter"===t.lineJoin&&4!==t.miterLimit&&r.push(`stroke-miterlimit="${t.miterLimit}"`),t.dashArray&&(r.push(`stroke-dasharray="${t.dashArray}"`),0!==t.dashOffset&&r.push(`stroke-dashoffset="${t.dashOffset}"`)),t.markerStart&&r.push(`marker-start="url(#line-marker-${n}-markerStart)"`),t.markerMid&&r.push(`marker-mid="url(#line-marker-${n}-markerMid)"`),t.markerEnd&&r.push(`marker-end="url(#line-marker-${n}-markerEnd)"`);const i=[];return t.glow&&i.push(`url(#line-glow-${n})`),t.shadow&&i.push(`url(#line-shadow-${n})`),i.length>0&&r.push(`filter="${i.join(" ")}"`),r.push(...s.pathAttributes),`<path ${r.join(" ")}/>`}_buildMarkers(e,t,n){return""}_buildEffects(e,t,n){return t.features.includes("flow"),t.features.includes("pulse"),[].join("\n")}_prepareAnimationAttributes(e,t){const n={hasAnimations:!1,pathAttributes:[],groupAttributes:[]};return!1!==t.animatable&&n.pathAttributes.push('data-animatable="true"'),t.pulse_speed>0&&(n.pathAttributes.push(`data-pulse-speed="${t.pulse_speed}"`),n.hasAnimations=!0),t.flow_speed>0&&(n.pathAttributes.push(`data-flow-speed="${t.flow_speed}"`),n.hasAnimations=!0),e._raw?.animation_ref&&(n.groupAttributes.push(`data-animation-ref="${e._raw.animation_ref}"`),n.hasAnimations=!0),n}_renderFallbackLine(e,t,n){const[s,r]=t,[i,o]=n,a=e.finalStyle||e.style||{},l=a.color||"var(--lcars-orange)",c=a.width||2;return console.warn(`[LineOverlayRenderer] Using fallback rendering for line ${e.id}`),`<g data-overlay-id="${e.id}" data-overlay-type="line" data-fallback="true">\n              <line x1="${s}" y1="${r}" x2="${i}" y2="${o}"\n                    stroke="${l}" stroke-width="${c}"\n                    stroke-linecap="round" fill="none"/>\n            </g>`}updateLineStyle(e,t){console.log(`[LineOverlayRenderer] Style update requested for line ${e}`)}getCapabilities(){return{routing:!0,gradients:!0,patterns:!0,markers:["arrow","dot","diamond","square"],effects:["glow","shadow"],animations:["pulse","flow"],segmentColors:!0,dashPatterns:!0,advanced:!0}}_computeTextAttachPoint(e,t,n){if(!e||!t)return t?.center;const s=n._raw||n.raw||n,r=(s.attach_side||s.attachSide||"auto").toLowerCase(),i=s.attach_gap??s.attachment_gap??s.line_gap??s.gap,o=Number(i??4),{bbox:a,points:l}=t,c=l.center;let d,u=r;if("auto"===u){const t=e[0]-c[0],n=e[1]-c[1];u=Math.abs(t)>=Math.abs(n)?t<=0?"left":"right":n<=0?"top":"bottom"}let h=[0,0];switch(u){case"left":case"left-center":default:d=[a.left,c[1]],h=[-1,0];break;case"right":case"right-center":d=[a.right,c[1]],h=[1,0];break;case"top":case"top-center":d=[c[0],a.top],h=[0,-1];break;case"bottom":case"bottom-center":d=[c[0],a.bottom],h=[0,1]}const p=[d[0]+h[0]*o,d[1]+h[1]*o];return n._attachComputed={targetOverlay:t.id,sideChosen:u,gap:o,basePoint:d,attachPoint:p},p}}var Wl=n(254);class Yl{constructor(e,t,n=null){this.mountEl=e,this.routerCore=t,this.systemsManager=n,this.overlayElements=new Map,this.lastRenderArgs=null,this.lineRenderer=new Vl(t),this.overlayElementCache=new Map,this.textAttachmentPoints=new Map,this._lineDeps=new Map}render(e){if(console.log("[MSD DEBUG] 🎨 AdvancedRenderer.render() ENTRY:",{timestamp:(new Date).toISOString(),hasResolvedModel:!!e,overlayCount:e?.overlays?.length||0,anchorCount:e?.anchors?Object.keys(e.anchors).length:0,hasViewBox:!!e?.viewBox,mountElExists:!!this.mountEl,stackTrace:(new Error).stack.split("\n").slice(1,3).join("\n")}),!e)return console.error("[MSD DEBUG] ❌ AdvancedRenderer.render() - No resolved model provided"),{svgMarkup:"",overlayCount:0};const{overlays:t=[],anchors:n={},viewBox:s}=e;console.log("[MSD DEBUG] 🎨 AdvancedRenderer processing:",{overlayCount:t.length,overlayTypes:t.map((e=>e.type)),anchorCount:Object.keys(n).length,viewBox:s}),this.overlayElements.clear();const r=this.mountEl?.querySelector("svg");if(!r)return console.error("[MSD DEBUG] ❌ AdvancedRenderer.render() - SVG element not found in container:",{mountEl:this.mountEl,mountElTagName:this.mountEl?.tagName,mountElChildren:this.mountEl?.children?.length||0}),{svgMarkup:"",overlayCount:0};console.log("[MSD DEBUG] ✅ SVG element found, proceeding with overlay rendering");const i=this._ensureOverlayGroup(r);i.innerHTML="",this.overlayElementCache.clear(),this.textAttachmentPoints.clear(),t.filter((e=>"text"===e.type)).forEach((e=>{const t=Hl.TextOverlayRenderer.computeAttachmentPoints(e,n,this.mountEl);t&&this.textAttachmentPoints.set(e.id,t)})),this.lineRenderer.setTextAttachmentPoints(this.textAttachmentPoints);const o=new Set(["text","sparkline"]);let a="",l=0;return t.filter((e=>o.has(e.type))).forEach((e=>{try{const t=this.renderOverlay(e,n,s);t&&(a+=t),l++}catch(t){console.warn("[AdvancedRenderer] Phase1 failed for",e.id,t)}})),i.innerHTML=a,this._cacheElementsFrom(i),this._dynamicAnchors={...n},this._buildDynamicOverlayAnchors(t,this._dynamicAnchors),t.filter((e=>!o.has(e.type))).forEach((e=>{try{const t=this.renderOverlay(e,this._dynamicAnchors,s);if(t){i.insertAdjacentHTML("beforeend",t),a+=t;const n=i.querySelector(`[data-overlay-id="${e.id}"]`);n&&this.overlayElementCache.set(e.id,n);const s=e._raw||e.raw||{},r=s.attach_to||s.attachTo;if(r&&(this._lineDeps.has(r)||this._lineDeps.set(r,new Set),this._lineDeps.get(r).add(e.id),this.routerCore&&s.anchor&&this._dynamicAnchors[s.anchor]&&this._dynamicAnchors[r]))try{const t=this.routerCore.buildRouteRequest(e,this._dynamicAnchors[s.anchor],this._dynamicAnchors[r]);this.routerCore.computePath(t)}catch(t){console.warn("[AdvancedRenderer] Overlay-destination route registration failed",e.id,t)}}l++}catch(t){console.warn("[AdvancedRenderer] Phase2 failed for",e.id,t)}})),console.log("[AdvancedRenderer] Injected elements (after phased render):",{total:this.overlayElementCache.size,text:i.querySelectorAll('[data-overlay-type="text"]').length,lines:i.querySelectorAll('[data-overlay-type="line"]').length,sparklines:i.querySelectorAll('[data-overlay-type="sparkline"]').length}),this._scheduleDeferredLineRefresh(t,this._dynamicAnchors,s),this._scheduleFontStabilization(t,this._dynamicAnchors,s),this.lastRenderArgs={resolvedModel:e,overlays:t,svg:r},{svgMarkup:a,overlayCount:l,errors:t.length-l}}_ensureOverlayGroup(e){let t=e.querySelector("#msd-overlay-container");return t||(t=document.createElementNS("http://www.w3.org/2000/svg","g"),t.setAttribute("id","msd-overlay-container"),e.appendChild(t)),t}_cacheElementsFrom(e){e.querySelectorAll("[data-overlay-id]").forEach((e=>{const t=e.getAttribute("data-overlay-id");t&&this.overlayElementCache.set(t,e)}))}_buildDynamicOverlayAnchors(e,t){e.filter((e=>"line"===e.type)).forEach((e=>{const n=e._raw||e.raw||{},s=n.attach_to||n.attachTo;if(!s)return;const r=this.textAttachmentPoints.get(s);if(!r||!r.points)return;const i=(n.attach_side||n.attachSide||"").toLowerCase(),o=this._resolveOverlayAttachmentPoint(r.points,i);if(!o)return;const a=this._applyAttachGap(o,i,n,r.bbox);if(t[s]=a,this.routerCore&&this.routerCore.anchors){this.routerCore.anchors[s]=a;try{this.routerCore.invalidate(e.id);const s=t[n.anchor]||this.routerCore.anchors[n.anchor];if(s){const t=this.routerCore.buildRouteRequest(e,s,a);this.routerCore.computePath(t)}}catch(t){console.warn("[AdvancedRenderer] Route registration (initial) failed",e.id,t)}}this._lineDeps.has(s)||this._lineDeps.set(s,new Set),this._lineDeps.get(s).add(e.id)}))}_updateDynamicAnchorsForOverlays(e,t,n){e.size&&e.forEach((e=>{const s=this.textAttachmentPoints.get(e);if(!s||!s.points)return;const r=this._lineDeps.get(e);r&&r.forEach((r=>{const i=t.find((e=>e.id===r));if(!i)return;const o=i._raw||i.raw||{},a=(o.attach_side||o.attachSide||"").toLowerCase(),l=this._resolveOverlayAttachmentPoint(s.points,a);if(!l)return;const c=this._applyAttachGap(l,a,o,s.bbox);if(n[e]=c,this.routerCore&&this.routerCore.anchors){this.routerCore.anchors[e]=c;try{this.routerCore.invalidate(i.id);const e=n[o.anchor]||this.routerCore.anchors[o.anchor];if(e){const t=this.routerCore.buildRouteRequest(i,e,c);this.routerCore.computePath(t)}}catch(e){console.warn("[AdvancedRenderer] Route registration (update) failed",i.id,e)}}}))}))}_applyAttachGap(e,t,n,s){const r=Number(n.attach_gap||n.attachGap||0),i=Number(n.attach_gap_x||n.attachGapX||r||0),o=Number(n.attach_gap_y||n.attachGapY||r||0);if(!i&&!o)return e;const[a,l]=e;let c=0,d=0;switch(t){case"left":c=-i;break;case"right":c=i;break;case"top":d=-o;break;case"bottom":d=o;break;case"top-left":c=-i,d=-o;break;case"top-right":c=i,d=-o;break;case"bottom-left":c=-i,d=o;break;case"bottom-right":c=i,d=o}return s&&(t.includes("left")&&a>s.left&&(c=-Math.abs(c)),t.includes("right")&&a<s.right&&(c=Math.abs(c)),t.includes("top")&&l>s.top&&(d=-Math.abs(d)),t.includes("bottom")&&l<s.bottom&&(d=Math.abs(d))),[a+c,l+d]}_resolveOverlayAttachmentPoint(e,t){if(!e)return null;switch(t){case"left":return e.left||e.leftPadded||e.center;case"right":return e.right||e.rightPadded||e.center;case"top":return e.top||e.topPadded||e.center;case"bottom":return e.bottom||e.bottomPadded||e.center;case"top-left":return e.topLeft||e.left||e.top||e.center;case"top-right":return e.topRight||e.right||e.top||e.center;case"bottom-left":return e.bottomLeft||e.left||e.bottom||e.center;case"bottom-right":return e.bottomRight||e.right||e.bottom||e.center;default:return e.center}}_scheduleFontStabilization(e,t,n){if(!e.some((e=>"text"===e.type)))return;let s=0;const r=()=>{const i=new Set;let o=!1;e.filter((e=>"text"===e.type)).forEach((e=>{const s=this.overlayElementCache.get(e.id);if(!s)return;const r=Gl.T.getDomTextBBox(s);if(!r)return void(o=!0);const a=parseFloat(s.getAttribute("data-text-width")||"0")||0,l=parseFloat(s.getAttribute("data-text-height")||"0")||0,c=Math.abs(r.width-a),d=Math.abs(r.height-l);if(c>.01||d>.01){const s=this._reRenderSingleTextOverlay(e,t,n);if(s){const t=Gl.T.getDomTextBBox(s);t&&(s.setAttribute("data-text-width",String(t.width)),s.setAttribute("data-text-height",String(t.height)),this._updateStatusIndicatorPosition(s,t)),i.add(e.id),o=!0}}else(c>0||d>0)&&(s.setAttribute("data-text-width",String(r.width)),s.setAttribute("data-text-height",String(r.height)),i.add(e.id)),"1"!==s.getAttribute("data-font-stabilized")&&s.setAttribute("data-font-stabilized","1"),this._updateTextAttachmentPointsFromDom(e,s,r),this._updateStatusIndicatorPosition(s,r)})),this.lineRenderer.setTextAttachmentPoints(this.textAttachmentPoints),i.size&&(this._updateDynamicAnchorsForOverlays(i,e,this._dynamicAnchors),this._rerenderDependentLines(i,e,this._dynamicAnchors,n)),s++;const a=s<15;(i.size||o)&&a?requestAnimationFrame(r):(i.size&&this._scheduleDeferredLineRefresh(e,this._dynamicAnchors,n),setTimeout((()=>{const t=e.filter((e=>"text"===e.type)).some((e=>{const t=this.overlayElementCache.get(e.id);return t&&"1"!==t.getAttribute("data-font-stabilized")}));t&&(console.log("[AdvancedRenderer] Running safety stabilization pass"),s=0,requestAnimationFrame(r))}),180),console.log("[AdvancedRenderer] Font stabilization complete",{passes:s,changed:Array.from(i)}))},i=document.fonts;i&&"loaded"!==i.status?i.ready.then((()=>requestAnimationFrame(r))).catch((()=>requestAnimationFrame(r))):requestAnimationFrame(r)}_scheduleDeferredLineRefresh(e,t,n){if("function"!=typeof requestAnimationFrame)return;const s=e.filter((e=>"line"===e.type&&((e._raw||e.raw||{}).attach_side||(e._raw||e.raw||{}).attach_to)));s.length&&requestAnimationFrame((()=>{s.forEach((e=>{const s=this.overlayElementCache.get(e.id);if(s)try{const r=this.lineRenderer.render(e,t,n);if(!r)return;const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.innerHTML=r.trim();const o=i.firstElementChild;if(!o)return;s.replaceWith(o),this.overlayElementCache.set(e.id,o)}catch(t){console.warn("[AdvancedRenderer] Deferred line refresh failed",e.id,t)}})),console.log("[AdvancedRenderer] Deferred line refresh pass complete")}))}renderOverlay(e,t,n){if(!e||!e.type)return console.warn("[AdvancedRenderer] Invalid overlay - missing type:",e),"";const s=this.mountEl,r=s?.querySelector("svg");switch(r||console.warn("[AdvancedRenderer] SVG element not found in container for overlay:",e.id),r&&(r.style.pointerEvents="auto",r.style.zIndex="0"),e.type){case"text":"title_overlay"===e.id&&console.log("[AdvancedRenderer] 🔍 Passing title_overlay to TextOverlayRenderer:",{id:e.id,color:e.style?.color,status_indicator:e.style?.status_indicator,finalStyleColor:e.finalStyle?.color,finalStyleStatusIndicator:e.finalStyle?.status_indicator});const r=Hl.TextOverlayRenderer.computeAttachmentPoints(e,t,s);return r&&this.textAttachmentPoints.set(e.id,r),Hl.TextOverlayRenderer.render(e,t,n,s);case"sparkline":return ql.render(e,t,n);case"line":return this.lineRenderer.render(e,t,n);case"control":return console.log("[AdvancedRenderer] Control overlay detected, skipping SVG rendering:",e.id),"";case"status_grid":return Wl.StatusGridRenderer.render(e,t,n);default:return console.warn(`[AdvancedRenderer] Unknown overlay type: ${e.type}`),""}}injectSvgContent(e){const t=this.mountEl.querySelector("svg");if(!t)return void console.warn("[AdvancedRenderer] No SVG element found for overlay injection");let n=t.querySelector("#msd-overlay-container");n?n.innerHTML="":(n=document.createElementNS("http://www.w3.org/2000/svg","g"),n.setAttribute("id","msd-overlay-container"),t.appendChild(n));try{n.innerHTML=e,console.log("[AdvancedRenderer] SVG content injected successfully"),this.overlayElementCache.clear(),n.querySelectorAll("[data-overlay-id]").forEach((e=>{const t=e.getAttribute("data-overlay-id");t&&(this.overlayElementCache.set(t,e),console.log(`[AdvancedRenderer] Cached element for overlay: ${t}`))}));const t=n.querySelectorAll('[data-overlay-type="sparkline"]'),s=n.querySelectorAll('[data-overlay-type="line"]'),r=n.querySelectorAll('[data-overlay-type="text"]');console.log("[AdvancedRenderer] Injected elements:",{sparklines:t.length,lines:s.length,texts:r.length,cached:this.overlayElementCache.size})}catch(e){console.error("[AdvancedRenderer] Failed to inject SVG content:",e)}}updateOverlayData(e,t){if(console.log("[AdvancedRenderer] updateOverlayData called:",{overlayId:e,hasSourceData:!!t,sourceDataKeys:t?Object.keys(t):"none",hasBuffer:!!t?.buffer,bufferSize:t?.buffer?.size?.()||0,hasCachedElement:this.overlayElementCache.has(e)}),!t)return void console.warn("[AdvancedRenderer] updateOverlayData: Missing sourceData");const n=this.overlayElementCache.get(e);if(!n)return void console.warn(`[AdvancedRenderer] Could not find cached overlay element: ${e}. Element should be cached during render.`);const s=this.lastRenderArgs?.overlays?.find((t=>t.id===e));if(s)switch(s.type){case"sparkline":ql.updateSparklineData(n,s,t);break;case"text":console.log(`[AdvancedRenderer] Updating text overlay: ${e}`),this.updateTextOverlay(e,t);break;case"status_grid":console.log(`[AdvancedRenderer] Updating status grid overlay: ${e}`),this.updateStatusGridWithTemplates(e,t);break;default:console.warn(`[AdvancedRenderer] Update not implemented for overlay type: ${s.type}`)}else console.warn(`[AdvancedRenderer] Could not find overlay config: ${e}`)}handleDataSourceUpdate(e){if(!this.mountEl)return;const t=Array.from(this.overlayElementCache.values()).filter((t=>t.getAttribute("data-source")===e.sourceId));0!==t.length?t.forEach((t=>{const n=this.lastRenderArgs.overlays?.find((e=>e.id===t.getAttribute("data-overlay-id")));n&&ql.updateSparklineData(t,n,e.data)})):console.log(`[AdvancedRenderer] No cached sparklines found for source: ${e.sourceId}`)}destroy(){this.overlayElements.clear(),this.overlayElementCache.clear(),this.lastRenderArgs=null}_updateTextAttachmentPointsFromDom(e,t,n){if(!e||!t||!n)return;const s={id:e.id,center:[n.centerX,n.centerY],bbox:{left:n.left,right:n.right,top:n.top,bottom:n.bottom,width:n.width,height:n.height},points:{center:[n.centerX,n.centerY],top:[n.centerX,n.top],bottom:[n.centerX,n.bottom],left:[n.left,n.centerY],right:[n.right,n.centerY],topLeft:[n.left,n.top],topRight:[n.right,n.top],bottomLeft:[n.left,n.bottom],bottomRight:[n.right,n.bottom]}};this.textAttachmentPoints.set(e.id,s)}_rerenderDependentLines(e,t,n,s){if(!e||!e.size)return;const r=new Set;e.forEach((e=>{const t=this._lineDeps.get(e);t&&t.forEach((e=>r.add(e)))})),r.size&&requestAnimationFrame((()=>{r.forEach((e=>{const r=t.find((t=>t.id===e));if(!r)return;const i=this.overlayElementCache.get(e);if(i)try{const t=this.lineRenderer.render(r,n,s);if(!t)return;const o=document.createElementNS("http://www.w3.org/2000/svg","g");o.innerHTML=t.trim();const a=o.firstElementChild;if(!a)return;i.replaceWith(a),this.overlayElementCache.set(e,a)}catch(t){console.warn("[AdvancedRenderer] Dep line re-render failed",e,t)}})),console.log("[AdvancedRenderer] Rerendered dependent lines after font stabilization",{count:r.size})}))}_reRenderSingleTextOverlay(e,t,n){try{const s=this.overlayElementCache.get(e.id);if(!s)return null;const r=Hl.TextOverlayRenderer.render(e,t,n,this.mountEl);if(!r)return null;const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.innerHTML=r.trim();const o=i.firstElementChild;if(!o)return null;s.replaceWith(o),this.overlayElementCache.set(e.id,o);const a=Gl.T.getDomTextBBox(o);return a&&this._updateTextAttachmentPointsFromDom(e,o,a),o}catch(t){return console.warn("[AdvancedRenderer] Re-render text overlay failed",e.id,t),null}}_updateStatusIndicatorPosition(e,t){try{if(!e)return;const n=e.querySelector('circle[data-decoration="status-indicator"]');if(!n)return;const s=n.getAttribute("data-status-pos")||"left-center",r=.4*Number(e.getAttribute("data-font-size")||16),i=Gl.T._getSvgTransformInfo(this.mountEl),o=8,a=i?i.pixelToViewBox(o):r,l=t;let c=l.centerX,d=l.centerY;switch(s){case"top-left":c=l.left-a,d=l.top-a;break;case"top-right":c=l.right+a,d=l.top-a;break;case"bottom-left":c=l.left-a,d=l.bottom+a;break;case"bottom-right":c=l.right+a,d=l.bottom+a;break;case"top":c=l.centerX,d=l.top-a;break;case"bottom":c=l.centerX,d=l.bottom+a;break;case"left":case"left-center":default:c=l.left-a,d=l.centerY;break;case"right":case"right-center":c=l.right+a,d=l.centerY;break;case"center":c=l.centerX,d=l.centerY}n.setAttribute("cx",c),n.setAttribute("cy",d),n.setAttribute("r",r)}catch(e){}}updateTextOverlay(e,t){try{const s=this.mountEl.querySelector(`[data-overlay-id="${e}"] text`);if(!s)return void console.warn(`[AdvancedRenderer] Text element not found for overlay: ${e}`);const r=this.systemsManager?.rulesEngine?.getResolvedModel?.()||this.systemsManager?.getResolvedModel?.()||window.__msdDebug?.pipelineInstance?.getResolvedModel?.(),i=r?.overlays?.find((t=>t.id===e));if(!i)return void console.warn(`[AdvancedRenderer] Overlay configuration not found: ${e}`);Promise.resolve().then(n.bind(n,333)).then((({TextOverlayRenderer:n})=>{const r=(new n)._resolveTextContentWithData(i,i.finalStyle||{},t);r&&r!==s.textContent?(console.log(`[AdvancedRenderer] Updating text overlay ${e}: "${s.textContent}" → "${r}"`),s.textContent=n.escapeXml(r),this.updateTextDecorations(e,r,i),console.log(`[AdvancedRenderer] ✅ Text overlay ${e} updated successfully`)):console.log(`[AdvancedRenderer] Text overlay ${e} content unchanged`)})).catch((t=>{console.error(`[AdvancedRenderer] Failed to update text overlay ${e}:`,t)}))}catch(t){console.error(`[AdvancedRenderer] Error updating text overlay ${e}:`,t)}}updateTextDecorations(e,t,n){try{this.mountEl.querySelector(`[data-overlay-id="${e}"] [data-decoration="status-indicator"]`)&&n.finalStyle?.status_indicator&&console.log(`[AdvancedRenderer] Status indicator position may need updating for ${e}`)}catch(t){console.error(`[AdvancedRenderer] Error updating text decorations for ${e}:`,t)}}updateStatusGrid(e,t){console.log(`[AdvancedRenderer] Updating status grid ${e} with ${t.length} cells`);const n=this.mountEl?.querySelector(`[data-overlay-id="${e}"]`);if(!n)return void console.warn(`[AdvancedRenderer] Status grid element not found: ${e}`);console.log(`[AdvancedRenderer] Status grid ${e} cells updated:`,t);const s=(new Date).toISOString();n.setAttribute("data-last-update",s),console.log(`[AdvancedRenderer] ✅ Status grid ${e} update placeholder completed`)}updateStatusGridWithTemplates(e,t){console.log(`[AdvancedRenderer] Updating status grid ${e} with DataSource data`);try{const s=this.systemsManager?.rulesEngine?.getResolvedModel?.()||this.systemsManager?.getResolvedModel?.()||window.__msdDebug?.pipelineInstance?.getResolvedModel?.(),r=s?.overlays?.find((t=>t.id===e));if(!r)return void console.warn(`[AdvancedRenderer] Status grid overlay configuration not found: ${e}`);Promise.resolve().then(n.bind(n,254)).then((({StatusGridRenderer:n})=>{const s=new n,i=r.finalStyle||r.style||{},o=s.updateCellsWithData(r,i,t);console.log(`[AdvancedRenderer] Processing ${o.length} updated cells for grid ${e}`),o.forEach((e=>{const t=this.mountEl?.querySelector(`[data-cell-content="${e.id}"]`);if(t&&void 0!==e.content){const n=t.textContent?.trim();let s=e.content;"object"==typeof s&&(console.warn(`[AdvancedRenderer] Cell ${e.id} has object content, converting to string`),s=null!==s?String(s):"N/A"),s=String(s),s!==n&&(console.log(`[AdvancedRenderer] Updating cell ${e.id}: "${n}" → "${s}"`),t.textContent=s)}})),console.log(`[AdvancedRenderer] ✅ Status grid ${e} updated successfully`)})).catch((t=>{console.error(`[AdvancedRenderer] Failed to update status grid ${e}:`,t)}))}catch(t){console.error(`[AdvancedRenderer] Error updating status grid ${e}:`,t)}}_hasTemplateContentEnhanced(e){if(!e)return!1;switch(e.type){case"text":const t=e.content||e._raw?.content||e.raw?.content;return t&&"string"==typeof t&&t.includes("{");case"status_grid":const n=e.cells||e._raw?.cells||e.raw?.cells;return!(!n||!Array.isArray(n))&&n.some((e=>e.content&&"string"==typeof e.content&&e.content.includes("{")||e.label&&"string"==typeof e.label&&e.label.includes("{")));default:const s=e.content||e._raw?.content||e.raw?.content;return s&&"string"==typeof s&&s.includes("{")}}_initializeEnhancedTemplateDetection(){const e=this.systemsManager?.overlayUpdater;e&&e._hasTemplateContent&&(console.log("[AdvancedRenderer] Enhancing BaseOverlayUpdater template detection for status grids"),e._hasTemplateContent.bind(e),e._hasTemplateContent=e=>this._hasTemplateContentEnhanced(e),console.log("[AdvancedRenderer] ✅ Enhanced template detection activated"))}}class Xl{constructor(){this.enabled=!1,this.debugLayer=null,this.anchorMarkers=new Map,this.boundingBoxes=new Map,this.routingOverlays=new Map,this.performanceOverlays=new Map,this.scale=1,this.debugManager=null,this.unsubscribeDebug=null,this._lastRenderContext=null}init(e){this.debugManager=e.debugManager,this.unsubscribeDebug=this.debugManager.onChange((e=>{"feature"!==e.type&&"scale"!==e.type&&"router-ready"!==e.type||this._scheduleRerender()}))}setScale(e=1){this.scale=Math.max(.3,Math.min(3,e)),console.log(`[MsdDebugRenderer] Scale factor set to: ${this.scale}`)}render(e,t,n={}){const s=this.debugManager?.getSnapshot();if(!s?.enabled)return;if(this._lastRenderContext={root:e,viewBox:t,opts:n},!this.debugManager||!this.debugManager.initialized)return;if(!e||"function"!=typeof e.querySelector)return void console.warn("[MsdDebugRenderer] Invalid root element");const r=e.querySelector("svg");r?(this.setScale(s.scale),this.integrateWithAdvancedRenderer(r,t,n.anchors),this.debugLayer&&(this.debugLayer.innerHTML=""),s.enabled?(console.log("[MsdDebugRenderer] Rendering debug features"),s.anchors&&n.anchors&&(console.log("[MsdDebugRenderer] Rendering anchors..."),this.renderAnchorMarkers(n.anchors)),s.bounding_boxes&&n.overlays&&(console.log("[MsdDebugRenderer] Rendering bounding boxes..."),this.renderOverlayBounds(n.overlays)),s.routing&&this.debugManager.canRenderRouting()&&(console.log("[MsdDebugRenderer] Rendering routing guides..."),this.renderRoutingGuides(n)),s.performance&&(console.log("[MsdDebugRenderer] Rendering performance overlays..."),this.renderPerformanceOverlays(n)),this.debugLayer&&(this.debugLayer.style.display="block")):this.debugLayer&&(this.debugLayer.style.display="none")):console.warn("[MsdDebugRenderer] No SVG element found in root")}_scheduleRerender(){this._lastRenderContext&&requestAnimationFrame((()=>{const{root:e,viewBox:t,opts:n}=this._lastRenderContext;this.render(e,t,n)}))}renderRoutingGuides(e){if(!this.debugLayer)return;this.routingOverlays.forEach((e=>e.remove())),this.routingOverlays.clear();const t=e.router||window.__msdDebug?.routing;if(!t||"function"!=typeof t.inspect)return void console.log("[MsdDebugRenderer] Routing system not available for debug rendering");const n=(e.overlays||[]).filter((e=>"line"===e.type));if(0===n.length)return void console.log("[MsdDebugRenderer] No line overlays found for routing visualization");let s=0;n.forEach((e=>{try{const n=t.inspect(e.id);if(n&&n.pts&&n.pts.length>1){const t=this.createRoutingOverlay(e.id,n);this.debugLayer.appendChild(t),this.routingOverlays.set(e.id,t),s++}else console.log(`[MsdDebugRenderer] No route info for overlay ${e.id}`)}catch(t){console.warn(`[MsdDebugRenderer] Failed to render routing guide for ${e.id}:`,t)}})),console.log(`[MsdDebugRenderer] Rendered ${s} routing guides`)}createRoutingOverlay(e,t){const n=this.debugLayer.ownerDocument,s=n.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("class","msd-debug-routing");const r=t.pts||[];if(r.forEach(((e,t)=>{if(Array.isArray(e)&&e.length>=2){const[i,o]=e,a=n.createElementNS("http://www.w3.org/2000/svg","circle");if(a.setAttribute("cx",i),a.setAttribute("cy",o),a.setAttribute("r",2*this.scale),a.setAttribute("fill","magenta"),a.setAttribute("stroke","white"),a.setAttribute("stroke-width",1*this.scale),a.setAttribute("opacity","0.8"),s.appendChild(a),0===t||t===r.length-1||r.length<=6){const e=n.createElementNS("http://www.w3.org/2000/svg","text");e.setAttribute("x",i+4*this.scale),e.setAttribute("y",o-4*this.scale),e.setAttribute("fill","magenta"),e.setAttribute("font-size",8*this.scale),e.setAttribute("font-family","monospace"),e.setAttribute("opacity","0.8"),e.textContent=t,s.appendChild(e)}}})),t.meta){const e=r[0];if(e&&Array.isArray(e)&&e.length>=2){const r=n.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",e[0]),r.setAttribute("y",e[1]-12*this.scale),r.setAttribute("fill","magenta"),r.setAttribute("font-size",9*this.scale),r.setAttribute("font-family","monospace"),r.setAttribute("opacity","0.9"),r.textContent=`${t.meta.strategy||"auto"} (${Math.round(t.meta.cost||0)})`,s.appendChild(r)}}return s}renderAnchorMarkers(e){if(!e||!this.debugLayer)return;this.anchorMarkers.forEach((e=>e.remove())),this.anchorMarkers.clear();let t=0;for(const[n,s]of Object.entries(e))if(Array.isArray(s)&&s.length>=2){const e=this.createAnchorMarker(n,s[0],s[1]);this.debugLayer.appendChild(e),this.anchorMarkers.set(n,e),t++}console.log(`[MsdDebugRenderer] Rendered ${t} anchor markers`)}createAnchorMarker(e,t,n){const s=this.debugLayer.ownerDocument.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("transform",`translate(${t}, ${n})`),s.setAttribute("class","msd-debug-anchor");const r=8*this.scale,i=2*this.scale,o=3*this.scale,a=12*this.scale,l=12*this.scale,c=`\n      <line x1="${-r}" y1="0" x2="${r}" y2="0" stroke="cyan" stroke-width="${i}" opacity="0.8"/>\n      <line x1="0" y1="${-r}" x2="0" y2="${r}" stroke="cyan" stroke-width="${i}" opacity="0.8"/>\n      <circle cx="0" cy="0" r="${o}" fill="cyan" stroke="white" stroke-width="${this.scale}" opacity="0.9"/>\n    `,d=`\n      <text x="${l}" y="4" fill="cyan" font-size="${a}" font-family="monospace" opacity="0.9">\n        ${e} (${Math.round(t)}, ${Math.round(n)})\n      </text>\n    `;return s.innerHTML=c+d,s}renderOverlayBounds(e=[]){if(!this.debugLayer)return;this.boundingBoxes.forEach((e=>{e.rect?.remove(),e.label?.remove()})),this.boundingBoxes.clear();let t=0;e.forEach((e=>{if(e.position&&Array.isArray(e.position)){const[n,s]=e.position,r=this._getOverlayDimensions(e,n,s);if(!r)return;const i=this.createBoundingBox(e.id,r.x,r.y,r.width,r.height);this.debugLayer.appendChild(i.rect),this.debugLayer.appendChild(i.label),this.boundingBoxes.set(e.id,i),t++}})),console.log(`[MsdDebugRenderer] Rendered ${t} bounding boxes`)}createBoundingBox(e,t,n,s,r){const i=this.debugLayer.ownerDocument,o=i.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",t),o.setAttribute("y",n),o.setAttribute("width",s),o.setAttribute("height",r),o.setAttribute("fill","none"),o.setAttribute("stroke","orange"),o.setAttribute("stroke-width",1*this.scale),o.setAttribute("stroke-dasharray",`${3*this.scale},${3*this.scale}`),o.setAttribute("opacity","0.7"),o.setAttribute("class","msd-debug-bbox");const a=i.createElementNS("http://www.w3.org/2000/svg","text");return a.setAttribute("x",t+2*this.scale),a.setAttribute("y",n+12*this.scale),a.setAttribute("fill","orange"),a.setAttribute("font-size",10*this.scale),a.setAttribute("font-family","monospace"),a.setAttribute("opacity","0.9"),a.textContent=e||"unknown",a.setAttribute("class","msd-debug-bbox-label"),{rect:o,label:a}}renderPerformanceOverlays(e){if(!this.debugLayer)return;this.performanceOverlays.forEach((e=>e.remove())),this.performanceOverlays.clear();const t=window.__msdDebug?.getPerf?.()||{},n=[];if(t.timers&&Object.entries(t.timers).forEach((([e,t])=>{if(t&&"object"==typeof t){const s=t.count>0?t.total/t.count:0;n.push(`${e}: ${s.toFixed(2)}ms avg`)}})),t.counters&&Object.entries(t.counters).forEach((([e,t])=>{n.push(`${e}: ${t}`)})),0===n.length&&Object.entries(t).slice(0,10).forEach((([e,t])=>{let s;s="object"==typeof t&&null!==t?void 0!==t.count&&void 0!==t.total?`${(t.count>0?t.total/t.count:0).toFixed(2)}ms avg`:JSON.stringify(t):String(t),n.push(`${e}: ${s}`)})),0===n.length)return void console.log("[MsdDebugRenderer] No performance data available");const s=this.debugLayer.ownerDocument,r=s.createElementNS("http://www.w3.org/2000/svg","g");r.setAttribute("class","msd-debug-performance");const i=10*this.scale,o=10*this.scale,a=200*this.scale,l=5*this.scale,c=s.createElementNS("http://www.w3.org/2000/svg","rect");c.setAttribute("x",i),c.setAttribute("y",o),c.setAttribute("width",a),c.setAttribute("height",(20+15*n.slice(0,8).length)*this.scale),c.setAttribute("fill","rgba(0,0,0,0.8)"),c.setAttribute("stroke","yellow"),c.setAttribute("stroke-width",1*this.scale),c.setAttribute("rx",4*this.scale),r.appendChild(c);const d=s.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",i+l),d.setAttribute("y",o+15*this.scale),d.setAttribute("fill","yellow"),d.setAttribute("font-size",12*this.scale),d.setAttribute("font-family","monospace"),d.setAttribute("font-weight","bold"),d.textContent="Performance",r.appendChild(d),n.slice(0,8).forEach(((e,t)=>{const n=s.createElementNS("http://www.w3.org/2000/svg","text");n.setAttribute("x",i+l),n.setAttribute("y",o+(30+15*t)*this.scale),n.setAttribute("fill","yellow"),n.setAttribute("font-size",10*this.scale),n.setAttribute("font-family","monospace"),n.textContent=e,r.appendChild(n)})),this.debugLayer.appendChild(r),this.performanceOverlays.set("perf-info",r),console.log(`[MsdDebugRenderer] Rendered performance overlay with ${n.length} metrics at scale ${this.scale}`)}integrateWithAdvancedRenderer(e,t,n={}){e&&(this.ensureDebugLayer(e),this.viewBox=t,this.anchors=n)}ensureDebugLayer(e){if(!e)return void console.warn("[MsdDebugRenderer] ensureDebugLayer: no SVG element provided");let t=e.querySelector("#msd-debug-layer");t?console.log("[MsdDebugRenderer] Using existing debug layer"):(console.log("[MsdDebugRenderer] Creating new debug layer"),t=e.ownerDocument.createElementNS("http://www.w3.org/2000/svg","g"),t.id="msd-debug-layer",t.style.pointerEvents="none",t.style.zIndex="1000",e.appendChild(t)),this.debugLayer=t}toggle(e=!this.enabled){return this.enabled=e,this.debugLayer&&(this.debugLayer.style.display=e?"block":"none"),console.log("[MsdDebugRenderer] Debug visualization "+(e?"enabled":"disabled")),e}toggleFeature(e,t){this.features.hasOwnProperty(e)&&(this.features[e]=t,console.log(`[MsdDebugRenderer] Feature '${e}' ${t?"enabled":"disabled"}`),setTimeout((()=>{if(this._lastRenderContext){const{root:e,viewBox:t,opts:n}=this._lastRenderContext;this.render(e,t,n)}}),10))}getDebugState(){return{enabled:this.enabled,features:{...this.features},hasDebugLayer:Boolean(this.debugLayer),markerCount:this.anchorMarkers.size,boundingBoxCount:this.boundingBoxes.size,routingOverlayCount:this.routingOverlays.size,performanceOverlayCount:this.performanceOverlays.size}}_getOverlayDimensions(e,t,n){if(this.debugLayer){const s=this.debugLayer.closest("svg");if(s){const r=s.querySelector(`[data-overlay-id="${e.id}"]`);if(r){const s=r.getAttribute("data-text-width"),i=r.getAttribute("data-text-height"),o=r.getAttribute("data-font-size"),a=r.getAttribute("data-dominant-baseline"),l=r.getAttribute("data-text-anchor");if(s&&i&&"0"!==s&&"0"!==i){console.log(`[MsdDebugRenderer] Using rendered dimensions for ${e.id}: ${s}x${i}, baseline: ${a}, anchor: ${l}`);const r=parseFloat(i),c=parseFloat(s),d=parseFloat(o)||16;let u=n;const h=a||"auto";u="hanging"===h?n:"middle"===h||"central"===h?n-r/2:"text-after-edge"===h?n-r:n-.7*d;let p=t;const g=l||"start";return"middle"===g?p=t-c/2:"end"===g&&(p=t-c),console.log(`[MsdDebugRenderer] Calculated bbox for ${e.id}: x=${p}, y=${u}, baseline=${h}, anchor=${g}`),{x:p,y:u,width:c,height:r}}}}}switch(e.type){case"text":return this._calculateTextOverlayDimensions(e,t,n);case"line":return this._calculateLineOverlayDimensions(e,t,n);case"image":return this._calculateImageOverlayDimensions(e,t,n);case"rect":case"rectangle":return this._calculateRectOverlayDimensions(e,t,n);default:return{x:t,y:n,width:e.size?e.size[0]:100,height:e.size?e.size[1]:20}}}_calculateTextOverlayDimensions(e,t,n){try{const s=this.debugLayer?.closest("svg"),r=s?.parentElement||this.debugLayer;if(window.cblcars?.TextOverlayRenderer?.computeAttachmentPoints){const t=window.cblcars.TextOverlayRenderer.computeAttachmentPoints(e,this.anchors||{},r);if(t&&t.bbox)return console.log(`[MsdDebugRenderer] Using TextOverlayRenderer bbox for ${e.id}`),{x:t.bbox.left,y:t.bbox.top,width:t.bbox.width,height:t.bbox.height}}if(s){const t=s.querySelector(`[data-overlay-id="${e.id}"]`);if(t)try{const n=t.getBBox();if(n.width>0&&n.height>0)return console.log(`[MsdDebugRenderer] Using getBBox for ${e.id}: ${n.width}x${n.height}`),{x:n.x,y:n.y,width:n.width,height:n.height}}catch(t){console.warn(`[MsdDebugRenderer] getBBox failed for ${e.id}:`,t)}}const i=e.finalStyle||e.style||{},o=i.value||e.text||e.content||e._raw?.content||e._raw?.text||"";if(!o)return{x:t,y:n,width:0,height:0};const a=i.font_size||i.fontSize||16,l=(i.font_family||i.fontFamily,.6*a),c=1.2*a,d=o.split("\n"),u=Math.max(...d.map((e=>e.length)))*l,h=d.length*c,p=i.text_anchor||i.textAnchor||"start",g=i.dominant_baseline||i.dominantBaseline||"auto";let m=t;"middle"===p?m=t-u/2:"end"===p&&(m=t-u);let f=n;return f="hanging"===g?n:"middle"===g||"central"===g?n-h/2:"text-after-edge"===g?n-h:n-.7*a,{x:m,y:f,width:u,height:h}}catch(s){return console.warn(`[MsdDebugRenderer] Failed to calculate text dimensions for ${e.id}:`,s),{x:t,y:n,width:100,height:20}}}_calculateLineOverlayDimensions(e,t,n){const s=e.endpoints||e.end_points;if(!s||!Array.isArray(s)||s.length<2)return{x:t,y:n,width:50,height:2};const[r,i]=s,o=Array.isArray(r)?r[0]:r.x||t,a=Array.isArray(r)?r[1]:r.y||n,l=Array.isArray(i)?i[0]:i.x||t+50,c=Array.isArray(i)?i[1]:i.y||n,d=Math.min(o,l),u=Math.min(a,c),h=Math.abs(l-o),p=Math.abs(c-a);return{x:d,y:u,width:Math.max(h,2),height:Math.max(p,2)}}_calculateImageOverlayDimensions(e,t,n){const s=e.finalStyle||e.style||{},r=s.width||e.width||e.size?.[0]||64,i=s.height||e.height||e.size?.[1]||64;return{x:t,y:n,width:parseFloat(r),height:parseFloat(i)}}_calculateRectOverlayDimensions(e,t,n){const s=e.finalStyle||e.style||{},r=s.width||e.width||e.size?.[0]||100,i=s.height||e.height||e.size?.[1]||50;return{x:t,y:n,width:parseFloat(r),height:parseFloat(i)}}destroy(){this.unsubscribeDebug&&(this.unsubscribeDebug(),this.unsubscribeDebug=null),this.debugLayer=null,this._lastRenderContext=null}}"undefined"!=typeof window&&(window.cblcars=window.cblcars||{},window.cblcars.MsdDebugRenderer=Xl);class Jl{constructor(e){this.renderer=e,this.controlElements=new Map,this.hass=null,this.lastRenderArgs=null,this._isRendering=!1,this._lastSignature=null,"undefined"!=typeof window&&(window._msdControlsRenderer=this),console.log("[MsdControlsRenderer] Constructor called")}setHass(e){console.log("[MsdControlsRenderer] setHass called with:",{hasHass:!!e,entityCount:e?.states?Object.keys(e.states).length:0,hasLightDesk:!!e?.states?.["light.desk"],lightDeskState:e?.states?.["light.desk"]?.state,previousHass:!!this.hass,controlElementsCount:this.controlElements.size}),this.hass=e,this.controlElements.size>0?(console.log("[MsdControlsRenderer] Updating HASS context for",this.controlElements.size,"control cards"),this._updateAllControlsHass(e)):console.log("[MsdControlsRenderer] No control elements to update")}_updateAllControlsHass(e){console.log(`[MsdControlsRenderer] Updating HASS for ${this.controlElements.size} control cards`);for(const[t,n]of this.controlElements)try{const s=n.querySelector('[class*="card"], [data-card-type], cb-lcars-button-card, hui-light-card')||n.firstElementChild;s&&this._applyHassToCard(s,e,t)}catch(e){console.warn("[MsdControlsRenderer] Failed to update HASS for control:",t,e)}}_applyHassToCard(e,t,n){console.log(`[MsdControlsRenderer] Updating HASS for ${n}:`,{tagName:e.tagName,isCustomButtonCard:e.tagName.toLowerCase().includes("button-card"),hasConfig:!!e._config,hasSetConfig:"function"==typeof e.setConfig,currentHass:!!e.hass,hasSetHass:"function"==typeof e.setHass,entity:e._config?.entity||"none"});try{const s=e.tagName?e.tagName.toLowerCase():"",r=s.includes("cb-lcars"),i=s.includes("hui-")||s.includes("button-card")&&!s.includes("cb-lcars");if(r){console.log(`[MsdControlsRenderer] Using property assignment for CB-LCARS card: ${n}`);const s=e.hass;if(e._config?.entity&&t.states?.[e._config.entity]){const s=t.states[e._config.entity];console.log(`[MsdControlsRenderer] Updating _stateObj for ${n} entity: ${e._config.entity}`,{oldState:e._stateObj?.state,newState:s?.state,stateChanged:e._stateObj?.state!==s?.state}),e._stateObj=s}e.hass=t,e._hass=t,"function"==typeof e.requestUpdate&&(console.log(`[MsdControlsRenderer] Triggering LitElement property update for ${n}`),e.requestUpdate("hass",s),e.requestUpdate("_hass",s),e._config?.entity&&e.requestUpdate("_stateObj"))}else if(i)if(console.log(`[MsdControlsRenderer] Using setHass() method for standard HA card: ${n}`),e.setHass&&"function"==typeof e.setHass)e.setHass(t);else{console.warn(`[MsdControlsRenderer] Standard HA card ${n} has no setHass method`);const s=e.hass;e.hass=t,e._hass=t,"function"==typeof e.requestUpdate&&e.requestUpdate("hass",s)}else if(console.log(`[MsdControlsRenderer] Using fallback approach for unknown card type: ${n}`),e.setHass&&"function"==typeof e.setHass)e.setHass(t);else{const n=e.hass;e.hass=t,e._hass=t,"function"==typeof e.requestUpdate&&e.requestUpdate("hass",n)}return!0}catch(e){return console.error(`[MsdControlsRenderer] ❌ Failed to update HASS for ${n}:`,e),!1}}async renderControls(e,t){if(this._isRendering)return void console.log("[MsdControlsRenderer] renderControls skipped (in progress)");if(!e?.length)return void console.log("[MsdControlsRenderer] No control overlays to render");if(!t)return void console.error("[MsdControlsRenderer] No resolved model provided");if("undefined"==typeof document)return void console.error("[MsdControlsRenderer] Document not available");const n=e.map((e=>e.id)).sort().join("|");if(this._lastSignature!==n||this.controlElements.size!==e.length){this._isRendering=!0;try{console.log("[MsdControlsRenderer] renderControls called",{count:e.length,ids:e.map((e=>e.id)),signature:n,hasHass:!!this.hass});const s=this.getSvgControlsContainer();if(!s)return void console.error("[MsdControlsRenderer] No SVG container available; abort render");console.log("[MsdControlsRenderer] SVG container found, clearing existing controls"),s.innerHTML="",this.controlElements.clear();for(const n of e)try{await this.renderControlOverlay(n,t)}catch(e){console.error(`[MsdControlsRenderer] Failed to render control overlay ${n.id}:`,e)}this.lastRenderArgs={controlOverlays:e,resolvedModel:t},this._lastSignature=n,console.log("[MsdControlsRenderer] renderControls completed successfully")}catch(e){throw console.error("[MsdControlsRenderer] renderControls failed:",e),e}finally{this._isRendering=!1}}else console.log("[MsdControlsRenderer] renderControls skipped (unchanged signature)",n)}async renderControlOverlay(e,t){const n=document.querySelector(`#msd-control-foreign-${e.id}`);if(n){console.log("[MsdControlsRenderer] Existing foreignObject found for",e.id,"- removing to avoid duplicates");try{n.remove()}catch(e){}}this.controlElements.has(e.id)&&this.controlElements.delete(e.id),console.log("[MsdControlsRenderer] Creating control overlay",e.id);const s=await this.createControlElement(e);s&&(this.positionControlElement(s,e,t),this.controlElements.set(e.id,s))}resolveCardDefinition(e){if(e.card)return e.card;if(e.card_config)return e.card_config;if(e.cardConfig)return e.cardConfig;if(e._card)return e._card;if(e.meta?.card)return e.meta.card;if(e.extension?.card)return e.extension.card;if(!this._rawOverlayIndex){const e=window&&window._msdRawOverlays?window._msdRawOverlays:[];this._rawOverlayIndex=new Map(e.map((e=>[e.id,e])))}const t=this._rawOverlayIndex?.get(e.id);return t?.card?t.card:null}_normalizeCardType(e){return e?e.startsWith("custom:")?e.slice(7):{button:"hui-button-card",light:"hui-light-card",switch:"hui-switch-card",sensor:"hui-sensor-card","binary-sensor":"hui-binary-sensor-card",cover:"hui-cover-card",fan:"hui-fan-card",climate:"hui-climate-card",thermostat:"hui-thermostat-card","media-player":"hui-media-control-card","alarm-panel":"hui-alarm-panel-card","input-number":"hui-input-number-card","input-select":"hui-input-select-card","input-text":"hui-input-text-card",lock:"hui-lock-card",vacuum:"hui-vacuum-card","water-heater":"hui-water-heater-card",weather:"hui-weather-forecast-card"}[e]||e:null}async createControlElement(e){const t=this.resolveCardDefinition(e);if(!t)return console.warn("[MsdControlsRenderer] No card definition found for control overlay",e.id),null;try{const n=t.type;let s=null;const r=this._normalizeCardType(n);console.log("[MsdControls] Creating card element:",{originalType:n,normalizedType:r,overlayId:e.id}),s=r.startsWith("hui-")?await this._createHomeAssistantCard(r,t,e):await this._createCustomCard(r,t,e),s||(console.warn(`Could not create card element for type: ${n}, creating fallback`),s=this._createFallbackCard(n,t)),console.log("[MsdControls] Applying HASS and config:",{overlayId:e.id,hasHass:!!this.hass,hasSetConfig:"function"==typeof s.setConfig}),this.hass&&await this._applyHassContext(s,e.id),await this._configureCard(s,t,e);const i=document.createElement("div");return i.className="msd-control-wrapper",i.dataset.msdControlId=e.id,i.style.position="absolute",i.style.pointerEvents="auto",i.style.touchAction="manipulation",i.appendChild(s),this._setupEventIsolation(i,s,e),i}catch(e){return console.error(`[MSD Controls] Failed to create card ${t?.type}:`,e),this._createFallbackCard(t?.type||"unknown",t)}}async _createHomeAssistantCard(e,t,n){console.log("[MsdControls] Creating HA built-in card:",e);try{if(!window.customCards&&!document.querySelector("home-assistant"))return console.warn("[MsdControls] Home Assistant not fully loaded yet"),null;let t=null;return window.customElements&&window.customElements.get(e)?t=new(window.customElements.get(e)):(t=document.createElement(e),await this._waitForElementUpgrade(t,3e3)),t&&"function"!=typeof t.setConfig&&(console.log("[MsdControls] HA card created but setConfig not available, trying alternative approach"),await new Promise((e=>setTimeout(e,500))),"function"!=typeof t.setConfig)?(console.warn("[MsdControls] HA card does not have setConfig method:",e),null):t}catch(e){return console.warn("[MsdControls] HA card creation failed:",e),null}}async _createCustomCard(e,t,n){console.log("[MsdControls] Starting custom card creation strategies for:",e);let s=null;if(console.log("[MsdControls] Strategy 1: Attempting direct custom element creation for:",e),window.customElements&&"function"==typeof window.customElements.get)try{const t=window.customElements.get(e);t?(s=new t,console.log("[MsdControls] ✅ Strategy 1 SUCCESS: Created via constructor:",e)):console.log("[MsdControls] ❌ Strategy 1 FAILED: No custom element found for:",e)}catch(t){console.log("[MsdControls] ❌ Strategy 1 FAILED: Constructor error for",e,":",t.message)}else console.log("[MsdControls] ❌ Strategy 1 SKIPPED: customElements not available");if(!s){console.log("[MsdControls] Strategy 2: Attempting createElement with upgrade for:",e);try{s=document.createElement(e),s.tagName.toLowerCase()===e.toLowerCase()?(console.log("[MsdControls] Strategy 2: Created element, waiting for upgrade:",e),await this._waitForElementUpgrade(s),"function"==typeof s.setConfig?console.log("[MsdControls] ✅ Strategy 2 SUCCESS: Created via createElement with upgrade:",e):(console.log("[MsdControls] ❌ Strategy 2 FAILED: Element created but no setConfig after upgrade:",e),s=null)):(console.log("[MsdControls] ❌ Strategy 2 FAILED: Generic element created, not custom card:",e),s=null)}catch(t){console.log("[MsdControls] ❌ Strategy 2 FAILED: createElement error for",e,":",t.message)}}if(!s){console.log("[MsdControls] Strategy 3: Attempting body attachment technique for:",e);try{s=document.createElement(e);const t=document.createElement("div");t.style.position="absolute",t.style.left="-10000px",document.body.appendChild(t),t.appendChild(s),console.log("[MsdControls] Strategy 3: Element attached to body, waiting for upgrade:",e),await this._waitForElementUpgrade(s,5e3),s.remove(),t.remove(),"function"==typeof s.setConfig?console.log("[MsdControls] ✅ Strategy 3 SUCCESS: Created via body attachment:",e):(console.log("[MsdControls] ❌ Strategy 3 FAILED: Body attachment did not result in working card:",e),s=null)}catch(t){console.log("[MsdControls] ❌ Strategy 3 FAILED: Body attachment error for",e,":",t.message)}}return s?console.log("[MsdControls] 🎉 Custom card creation SUCCESSFUL for:",e):console.log("[MsdControls] 💥 ALL STRATEGIES FAILED for:",e),s}async _waitForElementUpgrade(e,t=5e3){const n=Date.now();for(console.log("[MsdControls] Waiting for element upgrade:",{tagName:e.tagName,hasSetConfig:"function"==typeof e.setConfig});Date.now()-n<t;){if("function"==typeof e.setConfig)return console.log("[MsdControls] Element upgraded successfully:",e.tagName),e;if(e.updateComplete)try{if(await e.updateComplete,"function"==typeof e.setConfig)return console.log("[MsdControls] Element upgraded via updateComplete:",e.tagName),e}catch(e){}if(window.customElements&&window.customElements.upgrade)try{window.customElements.upgrade(e)}catch(e){}await new Promise((e=>setTimeout(e,100)))}return console.warn("[MsdControls] Element upgrade timeout:",{tagName:e.tagName,hasSetConfig:"function"==typeof e.setConfig,waitTime:Date.now()-n}),e}async _configureCard(e,t,n){const s=this._buildCardConfig(t);if(console.log("[MsdControls] Configuring card:",{overlayId:n.id,cardType:t.type,hasSetConfig:"function"==typeof e.setConfig,hasHass:!!this.hass,config:s}),s&&(await this._applyCardConfig(e,s,n.id)||setTimeout((async()=>{console.log("[MsdControls] Retrying config application after delay:",n.id),await this._applyCardConfig(e,s,n.id)}),1e3)),"function"==typeof e.requestUpdate)try{await e.requestUpdate(),console.log("[MsdControls] Requested update for:",n.id)}catch(e){console.debug("[MsdControls] requestUpdate failed:",e)}if(e.tagName){const t=e.tagName.toLowerCase();t.includes("cb-lcars")||t.includes("button-card")||e._isCustomButtonCard||e.constructor?.name?.includes("Button")?(console.log("[MsdControls] Setting up custom-button-card updates for:",n.id),setTimeout((()=>{try{if(this.hass&&(e.hass=this.hass,e._hass=this.hass),e._config&&"function"==typeof e.setConfig){const t={...e._config};e.setConfig(t),this.hass&&(e.hass=this.hass)}"function"==typeof e.requestUpdate&&e.requestUpdate(),console.debug("[MsdControls] ✅ Custom-button-card initial update completed for:",n.id)}catch(e){console.debug("[MsdControls] Custom-button-card specific update failed:",e)}}),100)):t.startsWith("hui-")&&setTimeout((()=>{try{"function"==typeof e.requestUpdate&&e.requestUpdate(),this.hass&&(e.hass=this.hass)}catch(e){console.debug("[MsdControls] HA card specific update failed:",e)}}),200)}}_buildCardConfig(e){if(!e)return null;let t;if(e.config&&"object"==typeof e.config)t={type:e.type,...e.config};else{const{type:n,config:s,card:r,card_config:i,cardConfig:o,...a}=e;t={type:n,...a}}const n=t.type,s="custom:cb-lcars-button-card"===n||"cb-lcars-button-card"===n||"custom:button-card"===n||"button-card"===n,r="button"===n||"light"===n||"switch"===n||n.startsWith("hui-");return s&&!r&&t.entity?(console.log(`[MsdControlsRenderer] Adding triggers_update for CB-LCARS card with entity: ${t.entity}`),s&&!r&&(console.log(`[MsdControlsRenderer] Setting triggers_update to 'all' for CB-LCARS card: ${t.entity}`),t.triggers_update="all",console.log("[MsdControlsRenderer] CB-LCARS card configured with triggers_update: 'all'")),console.log("[MsdControlsRenderer] CB-LCARS card configured with triggers_update:",t.triggers_update)):r&&console.log(`[MsdControlsRenderer] Skipping triggers_update for built-in HA card: ${n}`),t._msdGenerated=!0,t}async _applyHassContext(e,t){if(!this.hass)return console.warn("[MsdControls] No HASS context available for:",t),!1;console.log("[MsdControls] Starting HASS application strategies for:",t);const n=[()=>{console.log("[MsdControls] HASS Strategy 1: Attempting direct property assignment for:",t);try{e.hass=this.hass;const n=e.hass===this.hass;return n?console.log("[MsdControls] ✅ HASS Strategy 1 SUCCESS: Direct property assignment for:",t):console.log("[MsdControls] ❌ HASS Strategy 1 FAILED: Property assignment did not stick for:",t),n}catch(e){return console.log("[MsdControls] ❌ HASS Strategy 1 FAILED: Property assignment error for",t,":",e.message),!1}},()=>{console.log("[MsdControls] HASS Strategy 2: Attempting property descriptor for:",t);try{return Object.defineProperty(e,"hass",{value:this.hass,writable:!0,configurable:!0}),console.log("[MsdControls] ✅ HASS Strategy 2 SUCCESS: Property descriptor applied for:",t),!0}catch(e){return console.log("[MsdControls] ❌ HASS Strategy 2 FAILED: Property descriptor error for",t,":",e.message),!1}},()=>{console.log("[MsdControls] HASS Strategy 3: Attempting private property fallback for:",t);try{return e._hass=this.hass,"hass"in e&&(e.hass=this.hass,console.log("[MsdControls] HASS Strategy 3: Also set public hass property for:",t)),console.log("[MsdControls] ✅ HASS Strategy 3 SUCCESS: Private property fallback for:",t),!0}catch(e){return console.log("[MsdControls] ❌ HASS Strategy 3 FAILED: Private property error for",t,":",e.message),!1}}];for(const[e,s]of n.entries())if(s())return console.log(`[MsdControls] 🎉 HASS application SUCCESSFUL via strategy ${e+1} for:`,t),!0;return console.log("[MsdControls] 💥 ALL HASS STRATEGIES FAILED for:",t),!1}async _applyCardConfig(e,t,n){if(!t)return!1;console.log("[MsdControls] Applying config:",{overlayId:n,hasSetConfig:"function"==typeof e.setConfig,cardType:t.type,entity:t.entity,triggersUpdate:t.triggers_update,config:t});for(let s=0;s<8;s++)try{if("function"==typeof e.setConfig)return e.setConfig(t),e._config=t,e._config&&e._config.triggers_update?console.log(`[MsdControls] ✅ Config applied with triggers_update:${e._config.triggers_update} for:`,n):console.warn("[MsdControls] ⚠️ Config applied but no triggers_update found for:",n),console.log(`[MsdControls] ✅ Config applied on attempt ${s+1} for:`,n),!0;if(s<7){const e=200*(s+1);console.log(`[MsdControls] Retrying config in ${e}ms for:`,n),await new Promise((t=>setTimeout(t,e)))}}catch(e){console.warn(`[MsdControls] setConfig attempt ${s+1} failed for ${n}:`,e),s<7&&await new Promise((e=>setTimeout(e,200*(s+1))))}e._pendingConfig=t,console.warn("[MsdControls] ❌ Config stored for deferred application:",n);const s=setInterval((()=>{if("function"==typeof e.setConfig)try{e.setConfig(t),e._config=t,console.log("[MsdControls] ✅ Deferred config finally applied:",n),clearInterval(s)}catch(e){console.warn("[MsdControls] Deferred config retry failed:",n,e)}}),1e3);return setTimeout((()=>clearInterval(s)),1e4),!1}_createFallbackCard(e,t){const n=document.createElement("div");n.className="msd-control-fallback",Object.assign(n.style,{border:"2px dashed var(--primary-color, #ffa500)",borderRadius:"8px",padding:"16px",background:"var(--card-background-color, rgba(0,0,0,0.8))",color:"var(--primary-text-color, #ffffff)",fontSize:"14px",textAlign:"center",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",minHeight:"80px"});const s=document.createElement("div");s.textContent=`Card: ${e}`,s.style.fontWeight="bold",s.style.marginBottom="8px";const r=document.createElement("div");return r.textContent="(Card failed to load)",r.style.fontSize="12px",r.style.opacity="0.7",n.appendChild(s),n.appendChild(r),n.addEventListener("click",(()=>{console.log("[MsdControls] Fallback card clicked:",{cardType:e,cardDef:t})})),n}_setupEventIsolation(e,t,n){["click","dblclick","contextmenu","pointerdown","pointerup","pointermove","pointercancel","touchstart","touchend","touchmove","touchcancel","mousedown","mouseup","mousemove","mouseenter","mouseleave","focus","blur","focusin","focusout","keydown","keyup","keypress"].forEach((n=>{e.addEventListener(n,(e=>{(e.target===t||t.contains(e.target))&&e.stopPropagation()}),{capture:!1,passive:!1})})),e.style.pointerEvents="auto",e.style.position="absolute",e.style.zIndex="1000",e.setAttribute("tabindex","0"),t&&(t.style.pointerEvents="auto",t.style.position="relative",t.style.zIndex="1",t.style.touchAction="manipulation")}positionControlElement(e,t,n){const s=this.resolvePosition(t.position,n),r=this.resolveSize(t.size,n);if(!s||!r)return void console.warn("[MSD Controls] Invalid position or size for control:",t.id);const i=this.createSvgForeignObject(t.id,s,r);if(!i)return void console.error("[MSD Controls] Failed to create SVG foreignObject for:",t.id);this.configureControlForSvg(e,t,r),i.appendChild(e);const o=this.getSvgControlsContainer();o&&i.parentNode!==o&&(o.appendChild(i),console.debug("[MSD Controls] Control positioned in SVG coordinates:",t.id,{position:s,size:r}))}createSvgForeignObject(e,t,n){const s=this.renderer.container||this.renderer.mountEl,r=s?.querySelector("svg");if(!r)return console.warn("[MSD Controls] No SVG element found for foreignObject creation"),null;try{const s=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");return s.setAttribute("x",t[0]),s.setAttribute("y",t[1]),s.setAttribute("width",n[0]),s.setAttribute("height",n[1]),s.setAttribute("data-msd-control-id",e),s.setAttribute("id",`msd-control-foreign-${e}`),s.style.pointerEvents="auto",s.style.overflow="visible",s}catch(e){return console.error("[MSD Controls] Failed to create foreignObject:",e),null}}configureControlForSvg(e,t,n){e.style.position="relative",e.style.left="auto",e.style.top="auto",e.style.width="100%",e.style.height="100%",e.style.boxSizing="border-box",e.style.pointerEvents="auto",e.style.zIndex=t.z_index||"auto",e.style.background||e.shadowRoot||(e.style.background="none"),console.debug("[MSD Controls] Configured element for SVG embedding:",t.id)}getSvgControlsContainer(){const e=this.renderer.container||this.renderer.mountEl,t=e?.querySelector("svg");if(!t)return console.warn("[MSD Controls] No SVG element found for controls container"),null;let n=t.querySelector("#msd-controls-container");if(!n){n=document.createElementNS("http://www.w3.org/2000/svg","g"),n.setAttribute("id","msd-controls-container"),n.style.pointerEvents="none";const e=t.querySelector("#msd-overlay-container"),s=t.querySelector("#msd-debug-layer");s?t.insertBefore(n,s):e?t.insertBefore(n,e.nextSibling):t.appendChild(n),console.log("[MSD Controls] Created SVG controls container group")}return n}resolvePosition(e,t){return Ul.Q.resolvePosition(e,t.anchors||{})||(console.warn("[MSD Controls] Position resolution failed, using default [0, 0]"),[0,0])}resolveSize(e,t){return!e||!Array.isArray(e)||e.length<2?[100,100]:[e[0],e[1]]}cleanup(){console.log("[MsdControlsRenderer] Cleaning up controls renderer");for(const[e,t]of this.controlElements)try{const n=t.closest("foreignObject")||document.querySelector(`#msd-control-foreign-${e}`);n&&n.remove?n.remove():t&&t.remove&&t.remove()}catch(t){console.warn(`Failed to remove control element ${e}:`,t)}this.controlElements.clear();const e=this.renderer?.container||this.renderer?.mountEl,t=e?.querySelector("svg"),n=t?.querySelector("#msd-controls-container");if(n)try{n.remove()}catch(e){console.warn("Failed to remove SVG controls container:",e)}const s=e?.querySelector("#msd-controls-container");if(s&&"DIV"===s.tagName)try{s.remove(),console.log("[MsdControlsRenderer] Removed legacy DOM controls container")}catch(e){console.warn("Failed to remove legacy controls container:",e)}this.hass=null}}class Kl{constructor(){this.thresholds=new Map,this.previousSnapshot={}}setThreshold(e,t){const n=parseFloat(t);isNaN(n)?this.thresholds.delete(e):this.thresholds.set(e,{avgMs:n})}resetTimer(e){try{window.__msdDebug?.getPerf?.()?.resetTimer?.(e)}catch{}}clearAllTimers(){try{window.__msdDebug?.getPerf?.()?.clear?.()}catch{}this.thresholds.clear()}exportData(){const e=window.__msdDebug?.getPerf?.()||{},t={timestamp:Date.now(),timers:e.timers||{},counters:e.counters||{},thresholds:Object.fromEntries(this.thresholds)};console.table(t.timers),console.log("[PerformancePanel] Performance data:",t);const n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(n),r=document.createElement("a");r.href=s,r.download=`msd-performance-${Date.now()}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s)}captureData(){const e={},t={},n=[],s=[];try{window.__msdDebug?.getDebugStatusSilent?.();const r=window.__msdDebug?.getPerf?.()||{};r.timers&&Object.entries(r.timers).forEach((([t,r])=>{const i={count:r.count||0,total:r.total||0,avg:r.count>0?r.total/r.count:0,last:r.last||0,max:r.max||0,min:r.min||0};e[t]=i;const o=this.thresholds.get(t);o&&i.avg>o.avgMs&&n.push({type:"threshold",timer:t,current:i.avg,threshold:o.avgMs,severity:i.avg>2*o.avgMs?"high":"medium"});const a=this.previousSnapshot[t];if(a&&a.avg>0){const e=(i.avg-a.avg)/a.avg*100;e>20&&s.push({timer:t,previousAvg:a.avg,currentAvg:i.avg,regression:e})}})),r.counters&&Object.entries(r.counters).forEach((([e,n])=>{t[e]=Number(n)||0})),this.previousSnapshot={...e}}catch(e){console.warn("[PerformancePanel] Data capture failed:",e)}return{timers:e,counters:t,alerts:n,regressions:s}}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Performance Monitor</h3>';const{timers:n,counters:s,alerts:r,regressions:i}=e;t+='<div class="msd-hud-section"><h4>Controls</h4>',t+='<div style="display:flex;flex-wrap:wrap;gap:4px;">',t+='<button data-bus-event="performance:clear-all" onclick="__msdHudBus(\'performance:clear-all\')"\n      style="font-size:10px;padding:2px 6px;background:#666;color:#fff;border:1px solid #888;border-radius:3px;cursor:pointer;">\n      Clear All\n    </button>',t+='<button data-bus-event="performance:export" onclick="__msdHudBus(\'performance:export\')"\n      style="font-size:10px;padding:2px 6px;background:#333;color:#fff;border:1px solid #555;border-radius:3px;cursor:pointer;">\n      Export\n    </button>',t+="</div></div>",r&&r.length>0&&(t+='<div class="msd-hud-section msd-hud-warning"><h4>Threshold Alerts</h4>',r.forEach((e=>{const n="high"===e.severity?"#ff4444":"#ffaa00";t+=`<div class="msd-hud-metric msd-hud-warning">\n          <span class="msd-hud-metric-name" style="color:${n};">${e.timer}</span>\n          <span class="msd-hud-metric-value">${e.current.toFixed(2)}ms > ${e.threshold}ms</span>\n        </div>`})),t+="</div>"),i&&i.length>0&&(t+='<div class="msd-hud-section msd-hud-error"><h4>Performance Regressions</h4>',i.forEach((e=>{t+=`<div class="msd-hud-metric msd-hud-error">\n          <span class="msd-hud-metric-name">${e.timer}</span>\n          <span class="msd-hud-metric-value">+${e.regression.toFixed(1)}%</span>\n        </div>`,t+=`<div class="msd-hud-metric-detail">\n          ${e.previousAvg.toFixed(2)}ms → ${e.currentAvg.toFixed(2)}ms\n        </div>`})),t+="</div>");const o=Object.entries(n||{}).slice(0,10);o.length>0&&(t+='<div class="msd-hud-section"><h4>Timers</h4>',o.sort((([,e],[,t])=>t.avg-e.avg)),o.forEach((([e,n])=>{const s=this.thresholds.has(e),r=this.thresholds.get(e),i=s&&n.avg>r.avgMs?"#ff6666":n.avg>10?"#ffaa00":"#66ff99";t+=`<div class="msd-hud-metric" style="margin:4px 0;padding:4px;border:1px solid #333;border-radius:3px;">\n          <div style="display:flex;justify-content:space-between;">\n            <span class="msd-hud-metric-name">${e}</span>\n            <span class="msd-hud-metric-value" style="color:${i};">${n.avg.toFixed(2)}ms</span>\n          </div>\n          <div style="font-size:10px;color:#888;margin-top:2px;">\n            Count: ${n.count} • Max: ${n.max.toFixed(1)}ms • Last: ${n.last.toFixed(1)}ms\n          </div>\n          <div style="display:flex;gap:4px;margin-top:4px;">\n            <input type="number" placeholder="Threshold (ms)" value="${s?r.avgMs:""}"\n              id="perf-threshold-${e.replace(/[^a-z0-9_-]/gi,"-")}"\n              name="perf-threshold-${e.replace(/[^a-z0-9_-]/gi,"-")}"\n              data-bus-event="performance:set-threshold" data-timer="${e}"\n              onchange="__msdHudBus('performance:set-threshold',{timer:'${e}',value:this.value})"\n              style="width:80px;font-size:9px;padding:1px 3px;">\n            <button data-bus-event="performance:reset-timer"\n              onclick="__msdHudBus('performance:reset-timer',{timer:'${e}'})"\n              style="font-size:9px;padding:1px 4px;background:#555;color:#fff;border:1px solid #777;border-radius:2px;cursor:pointer;">\n              Reset\n            </button>\n          </div>\n        </div>`})),t+="</div>");const a=Object.entries(s||{}).slice(0,8);a.length>0&&(t+='<div class="msd-hud-section"><h4>Counters</h4>',a.forEach((([e,n])=>{t+=`<div class="msd-hud-metric">\n          <span class="msd-hud-metric-name">${e}</span>\n          <span class="msd-hud-metric-value">${n}</span>\n        </div>`})),t+="</div>"),0===o.length&&0===a.length&&(t+='<div class="msd-hud-section">No performance data available</div>');const l=r?.length||0,c=i?.length||0;return t+=`<div class="msd-hud-section msd-hud-summary">\n      ${o.length} timers • ${a.length} counters\n      ${l>0?` • ${l} alerts`:""}\n      ${c>0?` • ${c} regressions`:""}\n    </div>`,t+="</div>",t}}class Zl{captureData(){const e=[],t=[];try{const n=window.__msdDebug?.getDebugStatusSilent?.()||{};let s={};s=n.enabled&&window.__msdDebug?.validation?.issues?window.__msdDebug.validation.issues()||{}:window.__msdDebug?.pipelineInstance?.getValidationIssues?.()||{},s.errors&&s.errors.forEach((t=>{e.push({code:t.code||"unknown",severity:t.severity||"error",message:t.msg||t.message||"Unknown error",overlay:t.overlay,anchor:t.anchor})})),s.warnings&&s.warnings.forEach((e=>{t.push({code:e.code||"unknown",severity:e.severity||"warning",message:e.msg||e.message||"Unknown warning",overlay:e.overlay,anchor:e.anchor})}))}catch(e){}return{errors:e,warnings:t}}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Validation</h3>';const n=e.errors||[];n.length>0&&(t+='<div class="msd-hud-section msd-hud-errors"><h4>Errors</h4>',n.slice(0,6).forEach((e=>{t+=`<div class="msd-hud-metric msd-hud-error"\n          data-select-type="${e.overlay?"overlay":"anchor"}"\n          data-select-id="${e.overlay||e.anchor||e.code}"\n          onclick="__msdHudBus('select:set',{type:'${e.overlay?"overlay":"anchor"}',id:'${e.overlay||e.anchor||e.code}',source:'validation'})"\n        >\n          <span class="msd-hud-metric-name">${e.code}</span>\n          <span class="msd-hud-metric-value">${e.message}</span>\n        </div>`,e.overlay&&(t+=`<div class="msd-hud-metric-detail">Overlay: ${e.overlay}</div>`),e.anchor&&(t+=`<div class="msd-hud-metric-detail">Anchor: ${e.anchor}</div>`)})),t+="</div>");const s=e.warnings||[];s.length>0&&(t+='<div class="msd-hud-section msd-hud-warnings"><h4>Warnings</h4>',s.slice(0,6).forEach((e=>{t+=`<div class="msd-hud-metric msd-hud-warning"\n          data-select-type="${e.overlay?"overlay":"anchor"}"\n          data-select-id="${e.overlay||e.anchor||e.code}"\n          onclick="__msdHudBus('select:set',{type:'${e.overlay?"overlay":"anchor"}',id:'${e.overlay||e.anchor||e.code}',source:'validation'})"\n        >\n          <span class="msd-hud-metric-name">${e.code}</span>\n          <span class="msd-hud-metric-value">${e.message}</span>\n        </div>`,e.overlay&&(t+=`<div class="msd-hud-metric-detail">Overlay: ${e.overlay}</div>`)})),t+="</div>");const r=n.length+s.length;return t+=0===r?'<div class="msd-hud-section msd-hud-success">✅ No validation issues</div>':`<div class="msd-hud-section msd-hud-summary">\n        ${n.length} errors, ${s.length} warnings\n      </div>`,t+="</div>",t}}class Ql{constructor(){this.entityChangeHistory=new Map,this.maxHistoryLength=10,this._setupGlobalHelpers()}_setupGlobalHelpers(){window.__msdInspectDataEntity=e=>{console.log("[DataSourcePanel] Inspecting entity:",e);const t=window.__msdDebug?.dataSourceManager||window.__msdDebug?.pipelineInstance?.dataSourceManager||window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager;if(!t?.getEntity)return void console.warn("[DataSourcePanel] DataSourceManager not available");const n=t.getEntity(e);n?(console.log("[DataSourcePanel] Available dsManager methods:",Object.getOwnPropertyNames(t).filter((e=>"function"==typeof t[e]))),console.group(`🔍 Entity Inspection: ${e}`),console.log("Entity Data:",n),console.table([n]),console.groupEnd(),this._showEntityPopup(e,n)):console.warn("[DataSourcePanel] Entity not found:",e)},window.__msdInspectDataSubscription=e=>{console.log("[DataSourcePanel] Inspecting subscription:",e);const t=window.__msdDebug?.dataSourceManager||window.__msdDebug?.pipelineInstance?.dataSourceManager||window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager;if(!t?.getStats)return void console.warn("[DataSourcePanel] DataSourceManager not available");const n=t.getStats()||{},s=n.sources?.[e]||{};let r=[];try{r=t.getSourceSubscribers?.(e)||[],console.log("[DataSourcePanel] Found subscribers via API:",r)}catch(e){console.warn("[DataSourcePanel] Error getting subscribers:",e)}console.group(`🔍 Subscription Inspection: ${e}`),console.log("Source Stats:",s),console.log("Subscribers:",r),console.log("All Stats:",n),console.groupEnd(),this._showSubscriptionPopup(e,s,r)},window.__msdRefreshDataSources=()=>{const e=window.__msdDebug?.dataSourceManager||window.__msdDebug?.pipelineInstance?.dataSourceManager||window.__msdDebug?.pipelineInstance?.systemsManager?.dataSourceManager;e?.refreshSubscriptions?(e.refreshSubscriptions(),console.log("[DataSourcePanel] Subscriptions refreshed")):console.warn("[DataSourcePanel] Refresh not available"),window.__msdDebug?.hud?.refresh&&window.__msdDebug.hud.refresh()}}_showEntityPopup(e,t){const n=document.getElementById("msd-entity-inspection-popup");n&&n.remove();const s=document.createElement("div");s.id="msd-entity-inspection-popup",s.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: rgba(0, 0, 0, 0.95);\n      color: #66ff99;\n      padding: 20px;\n      border: 2px solid #66ff99;\n      border-radius: 8px;\n      font-family: monospace;\n      font-size: 12px;\n      z-index: 1000002;\n      max-width: 700px;\n      max-height: 80vh;\n      overflow-y: auto;\n      box-shadow: 0 4px 20px rgba(102, 255, 153, 0.3);\n    ";let r=`<h3 style="margin:0 0 16px;color:#ffaa00;">🔍 Entity Inspection: ${e}</h3>`;r+=`\n      <div style="margin-bottom:16px;">\n        <h4 style="margin:0 0 8px;color:#88ffcc;">📊 Entity State</h4>\n        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px;">\n          <div><strong>Current State:</strong> <span style="color:#ffcc88;">${t.state||"N/A"}</span></div>\n          <div><strong>Domain:</strong> ${e.split(".")[0]}</div>\n          <div><strong>Last Changed:</strong> ${t.last_changed?new Date(t.last_changed).toLocaleString():"N/A"}</div>\n          <div><strong>Last Updated:</strong> ${t.last_updated?new Date(t.last_updated).toLocaleString():"N/A"}</div>\n        </div>\n      </div>\n    `,t.attributes&&Object.keys(t.attributes).length>0&&(r+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#88ffcc;">🏷️ Attributes (${Object.keys(t.attributes).length})</h4>\n          <div style="font-size:10px;background:#111;padding:8px;border:1px solid #333;border-radius:4px;max-height:200px;overflow-y:auto;">\n      `,Object.entries(t.attributes).forEach((([e,t])=>{const n="object"==typeof t?JSON.stringify(t):String(t),s=n.length>60?n.substring(0,57)+"...":n;r+=`<div style="margin:2px 0;"><strong style="color:#99ddff;">${e}:</strong> <span style="color:#ccc;">${s}</span></div>`})),r+="</div></div>"),r+=`\n      <div style="margin-bottom:16px;">\n        <h4 style="margin:0 0 8px;color:#88ffcc;">🔧 Raw Entity Data</h4>\n        <div style="font-size:9px;background:#111;padding:8px;border:1px solid #333;border-radius:4px;max-height:200px;overflow-y:auto;word-break:break-all;color:#aaa;">\n          ${JSON.stringify(t,null,2)}\n        </div>\n      </div>\n    `,r+=`\n      <div style="text-align:center;margin-top:20px;border-top:1px solid #333;padding-top:16px;">\n        <button onclick="navigator.clipboard.writeText(JSON.stringify(${JSON.stringify(t)}, null, 2)); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy Entity', 2000);"\n          style="background:#225522;color:#fff;border:1px solid #55aa55;border-radius:4px;padding:6px 12px;cursor:pointer;margin-right:8px;font-size:11px;">\n          Copy Entity\n        </button>\n        <button onclick="this.parentElement.parentElement.remove()"\n          style="background:#333;color:#fff;border:1px solid #555;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:11px;">\n          Close\n        </button>\n      </div>\n    `,s.innerHTML=r,document.body.appendChild(s)}_showSubscriptionPopup(e,t,n=[]){const s=document.getElementById("msd-subscription-popup");s&&s.remove();const r=document.createElement("div");r.id="msd-subscription-popup",r.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: rgba(0, 0, 0, 0.95);\n      color: #ffaa66;\n      padding: 20px;\n      border: 2px solid #ffaa66;\n      border-radius: 8px;\n      font-family: monospace;\n      font-size: 12px;\n      z-index: 1000002;\n      max-width: 600px;\n      max-height: 80vh;\n      overflow-y: auto;\n      box-shadow: 0 4px 20px rgba(255, 170, 102, 0.3);\n    ";let i=`<h3 style="margin:0 0 16px;color:#ff9900;">🔗 Subscription: ${e}</h3>`;if(t&&Object.keys(t).length>0&&(i+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#ffcc88;">📊 Statistics</h4>\n          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px;">\n            <div><strong>Subscribers:</strong> <span style="color:#88ccff;">${t.subscribers||0}</span></div>\n            <div><strong>Updates Received:</strong> <span style="color:#88ff88;">${t.received||0}</span></div>\n            <div><strong>Cache Hits:</strong> <span style="color:#ffcc88;">${t.cacheHits||0}</span></div>\n            <div><strong>Errors:</strong> <span style="color:${t.errors>0?"#ff6666":"#888"};">${t.errors||0}</span></div>\n            <div><strong>Last Update:</strong> ${t.lastUpdate?new Date(t.lastUpdate).toLocaleString():"Never"}</div>\n          </div>\n        </div>\n      `,t.received>0)){const e=((t.cacheHits||0)/t.received*100).toFixed(1);i+=`\n          <div style="margin-bottom:16px;">\n            <h4 style="margin:0 0 8px;color:#ffcc88;">📈 Performance</h4>\n            <div style="font-size:11px;">\n              <div><strong>Cache Hit Rate:</strong> <span style="color:#88ff88;">${e}%</span></div>\n            </div>\n          </div>\n        `}n&&n.length>0?(i+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#ffcc88;">👥 Subscribers (${n.length})</h4>\n          <div style="font-size:10px;background:#111;padding:8px;border:1px solid #333;border-radius:4px;max-height:120px;overflow-y:auto;">\n      `,n.forEach(((e,t)=>{const n=e.name||e.id||`Subscriber ${t+1}`,s=e.type||"unknown";i+=`<div style="margin:2px 0;color:#ccc;">• ${n} <span style="color:#888;">(${s})</span></div>`})),i+="</div></div>"):t.subscribers>0&&(i+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#ffcc88;">👥 Subscribers</h4>\n          <div style="font-size:11px;color:#888;">\n            ${t.subscribers} active subscriber${1===t.subscribers?"":"s"} (basic details available)\n          </div>\n        </div>\n      `);const o={stats:t,subscribers:n};i+=`\n      <div style="margin-bottom:16px;">\n        <h4 style="margin:0 0 8px;color:#ffcc88;">🔧 Raw Data</h4>\n        <div style="font-size:9px;background:#111;padding:8px;border:1px solid #333;border-radius:4px;max-height:200px;overflow-y:auto;word-break:break-all;color:#aaa;">\n          ${JSON.stringify(o,null,2)}\n        </div>\n      </div>\n    `,i+=`\n      <div style="text-align:center;margin-top:20px;border-top:1px solid #333;padding-top:16px;">\n        <button onclick="navigator.clipboard.writeText(JSON.stringify(${JSON.stringify(o)}, null, 2)); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy Data', 2000);"\n          style="background:#552200;color:#fff;border:1px solid #aa5500;border-radius:4px;padding:6px 12px;cursor:pointer;margin-right:8px;font-size:11px;">\n          Copy Data\n        </button>\n        <button onclick="this.parentElement.parentElement.remove()"\n          style="background:#333;color:#fff;border:1px solid #555;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:11px;">\n          Close\n        </button>\n      </div>\n    `,r.innerHTML=i,document.body.appendChild(r)}_createEntityPopup(e,t,n={}){const s=document.getElementById("msd-entity-inspection-popup");s&&s.remove();const r=document.createElement("div");r.id="msd-entity-inspection-popup",r.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: rgba(0, 0, 0, 0.95);\n      color: #66ff99;\n      padding: 20px;\n      border: 2px solid #66ff99;\n      border-radius: 8px;\n      font-family: monospace;\n      font-size: 12px;\n      z-index: 1000002;\n      max-width: 700px;\n      max-height: 80vh;\n      overflow-y: auto;\n      box-shadow: 0 4px 20px rgba(102, 255, 153, 0.3);\n    ";let i=`<h3 style="margin:0 0 16px;color:#ffaa00;">🔍 Entity Inspection: ${e}</h3>`;i+=`\n      <div style="margin-bottom:16px;">\n        <h4 style="margin:0 0 8px;color:#88ffcc;">📊 Entity State</h4>\n        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px;">\n          <div><strong>Current State:</strong> <span style="color:#ffcc88;">${t.state||"N/A"}</span></div>\n          <div><strong>Domain:</strong> ${e.split(".")[0]}</div>\n          <div><strong>Last Changed:</strong> ${t.last_changed?new Date(t.last_changed).toLocaleString():"N/A"}</div>\n          <div><strong>Last Updated:</strong> ${t.last_updated?new Date(t.last_updated).toLocaleString():"N/A"}</div>\n        </div>\n      </div>\n    `,t.attributes&&Object.keys(t.attributes).length>0&&(i+='\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#88ffcc;">🏷️ Attributes</h4>\n          <div style="font-size:10px;background:#111;padding:8px;border:1px solid #333;border-radius:4px;max-height:150px;overflow-y:auto;">\n      ',Object.entries(t.attributes).forEach((([e,t])=>{const n="object"==typeof t?JSON.stringify(t):String(t),s=n.length>50?n.substring(0,47)+"...":n;i+=`<div style="margin:2px 0;"><strong style="color:#99ddff;">${e}:</strong> <span style="color:#ccc;">${s}</span></div>`})),i+="</div></div>"),n.history&&(i+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#88ffcc;">📈 Recent Activity</h4>\n          <div style="font-size:11px;color:#ccc;">\n            <div><strong>Previous State:</strong> ${n.history.state||"N/A"}</div>\n            <div><strong>Changed:</strong> ${new Date(n.history.timestamp).toLocaleString()}</div>\n          </div>\n        </div>\n      `),n.subscribers&&n.subscribers.length>0&&(i+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#88ffcc;">👥 Subscribers (${n.subscribers.length})</h4>\n          <div style="font-size:10px;color:#ccc;">\n      `,n.subscribers.forEach(((e,t)=>{const n="string"==typeof e?e:e.name||e.id||`Subscriber ${t+1}`;i+=`<div style="margin:2px 0;">• ${n}</div>`})),i+="</div></div>"),n.transforms&&n.transforms.length>0&&(i+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#88ffcc;">🔄 Transforms (${n.transforms.length})</h4>\n          <div style="font-size:10px;color:#ccc;">\n      `,n.transforms.forEach(((e,t)=>{const n="string"==typeof e?e:e.type||e.name||`Transform ${t+1}`;i+=`<div style="margin:2px 0;">• ${n}</div>`})),i+="</div></div>"),n.calculations&&n.calculations.length>0&&(i+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#88ffcc;">🧮 Calculations (${n.calculations.length})</h4>\n          <div style="font-size:10px;color:#ccc;">\n      `,n.calculations.forEach(((e,t)=>{const n="string"==typeof e?e:e.type||e.name||`Calculation ${t+1}`;i+=`<div style="margin:2px 0;">• ${n}</div>`})),i+="</div></div>"),i+=`\n      <div style="margin-bottom:16px;">\n        <h4 style="margin:0 0 8px;color:#88ffcc;">🔧 Raw Entity Data</h4>\n        <div style="font-size:9px;background:#111;padding:8px;border:1px solid #333;border-radius:4px;max-height:200px;overflow-y:auto;word-break:break-all;color:#aaa;">\n          ${JSON.stringify(t,null,2)}\n        </div>\n      </div>\n    `,i+=`\n      <div style="text-align:center;margin-top:20px;border-top:1px solid #333;padding-top:16px;">\n        <button onclick="navigator.clipboard.writeText(JSON.stringify(${JSON.stringify(t)}, null, 2)); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy Entity', 2000);"\n          style="background:#225522;color:#fff;border:1px solid #55aa55;border-radius:4px;padding:6px 12px;cursor:pointer;margin-right:8px;font-size:11px;">\n          Copy Entity\n        </button>\n        <button onclick="console.log('Entity ${e}:', ${JSON.stringify(t)}); this.textContent='Logged!'; setTimeout(() => this.textContent='Log to Console', 2000);"\n          style="background:#552255;color:#fff;border:1px solid #aa55aa;border-radius:4px;padding:6px 12px;cursor:pointer;margin-right:8px;font-size:11px;">\n          Log to Console\n        </button>\n        <button onclick="this.parentElement.parentElement.remove()"\n          style="background:#333;color:#fff;border:1px solid #555;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:11px;">\n          Close\n        </button>\n      </div>\n    `,r.innerHTML=i,document.body.appendChild(r)}_showSubscriptionInspectionPopup(e){try{if(!this._currentData?.subscriptions)return void console.warn("[DataSourcePanel] No subscription data available");const t=this._currentData.subscriptions[e];if(!t)return void console.warn("[DataSourcePanel] Subscription not found:",e);console.group(`🔍 Subscription Inspection: ${e}`),console.log("Source Stats:",t),console.groupEnd(),this._createSubscriptionPopup(e,t,{})}catch(e){console.warn("[DataSourcePanel] Subscription inspection failed:",e)}}_createSubscriptionPopup(e,t,n){const s=document.getElementById("msd-subscription-popup");s&&s.remove();const r=document.createElement("div");r.id="msd-subscription-popup",r.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: rgba(0, 0, 0, 0.95);\n      color: #ffaa66;\n      padding: 20px;\n      border: 2px solid #ffaa66;\n      border-radius: 8px;\n      font-family: monospace;\n      font-size: 12px;\n      z-index: 1000002;\n      max-width: 600px;\n      max-height: 80vh;\n      overflow-y: auto;\n      box-shadow: 0 4px 20px rgba(255, 170, 102, 0.3);\n    ";let i=`<h3 style="margin:0 0 16px;color:#ff9900;">🔗 Subscription: ${e}</h3>`;if(t&&Object.keys(t).length>0&&(i+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#ffcc88;">📊 Statistics</h4>\n          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px;">\n            <div><strong>Subscribers:</strong> <span style="color:#88ccff;">${t.subscribers||0}</span></div>\n            <div><strong>Updates Received:</strong> <span style="color:#88ff88;">${t.received||0}</span></div>\n            <div><strong>Cache Hits:</strong> <span style="color:#ffcc88;">${t.cacheHits||0}</span></div>\n            <div><strong>Errors:</strong> <span style="color:${t.errors>0?"#ff6666":"#888"};">${t.errors||0}</span></div>\n            <div><strong>Last Update:</strong> ${t.lastUpdate?new Date(t.lastUpdate).toLocaleString():"Never"}</div>\n          </div>\n        </div>\n      `,t.received>0)){const e=((t.cacheHits||0)/t.received*100).toFixed(1);i+=`\n          <div style="margin-bottom:16px;">\n            <h4 style="margin:0 0 8px;color:#ffcc88;">📈 Performance</h4>\n            <div style="font-size:11px;">\n              <div><strong>Cache Hit Rate:</strong> <span style="color:#88ff88;">${e}%</span></div>\n            </div>\n          </div>\n        `}n&&Object.keys(n).length>0&&(i+='\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#ffcc88;">🔧 Details</h4>\n          <div style="font-size:10px;background:#111;padding:8px;border:1px solid #333;border-radius:4px;max-height:200px;overflow-y:auto;">\n      ',Object.entries(n).forEach((([e,t])=>{const n="object"==typeof t?JSON.stringify(t,null,2):String(t);i+=`<div style="margin:3px 0;"><strong style="color:#ffaa88;">${e}:</strong><br><span style="color:#ccc;margin-left:10px;">${n}</span></div>`})),i+="</div></div>");const o={stats:t,details:n};i+=`\n      <div style="margin-bottom:16px;">\n        <h4 style="margin:0 0 8px;color:#ffcc88;">🔧 Raw Data</h4>\n        <div style="font-size:9px;background:#111;padding:8px;border:1px solid #333;border-radius:4px;max-height:200px;overflow-y:auto;word-break:break-all;color:#aaa;">\n          ${JSON.stringify(o,null,2)}\n        </div>\n      </div>\n    `,i+=`\n      <div style="text-align:center;margin-top:20px;border-top:1px solid #333;padding-top:16px;">\n        <button onclick="navigator.clipboard.writeText(JSON.stringify(${JSON.stringify(o)}, null, 2)); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy Data', 2000);"\n          style="background:#552200;color:#fff;border:1px solid #aa5500;border-radius:4px;padding:6px 12px;cursor:pointer;margin-right:8px;font-size:11px;">\n          Copy Data\n        </button>\n        <button onclick="console.log('Subscription ${e}:', ${JSON.stringify(o)}); this.textContent='Logged!'; setTimeout(() => this.textContent='Log to Console', 2000);"\n          style="background:#552255;color:#fff;border:1px solid #aa55aa;border-radius:4px;padding:6px 12px;cursor:pointer;margin-right:8px;font-size:11px;">\n          Log to Console\n        </button>\n        <button onclick="this.parentElement.parentElement.remove()"\n          style="background:#333;color:#fff;border:1px solid #555;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:11px;">\n          Close\n        </button>\n      </div>\n    `,r.innerHTML=i,document.body.appendChild(r)}refreshSubscriptions(){console.log("[DataSourcePanel] Refresh functionality removed - HUD auto-refreshes")}clearHistory(){console.log("[DataSourcePanel] Clear history functionality removed - limited utility")}captureData(){const e={},t={},n={},s={},r=[];try{const i=window.__msdDebug?.pipelineInstance,o=i?.dataSourceManager||i?.systemsManager?.dataSourceManager||window.__msdDebug?.dataSourceManager;if(o){const i=o.listIds?.()||[],a=o.getStats?.()||{},l=o.getHealth?.()||{};t.count=i.length,t.subscribed=Object.keys(a.sources||{}).length,t.updated=Object.values(a.sources||{}).reduce(((e,t)=>e+(t.received||0)),0),t.cacheHits=Object.values(a.sources||{}).reduce(((e,t)=>e+(t.cacheHits||0)),0),t.errors=Object.values(a.sources||{}).reduce(((e,t)=>e+(t.errors||0)),0),l.status&&(n.status=l.status,n.uptime=l.uptime||0,n.lastError=l.lastError,n.connectionCount=l.connectionCount||0),a.sources&&Object.entries(a.sources).forEach((([e,t])=>{s[e]={subscribers:t.subscribers||0,received:t.received||0,errors:t.errors||0,lastUpdate:t.lastUpdate,cacheHits:t.cacheHits||0}})),i.slice(0,15).forEach((t=>{const n=o.getEntity?.(t);if(n){const s=this.entityChangeHistory.get(t);if(s&&s.state!==n.state&&r.push({id:t,from:s.state,to:n.state,timestamp:Date.now()}),this.entityChangeHistory.set(t,{state:n.state,timestamp:Date.now()}),this.entityChangeHistory.size>this.maxHistoryLength){const e=this.entityChangeHistory.keys().next().value;this.entityChangeHistory.delete(e)}e[t]={state:n.state,lastChanged:n.last_changed,lastUpdated:n.last_updated,attributes:n.attributes||{},domain:t.split(".")[0]}}}))}else console.warn("[DataSourcePanel] DataSourceManager not available via consolidated interface"),t.error="DataSourceManager not available"}catch(e){console.warn("[DataSourcePanel] Data capture failed:",e),t.error=e.message}return{entities:e,stats:t,health:n,subscriptions:s,recentChanges:r}}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Data Sources</h3>';const{entities:n,stats:s,health:r,subscriptions:i,recentChanges:o}=e;if(this._currentData=e,s.error)return t+=`<div class="msd-hud-section msd-hud-error">\n        <h4>Error</h4>\n        <div class="msd-hud-metric-value">${s.error}</div>\n      </div>`,t+="</div>",t;if(r&&r.status){const e="healthy"===r.status?"#66ff99":"warning"===r.status?"#ffaa00":"#ff6666";if(t+='<div class="msd-hud-section"><h4>Health Status</h4>',t+=`<div class="msd-hud-metric">\n        <span class="msd-hud-metric-name">Status</span>\n        <span class="msd-hud-metric-value" style="color:${e};">${r.status}</span>\n      </div>`,r.uptime>0){const e=(r.uptime/36e5).toFixed(1);t+=`<div class="msd-hud-metric">\n          <span class="msd-hud-metric-name">Uptime</span>\n          <span class="msd-hud-metric-value">${e}h</span>\n        </div>`}void 0!==r.connectionCount&&(t+=`<div class="msd-hud-metric">\n          <span class="msd-hud-metric-name">Connections</span>\n          <span class="msd-hud-metric-value">${r.connectionCount}</span>\n        </div>`),r.lastError&&(t+=`<div class="msd-hud-metric msd-hud-warning">\n          <span class="msd-hud-metric-name">Last Error</span>\n          <span class="msd-hud-metric-value">${r.lastError}</span>\n        </div>`),t+="</div>"}if(t+='<div class="msd-hud-section"><h4>Statistics</h4>',t+=`<div class="msd-hud-metric">\n      <span class="msd-hud-metric-name">Total Entities</span>\n      <span class="msd-hud-metric-value">${s.count||0}</span>\n    </div>`,t+=`<div class="msd-hud-metric">\n      <span class="msd-hud-metric-name">Data Sources</span>\n      <span class="msd-hud-metric-value">${s.subscribed||0}</span>\n    </div>`,t+=`<div class="msd-hud-metric">\n      <span class="msd-hud-metric-name">Total Updates</span>\n      <span class="msd-hud-metric-value">${s.updated||0}</span>\n    </div>`,void 0!==s.cacheHits){const e=s.updated>0?(s.cacheHits/s.updated*100).toFixed(1):"0";t+=`<div class="msd-hud-metric">\n        <span class="msd-hud-metric-name">Cache Hit Rate</span>\n        <span class="msd-hud-metric-value">${e}%</span>\n      </div>`}void 0!==s.errors&&s.errors>0&&(t+=`<div class="msd-hud-metric msd-hud-warning">\n        <span class="msd-hud-metric-name">Errors</span>\n        <span class="msd-hud-metric-value">${s.errors}</span>\n      </div>`),t+="</div>",i&&Object.keys(i).length>0&&(t+='<div class="msd-hud-section"><h4>Active Subscriptions</h4>',Object.entries(i).slice(0,6).forEach((([e,n])=>{const s=e.length>18?e.substring(0,15)+"...":e,r=n.errors>0;t+=`<div class="msd-hud-metric ${r?"msd-hud-warning":""}" style="cursor:pointer;"\n          onclick="window.__msdInspectDataSubscription('${e}')">\n          <div style="display:flex;justify-content:space-between;">\n            <span class="msd-hud-metric-name">${s}</span>\n            <span class="msd-hud-metric-value">${n.subscribers} subs</span>\n          </div>\n          <div style="font-size:10px;color:#888;margin-top:2px;">\n            ${n.received} updates • ${n.cacheHits} cached\n            ${r?` • ${n.errors} errors`:""}\n          </div>\n        </div>`})),t+="</div>"),o&&o.length>0&&(t+='<div class="msd-hud-section"><h4>Recent Changes</h4>',o.slice(-5).forEach((e=>{const n=e.id.length>20?e.id.substring(0,17)+"...":e.id,s=Math.round((Date.now()-e.timestamp)/1e3);t+=`<div class="msd-hud-metric" style="cursor:pointer;"\n          onclick="window.__msdInspectDataEntity('${e.id}')">\n          <div style="display:flex;justify-content:space-between;">\n            <span class="msd-hud-metric-name">${n}</span>\n            <span style="font-size:10px;color:#888;">${s}s ago</span>\n          </div>\n          <div class="msd-hud-metric-value" style="font-size:10px;color:#ccc;margin-top:1px;">\n            ${e.from} → ${e.to}\n          </div>\n        </div>`})),t+="</div>");const a=Object.entries(n||{});if(a.length>0){const e={};a.forEach((([t,n])=>{const s=n.domain||"unknown";e[s]||(e[s]=[]),e[s].push([t,n])})),t+='<div class="msd-hud-section"><h4>Entity Samples</h4>',Object.entries(e).slice(0,4).forEach((([e,n])=>{t+=`<div style="margin-bottom:6px;">\n          <div style="font-weight:bold;font-size:11px;color:#ffaa00;">${e} (${n.length})</div>`,n.slice(0,3).forEach((([e,n])=>{const s=e.length>20?e.substring(0,17)+"...":e,r=n.state||"N/A",i=r.length>12?r.substring(0,9)+"...":r;t+=`<div class="msd-hud-metric" style="cursor:pointer;margin-left:10px;"\n            onclick="window.__msdInspectDataEntity('${e}')">\n            <span class="msd-hud-metric-name">${s}</span>\n            <span class="msd-hud-metric-value">${i}</span>\n          </div>`})),t+="</div>"})),t+="</div>"}else s.count>0?t+='<div class="msd-hud-section">Entities available but no recent data</div>':t+='<div class="msd-hud-section">No entity data available</div>';return t+="</div>",t}}class ec{constructor(){this.filters={strategy:"all",minCost:0,maxCost:1500,cacheHit:"all",showArcs:!1},this.inputStates={minCostFocused:!1,maxCostFocused:!1},this._setupGlobalHelpers()}_setupGlobalHelpers(){window.__msdAnalyzeRoute=e=>{console.log("[RoutingPanel] Global analyze for:",e);const t=window.__msdDebug?.routing;if(!t?.inspect)return void console.warn("[RoutingPanel] No routing inspector available");const n=t.inspect(e);if(console.group(`🔍 Route Analysis: ${e}`),n.meta&&console.table({Strategy:n.meta.strategy||"unknown",Cost:n.meta.cost||0,Segments:n.meta.segments||0,Bends:n.meta.bends||0,"Cache Hit":n.meta.cache_hit?"✅ Yes":"❌ No"}),n.pts&&n.pts.length>0&&(console.log("📍 Path Points:",n.pts.length,"points"),console.table(n.pts.map(((e,t)=>({Index:t,X:e[0],Y:e[1],Type:0===t?"Start":t===n.pts.length-1?"End":"Waypoint"}))))),n.meta?.hint&&(console.log("💡 Routing Hints:"),console.table(n.meta.hint)),n.d){const e=n.d.length>100?n.d.substring(0,97)+"...":n.d;console.log("🎨 SVG Path:",e)}console.log("📋 Full Analysis Object:",n),console.groupEnd(),this._showRouteAnalysisPopup(e,n)}}_showRouteAnalysisPopup(e,t){const n=document.getElementById("msd-route-analysis-popup");n&&n.remove();const s=document.createElement("div");s.id="msd-route-analysis-popup",s.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: rgba(0, 0, 0, 0.95);\n      color: #00ffff;\n      padding: 20px;\n      border: 2px solid #00ffff;\n      border-radius: 8px;\n      font-family: monospace;\n      font-size: 12px;\n      z-index: 1000002;\n      max-width: 600px;\n      max-height: 80vh;\n      overflow-y: auto;\n      box-shadow: 0 4px 20px rgba(0, 255, 255, 0.3);\n    ";let r=`<h3 style="margin:0 0 16px;color:#ffaa00;">🔍 Route Analysis: ${e}</h3>`;if(t.meta&&(r+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#88ccff;">📊 Routing Metrics</h4>\n          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px;">\n            <div><strong>Strategy:</strong> ${t.meta.strategy||"unknown"}</div>\n            <div><strong>Cost:</strong> <span style="color:#ffcc88;">${t.meta.cost||0}</span></div>\n            <div><strong>Segments:</strong> ${t.meta.segments||0}</div>\n            <div><strong>Bends:</strong> <span style="color:#ff99cc;">${t.meta.bends||0}</span></div>\n            <div><strong>Cache Hit:</strong> ${t.meta.cache_hit?'<span style="color:#66ff99;">✅ Yes</span>':'<span style="color:#ff6666;">❌ No</span>'}</div>\n            <div><strong>Smooth:</strong> ${t.meta.smooth?"✅ Yes":"❌ No"}</div>\n          </div>\n        </div>\n      `),t.pts&&t.pts.length>0){if(r+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#88ccff;">📍 Path Points (${t.pts.length} total)</h4>\n          <div style="font-size:10px;margin-bottom:8px;">\n            <strong>Start:</strong> (${t.pts[0][0]}, ${t.pts[0][1]})<br>\n            <strong>End:</strong> (${t.pts[t.pts.length-1][0]}, ${t.pts[t.pts.length-1][1]})\n          </div>\n      `,t.pts.length<=8)r+='<div style="font-size:10px;color:#ccc;">',t.pts.forEach(((e,n)=>{const s=0===n?"Start":n===t.pts.length-1?"End":"Waypoint";r+=`<div>${n}: (${e[0]}, ${e[1]}) - ${s}</div>`})),r+="</div>";else{r+='<div style="font-size:10px;color:#ccc;">';for(let e=0;e<3;e++){const n=t.pts[e],s=0===e?"Start":"Waypoint";r+=`<div>${e}: (${n[0]}, ${n[1]}) - ${s}</div>`}r+=`<div style="color:#888;">... ${t.pts.length-5} intermediate points ...</div>`;for(let e=t.pts.length-2;e<t.pts.length;e++){const n=t.pts[e],s=e===t.pts.length-1?"End":"Waypoint";r+=`<div>${e}: (${n[0]}, ${n[1]}) - ${s}</div>`}r+="</div>"}r+="</div>"}if(t.meta?.hint&&(r+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#88ccff;">💡 Routing Hints</h4>\n          <div style="font-size:11px;color:#ccc;">\n            <div><strong>First:</strong> ${t.meta.hint.first||"n/a"}\n                 <span style="color:#888;">(${t.meta.hint.sourceFirst||"n/a"})</span></div>\n            <div><strong>Last:</strong> ${t.meta.hint.last||"n/a"}\n                 <span style="color:#888;">(${t.meta.hint.sourceLast||"n/a"})</span></div>\n          </div>\n        </div>\n      `),t.d){const e=t.d,n=e.length>200,s=n?e.substring(0,197)+"...":e;r+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#88ccff;">🎨 SVG Path Data</h4>\n          <div style="font-size:10px;background:#111;padding:8px;border:1px solid #333;border-radius:4px;word-break:break-all;color:#ccc;font-family:monospace;">\n            ${s}\n          </div>\n          ${n?'<div style="font-size:9px;color:#888;margin-top:4px;">Path truncated for display</div>':""}\n        </div>\n      `}(t.meta?.compute_time_ms||t.meta?.cache_time_ms)&&(r+=`\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#88ccff;">⚡ Performance</h4>\n          <div style="font-size:11px;color:#ccc;">\n            ${t.meta.compute_time_ms?`<div><strong>Compute Time:</strong> ${t.meta.compute_time_ms}ms</div>`:""}\n            ${t.meta.cache_time_ms?`<div><strong>Cache Time:</strong> ${t.meta.cache_time_ms}ms</div>`:""}\n          </div>\n        </div>\n      `);const i=Object.keys(t.meta||{}).filter((e=>!["strategy","cost","segments","bends","cache_hit","smooth","hint","compute_time_ms","cache_time_ms"].includes(e)));i.length>0&&(r+='\n        <div style="margin-bottom:16px;">\n          <h4 style="margin:0 0 8px;color:#88ccff;">🔧 Additional Metadata</h4>\n          <div style="font-size:10px;color:#ccc;">\n      ',i.forEach((e=>{const n=t.meta[e],s="object"==typeof n?JSON.stringify(n):n;r+=`<div><strong>${e}:</strong> ${s}</div>`})),r+="</div></div>"),r+=`\n      <div style="text-align:center;margin-top:20px;border-top:1px solid #333;padding-top:16px;">\n        <button onclick="navigator.clipboard.writeText(JSON.stringify(${JSON.stringify(t)}, null, 2)); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy Analysis', 2000);"\n          style="background:#552255;color:#fff;border:1px solid #aa55aa;border-radius:4px;padding:6px 12px;cursor:pointer;margin-right:8px;font-size:11px;">\n          Copy Analysis\n        </button>\n        <button onclick="this.parentElement.parentElement.remove()"\n          style="background:#333;color:#fff;border:1px solid #555;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:11px;">\n          Close\n        </button>\n      </div>\n    `,s.innerHTML=r,document.body.appendChild(s)}setFilter(e,t){this.filters[e]=t}updateCostFilter(e,t){const n=parseFloat(t);isNaN(n)||(this.filters[e]=n)}finalizeCostFilter(){}setInputFocus(e,t){this.inputStates[e]=t}highlightRoute(e){console.log("[RoutingPanel] Highlighting route:",e);try{const t=window.__msdDebug?.pipelineInstance?.mountElement||window.__msdDebug?.mountElement||document.querySelector("cb-lcars-msd-card")?.shadowRoot||document;if(!t)return void console.warn("[RoutingPanel] No mount element found for route highlighting");const n=t.querySelectorAll(`g[data-overlay-id="${e}"], path[data-overlay-id="${e}"], #${e}`),s=t.querySelectorAll(`g[data-overlay-id="${e}"]`);t.querySelectorAll(`.msd-route-highlight-${e.replace(/[^a-zA-Z0-9]/g,"_")}`).forEach((t=>{t.style.filter=t.dataset.originalFilter||"",t.style.outline=t.dataset.originalOutline||"",t.style.removeProperty("outline-offset"),t.classList.remove(`msd-route-highlight-${e.replace(/[^a-zA-Z0-9]/g,"_")}`),delete t.dataset.originalFilter,delete t.dataset.originalOutline})),n.forEach((t=>{const n=e.replace(/[^a-zA-Z0-9]/g,"_");t.dataset.originalOutline=t.style.outline||"",t.style.outline="2px solid #ff00ff",t.style.outlineOffset="1px",t.classList.add(`msd-route-highlight-${n}`)})),s.forEach((t=>{t.querySelectorAll("path").forEach((t=>{const n=e.replace(/[^a-zA-Z0-9]/g,"_");t.dataset.originalFilter=t.style.filter||"",t.style.filter=`drop-shadow(0 0 4px #ff00ff) ${t.dataset.originalFilter}`.trim(),t.classList.add(`msd-route-highlight-${n}`)}))})),setTimeout((()=>{t.querySelectorAll(`.msd-route-highlight-${e.replace(/[^a-zA-Z0-9]/g,"_")}`).forEach((t=>{t.style.filter=t.dataset.originalFilter||"",t.style.outline=t.dataset.originalOutline||"",t.style.removeProperty("outline-offset"),t.classList.remove(`msd-route-highlight-${e.replace(/[^a-zA-Z0-9]/g,"_")}`),delete t.dataset.originalFilter,delete t.dataset.originalOutline}))}),3e3),this.showRouteHighlightFeedback(e)}catch(e){console.warn("[RoutingPanel] Route highlighting failed:",e)}window.__msdDebug?.hud?.emit&&window.__msdDebug.hud.emit("routing:focus",{id:e})}analyzeRoute(e){if(console.log("[RoutingPanel] analyzeRoute called with:",e),!e)return void console.warn("[RoutingPanel] No route ID provided for analysis");const t=window.__msdDebug?.routing;if(t?.inspect){const n=t.inspect(e);if(console.group(`🔍 Route Analysis: ${e}`),n.meta&&console.table({Strategy:n.meta.strategy||"unknown",Cost:n.meta.cost||0,Segments:n.meta.segments||0,Bends:n.meta.bends||0,"Cache Hit":n.meta.cache_hit?"✅ Yes":"❌ No"}),n.pts&&n.pts.length>0&&(console.log("📍 Path Points:",n.pts.length,"points"),console.table(n.pts.map(((e,t)=>({Index:t,X:e[0],Y:e[1],Type:0===t?"Start":t===n.pts.length-1?"End":"Waypoint"}))))),n.meta?.hint&&(console.log("💡 Routing Hints:"),console.table(n.meta.hint)),n.d){const e=n.d.length>100?n.d.substring(0,97)+"...":n.d;console.log("🎨 SVG Path:",e)}console.log("📋 Full Analysis Object:",n),console.groupEnd(),this.showRouteAnalysisFeedback(e,n)}else console.warn("[RoutingPanel] No routing inspector available")}showRouteHighlightFeedback(e){const t=document.createElement("div");t.style.cssText="\n      position: fixed;\n      top: 20px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(255, 0, 255, 0.9);\n      color: white;\n      padding: 8px 16px;\n      border-radius: 4px;\n      font-size: 12px;\n      z-index: 1000001;\n      pointer-events: none;\n    ",t.textContent=`Highlighting route: ${e}`,document.body.appendChild(t),setTimeout((()=>{t.remove()}),2e3)}showRouteAnalysisFeedback(e,t){const n=document.createElement("div");n.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: rgba(0, 0, 0, 0.95);\n      color: #00ffff;\n      padding: 16px;\n      border: 2px solid #00ffff;\n      border-radius: 8px;\n      font-family: monospace;\n      font-size: 12px;\n      z-index: 1000002;\n      max-width: 400px;\n      box-shadow: 0 4px 20px rgba(0, 255, 255, 0.3);\n    ";let s=`<h3 style="margin:0 0 12px;color:#ffaa00;">Route Analysis: ${e}</h3>`;t.meta&&(s+=`\n        <div style="margin-bottom:12px;">\n          <div><strong>Strategy:</strong> ${t.meta.strategy||"unknown"}</div>\n          <div><strong>Cost:</strong> ${t.meta.cost||0}</div>\n          <div><strong>Segments:</strong> ${t.meta.segments||0}</div>\n          <div><strong>Bends:</strong> ${t.meta.bends||0}</div>\n          <div><strong>Cache Hit:</strong> ${t.meta.cache_hit?"✅ Yes":"❌ No"}</div>\n        </div>\n      `),t.pts&&t.pts.length>0&&(s+=`\n        <div style="margin-bottom:12px;">\n          <strong>Path:</strong> ${t.pts.length} points<br>\n          <div style="font-size:10px;margin-top:4px;">\n            Start: (${t.pts[0][0]}, ${t.pts[0][1]})<br>\n            End: (${t.pts[t.pts.length-1][0]}, ${t.pts[t.pts.length-1][1]})\n          </div>\n        </div>\n      `),t.meta?.hint&&(s+=`\n        <div style="margin-bottom:12px;">\n          <strong>Hints:</strong><br>\n          <div style="font-size:10px;margin-top:4px;">\n            First: ${t.meta.hint.first||"n/a"} (${t.meta.hint.sourceFirst||"n/a"})<br>\n            Last: ${t.meta.hint.last||"n/a"} (${t.meta.hint.sourceLast||"n/a"})\n          </div>\n        </div>\n      `),s+='\n      <div style="text-align:center;margin-top:12px;">\n        <button onclick="this.parentElement.parentElement.remove()"\n          style="background:#333;color:#fff;border:1px solid #555;padding:4px 12px;border-radius:4px;cursor:pointer;">\n          Close\n        </button>\n      </div>\n    ',n.innerHTML=s,document.body.appendChild(n),setTimeout((()=>{n.parentElement&&n.remove()}),25e3)}captureData(){const e={},t={},n={};try{const s=window.__msdDebug?.routing;if(s){const r=s.stats?.()||{};Object.assign(e,r),s.getPerformanceMetrics&&(n.metrics=s.getPerformanceMetrics());const i=window.__msdDebug?.pipelineInstance;if(i){const e=i.getResolvedModel?.();if(e?.overlays){const n=e.overlays.filter((e=>"line"===e.type&&e.anchor&&e.attach_to)).slice(0,15);n.forEach((e=>{try{const n=s.inspect?.(e.id);n&&n.pts?t[e.id]={id:e.id,strategy:n.meta?.strategy||"auto",pathLength:n.pts?.length||0,segments:n.meta?.segments||0,bends:n.meta?.bends||0,cost:n.meta?.cost||0,cached:n.meta?.cache_hit||!1,success:n.pts&&n.pts.length>0,arcCount:n.meta?.arc?.count||0,startAnchor:e.anchor,endAnchor:e.attach_to,smooth:n.meta?.smooth||!1,channel:n.meta?.channel,computeTime:n.meta?.compute_time_ms||0}:t[e.id]={id:e.id,strategy:"unknown",pathLength:0,segments:0,bends:0,cost:0,cached:!1,success:!1,arcCount:0,startAnchor:e.anchor,endAnchor:e.attach_to,smooth:!1,channel:null,computeTime:0}}catch(t){console.warn(`[RoutingPanel] Route inspection failed for ${e.id}:`,t)}}))}}}}catch(e){console.warn("[RoutingPanel] Data capture failed:",e)}return{stats:e,routes:t,performance:n}}filterRoutes(e){return Object.values(e).filter((e=>!("all"!==this.filters.strategy&&e.strategy!==this.filters.strategy||e.cost<this.filters.minCost||e.cost>this.filters.maxCost||"hit"===this.filters.cacheHit&&!e.cached||"miss"===this.filters.cacheHit&&e.cached||this.filters.showArcs&&0===e.arcCount)))}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Enhanced Routing</h3>';t+="<style>\n      .msd-route-highlighted {\n        outline: 3px solid #ff00ff !important;\n        background: rgba(255, 0, 255, 0.1) !important;\n        box-shadow: 0 0 10px #ff00ff !important;\n      }\n    </style>",t+='<div class="msd-hud-section"><h4>Filters</h4>',t+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">',t+='<select id="hud-routing-strategy" name="hud-routing-strategy" data-bus-event="routing:set-filter" data-key="strategy" onchange="__msdHudBus(\'routing:set-filter\', {key:\'strategy\', value:this.value})" style="font-size:10px;">',["all","auto","manhattan","smooth","direct"].forEach((e=>{const n=this.filters.strategy===e?"selected":"";t+=`<option value="${e}" ${n}>${e}</option>`})),t+="</select>",t+=`<input type="number" id="hud-routing-min-cost" name="hud-routing-min-cost"\n      data-bus-event="routing:update-cost" data-key="minCost"\n      onfocus="__msdHudBus('routing:focus-set',{field:'minCostFocused',focus:true})"\n      onblur="__msdHudBus('routing:focus-set',{field:'minCostFocused',focus:false});__msdHudBus('routing:finalize-cost')"\n      oninput="__msdHudBus('routing:update-cost',{key:'minCost',value:this.value})"\n      placeholder="Min cost" value="${this.filters.minCost}" style="width:60px;font-size:10px;">`,t+=`<input type="number" id="hud-routing-max-cost" name="hud-routing-max-cost"\n      data-bus-event="routing:update-cost" data-key="maxCost"\n      onfocus="__msdHudBus('routing:focus-set',{field:'maxCostFocused',focus:true})"\n      onblur="__msdHudBus('routing:focus-set',{field:'maxCostFocused',focus:false});__msdHudBus('routing:finalize-cost')"\n      oninput="__msdHudBus('routing:update-cost',{key:'maxCost',value:this.value})"\n      placeholder="Max cost" value="${this.filters.maxCost}" style="width:60px;font-size:10px;">`,t+='<select id="hud-routing-cachehit" name="hud-routing-cachehit" data-bus-event="routing:set-filter" data-key="cacheHit" onchange="__msdHudBus(\'routing:set-filter\', {key:\'cacheHit\', value:this.value})" style="font-size:10px;">',["all","hit","miss"].forEach((e=>{const n=this.filters.cacheHit===e?"selected":"";t+=`<option value="${e}" ${n}>Cache: ${e}</option>`})),t+="</select>",t+="</div></div>";const n=e.stats||{};Object.keys(n).length>0&&(t+='<div class="msd-hud-section"><h4>Cache Statistics</h4>',Object.entries(n).forEach((([e,n])=>{t+=`<div class="msd-hud-metric">\n          <span class="msd-hud-metric-name">${e}</span>\n          <span class="msd-hud-metric-value">${n}</span>\n        </div>`})),t+="</div>");const s=e.performance||{};s.metrics&&(t+='<div class="msd-hud-section"><h4>Performance</h4>',Object.entries(s.metrics).forEach((([e,n])=>{const s="number"==typeof n?n.toFixed(2):n;t+=`<div class="msd-hud-metric">\n          <span class="msd-hud-metric-name">${e}</span>\n          <span class="msd-hud-metric-value">${s}</span>\n        </div>`})),t+="</div>");const r=e.routes||{},i=this.filterRoutes(r);return i.length>0?(t+=`<div class="msd-hud-section"><h4>Routes (${i.length}/${Object.keys(r).length})</h4>`,i.sort(((e,t)=>t.cost-e.cost)),i.slice(0,8).forEach((e=>{const n=e.id.length>15?e.id.substring(0,12)+"...":e.id,s=(e.success,e.cost>50?"#ff6666":e.cost>20?"#ffaa00":"#66ff99");t+=`<div class="msd-hud-metric"\n          data-overlay-id="${e.id}"\n          data-select-type="route"\n          data-select-id="${e.id}"\n          style="cursor:pointer;border:1px solid #333;padding:4px;margin:2px 0;border-radius:3px;transition:all 0.3s;"\n          onclick="__msdHudBus('select:set',{type:'route',id:'${e.id}',source:'routing'});__msdHudBus('routing:highlight',{id:'${e.id}'})"\n          onmouseover="this.style.background='rgba(255,0,255,0.1)'"\n          onmouseout="this.style.background=''">\n          <div style="display:flex;justify-content:space-between;">\n            <span class="msd-hud-metric-name">${n}</span>\n            <span class="msd-hud-metric-value" style="color:${s};">${e.cost.toFixed(1)}</span>\n          </div>\n          <div style="font-size:11px;color:#aaa;margin-top:3px;line-height:1.3;">\n            <span style="color:#88ccff;">${e.strategy}</span> •\n            <span style="color:#99dd99;" title="Path points">${e.pathLength} pts</span> •\n            <span style="color:#ffcc88;" title="Direction changes">${e.bends} turns</span>\n            ${e.cached?' • <span style="color:#66ddff;" title="Cached result">� cached</span>':""}\n            ${e.arcCount>0?` • <span style="color:#ff99cc;" title="Arc segments">${e.arcCount} arcs</span>`:""}\n          </div>\n        </div>`,t+=`<div style="text-align:right;margin-top:2px;">\n          <button\n            onclick="event.stopPropagation();window.__msdAnalyzeRoute('${e.id}');"\n            style="font-size:9px;padding:1px 4px;background:#333;color:#ccc;border:1px solid #555;border-radius:2px;cursor:pointer;">\n            Analyze\n          </button>\n        </div>`})),i.length>8&&(t+=`<div style="font-size:10px;text-align:center;color:#666;margin-top:4px;">\n          ... ${i.length-8} more routes\n        </div>`),t+="</div>"):t+='<div class="msd-hud-section">No routes match current filters</div>',t+="</div>",t}shouldSkipRefresh(){return this.inputStates.minCostFocused||this.inputStates.maxCostFocused}}class tc{constructor(){this.history=new Map,this.maxHistoryLength=30,this.conflictThreshold=3,this.lastSnapshot=null}captureData(){const e=window.__msdDebug?.routing,t=e?.channels?._occupancy||{},n=[],s={},r=[];try{Object.entries(t).forEach((([e,t])=>{this.history.has(e)||this.history.set(e,[]);const n=this.history.get(e);n.push(t),n.length>this.maxHistoryLength&&n.shift()})),Object.entries(t).forEach((([e,t])=>{t>=this.conflictThreshold&&n.push({channel:e,count:t,severity:t>=5?"high":"medium"})})),this.history.forEach(((e,t)=>{if(e.length>=3){const n=e.slice(-3),r=n.reduce(((e,t)=>e+t),0)/n.length,i=n[n.length-1]-n[0];s[t]={current:n[n.length-1],average:r,trend:i,variance:this.calculateVariance(n),history:[...e]}}})),n.length>0&&r.push({type:"conflict",message:`${n.length} channel conflicts detected`,action:"Consider adjusting routing strategy"});const e=Object.entries(s).filter((([e,t])=>t.variance>2)).length;e>0&&r.push({type:"variance",message:`${e} channels show high variance`,action:"Review routing stability"});const i=this.history.size-Object.keys(t).length;i>5&&r.push({type:"optimization",message:`${i} channels currently unused`,action:"Potential for route optimization"})}catch(e){console.warn("[ChannelTrendPanel] Data capture failed:",e)}return{current:t,conflicts:n,trends:s,recommendations:r}}calculateVariance(e){if(0===e.length)return 0;const t=e.reduce(((e,t)=>e+t),0)/e.length;return e.map((e=>Math.pow(e-t,2))).reduce(((e,t)=>e+t),0)/e.length}renderSparkline(e,t=null){if(!e||0===e.length)return"";const n=t||Math.max(...e,1);let s="";const r=Math.max(1,Math.floor(e.length/40));for(let t=0;t<e.length;t+=r){const r=e[t]/n;s+=" ▁▂▃▄▅▆▇█"[Math.min(8,Math.floor(8*r))]}return s}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Channel Trends</h3>';const{current:n,conflicts:s,trends:r,recommendations:i}=e;if(s&&s.length>0&&(t+='<div class="msd-hud-section msd-hud-warning"><h4>Conflicts Detected</h4>',s.forEach((e=>{const n="high"===e.severity?"#ff4444":"#ffaa00";t+=`<div class="msd-hud-metric">\n          <span class="msd-hud-metric-name" style="color:${n};">${e.channel}</span>\n          <span class="msd-hud-metric-value">${e.count} routes</span>\n        </div>`})),t+="</div>"),i&&i.length>0&&(t+='<div class="msd-hud-section"><h4>Recommendations</h4>',i.forEach((e=>{const n="conflict"===e.type?"#ff6666":"variance"===e.type?"#ffaa00":"#66ff99";t+=`<div class="msd-hud-metric">\n          <div style="color:${n};font-size:10px;">${e.message}</div>\n          <div style="color:#888;font-size:9px;">${e.action}</div>\n        </div>`})),t+="</div>"),r&&Object.keys(r).length>0){t+='<div class="msd-hud-section"><h4>Usage Trends</h4>';const e=Object.entries(r).sort((([,e],[,t])=>t.current-e.current)).slice(0,8);e.forEach((([e,n])=>{const s=e.length>15?e.substring(0,12)+"...":e,r=n.trend>0?"↗":n.trend<0?"↘":"→",i=n.trend>0?"#ff6666":n.trend<0?"#66ff99":"#888",o=this.renderSparkline(n.history);t+=`<div class="msd-hud-metric" style="margin:4px 0;">\n          <div style="display:flex;justify-content:space-between;">\n            <span class="msd-hud-metric-name">${s}</span>\n            <span class="msd-hud-metric-value">${n.current}</span>\n          </div>\n          <div style="display:flex;justify-content:space-between;font-size:10px;margin-top:2px;">\n            <span style="font-family:monospace;color:#888;">${o}</span>\n            <span style="color:${i};">${r} ${n.average.toFixed(1)}</span>\n          </div>\n        </div>`})),t+="</div>"}const o=Object.keys(n||{}).length,a=Object.values(n||{}).reduce(((e,t)=>e+t),0),l=this.history.size;return t+=`<div class="msd-hud-section msd-hud-summary">\n      ${o} active channels • ${a} total routes • ${l} tracked\n    </div>`,t+="</div>",t}}class nc{constructor(){this.debugFeatures=["anchors","bounding_boxes","routing","performance"]}toggleFeature(e){if(console.log("[FlagsPanel] toggleFeature called:",e),!window.__msdDebug?.debug)return void console.warn("[FlagsPanel] Debug interface not available");const t=window.__msdDebug?.debugManager||window.__msdDebug?.pipelineInstance?.systemsManager?.debugManager;if(!t)return void console.warn("[FlagsPanel] DebugManager not available");const n=t.getSnapshot()[e];n?window.__msdDebug.debug.disable(e):window.__msdDebug.debug.enable(e),setTimeout((()=>{try{const t=window.__msdDebug?.pipelineInstance;t?.reRender?(console.log("[FlagsPanel] Triggering re-render after",e,n?"disable":"enable"),t.reRender()):console.warn("[FlagsPanel] No reRender method available on pipeline instance")}catch(e){console.warn("[FlagsPanel] Failed to trigger re-render:",e)}}),50),setTimeout((()=>{window.__msdDebug?.hud?.refresh&&window.__msdDebug.hud.refresh()}),100)}adjustScale(e){if(!window.__msdDebug?.debug?.status)return;const t=window.__msdDebug.debug.status().scale||1,n=e>0?t+.1:t-.1,s=Math.max(.5,Math.min(3,n));window.__msdDebug.debug.setScale&&window.__msdDebug.debug.setScale(s)}setScale(e){const t=parseFloat(e);if(isNaN(t))return;const n=Math.max(.5,Math.min(3,t));window.__msdDebug?.debug?.setScale&&window.__msdDebug.debug.setScale(n)}refreshDebug(){window.__msdDebug?.debug?.refresh?.()}captureData(){const e={},t={};try{const n=window.__msdDebug?.getDebugStatusSilent?.()||{};Object.assign(t,n),Object.assign(e,window.__msdDebug?._debugFlags||{})}catch(e){console.warn("[FlagsPanel] Data capture failed:",e)}return{flags:e,debugFeatures:t}}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Debug Features</h3>';const n=e.debugFeatures||{},s=n.scale||1;n.initialized?(t+='<div class="msd-hud-section"><h4>Status</h4>',t+=`<div>Debug ready • Scale: ${s.toFixed(1)}x</div></div>`):(t+='<div class="msd-hud-section msd-hud-warning"><h4>Status</h4>',t+="<div>Debug interface not ready</div></div>"),t+='<div class="msd-hud-section"><h4>Debug Features</h4>',t+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">',this.debugFeatures.forEach((e=>{const s=Boolean(n[e]),r=e.replace("_"," ");t+=`<button data-bus-event="flags:toggle" onclick="__msdHudBus('flags:toggle',{feature:'${e}'})"\n        style="font-size:10px;padding:2px 6px;border:1px solid #444;border-radius:3px;cursor:pointer;\n        background:${s?"#ff00ff":"#333"};color:${s?"#000":"#eee"};">\n        ${r}\n      </button>`})),t+="</div></div>",t+='<div class="msd-hud-section"><h4>Scale Control</h4>',t+='<div style="display:flex;gap:4px;align-items:center;margin-bottom:6px;">',t+='<button data-bus-event="flags:scale-adjust" onclick="__msdHudBus(\'flags:scale-adjust\',{dir:-1})" style="font-size:10px;padding:2px 6px;border:1px solid #444;border-radius:3px;cursor:pointer;\n      background:#333;color:#eee;">-</button>',t+=`<input type="number" id="hud-flags-scale" name="hud-flags-scale"\n      value="${s.toFixed(1)}" min="0.5" max="3.0" step="0.1" data-bus-event="flags:scale-set"\n      onchange="__msdHudBus('flags:scale-set',{scale:this.value})"\n      style="width:60px;font-size:10px;padding:2px 4px;border:1px solid #444;border-radius:3px;\n      background:#222;color:#eee;text-align:center;">`,t+='<button data-bus-event="flags:scale-adjust" onclick="__msdHudBus(\'flags:scale-adjust\',{dir:1})" style="font-size:10px;padding:2px 6px;border:1px solid #444;border-radius:3px;cursor:pointer;\n      background:#333;color:#eee;">+</button>',t+="</div>",t+='<div style="display:flex;gap:4px;align-items:center;">',[.8,1,1.2,1.5,2].forEach((e=>{const n=Math.abs(s-e)<.05;t+=`<button data-bus-event="flags:scale-set"\n        onclick="__msdHudBus('flags:scale-set',{scale:${e}})"\n        style="font-size:10px;padding:2px 6px;border:1px solid #444;border-radius:3px;cursor:pointer;\n        background:${n?"#ffaa00":"#333"};color:${n?"#000":"#eee"};">\n        ${e}x\n      </button>`})),t+='<button data-bus-event="flags:refresh" onclick="__msdHudBus(\'flags:refresh\')" style="font-size:10px;padding:2px 6px;border:1px solid #444;border-radius:3px;cursor:pointer;\n      background:#333;color:#eee;margin-left:8px;">\n      Refresh\n    </button>',t+="</div></div>";const r=this.debugFeatures.filter((e=>n[e])).length;return t+=`<div class="msd-hud-section msd-hud-summary">\n      ${r}/${this.debugFeatures.length} features enabled\n    </div>`,t+="</div>",t}}class sc{constructor(){this.issueCategories={validation:{label:"Validation",color:"#ff6666",icon:"⚠️"},routing:{label:"Routing",color:"#ffaa00",icon:"🔀"},performance:{label:"Performance",color:"#ff9900",icon:"⏱️"},debug:{label:"Debug",color:"#66cfff",icon:"🔧"}}}handleIssueClick(e,t,n){switch(console.log("[IssuesPanel] Issue clicked:",{action:e,id:t,overlay:n}),e){case"overlay":n&&window.__msdDebug?.debug&&console.log(`[IssuesPanel] Highlighting overlay: ${n}`);break;case"routing":console.log("[IssuesPanel] Opening routing diagnostics"),window.__msdDebug?.hud?.refresh&&window.__msdDebug.hud.refresh();break;case"performance":console.log(`[IssuesPanel] Performance issue: ${t}`);break;case"debug":console.log("[IssuesPanel] Debug issue clicked - attempting to initialize debug interface"),window.__msdDebug?.debug?.refresh&&window.__msdDebug.debug.refresh();break;case"enable-features":if(console.log("[IssuesPanel] Enabling basic debug features"),window.__msdDebug?.debug){window.__msdDebug.debug.enable("anchors"),window.__msdDebug.debug.enable("bounding_boxes");const e=document.createElement("div");e.style.cssText="\n            position: fixed;\n            top: 20px;\n            left: 50%;\n            transform: translateX(-50%);\n            background: rgba(0, 255, 0, 0.9);\n            color: white;\n            padding: 8px 16px;\n            border-radius: 4px;\n            font-size: 12px;\n            z-index: 1000001;\n            pointer-events: none;\n          ",e.textContent="Debug features enabled: anchors, bounding_boxes",document.body.appendChild(e),setTimeout((()=>e.remove()),3e3)}}this.bus&&("overlay"===e&&n?this.bus.emit("select:set",{type:"overlay",id:n,source:"issues"}):"routing"===e&&t?this.bus.emit("select:set",{type:"route",id:t,source:"issues"}):"performance"===e&&t&&this.bus.emit("select:set",{type:"timer",id:t,source:"issues"}))}captureData(){const e={validation:[],routing:[],performance:[],debug:[]};try{const t=window.__msdDebug?.validation?.issues?.()||{};t.errors&&t.errors.forEach((t=>{e.validation.push({id:t.overlay||t.anchor||"unknown",type:"validation",severity:"error",message:t.msg||t.message||"Validation error",code:t.code,overlay:t.overlay,anchor:t.anchor,clickAction:"overlay"})})),t.warnings&&t.warnings.forEach((t=>{e.validation.push({id:t.overlay||t.anchor||"unknown",type:"validation",severity:"warning",message:t.msg||t.message||"Validation warning",code:t.code,overlay:t.overlay,anchor:t.anchor,clickAction:"overlay"})}));const n=window.__msdDebug?.getDebugStatusSilent?.()||{};if(n.enabled){const t=window.__msdDebug?.routing;if(t?.stats){const n=t.stats();n.errors&&n.errors>0&&e.routing.push({id:"routing-errors",type:"routing",severity:"error",message:`${n.errors} routing errors detected`,code:"routing_errors",clickAction:"routing"})}}if(n.performance){const t=window.__msdDebug?.getPerf?.()||{};t.timers&&Object.entries(t.timers).forEach((([t,n])=>{n.avg>50&&e.performance.push({id:t,type:"performance",severity:"warning",message:`Slow timer: ${t} (${n.avg.toFixed(1)}ms avg)`,code:"slow_timer",clickAction:"performance"})}))}n.initialized?n.enabled||e.debug.push({id:"debug-features-disabled",type:"debug",severity:"info",message:"All debug features are disabled",code:"debug_features_off",clickAction:"enable-features"}):e.debug.push({id:"debug-status",type:"debug",severity:"warning",message:"Debug interface not initialized",code:"debug_not_initialized",clickAction:"debug"})}catch(t){console.warn("[IssuesPanel] Data capture failed:",t),e.debug.push({id:"capture-error",type:"debug",severity:"error",message:`Issue capture failed: ${t.message}`,code:"capture_error",clickAction:"debug"})}return e}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Issues</h3>';const n=[];if(Object.values(e).forEach((e=>{n.push(...e)})),0===n.length)return t+='<div class="msd-hud-section msd-hud-success">✅ No issues detected</div>',t+="</div>",t;const s=n.filter((e=>"error"===e.severity)).length,r=n.filter((e=>"warning"===e.severity)).length;return t+=`<div class="msd-hud-section msd-hud-summary">\n      ${s} errors, ${r} warnings • Click to fix\n    </div>`,Object.entries(e).forEach((([e,n])=>{if(0===n.length)return;const s=this.issueCategories[e];t+=`<div class="msd-hud-section">\n        <h4 style="color: ${s.color};">${s.icon} ${s.label} (${n.length})</h4>\n      `,n.slice(0,6).forEach(((e,n)=>{const s="error"===e.severity?"#ff6666":"#ffaa00";t+=`<div class="msd-hud-metric msd-issue-row"\n          data-bus-event="issues:action"\n          data-action="${e.clickAction}"\n          data-id="${e.id}"\n          data-overlay="${e.overlay||""}"\n          data-select-type="${"overlay"===e.clickAction?"overlay":"routing"===e.clickAction?"route":"performance"===e.clickAction?"timer":"issue"}"\n          data-select-id="${e.overlay||e.id}"\n          onclick="__msdHudBus('issues:action',{action:'${e.clickAction}',id:'${e.id}',overlay:'${e.overlay||""}'});__msdHudBus('select:set',{type:'${"overlay"===e.clickAction?"overlay":"routing"===e.clickAction?"route":"performance"===e.clickAction?"timer":"issue"}',id:'${e.overlay||e.id}',source:'issues'})"\n          style="cursor:pointer; border-left:3px solid ${s}; padding-left:6px; margin:2px 0;">\n          <div style="display: flex; justify-content: space-between; align-items: center;">\n            <span class="msd-hud-metric-name">[${e.code||e.type}]</span>\n            <span style="color: ${s}; font-size: 10px;">${e.severity.toUpperCase()}</span>\n          </div>\n          <div style="font-size: 10px; color: #ccc; margin-top: 2px;">${e.message}</div>\n        </div>`})),n.length>6&&(t+=`<div style="font-size: 9px; opacity: 0.6; text-align: center;">\n          ... ${n.length-6} more ${s.label.toLowerCase()} issues\n        </div>`),t+="</div>"})),t+="</div>",t}}class rc{captureData(){const e={},t={},n={};try{const s=window.__msdDebug?.pipelineInstance;if(s){const r=s.getResolvedModel?.();r&&(["animations","timelines","rules","profiles","overlays"].forEach((t=>{e[t]=r[t]||[],n[t]=e[t].length})),r.__provenance&&Object.assign(t,r.__provenance));const i=s.merged;i&&(Object.keys(e).forEach((t=>{i[t]&&(e[t]=i[t],n[t]=i[t].length)})),i.__provenance&&Object.assign(t,i.__provenance))}}catch(e){console.warn("[PacksPanel] Data capture failed:",e)}return{collections:e,provenance:t,summary:n}}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Packs & Collections</h3>';const{collections:n,provenance:s,summary:r}=e;if(r&&Object.keys(r).length>0&&(t+='<div class="msd-hud-section"><h4>Collection Summary</h4>',t+='<div style="display:flex;flex-wrap:wrap;gap:4px;font-size:10px;">',Object.entries(r).forEach((([e,n])=>{t+=`<span style="background:#222;color:${n>0?"#66ff99":"#666"};padding:2px 4px;border:1px solid #444;border-radius:3px;">\n          ${e}:${n}\n        </span>`})),t+="</div></div>"),s&&Object.keys(s).some((e=>Object.keys(s[e]||{}).length>0))){t+='<div class="msd-hud-section"><h4>Provenance Sample</h4>';const e=[];Object.entries(s).forEach((([t,n])=>{Object.entries(n||{}).forEach((([n,s])=>{e.push({collection:t,id:n,chain:s})}))})),e.slice(0,8).forEach((e=>{const n=e.id.length>15?e.id.substring(0,12)+"...":e.id,s=(e.chain||[]).map((e=>`${e.layer_id}${e.overridden?"*":""}`)).join(" → ");t+=`<div class="msd-hud-metric" style="margin:2px 0;">\n          <div style="display:flex;justify-content:space-between;">\n            <span class="msd-hud-metric-name">${e.collection}:${n}</span>\n          </div>\n          <div style="font-size:9px;color:#888;margin-top:1px;font-family:monospace;">\n            ${s||"No chain data"}\n          </div>\n        </div>`})),e.length>8&&(t+=`<div style="font-size:9px;opacity:0.6;text-align:center;">\n          ... ${e.length-8} more items\n        </div>`),t+="</div>"}return n&&Object.keys(n).length>0?(t+='<div class="msd-hud-section"><h4>Collections Detail</h4>',Object.entries(n).forEach((([e,n])=>{Array.isArray(n)&&0!==n.length&&(t+=`<div style="margin-bottom:6px;">\n          <div style="font-weight:bold;font-size:11px;color:#ffaa00;">${e} (${n.length})</div>`,n.slice(0,6).forEach((e=>{if(!e||!e.id)return;const n=[];if(e.__meta?.origin_pack){const t=e.__meta.origin_pack;"builtin:core"===t?n.push({text:"core",color:"#555"}):t.startsWith("builtin:")?n.push({text:"builtin",color:"#663399"}):t.startsWith("external:")?n.push({text:"ext",color:"#cc6600"}):n.push({text:"user",color:"#996515"})}e.__meta?.overridden&&n.push({text:"mod",color:"#8a6d00"}),e.__meta?.removed&&n.push({text:"rm",color:"#702020"});const s=n.map((e=>`<span style="background:${e.color};color:#fff;padding:0 3px;margin-left:4px;border-radius:2px;font-size:8px;">\n              ${e.text}\n            </span>`)).join(""),r=e.id.length>20?e.id.substring(0,17)+"...":e.id;t+=`<div style="margin-left:10px;font-size:10px;margin:1px 0;">\n            ${r}${s}\n          </div>`})),n.length>6&&(t+=`<div style="margin-left:10px;font-size:9px;color:#666;">\n            ... ${n.length-6} more\n          </div>`),t+="</div>")})),t+="</div>"):t+='<div class="msd-hud-section">No pack data available</div>',t+="</div>",t}}class ic{captureData(){const e=[],t=[],n={};try{const s=window.__msdDebug?.pipelineInstance,r=s?.systemsManager?.rulesEngine||s?.rulesEngine;if(r){const s=r.getTrace?.()||[];Array.isArray(s)?t.push(...s):s&&t.push(s);const i=r.rules||r._rules||[];Array.isArray(i)&&i.forEach((n=>{const s=t.find((e=>e&&e.id===n.id));e.push({id:n.id,priority:n.priority||0,lastMatch:s?.matched||!1,matchCount:n._matchCount||n.matchCount||0,conditions:n.when?Object.keys(n.when).length:0,actions:n.apply?Object.keys(n.apply).length:0})})),n.totalRules=e.length,n.matchedRules=e.filter((e=>e.lastMatch)).length,n.totalMatches=e.reduce(((e,t)=>e+t.matchCount),0),n.avgPriority=e.length>0?e.reduce(((e,t)=>e+t.priority),0)/e.length:0}}catch(e){return console.warn("[RulesPanel] Data capture failed:",e),{rules:[],trace:[],stats:{totalRules:0,matchedRules:0,totalMatches:0,avgPriority:0}}}return{rules:e,trace:t,stats:n}}renderHtml(e){let t='<div class="msd-hud-panel"><h3>Rules Engine</h3>';const{rules:n,trace:s,stats:r}=e;if(r&&Object.keys(r).length>0&&(t+='<div class="msd-hud-section"><h4>Statistics</h4>',t+=`<div class="msd-hud-metric">\n        <span class="msd-hud-metric-name">Total Rules</span>\n        <span class="msd-hud-metric-value">${r.totalRules}</span>\n      </div>`,t+=`<div class="msd-hud-metric">\n        <span class="msd-hud-metric-name">Currently Matched</span>\n        <span class="msd-hud-metric-value" style="color:${r.matchedRules>0?"#66ff99":"#666"};">\n          ${r.matchedRules}\n        </span>\n      </div>`,t+=`<div class="msd-hud-metric">\n        <span class="msd-hud-metric-name">Total Matches</span>\n        <span class="msd-hud-metric-value">${r.totalMatches}</span>\n      </div>`,t+=`<div class="msd-hud-metric">\n        <span class="msd-hud-metric-name">Avg Priority</span>\n        <span class="msd-hud-metric-value">${r.avgPriority.toFixed(1)}</span>\n      </div>`,t+="</div>"),n&&n.length>0){t+='<div class="msd-hud-section"><h4>Rules Activity</h4>';const e=[...n].sort(((e,t)=>e.lastMatch!==t.lastMatch?t.lastMatch-e.lastMatch:t.priority-e.priority));e.slice(0,10).forEach((e=>{const n=e.id.length>20?e.id.substring(0,17)+"...":e.id,s=e.lastMatch?"✓":"○",r=e.lastMatch?"#66ff99":"#666";t+=`<div class="msd-hud-metric"\n          data-select-type="rule"\n          data-select-id="${e.id}"\n          onclick="__msdHudBus('select:set',{type:'rule',id:'${e.id}',source:'rules'})"\n          style="margin:2px 0;padding:2px;${e.lastMatch?"background:rgba(102,255,153,0.1);":""} border-radius:3px;">\n          <div style="display:flex;justify-content:space-between;align-items:center;">\n            <span class="msd-hud-metric-name">${n}</span>\n            <div style="display:flex;gap:8px;align-items:center;">\n              <span style="font-size:10px;color:#888;">p:${e.priority}</span>\n              <span style="color:${r};font-weight:bold;">${s}</span>\n            </div>\n          </div>\n          <div style="font-size:10px;color:#888;margin-top:1px;">\n            ${e.conditions} conditions • ${e.actions} actions • ${e.matchCount} matches\n          </div>\n        </div>`})),e.length>10&&(t+=`<div style="font-size:10px;text-align:center;color:#666;margin-top:4px;">\n          ... ${e.length-10} more rules\n        </div>`),t+="</div>"}else t+='<div class="msd-hud-section">No rules engine data available</div>';return t+="</div>",t}}class oc{constructor(){console.log("[ExportPanel] Constructor called"),this.initialized=!1,this.initialized=!0}exportCollapsed(){try{const e=window.__msdDebug?.pipelineInstance;if(e?.exportCollapsedJson){const t=e.exportCollapsedJson(!0);this.downloadJson(t,"msd-config-collapsed"),this.updateTextarea("collapsed",t)}}catch(e){console.error("[ExportPanel] Collapsed export failed:",e)}}exportFull(e=!1){try{const t=window.__msdDebug?.pipelineInstance;if(t?.exportFullSnapshotJson){const n=e?{include_meta:!0}:{},s=t.exportFullSnapshotJson(n,!0),r=e?"msd-snapshot-with-meta":"msd-snapshot";this.downloadJson(s,r),this.updateTextarea("full",s)}}catch(e){console.error("[ExportPanel] Full export failed:",e)}}diffItem(){}clearTextarea(e){this.updateTextarea(e,"")}copyToClipboard(e){const t=document.getElementById(`export-${e}-textarea`);t&&t.value&&navigator.clipboard.writeText(t.value).then((()=>{this.showFeedback("Copied to clipboard!")})).catch((e=>{console.warn("Clipboard copy failed:",e),t.select(),t.setSelectionRange(0,99999)}))}downloadJson(e,t){try{const n=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(n),r=document.createElement("a");r.href=s,r.download=`${t}-${Date.now()}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s),this.showFeedback(`Downloaded: ${r.download}`)}catch(e){console.error("[ExportPanel] Download failed:",e)}}updateTextarea(e,t){const n=document.getElementById(`export-${e}-textarea`);n&&(n.value=t)}showFeedback(e,t="info"){const n={info:"#00ffff",success:"#00ff00",warning:"#ffaa00",error:"#ff6666"},s=document.createElement("div");s.style.cssText=`\n      position: fixed;\n      top: 20px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(0, 0, 0, 0.9);\n      color: ${n[t]};\n      padding: 8px 16px;\n      border: 1px solid ${n[t]};\n      border-radius: 4px;\n      font-size: 12px;\n      z-index: 1000001;\n      pointer-events: none;\n    `,s.textContent=e,document.body.appendChild(s),setTimeout((()=>s.remove()),3e3)}captureData(){const e=window.__msdDebug?.pipelineInstance,t={available:!!e,hasExportMethods:!(!e?.exportCollapsedJson||!e?.exportFullSnapshotJson),hasDiffMethod:!!e?.diffItem,collections:["animations","timelines","rules","profiles","overlays"],initialized:this.initialized,globalHandlers:!!window.__msdExportPanel};return t.available||console.warn("[ExportPanel] Pipeline not available for export functionality"),t}renderHtml(e){if(!e.available)return`<h3>Export & Config</h3>\n        <div class="msd-hud-section msd-hud-error">\n          Pipeline instance not available\n          <div style="font-size: 10px; color: #888; margin-top: 4px;">\n            Initialized: ${e.initialized} | Handlers: ${e.globalHandlers}\n          </div>\n        </div>`;let t="<h3>Export & Config</h3>";return t+='<div class="msd-hud-section"><h4>Export Configuration</h4>',t+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;">',t+='<button data-bus-event="export:collapsed" onclick="__msdHudBus(\'export:collapsed\')"\n      style="font-size:10px;padding:2px 6px;background:#333;color:#fff;border:1px solid #555;border-radius:3px;cursor:pointer;">\n      Collapsed JSON\n    </button>',t+='<button data-bus-event="export:full" onclick="__msdHudBus(\'export:full\')"\n      style="font-size:10px;padding:2px 6px;background:#333;color:#fff;border:1px solid #555;border-radius:3px;cursor:pointer;">\n      Full Snapshot\n    </button>',t+='<button data-bus-event="export:full-meta" onclick="__msdHudBus(\'export:full-meta\')"\n      style="font-size:10px;padding:2px 6px;background:#666;color:#fff;border:1px solid #888;border-radius:3px;cursor:pointer;">\n      +Metadata\n    </button>',t+="</div>",t+='<div style="margin-bottom:6px;">',t+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">',t+='<span style="font-size:11px;color:#ffaa00;">Collapsed JSON:</span>',t+='<div style="display:flex;gap:2px;">',t+='<button data-bus-event="export:copy" onclick="__msdHudBus(\'export:copy\',{type:\'collapsed\'})" style="font-size:9px;padding:1px 4px;background:#444;color:#fff;border:1px solid #666;border-radius:2px;cursor:pointer;">Copy</button>',t+='<button data-bus-event="export:clear" onclick="__msdHudBus(\'export:clear\',{type:\'collapsed\'})" style="font-size:9px;padding:1px 4px;background:#666;color:#fff;border:1px solid #888;border-radius:2px;cursor:pointer;">Clear</button>',t+="</div></div>",t+='<textarea id="export-collapsed-textarea" name="export-collapsed" readonly\n      style="width:100%;height:80px;font-size:9px;font-family:monospace;background:#111;color:#ccc;border:1px solid #444;border-radius:3px;padding:4px;resize:vertical;"></textarea>',t+="</div>",t+='<div style="margin-bottom:6px;">',t+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">',t+='<span style="font-size:11px;color:#ffaa00;">Full Snapshot:</span>',t+='<div style="display:flex;gap:2px;">',t+='<button data-bus-event="export:copy" onclick="__msdHudBus(\'export:copy\',{type:\'full\'})" style="font-size:9px;padding:1px 4px;background:#444;color:#fff;border:1px solid #666;border-radius:2px;cursor:pointer;">Copy</button>',t+='<button data-bus-event="export:clear" onclick="__msdHudBus(\'export:clear\',{type:\'full\'})" style="font-size:9px;padding:1px 4px;background:#666;color:#fff;border:1px solid #888;border-radius:2px;cursor:pointer;">Clear</button>',t+="</div></div>",t+='<textarea id="export-full-textarea" name="export-full" readonly\n      style="width:100%;height:100px;font-size:9px;font-family:monospace;background:#111;color:#ccc;border:1px solid #444;border-radius:3px;padding:4px;resize:vertical;"></textarea>',t+="</div>",t+="</div>",t+=`<div class="msd-hud-section msd-hud-summary">\n      Export: ${e.hasExportMethods?"✅":"❌"} •\n      Diff: ${e.hasDiffMethod?"✅":"❌"} •\n      Handlers: ${e.globalHandlers?"✅":"❌"} •\n      Ready for config management\n    </div>`,t}}class ac{constructor(){this._listeners=new Map}on(e,t){return this._listeners.has(e)||this._listeners.set(e,new Set),this._listeners.get(e).add(t),()=>this.off(e,t)}once(e,t){const n=this.on(e,(e=>{n(),t(e)}))}off(e,t){this._listeners.get(e)?.delete(t)}emit(e,t){const n=this._listeners.get(e);n&&n.forEach((e=>{try{e(t)}catch(e){}}));const s=this._listeners.get("*");s&&s.forEach((n=>{try{n({event:e,payload:t})}catch(e){}}))}clear(){this._listeners.clear()}}class lc{constructor(e){this.bus=e,this.current=null}set(e,t,n={}){e&&t&&(this.current={type:e,id:t,meta:n,ts:Date.now()},this.bus?.emit("select:changed",this.current))}clear(){this.current=null,this.bus?.emit("select:changed",null)}get(){return this.current}}class cc{captureData(){const e=[],t={total:0,byType:{}};try{const n=window.__msdDebug?.pipelineInstance,s=n?.getResolvedModel?.();s?.overlays&&s.overlays.forEach((n=>{t.total++,t.byType[n.type]=(t.byType[n.type]||0)+1,e.push({id:n.id,type:n.type||"unknown",anchor:n.anchor,attach_to:n.attach_to,profileCount:Array.isArray(n._profiles)?n._profiles.length:0,patchCount:Array.isArray(n._patches)?n._patches.length:0,styleSourceCount:Array.isArray(n._styleSources)?n._styleSources.length:0,finalStyle:n.finalStyle||n.style||{},smooth:n.smooth,channel:n.channel,meta:{fromPacks:n.__meta?.origin_pack,overridden:!!n.__meta?.overridden}})}))}catch(e){console.warn("[OverlaysPanel] captureData failed:",e)}return{overlays:e,stats:t}}highlightOverlay(e){try{if(!e)return;const t=window.__msdDebug?.pipelineInstance?.mountElement||window.__msdDebug?.mountElement;if(!t)return void console.warn("[OverlaysPanel] No mountElement available for highlight");this._ensureHighlightStyles();const n=this._findOverlayModel(e),s="control"===n?.type;console.log(`[OverlaysPanel] Overlay "${e}":`,n),console.log(`[OverlaysPanel] Overlay type: "${n?.type}", isControlsType: ${s}`);const r=[t];t.shadowRoot&&r.push(t.shadowRoot);const i=[],o=`[data-overlay-id="${CSS.escape(e)}"]`,a=`#${CSS.escape(e)}`,l=s?[`foreignObject[data-msd-control-id="${CSS.escape(e)}"]`,`div[data-msd-control-id="${CSS.escape(e)}"]`,`#msd-control-foreign-${CSS.escape(e)}`]:[];if(r.forEach((t=>{console.log("[OverlaysPanel] Searching in root:",t);const n=t.querySelectorAll(o),r=t.querySelector(a);console.log(`[OverlaysPanel] Standard selectors for "${e}":`,{selectorExact:o,exactMatches:n.length,selectorId:a,byIdMatch:!!r}),n.forEach((e=>i.push(e))),r&&!i.includes(r)&&i.push(r),s?(console.log(`[OverlaysPanel] Searching for controls overlay: ${e}`),console.log("[OverlaysPanel] Controls selectors:",l),l.forEach((e=>{try{const n=t.querySelectorAll(e);console.log(`[OverlaysPanel] Selector "${e}" found ${n.length} elements:`,n),n.forEach((e=>{i.includes(e)||i.push(e)}))}catch(t){console.warn(`[OverlaysPanel] Invalid selector: ${e}`,t)}}))):console.log("[OverlaysPanel] Not a controls type overlay, skipping controls selectors")})),console.log(`[OverlaysPanel] Total matches found: ${i.length}`,i),0===i.length)return console.warn("[OverlaysPanel] No nodes found for overlay",e),void this._toast(`Overlay not found: ${e}`,"#ff4444");i.forEach((e=>{s?this._applyControlsHighlight(e,"#ff66ff"):(this._applyElementHighlight(e,"#ff66ff"),e.tagName&&"g"===e.tagName.toLowerCase()&&e.querySelectorAll("path, line, polyline, polygon, rect, circle, ellipse").forEach((e=>{this._applyElementHighlight(e,"#ff66ff",!0)})))})),this._toast(`Overlay: ${e} (${n?.type||"unknown"})`,"#ff66ff")}catch(e){console.warn("[OverlaysPanel] highlightOverlay failed:",e)}}_applyControlsHighlight(e,t){e.dataset._msdCtrlHl||(e.dataset._msdCtrlHl="1",e.dataset._msdPrevBoxShadow=e.style.boxShadow||"",e.dataset._msdPrevZIndex=e.style.zIndex||"",e.dataset._msdPrevOutline=e.style.outline||"",e.dataset._msdPrevFilter=e.style.filter||""),e.style.boxShadow=`0 0 15px ${t}, 0 0 30px ${t}, inset 0 0 15px rgba(255,102,255,0.2)`,e.style.zIndex="999999",e.style.outline=`2px solid ${t}`,e.style.outlineOffset="2px",e.style.filter=`drop-shadow(0 0 8px ${t}) brightness(1.1)`,e.classList.add("msd-overlay-highlighted","msd-controls-highlighted");const n=document.createElement("style");n.id=`msd-pulse-${e.dataset._msdCtrlHl}`,n.textContent=`\n      .msd-controls-highlighted {\n        animation: msdControlsPulse 1.2s ease-in-out infinite alternate;\n      }\n      @keyframes msdControlsPulse {\n        0% {\n          filter: drop-shadow(0 0 8px ${t}) brightness(1.1) saturate(1);\n          box-shadow: 0 0 15px ${t}, 0 0 30px ${t}, inset 0 0 15px rgba(255,102,255,0.2);\n        }\n        100% {\n          filter: drop-shadow(0 0 12px ${t}) brightness(1.3) saturate(1.2);\n          box-shadow: 0 0 20px ${t}, 0 0 40px ${t}, inset 0 0 20px rgba(255,102,255,0.3);\n        }\n      }\n    `,document.head.appendChild(n),setTimeout((()=>{void 0!==e.dataset._msdPrevBoxShadow&&(e.dataset._msdPrevBoxShadow?e.style.boxShadow=e.dataset._msdPrevBoxShadow:e.style.removeProperty("box-shadow")),void 0!==e.dataset._msdPrevZIndex&&(e.dataset._msdPrevZIndex?e.style.zIndex=e.dataset._msdPrevZIndex:e.style.removeProperty("z-index")),void 0!==e.dataset._msdPrevOutline&&(e.dataset._msdPrevOutline?e.style.outline=e.dataset._msdPrevOutline:e.style.removeProperty("outline")),void 0!==e.dataset._msdPrevFilter&&(e.dataset._msdPrevFilter?e.style.filter=e.dataset._msdPrevFilter:e.style.removeProperty("filter")),e.style.removeProperty("outline-offset"),e.classList.remove("msd-overlay-highlighted","msd-controls-highlighted");const t=document.getElementById(`msd-pulse-${e.dataset._msdCtrlHl}`);t&&t.remove()}),3e3)}_applyElementHighlight(e,t,n=!1){const s=(e.tagName||"").toLowerCase();["path","g","line","polyline","polygon","rect","circle","ellipse"].includes(s)||e instanceof SVGElement?(e.dataset._msdHl||(e.dataset._msdHl="1",e.dataset._msdPrevStroke=e.getAttribute("stroke")||e.style.stroke||"",e.dataset._msdPrevStrokeW=e.getAttribute("stroke-width")||e.style.strokeWidth||"",e.dataset._msdPrevFilter=e.style.filter||""),e.style.stroke=t,"g"!==s&&(e.style.strokeWidth="4"),e.style.filter="drop-shadow(0 0 6px "+t+")",e.classList.add("msd-overlay-highlighted"),setTimeout((()=>{void 0!==e.dataset._msdPrevStroke&&(e.dataset._msdPrevStroke?e.style.stroke=e.dataset._msdPrevStroke:e.style.removeProperty("stroke")),void 0!==e.dataset._msdPrevStrokeW&&(e.dataset._msdPrevStrokeW?e.style.strokeWidth=e.dataset._msdPrevStrokeW:e.style.removeProperty("stroke-width")),void 0!==e.dataset._msdPrevFilter&&(e.dataset._msdPrevFilter?e.style.filter=e.dataset._msdPrevFilter:e.style.removeProperty("filter")),e.classList.remove("msd-overlay-highlighted")}),3e3)):(e.dataset._msdHlBox||(e.dataset._msdHlBox="1",e.dataset._msdPrevOutline=e.style.outline||"",e.dataset._msdPrevBoxShadow=e.style.boxShadow||"",e.dataset._msdPrevFilter=e.style.filter||""),e.style.outline=`3px solid ${t}`,e.style.boxShadow=`0 0 10px ${t}`,e.style.filter=`drop-shadow(0 0 6px ${t})`,e.classList.add("msd-overlay-highlighted"),setTimeout((()=>{void 0!==e.dataset._msdPrevOutline&&(e.dataset._msdPrevOutline?e.style.outline=e.dataset._msdPrevOutline:e.style.removeProperty("outline")),void 0!==e.dataset._msdPrevBoxShadow&&(e.dataset._msdPrevBoxShadow?e.style.boxShadow=e.dataset._msdPrevBoxShadow:e.style.removeProperty("box-shadow")),void 0!==e.dataset._msdPrevFilter&&(e.dataset._msdPrevFilter?e.style.filter=e.dataset._msdPrevFilter:e.style.removeProperty("filter")),e.classList.remove("msd-overlay-highlighted")}),3e3))}_ensureHighlightStyles(){if(document.getElementById("msd-overlay-highlight-style"))return;const e=document.createElement("style");e.id="msd-overlay-highlight-style",e.textContent="\n      .msd-overlay-highlighted {\n        transition: outline .15s, box-shadow .15s;\n      }\n    ",document.head.appendChild(e)}analyzeOverlay(e){try{const t=window.__msdDebug?.pipelineInstance,n=t?.getResolvedModel?.(),s=n?.overlays?.find((t=>t.id===e));if(!s)return console.warn("[OverlaysPanel] analyzeOverlay: overlay not found",e),void this._toast("Overlay not found","#ff4444");console.group(`🛰 Overlay Analysis: ${e}`),console.table([{id:s.id,type:s.type,anchor:s.anchor,attach_to:s.attach_to,channel:s.channel,smooth:s.smooth,profiles:(s._profiles||[]).length,patches:(s._patches||[]).length,styleSources:(s._styleSources||[]).length}]),(s.finalStyle||s.style)&&console.log("Final Style:",s.finalStyle||s.style),s._styleSources&&(console.log("Style Sources (detailed):",s._styleSources),s._styleSources.forEach(((e,t)=>{console.log(`Source ${t}:`,e)}))),s._patches&&console.log("Rule Patches:",s._patches),s.__meta&&console.log("Metadata:",s.__meta),console.log("Full Overlay Object:",s),console.groupEnd(),this._showOverlayPopup(s)}catch(e){console.warn("[OverlaysPanel] analyzeOverlay failed:",e)}}_showOverlayPopup(e){const t=document.getElementById("msd-overlay-popup");t&&t.remove();const n=window.__msdDebug?.hud?.manager?.state?.fontSize||14,s=Math.round(1*n),r=Math.round(.92*n),i=Math.round(.83*n),o=(Math.round(.75*n),Math.round(.67*n),document.createElement("div"));o.id="msd-overlay-popup",o.style.cssText=`\n      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);\n      background:rgba(0,0,0,0.95);color:#ff66ff;\n      border:2px solid #ff66ff;border-radius:8px;\n      padding:14px 16px;z-index:1000003;\n      font-family:monospace;font-size:${s}px;\n      max-width:480px;max-height:70vh;overflow:auto;\n      box-shadow:0 4px 18px rgba(255,102,255,0.4);\n    `;const a=(()=>{try{const t=JSON.stringify(e.finalStyle||e.style||{},null,2);return t.length>520?t.slice(0,517)+"...":t}catch{return"{}"}})(),l=((e._styleSources||[]).map((e=>`${e.kind}:${e.id}`)).join(", "),(e._patches||[]).map((e=>e.ruleId||e.id)).join(", ")||"none"),c=(e._profiles||[]).map((e=>e.id||e)).join(", ")||"none",d=(()=>{if(!e._styleSources||0===e._styleSources.length)return"none";try{const t=e.finalStyle?Object.keys(e.finalStyle):[];console.log("[OverlaysPanel] Final style properties:",t),console.log("[OverlaysPanel] Number of sources:",e._styleSources.length);const n=[];return e._styleSources.forEach(((e,s)=>{const r=`${e.kind||"unknown"}:${e.id||`source-${s}`}`;if(s<t.length){const e=t[s];n.push(`${e} <span style="color:#ffaa00;font-weight:bold;font-size:${Math.round(1.3*i)}px;"> ◀ </span> ${r}`),console.log(`[OverlaysPanel] Source ${s} (${r}) → ${e}`)}})),t.length>e._styleSources.length&&t.slice(e._styleSources.length).forEach((e=>{n.push(`${e} <span style="color:#ffaa00;font-weight:bold;font-size:${Math.round(1.3*i)}px;"> ◀ </span> default:computed`)})),n.join("<br>")||"none"}catch(t){return console.warn("[OverlaysPanel] Error processing sources:",t),e._styleSources.map(((e,t)=>`property${t} <span style="color:#ffaa00;font-weight:bold;font-size:${Math.round(1.3*i)}px;"> ◀ </span> ${e.kind||"unknown"}:${e.id||"unnamed"}`)).join("<br>")}})();o.innerHTML=`\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">\n        <h3 style="margin:0;color:#ffaaee;">Overlay: ${e.id}</h3>\n        <button style="background:#331133;color:#fff;border:1px solid #553366;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:${r}px;"\n          onclick="document.getElementById('msd-overlay-popup')?.remove()">\n          Close\n        </button>\n      </div>\n      <div style="font-size:${r}px;line-height:1.4;color:#ddd;">\n        <strong>Type:</strong> ${e.type||"n/a"}<br>\n        <strong>Anchor:</strong> ${e.anchor||"none"} → <strong>Attach:</strong> ${e.attach_to||"none"}<br>\n        <strong>Channel:</strong> ${e.channel||"none"} | <strong>Smooth:</strong> ${e.smooth?"yes":"no"}<br>\n        <strong>Profiles:</strong> ${c}<br>\n        <strong>Sources:</strong><br>\n        <div style="margin-left:12px;font-size:${i}px;color:#bbb;line-height:1.3;">\n          ${d}\n        </div>\n        <strong>Patches:</strong> ${l}<br>\n        <strong>Meta:</strong> ${e.__meta?Object.keys(e.__meta).join(", "):"none"}\n      </div>\n      <div style="margin-top:8px;">\n        <div style="color:#ffaaee;font-size:${r}px;margin-bottom:4px;">Final Style</div>\n        <pre style="margin:0;background:#111;color:#ccc;padding:8px;border:1px solid #552255;border-radius:4px;font-size:${i}px;max-height:200px;overflow:auto;">${a}</pre>\n      </div>\n      <div style="margin-top:8px;text-align:right;">\n        <button\n          style="background:#552255;color:#fff;border:1px solid #aa55aa;border-radius:4px;padding:3px 10px;cursor:pointer;font-size:${r}px;"\n          onclick="navigator.clipboard.writeText(JSON.stringify(${JSON.stringify(e.finalStyle||e.style||{})},null,2))">\n          Copy Style\n        </button>\n        <button\n          style="background:#331133;color:#fff;border:1px solid #553366;border-radius:4px;padding:3px 10px;cursor:pointer;font-size:${r}px;margin-left:6px;"\n          onclick="document.getElementById('msd-overlay-popup')?.remove()">\n          Done\n        </button>\n      </div>\n    `,document.body.appendChild(o),setTimeout((()=>{o.parentElement&&(o.style.opacity="1")}),10)}_ensureHighlightStyles(){if(document.getElementById("msd-overlay-highlight-style"))return;const e=document.createElement("style");e.id="msd-overlay-highlight-style",e.textContent="\n      .msd-overlay-highlighted {\n        transition: outline .15s, box-shadow .15s;\n      }\n    ",document.head.appendChild(e)}_findOverlayModel(e){try{const t=window.__msdDebug?.pipelineInstance?.getResolvedModel?.();return t?.overlays?.find((t=>t.id===e))}catch{return null}}_highlightBoundingBoxFromModel(e,t){try{const n=e.anchor,s=e.attach_to,r=window.__msdDebug?.pipelineInstance?.mountElement||window.__msdDebug?.mountElement||document,i=n?r.querySelector(`[data-anchor-id="${CSS.escape(n)}"],#${CSS.escape(n)}`):null,o=s?r.querySelector(`[data-anchor-id="${CSS.escape(s)}"],#${CSS.escape(s)}`):null;if(!i&&!o){const e=r.getBoundingClientRect();return void this._spawnBoundingBox(e,t,"#ff66ff")}const a=[];i&&a.push(i.getBoundingClientRect()),o&&a.push(o.getBoundingClientRect());const l=Math.min(...a.map((e=>e.left))),c=Math.min(...a.map((e=>e.top))),d=Math.max(...a.map((e=>e.right))),u=Math.max(...a.map((e=>e.bottom)));this._spawnBoundingBox({left:l,top:c,width:d-l,height:u-c},t,"#ff66ff")}catch(e){console.warn("[OverlaysPanel] _highlightBoundingBoxFromModel failed:",e)}}_spawnBoundingBox(e,t,n){if(!e)return;const s=document.createElement("div");s.className="msd-overlay-box-highlight",s.style.left=e.left+"px",s.style.top=e.top+"px",s.style.width=e.width+"px",s.style.height=e.height+"px",s.dataset.overlayBoxFor=t,document.body.appendChild(s),setTimeout((()=>s.remove()),3e3),this._toast(`Overlay (bbox): ${t}`,n)}_toast(e,t="#ff66ff"){const n=window.__msdDebug?.hud?.manager?.state?.fontSize||14,s=Math.round(.83*n),r=document.createElement("div");r.style.cssText=`\n      position:fixed;top:18px;right:18px;\n      background:#000;padding:4px 10px;\n      border:1px solid ${t};color:${t};\n      font:${s}px monospace;z-index:1000002;\n      border-radius:4px;opacity:.95;\n    `,r.textContent=e,document.body.appendChild(r),setTimeout((()=>r.remove()),1600)}renderHtml(e){const{overlays:t=[],stats:n={}}=e,s=window.__msdDebug?.hud?.manager?.state?.fontSize||14,r=Math.round(.92*s),i=Math.round(.83*s),o=Math.round(.75*s);Math.round(.67*s);let a='<div class="msd-hud-panel"><h3>Overlays</h3>';return a+="<style>\n      .msd-overlay-highlighted { outline:3px solid #ff66ff !important; }\n    </style>",a+='<div class="msd-hud-section"><h4>Stats</h4>',a+=`<div class="msd-hud-metric"><span class="msd-hud-metric-name">Total</span><span class="msd-hud-metric-value">${n.total||0}</span></div>`,Object.entries(n.byType||{}).slice(0,6).forEach((([e,t])=>{a+=`<div class="msd-hud-metric" style="font-size:${i}px;">\n        <span class="msd-hud-metric-name">${e}</span>\n        <span class="msd-hud-metric-value">${t}</span>\n      </div>`})),a+="</div>",t.length?(a+='<div class="msd-hud-section"><h4>Overlay List</h4>',t.slice(0,25).forEach((e=>{const t=e.id.length>22?e.id.slice(0,19)+"...":e.id,n=e.meta.overridden?" • mod":"",s=(()=>{try{const t=JSON.stringify(e.finalStyle);return t.length>50?t.slice(0,47)+"...":t}catch{return""}})();a+=`<div\n        data-select-type="overlay"\n        data-select-id="${e.id}"\n        style="cursor:pointer;border:1px solid #222;padding:4px;border-radius:4px;margin:4px 0;"\n        onclick="__msdHudBus('select:set',{type:'overlay',id:'${e.id}',source:'overlays'});__msdHudBus('overlay:highlight',{id:'${e.id}'})"\n      >\n        <div style="display:flex;justify-content:space-between;align-items:center;">\n          <span style="color:#aaa;">${t}${n}</span>\n          <span style="color:#ff66ff;font-size:${r}px;">${e.type}</span>\n        </div>\n        <div style="font-size:${i}px;color:#888;margin-top:2px;">\n          ${e.anchor?`Anchor: ${e.anchor}`:"No anchor"} ${e.attach_to?`<span style="color:#ffaa00;font-weight:bold;font-size:${Math.round(1.2*i)}px;"> ➤ </span>${e.attach_to}`:""} ${e.channel?`• Channel: ${e.channel}`:""} ${e.smooth?"• Smooth":""}\n        </div>\n        <div style="font-size:${i}px;color:#666;margin-top:2px;">\n          Sources: ${e.styleSourceCount} • Profiles: ${e.profileCount} • Patches: ${e.patchCount}\n        </div>\n        <div style="font-size:${o}px;color:#555;overflow:hidden;text-overflow:ellipsis;margin-top:2px;">\n          ${s}\n        </div>\n        <div style="margin-top:4px;text-align:right;">\n          <button\n            onclick="event.stopPropagation();__msdHudBus('overlay:highlight',{id:'${e.id}'});__msdHudBus('overlay:analyze',{id:'${e.id}'})"\n            style="font-size:${o}px;padding:2px 6px;background:#331133;color:#ffccff;border:1px solid #553355;border-radius:3px;cursor:pointer;">\n            Analyze\n          </button>\n        </div>\n      </div>`})),t.length>25&&(a+=`<div style="font-size:${o}px;opacity:.6;text-align:center;margin-top:4px;">... ${t.length-25} more</div>`),a+="</div></div>",a):(a+='<div class="msd-hud-section">No overlays</div></div>',a)}}console.log("[MsdHudManager] Importing ExportPanel class");class dc{constructor(){console.log("[MsdHudManager] Testing ExportPanel instantiation...");try{new oc,console.log("[MsdHudManager] ExportPanel test successful")}catch(e){console.error("[MsdHudManager] ExportPanel instantiation failed:",e)}this.bus=new ac,window.__msdHudBus=(e,t)=>this.bus.emit(e,t||{}),this.panels={issues:new sc,flags:new nc,performance:new Kl,export:new oc,rules:new ic,packs:new rc,overlays:new cc,routing:new ec,channelTrend:new tc,dataSources:new Ql,validation:new Zl},console.log("[MsdHudManager] Created panels:",Object.keys(this.panels)),this.state={visible:!1,activePanel:"performance",refreshRate:2e3,lastRefresh:0,panelVisibility:{issues:!0,flags:!0,performance:!0,export:!0,rules:!0,packs:!0,overlays:!0,routing:!1,channelTrend:!1,dataSources:!1,validation:!1},panelOrder:["issues","flags","performance","export","rules","packs","overlays","routing","channelTrend","dataSources","validation"],compactMode:!1,autoPosition:!0,panelManagerOpen:!1,hudWidth:420,resizable:!1,fontSize:14,hudScale:1,fontFamily:'"Antonio", monospace'},console.log("[MsdHudManager] Initial panel order:",this.state.panelOrder),this.hudElement=null,this.refreshInterval=null,this.mountElement=null,this.dragState={isDragging:!1,startX:0,startY:0,startLeft:0,startTop:0},this._setupGlobalPanelControls(),this.keyboardEnabled=!0,this._setupKeyboardShortcuts(),Object.values(this.panels).forEach((e=>{e.bus=this.bus})),this._registerBusHandlers(),this.selection=new lc(this.bus),this._registerSelectionHandlers(),this.show=this.show.bind(this),this.hide=this.hide.bind(this),this.toggle=this.toggle.bind(this),this.refresh=this.refresh.bind(this),this.setRefreshRate=this.setRefreshRate.bind(this)}_setupGlobalPanelControls(){if(window.__msdHudPanelControls)return;const e=this;window.__msdHudPanelControls={togglePanel:function(t){e.state.panelVisibility[t]=!e.state.panelVisibility[t],e.updateHudContent()},setCompactMode:function(t){e.state.compactMode=t,e.updateHudContent()},setAutoPosition:function(t){e.state.autoPosition=t,t&&e._autoPositionHud()},resetPanelLayout:function(){Object.keys(e.state.panelVisibility).forEach((t=>{e.state.panelVisibility[t]=["issues","flags","performance","export"].includes(t)})),e.state.compactMode=!1,e.state.autoPosition=!0,e.updateHudContent(),e._autoPositionHud()},movePanel:function(t,n){const s=[...e.state.panelOrder],r=s.indexOf(t);if(-1===r)return;const i="up"===n?Math.max(0,r-1):Math.min(s.length-1,r+1);[s[r],s[i]]=[s[i],s[r]],e.state.panelOrder=s,e.updateHudContent()},togglePanelManager:function(){e.state.panelManagerOpen=!e.state.panelManagerOpen;const t=document.getElementById("msd-panel-manager");t&&(t.style.display=e.state.panelManagerOpen?"block":"none",e.state.panelManagerOpen&&setTimeout((()=>e._attachPanelManagerEventListeners()),10)),console.log("[MsdHudManager] Panel manager toggled:",e.state.panelManagerOpen)},closePanelManager:function(){e.state.panelManagerOpen=!1;const t=document.getElementById("msd-panel-manager");t&&(t.style.display="none"),console.log("[MsdHudManager] Panel manager closed")},adjustFontSize:function(t){if(e._fontSizeThrottle)return;e._fontSizeThrottle=!0,setTimeout((()=>{e._fontSizeThrottle=!1}),200);const n=Math.max(8,Math.min(20,e.state.fontSize+t));n!==e.state.fontSize&&(e.state.fontSize=n,e._applyFontAndScale(),console.log(`[MsdHudManager] Font size adjusted to ${n}px`))},setFontSize:function(t){const n=Math.max(8,Math.min(20,parseInt(t)||14));n!==e.state.fontSize&&(e.state.fontSize=n,e._applyFontAndScale(),console.log(`[MsdHudManager] Font size set to ${n}px`))},adjustHudScale:function(t){if(e._scaleThrottle)return;e._scaleThrottle=!0,setTimeout((()=>{e._scaleThrottle=!1}),200);const n=Math.max(.7,Math.min(2,e.state.hudScale+t));Math.abs(n-e.state.hudScale)>.05&&(e.state.hudScale=n,e._applyFontAndScale(),console.log(`[MsdHudManager] HUD scale adjusted to ${n.toFixed(2)}x`))},setHudScale:function(t){const n=Math.max(.7,Math.min(2,parseFloat(t)||1));Math.abs(n-e.state.hudScale)>.05&&(e.state.hudScale=n,e._applyFontAndScale(),console.log(`[MsdHudManager] HUD scale set to ${n.toFixed(2)}x`))},setFontFamily:function(t){console.log(`[MsdHudManager] setFontFamily called with: "${t}"`);const n=['"Antonio", monospace',"monospace","sans-serif","serif",'"Courier New", monospace','"Roboto Mono", monospace'];let s=t;t.includes("&quot;")&&(s=t.replace(/&quot;/g,'"')),console.log(`[MsdHudManager] Normalized font family: "${s}"`),n.includes(s)?(e.state.fontFamily=s,e._applyFontAndScale(),console.log(`[MsdHudManager] Font family successfully set to: ${s}`)):console.warn(`[MsdHudManager] Invalid font family: "${t}" (normalized: "${s}")`,{validFamilies:n,received:t,normalized:s})}}}_applyFontAndScale(){if(!this.hudElement)return;const e=this.state.fontSize,t=this.state.hudScale,n=this.state.fontFamily;if(this.hudElement.style.transform=`scale(${t})`,this.hudElement.style.transformOrigin="top left",this.hudElement.style.fontFamily=n,this.hudElement.style.fontSize=`${e}px`,1!==t){const e=this.hudElement.getBoundingClientRect(),n=this.state.hudWidth*t,s=e.height*t,r=parseInt(this.hudElement.style.left)||0,i=parseInt(this.hudElement.style.top)||0,o=window.innerWidth-n-10,a=window.innerHeight-s-10;r>o&&(this.hudElement.style.left=Math.max(10,o)+"px"),i>a&&(this.hudElement.style.top=Math.max(10,a)+"px")}console.log(`[MsdHudManager] Applied font: ${e}px ${n}, scale: ${t}x`)}_autoPositionHud(){if(!this.state.autoPosition||!this.hudElement)return;const e=window.innerWidth,t=window.innerHeight,n=this.state.hudWidth,s=Object.values(this.state.panelVisibility).filter(Boolean).length,r=Math.min(.9*t,200+s*(this.state.compactMode?80:140)),i=document.querySelector("app-header, ha-app-layout app-header"),o=document.querySelector("ha-sidebar, app-drawer-layout ha-sidebar"),a=i?i.offsetHeight:0,l=o&&!o.hasAttribute("collapsed")?o.offsetWidth:0;let c,d;c=e-n-20,l>0&&c<l+20&&(c=Math.max(l+20,e-n-20)),c<20&&(c=20),d=Math.max(a+20,20),d+r>t-20&&(d=Math.max(a+20,t-r-20)),this.hudElement.style.transition="all 0.3s ease",this.hudElement.style.left=c+"px",this.hudElement.style.top=d+"px",this.hudElement.style.right="auto",setTimeout((()=>{this.hudElement.style.transition=""}),300),console.log(`[MsdHudManager] Auto-positioned to (${c}, ${d}) avoiding header:${a}px sidebar:${l}px`)}_setupResizeHandler(){if(this._resizeSetup)return;let e;this._resizeSetup=!0,window.addEventListener("resize",(()=>{this.state.autoPosition&&this.state.visible&&(clearTimeout(e),e=setTimeout((()=>{this._autoPositionHud()}),250))}))}init(e){this.mountElement=e,window.__msdDebug&&(window.__msdDebug.mountElement=e),this._setupDebugStatusHelper(),console.log("[MsdHudManager] Initialized with pipeline mount element reference")}_setupDebugStatusHelper(){if(window.__msdDebug?.getDebugStatusSilent)return;const e="undefined"!=typeof window?window:{};e.__msdDebug=e.__msdDebug||{},e.__msdDebug.getDebugStatusSilent=function(){try{const t=e.__msdDebug?.pipelineInstance,n=t?.systemsManager?.debugManager;if(n?.getSnapshot)return n.getSnapshot();const s=e.__msdDebug?.debug;return s?._state?{...s._state}:{enabled:!1,initialized:!1}}catch(e){return{enabled:!1,initialized:!1,error:e.message}}}}_registerBusHandlers(){const{routing:e,performance:t,flags:n,export:s,dataSources:r,issues:i,overlays:o}=this.panels;this.bus.on("routing:highlight",(({id:t})=>e?.highlightRoute?.(t))),this.bus.on("routing:analyze",(({id:t})=>e?.analyzeRoute?.(t))),this.bus.on("routing:set-filter",(({key:t,value:n})=>e?.setFilter?.(t,n))),this.bus.on("routing:update-cost",(({key:t,value:n})=>e?.updateCostFilter?.(t,n))),this.bus.on("routing:finalize-cost",(()=>e?.finalizeCostFilter?.())),this.bus.on("routing:focus-set",(({field:t,focus:n})=>e?.setInputFocus?.(t,n))),this.bus.on("performance:clear-all",(()=>t?.clearAllTimers?.())),this.bus.on("performance:export",(()=>t?.exportData?.())),this.bus.on("performance:reset-timer",(({timer:e})=>t?.resetTimer?.(e))),this.bus.on("performance:set-threshold",(({timer:e,value:n})=>t?.setThreshold?.(e,n))),this.bus.on("flags:toggle",(({feature:e})=>n?.toggleFeature?.(e))),this.bus.on("flags:scale-adjust",(({dir:e})=>n?.adjustScale?.(e))),this.bus.on("flags:scale-set",(({scale:e})=>n?.setScale?.(e))),this.bus.on("flags:refresh",(()=>n?.refreshDebug?.())),this.bus.on("export:collapsed",(()=>s?.exportCollapsed?.())),this.bus.on("export:full",(()=>s?.exportFull?.(!1))),this.bus.on("export:full-meta",(()=>s?.exportFull?.(!0))),this.bus.on("export:copy",(({type:e})=>s?.copyToClipboard?.(e))),this.bus.on("export:clear",(({type:e})=>s?.clearTextarea?.(e))),this.bus.on("datasource:inspect",(({id:e})=>r?.inspectEntity?.(e))),this.bus.on("datasource:refresh-subs",(()=>r?.refreshSubscriptions?.())),this.bus.on("datasource:clear-history",(()=>r?.clearHistory?.())),this.bus.on("issues:action",(({action:e,id:t,overlay:n})=>i?.handleIssueClick?.(e,t,n))),this.bus.on("overlay:highlight",(({id:e})=>o?.highlightOverlay?.(e))),this.bus.on("overlay:analyze",(({id:e})=>o?.analyzeOverlay?.(e))),this.bus.on("hud:refresh",(()=>this.refresh())),this.bus.on("refresh-rate:change",(({value:e})=>{console.log("[MsdHudManager] Refresh rate change event:",e);const t=parseInt(e);!isNaN(t)&&t>0&&(this.setRefreshRate(t),console.log("[MsdHudManager] Refresh rate set to:",t))})),this.bus.on("width:adjust",(({delta:e})=>{console.log("[MsdHudManager] Width adjust event:",e),this.adjustWidth(parseInt(e))})),this.bus.on("font:adjust",(({delta:e})=>{console.log("[MsdHudManager] Font adjust event:",e,"throttled:",!!this._fontSizeThrottle),window.__msdHudPanelControls?.adjustFontSize(parseInt(e))})),this.bus.on("scale:adjust",(({delta:e})=>{console.log("[MsdHudManager] Scale adjust event:",e,"throttled:",!!this._scaleThrottle),window.__msdHudPanelControls?.adjustHudScale(parseFloat(e))})),this.bus.on("font-family:change",(({value:e})=>{console.log("[MsdHudManager] Font family change event:",e),setTimeout((()=>{window.__msdHudPanelControls?.setFontFamily(e)}),10)})),this.bus.on("font:reset",(()=>{console.log("[MsdHudManager] Font reset event"),this.state.fontSize=14,this.state.hudScale=1,this.state.fontFamily='"Antonio", monospace',this._applyFontAndScale(),this.updateHudContent(),console.log("[MsdHudManager] Font settings reset to defaults")}))}_registerSelectionHandlers(){this.bus.on("select:set",(({type:e,id:t,source:n})=>{this.selection.set(e,t,{source:n}),"route"===e?this.bus.emit("routing:highlight",{id:t}):"overlay"===e&&this.bus.emit("overlay:highlight",{id:t}),this.refresh()})),this.bus.on("select:clear",(()=>{this.selection.clear(),this.refresh()})),this.bus.on("select:changed",(()=>{this._applySelectionHighlight(),this._updateSelectionBadge()}))}_applySelectionHighlight(){if(!this.hudElement)return;const e=this.selection.get();this.hudElement.querySelectorAll(".msd-selected").forEach((e=>e.classList.remove("msd-selected"))),e&&this.hudElement.querySelectorAll(`[data-select-type="${e.type}"][data-select-id="${CSS.escape(e.id)}"]`).forEach((e=>e.classList.add("msd-selected")))}_updateSelectionBadge(){if(!this.hudElement)return;const e=this.hudElement.querySelector("#msd-selection-badge");if(!e)return;const t=this.selection.get();e.innerHTML=t?`\n      <span style="background:#222;border:1px solid #444;padding:2px 6px;border-radius:4px;font-size:10px;display:inline-flex;gap:6px;align-items:center;">\n        <span style="color:#ffaa00;">${t.type}</span>\n        <span style="color:#00ffff;max-width:160px;overflow:hidden;text-overflow:ellipsis;">${t.id}</span>\n        <button data-bus-event="select:clear"\n          onclick="__msdHudBus('select:clear')"\n          style="background:#333;color:#ccc;border:1px solid #555;border-radius:3px;font-size:9px;cursor:pointer;padding:0 4px;">\n          ✕\n        </button>\n      </span>\n    `:""}togglePanelCollapse(e){this.state.collapsedPanels[e]=!this.state.collapsedPanels[e],this._applyCollapseState()}toggleFocusPanel(e){this.state.focusPanel===e?this.state.focusPanel=null:this.state.focusPanel=e,this.updateHudContent()}_applyCollapseState(){this.hudElement&&(this.hudElement.querySelectorAll(".msd-hud-panel[data-panel]").forEach((e=>{const t=e.getAttribute("data-panel"),n=this.state.collapsedPanels[t];n?e.classList.add("collapsed"):e.classList.remove("collapsed");const s=e.querySelector(":scope h3"),r=s?.querySelector(".msd-collapse-indicator");if(r&&(r.textContent=n?"+":"−"),this.state.focusPanel&&this.state.focusPanel!==t?e.classList.add("focus-hidden"):e.classList.remove("focus-hidden"),this.state.filterTerm){const n=this.state.filterTerm.toLowerCase();t.toLowerCase().includes(n)?e.classList.remove("filter-hidden"):e.classList.add("filter-hidden")}else e.classList.remove("filter-hidden")})),this._updateFocusBadgeInFooter())}_decoratePanelHeaders(){this.hudElement&&(this.hudElement.querySelectorAll(".msd-hud-panel[data-panel]").forEach((e=>{const t=e.getAttribute("data-panel"),n=e.querySelector(":scope h3");if(!n||"1"===n.dataset.enhanced)return;n.dataset.enhanced="1",n.style.cursor="pointer";const s=document.createElement("span");s.className="msd-collapse-indicator",s.style.cssText="margin-left:6px;font-weight:bold;color:#ffaa00;",s.textContent=this.state.collapsedPanels[t]?"+":"−",n.appendChild(s),n.title="Click: Collapse/Expand • Alt+Click: Focus panel",n.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),e.altKey?this.toggleFocusPanel(t):this.togglePanelCollapse(t)}))})),this._applyCollapseState())}_updateFocusBadgeInFooter(){if(!this.hudElement)return;const e=this.hudElement.querySelector("#msd-focus-footer");e&&(this.state.focusPanel?e.innerHTML=`\n      <span style="background:#222;border:1px solid #444;padding:2px 6px;border-radius:4px;font-size:9px;">\n        Focus: <strong style="color:#ffaa00;">${this.state.focusPanel}</strong>\n        <button style="margin-left:6px;font-size:9px;background:#333;color:#ccc;border:1px solid #555;border-radius:3px;cursor:pointer;padding:0 4px;"\n          onclick="__msdHudBus && window.__msdDebug?.hud?.manager?.toggleFocusPanel && window.__msdDebug.hud.manager.toggleFocusPanel('${this.state.focusPanel}')">\n          Exit\n        </button>\n      </span>\n    `:e.innerHTML="")}setFilterTerm(e){this.state.filterTerm=e||"",this._applyCollapseState()}createHudElement(){this.hudElement||(this.hudElement=document.createElement("div"),this.hudElement.id="msd-debug-hud",this.hudElement.style.cssText=`\n      position: fixed;\n      top: 10px;\n      right: 10px;\n      width: ${this.state.hudWidth}px;\n      max-height: 90vh;\n      background: rgba(0, 0, 0, 0.95);\n      border: 2px solid #00ffff;\n      border-radius: 8px;\n      color: #00ffff;\n      font-family: monospace;\n      font-size: 12px;\n      z-index: 1000000;\n      overflow-y: auto;\n      backdrop-filter: blur(10px);\n      box-shadow: 0 4px 20px rgba(0, 255, 255, 0.3);\n      cursor: move;\n      user-select: none;\n      ${this.state.resizable?"resize: horizontal; min-width: 300px; max-width: 600px;":""}\n    `,this.setupDragging(),document.body.appendChild(this.hudElement),this.updateHudContent(),this._attachDelegatedEvents())}_attachDelegatedEvents(){!this._delegatedEventsAttached&&this.hudElement&&(this._delegatedEventsAttached=!0,["click","change","input","blur","focus"].forEach((e=>{this.hudElement.addEventListener(e,(t=>{const n=t.target.closest("[data-bus-event]");if(!n||!this.hudElement.contains(n))return;if("SELECT"===n.tagName&&"change"!==e)return;if("BUTTON"===n.tagName&&"click"!==e)return;t.preventDefault(),t.stopPropagation();const{busEvent:s,...r}=Object.fromEntries(Object.entries(n.dataset).map((([e,t])=>[e.replace(/-[a-z]/g,(e=>e[1].toUpperCase())),t])));"SELECT"===n.tagName&&(r.value=n.value),Object.keys(r).forEach((e=>{/^-?\d+(\.\d+)?$/.test(r[e])&&(r[e]=Number(r[e]))})),console.log(`[MsdHudManager] Bus event: ${n.dataset.busEvent}`,r),this.bus.emit(n.dataset.busEvent,r)}),!0)})),this.hudElement.addEventListener("input",(e=>{const t=e.target;t&&"msd-hud-filter"===t.id&&this.setFilterTerm(t.value)}),!0))}updateHudContent(){if(!this.hudElement)return;if(this.panels.routing?.shouldSkipRefresh?.())return;if(this.hudElement.querySelectorAll("select:focus, select:focus-within").length>0)return void console.log("[MsdHudManager] Skipping refresh - dropdown is open");const e=this.state.panelManagerOpen,t={};Object.entries(this.panels).forEach((([e,n])=>{try{n.captureData&&(t[e]=n.captureData())}catch(n){console.warn(`[MsdHudManager] Panel ${e} data capture failed:`,n),t[e]={error:n.message}}})),this.state.lastRefresh=Date.now();try{const n=this.renderHudHtml(t);this.hudElement.innerHTML=n,this.state.compactMode?this.hudElement.classList.add("msd-hud-compact"):this.hudElement.classList.remove("msd-hud-compact"),this._attachPanelManagerEventListeners(),this._updateSelectionBadge(),this._applySelectionHighlight();const s=this.hudElement.querySelector("#msd-hud-filter");if(s&&s.value!==this.state.filterTerm&&(s.value=this.state.filterTerm),e){this.state.panelManagerOpen=!0;const e=document.getElementById("msd-panel-manager");e&&(e.style.display="block")}}catch(e){console.error("[MsdHudManager] HUD render failed:",e),this.hudElement.innerHTML=`\n        <div class="msd-hud-header">\n          <span class="msd-hud-title">MSD Debug HUD - Error</span>\n          <span class="msd-hud-close" onclick="window.__msdDebug?.hud?.hide?.()" title="Close">✕</span>\n        </div>\n        <div style="padding:8px;color:#ff6666;">\n          Render failed: ${e.message}\n        </div>\n      `}}renderHudHtml(e){this.state.compactMode;const t=this.state.fontSize,n=Math.round(1.17*t),s=Math.round(1*t),r=Math.round(1*t),i=Math.round(.92*t),o=Math.round(.83*t),a=Math.round(.75*t),l=Math.round(.67*t);let c=`\n      <style>\n        #msd-debug-hud .msd-hud-header {\n          padding: 8px;\n          background: rgba(0,255,255,0.2);\n          border-bottom: 1px solid #00ffff;\n          display:flex;\n          justify-content:space-between;\n          align-items:center;\n          cursor:grab;\n        }\n        #msd-debug-hud .msd-hud-title { font-weight:bold; pointer-events:none; }\n        #msd-debug-hud .msd-hud-controls { font-size:${o}px; display:flex; gap:4px; }\n        #msd-debug-hud .msd-hud-close, #msd-debug-hud .msd-hud-refresh, #msd-debug-hud .msd-hud-menu {\n          cursor:pointer; padding:2px 6px; border-radius:3px; pointer-events:auto;\n        }\n        #msd-debug-hud .msd-hud-close { background:rgba(255,0,0,0.7); }\n        #msd-debug-hud .msd-hud-refresh { background:rgba(0,255,0,0.7); }\n        #msd-debug-hud .msd-hud-menu { background:rgba(255,170,0,0.7); }\n        #msd-debug-hud .msd-hud-panel { padding:${this.state.compactMode?"4px":"8px"}; border-bottom:1px solid rgba(0,255,255,0.3); }\n        #msd-debug-hud .msd-hud-panel.hidden { display:none; }\n        #msd-debug-hud .msd-hud-panel h3 {\n          margin:0 0 ${this.state.compactMode?"4px":"8px"} 0;\n          color:#ffaa00; font-size:${this.state.compactMode?s:n}px;\n        }\n        #msd-debug-hud .msd-hud-section h4 { margin:6px 0 4px 0; color:#fff; font-size:${r}px; }\n        #msd-debug-hud .msd-hud-metric { display:flex; justify-content:space-between; margin:2px 0; font-size:${i}px; }\n        #msd-debug-hud .msd-hud-metric-name { color:#aaa; }\n        #msd-debug-hud .msd-hud-metric-value { color:#0ff; font-weight:bold; }\n        #msd-debug-hud .msd-hud-error { border-left:3px solid #ff0000; padding-left:6px; }\n        #msd-debug-hud .msd-hud-warning { border-left:3px solid #ffaa00; padding-left:6px; }\n        #msd-debug-hud .msd-hud-success { color:#00ff00; font-size:${i}px; text-align:center; padding:4px; }\n        #msd-debug-hud .msd-hud-summary { text-align:center; font-size:${i}px; padding:4px; background:rgba(255,170,0,0.2); }\n        #msd-debug-hud .msd-selected { outline:2px solid #ffaa00; background:rgba(255,170,0,0.12)!important; position:relative; }\n        #msd-debug-hud .msd-selected::after { content:'●'; position:absolute; top:2px; right:4px; font-size:${l}px; color:#ffaa00; }\n        #msd-debug-hud .msd-panel-controls {\n          padding:6px 8px;\n          background:rgba(0,0,0,0.35);\n          border-bottom:1px solid rgba(0,255,255,0.25);\n          font-size:${o}px;\n        }\n        #msd-debug-hud .msd-panel-controls h4 {\n          margin:4px 0 6px;\n          font-size:${i}px;\n          color:#ffaa00;\n        }\n        #msd-debug-hud .msd-panel-toggle-buttons {\n          display:flex;\n          flex-wrap:wrap;\n          gap:6px;\n          margin:4px 0 8px;\n        }\n        #msd-debug-hud .msd-panel-toggle-btn {\n          cursor:pointer;\n          padding:3px 8px;\n          font-size:${o}px;\n          border:1px solid #044;\n          background:linear-gradient(#022,#011);\n          color:#0ff;\n          border-radius:14px;\n          line-height:1;\n          letter-spacing:.5px;\n          transition:all .18s;\n          position:relative;\n          pointer-events:auto;\n        }\n        #msd-debug-hud .msd-panel-toggle-btn.active {\n          background:linear-gradient(#0ff,#066);\n          color:#000;\n          font-weight:bold;\n          box-shadow:0 0 6px #0ff;\n          border-color:#0aa;\n        }\n        #msd-debug-hud .msd-panel-toggle-btn.inactive {\n          opacity:.45;\n        }\n        #msd-debug-hud .msd-panel-toggle-btn:not(.active):hover {\n          opacity:.8;\n          border-color:#088;\n        }\n        #msd-debug-hud .msd-panel-toggle-btn:focus {\n          outline:1px solid #0ff;\n        }\n        #msd-debug-hud .msd-panel-controls .msd-panel-meta {\n          font-size:${a}px;\n          opacity:.65;\n          margin-top:2px;\n        }\n        #msd-debug-hud select, #msd-debug-hud button, #msd-debug-hud input {\n          pointer-events: auto !important;\n          cursor: pointer !important;\n        }\n        #msd-debug-hud select:hover, #msd-debug-hud button:hover {\n          opacity: 0.9;\n        }\n        /* ADDED: Scale form elements proportionally */\n        #msd-debug-hud select, #msd-debug-hud input {\n          font-size: ${a}px !important;\n        }\n        #msd-debug-hud button {\n          font-size: ${a}px !important;\n        }\n        /* ADDED: Scale footer text */\n        #msd-debug-hud .msd-footer {\n          font-size: ${o}px;\n        }\n        #msd-debug-hud .msd-footer-shortcuts {\n          font-size: ${a}px;\n        }\n        #msd-debug-hud .msd-footer-debug {\n          font-size: ${l}px;\n        }\n      </style>\n    `;c+='\n      <div class="msd-hud-header">\n        <span class="msd-hud-title">MSD v1 Debug HUD</span>\n        <div id="msd-selection-badge" style="flex:1;display:flex;justify-content:center;"></div>\n        <div class="msd-hud-controls">\n          <span class="msd-hud-menu" onclick="window.__msdHudPanelControls?.togglePanelManager?.()" title="Panel Settings">⚙</span>\n          <span class="msd-hud-refresh" onclick="window.__msdDebug?.hud?.refresh?.()" title="Refresh">⟳</span>\n          <span class="msd-hud-close" onclick="window.__msdDebug?.hud?.hide?.()" title="Close">✕</span>\n        </div>\n      </div>\n    ',c+=this._renderPanelControls();let d=0,u=0;this.state.panelOrder.forEach((t=>{const n=this.panels[t];if(!n)return void console.warn(`[MsdHudManager] Panel '${t}' not found in panels object`);const s=this.state.panelVisibility[t],r=s?"":"hidden";s&&u++;try{const s=e[t]||{},i=n.renderHtml(s);c+=`<div class="msd-hud-panel ${r}" data-panel="${t}">\n          ${i}\n        </div>`,d++}catch(e){console.error(`[MsdHudManager] Panel ${t} render failed:`,e),c+=`<div class="msd-hud-panel ${r}" data-panel="${t}">\n          <h3>${t} (Error)</h3>\n          <div class="msd-hud-section">Panel render failed: ${e.message}</div>\n        </div>`,d++}}));const h=Math.round((Date.now()-this.state.lastRefresh)/1e3);return c+=`<div class="msd-footer" style="padding: 4px; text-align: center; color: #666; font-size: ${o}px;">\n      ${u}/${d} panels visible • Updated ${h}s ago • ${this.state.refreshRate/1e3}s\n      <div class="msd-footer-shortcuts" style="margin-top: 2px; opacity: 0.7; font-size: ${a}px;">\n        Shortcuts: Ctrl+H toggle • Ctrl+R refresh • Ctrl+P panels • Ctrl+K compact • 1-9 toggle panels\n      </div>\n      <div class="msd-footer-debug" style="margin-top: 1px; opacity: 0.5; font-size: ${l}px;">\n        Panels: [${this.state.panelOrder.join(", ")}] | Available: [${Object.keys(this.panels).join(", ")}]\n      </div>\n    </div>`,c}startRefresh(){this.stopRefresh(),this.state.refreshRate>0&&(this.refreshInterval=setInterval((()=>{this.state.visible&&this.updateHudContent()}),this.state.refreshRate))}stopRefresh(){this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null)}toggle(){this&&this.state&&(this.state.visible?"function"==typeof this.hide&&this.hide():"function"==typeof this.show&&this.show())}setRefreshRate(e){const t=parseInt(e);isNaN(t)||t<0||(this.state.refreshRate=t,this.state.visible&&this.startRefresh())}setupDragging(){const e=e=>{if(!this.dragState.isDragging)return;const t=e.clientX-this.dragState.startX,n=e.clientY-this.dragState.startY;let s=this.dragState.startLeft+t,r=this.dragState.startTop+n;const i=this.hudElement.getBoundingClientRect();s=Math.max(0,Math.min(window.innerWidth-i.width,s)),r=Math.max(0,Math.min(window.innerHeight-i.height,r)),this.hudElement.style.left=s+"px",this.hudElement.style.top=r+"px",this.hudElement.style.right="auto"},t=()=>{this.dragState.isDragging=!1,this.hudElement.style.cursor="move",document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)};this.hudElement.addEventListener("mousedown",(n=>{if(!n.target.classList.contains("msd-hud-title")&&(!n.target.closest(".msd-hud-header")||n.target.closest(".msd-hud-controls")||n.target.closest("select")||n.target.closest("button")||"SELECT"!==!n.target.tagName||"BUTTON"!==!n.target.tagName))return;n.preventDefault(),n.stopPropagation(),this.dragState.isDragging=!0,this.dragState.startX=n.clientX,this.dragState.startY=n.clientY;const s=this.hudElement.getBoundingClientRect();this.dragState.startLeft=s.left,this.dragState.startTop=s.top,this.hudElement.style.cursor="grabbing",document.addEventListener("mousemove",e),document.addEventListener("mouseup",t)}))}refresh(){this.state.visible&&this.hudElement&&(this.updateHudContent(),console.log("[MsdHudManager] Manual refresh triggered"))}_renderPanelControls(){const e=this.state.fontSize,t=Math.round(.75*e);let n=`<div class="msd-panel-controls" id="msd-panel-manager" style="display:${this.state.panelManagerOpen?"block":"none"};">\n      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">\n        <strong style="letter-spacing:.5px;">Panel Settings</strong>\n        <div style="display:flex;gap:4px;">\n          <button data-action="compact"\n            style="font-size:${t}px;padding:2px 6px;background:${this.state.compactMode?"#ffaa00":"#222"};color:${this.state.compactMode?"#000":"#ccc"};border:1px solid #555;border-radius:4px;cursor:pointer;">\n            Compact\n          </button>\n          <button data-action="reset"\n            style="font-size:${t}px;padding:2px 6px;background:#333;color:#ccc;border:1px solid #555;border-radius:4px;cursor:pointer;">\n            Reset\n          </button>\n          <button data-action="close"\n            style="font-size:${t}px;padding:2px 6px;background:#ff4444;color:#fff;border:1px solid #a00;border-radius:4px;cursor:pointer;">\n            ✕\n          </button>\n        </div>\n      </div>\n      <div class="msd-panel-toggle-buttons">`;return this.state.panelOrder.forEach((e=>{const t=!!this.state.panelVisibility[e];n+=`<button\n        class="msd-panel-toggle-btn ${t?"active":"inactive"}"\n        data-panel-toggle="${e}"\n        aria-pressed="${t}"\n        title="Toggle ${e} panel">\n        ${e}\n      </button>`})),n+=`</div>\n      <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">\n        <label style="font-size:${t}px;opacity:.75;">Refresh:</label>\n        <select id="msd-hud-refresh-rate" name="refresh-rate" data-bus-event="refresh-rate:change"\n          style="font-size:${t}px;background:#111;color:#0ff;border:1px solid #044;padding:2px 4px;border-radius:4px;">\n          <option value="1000" ${1e3===this.state.refreshRate?"selected":""}>1s</option>\n          <option value="2000" ${2e3===this.state.refreshRate?"selected":""}>2s</option>\n          <option value="5000" ${5e3===this.state.refreshRate?"selected":""}>5s</option>\n          <option value="10000" ${1e4===this.state.refreshRate?"selected":""}>10s</option>\n        </select>\n        <div style="margin-left:auto;display:flex;gap:4px;">\n          <button data-bus-event="width:adjust" data-delta="-20" title="Narrower"\n            style="font-size:${t}px;padding:2px 6px;background:#222;color:#0ff;border:1px solid #044;border-radius:4px;cursor:pointer;">◀</button>\n          <button data-bus-event="width:adjust" data-delta="20" title="Wider"\n            style="font-size:${t}px;padding:2px 6px;background:#222;color:#0ff;border:1px solid #044;border-radius:4px;cursor:pointer;">▶</button>\n        </div>\n      </div>\n\n      <div style="display:flex;align-items:center;gap:6px;margin-top:6px;padding-top:4px;border-top:1px solid rgba(0,255,255,0.2);">\n        <label style="font-size:${t}px;opacity:.75;">Font Size:</label>\n        <button data-bus-event="font:adjust" data-delta="-1" title="Smaller Font"\n          style="font-size:${t}px;padding:2px 6px;background:#222;color:#0ff;border:1px solid #044;border-radius:4px;cursor:pointer;">A-</button>\n        <span style="font-size:${t}px;color:#ffaa00;min-width:28px;text-align:center;">${this.state.fontSize}px</span>\n        <button data-bus-event="font:adjust" data-delta="1" title="Larger Font"\n          style="font-size:${t}px;padding:2px 6px;background:#222;color:#0ff;border:1px solid #044;border-radius:4px;cursor:pointer;">A+</button>\n\n        <div style="margin-left:8px;display:flex;align-items:center;gap:4px;">\n          <label style="font-size:${t}px;opacity:.75;">Scale:</label>\n          <button data-bus-event="scale:adjust" data-delta="-0.1" title="Scale Down"\n            style="font-size:${t}px;padding:2px 6px;background:#222;color:#0ff;border:1px solid #044;border-radius:4px;cursor:pointer;">-</button>\n          <span style="font-size:${t}px;color:#ffaa00;min-width:32px;text-align:center;">${this.state.hudScale.toFixed(1)}x</span>\n          <button data-bus-event="scale:adjust" data-delta="0.1" title="Scale Up"\n            style="font-size:${t}px;padding:2px 6px;background:#222;color:#0ff;border:1px solid #044;border-radius:4px;cursor:pointer;">+</button>\n        </div>\n      </div>\n\n      <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">\n        <label style="font-size:${t}px;opacity:.75;">Font:</label>\n        <select id="msd-hud-font-family" name="font-family" data-bus-event="font-family:change"\n          style="font-size:${t}px;background:#111;color:#0ff;border:1px solid #044;padding:2px 4px;border-radius:4px;flex:1;">\n          <option value="&quot;Antonio&quot;, monospace" ${'"Antonio", monospace'===this.state.fontFamily?"selected":""}>Antonio (LCARS)</option>\n          <option value="monospace" ${"monospace"===this.state.fontFamily?"selected":""}>Monospace</option>\n          <option value="sans-serif" ${"sans-serif"===this.state.fontFamily?"selected":""}>Sans-serif</option>\n          <option value="serif" ${"serif"===this.state.fontFamily?"selected":""}>Serif</option>\n          <option value="&quot;Courier New&quot;, monospace" ${'"Courier New", monospace'===this.state.fontFamily?"selected":""}>Courier New</option>\n          <option value="&quot;Roboto Mono&quot;, monospace" ${'"Roboto Mono", monospace'===this.state.fontFamily?"selected":""}>Roboto Mono</option>\n        </select>\n        <button data-bus-event="font:reset" title="Reset Font Settings"\n          style="font-size:${t}px;padding:2px 6px;background:#333;color:#ccc;border:1px solid #555;border-radius:4px;cursor:pointer;">Reset</button>\n      </div>      <div class="msd-panel-meta">\n        Click buttons to toggle panels • Order: ${this.state.panelOrder.join(", ")}\n      </div>\n    </div>`,n}_attachPanelManagerEventListeners(){try{const e=document.getElementById("msd-panel-manager");if(!e)return;const t=e.querySelector('[data-action="compact"]');t&&(t.onclick=e=>{e.preventDefault(),e.stopPropagation(),window.__msdHudPanelControls?.setCompactMode(!this.state.compactMode)});const n=e.querySelector('[data-action="reset"]');n&&(n.onclick=e=>{e.preventDefault(),e.stopPropagation(),window.__msdHudPanelControls?.resetPanelLayout()});const s=e.querySelector('[data-action="close"]');s&&(s.onclick=e=>{e.preventDefault(),e.stopPropagation(),window.__msdHudPanelControls?.closePanelManager()}),e.querySelectorAll("[data-panel-toggle]").forEach((e=>{const t=e.getAttribute("data-panel-toggle");t&&(e.onclick=e=>{e.preventDefault(),e.stopPropagation(),window.__msdHudPanelControls?.togglePanel(t)})}))}catch(e){console.warn("[MsdHudManager] Failed to attach panel manager event listeners:",e)}}adjustWidth(e){const t=Math.max(300,Math.min(600,this.state.hudWidth+e));t!==this.state.hudWidth&&(this.state.hudWidth=t,this.hudElement&&(this.hudElement.style.width=t+"px"),console.log(`[MsdHudManager] HUD width adjusted to ${t}px`),setTimeout((()=>this.updateHudContent()),100))}_setupKeyboardShortcuts(){if(this._keyboardSetup)return;this._keyboardSetup=!0;const e=this;document.addEventListener("keydown",(t=>{if(e.keyboardEnabled&&e.state.visible&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName){if(t.ctrlKey||t.metaKey)switch(t.key.toLowerCase()){case"h":t.preventDefault(),e.toggle();break;case"r":e.state.visible&&(t.preventDefault(),e.refresh());break;case"p":e.state.visible&&(t.preventDefault(),window.__msdHudPanelControls?.togglePanelManager?.());break;case"k":e.state.visible&&(t.preventDefault(),e.state.compactMode=!e.state.compactMode,e.updateHudContent())}if(e.state.visible&&!t.ctrlKey&&!t.metaKey){const n=parseInt(t.key);if(n>=1&&n<=9){const s=e.state.panelOrder[n-1];s&&(t.preventDefault(),window.__msdHudPanelControls?.togglePanel(s))}}}})),document.addEventListener("keydown",(t=>{t.ctrlKey&&t.shiftKey&&"h"===t.key.toLowerCase()&&(t.preventDefault(),e.toggle())}))}show(){this.state.visible||(this.state.visible=!0,this.createHudElement(),this.startRefresh(),this._setupResizeHandler(),this._applyFontAndScale(),window.__msdDebug&&(window.__msdDebug.hud={manager:this,refresh:()=>this.refresh(),hide:()=>this.hide(),show:()=>this.show(),toggle:()=>this.toggle(),setRefreshRate:e=>this.setRefreshRate(e),bus:this.bus}),this.state.autoPosition&&setTimeout((()=>this._autoPositionHud()),100),console.log("[MsdHudManager] HUD activated and exposed globally"))}hide(){this.state.visible&&(this.state.visible=!1,this.stopRefresh(),this.hudElement&&(this.hudElement.remove(),this.hudElement=null),console.log("[MsdHudManager] HUD deactivated"))}}class uc{constructor(e=100){if(e<1)throw new Error("RollingBuffer capacity must be at least 1");this.capacity=Math.min(e,1e3),this._timestamps=new Array(e),this._values=new Array(e),this._head=0,this._size=0,this._full=!1,this._stats={pushes:0,overwrites:0,queries:0},this._lastPushTime=0,this._coalescingThresholdMs=10}push(e,t){const n=Date.now();if((e<n-31536e6||e>n+36e5)&&console.warn(`[RollingBuffer] Suspicious timestamp: ${e} (${new Date(e).toISOString()}), current: ${n} (${new Date(n).toISOString()})`),!Number.isFinite(e)||e<0)console.warn("[RollingBuffer] Invalid timestamp:",e);else if("number"==typeof t&&isFinite(t)){if(this._size>0&&n-this._lastPushTime<this._coalescingThresholdMs){const s=0===this._head?this.capacity-1:this._head-1,r=this._timestamps[s];if(Math.abs(e-r)<1e3)return this._values[s]=t,this._stats.overwrites++,void(this._lastPushTime=n)}this._timestamps[this._head]=e,this._values[this._head]=t,this._stats.pushes++,this._full&&this._stats.overwrites++,this._head=(this._head+1)%this.capacity,this._size<this.capacity?this._size++:this._full=!0,this._lastPushTime=n,console.log(`[RollingBuffer] Added point: ${t} at ${new Date(e).toISOString()} (buffer size: ${this._size})`)}else console.warn(`[RollingBuffer] Invalid value: ${t} for timestamp ${e}`)}getArrays(){if(this._stats.queries++,0===this._size)return{t:[],v:[]};const e=new Array(this._size),t=new Array(this._size),n=this._full?this._head:0;for(let s=0;s<this._size;s++){const r=(n+s)%this.capacity;e[s]=this._timestamps[r],t[s]=this._values[r]}return{t:e,v:t}}getAll(){if(this._stats.queries++,0===this._size)return[];const e=new Array(this._size),t=this._full?this._head:0;for(let n=0;n<this._size;n++){const s=(t+n)%this.capacity;e[n]={t:this._timestamps[s],v:this._values[s]}}return e}sliceSince(e){if(this._stats.queries++,0===this._size||!Number.isFinite(e)||e<=0)return{t:[],v:[]};const t=Date.now()-e,{t:n,v:s}=this.getArrays();let r=0;for(let e=0;e<n.length;e++)if(n[e]>=t){r=e;break}return{t:n.slice(r),v:s.slice(r)}}last(){if(0===this._size)return null;const e=0===this._head?this.capacity-1:this._head-1;return{t:this._timestamps[e],v:this._values[e]}}first(){if(0===this._size)return null;const e=this._full?this._head:0;return{t:this._timestamps[e],v:this._values[e]}}clear(){this._head=0,this._size=0,this._full=!1}getStats(){return{capacity:this.capacity,size:this._size,utilization:this._size/this.capacity,pushes:this._stats.pushes,overwrites:this._stats.overwrites,queries:this._stats.queries,overwriteRate:this._stats.pushes>0?this._stats.overwrites/this._stats.pushes:0}}isFull(){return this._full}size(){return this._size}_validateConsistency(){const e=[];if((this._size<0||this._size>this.capacity)&&e.push(`Invalid size: ${this._size} (capacity: ${this.capacity})`),(this._head<0||this._head>=this.capacity)&&e.push(`Invalid head: ${this._head} (capacity: ${this.capacity})`),this._full&&this._size!==this.capacity&&e.push(`Full flag inconsistent: full=${this._full}, size=${this._size}, capacity=${this.capacity}`),this._size>1){const{t}=this.getArrays();for(let n=1;n<t.length;n++)if(t[n]<t[n-1]){e.push(`Timestamp ordering violation at index ${n}: ${t[n-1]} -> ${t[n]}`);break}}return!(e.length>0&&(console.warn("[RollingBuffer] Consistency issues:",e),1))}}class hc{constructor(e){this.config={...e},this.key=e.key||this.constructor.name.toLowerCase(),this.enabled=!1!==e.enabled,this._stats={transformations:0,errors:0,totalTime:0}}transform(e,t,n){if(!this.enabled)return e;const s=performance.now();try{const r=this._doTransform(e,t,n);return this._stats.transformations++,this._stats.totalTime+=performance.now()-s,r}catch(t){return this._stats.errors++,console.warn(`[${this.constructor.name}] Transform failed:`,t),this._getFallbackValue(e)}}_doTransform(e,t,n){throw new Error("_doTransform must be implemented by subclasses")}_getFallbackValue(e){return e}getStats(){return{...this._stats,key:this.key,enabled:this.enabled,avgTime:this._stats.transformations>0?this._stats.totalTime/this._stats.transformations:0}}resetStats(){this._stats={transformations:0,errors:0,totalTime:0}}}class pc extends hc{constructor(e){super(e),this.conversions={"°f_to_°c":e=>5*(e-32)/9,f_to_c:e=>5*(e-32)/9,"°c_to_°f":e=>9*e/5+32,c_to_f:e=>9*e/5+32,w_to_kw:e=>e/1e3,kw_to_w:e=>1e3*e,kb_to_mb:e=>e/1024,mb_to_gb:e=>e/1024},this.fromUnit=e.from?.toLowerCase(),this.toUnit=e.to?.toLowerCase(),this.factor=e.factor,this.offset=e.offset||0,this.customFunction=e.customFunction}_doTransform(e,t,n){if(!Number.isFinite(e))return null;if(this.customFunction&&"function"==typeof this.customFunction)return this.customFunction(e);const s=[`${this.fromUnit}_to_${this.toUnit}`,`${this.fromUnit.replace(/°/g,"")}_to_${this.toUnit.replace(/°/g,"")}`,`${this.fromUnit.replace(/[°\s]/g,"")}_to_${this.toUnit.replace(/[°\s]/g,"")}`];for(const t of s)if(this.conversions[t])return this.conversions[t](e);if(Number.isFinite(this.factor))return e*this.factor+this.offset;throw new Error(`No conversion method available for ${this.fromUnit} to ${this.toUnit}. Available: ${Object.keys(this.conversions).join(", ")}`)}}class gc extends hc{constructor(e){if(super(e),this.inputRange=e.input_range||e.inputRange||[0,100],this.outputRange=e.output_range||e.outputRange||[0,1],this.clamp=!1!==e.clamp,!Array.isArray(this.inputRange)||2!==this.inputRange.length)throw new Error("input_range must be an array of 2 numbers");if(!Array.isArray(this.outputRange)||2!==this.outputRange.length)throw new Error("output_range must be an array of 2 numbers")}_doTransform(e,t,n){if(!Number.isFinite(e))return null;const[s,r]=this.inputRange,[i,o]=this.outputRange;return i+((this.clamp?Math.max(s,Math.min(r,e)):e)-s)/(r-s)*(o-i)}}class mc extends hc{constructor(e){super(e),this.method=e.method||"exponential",this.alpha=e.alpha||.3,this.windowSize=e.window_size||e.windowSize||5,this._lastSmoothed=null,this._window=[]}_doTransform(e,t,n){if(!Number.isFinite(e))return null;switch(this.method){case"exponential":return this._exponentialSmooth(e);case"moving_average":return this._movingAverage(e);case"median":return this._medianFilter(e);default:throw new Error(`Unknown smoothing method: ${this.method}`)}}_exponentialSmooth(e){return null===this._lastSmoothed?(this._lastSmoothed=e,e):(this._lastSmoothed=this.alpha*e+(1-this.alpha)*this._lastSmoothed,this._lastSmoothed)}_movingAverage(e){return this._window.push(e),this._window.length>this.windowSize&&this._window.shift(),this._window.reduce(((e,t)=>e+t),0)/this._window.length}_medianFilter(e){this._window.push(e),this._window.length>this.windowSize&&this._window.shift();const t=[...this._window].sort(((e,t)=>e-t)),n=Math.floor(t.length/2);return t.length%2==0?(t[n-1]+t[n])/2:t[n]}}class fc extends hc{constructor(e){if(super(e),this.expression=e.expression,!this.expression)throw new Error("Expression is required for ExpressionProcessor");try{this._compiledFunction=new Function("value","timestamp","buffer","Math",`\n        "use strict";\n        return (${this.expression});\n      `)}catch(e){throw new Error(`Failed to compile expression: ${e.message}`)}}_doTransform(e,t,n){if(!Number.isFinite(e))return null;try{const s=this._compiledFunction(e,t,n,Math);return Number.isFinite(s)?s:null}catch(e){throw new Error(`Expression evaluation failed: ${e.message}`)}}}class yc{constructor(e,t){this.type=e,this.config={...t},this.key=t.key||e,this.enabled=!1!==t.enabled,this.windowMs=this._parseTimeWindow(t.window),this.maxAge=this.windowMs||864e5,this._values=[],this._lastUpdate=0,this._result=null,this._stats={updates:0,calculations:0,resets:0}}update(e,t,n={}){this.enabled&&Number.isFinite(t)&&(this._cleanOldValues(e),this._values.push({timestamp:e,value:t,transformed:n}),this._lastUpdate=e,this._stats.updates++,this._calculate())}getValue(){return this._result}getStats(){return{...this._stats,type:this.type,key:this.key,enabled:this.enabled,valueCount:this._values.length,windowMs:this.windowMs,lastUpdate:this._lastUpdate,currentResult:this._result}}reset(){this._values=[],this._result=null,this._stats.resets++}_cleanOldValues(e){if(!this.windowMs)return;const t=e-this.windowMs,n=this._values.length;this._values=this._values.filter((e=>e.timestamp>=t)),this._values.length!==n&&(this._stats.cleanedValues=(this._stats.cleanedValues||0)+(n-this._values.length))}_parseTimeWindow(e){if("number"==typeof e)return e;if("string"!=typeof e)return null;const t=e.match(/^(\d+(?:\.\d+)?)\s*(s|sec|m|min|h|hr|d|day)s?$/i);if(!t)return null;const n=parseFloat(t[1]);switch(t[2].toLowerCase()){case"s":case"sec":return 1e3*n;case"m":case"min":return 60*n*1e3;case"h":case"hr":return 60*n*60*1e3;case"d":case"day":return 24*n*60*60*1e3;default:return null}}_calculate(){throw new Error("_calculate must be implemented by subclasses")}}class bc extends yc{constructor(e){super("moving_average",e),this.maxSamples=e.max_samples||e.maxSamples}_calculate(){if(0===this._values.length)return void(this._result=null);let e=this._values;this.maxSamples&&e.length>this.maxSamples&&(e=e.slice(-this.maxSamples));const t=e.reduce(((e,t)=>e+t.value),0);this._result=t/e.length,this._stats.calculations++}}class _c extends yc{constructor(e){super("min_max",e),this.trackMin=!1!==e.min,this.trackMax=!1!==e.max,this.trackAvg=!0===e.avg}_calculate(){if(0===this._values.length)return void(this._result=null);const e=this._values.map((e=>e.value)),t={};if(this.trackMin&&(t.min=Math.min(...e)),this.trackMax&&(t.max=Math.max(...e)),this.trackAvg){const n=e.reduce(((e,t)=>e+t),0);t.avg=n/e.length}t.count=e.length,this._result=t,this._stats.calculations++}}class vc extends yc{constructor(e){super("rate_of_change",e),this.unit=e.unit||"per_second",this.smoothing=e.smoothing||!1}_calculate(){if(this._values.length<2)return void(this._result=null);const e=this._values.slice(-2),[t,n]=e,s=(n.timestamp-t.timestamp)/1e3;if(s<=0)return void(this._result=0);let r=(n.value-t.value)/s;switch(this.unit){case"per_minute":r*=60;break;case"per_hour":r*=3600}this._result=r,this._stats.calculations++}}class wc extends yc{constructor(e){super("session_stats",e),this._firstValue=null,this._sessionStart=Date.now()}_calculate(){if(0===this._values.length)return void(this._result=null);const e=this._values.map((e=>e.value)),t=this._values.map((e=>e.timestamp));null===this._firstValue&&(this._firstValue=e[0]);const n={count:e.length,min:Math.min(...e),max:Math.max(...e),avg:e.reduce(((e,t)=>e+t),0)/e.length,first:this._firstValue,last:e[e.length-1],sessionDuration:(Date.now()-this._sessionStart)/1e3,dataSpan:(t[t.length-1]-t[0])/1e3};this._result=n,this._stats.calculations++}}class Sc extends yc{constructor(e){super("recent_trend",e),this.samples=e.samples||5,this.threshold=e.threshold||.01}_calculate(){if(this._values.length<2)return void(this._result={direction:"unknown",strength:0});const e=this._values.slice(-this.samples);if(e.length<2)return void(this._result={direction:"unknown",strength:0});const t=e.length,n=e.reduce(((e,t,n)=>e+n),0),s=e.reduce(((e,t)=>e+t.value),0),r=e.reduce(((e,t,n)=>e+n*t.value),0),i=e.reduce(((e,t,n)=>e+n*n),0),o=(t*r-n*s)/(t*i-n*n);let a="stable";Math.abs(o)>this.threshold&&(a=o>0?"increasing":"decreasing"),this._result={direction:a,strength:Math.abs(o),slope:o},this._stats.calculations++}}const xc="undefined"==typeof window,$c=xc?e=>setTimeout(e,16):window.requestAnimationFrame,Cc=xc?e=>clearTimeout(e):window.cancelAnimationFrame;class Mc{constructor(e,t){this.cfg={...e},this.hass=t,this.cfg.entity||(console.warn("[MsdDataSource] No entity specified in config"),this.cfg.entity="");let n=60;if("number"==typeof e.windowSeconds&&isFinite(e.windowSeconds))n=Math.max(1,e.windowSeconds);else if("string"==typeof e.windowSeconds){const t=this._parseTimeWindowMs(e.windowSeconds);Number.isFinite(t)&&(n=Math.max(1,Math.floor(t/1e3)))}const s=Math.max(60,Math.floor(10*n));this.buffer=new uc(s);const r=Number.isFinite(e.minEmitMs)?e.minEmitMs:Number.isFinite(e.sampleMs)?e.sampleMs:100;this.minEmitMs=Math.max(10,r),this.coalesceMs=Number.isFinite(e.coalesceMs)?Math.max(20,e.coalesceMs):Math.max(20,Math.round(.4*this.minEmitMs)),this.maxDelayMs=Number.isFinite(e.maxDelayMs)?Math.max(this.minEmitMs,e.maxDelayMs):Math.max(this.minEmitMs,3*this.coalesceMs),this.emitOnSameValue=!1!==e.emitOnSameValue,this.subscribers=new Set,this.haUnsubscribe=null,this.transformations=new Map,this.aggregations=new Map,this._transformationData=new Map,this._aggregationData=new Map,this._lastEmitTime=0,this._lastEmittedValue=null,this._pendingRaf=0,this._pending=!1,this._pendingFirstTs=0,this._pendingCount=0,this._stats={emits:0,coalesced:0,skipsSameValue:0,received:0,invalid:0,historyLoaded:0},this._started=!1,this._destroyed=!1,this._initializeProcessors(e)}_initializeProcessors(e){e.transformations&&Array.isArray(e.transformations)&&e.transformations.forEach(((e,t)=>{try{const n=e.key||`transform_${t}`,s=function(e){if(!e||!e.type)throw new Error("Transformation config must specify a type");switch(e.type){case"unit_conversion":return new pc(e);case"scale":return new gc(e);case"smooth":return new mc(e);case"expression":return new fc(e);default:throw new Error(`Unknown transformation type: ${e.type}`)}}(e);this.transformations.set(n,s),console.log(`[MsdDataSource] Initialized transformation: ${n} (${e.type})`)}catch(e){console.warn(`[MsdDataSource] Failed to create transformation ${t}:`,e)}})),e.aggregations&&"object"==typeof e.aggregations&&Object.entries(e.aggregations).forEach((([e,t])=>{try{const n=t.key||e,s=function(e,t){switch(e){case"moving_average":return new bc(t);case"min_max":case"daily_stats":return new _c(t);case"rate_of_change":return new vc(t);case"session_stats":return new wc(t);case"recent_trend":return new Sc(t);default:throw new Error(`Unknown aggregation type: ${e}`)}}(e,t);this.aggregations.set(n,s),console.log(`[MsdDataSource] Initialized aggregation: ${n} (${e})`)}catch(t){console.warn(`[MsdDataSource] Failed to create aggregation ${e}:`,t)}})),console.log(`[MsdDataSource] Processor initialization complete: ${this.transformations.size} transformations, ${this.aggregations.size} aggregations`)}async _preloadHistory(){if(!this.hass?.callService||!this.cfg.entity)return;const e=this.cfg.history||{};if(!1===e.enabled)return;const t=Math.max(1,Math.min(168,e.hours||6)),n=new Date,s=new Date(n.getTime()-36e5*t);console.log(`[MsdDataSource] 📊 Preloading ${t}h history for ${this.cfg.entity}`);try{await this._preloadWithHistoryService(s,n)}catch(e){console.warn(`[MsdDataSource] History service failed for ${this.cfg.entity}, trying statistics:`,e.message);try{await this._preloadWithStatistics(s,n)}catch(e){console.warn("[MsdDataSource] Statistics failed, trying state history:",e.message),await this._preloadStateHistory(s,n)}}console.log(`[MsdDataSource] History preload complete: ${this._stats.historyLoaded} points loaded`)}async _preloadWithHistoryService(e,t){const n=await this.hass.callService("history","get_history",{entity_ids:[this.cfg.entity],start_time:e.toISOString(),end_time:t.toISOString()});if(n&&n[0]){const e=n[0];console.log(`[MsdDataSource] History service returned ${e.length} states for ${this.cfg.entity}`);for(const t of e){const e=new Date(t.last_changed||t.last_updated).getTime(),n=this.cfg.attribute?t.attributes?.[this.cfg.attribute]:t.state,s=this._toNumber(n);null!==s&&(this.buffer.push(e,s),this._stats.historyLoaded++)}}}async _preloadWithStatistics(e,t){const n=await this.hass.callService("recorder","get_statistics",{statistic_ids:[this.cfg.entity],start_time:e.toISOString(),end_time:t.toISOString(),period:"5minute"});if(n&&n[0]?.statistics){const e=n[0].statistics;console.log(`[MsdDataSource] Statistics returned ${e.length} points for ${this.cfg.entity}`);for(const t of e){const e=new Date(t.start).getTime(),n=this._extractStatisticValue(t);null!==n&&(this.buffer.push(e,n),this._stats.historyLoaded++)}}}async start(){if(!this._started&&!this._destroyed)try{if(console.log(`[MsdDataSource] 🚀 Starting initialization for ${this.cfg.entity}`),this.hass?.callService&&await this._preloadHistory(),this.hass.states&&this.hass.states[this.cfg.entity]){const e=this.hass.states[this.cfg.entity];console.log(`[MsdDataSource] 🔄 Loading initial state for ${this.cfg.entity}:`,e.state),e.attributes?.unit_of_measurement&&(this.cfg.unit_of_measurement=e.attributes.unit_of_measurement,console.log(`[MsdDataSource] 📊 Captured initial unit_of_measurement for ${this.cfg.entity}: "${this.cfg.unit_of_measurement}"`));const t=Date.now(),n=this.cfg.attribute?e.attributes?.[this.cfg.attribute]:e.state,s=this._toNumber(n);null!==s&&(console.log(`[MsdDataSource] Adding current state: ${s} at ${t}`),this.buffer.push(t,s),this._stats.currentValue=s)}this.haUnsubscribe=await this.hass.connection.subscribeEvents((e=>{"state_changed"===e.event_type&&e.data?.entity_id===this.cfg.entity&&(console.log(`[MsdDataSource] 📊 HA event received for ${this.cfg.entity}:`,e.data.new_state?.state),this._handleStateChange(e.data))}),"state_changed"),this._started=!0,console.log(`[MsdDataSource] ✅ Full initialization complete for ${this.cfg.entity} - Buffer: ${this.buffer.size()} points`),this._emitInitialData()}catch(e){throw console.error(`[MsdDataSource] ❌ Failed to initialize ${this.cfg.entity}:`,e),e}}_emitInitialData(){if(this.subscribers.size>0){const e=this.buffer.last();if(e){console.log(`[MsdDataSource] 📤 Emitting initial data for ${this.cfg.entity} to ${this.subscribers.size} subscribers`);const t={t:e.t,v:e.v,buffer:this.buffer,stats:{...this._stats},transformations:this._getTransformationData(),aggregations:this._getAggregationData(),entity:this.cfg.entity,unit_of_measurement:this.cfg.unit_of_measurement,historyReady:this._stats.historyLoaded>0,isInitialEmission:!0};this.subscribers.forEach((e=>{try{e(t)}catch(e){console.error(`[MsdDataSource] Initial callback error for ${this.cfg.entity}:`,e)}}))}else{console.log(`[MsdDataSource] 📤 Emitting initial empty data structure for ${this.cfg.entity} to ${this.subscribers.size} subscribers`);const e={t:null,v:null,buffer:this.buffer,stats:{...this._stats},transformations:this._getTransformationData(),aggregations:this._getAggregationData(),entity:this.cfg.entity,unit_of_measurement:this.cfg.unit_of_measurement,historyReady:this._stats.historyLoaded>0,isInitialEmission:!0};this.subscribers.forEach((t=>{try{t(e)}catch(e){console.error(`[MsdDataSource] Initial callback error for ${this.cfg.entity}:`,e)}}))}}}async _preloadHistory(){if(!this.hass?.connection||!this.cfg.entity)return void console.warn("[MsdDataSource] No HASS connection or entity for history preload");const e=Math.max(1,Math.min(168,this.cfg.history?.hours||6)),t=new Date,n=new Date(t.getTime()-36e5*e);console.log(`[MsdDataSource] 🔄 Preloading ${e}h history for ${this.cfg.entity}`);try{const e=await this.hass.connection.sendMessagePromise({type:"recorder/statistics_during_period",start_time:n.toISOString(),end_time:t.toISOString(),statistic_ids:[this.cfg.entity],period:"hour"});if(e&&e[this.cfg.entity]){const t=e[this.cfg.entity];console.log(`[MsdDataSource] 📊 Got ${t.length} statistics points`);for(const e of t){const t=new Date(e.start).getTime(),n=this._extractStatisticValue(e);null!==n&&(this.buffer.push(t,n),this._stats.historyLoaded++)}return void console.log(`[MsdDataSource] ✅ Loaded ${this._stats.historyLoaded} statistics points`)}}catch(e){console.warn("[MsdDataSource] Statistics failed, trying state history:",e.message)}await this._preloadStateHistoryWS(n,t)}async _preloadStateHistoryWS(e,t){try{console.log(`[MsdDataSource] 📚 Trying WebSocket state history for ${this.cfg.entity}`);const n=await this.hass.connection.sendMessagePromise({type:"history/history_during_period",start_time:e.toISOString(),end_time:t.toISOString(),entity_ids:[this.cfg.entity],minimal_response:!0,no_attributes:!0});if(n&&n[0]){const e=n[0];console.log(`[MsdDataSource] 📊 Got ${e.length} history states`);for(const t of e){const e=new Date(t.last_changed||t.last_updated).getTime(),n=this.cfg.attribute?t.attributes?.[this.cfg.attribute]:t.state,s=this._toNumber(n);null!==s&&(this.buffer.push(e,s),this._stats.historyLoaded++)}console.log(`[MsdDataSource] ✅ Loaded ${this._stats.historyLoaded} history points`)}else console.warn("[MsdDataSource] No history data returned from WebSocket call")}catch(n){console.error("[MsdDataSource] WebSocket state history also failed:",n),await this._preloadHistoryREST(e,t)}}async _preloadHistoryREST(e,t){try{console.log(`[MsdDataSource] 🌐 Trying REST API history for ${this.cfg.entity}`);const t=`/api/history/period/${e.toISOString()}?filter_entity_id=${this.cfg.entity}&minimal_response&no_attributes`,n=await fetch(t,{headers:{Authorization:`Bearer ${this.hass.auth?.accessToken}`,"Content-Type":"application/json"}});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const s=await n.json();if(s&&s[0]){const e=s[0];console.log(`[MsdDataSource] 📊 Got ${e.length} REST history states`);for(const t of e){const e=new Date(t.last_changed||t.last_updated).getTime(),n=this.cfg.attribute?t.attributes?.[this.cfg.attribute]:t.state,s=this._toNumber(n);null!==s&&(this.buffer.push(e,s),this._stats.historyLoaded++)}console.log(`[MsdDataSource] ✅ Loaded ${this._stats.historyLoaded} REST history points`)}}catch(e){console.error("[MsdDataSource] REST history fallback also failed:",e)}}_handleStateChange(e){if(console.log("[MSD DEBUG] 📊 MsdDataSource._handleStateChange() ENTRY:",{entity:this.cfg.entity,timestamp:(new Date).toISOString(),hasEventData:!!e,hasNewState:!!e?.new_state,newStateValue:e?.new_state?.state,subscriberCount:this.subscribers.size,stackTrace:(new Error).stack.split("\n").slice(1,3).join("\n")}),!e?.new_state||this._destroyed)return void console.log("[MSD DEBUG] ⏭️ Skipping state change - no new state or destroyed");this._lastOriginalState=e.new_state,e.new_state.attributes?.unit_of_measurement&&(this.cfg.unit_of_measurement=e.new_state.attributes.unit_of_measurement,console.log(`[MSD DEBUG] 📊 Captured unit_of_measurement for ${this.cfg.entity}: "${this.cfg.unit_of_measurement}"`));const t=Date.now(),n=this.cfg.attribute?e.new_state.attributes?.[this.cfg.attribute]:e.new_state.state,s=this._toNumber(n);if(null!==s){console.log(`[MSD DEBUG] 📊 Processing state change for ${this.cfg.entity}:`,{value:s,timestamp:t,subscriberCount:this.subscribers.size,originalState:this._lastOriginalState.state,unit_of_measurement:this.cfg.unit_of_measurement}),this.buffer.push(t,s),this._stats.updates++,this._stats.currentValue=s;const e=this._applyTransformations(t,s);this._updateAggregations(t,s,e),console.log(`[MSD DEBUG] 📤 Emitting to ${this.subscribers.size} subscribers:`,s);const n={t,v:s,buffer:this.buffer,stats:{...this._stats},transformations:this._getTransformationData(),aggregations:this._getAggregationData(),entity:this.cfg.entity,unit_of_measurement:this.cfg.unit_of_measurement,historyReady:this._stats.historyLoaded>0};this.subscribers.forEach(((e,t)=>{try{console.log(`[MSD DEBUG] 📞 Calling subscriber ${t} for ${this.cfg.entity}`),e(n),console.log(`[MSD DEBUG] ✅ Subscriber ${t} completed successfully`)}catch(e){console.error(`[MSD DEBUG] ❌ Subscriber ${t} callback FAILED for ${this.cfg.entity}:`,e),console.error("[MSD DEBUG] ❌ Subscriber error stack:",e.stack)}}))}else console.log("[MSD DEBUG] ⚠️ Skipping state change - invalid value:",{rawValue:n,entity:this.cfg.entity})}_shouldEmit(e,t){return Date.now(),this._lastEmitTime&&t-this._lastEmitTime<this.minEmitMs?(this._stats.coalesced++,!1):!(!this.emitOnSameValue&&e===this._lastEmittedValue&&(this._stats.skipsSameValue++,1))}_emit(e){const t=Date.now();this._lastEmitTime=t,this._lastEmittedValue=e.v,this._stats.emits++,console.log(`[MsdDataSource] 📤 Emitting to ${this.subscribers.size} subscribers:`,e.v),this.subscribers.forEach((t=>{try{t(e)}catch(e){console.warn("[MsdDataSource] Subscriber callback error:",e)}}))}async _subscribeLive(){if(!this.hass?.connection?.subscribeEvents||!this.cfg.entity)return;const e=this.cfg.entity;try{this.haUnsubscribe=await this.hass.connection.subscribeEvents((t=>{const n=t?.data?.new_state;if(!n||n.entity_id!==e)return;const s=new Date(n.last_changed||n.last_updated||Date.now()).getTime(),r=this.cfg.attribute?n.attributes?.[this.cfg.attribute]:n.state,i=this._toNumber(r);this._onRawEventValue(s,i)}),"state_changed")}catch(e){console.warn("[MsdDataSource] Failed to subscribe to HA events:",e.message)}}_onRawEventValue(e,t){if(null===t)return void this._stats.invalid++;const n=xc?Date.now():performance.now();this.buffer.push(e,t),this._stats.received++,this._pending?(this._pendingCount++,n-this._pendingFirstTs>=this.coalesceMs?(this._emit(),this._pending=!0,this._pendingFirstTs=n,this._pendingCount=1,this._ensureScheduleEmit()):this._stats.coalesced++):(this._pending=!0,this._pendingFirstTs=n,this._pendingCount=1,this._stats.received>10?setTimeout((()=>this._ensureScheduleEmit()),5):this.subscribers.size>0&&0===this._stats.emits?this._emit():this._ensureScheduleEmit())}_ensureScheduleEmit(){this._pendingRaf||(this._pendingRaf=$c((()=>{this._pendingRaf=0,this._frameEmitCheck()})))}_frameEmitCheck(){if(!this._pending||this._destroyed)return;const e=xc?Date.now():performance.now(),t=e-this._lastEmitTime,n=e-this._pendingFirstTs;let s=!1;if(t>=this.minEmitMs&&n>=this.coalesceMs&&(s=!0),n>=this.maxDelayMs&&(s=!0),s)this._emit();else{const e=Math.max(0,this.minEmitMs-t),s=Math.max(0,this.coalesceMs-n),r=Math.max(0,this.maxDelayMs-n),i=Math.min(e||1/0,s||1/0,r||1/0);i<1/0&&i>0&&setTimeout((()=>{this._ensureScheduleEmit()}),Math.max(1,Math.min(50,i)))}}subscribe(e){if("function"!=typeof e)return console.warn("[MsdDataSource] Subscribe requires a function callback"),()=>{};this.subscribers.add(e);const t=this.buffer.last();if(t)try{const n={t:t.t,v:t.v,buffer:this.buffer,stats:{...this._stats},transformations:this._getTransformationData(),aggregations:this._getAggregationData(),entity:this.cfg.entity,historyReady:this._stats.historyLoaded>0};console.log("[MsdDataSource] Providing immediate hydration for new subscriber:",{entity:this.cfg.entity,value:t.v,bufferSize:this.buffer.size(),timestamp:new Date(t.t).toISOString()}),setTimeout((()=>{e(n)}),0)}catch(e){console.warn("[MsdDataSource] Initial callback error:",e)}else console.log("[MsdDataSource] No data available for immediate hydration:",{entity:this.cfg.entity,bufferSize:this.buffer.size(),started:this._started});return()=>{this.subscribers.delete(e)}}subscribeWithMetadata(e,t={}){return"function"!=typeof e?(console.warn("[MsdDataSource] Subscribe requires a function callback"),()=>{}):(e._subscriberMetadata={overlayId:t.overlayId||"unknown",overlayType:t.overlayType||"unknown",component:t.component||"unknown",subscribedAt:Date.now()},this.subscribe(e))}_toNumber(e){if(console.log("[MSD DEBUG] 📊 _toNumber() converting:",{raw:e,type:typeof e,entity:this.cfg.entity}),null==e)return console.log("[MSD DEBUG] ⚠️ _toNumber() - null/undefined value"),null;if("number"==typeof e){const t=isNaN(e)?null:e;return console.log("[MSD DEBUG] 📊 _toNumber() - numeric:",{raw:e,result:t}),t}if("string"==typeof e){const t=parseFloat(e);if(!isNaN(t)&&isFinite(t))return console.log("[MSD DEBUG] 📊 _toNumber() - string numeric:",{raw:e,num:t}),t;const n=e.toLowerCase().trim();return"on"===n||"true"===n||"active"===n||"open"===n?(console.log("[MSD DEBUG] 📊 _toNumber() - boolean TRUE:",{raw:e,converted:1}),1):"off"===n||"false"===n||"inactive"===n||"closed"===n?(console.log("[MSD DEBUG] 📊 _toNumber() - boolean FALSE:",{raw:e,converted:0}),0):"unavailable"===n||"unknown"===n?(console.log("[MSD DEBUG] 📊 _toNumber() - unavailable state:",{raw:e,converted:null}),null):(console.log("[MSD DEBUG] ⚠️ _toNumber() - unhandled string:",{raw:e}),null)}if("boolean"==typeof e){const t=e?1:0;return console.log("[MSD DEBUG] 📊 _toNumber() - boolean:",{raw:e,result:t}),t}return console.log("[MSD DEBUG] ⚠️ _toNumber() - unsupported type:",{raw:e,type:typeof e}),null}_parseTimeWindowMs(e){if("string"!=typeof e)return NaN;const t=e.match(/^(\d+(?:\.\d+)?)\s*(s|sec|m|min|h|hr|d|day)s?$/i);if(!t)return NaN;const n=parseFloat(t[1]);switch(t[2].toLowerCase()){case"s":case"sec":return 1e3*n;case"m":case"min":return 60*n*1e3;case"h":case"hr":return 60*n*60*1e3;case"d":case"day":return 24*n*60*60*1e3;default:return NaN}}getStats(){return{...this._stats,config:{entity:this.cfg.entity,windowSeconds:this.cfg.windowSeconds,minEmitMs:this.minEmitMs,coalesceMs:this.coalesceMs,maxDelayMs:this.maxDelayMs},buffer:this.buffer.getStats(),subscribers:this.subscribers.size,state:{started:this._started,pending:this._pending,destroyed:this._destroyed}}}getSubscriberInfo(){return Array.from(this.subscribers).map(((e,t)=>{const n=e._subscriberMetadata;if(n)return{id:n.overlayId,name:`${n.overlayType}_${n.overlayId}`,type:n.overlayType,component:n.component,subscribedAt:n.subscribedAt,index:t};const s=e.name||"anonymous",r=e.toString().includes("overlay")||e.toString().includes("callback");return{id:`subscriber_${t}`,name:"anonymous"===s&&r?"overlay_callback":s,type:"function",component:"unknown",index:t}}))}getCurrentData(){const e=this.buffer.last();return e?{t:e.t,v:e.v,buffer:this.buffer,stats:{...this._stats},transformations:this._getTransformationData(),aggregations:this._getAggregationData(),entity:this.cfg.entity,unit_of_measurement:this.cfg.unit_of_measurement,historyReady:this._stats.historyLoaded>0,bufferSize:this.buffer.size(),started:this._started}:{t:null,v:null,buffer:this.buffer,stats:{...this._stats},transformations:this._getTransformationData(),aggregations:this._getAggregationData(),entity:this.cfg.entity,unit_of_measurement:this.cfg.unit_of_measurement,historyReady:this._stats.historyLoaded>0,bufferSize:0,started:this._started}}getEntity(){return this.currentState?{state:this.currentState.state,attributes:this.currentState.attributes||{}}:null}async stop(){if(this._started=!1,this.haUnsubscribe){try{this.haUnsubscribe()}catch(e){console.warn("[MsdDataSource] HA unsubscribe error:",e)}this.haUnsubscribe=null}this._pendingRaf&&(Cc(this._pendingRaf),this._pendingRaf=0),this._pending=!1}destroy(){this._destroyed=!0,this.stop(),this.subscribers.clear(),this.buffer.clear()}_extractStatisticValue(e){return Number.isFinite(e.mean)?e.mean:Number.isFinite(e.state)?e.state:Number.isFinite(e.sum)?e.sum:Number.isFinite(e.max)?e.max:Number.isFinite(e.min)?e.min:null}_applyTransformations(e,t){const n={original:t};return this.transformations.forEach(((s,r)=>{try{n[r]=s.transform(t,e,this.buffer),this._transformationData.set(r,n[r])}catch(e){console.warn(`[MsdDataSource] Transformation ${r} failed:`,e),n[r]=null,this._transformationData.set(r,null)}})),n}_updateAggregations(e,t,n){this.aggregations.forEach(((s,r)=>{try{s.update(e,t,n),this._aggregationData.set(r,s.getValue())}catch(e){console.warn(`[MsdDataSource] Aggregation ${r} failed:`,e),this._aggregationData.set(r,null)}}))}_getTransformationData(){const e={};return this._transformationData.forEach(((t,n)=>{e[n]=t})),e}_getAggregationData(){const e={};return this._aggregationData.forEach(((t,n)=>{e[n]=t})),e}}class Ac{constructor(e){this.hass=e,this.sources=new Map,this.overlaySubscriptions=new Map,this.entityIndex=new Map,this.globalEntityChangeListeners=new Set,this._stats={sourcesCreated:0,subscriptionsActive:0,dataUpdates:0,errors:0},this._destroyed=!1}async initializeFromConfig(e){if(this._destroyed)throw new Error("DataSourceManager has been destroyed");console.log(`[DataSourceManager] 🚀 Initializing ${Object.keys(e||{}).length} data sources`);const t=Object.entries(e||{}).map((async([e,t])=>{try{const n=await this.createDataSource(e,t);return this._stats.sourcesCreated++,n}catch(t){throw console.warn(`[DataSourceManager] Failed to create source ${e}:`,t),this._stats.errors++,t}}));await Promise.all(t),this.sources.size>0&&await this._waitForHistoryPreloading();const n=this.sources.size,s=Object.keys(e||{}).length-n;return console.log(`[DataSourceManager] ✅ Initialization complete: ${n} successful, ${s} failed`),n}async createDataSource(e,t){if(this.sources.has(e))return this.sources.get(e);const n=new Mc(t,this.hass);this.sources.set(e,n),t.entity&&(this.entityIndex.set(t.entity,n),n.subscribe((e=>{this._notifyGlobalEntityChangeListeners([t.entity])})));try{if(await n.start(),t.entity&&this.hass.states&&this.hass.states[t.entity]){const e=this.hass.states[t.entity];n._handleStateChange({entity_id:t.entity,new_state:e,old_state:null})}}catch(n){throw console.warn(`[DataSourceManager] Failed to start source ${e}:`,n),this.sources.delete(e),this.entityIndex.delete(t.entity),this._stats.errors++,n}return n}async _waitForHistoryPreloading(e=1e4){const t=Date.now();for(console.log("[DataSourceManager] ⏳ Waiting for history preloading...");Date.now()-t<e;){let e=!0,n=0,s=0;for(const[t,r]of this.sources)n++,r.getStats().historyLoaded>0||!r.cfg.history?.enabled?s++:e=!1;if(s>0&&console.log(`[DataSourceManager] History loading progress: ${s}/${n} sources ready`),e||0===n){console.log(`[DataSourceManager] ✅ History preloading complete in ${Date.now()-t}ms`);break}await new Promise((e=>setTimeout(e,100)))}}getEntity(e){if(e.includes(".")){const[t,...n]=e.split("."),s=this.sources.get(t);if(s){const t=s.getCurrentData();if(!t)return null;if(n.length>=2){const s=n[0],r=n.slice(1).join(".");if("transformations"===s&&t.transformations){const n=t.transformations[r];if(null!=n)return{state:String(n),attributes:{data_path:e,source_type:"datasource_transformation",raw_value:n}}}else if("aggregations"===s&&t.aggregations){const n=t.aggregations[r];if("object"==typeof n&&null!==n){let t=n.avg??n.value??n.last??n.current;if(null!=t)return{state:String(t),attributes:{data_path:e,source_type:"datasource_aggregation",raw_value:t,aggregation_data:n}}}else if(null!=n)return{state:String(n),attributes:{data_path:e,source_type:"datasource_aggregation",raw_value:n}}}}return{state:t.v?.toString()||"unavailable",attributes:{timestamp:t.t,source_type:"datasource",...t.stats}}}}const t=this.entityIndex.get(e);if(t){const e=t.getCurrentData();if(e)return{state:e.v?.toString()||"unavailable",attributes:{timestamp:e.t,source_type:"datasource"}}}if(this.hass.states&&this.hass.states[e]){const t=this.hass.states[e];return{state:t.state,attributes:t.attributes||{}}}return null}_resolveDataPath(e,t){if(!e||"object"!=typeof e)return null;const n=t.split(".");let s=e;for(let e="aggregations"===n[0]||"transformations"===n[0]?1:0;e<n.length;e++){if(!s||"object"!=typeof s)return null;s=s[n[e]]}return null!=s?{state:s.toString(),attributes:{data_path:t,source_type:"datasource_processed"}}:null}listIds(){return Array.from(this.entityIndex.keys())}addEntityChangeListener(e){return this.globalEntityChangeListeners.add(e),()=>this.globalEntityChangeListeners.delete(e)}_notifyGlobalEntityChangeListeners(e){0!==this.globalEntityChangeListeners.size&&this.globalEntityChangeListeners.forEach((t=>{try{t(e)}catch(e){console.warn("[DataSourceManager] Global entity listener error:",e)}}))}subscribeOverlay(e,t){if(!e.source)return void console.warn("[DataSourceManager] subscribeOverlay: No source specified for overlay",e.id);const n=this.sources.get(e.source);if(!n)return void console.warn("[DataSourceManager] subscribeOverlay: Source not found:",e.source);console.log(`[DataSourceManager] 🔗 Setting up subscription for ${e.id} to ${e.source}`);const s=n.subscribeWithMetadata?.((n=>{const s={...n,sourceId:e.source,overlayId:e.id,overlayType:e.type,buffer:"sparkline"===e.type?n.buffer:void 0,historicalData:"sparkline"===e.type&&n.buffer?n.buffer.getAll().map((e=>({timestamp:e.t,value:e.v}))):void 0};console.log(`[DataSourceManager] 📤 Calling callback for ${e.id}:`,{hasBuffer:!!s.buffer,bufferSize:s.buffer?.size?.()||0,hasHistoricalData:!!s.historicalData,historicalDataLength:s.historicalData?.length||0,currentValue:s.v}),t(e,s)}),{overlayId:e.id,overlayType:e.type,component:"OverlayManager"})||n.subscribe((n=>{const s={...n,sourceId:e.source,overlayId:e.id,overlayType:e.type,buffer:"sparkline"===e.type?n.buffer:void 0,historicalData:"sparkline"===e.type&&n.buffer?n.buffer.getAll().map((e=>({timestamp:e.t,value:e.v}))):void 0};t(e,s)})),r=n.getCurrentData();if(r&&(r.buffer?.size?.()>0||void 0!==r.v)){console.log(`[DataSourceManager] 🔄 Providing immediate data for ${e.id}`);const n={...r,sourceId:e.source,overlayId:e.id,overlayType:e.type,buffer:"sparkline"===e.type?r.buffer:void 0,historicalData:"sparkline"===e.type&&r.buffer?r.buffer.getAll().map((e=>({timestamp:e.t,value:e.v}))):void 0};setTimeout((()=>{t(e,n)}),0)}return this.overlaySubscriptions.has(e.id)||this.overlaySubscriptions.set(e.id,[]),this.overlaySubscriptions.get(e.id).push(s),this._stats.subscriptionsActive++,console.log(`[DataSourceManager] ✅ Subscribed ${e.type} overlay ${e.id} to source ${e.source} (${n.subscribers?.size||0} total subscribers)`),s}unsubscribeOverlay(e){const t=this.overlaySubscriptions.get(e);t&&(t.forEach((t=>{try{t()}catch(t){console.warn(`[DataSourceManager] Error unsubscribing overlay ${e}:`,t),this._stats.errors++}})),this.overlaySubscriptions.delete(e),this._stats.subscriptionsActive--)}getSource(e){return this.sources.get(e)}getAllSources(){return Array.from(this.sources.values())}getDataSource(e){return this._dataSources.get(e)||null}getStats(){const e={};for(const[t,n]of this.sources)e[t]=n.getStats?n.getStats():{error:"No stats available"};return{manager:this._stats,sources:e,summary:{totalSources:this.sources.size,activeSubscriptions:this.overlaySubscriptions.size,entityCount:this.entityIndex.size,destroyed:this._destroyed}}}getSourceSubscribers(e){const t=this.sources.get(e);return t?.getSubscriberInfo?.()||[]}getAllSubscribers(){const e={};return this.sources.forEach(((t,n)=>{e[n]=t.getSubscriberInfo?.()||[]})),e}async destroy(){if(this._destroyed)return;this._destroyed=!0;for(const e of this.overlaySubscriptions.keys())this.unsubscribeOverlay(e);const e=[];for(const[t,n]of this.sources)try{n.stop?e.push(n.stop()):n.destroy&&e.push(n.destroy())}catch(e){console.warn(`[DataSourceManager] Error stopping source ${t}:`,e)}await Promise.all(e),this.sources.clear(),this.overlaySubscriptions.clear(),this.entityIndex.clear(),this.globalEntityChangeListeners.clear()}debugDump(){return{sources:Array.from(this.sources.keys()),subscriptions:Array.from(this.overlaySubscriptions.keys()),entities:Array.from(this.entityIndex.keys()),stats:this.getStats()}}}const kc=Object.create(null);function Dc(e,t=1){kc[e]=(kc[e]||0)+t}function Ec(){return{...kc}}function Tc(e,t){const n=performance.now(),s=t(),r=()=>{const t=performance.now()-n;Dc(e+".samples",1),Dc(e+".totalMs",t),function(e,t){kc[e]=t}(e+".lastMs",t)};return s&&"function"==typeof s.then?s.then((e=>(r(),e))):(r(),s)}class Rc{constructor(e,t,n){this.config=e||{},this.anchors=t||{},this.viewBox=n,this._cache=new Map,this._cacheOrder=[],this._maxCache=256,this._rev=0,this._overlaysRef=null,this._obstacles=[],this._obsVersion=0,this._gridCache=new Map,this._channels=this._normalizeChannels(this.config.channels||[]),this._channelForcePenalty=Number(this.config.channel_force_penalty||800),this._channelAvoidMultiplier=Number(this.config.channel_avoid_multiplier||1),this._channelTargetCoverage=Number(this.config.channel_target_coverage??.6),this._channelShapingMaxAttempts=Number(this.config.channel_shaping_max_attempts??12),this._channelShapingSpan=Number(this.config.channel_shaping_span??32),this._channelMinCoverageGain=Number(this.config.channel_min_coverage_gain??.04)}invalidate(e="*"){if("*"===e)this._cache.clear(),this._cacheOrder.length=0,this._rev++;else for(const t of Array.from(this._cache.keys()))if(t.includes(`@${e}|`)){this._cache.delete(t);const e=this._cacheOrder.indexOf(t);e>=0&&this._cacheOrder.splice(e,1)}Dc("routing.invalidate.events",1)}setOverlays(e){if(!Array.isArray(e))return;if(e===this._overlaysRef)return;this._overlaysRef=e;const t=[];for(const n of e){if(!n||!n.id)continue;const e=n._raw||n.raw||{};if(!0!==e.obstacle&&"ribbon"!==n.type)continue;let s=0,r=0,i=0,o=0;if(Array.isArray(e.position)&&Array.isArray(e.size))[s,r]=e.position,[i,o]=e.size;else{if(!e.anchor||!this.anchors[e.anchor])continue;{const[t,n]=this.anchors[e.anchor];s=t-1,r=n-1,i=2,o=2}}!Number.isFinite(s+r+i+o)||i<=0||o<=0||t.push({id:n.id,x1:s,y1:r,x2:s+i,y2:r+o})}this._obstacles=t,this._obsVersion++,this._gridCache.clear(),this.invalidate("*"),Dc("routing.obstacles.count",t.length)}stats(){return{size:this._cache.size,max:this._maxCache,rev:this._rev,obstacles:this._obstacles.length,obsVersion:this._obsVersion}}buildRouteRequest(e,t,n){const s=e._raw||e.raw||{},r=e.finalStyle||{};let i=(s.route_channel_mode||s.routeChannelMode||s.channel_mode||"prefer").toLowerCase();["prefer","avoid","force"].includes(i)||(Dc&&Dc("routing.channel.mode.invalid",1),i="prefer");let o=(s.smoothing_mode||s.corner_smoothing_mode||r.smoothing_mode||this.config.smoothing_mode||this.config.smoothing&&this.config.smoothing.mode||"none").toLowerCase();if(!["none","chaikin"].includes(o)){try{Dc("routing.smooth.mode.invalid",1)}catch(e){}o="none"}let a=(s.route_mode||"").toLowerCase(),l=(s.route_mode_last||"").toLowerCase(),c=a?"explicit":"auto",d=l?"explicit":null,u=!1;if(s.attach_side?u=!0:"string"==typeof s.attach_to&&s.attach_to&&(this.anchors[s.attach_to]||(u=!0)),!l&&u){const e=(s.attach_side||"").toLowerCase();if("left"===e||"right"===e){l="yx",d="attach_side";try{Dc("routing.hint.attach_side.horizontal",1)}catch(e){}}else if("top"===e||"bottom"===e){l="xy",d="attach_side";try{Dc("routing.hint.attach_side.vertical",1)}catch(e){}}}if(!a){const[e,s]=t,[r,i]=n;a=Number.isFinite(e+s+r+i)?Math.abs(r-e)>=Math.abs(i-s)?"xy":"yx":"xy",c="geometry"}l||(l=a,d||(d=c));const h=Number(s.smoothing_iterations||s.corner_smoothing_iterations||r.smoothing_iterations||this.config.smoothing_iterations||this.config.smoothing&&this.config.smoothing.iterations||0),p=Number(s.smoothing_max_points||r.smoothing_max_points||this.config.smoothing_max_points||this.config.smoothing&&this.config.smoothing.max_points||160);return{id:e.id,a:t,b:n,modeFull:(s.route_mode_full||s.route_mode||"manhattan").toLowerCase(),modeHint:a,modeHintLast:l,_hintSourceFirst:c,_hintSourceLast:d,avoidIds:Array.isArray(s.avoid)?s.avoid.slice():[],channels:s.route_channels||s.routeChannels||[],channelMode:i,cornerRadius:Number(s.corner_radius||s.cornerRadius||r.corner_radius||0),cornerStyle:(s.corner_style||s.cornerStyle||r.corner_style||"miter").toLowerCase(),smoothingMode:o,smoothingIterations:h,smoothingMaxPoints:p,clearance:Number(s.clearance||this.config.clearance||0),proximity:Number(s.smart_proximity||this.config.smart_proximity||0),smart:{detourSpan:Number(this.config.smart_detour_span||48),maxExtraBends:Number(this.config.smart_max_extra_bends||3),minImprovement:Number(this.config.smart_min_improvement||4),maxDetoursPerElbow:Number(this.config.smart_max_detours_per_elbow||4)},_rev:this._rev}}_cacheKey(e){const[t,n]=e.a,[s,r]=e.b,i=e.avoidIds.sort().join(","),o=e.channels.sort().join(",");return`${e.id}@${t},${n}-${s},${r}|${e.modeFull}|${e.modeHint}|A:${i}|C:${o}|${e.channelMode}|R:${e._rev}|O:${this._obsVersion}|P:${e.proximity}|CR:${e.cornerRadius}|CS:${e.cornerStyle}|SM:${e.smoothingMode}|SI:${e.smoothingIterations}`}computePath(e){return Tc("routing.compute.ms",(()=>{const t=this._cacheKey(e),n=this._cache.get(t);if(n)return Dc("routing.cache.hit",1),{...n,meta:{...n.meta,cache_hit:!0}};let s;Dc("routing.cache.miss",1);const r=e.modeFull;try{if("grid"===r)s=this._computeGrid(e);else if("smart"===r){Dc("routing.strategy.smart",1);const t=this._computeGrid(e,{smart:!0});t&&(s=this._refineSmart(e,t))}}catch(e){console.warn("[MSD v1] smart/grid router error; fallback to manhattan",e)}if(s||("smart"===r&&Dc("routing.strategy.smart",1),s=this._computeManhattan(e)),s&&"round"===e.cornerStyle&&e.cornerRadius>0){const t=this._applyCornerRounding(s,e.cornerRadius);t&&(s=t)}if(s&&"none"!==e.smoothingMode&&e.smoothingIterations>0){const t=this._applySmoothing(s,e);t&&(s=t)}if(this._cache.set(t,s),this._cacheOrder.push(t),this._cacheOrder.length>this._maxCache){const e=this._cacheOrder.shift();e&&this._cache.delete(e)}return{...s,meta:{...s.meta,cache_hit:!1}}}))}_computeGrid(e,t={}){Dc("routing.strategy.grid",1);const n=this.viewBox||[0,0,400,200],s=n[2],r=n[3],i=Number(this.config.grid_resolution||64),o=i>4?i:32,a=Math.max(2,Math.ceil(s/o)),l=Math.max(2,Math.ceil(r/o)),c=Math.max(0,e.clearance||this.config.clearance||0),d=`${o}|${this._obsVersion}|${c}`;let u=this._gridCache.get(d);u||(u=this._buildOccupancy(a,l,o,c),this._gridCache.set(d,u));const h=e=>Math.min(a-1,Math.max(0,Math.round(e/o))),p=e=>Math.min(l-1,Math.max(0,Math.round(e/o))),g=e=>e*o,m=e=>e*o,f={c:h(e.a[0]),r:p(e.a[1])},y={c:h(e.b[0]),r:p(e.b[1])},b=new Oc,_=(e,t)=>`${e},${t}`,v=new Map,w=new Map,S=(e,t)=>Math.abs(e-y.c)+Math.abs(t-y.r);v.set(_(f.c,f.r),0),b.push({c:f.c,r:f.r,f:S(f.c,f.r)});const x=(e,t)=>u[t]&&1===u[t][e],$=a*l*4;let C=0,M=!1;for(;!b.isEmpty()&&C++<$;){const e=b.pop();if(e.c===y.c&&e.r===y.r){M=!0;break}const t=v.get(_(e.c,e.r));for(const[n,s]of[[1,0],[-1,0],[0,1],[0,-1]]){const r=e.c+n,i=e.r+s;if(r<0||i<0||r>=a||i>=l)continue;if(x(r,i))continue;const o=_(r,i),c=t+1;if(c<(v.get(o)??1/0)){v.set(o,c),w.set(o,[e.c,e.r]);const t=c+S(r,i);b.push({c:r,r:i,f:t})}}}if(!M)return null;const A=[];let k=y.c,D=y.r;for(;A.push([k,D]),k!==f.c||D!==f.r;){const e=w.get(_(k,D));if(!e)break;[k,D]=e}A.reverse();const E=[];let T=null;for(let e=0;e<A.length;e++){const[t,n]=A[e],s=g(t),r=m(n);if(0===e){E.push([s,r]);continue}const[i,o]=A[e-1],a=[t-i,n-o].join(",");a!==T?(E.push([s,r]),T=a):E[E.length-1]=[s,r]}if(E[0]=[e.a[0],e.a[1]],E[E.length-1]=[e.b[0],e.b[1]],2===E.length){const[t,n]=E[0],[s,r]=E[1];t!==s&&n!==r&&("yx"==("yx"===e.modeHint?"yx":"xy")?E.splice(1,0,[t,r]):E.splice(1,0,[s,n]))}const R=this.config?.cost_defaults?.bend??10,O=this.config?.cost_defaults?.proximity??4,{penalty:F}=this._segmentProximityPenalty(E,e.clearance,e.proximity,O);let N=this._channelDelta(E,e),P=null;if(e.channels?.length&&("prefer"===e.channelMode||"force"===e.channelMode)){const t="force"===e.channelMode?1:this._channelTargetCoverage;if(N.coverage<t){const n=this._shapeForChannels(e,E,N,t);n&&n.accepted?(E=n.pts,N=this._channelDelta(E,e),P=n.meta,Dc("routing.channel.shape.accept",1)):n&&(P=n.meta)}}const L=this._costComposite(E,R,O,F,N.delta);return{d:this._polylineToPath(E),pts:E,meta:{strategy:t.smart?"grid-smart-preface":"grid",cost:L,segments:E.length-1,bends:Math.max(0,E.length-2),grid:{resolution:o,iterations:C},...e.channels?.length?{channel:{mode:N.mode,insidePx:N.inside,outsidePx:N.outside,coveragePct:Number((100*N.coverage).toFixed(1)),deltaCost:N.delta,forcedOutside:N.forcedOutside,...P?{shaping:P}:{}}}:{}}}}_buildOccupancy(e,t,n,s){const r=Array.from({length:t},(()=>new Uint8Array(e)));if(!this._obstacles.length)return r;for(const i of this._obstacles){const o=i.x1-s,a=i.y1-s,l=i.x2+s,c=i.y2+s,d=Math.max(0,Math.floor(o/n)),u=Math.max(0,Math.floor(a/n)),h=Math.min(e-1,Math.ceil(l/n)),p=Math.min(t-1,Math.ceil(c/n));for(let e=u;e<=p;e++){const t=r[e];for(let e=d;e<=h;e++)t[e]=1}}return r}_computeManhattan(e){const[t,n]=e.a,[s,r]=e.b,i=(e.modeHint,"yx"===e.modeHintLast?"yx":"xy");let o;return o=t===s||n===r?[[t,n],[s,r]]:"xy"===i?[[t,n],[s,n],[s,r]]:[[t,n],[t,r],[s,r]],{d:this._polylineToPath(o),pts:o,meta:{strategy:"manhattan-basic",cost:this._costSimple(o),segments:o.length-1,bends:Math.max(0,o.length-2),hint:{first:e.modeHint,last:e.modeHintLast,sourceFirst:e._hintSourceFirst,sourceLast:e._hintSourceLast}}}}_polylineToPath(e){if(!e.length)return"";let t=`M${e[0][0]},${e[0][1]}`;for(let n=1;n<e.length;n++)t+=` L${e[n][0]},${e[n][1]}`;return t}_costSimple(e){let t=0;for(let n=1;n<e.length;n++){const s=e[n][0]-e[n-1][0],r=e[n][1]-e[n-1][1];t+=Math.abs(s)+Math.abs(r)}return t+Math.max(0,e.length-2)*(this.config?.cost_defaults?.bend??10)}_costComposite(e,t,n,s,r=0){let i=0;for(let t=1;t<e.length;t++)i+=Math.abs(e[t][0]-e[t-1][0])+Math.abs(e[t][1]-e[t-1][1]);return i+Math.max(0,e.length-2)*t+s*n+r}_segmentProximityPenalty(e,t,n,s){if(!n||!this._obstacles.length)return{penalty:0,detail:[]};const r=t+n;let i=0;const o=[];for(let t=1;t<e.length;t++){const n=e[t-1],s=e[t],a=this._nearestObstacleBandOverlap(n,s,r);a>0&&(i+=a,o.push({i:t,segPenalty:a}))}return{penalty:i,detail:o}}_nearestObstacleBandOverlap(e,t,n){const s=e[0]===t[0],r=Math.min(e[0],t[0]),i=Math.max(e[0],t[0]),o=Math.min(e[1],t[1]),a=Math.max(e[1],t[1]);let l=0;for(const t of this._obstacles){if(i<t.x1-n||r>t.x2+n||a<t.y1-n||o>t.y2+n)continue;let c;if(c=s?e[0]<t.x1?t.x1-e[0]:e[0]>t.x2?e[0]-t.x2:0:e[1]<t.y1?t.y1-e[1]:e[1]>t.y2?e[1]-t.y2:0,c<n){const e=n-c;e>l&&(l=e)}}return l}_normalizeChannels(e){return Array.isArray(e)?e.filter((e=>e&&Array.isArray(e.rect)&&4===e.rect.length)).map((e=>{const[t,n,s,r]=e.rect;return{id:e.id||`chan_${t}_${n}`,x1:t,y1:n,x2:t+s,y2:n+r,weight:Number(e.weight||e.w||.5)}})):[]}_channelDelta(e,t){if(!this._channels.length||!t.channels||!t.channels.length)return{delta:0,inside:0,outside:0,coverage:0,forcedOutside:!1,mode:t.channelMode};const n=new Set(t.channels),s=this._channels.filter((e=>n.has(e.id)));if(!s.length)return{delta:0,inside:0,outside:0,coverage:0,forcedOutside:!1};let r=0,i=0;for(let t=1;t<e.length;t++){const n=e[t-1],o=e[t],a=Math.abs(n[0]-o[0])+Math.abs(n[1]-o[1]);if(0===a)continue;const l=(n[0]+o[0])/2,c=(n[1]+o[1])/2,d=s.some((e=>l>=e.x1&&l<=e.x2&&c>=e.y1&&c<=e.y2));d?r+=a:i+=a}const o=r/(r+i||1);let a=0;const l=(t.channelMode||"prefer").toLowerCase();let c=!1;if("prefer"===l){const e=s.reduce(((e,t)=>e+t.weight),0)/s.length;a-=r*e}else if("avoid"===l){const e=s.reduce(((e,t)=>e+t.weight),0)/s.length;a+=r*e*this._channelAvoidMultiplier}else if("force"===l)if(i>0)c=!0,a+=this._channelForcePenalty;else{const e=s.reduce(((e,t)=>e+t.weight),0)/s.length;a-=r*e}return 0!==a&&Dc("routing.channel.applied",1),c&&Dc("routing.channel.force.penalty",1),{delta:a,inside:r,outside:i,coverage:o,forcedOutside:c,mode:t.channelMode}}_refineSmart(e,t){if(!t||!Array.isArray(t.pts)||t.pts.length<2)return t;const n=this.config?.cost_defaults?.bend??10,s=this.config?.cost_defaults?.proximity??4,{penalty:r}=this._segmentProximityPenalty(t.pts,e.clearance,e.proximity,s);let i=t.pts.slice(),o=r,a=this._costComposite(i,n,s,o),l=0,c=0;if(e.proximity>0&&i.length>2){const t=e.smart.detourSpan,r=e.smart.maxExtraBends,d=e.smart.min_improvement;for(let u=1;u<i.length-1;u++){const h=i[u],p=i[u-1],g=i[u+1],m=p[0]===h[0],f=h[1]===g[1];if(m&&f||!m&&!f){const p=[];p.push([h[0]+t,h[1]]),p.push([h[0]-t,h[1]]),p.push([h[0],h[1]+t]),p.push([h[0],h[1]-t]);let g=0;for(const t of p){if(g++>=e.smart.maxDetoursPerElbow)break;l++;const h=i.slice();h[u]=t;const p=this._compactPolyline(h);if(p.length-i.length>r)continue;const{penalty:m}=this._segmentProximityPenalty(p,e.clearance,e.proximity,s),f=this._costComposite(p,n,s,m);f+d<=a&&(a=f,i=p,o=m,c++)}}}}const d=this._channelDelta(i,e);let u=null;if(e.channels?.length&&("prefer"===e.channelMode||"force"===e.channelMode)){const t="force"===e.channelMode?1:this._channelTargetCoverage;if(d.coverage<t){const r=this._shapeForChannels(e,i,d,t);if(r&&r.accepted){i=r.pts;const t=this._channelDelta(i,e),{penalty:l}=this._segmentProximityPenalty(i,e.clearance,e.proximity,s);o=l,u=r.meta,a=this._costComposite(i,n,s,o,t.delta),d.inside=t.inside,d.outside=t.outside,d.coverage=t.coverage,d.delta=t.delta,d.forcedOutside=t.forcedOutside,Dc("routing.channel.shape.accept",1)}else r&&(u=r.meta)}}a=this._costComposite(i,n,s,o,d.delta);const h=this._polylineToPath(i),p=t.meta||{};return p.strategy="smart",p.cost=a,p.bends=Math.max(0,i.length-2),p.segments=i.length-1,p.smart={penaltyBefore:r,penaltyAfter:o,detoursTried:l,detoursAccepted:c},e.channels?.length&&(p.channel={mode:d.mode,insidePx:d.inside,outsidePx:d.outside,coveragePct:Number((100*d.coverage).toFixed(1)),deltaCost:d.delta,forcedOutside:d.forcedOutside,...u?{shaping:u}:{}}),Dc("routing.smart.refine.attempt",l),Dc("routing.smart.refine.accept",c),{d:h,pts:i,meta:p}}_compactPolyline(e){if(e.length<=2)return e;const t=[e[0]];for(let n=1;n<e.length-1;n++){const s=t[t.length-1],r=e[n],i=e[n+1];s[0]===r[0]&&r[0]===i[0]||s[1]===r[1]&&r[1]===i[1]||t.push(r)}return t.push(e[e.length-1]),t}_shapeForChannels(e,t,n,s){Dc("routing.channel.shape.attempt",1);const r=this._channelShapingMaxAttempts,i=this._channelShapingSpan,o=this._channelMinCoverageGain,a=new Set(e.channels),l=this._channels.filter((e=>a.has(e.id)));if(!l.length)return null;const c=n.coverage;let d=t.slice(),u=c,h=!1,p=0,g=[Number(c.toFixed(4))];const m="force"===e.channelMode;function f(e,t){return[(e[0]+t[0])/2,(e[1]+t[1])/2]}const y=(e,t)=>l.some((n=>e>=n.x1&&e<=n.x2&&t>=n.y1&&t<=n.y2)),b=()=>{const e=[];for(let t=1;t<d.length;t++){const n=d[t-1],s=d[t],r=Math.abs(n[0]-s[0])+Math.abs(n[1]-s[1]);if(!r)continue;const[i,o]=f(n,s);y(i,o)||e.push({i:t,len:r,a:n,b:s,mx:i,my:o})}return e.sort(((e,t)=>t.len-e.len))};for(;p<r;){p++;const t=b();if(!t.length)break;const n=t[0],r=[];n.i-1>0&&r.push(n.i-1),n.i<d.length-1&&r.push(n.i);let a=!1;for(const t of r){const n=d.map((e=>e.slice())),r=n[t];let c=null,h=1/0;if(l.forEach((e=>{const t=r[0]<e.x1?e.x1-r[0]:r[0]>e.x2?e.x2-r[0]:0,n=r[1]<e.y1?e.y1-r[1]:r[1]>e.y2?e.y2-r[1]:0;if(0!==t&&0!==n)Math.abs(t)<Math.abs(n)?Math.abs(t)<h&&(h=Math.abs(t),c=[t,0]):Math.abs(n)<h&&(h=Math.abs(n),c=[0,n]);else if(0!==t||0!==n){const e=Math.abs(t||n);e<h&&(h=e,c=[t,n])}})),!c)continue;const p=[0===c[0]?0:Math.sign(c[0])*Math.min(Math.abs(c[0]),i),0===c[1]?0:Math.sign(c[1])*Math.min(Math.abs(c[1]),i)];n[t]=[r[0]+p[0],r[1]+p[1]];const f=this._compactPolyline(n),y=this._channelDelta(f,e);if(y.coverage-u>=o){if(d=f,u=y.coverage,g.push(Number(u.toFixed(4))),a=!0,m&&u>=.999)break;if(!m&&u>=s)break}}if(!a)break;if(m&&u>=.999||!m&&u>=s){h=!0;break}}let _=!1;return m&&u<.999&&(_=!0,Dc("routing.channel.shape.downgrade",1)),{accepted:h,pts:d,meta:{attempts:p,coverageBefore:Number(c.toFixed(4)),coverageAfter:Number(u.toFixed(4)),coverageHistory:g,accepted:h,downgraded:_}}}_applyCornerRounding(e,t){const n=e.pts;if(!Array.isArray(n)||n.length<3)return Dc("routing.arc.none",1),null;let s=0,r=0;const i=[];let o=n[0].slice();i.push(`M${o[0]},${o[1]}`);for(let e=1;e<n.length-1;e++){const a=n[e-1],l=n[e],c=n[e+1],d=[l[0]-a[0],l[1]-a[1]],u=[c[0]-l[0],c[1]-l[1]];if(0!==d[0]&&0!==d[1]||0!==u[0]&&0!==u[1]||0===d[0]&&0===d[1]||0===u[0]&&0===u[1]||Math.sign(d[0])===Math.sign(u[0])&&0!==d[0]||Math.sign(d[1])===Math.sign(u[1])&&0!==d[1]){l[0]===o[0]&&l[1]===o[1]||(i.push(`L${l[0]},${l[1]}`),o=l.slice());continue}const h=Math.abs(d[0])+Math.abs(d[1]),p=Math.abs(u[0])+Math.abs(u[1]);let g=Math.min(t,h/2,p/2);if(g<1){l[0]===o[0]&&l[1]===o[1]||(i.push(`L${l[0]},${l[1]}`),o=l.slice());continue}let m=l.slice();0!==d[0]?m[0]=l[0]-Math.sign(d[0])*g:m[1]=l[1]-Math.sign(d[1])*g;let f=l.slice();0!==u[0]?f[0]=l[0]+Math.sign(u[0])*g:f[1]=l[1]+Math.sign(u[1])*g,m[0]===o[0]&&m[1]===o[1]||i.push(`L${m[0]},${m[1]}`);const y=d[0]*u[1]-d[1]*u[0]<0?0:1;i.push(`A${g},${g} 0 0 ${y} ${f[0]},${f[1]}`),r+=2*g,s++,o=f}const a=n[n.length-1];return a[0]===o[0]&&a[1]===o[1]||i.push(`L${a[0]},${a[1]}`),s?(Dc("routing.arc.apply",1),{...e,d:i.join(" "),meta:{...e.meta,arc:{count:s,trimPx:Math.round(r)}}}):(Dc("routing.arc.none",1),null)}_applySmoothing(e,t){const n=t.smoothingMode;if("none"===n||t.smoothingIterations<=0)return null;let s=Math.min(5,Math.max(1,0|t.smoothingIterations));if(!Array.isArray(e.pts)||e.pts.length<3)return null;if("chaikin"!==n)return null;let r=e.pts.map((e=>[e[0],e[1]]));for(let e=0;e<s;e++){const e=[r[0]];for(let n=0;n<r.length-1;n++){const s=r[n],i=r[n+1],o=[.75*s[0]+.25*i[0],.75*s[1]+.25*i[1]],a=[.25*s[0]+.75*i[0],.25*s[1]+.75*i[1]];if(e.push(o,a),e.length>=t.smoothingMaxPoints)break}if(e.push(r[r.length-1]),r=e,r.length>=t.smoothingMaxPoints)break}const i=r.reduce(((e,t,n)=>e+(n?` L${t[0]},${t[1]}`:`M${t[0]},${t[1]}`)),""),o={...e.meta,smooth:{mode:n,iterations:s,points:r.length,addedPoints:r.length-e.pts.length}};return Dc("routing.smooth.apply",1),{...e,d:i,pts:r,meta:o}}}class Oc{constructor(){this.a=[]}push(e){this.a.push(e),this._up(this.a.length-1)}pop(){if(!this.a.length)return null;const e=this.a[0],t=this.a.pop();return this.a.length&&(this.a[0]=t,this._down(0)),e}isEmpty(){return 0===this.a.length}_up(e){for(;e>0;){const t=e-1>>1;if(this.a[t].f<=this.a[e].f)break;[this.a[t],this.a[e]]=[this.a[e],this.a[t]],e=t}}_down(e){const t=this.a.length;for(;;){let n=2*e+1,s=n+1,r=e;if(n<t&&this.a[n].f<this.a[r].f&&(r=n),s<t&&this.a[s].f<this.a[r].f&&(r=s),r===e)break;[this.a[r],this.a[e]]=[this.a[e],this.a[r]],e=r}}}function Fc(e){return function(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return Math.abs(t).toString(36)}(Pc(Nc(e)))}function Nc(e){if(null==e)return null;if("object"!=typeof e)return e;if(Array.isArray(e))return e.map(Nc);const t={};return Object.keys(e).sort().forEach((n=>{t[n]=Nc(e[n])})),t}function Pc(e){if("object"!=typeof e||null===e)return JSON.stringify(e);if(Array.isArray(e))return"["+e.map(Pc).join(",")+"]";const t=Object.keys(e).sort().map((t=>`"${t}":${Pc(e[t])}`));return"{"+t.join(",")+"}"}class Lc{constructor(){this.cache=new Map,this.instanceToHash=new WeakMap,this.usageStats=new Map,this.maxCacheSize=500,this.cleanupThreshold=600,this.perfStats={cacheHits:0,cacheMisses:0,instancesCreated:0,instancesReused:0,cleanupRuns:0}}getOrCreateInstance(e,t){return Dl("animation.getInstance",(()=>{const n=this.computeInstanceHash(e);if(this.cache.has(n)){const e=this.cache.get(n);if(this.targetsCompatible(e.targets,t))return this.recordCacheHit(n),Tl("animation.instance.reuse",1),this.perfStats.instancesReused++,this.reuseInstance(e,t);this.cache.delete(n),this.perfStats.cacheMisses++}const s=this.createAnimationInstance(e,t);return this.cacheInstance(n,s,e),Tl("animation.instance.new",1),this.perfStats.instancesCreated++,this.perfStats.cacheMisses++,s}))}computeInstanceHash(e){const t={preset:e.preset,params:this.normalizeParams(e.params),duration:this.normalizeNumber(e.duration),easing:e.easing,loop:e.loop,alternate:e.alternate,delay:this.normalizeNumber(e.delay)};return e.animation_ref&&(t.animation_ref=e.animation_ref,e.override&&(t.override=this.normalizeParams(e.override.params))),Fc(t)}normalizeNumber(e){return"number"==typeof e?Math.round(1e3*e)/1e3:e}normalizeParams(e){if(!e||"object"!=typeof e)return e;const t={};return Object.entries(e).forEach((([e,n])=>{"number"==typeof n?t[e]=Math.round(1e3*n)/1e3:Array.isArray(n)?t[e]=n.map((e=>"number"==typeof e?Math.round(1e3*e)/1e3:e)):t[e]="object"==typeof n&&null!==n?this.normalizeParams(n):n})),t}targetsCompatible(e,t){if(!e||!t)return!1;const n=Array.isArray(e)?e:[e],s=Array.isArray(t)?t:[t];if(n.length!==s.length)return!1;for(let e=0;e<n.length;e++){const t=n[e],r=s[e];if("string"!=typeof t||"string"!=typeof r){if(!t?.id||!r?.id)return!1;if(t.id!==r.id)return!1}else if(t!==r)return!1}return!0}createAnimationInstance(e,t){try{return"undefined"!=typeof window&&window.cblcars?.anim?.create?window.cblcars.anim.create(e,t):{definition:{...e},targets:Array.isArray(t)?[...t]:[t],id:`anim_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,play:()=>{},pause:()=>{},stop:()=>{},restart:()=>{}}}catch(e){return console.warn("[AnimationRegistry] Failed to create animation instance:",e),null}}reuseInstance(e,t){try{return e.retarget&&"function"==typeof e.retarget?e.retarget(t):{...e,targets:Array.isArray(t)?[...t]:[t],id:`${e.id}_reused_${Date.now()}`}}catch(n){return console.warn("[AnimationRegistry] Failed to reuse animation instance:",n),this.createAnimationInstance(e.definition,t)}}cacheInstance(e,t,n){this.cache.set(e,{instance:t,definition:n,targets:t.targets,createdAt:Date.now(),hash:e}),this.usageStats.set(e,{count:1,lastUsed:Date.now(),hash:e}),this.instanceToHash.set(t,e),this.cache.size>this.maxCacheSize&&this.cleanupCache()}recordCacheHit(e){const t=this.usageStats.get(e);t&&(t.count++,t.lastUsed=Date.now()),this.perfStats.cacheHits++}cleanupCache(){Dl("animation.cache.cleanup",(()=>{const e=Array.from(this.usageStats.entries());e.sort((([,e],[,t])=>e.lastUsed-t.lastUsed));const t=e.slice(0,e.length-this.maxCacheSize);t.forEach((([e])=>{this.cache.delete(e),this.usageStats.delete(e)})),this.perfStats.cleanupRuns++,Tl("animation.cache.cleanup",t.length)}))}getStats(){const e={...this.perfStats};return e.cacheSize=this.cache.size,e.hitRate=e.cacheHits/(e.cacheHits+e.cacheMisses)||0,e.reuseRate=e.instancesReused/(e.instancesReused+e.instancesCreated)||0,e}getCacheContents(){const e={};return this.cache.forEach(((t,n)=>{const s=this.usageStats.get(n);e[n]={definition:t.definition,createdAt:t.createdAt,usage:s?{count:s.count,lastUsed:s.lastUsed}:null}})),e}clear(){this.cache.clear(),this.usageStats.clear(),this.perfStats={cacheHits:0,cacheMisses:0,instancesCreated:0,instancesReused:0,cleanupRuns:0},Tl("animation.cache.cleared",1)}exportStats(e={}){const t=this.getStats();return e.includeCache&&(t.cacheContents=this.getCacheContents()),"csv"===e.format?this.exportToCsv(t):JSON.stringify(t,null,2)}exportToCsv(e){return["metric,value",`cacheHits,${e.cacheHits}`,`cacheMisses,${e.cacheMisses}`,`instancesCreated,${e.instancesCreated}`,`instancesReused,${e.instancesReused}`,`cacheSize,${e.cacheSize}`,`hitRate,${e.hitRate.toFixed(3)}`,`reuseRate,${e.reuseRate.toFixed(3)}`,`cleanupRuns,${e.cleanupRuns}`].join("\n")}}const zc=new Lc,Bc="undefined"!=typeof window?window:n.g;Bc&&(Bc.__msdAnimRegistry={registry:zc,getStats:()=>zc.getStats(),getCacheContents:()=>zc.getCacheContents(),clear:()=>zc.clear(),export:e=>zc.exportStats(e)});const Ic=new class{constructor(e=1e3){this.buffer=[],this.maxSize=e,this.index=0,this.totalTraces=0}addTrace(e,t,n,s,r={}){const i={ruleId:e,matched:t,conditions:n,evaluationTime:s,timestamp:Date.now(),metadata:{...r}};this.buffer.length<this.maxSize?this.buffer.push(i):(this.buffer[this.index]=i,this.index=(this.index+1)%this.maxSize),this.totalTraces++}getRecentTraces(e=50,t={}){const n=[];let s=this.index-1;for(let r=0;r<Math.min(e,this.buffer.length);r++){s<0&&(s=this.buffer.length-1);const e=this.buffer[s];this.matchesFilter(e,t)&&n.unshift(e),s--}return n}getRuleHistory(e,t=20){return this.getRecentTraces(this.buffer.length,{ruleId:e}).slice(0,t)}getMatchedRules(e=6e4,t=100){const n=Date.now()-e;return this.getRecentTraces(this.buffer.length,{matched:!0}).filter((e=>e.timestamp>n)).slice(0,t)}getStats(){const e=this.getRecentTraces(this.buffer.length),t=e.filter((e=>e.matched)).length,n=e.length>0?e.reduce(((e,t)=>e+t.evaluationTime),0)/e.length:0;return{totalTraces:this.totalTraces,bufferedTraces:this.buffer.length,recentMatched:t,recentTotal:e.length,matchRate:e.length>0?t/e.length:0,avgEvaluationTime:n}}matchesFilter(e,t){return!(t.ruleId&&e.ruleId!==t.ruleId||void 0!==t.matched&&e.matched!==t.matched||t.minTime&&e.timestamp<t.minTime||t.maxTime&&e.timestamp>t.maxTime||t.minEvalTime&&e.evaluationTime<t.minEvalTime)}clear(){this.buffer=[],this.index=0,this.totalTraces=0}exportTraces(e={}){const{format:t="json",limit:n=100,includeConditions:s=!0,includeMetadata:r=!1}=e,i=this.getRecentTraces(n).map((e=>{const t={ruleId:e.ruleId,matched:e.matched,evaluationTime:e.evaluationTime,timestamp:e.timestamp};return s&&(t.conditions=e.conditions),r&&(t.metadata=e.metadata),t}));return"csv"===t?this.exportToCsv(i):JSON.stringify(i,null,2)}exportToCsv(e){if(0===e.length)return"No traces available\n";const t=e.map((e=>[e.ruleId,e.matched,e.evaluationTime.toFixed(3),new Date(e.timestamp).toISOString()]));return[["ruleId","matched","evaluationTime","timestamp"].join(","),...t.map((e=>e.join(",")))].join("\n")}},jc="undefined"!=typeof window?window:n.g;jc&&(jc.__msdRuleTrace={buffer:Ic,getRecent:e=>Ic.getRecentTraces(e),getStats:()=>Ic.getStats(),getRuleHistory:e=>Ic.getRuleHistory(e),export:e=>Ic.exportTraces(e),clear:()=>Ic.clear()});class Hc{constructor(e=[],t=null){this.rules=Array.isArray(e)?e:[],this.rulesById=new Map,this.dependencyIndex=null,this.dirtyRules=new Set,this.lastEvaluation=new Map,this.traceBuffer=Ic,this.stopProcessing=new Map,this.dataSourceManager=t,this.evalCounts={total:0,dirty:0,matched:0,skipped:0},this.buildRulesIndex(),this.buildDependencyIndex(),this.markAllDirty()}buildRulesIndex(){this.rulesById.clear(),this.rules.forEach((e=>{e.id&&this.rulesById.set(e.id,e)}))}buildDependencyIndex(){const e=new Map,t=new Map;this.rules.forEach((n=>{const s=this.extractEntityReferences(n);t.set(n.id,s),s.forEach((t=>{e.has(t)||e.set(t,new Set),e.get(t).add(n.id)}))})),this.dependencyIndex={entityToRules:e,ruleToEntities:t};try{const s="undefined"!=typeof window?window:n.g;s.__msdDebug&&(s.__msdDebug.rulesDeps={entityToRules:Object.fromEntries(e),ruleToEntities:Object.fromEntries(t),totalEntities:e.size,totalRules:this.rules.length})}catch(e){}}extractEntityReferences(e){const t=new Set;return e.when?([...e.when.all||[],...e.when.any||[]].forEach((e=>{if(e.entity)if(e.entity.includes(".")&&this.dataSourceManager){const n=e.entity.split(".")[0];this.dataSourceManager.getSource(n)?(t.add(n),t.add(e.entity)):t.add(e.entity)}else t.add(e.entity);if(e.entity_attr){const n=e.entity_attr.split(".")[0];t.add(n)}e.map_range_cond?.entity&&t.add(e.map_range_cond.entity),e.value_map?.entity&&t.add(e.value_map.entity)})),Array.from(t)):Array.from(t)}markEntitiesDirty(e){Array.isArray(e)||(e=[e]);let t=0;return e.forEach((e=>{const n=this.dependencyIndex.entityToRules.get(e);if(n&&n.forEach((e=>{this.dirtyRules.has(e)||(this.dirtyRules.add(e),t++)})),this.dataSourceManager?.getSource(e))for(const[n,s]of this.dependencyIndex.entityToRules)n.startsWith(`${e}.`)&&s.forEach((e=>{this.dirtyRules.has(e)||(this.dirtyRules.add(e),t++)}))})),Tl("rules.dirty.entities",e.length),Tl("rules.dirty.affected",t),t}markAllDirty(){this.dirtyRules.clear(),this.rules.forEach((e=>{e.id&&this.dirtyRules.add(e.id)})),Tl("rules.dirty.all",this.dirtyRules.size)}evaluateDirty(e={}){return Dl("rules.evaluate",(()=>{let{getEntity:t}=e;if(!t&&this.dataSourceManager&&(t=e=>{if(e.includes(".")&&this.dataSourceManager){const t=this.resolveDataSourceValue(e);if(null!==t)return{entity_id:e,state:String(t),attributes:{}}}if(this.dataSourceManager.getEntity){const t=this.dataSourceManager.getEntity(e);if(t)return t}if(this.dataSourceManager.entityIndex){const t=this.dataSourceManager.entityIndex.get(e);if(t)return t}return null}),!t||"function"!=typeof t)return console.warn("[RulesEngine] evaluateDirty called without getEntity function and no DataSourceManager available"),this.createEmptyResult();const n=this.dirtyRules.size,s=[],r=new Set,i=Array.from(this.dirtyRules).map((e=>this.rulesById.get(e))).filter((e=>e)).sort(((e,t)=>(t.priority||0)-(e.priority||0)));return i.forEach((e=>{if(r.has(e.id))return;const n=this.evaluateRule(e,t);r.add(e.id),this.lastEvaluation.set(e.id,{matched:n.matched,timestamp:Date.now(),conditions:n.conditions}),n.matched&&(s.push(n),this.evalCounts.matched++),this.dirtyRules.delete(e.id)})),this.evalCounts.total+=n,this.evalCounts.dirty+=n,this.evalCounts.skipped+=this.rules.length-n,Tl("rules.eval.total",n),Tl("rules.eval.matched",s.length),Tl("rules.eval.skipped",this.rules.length-n),this.aggregateResults(s)}))}evaluateRule(e,t){const n=performance.now();try{const s=this.evaluateConditions(e.when,t),r=this.determineMatch(e.when,s),i=performance.now()-n,o={ruleId:e.id,priority:e.priority||0,matched:r,conditions:s,rule:e,evaluationTime:i};return this.traceBuffer.addTrace(e.id,r,s,i,{priority:e.priority||0,conditionCount:this.countConditions(e.when),entityRefs:this.dependencyIndex?.ruleToEntities.get(e.id)||[]}),r&&e.apply&&(o.overlayPatches=e.apply.overlays||[],o.profilesAdd=e.apply.profiles_add||[],o.profilesRemove=e.apply.profiles_remove||[],o.animations=e.apply.animations||[],o.stopAfter=!0===e.stop),o}catch(t){const s=performance.now()-n;return this.traceBuffer.addTrace(e.id,!1,{},s,{error:t.message}),console.warn(`[RulesEngine] Error evaluating rule ${e.id}:`,t),{ruleId:e.id,matched:!1,error:t.message,evaluationTime:s}}}evaluateConditions(e,t){if(!e)return{};const n={};return e.all&&(n.all=e.all.map((e=>this.evaluateCondition(e,t)))),e.any&&(n.any=e.any.map((e=>this.evaluateCondition(e,t)))),n}evaluateCondition(e,t){const n={condition:e,matched:!1,value:null,error:null};try{if(e.entity){if(e.entity.includes(".")&&this.dataSourceManager){const t=this.resolveDataSourceValue(e.entity);if(null===t)return n.error=`DataSource ${e.entity} not found or no data`,n;if(n.value=t,void 0!==e.above){const s=parseFloat(t);n.matched=!isNaN(s)&&s>e.above}else if(void 0!==e.below){const s=parseFloat(t);n.matched=!isNaN(s)&&s<e.below}else void 0!==e.equals?n.matched=t==e.equals:n.matched=!0;return n}{const s=t(e.entity);if(!s)return n.error=`Entity ${e.entity} not found`,n;if(n.value=s.state,void 0!==e.above){const t=parseFloat(s.state);n.matched=!isNaN(t)&&t>e.above}else if(void 0!==e.below){const t=parseFloat(s.state);n.matched=!isNaN(t)&&t<e.below}else void 0!==e.equals?n.matched=s.state==e.equals:n.matched=!0}}e.time_between&&(n.matched=this.evaluateTimeBetween(e.time_between),n.value=(new Date).toTimeString().substring(0,5)),e.map_range_cond&&(n.matched=this.evaluateMapRangeCondition(e.map_range_cond,t))}catch(e){n.error=e.message}return n}evaluateTimeBetween(e){const[t,n]=e.split("-"),s=new Date,r=60*s.getHours()+s.getMinutes(),[i,o]=t.split(":").map(Number),[a,l]=n.split(":").map(Number),c=60*i+o,d=60*a+l;return c<=d?r>=c&&r<=d:r>=c||r<=d}evaluateMapRangeCondition(e,t){const{entity:n,input:s,output:r,above:i,below:o,equals:a}=e,l=t(n);if(!l)return!1;const c=parseFloat(l.state);if(isNaN(c))return!1;const d=this.mapRange(c,s,r);return void 0!==i?d>i:void 0!==o?d<o:void 0!==a&&Math.abs(d-a)<.001}mapRange(e,t,n){const[s,r]=t,[i,o]=n;return i+(Math.max(s,Math.min(r,e))-s)/(r-s)*(o-i)}resolveDataSourceValue(e){try{const t=e.split("."),n=t[0],s=this.dataSourceManager.getSource(n);if(!s)return null;const r=s.getCurrentData();if(!r)return null;if(1===t.length)return r.v;if(t.length>=3){const e=t[1],n=t.slice(2).join(".");if("transformations"===e&&r.transformations)return r.transformations[n];if("aggregations"===e&&r.aggregations){const e=r.aggregations[n];return"object"==typeof e&&null!==e?void 0!==e.avg?e.avg:void 0!==e.value?e.value:void 0!==e.last?e.last:void 0!==e.current?e.current:e:e}}return null}catch(t){return console.warn(`[RulesEngine] Error resolving DataSource reference '${e}':`,t),null}}determineMatch(e,t){if(!e)return!1;let n=!0,s=!1;return e.all&&t.all&&(n=t.all.every((e=>e.matched))),e.any&&t.any&&(s=t.any.some((e=>e.matched))),e.all&&e.any?n&&s:e.all?n:!!e.any&&s}aggregateResults(e){const t={overlayPatches:[],profilesAdd:[],profilesRemove:[],animations:[]},n=new Map;return e.forEach((e=>{e.overlayPatches&&e.overlayPatches.forEach((t=>{n.has(t.id)||n.set(t.id,[]),n.get(t.id).push({...e,overlayPatch:t})}))})),n.forEach(((e,n)=>{this.processOverlayRules(n,e,t)})),e.sort(((e,t)=>(t.priority||0)-(e.priority||0))).forEach((e=>{e.profilesAdd&&t.profilesAdd.push(...e.profilesAdd),e.profilesRemove&&t.profilesRemove.push(...e.profilesRemove),e.animations&&t.animations.push(...e.animations)})),t}processOverlayRules(e,t,n){const s=t.sort(((e,t)=>(t.priority||0)-(e.priority||0)));let r=!1;s.forEach((t=>{if(r)return this.traceBuffer.addTrace(t.ruleId,t.matched,t.conditions,t.evaluationTime,{stopped:!0,stoppedBy:e,reason:"stop_semantics"}),void Tl("rules.stopped",1);t.overlayPatch&&n.overlayPatches.push(t.overlayPatch),t.stopAfter&&(r=!0,Tl("rules.stop.triggered",1),this.traceBuffer.addTrace(t.ruleId,t.matched,t.conditions,t.evaluationTime,{stopTriggered:!0,affectedOverlay:e}))}))}countConditions(e){return e?(e.all?.length||0)+(e.any?.length||0):0}createEmptyResult(){return{overlayPatches:[],profilesAdd:[],profilesRemove:[],animations:[]}}getTrace(){const e={totalRules:this.rules.length,dirtyRules:this.dirtyRules.size,lastEvaluations:Object.fromEntries(this.lastEvaluation),evalCounts:{...this.evalCounts},dependencyStats:{entitiesTracked:this.dependencyIndex?.entityToRules.size||0,avgRulesPerEntity:this.dependencyIndex?Array.from(this.dependencyIndex.entityToRules.values()).reduce(((e,t)=>e+t.size),0)/this.dependencyIndex.entityToRules.size:0}},t=this.traceBuffer.getStats();return e.traceStats=t,e}getRuleTrace(e,t=20){return this.traceBuffer.getRuleHistory(e,t)}getRecentMatches(e=6e4){return this.traceBuffer.getMatchedRules(e)}exportTrace(e={}){return this.traceBuffer.exportTraces(e)}clearTrace(){this.traceBuffer.clear(),Tl("rules.trace.cleared",1)}setDataSourceManager(e){console.log("[RulesEngine] Setting DataSourceManager:",e),this.dataSourceManager=e,this.buildDependencyIndex(),this.markAllDirty(),console.log("[RulesEngine] DataSourceManager set, rebuilding dependencies and marking rules dirty")}getRuleDependencies(e){return this.dependencyIndex?.ruleToEntities.get(e)||[]}getEntityDependents(e){return Array.from(this.dependencyIndex?.entityToRules.get(e)||[])}}class Uc{constructor(){this.state={anchors:!1,bounding_boxes:!1,routing:!1,performance:!1,scale:1},this.callbacks=new Set,this.initialized=!1,this.routerReady=!1,this.pendingRouterActions=[],this.pendingInitActions=[],this._notifyTimeout=null,this._pendingNotification=null}init(e={}){e&&Object.keys(e).length>0&&console.log("[DebugManager] Initializing with config:",e),e.overlays?Object.keys(this.state).forEach((t=>{"scale"!==t&&void 0!==e.overlays[t]&&(this.state[t]=e.overlays[t])})):Object.keys(this.state).forEach((t=>{void 0!==e[t]&&(this.state[t]=e[t])})),void 0!==e.scale&&(this.state.scale=e.scale),this.initialized=!0,this.isAnyEnabled()&&console.log("[DebugManager] State after config init:",this.state),this.pendingInitActions.forEach((e=>e())),this.pendingInitActions=[],this.routerReady&&(this.pendingRouterActions.forEach((e=>e())),this.pendingRouterActions=[]),this._scheduleNotification("init")}markRouterReady(){this.routerReady=!0,this.initialized&&(this.pendingRouterActions.forEach((e=>e())),this.pendingRouterActions=[],this._scheduleNotification("router-ready"))}enable(e){this._setFeature(e,!0)}disable(e){this._setFeature(e,!1)}toggle(e){this._setFeature(e,!this.state[e])}setScale(e){this._executeWhenReady((()=>{const t=Math.max(.1,Math.min(3,Number(e)||1));t!==this.state.scale&&(this.state.scale=t,this._scheduleNotification("scale",{scale:t}))}),!1)}getSnapshot(){return{...this.state,enabled:this.isAnyEnabled(),initialized:this.initialized,routerReady:this.routerReady}}status(){const e=this.getSnapshot();return console.table(e),e}isAnyEnabled(){return["anchors","bounding_boxes","routing","performance"].some((e=>this.state[e]))}canRenderRouting(){return this.state.routing&&this.routerReady}onChange(e){return this.callbacks.add(e),()=>this.callbacks.delete(e)}enableMultiple(e){e.forEach((e=>this.enable(e)))}disableMultiple(e){e.forEach((e=>this.disable(e)))}getAvailableFeatures(){return Object.keys(this.state).filter((e=>"scale"!==e))}isEnabled(e){return Boolean(this.state[e])}_scheduleNotification(e,t){this._notifyTimeout&&clearTimeout(this._notifyTimeout),this._pendingNotification={type:e,details:t},this._notifyTimeout=setTimeout((()=>{this._pendingNotification&&(this._notifyChange(this._pendingNotification.type,this._pendingNotification.details),this._pendingNotification=null),this._notifyTimeout=null}),16)}_notifyChange(e,t={}){const n={type:e,details:t,snapshot:this.getSnapshot(),timestamp:Date.now()};this.callbacks.forEach((e=>{try{e(n)}catch(e){console.warn("[DebugManager] Callback error:",e)}}))}_setFeature(e,t){if(!this.state.hasOwnProperty(e)||"scale"===e)return void console.warn(`[DebugManager] Invalid debug feature: ${e}`);const n="routing"===e;this._executeWhenReady((()=>{this.state[e]!==t&&(console.log(`[DebugManager] Setting ${e} to ${t}`),this.state[e]=t,this._scheduleNotification("feature",{feature:e,enabled:t}),setTimeout((()=>{try{const n=window.__msdDebug?.pipelineInstance;n?.reRender&&(console.log(`[DebugManager] Auto re-render after ${e} ${t?"enable":"disable"}`),n.reRender())}catch(e){console.warn("[DebugManager] Auto re-render failed:",e)}}),5))}),n)}_executeWhenReady(e,t=!1){this.initialized?!t||this.routerReady?e():this.pendingRouterActions.push(e):this.pendingInitActions.push((()=>this._executeWhenReady(e,t)))}}class Gc{constructor(e){this.systemsManager=e,this.overlayUpdaters=new Map,this._registerUpdaters()}_registerUpdaters(){this.overlayUpdaters.set("text",{needsUpdate:(e,t)=>this._textNeedsUpdate(e,t),update:(e,t,n)=>this._updateTextOverlay(e,t,n),hasTemplates:e=>this._hasTemplateContent(e)}),this.overlayUpdaters.set("status_grid",{needsUpdate:(e,t)=>this._statusGridNeedsUpdate(e,t),update:(e,t,n)=>this._updateStatusGrid(e,t,n),hasTemplates:e=>this._hasTemplateContent(e)}),this.overlayUpdaters.set("sparkline",{needsUpdate:(e,t)=>!0,update:(e,t,n)=>this._updateSparkline(e,t,n),hasTemplates:()=>!1}),this.overlayUpdaters.set("default",{needsUpdate:(e,t)=>this._hasTemplateContent(e),update:(e,t,n)=>this._updateGenericOverlay(e,t,n),hasTemplates:e=>this._hasTemplateContent(e)})}updateOverlaysForDataSourceChanges(e){console.log("[BaseOverlayUpdater] Checking overlays for DataSource changes:",e);const t=this.systemsManager.modelBuilder?.getResolvedModel?.();t?.overlays&&t.overlays.forEach((t=>{const n=this.overlayUpdaters.get(t.type)||this.overlayUpdaters.get("default");if(n.hasTemplates(t)&&this._overlayReferencesChangedDataSources(t,e)){const s=this._findDataSourceForEntity(e[0]);if(s){const e=this.systemsManager.dataSourceManager.getSource(s);if(e){const s=e.getCurrentData();console.log(`[BaseOverlayUpdater] Updating ${t.type} overlay ${t.id}`),n.update(t.id,t,s)}}}}))}_hasTemplateContent(e){const t=e._raw?.content||e.content||e.text||e._raw?.value_format||e.value_format||"";if(t&&"string"==typeof t&&t.includes("{"))return!0;if("status_grid"===e.type){const t=e.cells||e._raw?.cells||e.raw?.cells;if(t&&Array.isArray(t))return t.some((e=>{const t=e.content||e.label||e.value_format||"";return t&&"string"==typeof t&&t.includes("{")}))}return!1}_overlayReferencesChangedDataSources(e,t){const n=e._raw?.content||e.content||e.text||"";let s=!1;if(n&&this._contentReferencesChangedDataSources(n,t)&&(s=!0),"status_grid"===e.type){const n=e.cells||e._raw?.cells||e.raw?.cells;n&&Array.isArray(n)&&(s=s||n.some((e=>{const n=e.content||e.label||e.value_format||"";return this._contentReferencesChangedDataSources(n,t)})))}return s}_contentReferencesChangedDataSources(e,t){return!(!e||"string"!=typeof e)&&t.some((t=>{if(this.systemsManager.dataSourceManager)for(const[n,s]of this.systemsManager.dataSourceManager.sources||new Map)if(s.cfg&&s.cfg.entity===t&&e.includes(n))return!0;return!1}))}_updateTextOverlay(e,t,n){this.systemsManager.renderer&&this.systemsManager.renderer.updateTextOverlay&&this.systemsManager.renderer.updateTextOverlay(e,n)}_updateStatusGrid(e,t,s){console.log(`[BaseOverlayUpdater] Updating status grid ${e} with template processing`),Promise.resolve().then(n.bind(n,254)).then((({StatusGridRenderer:n})=>{const r=(new n).updateCellsWithData(t,t.finalStyle||{},s);console.log(`[BaseOverlayUpdater] Processed ${r.length} cells for status grid ${e}`),this.systemsManager.renderer&&this.systemsManager.renderer.updateStatusGridWithTemplates?this.systemsManager.renderer.updateStatusGridWithTemplates(e,s):this.systemsManager.renderer&&this.systemsManager.renderer.updateStatusGrid?this.systemsManager.renderer.updateStatusGrid(e,r):(console.log("[BaseOverlayUpdater] Status grid update method not yet implemented in AdvancedRenderer"),this.systemsManager.renderer&&this.systemsManager.renderer.updateOverlayData&&this.systemsManager.renderer.updateOverlayData(e,s))})).catch((e=>{console.error("[BaseOverlayUpdater] Failed to import StatusGridRenderer:",e)}))}_updateSparkline(e,t,n){console.log(`[BaseOverlayUpdater] Updating sparkline ${e} with enhanced synchronization`),this.systemsManager.renderer&&this.systemsManager.renderer.updateSparklineData?this.systemsManager.renderer.updateSparklineData(e,n):this.systemsManager.renderer&&this.systemsManager.renderer.updateOverlayData&&this.systemsManager.renderer.updateOverlayData(e,n)}_updateGenericOverlay(e,t,n){console.log(`[BaseOverlayUpdater] Generic update for ${t.type} overlay ${e}`)}static _updateOverlayWithData(e,t){const n=Date.now(),s=t.historyReady&&(!e.lastUpdate||0===e.lastUpdate);s&&console.log(`[BaseOverlayUpdater] 🚀 Processing INITIAL data for ${e.type} overlay ${e.id}`),"text"===e.type?(TextOverlayRenderer.updateTextOverlay(e,t.entity,t.v,n,t.unit_of_measurement),console.log(`[BaseOverlayUpdater] ✅ Updated TEXT overlay ${e.id} with value: ${t.v}`)):"status_grid"===e.type?(StatusGridRenderer.updateCellsWithData(e,t),s&&(console.log(`[BaseOverlayUpdater] 🎯 STATUS GRID ${e.id} received initial data - forcing re-render if needed`),e._needsRerender=!0),console.log(`[BaseOverlayUpdater] ✅ Updated STATUS GRID overlay ${e.id} with data from entity: ${t.entity}`)):"sparkline"===e.type?(SparklineRenderer.updateSparklineData(e,t),console.log(`[BaseOverlayUpdater] ✅ Updated SPARKLINE overlay ${e.id} with buffer data`)):(e.data=t,e.lastUpdate=n,console.log(`[BaseOverlayUpdater] ✅ Updated ${e.type} overlay ${e.id} with generic data`)),e.lastUpdate=n}_textNeedsUpdate(e,t){return this._hasTemplateContent(e)}_statusGridNeedsUpdate(e,t){return this._hasTemplateContent(e)}_findDataSourceForEntity(e){if(this.systemsManager.dataSourceManager)for(const[t,n]of this.systemsManager.dataSourceManager.sources||new Map)if(n.cfg&&n.cfg.entity===e)return t;return null}}class qc{constructor(){this.dataSourceManager=null,this.renderer=null,this.debugRenderer=null,this.controlsRenderer=null,this.hudManager=null,this.router=null,this.animRegistry=null,this.rulesEngine=null,this.debugManager=new Uc,this.overlayUpdater=null,this._renderTimeout=null,this._reRenderCallback=null,this._queuedReRender=!1,this._debugControlsRendering=!1,this.mergedConfig=null,this._originalHass=null,this._currentHass=null,this._previousRuleStates=new Map,this._internalRenderInProgress=!1,Object.defineProperty(this,"_renderInProgress",{get(){return this._internalRenderInProgress},set(e){const t=this._internalRenderInProgress;this._internalRenderInProgress=e,!0===t&&!1===e&&this._queuedReRender&&(console.log("[MSD DEBUG] 🔄 Executing queued re-render (render completed)"),this._queuedReRender=!1,setTimeout((()=>{if(!this._internalRenderInProgress&&this._reRenderCallback){console.log("[MSD DEBUG] 🚀 Executing queued re-render callback");try{this._reRenderCallback()}catch(e){console.error("[MSD DEBUG] ❌ Queued re-render failed:",e)}}}),50))}})}async initializeSystems(e,t,n,s){console.log("[MSD v1] Initializing runtime systems"),this.mergedConfig=e,this._currentHass=s;const r=e.debug||{};if(console.log("[MSD v1] Raw debug config from mergedConfig:",r),this.debugManager.init(r),console.log("[MSD v1] DebugManager initialized with config:",r),await this._initializeDataSources(s,e),this.rulesEngine=new Hc(e.rules,this.dataSourceManager),this.rulesEngine.markAllDirty(),this._instrumentRulesEngine(e),this.dataSourceManager){const e=this._createEntityChangeHandler();this.dataSourceManager.addEntityChangeListener(e),console.log("[MSD v1] DataSourceManager connected to rules engine with entity change handler"),console.log("[MSD v1] DataSourceManager entity count:",this.dataSourceManager.listIds().length)}else console.warn("[MSD v1] DataSourceManager not initialized - no data sources configured or HASS unavailable");return this.router=new Rc(e.routing,t.anchors,t.viewBox),this.renderer=new Yl(n,this.router,this),this.debugRenderer=new Xl,this.controlsRenderer=new Jl(this.renderer),this._currentHass&&this.controlsRenderer&&(console.log("[MSD v1] Setting initial HASS context on controls renderer"),this.controlsRenderer.setHass(this._currentHass)),this.hudManager=new dc,this.hudManager.init(n),this._setupGlobalHudInterface(),this.debugRenderer.init(this),this.debugManager.markRouterReady(),console.log("[MSD v1] RouterCore marked ready for debug system"),this.animRegistry=new Lc,this.overlayUpdater=new Gc(this),console.log("[MSD v1] BaseOverlayUpdater initialized for unified overlay updates"),this.mergedConfig&&this.mergedConfig.overlays&&(console.log("[MSD v1] Applying status indicator fix to prevent NaN coordinate errors"),this.mergedConfig.overlays=this.mergedConfig.overlays.map((e=>e&&e.status_indicator?(console.log(`[MSD v1] DISABLED status indicator for ${e.id} to prevent NaN coordinates`),{...e,status_indicator:!1}):e))),console.log("[MSD v1] All systems initialized successfully"),this}setReRenderCallback(e){this._reRenderCallback=e}_createEntityChangeHandler(){return(e,t=null)=>{const n=Date.now();console.log("[MSD DEBUG] 🔔 Entity change handler TRIGGERED:",{timestamp:(new Date).toISOString(),changedIds:e,hasEnhancedData:!!t,stackTrace:(new Error).stack.split("\n").slice(1,5).join("\n"),renderTimeout:!!this._renderTimeout,renderInProgress:!!this._renderInProgress});const s=this._extractControlEntities(this.mergedConfig),r=e.filter((e=>s.includes(e)));r.length>0&&this.controlsRenderer&&(console.log("[SystemsManager] 📡 Control entities changed:",r),console.log("[SystemsManager] ℹ️ Direct subscription will handle these updates automatically"));const i=this.getCurrentHass();if(i&&this.dataSourceManager){console.log("[MSD DEBUG] 📤 Refreshing MSD internal HASS context with converted entity states");const t={};e.forEach((e=>{const n=this.dataSourceManager.getEntity(e);n&&void 0!==n.state?(t[e]={state:n.state.toString(),last_changed:(new Date).toISOString(),last_updated:(new Date).toISOString(),attributes:n.attributes||i.states[e]?.attributes||{},entity_id:e,context:{id:Date.now().toString(),user_id:null}},console.log("[MSD DEBUG] 🔄 Updated MSD internal state for",e,{originalState:this._originalHass?.states[e]?.state,convertedState:t[e].state,rawValue:n.state})):console.log("[MSD DEBUG] ⚠️ No data source found for entity:",e,"(entity will not be updated in MSD internal HASS)")})),Object.keys(t).length>0?(this._currentHass={...i,states:{...i.states,...t}},console.log("[MSD DEBUG] ✅ MSD internal HASS context refreshed with",Object.keys(t).length,"converted entities")):console.log("[MSD DEBUG] ℹ️ No data source entities changed - MSD internal HASS unchanged")}else console.log("[MSD DEBUG] ⚠️ Skipping MSD internal HASS update:",{hasWorkingHass:!!i,hasDataSourceManager:!!this.dataSourceManager,dataSourceManagerIsNull:null===this.dataSourceManager});if(this.overlayUpdater?(console.log("[MSD DEBUG] 🔄 Using BaseOverlayUpdater for overlay updates"),this.overlayUpdater.updateOverlaysForDataSourceChanges(e)):console.log("[MSD DEBUG] ⚠️ BaseOverlayUpdater not available, skipping overlay updates"),this.rulesEngine){const t=new Set;e.forEach((e=>{if(t.add(e),this.dataSourceManager)for(const[n,s]of this.dataSourceManager.sources)s.cfg&&s.cfg.entity===e&&(t.add(n),console.log(`[MSD DEBUG] 📏 Mapped entity "${e}" to DataSource "${n}"`))}));const n=Array.from(t);this.rulesEngine.markEntitiesDirty(n),console.log("[MSD DEBUG] 📏 Marked rules dirty for entities:",n)}else console.log("[MSD DEBUG] ⚠️ No rules engine available to mark dirty");this._renderTimeout&&(console.log("[MSD DEBUG] ⏰ Clearing existing render timeout"),clearTimeout(this._renderTimeout));const o=e.some((e=>s.includes(e))),a=e.some((e=>this.dataSourceManager&&this.dataSourceManager.getEntity(e)));this._lastEntityAnalysis={isControlTriggered:o,hasDataSourceChanges:a,timestamp:n,changedIds:e,controlEntities:s,matchingEntities:e.filter((e=>s.includes(e)))},console.log("[MSD DEBUG] 🎯 Entity change analysis:",this._lastEntityAnalysis),a?(console.log("[MSD DEBUG] 🔄 Checking if rules need re-evaluation for data source changes"),this._checkIfRulesNeedReRender(e)?(console.log("[MSD DEBUG] 🎨 Rule conditions may have changed - scheduling full re-render"),this._scheduleFullReRender()):console.log("[MSD DEBUG] 📊 Only content changed - rules unchanged, skipping full re-render")):console.log("[MSD DEBUG] ⏭️ SKIPPING re-render - no relevant entity changes for MSD")}}setOriginalHass(e){console.log("[SystemsManager] 📚 Setting original HASS reference:",{hasStates:!!e?.states,entityCount:e?.states?Object.keys(e.states).length:0,hasAuth:!!e?.auth,hasConnection:!!e?.connection,lightDeskState:e?.states?.["light.desk"]?.state,timestamp:(new Date).toISOString()}),this._originalHass=e,this._currentHass||(this._currentHass=e,console.log("[SystemsManager] 📚 Also setting _currentHass (first time)")),this.setupDirectHassSubscription(e)}getCurrentHass(){return this._currentHass}getOriginalHass(){return this._originalHass}_instrumentRulesEngine(e){try{const t=new Map;(e.rules||[]).forEach((e=>{(e.when&&(e.when.all||e.when.any)||[]).forEach((n=>{const s=n?.entity;s&&(t.has(s)||t.set(s,new Set),t.get(s).add(e.id))}))})),this.rulesEngine.__hudDeps=t;const n="undefined"!=typeof window?window:{};n.__msdDebug=n.__msdDebug||{};const s=n.__msdDebug.__perfStore=n.__msdDebug.__perfStore||{counters:{},timings:{}};function r(e,t=1){s.counters[e]=(s.counters[e]||0)+t}if(!this.rulesEngine.__perfWrapped&&"function"==typeof this.rulesEngine.evaluateDirty){const i=this.rulesEngine.evaluateDirty;this.rulesEngine.evaluateDirty=function(){r("rules.eval.count",(e.rules||[]).length||0);const t=i.apply(this,arguments);try{const e=this.getTrace&&this.getTrace()||[],t=Array.isArray(e)?e.filter((e=>e&&e.matched)).length:0;r("rules.match.count",t)}catch{}return t},this.rulesEngine.__perfWrapped=!0}}catch(o){console.warn("[MSD v1][rules instrumentation] failed",o)}}async _initializeDataSources(e,t){if(this.dataSourceManager=null,!e)return void console.warn("[MSD v1] No HASS provided - DataSourceManager will not be initialized");const n=t.data_sources||{};console.log("[MSD v1] 🔍 Using explicit-only data sources mode"),console.log("[MSD v1] 🔍 Configured data sources:",Object.keys(n));const s=this._extractControlEntities(t);console.log("[MSD v1] 🔍 Control entities (using direct HASS):",s);const r={...n};if(console.log("[MSD v1] 📊 Data source summary:",{configured:Object.keys(n).length,total:Object.keys(r).length,allDataSourceIds:Object.keys(r)}),0===Object.keys(r).length)return console.log("[MSD v1] No explicit data sources configured - DataSourceManager will not be initialized"),void console.log("[MSD v1] Note: Control overlays will use direct HASS (no data sources needed)");console.log("[MSD v1] Initializing DataSourceManager with",Object.keys(r).length,"explicit data sources");try{this.dataSourceManager=new Ac(e);const t=await this.dataSourceManager.initializeFromConfig(r);console.log("[MSD v1] ✅ DataSourceManager initialized -",t,"sources started");const n=this.dataSourceManager.listIds();console.log("[MSD v1] ✅ DataSourceManager entities available:",n)}catch(e){console.error("[MSD v1] ❌ DataSourceManager initialization failed:",e),console.error("[MSD v1] Error details:",e.stack),this.dataSourceManager=null}}_extractControlEntities(e){const t=new Set;return(e.overlays||[]).forEach((e=>{if("control"===e.type&&e.card){const n=e.card.config?.entity||e.card.config?.variables?.entity||e.card.entity;n&&t.add(n)}})),Array.from(t)}destroy(){this.debugRenderer&&this.debugRenderer.destroy(),this._renderTimeout&&(clearTimeout(this._renderTimeout),this._renderTimeout=null),this._reRenderCallback=null}async renderDebugAndControls(e,t=null){if(this._debugControlsRendering)console.log("[SystemsManager] renderDebugAndControls already in progress, skipping");else{this._debugControlsRendering=!0;try{const n=this.debugManager.getSnapshot();if(console.log("[SystemsManager] renderDebugAndControls called:",{anyEnabled:this.debugManager.isAnyEnabled(),controlOverlays:e.overlays.filter((e=>"control"===e.type)).length,hasHass:!!this._currentHass,hasResolvedModel:!!e,hasOverlays:!!e?.overlays}),!e||!e.overlays)return void console.warn("[SystemsManager] Invalid resolved model for renderDebugAndControls");if(this.debugManager.isAnyEnabled())try{const s={anchors:e.anchors||{},overlays:e.overlays||[],showAnchors:n.anchors,showBoundingBoxes:n.bounding_boxes,showRouting:this.debugManager.canRenderRouting(),showPerformance:n.performance,scale:n.scale};this.debugRenderer.render(t||this.renderer?.mountEl,e.viewBox,s),console.log("[SystemsManager] ✅ Debug renderer completed")}catch(e){console.error("[SystemsManager] ❌ Debug renderer failed:",e)}const s=e.overlays.filter((e=>"control"===e.type));if(s.length>0){console.log("[SystemsManager] Rendering control overlays:",s.map((e=>e.id)));try{if(!this.controlsRenderer)return void console.error("[SystemsManager] No controls renderer available");this._currentHass&&this.controlsRenderer?(this.controlsRenderer.setHass(this._currentHass),console.log("[SystemsManager] HASS context applied to controls renderer")):console.warn("[SystemsManager] No HASS context available for controls");const t=this.controlsRenderer.renderControls(s,e),n=new Promise(((e,t)=>setTimeout((()=>t(new Error("Controls render timeout"))),5e3)));await Promise.race([t,n]),console.log("[SystemsManager] ✅ Controls rendered successfully")}catch(e){console.error("[SystemsManager] ❌ Controls rendering failed:",e),console.error("[SystemsManager] Error stack:",e.stack)}}}catch(e){console.error("[SystemsManager] renderDebugAndControls failed completely:",e),console.error("[SystemsManager] Error stack:",e.stack)}finally{this._debugControlsRendering=!1}}}_shouldRenderDebugFromConfig(e){return!(!e||!e.overlays)&&(e.overlays.anchors||e.overlays.bounding_boxes||e.overlays.routing||e.overlays.performance)}_getDebugFlags(){return window.cblcars?._debugFlags||{}}_shouldRenderDebug(e){return e&&(e.overlay||e.connectors||e.geometry)}ingestHass(e){console.log("[SystemsManager] ingestHass called with:",{hasHass:!!e,hasStates:!!e?.states,entityCount:e?.states?Object.keys(e.states).length:0,hasLightDesk:!!e?.states?.["light.desk"],lightDeskState:e?.states?.["light.desk"]?.state,timestamp:(new Date).toISOString()}),e&&e.states?(this._currentHass=e,this._originalHass=e,console.log("[SystemsManager] Updated both _currentHass and _originalHass with fresh data"),this.controlsRenderer?(console.log("[SystemsManager] Updating HASS context in controls renderer immediately"),this.controlsRenderer.setHass(e)):console.warn("[SystemsManager] No controls renderer available for HASS update"),console.log("[MSD v1] HASS ingestion handled by individual data sources")):console.warn("[MSD v1] ingestHass called without valid hass.states")}updateEntities(e){e&&"object"==typeof e&&(console.log("[MSD v1] Manual entity updates not supported in DataSources system"),console.warn("[MSD v1] Use direct HASS state updates instead of manual entity updates"))}listEntities(){return this.dataSourceManager?this.dataSourceManager.listIds():[]}getEntity(e){return this.dataSourceManager?this.dataSourceManager.getEntity(e):null}setupDirectHassSubscription(e){e&&e.connection&&!this._directHassSubscription&&(console.log("[SystemsManager] 🔗 Setting up direct HASS subscription for fresh control updates"),this._directHassSubscription=e.connection.subscribeEvents((e=>{if("state_changed"===e.event_type&&e.data&&e.data.entity_id){const t=e.data.entity_id,n=e.data.new_state;if(this._extractControlEntities(this.mergedConfig).includes(t)&&n&&(console.log("[SystemsManager] 📡 Direct HASS update for control entity:",t,"new state:",n.state),this._originalHass&&this._originalHass.states)){const e={...this._originalHass,states:{...this._originalHass.states,[t]:n}};console.log("[SystemsManager] 📊 Updated HASS with fresh state for",t,":",n.state),this._originalHass=e,this._currentHass=e,this.controlsRenderer&&(console.log("[SystemsManager] 📤 Immediately forwarding fresh HASS to controls"),this.controlsRenderer.setHass(e))}}}),"state_changed"),console.log("[SystemsManager] ✅ Direct HASS subscription established"))}_setupGlobalHudInterface(){console.log("[SystemsManager] Global HUD interface setup completed")}_checkIfRulesNeedReRender(e){if(!this.rulesEngine||!this.mergedConfig?.rules)return!1;const t=e.filter((t=>this.dataSourceManager?.getEntity(t)||e.some((e=>this.dataSourceManager?.getSource(e)))));if(t.length>0){console.log("[MSD DEBUG] 🎯 DataSource entities affected by changes:",t);const n=this._checkThresholdCrossing(e);return console.log("[MSD DEBUG] 🌡️ Threshold crossing check:",n),n}return!1}_checkThresholdCrossing(e){const t=this.mergedConfig.rules||[];for(const n of t){const t=n.when?.any||n.when?.all||[];for(const s of t)if(s.entity&&(void 0!==s.above||void 0!==s.below)){const t=s.entity;if(e.some((e=>{const n=t.split(".")[0],s=this.dataSourceManager?.getSource(n);return s&&s.cfg?.entity===e}))){console.log("[MSD DEBUG] 🎯 Rule condition potentially affected:",{rule:n.id,entity:t,threshold:s.above||s.below,operator:s.above?"above":"below"});const e=this.dataSourceManager?.getEntity(t);if(e&&void 0!==e.state){const t=parseFloat(e.state),r=s.above||s.below,i=t>r,o=t<r,a=s.above?i:o;console.log("[MSD DEBUG] 🌡️ Detailed threshold analysis:",{currentValue:t,threshold:r,operator:s.above?"above":"below",isAboveThreshold:i,isBelowThreshold:o,currentlyMatches:a,ruleId:n.id}),this._previousRuleStates||(this._previousRuleStates=new Map);const l=`${n.id}_${s.entity}`,c=this._previousRuleStates.get(l);return console.log("[MSD DEBUG] 📊 Rule state comparison:",{ruleKey:l,previouslyMatched:c,currentlyMatches:a,stateChanged:c!==a}),this._previousRuleStates.set(l,a),void 0!==c&&c!==a?(console.log("[MSD DEBUG] 🔄 Rule state CHANGED - threshold crossing detected!"),!0):void 0===c?(console.log("[MSD DEBUG] 🆕 First rule evaluation - storing state"),!1):(console.log("[MSD DEBUG] 📌 Rule state UNCHANGED - no threshold crossing"),!1)}}}}return console.log("[MSD DEBUG] 📊 No threshold crossings detected"),!1}_scheduleFullReRender(){this._renderTimeout&&(console.log("[MSD DEBUG] ⏰ Clearing existing render timeout"),clearTimeout(this._renderTimeout)),this._renderTimeout=setTimeout((()=>{if(this._reRenderCallback&&!this._renderInProgress)try{this._renderInProgress=!0,console.log("[MSD DEBUG] 🚀 TRIGGERING full re-render from rule change timeout"),this._reRenderCallback()}catch(e){console.error("[MSD DEBUG] ❌ Re-render FAILED in entity change handler:",e)}finally{this._renderInProgress=!1}this._renderTimeout=null}),100)}_updateTextOverlaysForDataSourceChanges(e){console.log("[MSD DEBUG] 🔤 Checking for text overlays affected by DataSource changes:",e);const t=this.modelBuilder?.getResolvedModel?.();if(!t||!t.overlays)return void console.log("[MSD DEBUG] ⚠️ No resolved model available for text overlay updates");const n=t.overlays.filter((e=>"text"===e.type));console.log("[MSD DEBUG] 🔤 Found",n.length,"text overlays to check"),n.forEach((t=>{const n=t._raw?.content||t.content||t.text||"";if(n&&"string"==typeof n&&n.includes("{"))if(console.log(`[MSD DEBUG] 🔤 Checking text overlay ${t.id} with content: "${n}"`),e.some((e=>{if(this.dataSourceManager)for(const[s,r]of this.dataSourceManager.sources||new Map)if(r.cfg&&r.cfg.entity===e&&(console.log(`[MSD DEBUG] 🔗 Entity ${e} maps to DataSource ${s}`),n.includes(s)))return console.log(`[MSD DEBUG] ✅ Text overlay ${t.id} references DataSource ${s} - needs update`),!0;return!1}))){console.log(`[MSD DEBUG] 🚀 Updating text overlay ${t.id} for DataSource changes`);const n=this._findDataSourceForEntity(e[0]);if(n){const e=this.dataSourceManager.getSource(n);if(e){const s=e.getCurrentData();if(console.log(`[MSD DEBUG] 📊 Using DataSource ${n} data:`,s),this.renderer&&this.renderer.updateTextOverlay)try{this.renderer.updateTextOverlay(t.id,s),console.log(`[MSD DEBUG] ✅ Text overlay ${t.id} updated successfully`)}catch(e){console.error(`[MSD DEBUG] ❌ Failed to update text overlay ${t.id}:`,e)}}}}else console.log(`[MSD DEBUG] ⏭️ Text overlay ${t.id} not affected by these changes`)}))}_findDataSourceForEntity(e){if(this.dataSourceManager)for(const[t,n]of this.dataSourceManager.sources||new Map)if(n.cfg&&n.cfg.entity===e)return t;return null}}const Vc=new class{constructor(){this.profileIndex=new Map,this.activeProfiles=[],this.styleCache=new Map,this.lastActiveProfiles=null,this.perfStats={profileLoads:0,styleMerges:0,cacheHits:0,cacheMisses:0,invalidations:0}}loadProfiles(e){Dl("profile.load",(()=>{this.profileIndex.clear(),e.forEach((e=>{e.id&&(this.profileIndex.set(e.id,e),this.perfStats.profileLoads++)})),Tl("profile.loaded",e.length)}))}setActiveProfiles(e){const t=Array.isArray(e)?e:[];JSON.stringify(this.activeProfiles)!==JSON.stringify(t)&&(this.activeProfiles=[...t],this.invalidateStyleCache(),Tl("profile.active.changed",1))}resolveOverlayStyles(e){return Dl("profile.resolve.overlays",(()=>{const t=e.map((e=>{const t={...e};return t.style=this.resolveOverlayStyle(e),t}));return Tl("profile.overlays.processed",e.length),t}))}resolveOverlayStyle(e){return Dl("profile.resolve.single",(()=>{const t=this.buildStyleCacheKey(e);if(this.styleCache.has(t))return this.perfStats.cacheHits++,Tl("profile.cache.hits",1),this.styleCache.get(t);const n=this.buildStyleLayers(e),s=this.mergeStyleLayers(n);return this.styleCache.set(t,s),this.perfStats.cacheMisses++,this.perfStats.styleMerges++,Tl("profile.cache.misses",1),s}))}buildStyleLayers(e){const t=[];return this.activeProfiles.forEach(((n,s)=>{const r=this.profileIndex.get(n);if(r){const i=this.getProfileOverlayStyle(r,e.id,e.type);i&&t.push({source:"profile",sourceId:n,style:i,precedence:100+s})}})),e.style&&t.push({source:"overlay",sourceId:e.id,style:e.style,precedence:1e3}),t.sort(((e,t)=>e.precedence-t.precedence))}getProfileOverlayStyle(e,t,n){return e.overlays&&e.overlays[t]?e.overlays[t]:e.defaults&&e.defaults[n]?e.defaults[n]:null}mergeStyleLayers(e){const t={},n={};return e.forEach((e=>{Object.entries(e.style).forEach((([s,r])=>{t[s]=r,n[s]={source:e.source,sourceId:e.sourceId,precedence:e.precedence}}))})),Object.defineProperty(t,"__styleProvenance",{value:n,enumerable:!1,writable:!1}),t}buildStyleCacheKey(e){return[e.id,e.type||"unknown",this.getOverlayStyleHash(e.style),this.activeProfiles.join(",")].join("|")}getOverlayStyleHash(e){return e&&"object"==typeof e?JSON.stringify(e).length.toString(36):"empty"}invalidateStyleCache(){this.styleCache.clear(),this.perfStats.invalidations++,Tl("profile.cache.invalidated",1)}getProfile(e){return this.profileIndex.get(e)}getActiveProfiles(){return[...this.activeProfiles]}getAvailableProfiles(){return Array.from(this.profileIndex.keys())}isProfileActive(e){return this.activeProfiles.includes(e)}getStats(){return{...this.perfStats,profileCount:this.profileIndex.size,activeProfileCount:this.activeProfiles.length,cacheSize:this.styleCache.size,hitRate:this.perfStats.cacheHits/(this.perfStats.cacheHits+this.perfStats.cacheMisses)||0}}getDebugInfo(){const e={availableProfiles:{},activeProfiles:this.activeProfiles,cacheSize:this.styleCache.size,stats:this.getStats()};return this.profileIndex.forEach(((t,n)=>{e.availableProfiles[n]={hasDefaults:!!(t.defaults&&Object.keys(t.defaults).length>0),hasOverlays:!!(t.overlays&&Object.keys(t.overlays).length>0),defaultTypes:t.defaults?Object.keys(t.defaults):[],overlayIds:t.overlays?Object.keys(t.overlays):[]}})),e}exportStats(e={}){const t=this.getStats();return e.includeDebug&&(t.debug=this.getDebugInfo()),"json"===e.format?JSON.stringify(t,null,2):t}},Wc="undefined"!=typeof window?window:n.g;function Yc(e){return e&&"object"==typeof e&&!Array.isArray(e)}function Xc(e,t){if(!Yc(t))return t;Yc(e)||(e={});for(const n of Object.keys(t)){const s=t[n],r=e[n];Yc(s)&&Yc(r)?e[n]=Xc(r,s):e[n]=s}return e}Wc&&(Wc.__msdProfile={resolver:Vc,getStats:()=>Vc.getStats(),getDebugInfo:()=>Vc.getDebugInfo(),getActiveProfiles:()=>Vc.getActiveProfiles(),getAvailableProfiles:()=>Vc.getAvailableProfiles(),export:e=>Vc.exportStats(e)});class Jc{constructor(e,t,n){this.mergedConfig=e,this.cardModel=t,this.systems=n,Vc.loadProfiles(e.profiles||[]),this.animationIndex=new Map((e.animations||[]).map((e=>[e.id,e]))),this.timelineDefs=e.timelines||[],this.runtimeActiveProfiles=Array.isArray(e.active_profiles)?e.active_profiles.slice():[],this._resolvedModelRef=null}computeResolvedModel(){this._ensureAnchors();const e=this._assembleBaseOverlays();this._subscribeOverlaysToDataSources(e);const t=this._applyRules();this._updateActiveProfiles(t);const n=this._applyOverlayPatches(e,t);this._resolveValueMaps(n);const{activeAnimations:s,animDiff:r,tlDiff:i}=this._processAnimations(n,t),o={viewBox:this.cardModel.viewBox,anchors:{...this.cardModel.anchors},overlays:n,animations:r.active,timelines:i.active,config:this.mergedConfig,active_profiles:this.runtimeActiveProfiles.slice()},a=o.overlays.find((e=>"title_overlay"===e.id));a&&console.log("[ModelBuilder] 🏁 Final title_overlay state before rendering:",{id:a.id,color:a.style?.color,status_indicator:a.style?.status_indicator,finalStyle:a.finalStyle});try{this.systems.router.setOverlays&&this.systems.router.setOverlays(o.overlays)}catch(e){}return this._resolvedModelRef=o,o}getResolvedModel(){return this._resolvedModelRef}_ensureAnchors(){this.cardModel.anchors&&0!==Object.keys(this.cardModel.anchors).length||(this.mergedConfig.anchors&&Object.keys(this.mergedConfig.anchors).length?(console.warn("[MSD v1] computeResolvedModel: anchors missing – repairing from merged.anchors"),this.cardModel.anchors={...this.mergedConfig.anchors}):console.warn("[MSD v1] computeResolvedModel: anchors missing and no merged fallback available."))}_assembleBaseOverlays(){return Tc("profiles.assemble",(()=>(Vc.setActiveProfiles(this.runtimeActiveProfiles),this.cardModel.overlaysBase.map((e=>{const t=Vc.resolveOverlayStyle(e),n=t.__styleProvenance?Object.entries(t.__styleProvenance).map((([e,t])=>({kind:t.source,id:t.sourceId}))):[],s={id:e.id,type:e.type,style:t,finalStyle:{...t},_styleSources:n,_raw:e.raw,anchor:e.raw?.anchor,attach_to:e.raw?.attach_to,position:e.raw?.position,size:e.raw?.size};return e.raw?.source&&(s.source=e.raw.source),e.raw?.route&&(s.route=e.raw.route),s})))))}_subscribeOverlaysToDataSources(e){if(!this.systems.dataSourceManager||!e)return void console.log("[MSD v1] Skipping overlay subscriptions - no DataSourceManager or overlays");let t=0,n=0;e.forEach((e=>{if(("sparkline"===e.type||"ribbon"===e.type)&&e.source)try{const s=this.systems.dataSourceManager.getSource(e.source);if(!s)return void console.warn(`[MSD v1] Data source '${e.source}' not found for overlay ${e.id}`);const r=s.getCurrentData(),i=r&&(r.bufferSize>0||void 0!==r.v);console.log(`[MSD v1] Subscribing overlay ${e.id} to source ${e.source}:`,{sourceReady:i,bufferSize:r?.bufferSize||0,hasValue:void 0!==r?.v});const o=this.systems.dataSourceManager.subscribeOverlay(e,((e,t)=>{if(console.log(`[MSD v1] 📊 Data update for overlay ${e.id}:`,{value:t.v,bufferSize:t.buffer?.size?.()||0,hasHistoricalData:!!t.historicalData?.length,sourceReady:!0}),this.systems.renderer&&this.systems.renderer.updateOverlayData)try{this.systems.renderer.updateOverlayData(e.id,t)}catch(t){console.error(`[MSD v1] Error updating overlay ${e.id}:`,t)}else console.warn(`[MSD v1] Renderer not available for overlay update: ${e.id}`)}));o&&(t++,i?console.log(`[MSD v1] ✅ Subscribed overlay ${e.id} to ready source ${e.source}`):(n++,console.log(`[MSD v1] ⏳ Subscribed overlay ${e.id} to pending source ${e.source}`)),this._overlayUnsubscribers||(this._overlayUnsubscribers=new Map),this._overlayUnsubscribers.has(e.id)||this._overlayUnsubscribers.set(e.id,[]),this._overlayUnsubscribers.get(e.id).push(o))}catch(t){console.warn(`[MSD v1] ⚠️ Failed to subscribe overlay ${e.id} to source ${e.source}:`,t.message)}})),t>0&&console.log(`[MSD v1] ✅ Established ${t} overlay data subscriptions (${n} pending data)`),n>0&&this._monitorPendingSubscriptions(e,n),this._subscribeTextOverlaysToDataSources(e)}_monitorPendingSubscriptions(e,t){let n=0;const s=setInterval((()=>{n++;let t=0;e.forEach((e=>{if(("sparkline"===e.type||"ribbon"===e.type)&&e.source){const n=this.systems.dataSourceManager.getSource(e.source);if(n){const e=n.getCurrentData();e&&(e.bufferSize>0||void 0!==e.v)||t++}}})),0===t?(console.log(`[MSD v1] 🎉 All overlay data sources are now ready (checked ${n} times)`),clearInterval(s)):n>=50?(console.warn(`[MSD v1] ⏰ Timeout waiting for ${t} data sources to become ready`),clearInterval(s)):n%10==0&&console.log(`[MSD v1] ⏳ Still waiting for ${t} data sources (${100*n}ms elapsed)`)}),100)}_applyRules(){console.log("[ModelBuilder] 🔍 _applyRules() called"),this.systems.rulesEngine.markAllDirty(),console.log("[ModelBuilder] 📏 Marked all rules dirty");const e=this.systems.rulesEngine.evaluateDirty({getEntity:e=>{if(this.systems.dataSourceManager&&this.systems.dataSourceManager.getEntity)return this.systems.dataSourceManager.getEntity(e);if(this.systems._currentHass?.states?.[e]){const t=this.systems._currentHass.states[e];return{state:t.state,attributes:t.attributes||{}}}return null}});return console.log("[ModelBuilder] 📏 Rule evaluation result:",{overlayPatches:e.overlayPatches.length,patches:e.overlayPatches}),e}_updateActiveProfiles(e){if(e.profilesAdd?.length||e.profilesRemove?.length){const t=new Set(this.runtimeActiveProfiles);e.profilesAdd.forEach((e=>t.add(e))),e.profilesRemove.forEach((e=>t.delete(e))),this.runtimeActiveProfiles=Array.from(t),Vc.setActiveProfiles(this.runtimeActiveProfiles)}}_applyOverlayPatches(e,t){console.log("[ModelBuilder] 🎨 _applyOverlayPatches() called with:",{overlayCount:e.length,patchCount:t.overlayPatches.length,patches:t.overlayPatches});const n=Tc("styles.patch",(()=>function(e,t){if(!t||0===t.length)return e;console.log("[RulesEngine] 🎨 Applying overlay patches:",{overlayCount:e.length,patchCount:t.length,patches:t.map((e=>({id:e.id,styleKeys:Object.keys(e.style||{})})))});const n=new Map(t.map((e=>[e.id,e])));return e.map((e=>{const t=n.get(e.id);if(!t)return e;console.log("[RulesEngine] 🎯 Applying patch to overlay:",{id:e.id,originalStyle:e.style,originalFinalStyle:e.finalStyle,patch:t.style});const s={...e,style:{...e.style,...t.style},finalStyle:{...e.finalStyle||e.style||{},...t.style}};return console.log("[RulesEngine] ✅ Patched overlay result:",{id:s.id,newStyle:s.style,newFinalStyle:s.finalStyle}),s}))}(e,t.overlayPatches)));console.log("[ModelBuilder] 🎨 Overlay patches applied. Checking title_overlay:");const s=n.find((e=>"title_overlay"===e.id));return s&&console.log("[ModelBuilder] 🎯 Title overlay after patching:",{id:s.id,color:s.style?.color,status_indicator:s.style?.status_indicator}),n}_resolveValueMaps(e){Tc("value_map.subst",(()=>{return t=e,n={getEntity:e=>this.systems.entityRuntime.getEntity(e)},Tc("value_map.resolve",(()=>{let e=0,s=0;for(const e of t)e.finalStyle&&(e.finalStyle=r(e.finalStyle));function r(t){if(!t||"object"!=typeof t)return t;if(t.value_map&&1===Object.keys(t).length){const r=function(t){try{const r=t.entity;if(!r)return s++,i(t);const o=n?.getEntity?n.getEntity(r):null;if(!o)return s++,i(t);let a=o.state;t.attribute&&o.attributes&&(a=o.attributes[t.attribute]);let l=Number(a);if(!Number.isFinite(l))return s++,i(t);const[c,d]=t.input||[],[u,h]=t.output||[];if(![c,d,u,h].every(Number.isFinite))return s++,i(t);let p=function(e,t,n,s,r,i){if(n===t)return s;let o=(e-t)/(n-t);return i&&(o<0?o=0:o>1&&(o=1)),s+o*(r-s)}(l,c,d,u,h,!!t.clamp);if(Number.isFinite(t.round)){const e=Math.pow(10,t.round);p=Math.round(p*e)/e}return e++,p}catch{return s++,i(t)}}(t.value_map);return r}if(Array.isArray(t))return t.map(r);const o={};for(const e of Object.keys(t))o[e]=r(t[e]);return o}function i(e){return e&&Number.isFinite(e.default)?e.default:Array.isArray(e?.output)&&Number.isFinite(e.output[0])?e.output[0]:1}Dc("value_map.resolve.count",e),Dc("value_map.fail.count",s)}));var t,n}))}_processAnimations(e,t){const n=function(e,t,n){const s=[],r=function(e){const t=new Map;return(e||[]).forEach((e=>{e.ref&&(t.has(e.ref)||t.set(e.ref,[]),t.get(e.ref).push(e))})),t.forEach((e=>e.sort(((e,t)=>(t.priority||0)-(e.priority||0))))),t}(n);for(const n of e){const e=n._raw||n.raw||{};if(!e.animation_ref)continue;const i=t.get(e.animation_ref);if(!i)continue;let o={};i.params&&(o=Xc(o,i.params)),e.animation_override?.params&&(o=Xc(o,e.animation_override.params));const a=r.get(e.animation_ref);if(a&&a.length)for(const e of a){e.override?.params&&(o=Xc(o,e.override.params));break}s.push({key:`overlay:${n.id}:${e.animation_ref}`,preset:i.preset,params:o,targets:[`#${n.id}`],ref:e.animation_ref,overlayId:n.id})}for(const[e,n]of t.entries())n.targets&&s.push({key:`standalone:${e}`,preset:n.preset,params:n.params||{},targets:Array.isArray(n.targets)?n.targets.slice():[n.targets],ref:e});return s}(e,this.animationIndex,t.animations),s=function(e=[]){return e.map((e=>{const t={...e.globals||{}},n=(e.steps||[]).map((e=>({targets:e.targets,preset:e.preset,params:Xc({},e.params||{}),offset:e.offset})));return{id:e.id,globals:t,steps:n}}))}(this.timelineDefs),r=[];n.forEach((e=>{const t=this.systems.animRegistry.getOrCreateInstance(e.definition,e.targets);t&&r.push({id:e.id,instance:t,hash:this.systems.animRegistry.computeInstanceHash(e.definition)})}));const i={active:r},o={active:s},a=new Map;return i.active.forEach((e=>{e.overlayId&&a.set(e.overlayId,e.hash)})),e.forEach((e=>{const t=a.get(e.id);t&&(e.animation_hash=t)})),{activeAnimations:r,animDiff:i,tlDiff:o}}destroy(){if(this._overlayUnsubscribers){console.log(`[MSD v1] Cleaning up ${this._overlayUnsubscribers.size} overlay subscriptions`);for(const[e,t]of this._overlayUnsubscribers)t.forEach((t=>{try{t()}catch(t){console.warn(`[MSD v1] Error unsubscribing overlay ${e}:`,t)}}));this._overlayUnsubscribers.clear()}}_subscribeTextOverlaysToDataSources(e){e.forEach((e=>{if("text"===e.type){const t=e.text||e.content||e.finalStyle?.value||"",n=e.data_source||e._raw?.data_source||e.finalStyle?.data_source,s=this._extractDataSourceReferences(t);n&&this._subscribeTextOverlayToDataSource(e.id,n),s.forEach((t=>{this._subscribeTextOverlayToDataSource(e.id,t)}))}}))}_subscribeTextOverlayToDataSource(e,t){try{const n=this.systems?.dataSourceManager;if(!n)return void console.warn(`[ModelBuilder] DataSourceManager not available for text overlay subscription: ${e}`);const s=t.split(".")[0],r=n.getSource(s);if(!r)return void console.warn(`[ModelBuilder] DataSource '${s}' not found for text overlay: ${e}`);const i=t=>{console.log(`[ModelBuilder] 📊 Text overlay ${e} received DataSource update from ${s}`),this.systems.renderer&&this.systems.renderer.updateOverlayData&&this.systems.renderer.updateOverlayData(e,t)};r.subscribe(e,i),console.log(`[ModelBuilder] ✅ Subscribed text overlay ${e} to DataSource ${s}`)}catch(n){console.error(`[ModelBuilder] Failed to subscribe text overlay ${e} to DataSource ${t}:`,n)}}_extractDataSourceReferences(e){if(!e||"string"!=typeof e)return[];const t=[],n=/\{([^}]+)\}/g;let s;for(;null!==(s=n.exec(e));){const e=s[1].split(":")[0].trim();if(e.includes(".")||/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e)){const n=e.split(".")[0];t.includes(n)||t.push(n)}}return t}}class Kc{static getOverlaysSvg(e){return e?.querySelector?.("#msd_svg_overlays svg")||e?.querySelector?.("#cblcars-msd-wrapper svg")||null}static listOverlays(e){const t=[],n=this.getOverlaysSvg(e);if(!n)return t;const s=e.__msdResolvedModel||{},r=new Map((s.overlays||[]).map((e=>[e.id,e])));let i=Array.from(n.querySelectorAll('[id][data-cblcars-root="true"]'));i.length||(i=Array.from(n.querySelectorAll("[id]")).filter((e=>e.id&&"cblcars-debug-layer"!==e.id&&"cblcars-highlight-layer"!==e.id)));for(const n of i){const s=n.id,i=r.get(s),o=this.getOverlayBBox(s,e);t.push({id:s,type:i?.type||n.getAttribute?.("data-cblcars-type")||n.tagName?.toLowerCase()||"unknown",bbox:o,hasErrors:!1,hasWarnings:!1,element:n,config:i})}return t}static getOverlayBBox(e,t){if(!e||!t)return null;let n=t.getElementById?.(e);if(n&&"function"==typeof n.getBBox)try{const e=n.getBBox();if(e&&Number.isFinite(e.width)&&Number.isFinite(e.height))return{x:e.x,y:e.y,w:e.width,h:e.height}}catch(e){}const s=t.getElementById?.(`${e}_backdrop`);if(s&&"function"==typeof s.getBBox)try{const e=s.getBBox();if(e&&(e.width>0||e.height>0))return{x:e.x,y:e.y,w:e.width,h:e.height}}catch(e){}const r=t.__msdResolvedModel||{},i=r.overlays?.find((t=>t.id===e));if(i&&i.position&&i.size){const e=r.anchors||{},t=r.viewBox||[0,0,100,100],n=this.resolvePointFromConfig(i.position,e,t),s=this.resolveSizeFromConfig(i.size,t);if(n&&s)return{x:n[0],y:n[1],w:s.w,h:s.h}}return null}static highlight(e,t={}){const n=Array.isArray(e)?e:[e],s=t.root;if(!s)return void console.warn("[MsdIntrospection] Root element required for highlighting");const r=this.getOverlaysSvg(s);if(!r)return void console.warn("[MsdIntrospection] No SVG found for highlighting");const i=this.getViewBox(s,r)||[0,0,400,200],o=t.color||"#ffcc00",a=Number.isFinite(t.strokeWidth)?t.strokeWidth:Math.max(1.5,Math.round(.004*i[3])),l=Math.max(250,t.duration||1500),c=s.ownerDocument||s.document;if(!c||!c.createElementNS)return void console.warn("[MsdIntrospection] createElementNS not available");let d=r.querySelector("#cblcars-highlight-layer");d||(d=c.createElementNS("http://www.w3.org/2000/svg","g"),d.setAttribute("id","cblcars-highlight-layer"),d.style.pointerEvents="none",r.appendChild(d)),d.innerHTML="";for(const e of n){const t=this.getOverlayBBox(e,s);if(t){const e=c.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("x",t.x),e.setAttribute("y",t.y),e.setAttribute("width",t.w),e.setAttribute("height",t.h),e.setAttribute("fill","none"),e.setAttribute("stroke",o),e.setAttribute("stroke-width",a),e.setAttribute("opacity","0.9"),d.appendChild(e)}}setTimeout((()=>{d&&d.parentNode&&(d.innerHTML="")}),l)}static getViewBox(e,t){if(!t)return null;const n=t.getAttribute("viewBox");if(n){const e=n.split(/\s+/).map(Number);if(4===e.length)return e}return[0,0,400,200]}static resolvePointFromConfig(e,t={},n=[0,0,400,200]){const[s,r,i,o]=n;if(!e)return null;if("string"==typeof e&&t[e])return t[e];if(Array.isArray(e)&&2===e.length){const t=(e,t)=>"string"==typeof e&&e.trim().endsWith("%")?"x"===t?s+parseFloat(e)/100*i:r+parseFloat(e)/100*o:Number(e),n=t(e[0],"x"),a=t(e[1],"y");if(Number.isFinite(n)&&Number.isFinite(a))return[n,a]}return null}static resolveSizeFromConfig(e,t=[0,0,400,200]){if(!Array.isArray(e)||2!==e.length)return null;const[,,n,s]=t,r=(e,t)=>"string"==typeof e&&e.trim().endsWith("%")?parseFloat(e)/100*t:Number(e),i=r(e[0],n),o=r(e[1],s);return Number.isFinite(i)&&Number.isFinite(o)?{w:i,h:o}:null}}async function Zc(e){return Tc("cardModel.build",(()=>{const t=e.overlays.map((e=>({id:e.id,type:e.type,style:e.style||{},raw:e})));return{viewBox:[0,0,400,200],anchors:{},overlaysBase:t,__raw:e}}))}class Qc{static attach(){"undefined"!=typeof window&&(window.cblcars=window.cblcars||{},window.cblcars.msd=window.cblcars.msd||{},window.cblcars.msd.api={overlays:{list:e=>this.listOverlays(e),highlight:(e,t)=>this.highlightOverlays(e,t),getBBox:(e,t)=>this.getOverlayBBox(e,t),update:(e,t)=>this.updateOverlay(e,t)},anchors:{list:()=>this.listAnchors(),get:e=>this.getAnchor(e),set:(e,t,n)=>this.setAnchor(e,t,n),dump:()=>this.dumpAnchors()},debug:{enable:e=>this.enableDebugFeature(e),disable:e=>this.disableDebugFeature(e),toggle:e=>this.toggleDebugFeature(e),setScale:e=>this.setDebugScale(e),status:()=>this.getDebugStatus(),showAnchors:()=>{console.warn('[MsdApi] debug.showAnchors deprecated, use debug.enable("anchors")'),this.enableDebugFeature("anchors")},showOverlays:()=>{console.warn('[MsdApi] debug.showOverlays deprecated, use debug.enable("bounding_boxes")'),this.enableDebugFeature("bounding_boxes")},clear:()=>{console.warn('[MsdApi] debug.clear deprecated, use debug.disable("all")'),this.disableDebugFeature("all")}},performance:{dump:()=>this.getPerformanceData(),counters:()=>this.getPerformanceData().counters||{},timers:()=>this.getPerformanceData().timers||{}},pipeline:{getResolvedModel:()=>this.getResolvedModel(),reRender:()=>this.reRender(),validate:()=>this.getValidationIssues()}},window.cblcars.msd.listOverlays=e=>this.listOverlays(e),window.cblcars.msd.listAnchors=()=>this.listAnchors(),window.cblcars.msd.getOverlayBBox=(e,t)=>this.getOverlayBBox(e,t),window.cblcars.msd.highlight=(e,t)=>this.highlightOverlays(e,t))}static getWindow(){return"undefined"!=typeof window?window:void 0!==n.g&&n.g.window?n.g.window:null}static listOverlays(e){try{const t=this.getWindow(),n=t?.MsdIntrospection;if(n&&n.listOverlays)return n.listOverlays(e);const s=[],r=this.getResolvedModel();return r&&r.overlays&&r.overlays.forEach((t=>{s.push({id:t.id,type:t.type,bbox:this.getOverlayBBox(t.id,e),hasErrors:!1,hasWarnings:!1})})),s}catch(e){return[]}}static listAnchors(){try{const e=this.getResolvedModel();return Object.keys(e?.anchors||{})}catch(e){return[]}}static getAnchor(e){try{const t=this.getResolvedModel();return t?.anchors?.[e]||null}catch(e){return null}}static dumpAnchors(){try{const e=this.getResolvedModel();return{...e?.anchors}||{}}catch(e){return{}}}static getOverlayBBox(e,t){try{const n=this.getWindow(),s=n?.MsdIntrospection;if(s&&s.getOverlayBBox)return s.getOverlayBBox(e,t);const r=this.getResolvedModel(),i=r?.overlays?.find((t=>t.id===e));if(i&&i.position&&i.size){const e=Array.isArray(i.position)?i.position:[0,0],t=Array.isArray(i.size)?i.size:[100,50];return{x:Number(e[0])||0,y:Number(e[1])||0,w:Number(t[0])||100,h:Number(t[1])||50}}return null}catch(e){return null}}static highlightOverlays(e,t){try{const n=this.getWindow(),s=n?.MsdIntrospection;if(s&&s.highlight)return s.highlight(e,t);console.log("[MSD API] Highlight request:",e,t)}catch(e){}}static getResolvedModel(){try{const e=this.getWindow();return e?.__msdDebug?.pipelineInstance?.getResolvedModel?.()||null}catch(e){return null}}static getPerformanceData(){try{const e=this.getWindow();return e?.__msdDebug?.getPerf?.()||{timers:{},counters:{}}}catch(e){return{timers:{},counters:{}}}}static getValidationIssues(){try{const e=this.getWindow();return e?.__msdDebug?.validation?.issues?.()||[]}catch(e){return[]}}static setDebugFlag(e,t){try{const n=this.getWindow();n.cblcars=n.cblcars||{},n.cblcars._debugFlags=n.cblcars._debugFlags||{},n.cblcars._debugFlags[e]=t}catch(e){}}static clearDebugFlags(){try{const e=this.getWindow();e.cblcars=e.cblcars||{},e.cblcars._debugFlags={overlay:!1,connectors:!1,geometry:!1}}catch(e){}}static updateOverlay(e,t){return console.warn("[MSD API] Dynamic overlay updates not yet implemented"),!1}static setAnchor(e,t,n){try{const s=this.getWindow(),r=s?.__msdDebug?.pipelineInstance?.setAnchor?.(e,[t,n]);return r||{id:e,position:[t,n]}}catch(e){return null}}static reRender(){try{const e=this.getWindow();return e?.__msdDebug?.pipelineInstance?.reRender?.()||{success:!1}}catch(e){return{success:!1}}}static enableDebugFeature(e){const t=this.getDebugManager();t&&("all"===e?t.enableMultiple(["anchors","bounding_boxes","routing","performance"]):t.enable(e))}static disableDebugFeature(e){const t=this.getDebugManager();t&&("all"===e?t.disableMultiple(["anchors","bounding_boxes","routing","performance"]):t.disable(e))}static toggleDebugFeature(e){const t=this.getDebugManager();t&&t.toggle(e)}static setDebugScale(e){const t=this.getDebugManager();t&&t.setScale(e)}static getDebugStatus(){const e=this.getDebugManager();return e?e.getSnapshot():{error:"DebugManager not available"}}static getDebugManager(){const e=this.getWindow();return e?.__msdDebug?.debugManager||e?.__msdDebug?.pipelineInstance?.systemsManager?.debugManager}}function ed(e){if(!e||"object"!=typeof e)return e;const{__meta:t,...n}=e;return n}function td(e){const t=e.__raw_msd||{};function n(t){return(e[t]||[]).filter((e=>"user"===e.__meta?.origin_pack&&!e.__meta.removed)).map(ed)}const s={msd:{version:t.version||1,base_svg:t.base_svg,view_box:t.view_box,use_packs:t.use_packs,anchors:t.anchors,palettes:t.palettes,remove:t.remove,profiles:n("profiles"),animations:n("animations"),timelines:n("timelines"),overlays:n("overlays"),rules:n("rules"),routing:t.routing,active_profiles:t.active_profiles,hud:t.hud}};return Object.keys(s.msd).forEach((e=>{null==s.msd[e]||Array.isArray(s.msd[e])&&!s.msd[e].length?delete s.msd[e]:"object"!=typeof s.msd[e]||Array.isArray(s.msd[e])||Object.keys(s.msd[e]).length||delete s.msd[e]})),s}function nd(e,t={}){const n=!!t.include_meta;function s(t){return(e[t]||[]).filter((e=>!e.__meta?.removed)).map((e=>function(e,t){if(t)return e;if(!e||"object"!=typeof e)return e;const{__meta:n,...s}=e;return s}(e,n)))}return{msd:{version:e.__raw_msd&&e.__raw_msd.version||1,base_svg:e.__raw_msd?.base_svg,view_box:e.__raw_msd?.view_box,use_packs:e.__raw_msd?.use_packs,anchors:e.__raw_msd?.anchors,palettes:e.palettes,remove:e.__raw_msd?.remove,profiles:s("profiles"),animations:s("animations"),timelines:s("timelines"),overlays:s("overlays"),rules:s("rules"),routing:e.routing,active_profiles:e.active_profiles,hud:e.hud,__provenance:n?e.__provenance:void 0,__issues:n?e.__issues:void 0}}}function sd(e){if(!e)return null;const t={...e};return delete t.__meta,JSON.parse(function(e){const t=new WeakSet;return function e(n){return null===n||"object"!=typeof n?JSON.stringify(n):t.has(n)?'"[Circular]"':(t.add(n),Array.isArray(n)?"["+n.map(e).join(",")+"]":"{"+Object.keys(n).sort().map((t=>JSON.stringify(t)+":"+e(n[t]))).join(",")+"}")}(e)}(t))}async function rd(e,t,n=null){const{mergedConfig:s,issues:r,provenance:i}=await async function(e){const t=await Ol(e),n=t.__provenance;"undefined"!=typeof window&&(window.__msdDebug=window.__msdDebug||{},window.__msdDebug._originalUserConfig=e);const s=performance.now(),r=function(e){const t={errors:[],warnings:[]};return e&&"object"==typeof e?(function(e,t){if(e.version?"number"==typeof e.version&&1===e.version||t.errors.push({code:"version.invalid",message:"Version must be 1 (only supported version)"}):t.warnings.push({code:"version.missing",message:"Missing version field - assuming version 1"}),void 0!==e.view_box){const n=e.view_box;"auto"===n||Array.isArray(n)&&4===n.length&&n.every((e=>"number"==typeof e))||t.errors.push({code:"view_box.invalid",message:'view_box must be "auto" or array of 4 numbers [x, y, width, height]'})}}(e,t),function(e,t){e.anchors&&Object.entries(e.anchors).forEach((([e,n])=>{Array.isArray(n)&&2===n.length?n.forEach(((n,s)=>{const r=0===s?"x":"y";"string"==typeof n?n.endsWith("%")&&!isNaN(parseFloat(n.slice(0,-1)))||t.errors.push({code:"anchor.coordinates.invalid",anchor_id:e,message:`Anchor '${e}' ${r}-coordinate '${n}' must be number or percentage string`}):"number"!=typeof n&&t.errors.push({code:"anchor.coordinates.invalid",anchor_id:e,message:`Anchor '${e}' ${r}-coordinate must be number or percentage string`})})):t.errors.push({code:"anchor.coordinates.invalid",anchor_id:e,message:`Anchor '${e}' coordinates must be array of 2 elements [x, y]`})}))}(e,t),function(e,t){if(!e.overlays)return;const n=new Set(Object.keys(e.anchors||{}));e.overlays.forEach((e=>{e&&e.id&&n.add(e.id)})),e.overlays.forEach((s=>{s.id?(s.type||t.errors.push({code:"overlay.type.missing",overlay_id:s.id,message:`Overlay '${s.id}' missing required type field`}),["anchor","attach_to"].forEach((e=>{s[e]&&("string"!=typeof s[e]||n.has(s[e])?Array.isArray(s[e])&&jl(s[e],t,`Overlay '${s.id}' ${e}`):t.errors.push({code:"anchor.missing",collection:"overlays",item_id:s.id,anchor:s[e],message:`Overlay '${s.id}' references missing anchor '${s[e]}'`}))})),s.position&&Array.isArray(s.position)&&jl(s.position,t,`Overlay '${s.id}' position`),s.animation_ref&&e.animations&&(e.animations.some((e=>e.id===s.animation_ref))||t.errors.push({code:"animation.missing",overlay_id:s.id,animation_ref:s.animation_ref,message:`Overlay '${s.id}' references missing animation '${s.animation_ref}'`}))):t.errors.push({code:"id.missing",collection:"overlays",message:"Overlay missing required id field"})}))}(e,t),function(e,t){e.rules&&e.rules.forEach((e=>{if(!e.id)return void t.errors.push({code:"id.missing",collection:"rules",message:"Rule missing required id field"});if(!e.when)return void t.errors.push({code:"rule.when.missing",rule_id:e.id,message:`Rule '${e.id}' missing required when conditions`});const n=Array.isArray(e.when.all),s=Array.isArray(e.when.any);n||s||t.errors.push({code:"rule.when.invalid",rule_id:e.id,message:`Rule '${e.id}' when must have 'all' or 'any' array of conditions`}),[...e.when.all||[],...e.when.any||[]].forEach((n=>{if(n.time_between&&(/^\d{2}:\d{2}-\d{2}:\d{2}$/.test(n.time_between)||t.errors.push({code:"rule.time_between.invalid",rule_id:e.id,message:`Rule '${e.id}' time_between must be format "HH:MM-HH:MM"`})),n.regex)try{new RegExp(n.regex)}catch(n){t.warnings.push({code:"rule.regex.invalid",rule_id:e.id,message:`Rule '${e.id}' has invalid regex pattern - rule will be ignored`})}})),void 0===e.priority||Number.isInteger(e.priority)||t.errors.push({code:"rule.priority.invalid",rule_id:e.id,message:`Rule '${e.id}' priority must be an integer`})}))}(e,t),function(e,t){e.animations&&e.animations.forEach((e=>{e.id?(e.preset||t.errors.push({code:"animation.preset.missing",animation_id:e.id,message:`Animation '${e.id}' missing required preset field`}),e.params?.duration&&"number"!=typeof e.params.duration&&t.errors.push({code:"animation.duration.invalid",animation_id:e.id,message:`Animation '${e.id}' duration must be a number (milliseconds)`})):t.errors.push({code:"id.missing",collection:"animations",message:"Animation missing required id field"})}))}(e,t),function(e,t){if(e.profiles&&(e.profiles.forEach((e=>{e.id||t.errors.push({code:"id.missing",collection:"profiles",message:"Profile missing required id field"})})),e.active_profiles))if(Array.isArray(e.active_profiles)){const n=new Set((e.profiles||[]).map((e=>e.id)));e.active_profiles.forEach((e=>{n.has(e)||t.warnings.push({code:"profile.missing",profile_id:e,message:`active_profiles references missing profile '${e}'`})}))}else t.errors.push({code:"active_profiles.invalid",message:"active_profiles must be an array of profile IDs"})}(e,t),function(e,t){e.palettes&&Object.entries(e.palettes).forEach((([e,n])=>{("object"!=typeof n||Array.isArray(n))&&t.errors.push({code:"palette.tokens.invalid",palette_name:e,message:`Palette '${e}' tokens must be an object`})}))}(e,t),function(e,t){if(!e.routing)return;const n=e.routing;void 0!==n.clearance&&"number"!=typeof n.clearance&&t.errors.push({code:"routing.clearance.invalid",message:"routing.clearance must be a number"}),void 0!==n.grid_resolution&&"number"!=typeof n.grid_resolution&&t.errors.push({code:"routing.grid_resolution.invalid",message:"routing.grid_resolution must be a number"}),void 0!==n.smoothing_mode&&(["none","chaikin"].includes(n.smoothing_mode)||t.warnings.push({code:"routing.smoothing_mode.invalid",message:`routing.smoothing_mode '${n.smoothing_mode}' invalid, using 'none'`}))}(e,t),function(e,t){["overlays","rules","animations","profiles","timelines"].forEach((n=>{const s=e[n]||[],r=new Set;s.forEach(((e,s)=>{e&&e.id?r.has(e.id)?t.errors.push({code:"duplicate.id",collection:n,id:e.id,message:`Duplicate ${n} ID: ${e.id}`}):r.add(e.id):t.errors.push({code:"id.missing",collection:n,index:s,message:`Missing id in ${n} item at index ${s}`})}))}))}(e,t),t):(t.errors.push({code:"config.invalid",message:"Configuration must be an object"}),t)}(t);t.__issues=r;const i=performance.now();try{window.__msdDebug&&(window.__msdDebug._validationMs=i-s)}catch{}try{const e=new Set(r.errors.map((e=>e.code))),n=new Set(Object.keys(t.anchors||{})),s=new Set;(t.overlays||[]).forEach((e=>{e&&e.id&&(s.add(e.id),n.add(e.id))})),(t.overlays||[]).forEach((t=>{if(!t||!t.id)return;const s=[];"string"==typeof t.anchor&&s.push(t.anchor),"string"==typeof t.attach_to&&s.push(t.attach_to),"string"==typeof t.attachTo&&s.push(t.attachTo),s.forEach((s=>{if(s&&!n.has(s)){const n="anchor.missing";e.has(`${n}:${s}:${t.id}`)||(r.errors.push({code:n,severity:"error",overlay:t.id,anchor:s,msg:`Overlay ${t.id} references missing anchor '${s}'`}),e.add(`${n}:${s}:${t.id}`))}}))}))}catch(e){}return{mergedConfig:t,issues:r,provenance:n}}(e);if(r.errors.length)return console.error("[MSD v1] Validation errors – pipeline disabled",r.errors),function(e,t,n){const s={enabled:!1,errors:t.errors,warnings:t.warnings,getResolvedModel:()=>null,ingestHass:()=>{},updateEntities:()=>{},listEntities:()=>[],getEntity:()=>null,getActiveProfiles:()=>[],getAnchors:()=>e.anchors||{},repairAnchorsFromMerged:()=>!1,exportCollapsed:()=>null,exportCollapsedJson:()=>"null",exportFullSnapshot:()=>null,exportFullSnapshotJson:()=>"null",diffItem:()=>null,getPerf:()=>({})};return"undefined"!=typeof window&&(window.__msdDebug=window.__msdDebug||{},window.__msdDebug.validation={issues:()=>e.__issues},window.__msdDebug.pipelineInstance=s,window.__msdDebug._provenance=n),s}(s,r,i);const o=await Zc(s);o.anchors||(o.anchors={}),Object.keys(o.anchors).length||s.anchors&&Object.keys(s.anchors).length&&(o.anchors={...s.anchors},console.info("[MSD v1] Adopted user anchors"));const a=new qc;if(await a.initializeSystems(s,o,t,n),n&&a.setOriginalHass(n),"undefined"!=typeof window&&(window.__msdDebug=window.__msdDebug||{},window.__msdDebug.debugManager=a.debugManager,window.__msdDebug.routing=a.router,window.__msdDebug.pipelineInstance={systemsManager:a,dataSourceManager:a.dataSourceManager},console.log("[MSD v1] Essential subsystems ready for overlay rendering:",{hasSystemsManager:!!a,hasDataSourceManager:!!a.dataSourceManager,dataSourceCount:a.dataSourceManager?.listIds?.()?.length||0})),a.dataSourceManager||console.warn("[MSD v1] DataSourceManager not available - overlay template processing will be limited"),"undefined"!=typeof window){window.__msdDebug=window.__msdDebug||{},window.__msdDebug.routing||(window.__msdDebug.routing=a.router),window.__msdDebug.getPerf||(window.__msdDebug.getPerf=()=>Ec()),window.__msdDebug.systemsManager||(window.__msdDebug.systemsManager=a);try{window.dispatchEvent(new CustomEvent("msd-routing-ready"))}catch(e){}}const l=new Jc(s,o,a);async function c(){if(console.log("[MSD DEBUG] 🔄 reRender() ENTRY",{timestamp:(new Date).toISOString(),renderInProgress:a._renderInProgress,stackTrace:(new Error).stack.split("\n").slice(1,4).join("\n")}),a._renderInProgress)return console.log("[MSD DEBUG] 🕐 Render in progress, queueing re-render"),a._queuedReRender=!0,{success:!1,reason:"render_in_progress",queued:!0};a._renderInProgress=!0,a._queuedReRender=!1;try{console.log("[MSD DEBUG] 📊 Computing resolved model...");const e=performance.now(),n=l.computeResolvedModel();let s;console.log("[MSD DEBUG] ✅ Resolved model computed:",{overlayCount:n.overlays.length,controlOverlays:n.overlays.filter((e=>"control"===e.type)).length,hasAnchors:!!n.anchors,hasViewBox:!!n.viewBox}),console.log(`[MSD DEBUG] 🎨 Starting AdvancedRenderer.render() - overlays: ${n.overlays.length}`);try{s=a.renderer.render(n),console.log("[MSD DEBUG] ✅ AdvancedRenderer.render() completed successfully:",s)}catch(e){return console.error("[MSD DEBUG] ❌ AdvancedRenderer.render() FAILED:",e),console.error("[MSD DEBUG] ❌ Render error stack:",e.stack),{success:!1,error:e.message,phase:"advanced_renderer"}}console.log("[MSD DEBUG] 🎮 Starting renderDebugAndControls()...");try{await a.renderDebugAndControls(n,t),console.log("[MSD DEBUG] ✅ renderDebugAndControls() completed successfully")}catch(e){console.error("[MSD DEBUG] ❌ renderDebugAndControls() FAILED:",e),console.error("[MSD DEBUG] ❌ Debug/Controls error stack:",e.stack),console.warn("[MSD DEBUG] ⚠️ Continuing without debug/controls rendering due to error")}const r=performance.now()-e;return console.log(`[MSD DEBUG] ✅ reRender() COMPLETED in ${r.toFixed(2)}ms`),s||{success:!0}}catch(e){return console.error("[MSD DEBUG] ❌ reRender() COMPLETELY FAILED:",e),console.error("[MSD DEBUG] ❌ Complete failure stack:",e.stack),{success:!1,error:e.message}}finally{a._renderInProgress=!1,console.log("[MSD DEBUG] 🏁 reRender() FINALLY block - _renderInProgress reset to false"),a._queuedReRender&&(console.log("[MSD DEBUG] 🔄 Executing queued re-render"),a._queuedReRender=!1,setTimeout((()=>c()),50))}}a.modelBuilder=l,a.setReRenderCallback(c),console.log("[MSD v1] Computing initial resolved model"),console.log("[MSD v1] DataSourceManager status:",{sourcesCount:a.dataSourceManager?.getAllSources?.()?.length||0,entityCount:a.dataSourceManager?.listIds?.()?.length||0});const d=await c();console.log("[MSD v1] Initial render completed:",{overlayCount:d?.overlayCount||0,errors:d?.errors||0});const u=id(s,o,a,l,c);if(function(e,t,n,s,r){if("undefined"==typeof window)return;const i=window.__msdDebug=window.__msdDebug||{},o=t?.debug||{};console.log("[MSD v1] Debug interface ready - type window.__msdDebug.help() for usage"),i.pipelineInstance=e,i.hasOwnProperty("pipeline")||Object.defineProperty(i,"pipeline",{get(){return console.warn("[MSD Debug] window.__msdDebug.pipeline is deprecated. Use window.__msdDebug.pipelineInstance instead."),this.pipelineInstance},configurable:!0}),i._provenance=n,function(e,t,n){e.routing={inspect:e=>t.routingInspect(e),invalidate:(e="*")=>n.router.invalidate(e),stats:()=>{try{return n.router.stats?.()||{cacheHits:0,pathsComputed:0,invalidations:0}}catch(e){return console.warn("[MSD v1] routing.stats failed:",e),{cacheHits:0,pathsComputed:0,invalidations:0,error:e.message}}},inspectAs:(s,r="smart")=>{try{const i=t.getResolvedModel?.();if(!i)return null;const o=i.overlays.find((e=>e.id===s));if(!o)return null;o._raw=o._raw||{};const a=o._raw.route_mode_full;o._raw.route_mode_full=r,n.router.invalidate&&n.router.invalidate("*");const l=e.routing.inspect(s);return o._raw.route_mode_full=a,n.router.invalidate&&n.router.invalidate("*"),l}catch(e){return console.warn("[MSD v1] inspectAs failed",e),null}}}}(i,e,s),function(e,t){if(e.hasOwnProperty("dataSources"))try{Object.assign(e.dataSources,{list:()=>t.dataSourceManager?Array.from(t.dataSourceManager.sources.keys()):[],get:e=>t.dataSourceManager?.getSource(e)?.getStats()||null,dump:()=>t.dataSourceManager?.debugDump()||{error:"DataSourceManager not initialized"}})}catch(n){e.dataSourcesDebug={stats:()=>t.dataSourceManager?.getStats()||{error:"DataSourceManager not initialized"},list:()=>t.dataSourceManager?Array.from(t.dataSourceManager.sources.keys()):[],get:e=>t.dataSourceManager?.getSource(e)?.getStats()||null,dump:()=>t.dataSourceManager?.debugDump()||{error:"DataSourceManager not initialized"},manager:()=>t.dataSourceManager},console.log("[DebugInterface] Created dataSourcesDebug as alternative access due to getter conflict")}else e.dataSources={stats:()=>t.dataSourceManager?.getStats()||{error:"DataSourceManager not initialized"},list:()=>t.dataSourceManager?Array.from(t.dataSourceManager.sources.keys()):[],get:e=>t.dataSourceManager?.getSource(e)?.getStats()||null,dump:()=>t.dataSourceManager?.debugDump()||{error:"DataSourceManager not initialized"},manager:()=>t.dataSourceManager};e.entities={list:()=>(console.warn("[MSD Debug] entities.list() is deprecated. Use window.__msdDebug.dataSourceManager.listIds() instead."),t.dataSourceManager?.listIds()||[]),get:e=>(console.warn("[MSD Debug] entities.get() is deprecated. Use window.__msdDebug.dataSourceManager.getEntity() instead."),t.dataSourceManager?.getEntity(e)||null),stats:()=>{console.warn("[MSD Debug] entities.stats() is deprecated. Use window.__msdDebug.dataSources.stats() instead.");const e=t.dataSourceManager?.getStats()||{};return{count:t.dataSourceManager?.listIds()?.length||0,subscribed:Object.keys(e.sources||{}).length,updated:Object.values(e.sources||{}).reduce(((e,t)=>e+(t.received||0)),0),cacheHits:Object.values(e.sources||{}).reduce(((e,t)=>e+(t.cacheHits||0)),0)}}}}(i,s),function(e,t,n,s,r){const i=t.debugManager;e.debug={enable:e=>{"all"===e?i.enableMultiple(["anchors","bounding_boxes","routing","performance"]):i.enable(e),setTimeout((()=>{try{const t=window.__msdDebug?.pipelineInstance;t?.reRender&&(console.log("[MSD Debug] Force re-render after enable:",e),t.reRender())}catch(e){console.warn("[MSD Debug] Failed to trigger re-render:",e)}}),10)},disable:e=>{"all"===e?i.disableMultiple(["anchors","bounding_boxes","routing","performance"]):i.disable(e),setTimeout((()=>{try{const t=window.__msdDebug?.pipelineInstance;t?.reRender&&(console.log("[MSD Debug] Force re-render after disable:",e),t.reRender())}catch(e){console.warn("[MSD Debug] Failed to trigger re-render:",e)}}),10)},testRender:()=>{console.log("[MSD Debug] Testing debug render directly...");try{const e=i.getSnapshot();console.log("[MSD Debug] Current state:",e);const t=window.__msdDebug?.pipelineInstance;if(!t)return void console.warn("[MSD Debug] No pipeline instance available");const n=t.systemsManager;if(!n)return void console.warn("[MSD Debug] No systems manager available");const s=n.renderer?.mountEl;if(!s)return void console.warn("[MSD Debug] No mount element found in renderer");console.log("[MSD Debug] Found mount element:",s.constructor.name);const r=t.getResolvedModel();if(!r)return void console.warn("[MSD Debug] No resolved model available");console.log("[MSD Debug] Calling renderDebugAndControls with shadowRoot context"),n.renderDebugAndControls(r,s)}catch(e){console.error("[MSD Debug] testRender failed:",e)}},setScale:e=>i.setScale(e),status:()=>{const e=i.getSnapshot();return console.table(e),e},getStatus:()=>i.getSnapshot(),onChange:e=>i.onChange(e),refresh:()=>{try{const e=window.__msdDebug?.pipelineInstance;e?.reRender&&(e.reRender(),console.log("[MSD Debug] Debug overlays refreshed"))}catch(e){console.warn("[MSD Debug] Failed to trigger pipeline re-render:",e)}},anchors:{show:()=>i.enable("anchors"),hide:()=>i.disable("anchors"),toggle:()=>i.toggle("anchors")},bounding:{show:()=>i.enable("bounding_boxes"),hide:()=>i.disable("bounding_boxes"),toggle:()=>i.toggle("bounding_boxes"),test:e=>{const n=window.__msdDebug?.pipelineInstance;if(!n)return console.warn("[MSD Debug] No pipeline instance available"),null;const s=n.getResolvedModel?.();if(!s)return console.warn("[MSD Debug] No resolved model available"),null;const r=s.overlays.find((t=>t.id===e));if(!r)return console.warn(`[MSD Debug] Overlay "${e}" not found`),null;const i=t.debugRenderer;if(!i)return console.warn("[MSD Debug] Debug renderer not available"),null;const o=r.position;if(!o||!Array.isArray(o))return console.warn(`[MSD Debug] Invalid position for overlay "${e}"`),null;const[a,l]=o,c=i._getOverlayDimensions(r,a,l);return console.log(`[MSD Debug] Bounding box test for "${e}":`,{overlay:{id:r.id,type:r.type,position:[a,l]},calculatedDimensions:c,overlayConfig:{text:r.text||r.content||r._raw?.content,style:r.finalStyle||r.style}}),c},compare:e=>{const n=window.__msdDebug?.pipelineInstance;if(!n)return console.warn("[MSD Debug] No pipeline instance available"),null;const s=n.getResolvedModel?.();if(!s)return console.warn("[MSD Debug] No resolved model available"),null;const r=s.overlays.find((t=>t.id===e));if(!r||"text"!==r.type)return console.warn(`[MSD Debug] Text overlay "${e}" not found`),null;const[i,o]=r.position||[0,0],a=t.debugRenderer,l={overlayId:e,position:[i,o],methods:{}};if(a)try{const e=a._getOverlayDimensions(r,i,o);l.methods.debugRenderer=e}catch(e){l.methods.debugRenderer={error:e.message}}try{const e=t.renderer?.mountEl,n=window.cblcars?.TextOverlayRenderer?.computeAttachmentPoints?.(r,s.anchors||{},e);n?.bbox&&(l.methods.textOverlayRenderer={x:n.bbox.left,y:n.bbox.top,width:n.bbox.width,height:n.bbox.height})}catch(e){l.methods.textOverlayRenderer={error:e.message}}try{const n=t.renderer?.mountEl,s=n?.querySelector("svg"),r=s?.querySelector(`[data-overlay-id="${e}"]`);if(r){const e=r.getBBox();l.methods.domGetBBox={x:e.x,y:e.y,width:e.width,height:e.height}}}catch(e){l.methods.domGetBBox={error:e.message}}try{const n=t.renderer?.mountEl,s=n?.querySelector("svg"),r=s?.querySelector(`[data-overlay-id="${e}"]`);if(r){const e=r.getAttribute("data-text-width"),t=r.getAttribute("data-text-height"),n=r.getAttribute("data-font-size"),s=r.getAttribute("data-dominant-baseline"),a=r.getAttribute("data-text-anchor");if(e&&t){let r=o;const c=parseFloat(t),d=parseFloat(n)||16,u=s||"auto";r="hanging"===u?o:"middle"===u||"central"===u?o-c/2:"text-after-edge"===u?o-c:o-.7*d;let h=i;const p=parseFloat(e),g=a||"start";"middle"===g?h=i-p/2:"end"===g&&(h=i-p),l.methods.dataAttributes={x:h,y:r,width:p,height:c,baseline:u,anchor:g}}}}catch(e){l.methods.dataAttributes={error:e.message}}return console.table(l.methods),l}},routing:{show:()=>i.enable("routing"),hide:()=>i.disable("routing"),toggle:()=>i.toggle("routing")},performance:{show:()=>i.enable("performance"),hide:()=>i.disable("performance"),toggle:()=>i.toggle("performance")}},e.renderAdvanced=e=>{try{console.log("[MSD v1] renderAdvanced called - using AdvancedRenderer");const e=n.getResolvedModel();return e?t.renderer.render(e):(console.warn("[MSD v1] renderAdvanced: No resolved model available"),{svgMarkup:""})}catch(e){return console.error("[MSD v1] renderAdvanced failed:",e),{svgMarkup:"",error:e.message}}},e.hud={show:()=>t.hudManager.show(),hide:()=>t.hudManager.hide(),toggle:()=>t.hudManager.toggle(),state:()=>({visible:t.hudManager.state?.visible||!1,activePanel:t.hudManager.state?.activePanel||"unknown",refreshRate:t.hudManager.state?.refreshRate||2e3}),init:()=>{r?.hud?.auto_show&&setTimeout((()=>{t.hudManager.show(),console.log("[MSD v1] HUD auto-shown based on config")}),2e3)}},setTimeout((()=>e.hud.init()),100),e.introspection={listOverlays:e=>Kc.listOverlays(e),getOverlayBBox:(e,t)=>Kc.getOverlayBBox(e,t),highlight:(e,t)=>Kc.highlight(e,t)},e.controls={render:(e,n)=>t.controlsRenderer.renderControls(e,n),relayout:()=>t.controlsRenderer.relayout()},e.help=function(){console.log("\n╔══════════════════════════════════════════════════════════════════════════════╗\n║                          MSD Debug Interface Help                            ║\n╠══════════════════════════════════════════════════════════════════════════════╣\n║ Debug Features:                                                              ║\n║   __msdDebug.debug.enable('anchors')       - Show anchor point markers      ║\n║   __msdDebug.debug.enable('bounding_boxes') - Show overlay bounding boxes   ║\n║   __msdDebug.debug.enable('routing')       - Show routing path visualization║\n║   __msdDebug.debug.enable('performance')   - Show performance metrics       ║\n║   __msdDebug.debug.enable('all')           - Enable all features            ║\n║                                                                              ║\n║   __msdDebug.debug.disable('feature')      - Disable specific feature       ║\n║   __msdDebug.debug.status()                - Show current debug state       ║\n║   __msdDebug.debug.setScale(1.5)           - Set debug element scale        ║\n║   __msdDebug.debug.refresh()               - Force re-render debug overlays ║\n║                                                                              ║\n║ Quick Access:                                                                ║\n║   __msdDebug.debug.anchors.toggle()        - Toggle anchor markers          ║\n║   __msdDebug.debug.bounding.toggle()       - Toggle bounding boxes          ║\n║   __msdDebug.debug.bounding.test('id')     - Test bounding box accuracy     ║\n║   __msdDebug.debug.bounding.compare('id')  - Compare measurement methods    ║\n║   __msdDebug.debug.routing.toggle()        - Toggle routing guides          ║\n║   __msdDebug.debug.performance.toggle()    - Toggle performance overlay     ║\n║                                                                              ║\n║ Data & Entities:                                                             ║\n║   __msdDebug.dataSources.stats()           - Data source statistics         ║\n║   __msdDebug.dataSources.list()            - List all data sources          ║\n║   __msdDebug.dataSources.get('name')       - Get specific data source       ║\n║                                                                              ║\n║ Routing:                                                                     ║\n║   __msdDebug.routing.inspect('overlay_id') - Inspect routing path           ║\n║   __msdDebug.routing.stats()               - Routing system statistics      ║\n║   __msdDebug.routing.invalidate()          - Clear routing cache            ║\n║                                                                              ║\n║ Performance:                                                                 ║\n║   __msdDebug.getPerf()                     - Get performance metrics        ║\n║   __msdDebug.perf()                        - Alternative performance data   ║\n║                                                                              ║\n║ Other Tools:                                                                 ║\n║   __msdDebug.hud.toggle()                  - Toggle HUD overlay             ║\n║   __msdDebug.rules.trace()                 - Show rules engine trace        ║\n║   __msdDebug.validation.issues()           - Show configuration issues      ║\n║   __msdDebug.usage()                       - Show simplified usage examples ║\n║                                                                              ║\n║ Pipeline:                                                                    ║\n║   __msdDebug.pipelineInstance              - Direct pipeline access         ║\n╚══════════════════════════════════════════════════════════════════════════════╝\n    ")},e.usage=function(){console.log("\n🔧 Quick MSD Debug Commands:\n\nEnable debug features:\n  __msdDebug.debug.enable('anchors')      # Show anchor points\n  __msdDebug.debug.enable('bounding_boxes') # Show overlay bounds\n  __msdDebug.debug.enable('all')          # Enable everything\n\nCheck status:\n  __msdDebug.debug.status()               # Current debug state\n  __msdDebug.dataSources.stats()          # Data source info\n  __msdDebug.getPerf()                    # Performance metrics\n\nQuick toggles:\n  __msdDebug.debug.anchors.toggle()       # Toggle anchors\n  __msdDebug.debug.bounding.toggle()      # Toggle bounding boxes\n  __msdDebug.debug.bounding.test('id')    # Test bounding accuracy\n  __msdDebug.debug.routing.toggle()       # Toggle routing guides\n\nFor full help: __msdDebug.help()\n    ")},r.enabled&&console.log("[MSD v1] Debug mode enabled")}(i,s,r,0,o),function(e,t,n){e.rules={trace:()=>n.rulesEngine.getTrace()},e.animations={active:()=>n.animRegistry.getActive()},e.getPerf=()=>{const t=e.__perfStore||{},n={timers:{},counters:t.counters||{}};return t.timings&&Object.entries(t.timings).forEach((([e,t])=>{t&&"object"==typeof t&&(n.timers[e]={count:t.count||0,total:t.total||0,avg:t.count>0?t.total/t.count:0,last:t.last||0,max:t.max||0})})),n},e.perf=()=>Ec(),e.validation={issues:()=>{try{return t.__issues||{errors:[],warnings:[]}}catch(e){return console.warn("[MSD v1] validation.issues failed:",e),{errors:[],warnings:[]}}}},e.packs={list:e=>e?t[e]||[]:{animations:t.animations?.length||0,overlays:t.overlays?.length||0,rules:t.rules?.length||0,profiles:t.profiles?.length||0,timelines:t.timelines?.length||0},get:(e,n)=>(t[e]||[]).find((e=>e.id===n)),issues:()=>t.__issues},e.lines={markersEnabled:!1,showMarkers(e=!0){this.markersEnabled=!!e,console.info("[MSD v1] line endpoint markers",this.markersEnabled?"ENABLED":"DISABLED")},forceRedraw:()=>!!n._reRenderCallback&&(n._reRenderCallback(),!0)}}(i,t,s),console.log("[MSD v1] Debug interface setup complete"),console.log("[MSD v1] Available methods:",Object.keys(i)),o.enabled&&console.log("[MSD v1] Debug mode enabled")}(u,s,i,a,l),"undefined"!=typeof window&&window.__msdDebug?.hud?.setMountElement&&window.__msdDebug.hud.setMountElement(t),console.log("[MSD v1] Attaching unified API"),Qc.attach(),"undefined"!=typeof window&&(window.__msdDebug=window.__msdDebug||{},window.__msdDebug.validation={issues:()=>s.__issues},window.__msdDebug.pipelineInstance=u,window.__msdDebug._provenance=i,!window.__msdDebug.routing)){window.__msdDebug.routing=a.router;try{window.dispatchEvent(new CustomEvent("msd-routing-ready"))}catch(e){}}return console.log("[MSD v1] Pipeline initialization complete"),u}function id(e,t,n,s,r){const i={enabled:!0,version:e.version||1,config:e,systemsManager:n,dataSourceManager:n.dataSourceManager,rulesEngine:n.rulesEngine,renderer:n.renderer,router:n.router,routingInspect:e=>{const r=s.getResolvedModel(),i=(r?.overlays||[]).find((t=>t.id===e));if(!i)return null;const o=i._raw||i.raw||{},a=t.anchors[o.anchor],l=t.anchors[o.attach_to]||t.anchors[o.attachTo];if(!a||!l)return null;const c=n.router.buildRouteRequest(i,a,l);return n.router.computePath(c)},getResolvedModel:()=>s.getResolvedModel(),reRender:()=>{try{return console.log("[MSD v1] Manual re-render triggered"),r()}catch(e){return console.error("[MSD v1] Manual re-render failed:",e),{success:!1,error:e.message}}},setAnchor(e,r){if(!e||!Array.isArray(r)||2!==r.length)return!1;t.anchors||(t.anchors={}),t.anchors[e]=[Number(r[0]),Number(r[1])];const i=s.getResolvedModel();i?.anchors&&(i.anchors[e]=t.anchors[e]),n.router.invalidate&&n.router.invalidate("*");try{n.renderer&&i&&(n.renderer._routerOverlaySync=!1,n.renderer.render(i))}catch(e){}return!0},ingestHass:e=>n.ingestHass(e),updateEntities:e=>n.updateEntities(e),listEntities:()=>n.entityRuntime.listIds(),getEntity:e=>n.entityRuntime.getEntity(e),getActiveProfiles:()=>s.runtimeActiveProfiles.slice(),getAnchors:()=>({...t.anchors}),exportCollapsed:()=>td(userMsdConfig),exportCollapsedJson:()=>JSON.stringify(td(userMsdConfig)),exportFullSnapshot:()=>nd(e),exportFullSnapshotJson:()=>JSON.stringify(nd(e)),diffItem:e=>function(e,t,n){const s=e.__provenance?.[void 0]?.[n];if(!s)return{id:n,collection:t,chain:[],final:null,removed:!1};const r=(e[void 0]||[]).filter((e=>e.id===n)),i=r.length?r[r.length-1]:null;return{id:n,collection:t,chain:s,removed:s.some((e=>e.removed)),final_summary:i?sd(i):null,chain_summaries:s.map((e=>({layer:e.layer_id,overridden:e.overridden,removed:e.removed,checksum:e.checksum,diff:e.diff})))}}(e),getPerf:()=>Ec(),debug:{enable:e=>n.debugManager.enable(e),disable:e=>n.debugManager.disable(e),toggle:e=>n.debugManager.toggle(e),setScale:e=>n.debugManager.setScale(e),status:()=>n.debugManager.getSnapshot(),onChange:e=>n.debugManager.onChange(e)},getDataSourceManager:()=>n.dataSourceManager,_reRenderCallback:r};return i}let od,ad,ld;n(372),n(157),n(388),n(733),n(786),"undefined"!=typeof window&&(window.__msdDebug=window.__msdDebug||{},Object.assign(window.__msdDebug,{mergePacks:Ol,buildCardModel:Zc,initMsdPipeline:rd}),Object.assign(window.__msdDebug,{pipelineInstance:null,async initMsdPipeline(e,t,n){try{const s=await rd(e,t,n);return this.pipelineInstance=s,s}catch(e){throw console.error("[MSD Debug] Pipeline initialization failed:",e),e}}}),Object.defineProperty(window.__msdDebug,"dataSourceManager",{get:()=>window.__msdDebug.pipelineInstance?.dataSourceManager||window.__msdDebug.pipelineInstance?.systemsManager?.dataSourceManager,configurable:!0})),window.cblcars=window.cblcars||{};let cd={},dd={};function ud(e,t="green",n=!1){const s=e[`${t}_alert`];if(!s)return void In.lr.error(`[setThemeColors] Theme for alert condition ${t} is not defined.`,"",(0,In.mZ)());const r=s.colors;for(const[e,t]of Object.entries(r))for(const[e,s]of Object.entries(t)){const t=`--${e}`,r=getComputedStyle(document.documentElement).getPropertyValue(t).trim();n||!r?(In.lr.warn(`[setThemeColors] Color undefined or overridden - Setting ${t}=${s}`,"",(0,In.mZ)()),document.documentElement.style.setProperty(t,s)):In.lr.debug(`[setThemeColors] Skipping ${t} as it is already defined with value ${r}`,"",(0,In.mZ)())}}window.cblcars.loadFont=Wr,console.log("[CB-LCARS] File loaded, setting up debugging"),async function(){(0,In.zf)(),window.cblcars.cblcarsLog=In.lr,window.cblcars.debug=window.cblcars.debug||{},window.cblcars.debug.setLevel=In.mD,window.cblcars.anim={animejs:e,anime:Lt,utils:dn,animateElement:_l.animateElement,animateWithRoot:_l.animateWithRoot,waitForElement:_l.waitForElement,presets:vl.m,scopes:new Map},window.cblcars.animejs=window.cblcars.anim.animejs,window.cblcars.anime=window.cblcars.anim.anime,window.cblcars.animateElement=window.cblcars.anim.animateElement,window.cblcars.animateWithRoot=window.cblcars.anim.animateWithRoot,window.cblcars.waitForElement=window.cblcars.anim.waitForElement,window.cblcars.svgHelpers=wl,window.cblcars.anchorHelpers=t,window.cblcars.findSvgAnchors=Sl,window.cblcars.getSvgContent=xl,window.cblcars.getSvgViewBox=$l,window.cblcars.getSvgAspectRatio=Cl,window.cblcars.loadFont=Wr,window.cblcars.loadUserSVG=async function(e,t){return await Hr(e,t)},window.cblcars.getSVGFromCache=Ur,od=async function(e){try{const t=await Ir(e);window.cblcars_card_templates=t.cblcars_card_templates,t.cblcars&&(window.cblcars={...window.cblcars,...t.cblcars}),cd=t||{},In.lr.debug(`[loadTemplates] CB-LCARS dashboard templates loaded from source file [${e}]`,cd)}catch(e){In.lr.error("[loadTemplates] Failed to get the CB-LCARS lovelace templates from source file.",e)}}(Bn.FS),ad=async function(e){try{const t=await Ir(e);dd=t||{},In.lr.debug(`[loadStubConfig] CB-LCARS stub configuration loaded from source file [${Bn.ZU}]`,dd)}catch(e){In.lr.error("[loadStubConfig] Failed to get the CB-LCARS stub configuration from source file.",e)}}(Bn.ZU),ld=async function(e){try{const t=await Ir(e);t.cblcars&&(window.cblcars={...window.cblcars,...t.cblcars}),In.lr.info(`[loadThemeColors] CB-LCARS theme colors loaded from source file [${e}]`,t),ud(window.cblcars.themes,"green")}catch(e){In.lr.error("[loadThemeColors] Failed to get the CB-LCARS theme colors from source file.",e)}}(Bn.CZ),await async function(e,t){const n=e.map((e=>Hr(e,`${t}${e}.svg`)));await Promise.all(n),In.lr.info(`[preloadSVGs] Preloaded SVGs: ${e.join(", ")} from ${t}`)}(Bn.ur,Bn.A1).catch((e=>In.lr.error("[initializeCustomCard] Error preloading built-in SVGs:",e)));const n=[customElements.whenDefined("cblcars-button-card"),customElements.whenDefined("my-slider-v2")];await Promise.all(n),await async function(){try{const e=Array.isArray(Bn.ry)?Bn.ry:[Bn.ry];for(const t of e)window.cblcars.loadFont(t)}catch(e){In.lr.error(`[loadCoreFonts] Failed to preload core fonts: ${e.message}`)}}(),await Promise.all([od,ad,ld]),customElements.get("cblcars-button-card")||In.lr.error("[initializeCustomCard] Custom Button Card for LCARS [cblcars-button-card] was not found!"),customElements.get("my-slider-v2")||In.lr.error("[initializeCustomCard] 'My Cards' MySliderV2 Custom Card [my-slider-v2] was not found!")}().then((()=>{Sd("cb-lcars-base-card",pd,"cb-lcars-base-card-editor",Vr),Sd("cb-lcars-label-card",md,"cb-lcars-label-card-editor",Vr),Sd("cb-lcars-elbow-card",fd,"cb-lcars-elbow-card-editor",Vr),Sd("cb-lcars-double-elbow-card",bd,"cb-lcars-double-elbow-card-editor",Vr),Sd("cb-lcars-multimeter-card",_d,"cb-lcars-multimeter-card-editor",Vr),Sd("cb-lcars-dpad-card",vd,"cb-lcars-dpad-card-editor",Vr),Sd("cb-lcars-button-card",wd,"cb-lcars-button-card-editor",Vr),Sd("cb-lcars-msd-card",yd,"cb-lcars-msd-card-editor",Vr)})).catch((e=>{In.lr.error("[initializeCustomCard.then()] Error initializing custom card:",e)})),window.cblcars.setAlertCondition=function(e){ud(window.cblcars.themes,e,!0)};class hd{constructor(e){this.id=e,this.scope=window.cblcars.animejs.createScope(),this.animations=[],this._runningByTarget=new Map}_getRoot(e){return e&&e.root||document}_resolveTargets(e){const t=this._getRoot(e),n=e&&e.targets;if(!n)return[];if(n instanceof Element)return[n];if(Array.isArray(n))return n.filter(Boolean);if("string"==typeof n){if(n.startsWith("#")){const e=t.querySelector(n);return e?[e]:[]}return Array.from(t.querySelectorAll(n))}return[]}_cleanupArtifactsForTargetId(e,t){if(!t)return;e.querySelectorAll(`#${t}_trail[data-cblcars-owned]`).forEach((e=>e.parentElement&&e.parentElement.removeChild(e))),e.querySelectorAll(`#${t}_tracer[data-cblcars-owned]`).forEach((e=>e.parentElement&&e.parentElement.removeChild(e)));const n=e.getElementById(t);n&&(n.style&&(n.style.animation=""),n.removeAttribute("data-march-anim-id"))}_cancelAndCleanupTargets(e){const t=this._getRoot(e),n=this._resolveTargets(e);return n.forEach((e=>{const n=e&&e.id;if(n){if(this.scope&&"function"==typeof this.scope.remove)try{this.scope.remove(e)}catch(e){}this._cleanupArtifactsForTargetId(t,n),e.style&&(e.style.animation=""),this._runningByTarget.delete(n)}})),n}animate(e,t=null){const n=this._cancelAndCleanupTargets(e),s=window.cblcars.anim.animateElement(this,e,t);s&&(this.animations.push({config:e,animation:s,targets:n}),n.forEach((e=>e&&e.id&&this._runningByTarget.set(e.id,s))))}destroy(){if(this.scope&&"function"==typeof this.scope.remove)try{const e=window.cblcars.animejs.get(this.scope);e&&this.scope.remove(e.map((e=>e.targets)).flat())}catch(e){}try{this.animations.forEach((e=>{const t=this._getRoot(e.config);(e.targets||[]).forEach((e=>{e&&e.id&&(this._cleanupArtifactsForTargetId(t,e.id),e.style&&(e.style.animation=""))}))}))}catch(e){}this._runningByTarget.clear(),this.animations=[]}}class pd extends bl{_isResizeObserverEnabled=!1;_resizeObserver;_logLevel=(0,In.mZ)();_resizeObserverTarget="this";_lastWidth=0;_lastHeight=0;_resizeObserverTolerance=16;_debounceWait=100;_isUsingLovelaceTemplate=!1;_overrideTemplates=[];constructor(){super(),this._resizeObserverTolerance=window.cblcars.resizeObserverTolerance||this._resizeObserverTolerance,this._debounceWait=window.cblcars.debounceWait||this._debounceWait,this._resizeObserver=new ResizeObserver((()=>{In.lr.debug("[CBLCARSBaseCard.constructor()] Resize observer fired",this,this._logLevel),this._debouncedResizeHandler()})),this._debouncedResizeHandler=this._debounce((()=>this._updateCardSize()),this._debounceWait)}setHass(e){console.log("[CBLCARSBaseCard.setHass()] 🎯 RECEIVED setHass call:",{cardType:this.constructor.cardType,entity:this._config?.entity,oldState:this.hass?.states?.[this._config?.entity]?.state,newState:e?.states?.[this._config?.entity]?.state,stateChanged:this.hass?.states?.[this._config?.entity]?.state!==e?.states?.[this._config?.entity]?.state,timestamp:(new Date).toISOString(),callerStack:(new Error).stack.split("\n").slice(1,3).map((e=>e.trim())).join(" → ")});const t=this.hass;if(this._config?.entity&&e?.states?.[this._config.entity]){const t=e.states[this._config.entity];this._stateObj!==t&&(console.log("[CBLCARSBaseCard.setHass()] Updating _stateObj for entity:",this._config.entity,{oldState:this._stateObj?.state,newState:t?.state}),this._stateObj=t)}this.hass=e,this._hass=e,"function"==typeof this.requestUpdate&&(this.requestUpdate("hass",t),this.requestUpdate("_hass",t),this._config?.entity&&this._stateObj&&this.requestUpdate("_stateObj")),console.log("[CBLCARSBaseCard.setHass()] Completed with property assignment approach")}setConfig(e){if(!e)throw new Error("The 'cblcars_card_config' section is required in the configuration.");console.log("[CBLCARSBaseCard.setConfig()] Called with config:",{type:e.type,entity:e.entity,triggersUpdate:e.triggers_update,hasSetConfigFromMSD:e._msdGenerated||!1,fullConfig:e});const t=["cb-lcars-base",...e.template?[...e.template]:[]];this._logLevel=e.cblcars_log_level||(0,In.mZ)();let n=[];if("cb-lcars-msd-card"===e.type||"cb-lcars-msd-card"===this.constructor.cardType||t.includes("cb-lcars-msd"))n=[],console.log("[CBLCARSBaseCard.setConfig()] MSD card detected: Completely disabling triggers_update");else{const t=gd(e);n=Array.isArray(e.triggers_update)?e.triggers_update:[],"all"===e.triggers_update?n="all":t.length>0&&(n=Array.from(new Set([...n,...t])),console.log("[CBLCARSBaseCard.setConfig()] Found entities for triggers_update:",t))}this._config={...e,template:t,triggers_update:n},console.log("[CBLCARSBaseCard.setConfig()] Final config triggers_update:",this._config.triggers_update),function(e){const t=new Set;!function e(n){if(n&&"object"==typeof n)for(const s in n)"font_family"===s&&"string"==typeof n[s]?t.add(n[s]):"object"==typeof n[s]&&e(n[s])}(e),t.forEach((e=>window.cblcars.loadFont(e)))}(this._config);const{isUsingLovelaceTemplate:s,overriddenTemplates:r}=function(e){const t=function(){let e=document.querySelector("home-assistant");if(e=e&&e.shadowRoot,e=e&&e.querySelector("home-assistant-main"),e=e&&e.shadowRoot,e=e&&e.querySelector("app-drawer-layout partial-panel-resolver, ha-drawer partial-panel-resolver"),e=e&&e.shadowRoot||e,e=e&&e.querySelector("ha-panel-lovelace"),e=e&&e.shadowRoot,e=e&&e.querySelector("hui-root"),e){const t=e.lovelace;return t.current_view=e.___curView,t}return null}(),n=t&&t.config&&t.config.cblcars_card_templates?t.config.cblcars_card_templates:{};let s=!1,r=[],i=e.template||[];for(const e of i)n.hasOwnProperty(e)&&(s=!0,r.push(e));return r=[...new Set(r)].sort(),{isUsingLovelaceTemplate:s,overriddenTemplates:r}}(this._config);this._isUsingLovelaceTemplate=s,this._overrideTemplates=r,s&&(In.lr.warn(`[CBLCARSBaseCard.setConfig()] Card configuration templates are being overridden with local dashboard YAML configuration.  Templates: ${r.join(", ")}`,this,this._logLevel),window.cblcars.taintedCards=window.cblcars.taintedCards||[],window.cblcars.taintedCards.push({card:this,templates:r})),this._resizeObserverTarget=e.resize_observer_target||"this",this._isResizeObserverEnabled=e.enable_resize_observer||e.variables&&e.variables.enable_resize_observer||!1,this._resizeObserverTolerance=e.resize_observer_tolerance||this._resizeObserverTolerance,this._debounceWait=e.debounce_wait||this._debounceWait,t.some((e=>e.includes("animation")||e.includes("symbiont")))&&(this._isResizeObserverEnabled=!0),this._isResizeObserverEnabled&&this.enableResizeObserver(),super.setConfig(this._config),console.log("[CBLCARSBaseCard.setConfig()] Called super.setConfig with final config:",{triggers_update:this._config.triggers_update,entity:this._config.entity,type:this._config.type}),this.hass&&this._config.entity&&(console.log("[CBLCARSBaseCard.setConfig()] Forcing state re-evaluation after setConfig"),setTimeout((()=>{try{console.log("[CBLCARSBaseCard.setConfig()] Skipping forced setHass - will rely on normal HA update cycle"),"function"==typeof this.requestUpdate&&(console.log("[CBLCARSBaseCard.setConfig()] Forcing requestUpdate"),this.requestUpdate())}catch(e){console.warn("[CBLCARSBaseCard.setConfig()] Failed to force state re-evaluation:",e)}}),100)),In.lr.debug("[CBLCARSBaseCard.setConfig()] called with:",this._config,this._logLevel)}static get editorType(){return"cb-lcars-base-card-editor"}static get cardType(){return"cb-lcars-base-card"}static get defaultConfig(){return{label:"CB-LCARS Base Card",show_label:!0}}static getConfigElement(){const e=this.editorType;try{return customElements.get(e)?document.createElement(e):(In.lr.error(`[CBLCARSBaseCard.getConfigElement()] Graphical editor element [${e}] is not defined defined in Home Assistant!`,null,this._logLevel),null)}catch(t){return In.lr.error(`[CBLCARSBaseCard.getConfigElement()] Error creating element ${e}: `,t,this._logLevel),null}}static getStubConfig(){const e=this.cardType;return dd[e]?dd[e]:this.defaultConfig}getCardSize(){super.getCardSize()}getLayoutOptions(){return{grid_rows:1,grid_columns:4}}connectedCallback(){super.connectedCallback(),this._animationScopeId=`card-${this.id||this.cardType||Math.random().toString(36).slice(2)}`,this._animationScope=new hd(this._animationScopeId),window.cblcars.anim.scopes.set(this._animationScopeId,this._animationScope),this._timelines&&Array.isArray(this._timelines)&&(this._timelines.forEach((e=>e&&"function"==typeof e.pause&&e.pause())),this._timelines=null);const e=this._config?.variables?.msd||{},t=e.timelines||null,n=(Array.isArray(e.overlays)?e.overlays:[]).reduce(((e,t)=>(t&&t.id&&(e[t.id]=t),e)),{});t&&requestAnimationFrame((()=>{requestAnimationFrame((async()=>{try{this._timelines=await _l.createTimelines(t,this._animationScopeId,this.shadowRoot,n,this.hass||null,e.presets||{})}catch(e){In.lr.error("[CBLCARSBaseCard.connectedCallback] Error creating timelines:",e)}}))})),this.parentElement&&this.parentElement.classList.contains("preview")?(this.style.height="60px",this.style.minHeight="60px"):(this.style.height="100%",this._isResizeObserverEnabled&&(this.enableResizeObserver(),window.addEventListener("resize",this._debouncedResizeHandler)))}disconnectedCallback(){super.disconnectedCallback();const e=window.cblcars.anim.scopes.get(this._animationScopeId);e&&(e.destroy(),window.cblcars.anim.scopes.delete(this._animationScopeId)),this.disableResizeObserver(),window.removeEventListener("resize",this._debouncedResizeHandler)}_updateCardSize(){const e=this.parentElement.offsetWidth,t=this.parentElement.offsetHeight,n=this._resizeObserverTolerance;if(e>0&&t>0&&(Math.abs(e-this._lastWidth)>n||Math.abs(t-this._lastHeight)>n)){if(this._lastWidth=e,this._lastHeight=t,this.style.setProperty("--button-card-width",`${e}px`),this.style.setProperty("--button-card-height",`${t}px`),!this._config)return void In.lr.debug("[CBLCARSBaseCard._updateCardSize()] Config is not defined. Skipping resize handling.",this,this._logLevel);this._config.variables||(this._config.variables={card:{}}),this._config.variables.card.width=`${e}px`,this._config.variables.card.height=`${t}px`,this.setConfig(this._config)}}_updateResizeObserver(){this._isResizeObserverEnabled?this.enableResizeObserver():this.disableResizeObserver()}enableResizeObserver(){const e=this.resolveTargetElement(this._resizeObserverTarget);e&&this.isConnected&&(this._resizeObserver.observe(e),In.lr.debug(`[CBLCARSBaseCard.enableResizeObserver()] Resize observer enabled on [${this._resizeObserverTarget}]`,this,this._logLevel))}disableResizeObserver(){this._resizeObserver&&this._resizeObserver.disconnect(),In.lr.debug("[CBLCARSBaseCard.disableResizeObserver()] Resize observer disabled",this._logLevel)}toggleResizeObserver(){this._isResizeObserverEnabled=!this._isResizeObserverEnabled,this._updateResizeObserver()}resolveTargetElement(e){const t={this:()=>this,"this.parentElement":()=>this.parentElement,"this.offsetParent":()=>this.offsetParent};return t[e]?t[e]():this}_debounce(e,t){let n;return function(...s){clearTimeout(n),n=setTimeout((()=>e.apply(this,s)),t)}}_rebuildTimelines(e,t={},s={}){e&&(this._timelines&&Array.isArray(this._timelines)&&(this._timelines.forEach((e=>e&&"function"==typeof e.pause&&e.pause())),this._timelines=null),requestAnimationFrame((()=>{requestAnimationFrame((async()=>{try{this._timelines=await window.cblcars.anim.createTimelines?window.cblcars.anim.createTimelines(e,this._animationScopeId,this.shadowRoot,t,this.hass||null,s||{}):(await Promise.resolve().then(n.bind(n,625))).createTimelines(e,this._animationScopeId,this.shadowRoot,t,this.hass||null,s||{})}catch(e){In.lr.error("[CBLCARSBaseCard._rebuildTimelines] Error creating timelines:",e)}}))})))}}function gd(e,t=[]){if(Array.isArray(e))e.forEach((e=>gd(e,t)));else if(e&&"object"==typeof e)for(const[n,s]of Object.entries(e))"entity"!==n&&"entity_id"!==n||"string"!=typeof s?gd(s,t):t.push(s);return t}class md extends pd{static get editorType(){return"cb-lcars-label-card-editor"}static get cardType(){return"cb-lcars-label-card"}static get defaultConfig(){return{label:"CB-LCARS Label",show_label:!0}}setConfig(e){const t=[e.cblcars_card_type?e.cblcars_card_type:"cb-lcars-label",...e.template?[...e.template]:[]],n={...e,template:t};super.setConfig(n)}}class fd extends pd{static get editorType(){return"cb-lcars-elbow-card-editor"}static get cardType(){return"cb-lcars-elbow-card"}static get defaultConfig(){return{variables:{card:{border:{left:{size:90},top:{size:20}}}}}}setConfig(e){const t=[e.cblcars_card_type?e.cblcars_card_type:"cb-lcars-header",...e.template?[...e.template]:[]],n={...e,template:t};super.setConfig(n)}getLayoutOptions(){return{grid_rows:1,grid_columns:4}}}class yd extends pd{static get editorType(){return"cb-lcars-msd-card-editor"}static get cardType(){return"cb-lcars-msd-card"}static get defaultConfig(){return{enable_resize_observer:!0,variables:{card:{border:{left:{size:0},right:{size:0},top:{size:0},bottom:{size:0}}}}}}setConfig(e){console.log("[MSD DEBUG] 🔧 CBLCARSMSDCard.setConfig() CALLED:",{timestamp:(new Date).toISOString(),hasExistingConfig:!!this._config,configType:e.type,configEntity:e.entity,msdAlreadyBooted:!!this._msdV1ComprehensiveBoot,stackTrace:(new Error).stack.split("\n").slice(1,6).map((e=>e.trim())).join(" → ")});const t=["cb-lcars-msd",...e.template?[...e.template]:[]],n={...e,template:t,entity:void 0,entities:void 0,triggers_update:[],show_state:!1,show_icon:!1,show_name:!1,show_label:!1,state:void 0,tap_action:{action:"none"},hold_action:{action:"none"},double_tap_action:{action:"none"}},s=n?.msd;super.setConfig(n);try{s&&window.__msdDebug?.initMsdPipeline&&(this._msdConfig=s,console.log("[CBLCARSMSDCard] MSD v1 config prepared for pipeline initialization"))}catch(e){console.warn("[CBLCARSMSDCard] Failed to prepare MSD v1 pipeline:",e)}if(console.log("[CBLCARSMSDCard] msdConfig:",s),s&&s.base_svg?.source){console.log("[CBLCARSMSDCard] Found base SVG:",s.base_svg.source);let e=null,t=null;s.base_svg.source.startsWith("builtin:")?e=s.base_svg.source.replace("builtin:",""):s.base_svg.source.startsWith("/local/")&&(e=s.base_svg.source.split("/").pop().replace(".svg",""),t=s.base_svg.source,window.cblcars.getSVGFromCache(e)||window.cblcars.loadUserSVG(e,t).then((()=>{console.log("[CBLCARSMSDCard] SVG loaded, scheduling safe update"),setTimeout((()=>{this.requestUpdate&&!this._blockUpdates&&this.requestUpdate()}),100)})).catch((e=>{console.warn("[CBLCARSMSDCard] Failed to load user SVG:",e)}))),this._svgKey=e,console.log("[CBLCARSMSDCard] SVG key stored:",e)}console.log("[CBLCARSMSDCard] Config set with disabled entity tracking and SVG handling preserved")}getLayoutOptions(){return{grid_rows:4,grid_columns:4}}setHass(e){console.log("[MSD DEBUG] 🏠 CBLCARSMSDCard.setHass() CALLED:",{timestamp:(new Date).toISOString(),hasHass:!!e,lightDeskState:e?.states?.["light.desk"]?.state,callerStack:(new Error).stack.split("\n").slice(1,4).map((e=>e.trim())).join(" → ")}),this.hass=e,this._msdPipeline&&this._msdPipeline.systemsManager&&(console.log("[MSD DEBUG] 📤 IMMEDIATELY updating SystemsManager with FRESH HASS"),console.log("[MSD DEBUG] 📊 Fresh HASS light.desk state being sent:",e?.states?.["light.desk"]?.state),this._msdPipeline.systemsManager.controlsRenderer&&(console.log("[MSD DEBUG] 📤 Immediately forwarding fresh HASS to controls"),this._msdPipeline.systemsManager.controlsRenderer.setHass(e))),this._msdPipeline&&"function"==typeof this._msdPipeline.ingestHass&&(console.log("[MSD DEBUG] 📤 Forwarding HASS to MSD pipeline via ingestHass"),this._msdPipeline.ingestHass(e)),console.log("[MSD DEBUG] 📤 Calling super.setHass() to maintain HA compatibility"),super.setHass(e),console.log("[MSD DEBUG] ✅ CBLCARSMSDCard.setHass() COMPLETED - SystemsManager should now have fresh HASS")}updated(e){if(console.log("[MSD DEBUG] 🔄 CBLCARSMSDCard.updated() CALLED:",{timestamp:(new Date).toISOString(),changedProperties:Array.from(e.keys()),stackTrace:(new Error).stack.split("\n").slice(1,4).map((e=>e.trim())).join(" → ")}),e.has("hass")||e.has("_hass")){if(this._isControlTriggeredUpdate())return void console.log("[MSD DEBUG] ⏭️ BLOCKED super.updated() for control-triggered HASS change");console.log("[MSD DEBUG] 🔄 Allowing super.updated() for non-control HASS change")}console.log("[MSD DEBUG] 🔄 Calling super.updated() for changes:",Array.from(e.keys())),super.updated(e)}requestUpdate(e,t,n){return console.log("[MSD DEBUG] 🔃 CBLCARSMSDCard.requestUpdate() CALLED:",{timestamp:(new Date).toISOString(),name:e,hasOldValue:void 0!==t,stackTrace:(new Error).stack.split("\n").slice(1,4).map((e=>e.trim())).join(" → ")}),"hass"===e||"_hass"===e?(console.log("[MSD DEBUG] 🚫 BLOCKED requestUpdate() for HASS change:",e),console.log("[MSD DEBUG] ⏭️ MSD system manages its own HASS updates internally"),Promise.resolve()):(console.log("[MSD DEBUG] ✅ Allowing requestUpdate() for:",e),super.requestUpdate(e,t,n))}_isControlTriggeredUpdate(){if(window.__msdDebug?.systemsManager){const e=window.__msdDebug.systemsManager._lastEntityAnalysis;if(e&&e.isControlTriggered)return Date.now()-e.timestamp<100}return!1}connectedCallback(){console.log("[CBLCARSMSDCard.connectedCallback] MSD card connected to DOM"),super.connectedCallback()}disconnectedCallback(){console.log("[CBLCARSMSDCard.disconnectedCallback] MSD card disconnected from DOM"),this.msdSystem&&console.log("[CBLCARSMSDCard.disconnectedCallback] Cleaning up MSD system"),super.disconnectedCallback()}}class bd extends pd{static get editorType(){return"cb-lcars-double-elbow-card-editor"}static get cardType(){return"cb-lcars-double-elbow-card"}static get defaultConfig(){return{}}setConfig(e){const t=[e.cblcars_card_type?e.cblcars_card_type:"cb-lcars-header-picard",...e.template?[...e.template]:[]],n={...e,template:t};super.setConfig(n)}getLayoutOptions(){return{grid_rows:1,grid_columns:4}}}class _d extends pd{static get editorType(){return"cb-lcars-multimeter-card-editor"}static get cardType(){return"cb-lcars-multimeter-card"}static get defaultConfig(){return{variables:{_mode:"gauge"}}}constructor(){super(),this._enableResizeObserver=!0}setConfig(e){const t=["cb-lcars-multimeter",...e.template?[...e.template]:[]],n={...e,template:t};super.setConfig(n)}getLayoutOptions(){return{grid_rows:1,grid_columns:4}}render(){return customElements.get("my-slider-v2")?super.render():Gr.html`<ha-alert alert-type="error" title="CB-LCARS - Dependency Error">Required 'my-slider-v2' card is not available - Please refer to the documentation.</ha-alert>`}}class vd extends pd{static get editorType(){return"cb-lcars-dpad-card-editor"}static get cardType(){return"cb-lcars-dpad-card"}static get defaultConfig(){return{}}setConfig(e){const t=["cb-lcars-dpad",...e.template?[...e.template]:[]],n={...e,template:t};super.setConfig(n)}getLayoutOptions(){return{grid_rows:4,grid_columns:2}}}class wd extends pd{static get editorType(){return"cb-lcars-button-card-editor"}static get cardType(){return"cb-lcars-button-card"}static get defaultConfig(){return{label:"CB-LCARS Button",show_label:!0}}setConfig(e){const t=[e.cblcars_card_type?e.cblcars_card_type:"cb-lcars-button-lozenge",...e.template?[...e.template]:[]],n={...e,template:t};super.setConfig(n)}getLayoutOptions(){return{grid_min_rows:1,grid_rows:1,grid_columns:2,grid_min_columns:1}}}function Sd(e,t,n,s){customElements.define(e,t),customElements.define(n,class extends s{constructor(){super(e)}})}window.customCards=window.customCards||[],window.customCards.push({type:"cb-lcars-base-card",name:"CB-LCARS Base Card",description:"For advanced use: the CB-LCARS base card for full manual configuration.",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-label-card",name:"CB-LCARS Label",preview:!0,description:"CB-LCARS label card for text.",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-elbow-card",name:"CB-LCARS Elbow",preview:!0,description:"CB-LCARS Elbow card",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-double-elbow-card",name:"CB-LCARS Double Elbow",preview:!0,description:"CB-LCARS Double Elbow card",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-multimeter-card",name:"CB-LCARS Multimeter",preview:!0,description:"CB-LCARS Multimeter card",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-dpad-card",name:"CB-LCARS D-Pad",preview:!0,description:"CB-LCARS D-Pad card",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-button-card",name:"CB-LCARS Button",preview:!0,description:"CB-LCARS Buttons [various styles]",documentationURL:"https://cb-lcars.unimatrix01.ca"},{type:"cb-lcars-msd-card",name:"CB-LCARS MSD",preview:!0,description:"CB-LCARS Master Systems Display (MSD) card",documentationURL:"https://cb-lcars.unimatrix01.ca"})})()})();
//# sourceMappingURL=cb-lcars.js.map