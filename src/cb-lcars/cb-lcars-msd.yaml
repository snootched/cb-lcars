cb-lcars-msd:
  variables:
    card:
      height: 70vw
      color:
        background:
          default: black
    msd:
      base_svg: builtin:ncc-1701-a-blue
      base_svg2: builtin:enterprise-d-shuttlecraft15-anomaly
      presets:
        default:
          line:
            width: 10
            corner_style: bevel
            corner_radius: 50
            color: var(--picard-orange)
            animation:
              type: motionpath
              duration2: 1200
              playbackRate2: 1
              playbackEase2: inOut(3)
              loop: false
              alternate: false
              trail: true
              duration:
                entity_id: light.tv
                attribute: brightness
                input_range:
                  - 0
                  - 255
                output_range:
                  - 4000
                  - 1001
              tracer:
                shape: circle
                height: 25
                width: 25
                r: 15
          text:
            font_size: 56
            font_family: antonio
            text_transform: uppercase
            color: var(--picard-moonlight)
            animation:
              type: fade
              duration: 4000
        # Add named presets used by state_resolver
        wc_core_blue:
          animation:
            fill: 'blue'
        wc_core_yellow:
          animation:
            fill: 'var(--lcars-yellow)'
        wc_core_red:
          animation:
            fill: 'red'
      overlays:
        # Warp Core
        - type: text
          id: wc_label
          position: wc_label
          value: warp core
          preset: default
          animation:
            type: blink
            duration: 1200
            opacity:
              - 1
              - 0.3
            loop: true
            ease: linear
            alternate: true
        - type: line
          id: wc_connector
          anchor: wc
          attach_to: wc_label
          preset: default
          corner_style: round
          stroke_dasharray:
            - 25
            - 25
          animation:
            reversed: true
            type: march
            alternate: false
            easing: linear
            loop: true
            duration:
              entity_id: light.tv
              attribute: brightness
              input_range:
                - 0
                - 255
              output_range:
                - 200
                - 100
        # Shuttle Bay
        - type: text
          id: sb_label
          position: sb_label
          value: shuttle bay
          preset: default
        - type: line
          id: sb_connector
          anchor: sb
          attach_to: sb_label
          preset: default
        # Port Nodes
        - type: text
          id: pn_3_label
          position: pn_3_label
          value: port 1
          preset: default
        - type: line
          id: pn_1_connector
          anchor: pn_1
          attach_to: pn_3_label
          preset: default
        - type: text
          id: pn_2_label
          position: pn_2_label
          value: port 2
          preset: default
        - type: line
          id: pn_2_connector
          anchor: pn_2
          attach_to: pn_2_label
          preset: default
        - type: text
          id: pn_1_label
          position: pn_1_label
          value: port 3
          preset: default
        - type: line
          id: pn_3_connector
          anchor: pn_3
          attach_to: pn_1_label
          preset: default
        # SBN Nodes
        - type: text
          id: sbn_3_label
          position: sbn_3_label
          value: sb 3
          preset: default
        - type: line
          id: sbn_3_connector
          anchor: sbn_3
          attach_to: sbn_3_label
          preset: default
        - type: text
          id: sbn_2_label
          position: sbn_2_label
          value: sb 2
          preset: default
        - type: line
          id: nsb_2_connector
          anchor: sbn_2
          attach_to: sbn_2_label
          preset: default
        - type: text
          id: sbn_1_label
          position: sbn_1_label
          value: port 1
          preset: default
        - type: line
          id: sbn_1_connector
          anchor: sbn_1
          attach_to: sbn_1_label
          preset: default
        # Bridge
        - type: text
          id: br_label
          position: br_label
          value: bridge
          preset: default
        - type: line
          id: br_connector
          anchor: br
          attach_to: br_label
          preset: default
        # SCR Nodes
        - type: text
          id: scr_nw_label
          position: scr_nw_label
          value: scr nw
          preset: default
        - type: line
          id: scr_nw_connector
          anchor: scr_nw
          attach_to: scr_nw_label
          preset: default
        - type: text
          id: scr_ne_label
          position: scr_ne_label
          value: scr ne
          preset: default
        - type: line
          id: scr_ne_connector
          anchor: scr_ne
          attach_to: scr_ne_label
          preset: default
        - type: text
          id: scr_se_label
          position: scr_se_label
          value: scr se
          preset: default
        - type: line
          id: scr_se_connector
          anchor: scr_se
          attach_to: scr_se_label
          preset: default
        - type: text
          id: scr_sw_label
          position: scr_sw_label
          value: scr sw
          preset: default
        - type: line
          id: scr_sw_connector
          anchor: scr_sw
          attach_to: scr_sw_label
          preset: default
        # Optional: same behavior as a free overlay (no SVG, just mutate an existing element)
        - type: free
          id: wc_core
          targets: '#wc_core'
          animation:
            type: set
          state_resolver:
            entity: light.desk          # was entity_id
            attribute: brightness
            states:                      # was cases
              - map_range:
                  input_range: [0, 255]
                  output_range: [0, 100]
                from: 0
                to: 29                   # 0–29% => blue
                preset: wc_core_blue
              - map_range:
                  input_range: [0, 255]
                  output_range: [0, 100]
                from: 30
                to: 79                   # 30–79% => yellow
                preset: wc_core_yellow
              - map_range:
                  input_range: [0, 255]
                  output_range: [0, 100]
                from: 80
                to: 100                  # 80–100% => red
                preset: wc_core_red
      animations:
        # Use the same resolver for standalone animations (now supported)
        - id: wc_core_fill
          type: set
          targets: '#wc_core'
          state_resolver:
            entity: light.desk
            attribute: brightness
            states:
              - map_range:
                  input_range: [0, 255]
                  output_range: [0, 100]
                from: 0
                to: 29
                preset: wc_core_blue
              - map_range:
                  input_range: [0, 255]
                  output_range: [0, 100]
                from: 30
                to: 79
                preset: wc_core_yellow
              - map_range:
                  input_range: [0, 255]
                  output_range: [0, 100]
                from: 80
                to: 100
                preset: wc_core_red
  custom_fields:
    msd_svg_base: |
      [[[
        let svgContent = window.cblcars.getSvgContent(variables.msd.base_svg);
        if (!svgContent) {
          return `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:gray;">Loading SVG...</div>`;
        }
        let viewBox = window.cblcars.getSvgViewBox(svgContent);
        // Extract anchors from SVG
        let svgAnchors = window.cblcars.findSvgAnchors(svgContent);
        // Get user anchors from config (if present)
        let userAnchors = variables.msd.anchors || {};
        // Merge user anchors with SVG anchors (user anchors take precedence)
        let anchorTable = { ...svgAnchors, ...userAnchors };
        variables.msd._viewBox = viewBox;
        variables.msd._anchors = anchorTable;
        const aspect = window.cblcars.getSvgAspectRatio(viewBox);
        return `<div style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;position:relative;aspect-ratio:${aspect};">${svgContent}</div>`;
      ]]]
    msd_svg_overlays: |
      [[[
        const timelines = variables.msd?.timelines || {};
        const overlays = variables.msd.overlays || [];

        const { svgMarkup, animationsToRun } = window.cblcars.renderMsdOverlay({
          overlays,
          anchors: variables.msd._anchors,
          styleLayers: variables.msd.presets,
          hass,
          root: this.shadowRoot,
          viewBox: variables.msd._viewBox,
          timelines,
          animations: variables.msd.animations,
          dataSources: variables.msd.data_sources || {}    // <--- add this
        });

        const overlayConfigsById = Array.isArray(overlays)
          ? overlays.reduce((acc, o) => { if (o && o.id) acc[o.id] = o; return acc; }, {})
          : {};

        requestAnimationFrame(() => {
          if (animationsToRun.length > 0) {
            animationsToRun.forEach(animConfig => {
              this._animationScope.animate(animConfig);
            });
          }
          if (timelines && Object.keys(timelines).length > 0 && typeof this._rebuildTimelines === 'function') {
            this._rebuildTimelines(timelines, overlayConfigsById, variables.msd.presets || {});
          }
        });

        return svgMarkup;
      ]]]
  styles:
    custom_fields:
      msd_svg_base:
        - width: 100%
        - height: 100%
        - position: absolute
        - top: 0
        - left: 0
        - z-index: 1
      msd_svg_overlays:
        - width: 100%
        - height: 100%
        - position: absolute
        - top: 0
        - left: 0
        - z-index: 1
